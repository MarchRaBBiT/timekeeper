# Frontend Design Review

## 指摘事項

1. **env.js の読み込みレースで API ベース URL が固定化される恐れ**  
   - `index.html:13-19` で `env.js` を非同期に読み込みつつ、同じスクリプト内で `init()` を呼び出し、`src/config.rs:182-195` の `OnceLock` で初回値をキャッシュしている。`env.js` のロードが間に合わないと `__TIMEKEEPER_ENV` が無視され、`api_base_url` 等が常にデフォルト/`config.json` で固定される。`env.js` のロード完了を待つか、キャッシュ前にグローバルをポーリングする仕組みが必要。

2. **アクセストークン期限切れ時に即ログアウトしリフレッシュが走らない**  
   - `src/state/auth.rs:63-88` は localStorage の有無のみで `is_authenticated` を立て、有効性検証を行わない。各 API は `src/api/client.rs:43-67` で 401 を受けるとリフレッシュを試さずセッションを削除し `/login` へ遷移するため、アクセストークン期限切れ時にリフレッシュトークンがあっても強制ログアウトとなり UI 状態もずれる。`exp`/JTI を見て事前リフレッシュするか、401 時に一度だけリフレッシュして再試行するフローが必要。

3. **ルーティング定義が二重管理されガードも不一致**  
   - WASM エントリ (`src/lib.rs:35-50`) とバイナリエントリ (`src/main.rs:19-39`) でルート構成が異なる。後者は `AuthProvider` / `RequireAuth` を挟まず管理系サブルート（`/admin/users`, `/admin/export` 等）も未登録。`cargo run` など bin 側を用いると、保護ページが未ガードで表示される/ルート欠落の挙動になる。ルーター生成を共通化し、一元管理する必要がある。

4. **RequireAuth が loading 中も子を描画し、未認証アクセスで API 呼び出しが走る**  
   - `src/components/guard.rs:5-16` は `loading` を考慮したプレースホルダを挟まず子コンポーネントをそのまま描画するため、例えば `src/pages/dashboard/panel.rs:22-27` で初期マウント直後に勤怠 API 呼び出しが始まる。未ログイン訪問で 401 が連発しつつリダイレクトされる UX になる。`loading` 解消までサスペンド/スケルトンを表示し、認証確認後に子をマウントするガードへ変更するのが安全。

## テスト

- レビューのみのためテストは未実行。
