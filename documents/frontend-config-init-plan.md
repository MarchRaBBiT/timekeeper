# フロントエンド初期化シーケンス修正プラン（ベースURL誤キャッシュ対策）

## 背景
- `config::init()` より先に `AuthProvider`/`ApiClient` が起動し、`await_api_base_url()` がデフォルト値を `OnceLock` に確定させることで、本番ホストを無視するリスクがある。
- 対策方針は「初期化を直列化し、ベースURL/タイムゾーン確定までAPI呼び出しを開始しない」案を採用する。

## ゴール
- 初回起動時に正しいベースURLを必ずキャッシュさせる。
- 初期化待ちの間に未認証での API フェッチや一時的な誤URLアクセスが走らない状態にする。
- 初期化遅延のユーザ影響を把握するための計測ポイントを用意する。

## 対応スコープ
1. **初期化順序の直列化**
   - `frontend/src/lib.rs`（wasm エントリ）と `frontend/src/main.rs`（サーバサイドビルド）が `config::init()` 完了を待ってからルーター/プロバイダをマウントするように変更。
   - `AuthProvider` 起動時の `check_auth_status` が config 未確定で走らないようガードを追加（例: init 完了フラグ or await）。
2. **初期ロード UX**
   - 初期化待ち中の表示をスプラッシュ/ローディングに限定し、Protected ルートの子コンポーネントを描画しない。
3. **計測・ログ**
   - 初期化開始/完了のタイムスタンプを `web_sys::console` へ出力し、差分を計測できるようにする（必要に応じて後からメトリクスへ移行）。

## 非スコープ
- API 仕様変更、バックエンド側の動作変更。
- 既存 UI レイアウトの大幅変更（ローディング表示の最小限追加のみ）。

## 検証方針
- `wasm-pack test`（ヘッドレス）で既存テストが通ることを確認。
- ブラウザで `env.js` / `config.json` を切り替え、正しいベースURLがキャッシュされることを手動確認。
- 初期化所要時間をログで確認し、ユーザ影響の有無をプロファイルする。
