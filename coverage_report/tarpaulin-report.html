<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
}

.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","marra","projects","timekeeper","backend","src","bin","token_cleanup.rs"],"content":"use timekeeper_backend::{\n    config::Config,\n    db::connection::create_pool,\n    repositories::{active_session, auth as auth_repo, password_reset as password_reset_repo},\n};\n\n#[tokio::main]\nasync fn main() -\u003e anyhow::Result\u003c()\u003e {\n    let config = Config::load()?;\n    let pool = create_pool(\u0026config.database_url).await?;\n\n    auth_repo::cleanup_expired_access_tokens(\u0026pool)\n        .await\n        .expect(\"cleanup active tokens\");\n\n    let deleted_sessions = active_session::cleanup_expired_sessions(\u0026pool)\n        .await\n        .expect(\"cleanup expired sessions\");\n    if deleted_sessions \u003e 0 {\n        tracing::info!(\"Deleted {} expired sessions\", deleted_sessions);\n    }\n\n    sqlx::query(\"VACUUM (ANALYZE) active_access_tokens\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"vacuum tokens table\");\n\n    sqlx::query(\"VACUUM (ANALYZE) active_sessions\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"vacuum active_sessions table\");\n\n    let deleted_count = password_reset_repo::delete_expired_tokens(\u0026pool)\n        .await\n        .expect(\"cleanup expired password reset tokens\");\n\n    if deleted_count \u003e 0 {\n        tracing::info!(\"Deleted {} expired password reset tokens\", deleted_count);\n    }\n\n    sqlx::query(\"VACUUM (ANALYZE) password_resets\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"vacuum password_resets table\");\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","config.rs"],"content":"use anyhow::anyhow;\nuse chrono::{DateTime, Duration as ChronoDuration, Utc};\nuse chrono_tz::Tz;\nuse serde::{Deserialize, Serialize};\nuse std::env;\n\nuse crate::utils::cookies::SameSite;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Config {\n    pub database_url: String,\n    pub read_database_url: Option\u003cString\u003e,\n    pub jwt_secret: String,\n    pub jwt_expiration_hours: u64,\n    pub refresh_token_expiration_days: u64,\n    pub max_concurrent_sessions: u32,\n    pub audit_log_retention_days: i64,\n    pub audit_log_retention_forever: bool,\n    pub consent_log_retention_days: i64,\n    pub consent_log_retention_forever: bool,\n    pub aws_region: String,\n    pub aws_kms_key_id: String,\n    pub aws_audit_log_bucket: String,\n    pub aws_cloudtrail_enabled: bool,\n    pub cookie_secure: bool,\n    pub cookie_same_site: SameSite,\n    pub cors_allow_origins: Vec\u003cString\u003e,\n    pub time_zone: Tz,\n    pub mfa_issuer: String,\n    pub rate_limit_ip_max_requests: u32,\n    pub rate_limit_ip_window_seconds: u64,\n    pub rate_limit_user_max_requests: u32,\n    pub rate_limit_user_window_seconds: u64,\n    pub redis_url: Option\u003cString\u003e,\n    pub redis_pool_size: u32,\n    pub redis_connect_timeout: u64,\n    pub feature_redis_cache_enabled: bool,\n    pub feature_read_replica_enabled: bool,\n    pub password_min_length: usize,\n    pub password_require_uppercase: bool,\n    pub password_require_lowercase: bool,\n    pub password_require_numbers: bool,\n    pub password_require_symbols: bool,\n    pub password_expiration_days: u64,\n    pub password_history_count: u32,\n    pub production_mode: bool,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum AuditLogRetentionPolicy {\n    Disabled,\n    Forever,\n    Days(i64),\n}\n\nimpl AuditLogRetentionPolicy {\n    pub fn is_recording_enabled(\u0026self) -\u003e bool {\n        !matches!(self, AuditLogRetentionPolicy::Disabled)\n    }\n\n    pub fn retention_days(\u0026self) -\u003e Option\u003ci64\u003e {\n        match self {\n            AuditLogRetentionPolicy::Days(days) =\u003e Some(*days),\n            _ =\u003e None,\n        }\n    }\n\n    pub fn cleanup_cutoff(\u0026self, now: DateTime\u003cUtc\u003e) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n        self.retention_days()\n            .map(|days| now - ChronoDuration::days(days))\n    }\n}\n\nimpl Config {\n    pub fn load() -\u003e anyhow::Result\u003cSelf\u003e {\n        dotenvy::dotenv().ok();\n\n        let database_url = env::var(\"DATABASE_URL\").unwrap_or_else(|_| {\n            \"postgres://timekeeper:timekeeper@localhost:5432/timekeeper\".to_string()\n        });\n\n        let read_database_url = env::var(\"READ_DATABASE_URL\").ok();\n\n        let jwt_secret = env::var(\"JWT_SECRET\")\n            .map_err(|_| anyhow!(\"JWT_SECRET must be set and at least 32 characters long\"))?;\n        if jwt_secret.len() \u003c 32 {\n            return Err(anyhow!(\n                \"JWT_SECRET must be at least 32 characters long (current length: {})\",\n                jwt_secret.len()\n            ));\n        }\n\n        let jwt_expiration_hours = env::var(\"JWT_EXPIRATION_HOURS\")\n            .unwrap_or_else(|_| \"1\".to_string())\n            .parse()\n            .unwrap_or(1);\n\n        let refresh_token_expiration_days = env::var(\"REFRESH_TOKEN_EXPIRATION_DAYS\")\n            .unwrap_or_else(|_| \"7\".to_string())\n            .parse()\n            .unwrap_or(7);\n\n        let max_concurrent_sessions = env::var(\"MAX_CONCURRENT_SESSIONS\")\n            .unwrap_or_else(|_| \"3\".to_string())\n            .parse()\n            .unwrap_or(3);\n\n        let audit_log_retention_days = env::var(\"AUDIT_LOG_RETENTION_DAYS\")\n            .unwrap_or_else(|_| \"1825\".to_string())\n            .parse::\u003ci64\u003e()\n            .unwrap_or(1825)\n            .max(0);\n\n        let audit_log_retention_forever = env::var(\"AUDIT_LOG_RETENTION_FOREVER\")\n            .unwrap_or_else(|_| \"false\".to_string())\n            .parse()\n            .unwrap_or(false);\n\n        let consent_log_retention_days = env::var(\"CONSENT_LOG_RETENTION_DAYS\")\n            .unwrap_or_else(|_| \"1825\".to_string())\n            .parse::\u003ci64\u003e()\n            .unwrap_or(1825)\n            .max(0);\n\n        let consent_log_retention_forever = env::var(\"CONSENT_LOG_RETENTION_FOREVER\")\n            .unwrap_or_else(|_| \"false\".to_string())\n            .parse()\n            .unwrap_or(false);\n\n        let aws_region = env::var(\"AWS_REGION\").unwrap_or_else(|_| \"ap-northeast-1\".to_string());\n        let aws_kms_key_id = env::var(\"AWS_KMS_KEY_ID\").unwrap_or_default();\n        let aws_audit_log_bucket = env::var(\"AWS_AUDIT_LOG_BUCKET\").unwrap_or_default();\n        let aws_cloudtrail_enabled = env::var(\"AWS_CLOUDTRAIL_ENABLED\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let cookie_secure = env::var(\"COOKIE_SECURE\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let cookie_same_site =\n            parse_same_site(env::var(\"COOKIE_SAMESITE\").unwrap_or_else(|_| \"Lax\".to_string()))?;\n\n        let cors_allow_origins = env::var(\"CORS_ALLOW_ORIGINS\")\n            .unwrap_or_else(|_| \"http://localhost:8000\".to_string())\n            .split(',')\n            .map(|origin| origin.trim().to_string())\n            .filter(|origin| !origin.is_empty())\n            .collect::\u003cVec\u003c_\u003e\u003e();\n\n        let time_zone_name = env::var(\"APP_TIMEZONE\").unwrap_or_else(|_| \"UTC\".to_string());\n        let time_zone: Tz = time_zone_name\n            .parse()\n            .map_err(|_| anyhow!(\"Invalid APP_TIMEZONE value: {}\", time_zone_name))?;\n\n        let mfa_issuer = env::var(\"MFA_ISSUER\").unwrap_or_else(|_| \"Timekeeper\".to_string());\n\n        let rate_limit_ip_max_requests = env::var(\"RATE_LIMIT_IP_MAX_REQUESTS\")\n            .unwrap_or_else(|_| \"15\".to_string())\n            .parse()\n            .unwrap_or(15);\n\n        let rate_limit_ip_window_seconds = env::var(\"RATE_LIMIT_IP_WINDOW_SECONDS\")\n            .unwrap_or_else(|_| \"900\".to_string())\n            .parse()\n            .unwrap_or(900);\n\n        let rate_limit_user_max_requests = env::var(\"RATE_LIMIT_USER_MAX_REQUESTS\")\n            .unwrap_or_else(|_| \"20\".to_string())\n            .parse()\n            .unwrap_or(20);\n\n        let rate_limit_user_window_seconds = env::var(\"RATE_LIMIT_USER_WINDOW_SECONDS\")\n            .unwrap_or_else(|_| \"3600\".to_string())\n            .parse()\n            .unwrap_or(3600);\n\n        let redis_url = env::var(\"REDIS_URL\").ok();\n        let redis_pool_size = env::var(\"REDIS_POOL_SIZE\")\n            .unwrap_or_else(|_| \"10\".to_string())\n            .parse()\n            .unwrap_or(10);\n        let redis_connect_timeout = env::var(\"REDIS_CONNECT_TIMEOUT\")\n            .unwrap_or_else(|_| \"5\".to_string())\n            .parse()\n            .unwrap_or(5);\n\n        let feature_redis_cache_enabled = env::var(\"FEATURE_REDIS_CACHE_ENABLED\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let feature_read_replica_enabled = env::var(\"FEATURE_READ_REPLICA_ENABLED\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let password_min_length = env::var(\"PASSWORD_MIN_LENGTH\")\n            .unwrap_or_else(|_| \"12\".to_string())\n            .parse()\n            .unwrap_or(12);\n\n        let password_require_uppercase = env::var(\"PASSWORD_REQUIRE_UPPERCASE\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let password_require_lowercase = env::var(\"PASSWORD_REQUIRE_LOWERCASE\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let password_require_numbers = env::var(\"PASSWORD_REQUIRE_NUMBERS\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let password_require_symbols = env::var(\"PASSWORD_REQUIRE_SYMBOLS\")\n            .unwrap_or_else(|_| \"true\".to_string())\n            .parse()\n            .unwrap_or(true);\n\n        let password_expiration_days = env::var(\"PASSWORD_EXPIRATION_DAYS\")\n            .unwrap_or_else(|_| \"90\".to_string())\n            .parse()\n            .unwrap_or(90);\n\n        let password_history_count = env::var(\"PASSWORD_HISTORY_COUNT\")\n            .unwrap_or_else(|_| \"5\".to_string())\n            .parse()\n            .unwrap_or(5);\n\n        let production_mode = env::var(\"PRODUCTION_MODE\")\n            .unwrap_or_else(|_| \"false\".to_string())\n            .parse()\n            .unwrap_or(false);\n\n        Ok(Self {\n            database_url,\n            read_database_url,\n            jwt_secret,\n            jwt_expiration_hours,\n            refresh_token_expiration_days,\n            max_concurrent_sessions,\n            audit_log_retention_days,\n            audit_log_retention_forever,\n            consent_log_retention_days,\n            consent_log_retention_forever,\n            aws_region,\n            aws_kms_key_id,\n            aws_audit_log_bucket,\n            aws_cloudtrail_enabled,\n            cookie_secure,\n            cookie_same_site,\n            cors_allow_origins,\n            time_zone,\n            mfa_issuer,\n            rate_limit_ip_max_requests,\n            rate_limit_ip_window_seconds,\n            rate_limit_user_max_requests,\n            rate_limit_user_window_seconds,\n            redis_url,\n            redis_pool_size,\n            redis_connect_timeout,\n            feature_redis_cache_enabled,\n            feature_read_replica_enabled,\n            password_min_length,\n            password_require_uppercase,\n            password_require_lowercase,\n            password_require_numbers,\n            password_require_symbols,\n            password_expiration_days,\n            password_history_count,\n            production_mode,\n        })\n    }\n\n    pub fn audit_log_retention_policy(\u0026self) -\u003e AuditLogRetentionPolicy {\n        if self.audit_log_retention_forever {\n            AuditLogRetentionPolicy::Forever\n        } else if self.audit_log_retention_days == 0 {\n            AuditLogRetentionPolicy::Disabled\n        } else {\n            AuditLogRetentionPolicy::Days(self.audit_log_retention_days)\n        }\n    }\n\n    pub fn consent_log_retention_policy(\u0026self) -\u003e AuditLogRetentionPolicy {\n        if self.consent_log_retention_forever {\n            AuditLogRetentionPolicy::Forever\n        } else if self.consent_log_retention_days == 0 {\n            AuditLogRetentionPolicy::Disabled\n        } else {\n            AuditLogRetentionPolicy::Days(self.consent_log_retention_days)\n        }\n    }\n}\n\nfn parse_same_site(raw: String) -\u003e anyhow::Result\u003cSameSite\u003e {\n    match raw.to_ascii_lowercase().as_str() {\n        \"lax\" =\u003e Ok(SameSite::Lax),\n        \"strict\" =\u003e Ok(SameSite::Strict),\n        \"none\" =\u003e Ok(SameSite::None),\n        _ =\u003e Err(anyhow!(\"Invalid COOKIE_SAMESITE value: {}\", raw)),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono_tz::UTC;\n    use std::sync::{Mutex, OnceLock};\n\n    fn env_guard() -\u003e std::sync::MutexGuard\u003c'static, ()\u003e {\n        static ENV_MUTEX: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n        ENV_MUTEX\n            .get_or_init(|| Mutex::new(()))\n            .lock()\n            .expect(\"lock env\")\n    }\n\n    fn snapshot_env(keys: \u0026[\u0026str]) -\u003e Vec\u003cOption\u003cString\u003e\u003e {\n        keys.iter().map(|key| env::var(key).ok()).collect()\n    }\n\n    fn restore_env(keys: \u0026[\u0026str], values: Vec\u003cOption\u003cString\u003e\u003e) {\n        for (key, value) in keys.iter().zip(values.into_iter()) {\n            match value {\n                Some(value) =\u003e env::set_var(key, value),\n                None =\u003e env::remove_var(key),\n            }\n        }\n    }\n\n    fn set_optional_aws_env() {\n        env::remove_var(\"AWS_KMS_KEY_ID\");\n        env::remove_var(\"AWS_AUDIT_LOG_BUCKET\");\n    }\n\n    fn base_config() -\u003e Config {\n        Config {\n            database_url: \"postgres://test\".to_string(),\n            read_database_url: None,\n            jwt_secret: \"test-jwt-secret-32-chars-minimum!\".to_string(),\n            jwt_expiration_hours: 1,\n            refresh_token_expiration_days: 7,\n            max_concurrent_sessions: 3,\n            audit_log_retention_days: 1825,\n            audit_log_retention_forever: false,\n            consent_log_retention_days: 1825,\n            consent_log_retention_forever: false,\n            aws_region: \"ap-northeast-1\".to_string(),\n            aws_kms_key_id: \"alias/timekeeper-test\".to_string(),\n            aws_audit_log_bucket: \"timekeeper-audit-logs\".to_string(),\n            aws_cloudtrail_enabled: true,\n            cookie_secure: false,\n            cookie_same_site: SameSite::Lax,\n            cors_allow_origins: Vec::new(),\n            time_zone: UTC,\n            mfa_issuer: \"Timekeeper\".to_string(),\n            rate_limit_ip_max_requests: 15,\n            rate_limit_ip_window_seconds: 900,\n            rate_limit_user_max_requests: 20,\n            rate_limit_user_window_seconds: 3600,\n            redis_url: None,\n            redis_pool_size: 10,\n            redis_connect_timeout: 5,\n            feature_redis_cache_enabled: true,\n            feature_read_replica_enabled: true,\n            password_min_length: 12,\n            password_require_uppercase: true,\n            password_require_lowercase: true,\n            password_require_numbers: true,\n            password_require_symbols: true,\n            password_expiration_days: 90,\n            password_history_count: 5,\n            production_mode: false,\n        }\n    }\n\n    #[test]\n    fn config_loads_audit_log_retention_defaults() {\n        let _guard = env_guard();\n        let keys = [\n            \"JWT_SECRET\",\n            \"AUDIT_LOG_RETENTION_DAYS\",\n            \"AUDIT_LOG_RETENTION_FOREVER\",\n            \"CONSENT_LOG_RETENTION_DAYS\",\n            \"CONSENT_LOG_RETENTION_FOREVER\",\n            \"AWS_KMS_KEY_ID\",\n            \"AWS_AUDIT_LOG_BUCKET\",\n            \"AWS_REGION\",\n            \"AWS_CLOUDTRAIL_ENABLED\",\n        ];\n        let original = snapshot_env(\u0026keys);\n\n        env::set_var(\"JWT_SECRET\", \"a_secure_token_that_is_long_enough_123\");\n        env::remove_var(\"AUDIT_LOG_RETENTION_DAYS\");\n        env::remove_var(\"AUDIT_LOG_RETENTION_FOREVER\");\n        env::remove_var(\"CONSENT_LOG_RETENTION_DAYS\");\n        env::remove_var(\"CONSENT_LOG_RETENTION_FOREVER\");\n        env::remove_var(\"AWS_REGION\");\n        env::remove_var(\"AWS_CLOUDTRAIL_ENABLED\");\n        set_optional_aws_env();\n\n        let config = Config::load().expect(\"load config\");\n\n        assert_eq!(config.audit_log_retention_days, 1825);\n        assert!(!config.audit_log_retention_forever);\n        assert_eq!(config.consent_log_retention_days, 1825);\n        assert!(!config.consent_log_retention_forever);\n        assert_eq!(config.aws_kms_key_id, \"\");\n        assert_eq!(config.aws_audit_log_bucket, \"\");\n\n        restore_env(\u0026keys, original);\n    }\n\n    #[test]\n    fn config_loads_aws_defaults() {\n        let _guard = env_guard();\n        let keys = [\n            \"JWT_SECRET\",\n            \"AWS_KMS_KEY_ID\",\n            \"AWS_AUDIT_LOG_BUCKET\",\n            \"AWS_REGION\",\n            \"AWS_CLOUDTRAIL_ENABLED\",\n            \"CONSENT_LOG_RETENTION_DAYS\",\n            \"CONSENT_LOG_RETENTION_FOREVER\",\n        ];\n        let original = snapshot_env(\u0026keys);\n\n        env::set_var(\"JWT_SECRET\", \"a_secure_token_that_is_long_enough_123\");\n        env::remove_var(\"AWS_REGION\");\n        env::remove_var(\"AWS_CLOUDTRAIL_ENABLED\");\n        set_optional_aws_env();\n\n        let config = Config::load().expect(\"load config\");\n\n        assert_eq!(config.aws_region, \"ap-northeast-1\");\n        assert!(config.aws_cloudtrail_enabled);\n        assert_eq!(config.aws_kms_key_id, \"\");\n        assert_eq!(config.aws_audit_log_bucket, \"\");\n\n        restore_env(\u0026keys, original);\n    }\n\n    #[test]\n    fn config_aws_kms_key_id_is_optional() {\n        let _guard = env_guard();\n        let keys = [\"JWT_SECRET\", \"AWS_KMS_KEY_ID\", \"AWS_AUDIT_LOG_BUCKET\"];\n        let original = snapshot_env(\u0026keys);\n\n        env::set_var(\"JWT_SECRET\", \"a_secure_token_that_is_long_enough_123\");\n        env::remove_var(\"AWS_KMS_KEY_ID\");\n        env::set_var(\"AWS_AUDIT_LOG_BUCKET\", \"timekeeper-audit-logs\");\n\n        let config = Config::load().expect(\"config should load without kms key\");\n        assert_eq!(config.aws_kms_key_id, \"\");\n        assert_eq!(config.aws_audit_log_bucket, \"timekeeper-audit-logs\");\n\n        restore_env(\u0026keys, original);\n    }\n\n    #[test]\n    fn config_aws_audit_log_bucket_is_optional() {\n        let _guard = env_guard();\n        let keys = [\"JWT_SECRET\", \"AWS_KMS_KEY_ID\", \"AWS_AUDIT_LOG_BUCKET\"];\n        let original = snapshot_env(\u0026keys);\n\n        env::set_var(\"JWT_SECRET\", \"a_secure_token_that_is_long_enough_123\");\n        env::set_var(\"AWS_KMS_KEY_ID\", \"alias/timekeeper-test\");\n        env::remove_var(\"AWS_AUDIT_LOG_BUCKET\");\n\n        let config = Config::load().expect(\"config should load without audit bucket\");\n        assert_eq!(config.aws_kms_key_id, \"alias/timekeeper-test\");\n        assert_eq!(config.aws_audit_log_bucket, \"\");\n\n        restore_env(\u0026keys, original);\n    }\n\n    #[test]\n    fn audit_log_retention_policy_prioritizes_forever() {\n        let mut config = base_config();\n        config.audit_log_retention_days = 0;\n        config.audit_log_retention_forever = true;\n\n        let policy = config.audit_log_retention_policy();\n\n        assert_eq!(policy, AuditLogRetentionPolicy::Forever);\n        assert!(policy.is_recording_enabled());\n    }\n\n    #[test]\n    fn audit_log_retention_policy_disables_when_days_zero() {\n        let mut config = base_config();\n        config.audit_log_retention_days = 0;\n        config.audit_log_retention_forever = false;\n\n        let policy = config.audit_log_retention_policy();\n\n        assert_eq!(policy, AuditLogRetentionPolicy::Disabled);\n        assert!(!policy.is_recording_enabled());\n    }\n\n    #[test]\n    fn audit_log_retention_policy_returns_days() {\n        let mut config = base_config();\n        config.audit_log_retention_days = 30;\n        config.audit_log_retention_forever = false;\n\n        let policy = config.audit_log_retention_policy();\n\n        assert_eq!(policy, AuditLogRetentionPolicy::Days(30));\n        assert_eq!(policy.retention_days(), Some(30));\n    }\n}\n","traces":[{"line":57,"address":[22352544],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[22352549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[22352464],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[22352474],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[22352485],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[22352517],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[22352384],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[22352419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[22352437],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[22352768,22362580,22362013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[22352816],"length":1,"stats":{"Line":1},"fn_name":null},{"line":78,"address":[22352947],"length":1,"stats":{"Line":2},"fn_name":null},{"line":79,"address":[21394000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[22353036,22353101],"length":1,"stats":{"Line":2},"fn_name":null},{"line":84,"address":[22353136,22353244,22362521,22353312],"length":1,"stats":{"Line":2},"fn_name":null},{"line":85,"address":[22353296,22353221],"length":1,"stats":{"Line":1},"fn_name":null},{"line":86,"address":[22353473,22353409],"length":1,"stats":{"Line":2},"fn_name":null},{"line":87,"address":[22362282],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[22362266,22353518],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[22353479,22353574,22353712],"length":1,"stats":{"Line":3},"fn_name":null},{"line":94,"address":[21393648,21393664],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":98,"address":[22353946,22353739,22353808],"length":1,"stats":{"Line":3},"fn_name":null},{"line":99,"address":[21394208,21394224],"length":1,"stats":{"Line":3},"fn_name":"{closure#3}"},{"line":103,"address":[22353973,22354042,22354226,22354152],"length":1,"stats":{"Line":4},"fn_name":null},{"line":104,"address":[21395216,21395232],"length":1,"stats":{"Line":3},"fn_name":"{closure#4}"},{"line":108,"address":[22354490,22354321,22354252],"length":1,"stats":{"Line":3},"fn_name":null},{"line":109,"address":[21395104,21395120],"length":1,"stats":{"Line":3},"fn_name":"{closure#5}"},{"line":114,"address":[22354586,22354716,22354517],"length":1,"stats":{"Line":3},"fn_name":null},{"line":115,"address":[21393536,21393552],"length":1,"stats":{"Line":3},"fn_name":"{closure#6}"},{"line":119,"address":[22354982,22354744,22354813],"length":1,"stats":{"Line":3},"fn_name":null},{"line":120,"address":[22354775],"length":1,"stats":{"Line":3},"fn_name":null},{"line":125,"address":[22355208,22355009,22355078],"length":1,"stats":{"Line":3},"fn_name":null},{"line":126,"address":[22355040],"length":1,"stats":{"Line":3},"fn_name":null},{"line":130,"address":[21396000,21396016],"length":1,"stats":{"Line":3},"fn_name":"{closure#9}"},{"line":131,"address":[22355305,22355393],"length":1,"stats":{"Line":2},"fn_name":null},{"line":132,"address":[22355408,22355493],"length":1,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[22355615,22355745,22355508],"length":1,"stats":{"Line":3},"fn_name":null},{"line":134,"address":[21395344,21395328],"length":1,"stats":{"Line":3},"fn_name":"{closure#10}"},{"line":138,"address":[22355773,22355842,22355975],"length":1,"stats":{"Line":3},"fn_name":null},{"line":139,"address":[22355804],"length":1,"stats":{"Line":3},"fn_name":null},{"line":143,"address":[22362106,22356003],"length":1,"stats":{"Line":3},"fn_name":null},{"line":146,"address":[22356192,22356261],"length":1,"stats":{"Line":2},"fn_name":null},{"line":147,"address":[22356223],"length":1,"stats":{"Line":3},"fn_name":null},{"line":149,"address":[21394656,21394709],"length":1,"stats":{"Line":3},"fn_name":"{closure#14}"},{"line":150,"address":[21392953,21392928],"length":1,"stats":{"Line":3},"fn_name":"{closure#15}"},{"line":153,"address":[22356505],"length":1,"stats":{"Line":3},"fn_name":null},{"line":154,"address":[22356719,22356766,22356574],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[21394752,21394775],"length":1,"stats":{"Line":1},"fn_name":"{closure#17}"},{"line":158,"address":[22356807],"length":1,"stats":{"Line":3},"fn_name":null},{"line":160,"address":[22357088,22357162,22356868,22356981],"length":1,"stats":{"Line":4},"fn_name":null},{"line":161,"address":[22356943],"length":1,"stats":{"Line":3},"fn_name":null},{"line":165,"address":[22357257,22357395,22357188],"length":1,"stats":{"Line":3},"fn_name":null},{"line":166,"address":[21393888,21393872],"length":1,"stats":{"Line":3},"fn_name":"{closure#20}"},{"line":170,"address":[22357422,22357675,22357491,22357601],"length":1,"stats":{"Line":4},"fn_name":null},{"line":171,"address":[21396128,21396112],"length":1,"stats":{"Line":3},"fn_name":"{closure#21}"},{"line":175,"address":[22357701,22357908,22357770],"length":1,"stats":{"Line":3},"fn_name":null},{"line":176,"address":[21393776,21393760],"length":1,"stats":{"Line":3},"fn_name":"{closure#22}"},{"line":180,"address":[22357935],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[22358213,22357993,22358287,22358106],"length":1,"stats":{"Line":4},"fn_name":null},{"line":182,"address":[21395904,21395888],"length":1,"stats":{"Line":3},"fn_name":"{closure#23}"},{"line":185,"address":[22358313,22358382,22358520],"length":1,"stats":{"Line":3},"fn_name":null},{"line":186,"address":[21395680,21395664],"length":1,"stats":{"Line":3},"fn_name":"{closure#24}"},{"line":190,"address":[22358547,22358749,22358616],"length":1,"stats":{"Line":3},"fn_name":null},{"line":191,"address":[22358578],"length":1,"stats":{"Line":3},"fn_name":null},{"line":195,"address":[22358979,22358846,22358777],"length":1,"stats":{"Line":3},"fn_name":null},{"line":196,"address":[21392976,21392992],"length":1,"stats":{"Line":3},"fn_name":"{closure#26}"},{"line":200,"address":[22359076,22359007,22359214],"length":1,"stats":{"Line":3},"fn_name":null},{"line":201,"address":[21393440,21393424],"length":1,"stats":{"Line":3},"fn_name":"{closure#27}"},{"line":205,"address":[22359310,22359241,22359443],"length":1,"stats":{"Line":3},"fn_name":null},{"line":206,"address":[21393200,21393216],"length":1,"stats":{"Line":3},"fn_name":"{closure#28}"},{"line":210,"address":[22359540,22359471,22359673],"length":1,"stats":{"Line":3},"fn_name":null},{"line":211,"address":[22359502],"length":1,"stats":{"Line":3},"fn_name":null},{"line":215,"address":[22359770,22359903,22359701],"length":1,"stats":{"Line":3},"fn_name":null},{"line":216,"address":[21394336,21394320],"length":1,"stats":{"Line":3},"fn_name":"{closure#30}"},{"line":220,"address":[22360000,22360115,22359931],"length":1,"stats":{"Line":3},"fn_name":null},{"line":221,"address":[21395568,21395552],"length":1,"stats":{"Line":3},"fn_name":"{closure#31}"},{"line":225,"address":[22360332,22360143,22360212],"length":1,"stats":{"Line":3},"fn_name":null},{"line":226,"address":[21394448,21394432],"length":1,"stats":{"Line":3},"fn_name":"{closure#32}"},{"line":230,"address":[22360359,22360428,22360588,22360520],"length":1,"stats":{"Line":4},"fn_name":null},{"line":231,"address":[21392704,21392720],"length":1,"stats":{"Line":3},"fn_name":"{closure#33}"},{"line":235,"address":[22360614,22360789,22360683],"length":1,"stats":{"Line":3},"fn_name":null},{"line":236,"address":[21392448,21392432],"length":1,"stats":{"Line":3},"fn_name":"{closure#34}"},{"line":240,"address":[22361262],"length":1,"stats":{"Line":1},"fn_name":null},{"line":241,"address":[22360918],"length":1,"stats":{"Line":1},"fn_name":null},{"line":242,"address":[22360958],"length":1,"stats":{"Line":1},"fn_name":null},{"line":243,"address":[22360998],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[22361038],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[22361078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":253,"address":[22361118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[22361158],"length":1,"stats":{"Line":1},"fn_name":null},{"line":259,"address":[22361198],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[22361230],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[22352576],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[22352586,22352621],"length":1,"stats":{"Line":2},"fn_name":null},{"line":282,"address":[22352612],"length":1,"stats":{"Line":1},"fn_name":null},{"line":283,"address":[22352649,22352600],"length":1,"stats":{"Line":2},"fn_name":null},{"line":284,"address":[22352651],"length":1,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[22352628],"length":1,"stats":{"Line":1},"fn_name":null},{"line":290,"address":[22352672],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[22352717,22352682],"length":1,"stats":{"Line":0},"fn_name":null},{"line":292,"address":[22352708],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[22352745,22352696],"length":1,"stats":{"Line":0},"fn_name":null},{"line":294,"address":[22352747],"length":1,"stats":{"Line":0},"fn_name":null},{"line":296,"address":[22352724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[22352359,22351776],"length":1,"stats":{"Line":1},"fn_name":"parse_same_site"},{"line":302,"address":[22351806,22351879,22351956],"length":1,"stats":{"Line":3},"fn_name":null},{"line":303,"address":[22352043,22351972],"length":1,"stats":{"Line":2},"fn_name":null},{"line":304,"address":[22352103,22352015,22352059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[22352162,22352075,22352119],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[22352174,22352130],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":95,"coverable":110},{"path":["/","home","marra","projects","timekeeper","backend","src","db","connection.rs"],"content":"use sqlx::postgres::{PgPool, PgPoolOptions};\nuse std::time::Duration;\n\n/// Type alias so downstream code can reference the logical database pool in a single place.\npub type DbPool = PgPool;\n\n/// Database pool configuration from environment variables\n#[derive(Debug, Clone)]\npub struct PoolConfig {\n    pub max_connections: u32,\n    pub min_connections: u32,\n    pub acquire_timeout_secs: u64,\n    pub idle_timeout_secs: u64,\n    pub max_lifetime_secs: u64,\n}\n\nconst DEFAULT_IDLE_TIMEOUT_SECS: u64 = 600;\nconst DEFAULT_MAX_LIFETIME_SECS: u64 = 1800;\n\nimpl Default for PoolConfig {\n    fn default() -\u003e Self {\n        Self {\n            max_connections: 10,\n            min_connections: 2,\n            acquire_timeout_secs: 30,\n            idle_timeout_secs: DEFAULT_IDLE_TIMEOUT_SECS,\n            max_lifetime_secs: DEFAULT_MAX_LIFETIME_SECS,\n        }\n    }\n}\n\nimpl PoolConfig {\n    pub fn from_env() -\u003e Self {\n        Self {\n            max_connections: std::env::var(\"DB_MAX_CONNECTIONS\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(10),\n            min_connections: std::env::var(\"DB_MIN_CONNECTIONS\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(2),\n            acquire_timeout_secs: std::env::var(\"DB_ACQUIRE_TIMEOUT\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(30),\n            idle_timeout_secs: std::env::var(\"DB_IDLE_TIMEOUT\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(DEFAULT_IDLE_TIMEOUT_SECS),\n            max_lifetime_secs: std::env::var(\"DB_MAX_LIFETIME\")\n                .ok()\n                .and_then(|v| v.parse().ok())\n                .unwrap_or(DEFAULT_MAX_LIFETIME_SECS),\n        }\n    }\n\n    pub fn log(\u0026self) {\n        tracing::info!(\n            max_connections = self.max_connections,\n            min_connections = self.min_connections,\n            acquire_timeout_secs = self.acquire_timeout_secs,\n            idle_timeout_secs = self.idle_timeout_secs,\n            max_lifetime_secs = self.max_lifetime_secs,\n            \"Database pool configuration\"\n        );\n    }\n}\n\n#[allow(dead_code)]\npub async fn create_pool(database_url: \u0026str) -\u003e anyhow::Result\u003cDbPool\u003e {\n    let config: PoolConfig = PoolConfig::from_env();\n    let pool = create_pool_with_config(database_url, config).await?;\n\n    Ok(pool)\n}\n\npub async fn create_pool_with_config(\n    database_url: \u0026str,\n    config: PoolConfig,\n) -\u003e anyhow::Result\u003cDbPool\u003e {\n    config.log();\n\n    let span = tracing::info_span!(\"db_pool_connect\");\n    let _enter = span.enter();\n\n    let pool = PgPoolOptions::new()\n        .max_connections(config.max_connections)\n        .min_connections(config.min_connections)\n        .acquire_timeout(Duration::from_secs(config.acquire_timeout_secs))\n        .idle_timeout(Duration::from_secs(config.idle_timeout_secs))\n        .max_lifetime(Duration::from_secs(config.max_lifetime_secs))\n        .connect(database_url)\n        .await?;\n\n    Ok(pool)\n}\n\npub async fn create_pools(\n    write_url: \u0026str,\n    read_url: Option\u003c\u0026str\u003e,\n) -\u003e anyhow::Result\u003c(DbPool, Option\u003cDbPool\u003e)\u003e {\n    create_pools_with_config(write_url, read_url, PoolConfig::from_env()).await\n}\n\npub async fn create_pools_with_config(\n    write_url: \u0026str,\n    read_url: Option\u003c\u0026str\u003e,\n    config: PoolConfig,\n) -\u003e anyhow::Result\u003c(DbPool, Option\u003cDbPool\u003e)\u003e {\n    tracing::info!(\"Creating write pool\");\n    let write_pool = create_pool_with_config(write_url, config.clone()).await?;\n\n    let read_pool = if let Some(read_url) = read_url {\n        tracing::info!(\"Creating read replica pool\");\n        Some(create_pool_with_config(read_url, config).await?)\n    } else {\n        tracing::info!(\"No read replica configured, using write pool for reads\");\n        None\n    };\n\n    Ok((write_pool, read_pool))\n}\n","traces":[{"line":21,"address":[22257232],"length":1,"stats":{"Line":0},"fn_name":"default"},{"line":33,"address":[22248912],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[22248929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[22248997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[22249071],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[22249154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[22249237],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[22247760],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[22247780,22248313],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[22249389,22249376],"length":1,"stats":{"Line":0},"fn_name":"create_pool"},{"line":72,"address":[21564657],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[21564758,21565336,21564691,21564915],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[21565251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[22249456],"length":1,"stats":{"Line":0},"fn_name":"create_pool_with_config"},{"line":82,"address":[21566173],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21566273,21566938],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[21567091,21566893],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[21567431,21568125,21568289,21568543,21568062,21567556,21567721,21567094,21567306],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[21567156],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[21567194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21567236,21567256,21567330,21567838,21567113],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[21567381,21567455,21567361,21567809],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[21567777,21567486,21567506,21567580],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[21567611],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[21567754,21566210,21567894,21568110,21568241,21567686],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[21568396],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[22249408],"length":1,"stats":{"Line":0},"fn_name":"create_pools"},{"line":103,"address":[21565763,21565533,21565567,21565660],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[22249520],"length":1,"stats":{"Line":0},"fn_name":"create_pools_with_config"},{"line":111,"address":[21568956,21568810,21569359],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[20981039],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[21570808,21572812,21574133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[21570997,21570883,21571444],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[20981054],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21572434,21572824,21570911],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[21572800],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[21573666],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":37},{"path":["/","home","marra","projects","timekeeper","backend","src","db","mod.rs"],"content":"pub mod connection;\npub mod redis;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","db","redis.rs"],"content":"use crate::config::Config;\nuse bb8::Pool;\nuse bb8_redis::RedisConnectionManager;\nuse std::time::Duration;\n\npub type RedisPool = Pool\u003cRedisConnectionManager\u003e;\n\npub async fn create_redis_pool(config: \u0026Config) -\u003e anyhow::Result\u003cOption\u003cRedisPool\u003e\u003e {\n    let Some(url) = \u0026config.redis_url else {\n        tracing::info!(\"Redis URL not set, caching disabled\");\n        return Ok(None);\n    };\n\n    let manager = RedisConnectionManager::new(url.clone())?;\n    let pool = Pool::builder()\n        .max_size(config.redis_pool_size)\n        .connection_timeout(Duration::from_secs(config.redis_connect_timeout))\n        .build(manager)\n        .await?;\n\n    tracing::info!(\n        \"Redis connection pool created (size: {})\",\n        config.redis_pool_size\n    );\n    Ok(Some(pool))\n}\n","traces":[{"line":8,"address":[21840621,21839312,21842106,21840687,21839483,21839343],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":9,"address":[21839534,21839425],"length":1,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[21840736,21839561,21841138],"length":1,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[21841102],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[21840643,21839542,21839650],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[21840291,21840551,21842368,21844126,21840105,21842550,21842293],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[21840155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[21840203,21840315,21840235,21840611,21840112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[21840338],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[21842486,21842140,21839513,21840536,21842357,21840581],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[21842679,21842754,21843175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[21843128],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":12},{"path":["/","home","marra","projects","timekeeper","backend","src","docs.rs"],"content":"#![allow(dead_code)] // OpenAPI doc stubs are only referenced by utoipa macros.\n\nuse crate::{\n    handlers::{\n        admin::{\n            AdminAttendanceUpsert, AdminBreakItem, AdminHolidayListQuery, AdminHolidayListResponse,\n            AdminRequestListPageInfo, AdminRequestListResponse, AdminSessionResponse,\n            ApprovePayload, AuditLogExportQuery, AuditLogListQuery, AuditLogListResponse,\n            AuditLogResponse, DecisionPayload, ExportQuery, RejectPayload, RequestListQuery,\n            ResetMfaPayload, SubjectRequestListQuery, SubjectRequestListResponse,\n        },\n        attendance::{AttendanceExportQuery, AttendanceQuery, AttendanceStatusResponse},\n        sessions::SessionResponse,\n    },\n    models::{\n        attendance::{\n            AttendanceResponse, AttendanceSummary, BreakEndRequest, BreakStartRequest,\n            ClockInRequest, ClockOutRequest,\n        },\n        break_record::BreakRecordResponse,\n        consent_log::{ConsentLogResponse, RecordConsentPayload},\n        holiday::{\n            AdminHolidayKind, AdminHolidayListItem, CreateHolidayPayload,\n            CreateWeeklyHolidayPayload, HolidayResponse, WeeklyHolidayResponse,\n        },\n        holiday_exception::{CreateHolidayExceptionPayload, HolidayExceptionResponse},\n        leave_request::{CreateLeaveRequest, LeaveRequestResponse, LeaveType},\n        overtime_request::{CreateOvertimeRequest, OvertimeRequestResponse},\n        request::RequestStatus,\n        subject_request::{\n            CreateDataSubjectRequest, DataSubjectRequestResponse, DataSubjectRequestType,\n        },\n        user::{\n            ChangePasswordRequest, CreateUser, LoginRequest, LoginResponse, MfaCodeRequest,\n            MfaSetupResponse, MfaStatusResponse, UpdateUser, UserResponse,\n        },\n    },\n};\nuse utoipa::{\n    openapi::security::{Http, HttpAuthScheme, SecurityScheme},\n    Modify, OpenApi,\n};\n\n#[derive(OpenApi)]\n#[openapi(\n    paths(\n        login_doc,\n        refresh_doc,\n        me_doc,\n        mfa_status_doc,\n        mfa_setup_doc,\n        mfa_activate_doc,\n        mfa_disable_doc,\n        change_password_doc,\n        logout_doc,\n        list_sessions_doc,\n        revoke_session_doc,\n        clock_in_doc,\n        clock_out_doc,\n        break_start_doc,\n        break_end_doc,\n        attendance_status_doc,\n        my_attendance_doc,\n        my_attendance_summary_doc,\n        export_attendance_doc,\n        create_leave_doc,\n        create_overtime_doc,\n        my_requests_doc,\n        record_consent_doc,\n        list_my_consents_doc,\n        create_subject_request_doc,\n        list_my_subject_requests_doc,\n        cancel_subject_request_doc,\n        admin_list_requests_doc,\n        admin_request_detail_doc,\n        admin_approve_request_doc,\n        admin_reject_request_doc,\n        admin_list_subject_requests_doc,\n        admin_approve_subject_request_doc,\n        admin_reject_subject_request_doc,\n        admin_get_users_doc,\n        admin_create_user_doc,\n        admin_list_user_sessions_doc,\n        admin_revoke_session_doc,\n        admin_list_holidays_doc,\n        admin_create_holiday_doc,\n        admin_delete_holiday_doc,\n        admin_list_weekly_holidays_doc,\n        admin_create_weekly_holiday_doc,\n        admin_export_doc,\n        admin_list_audit_logs_doc,\n        admin_get_audit_log_doc,\n        admin_export_audit_logs_doc,\n        system_admin_reset_mfa_doc,\n        admin_create_holiday_exception_doc,\n        admin_list_holiday_exceptions_doc,\n        admin_delete_holiday_exception_doc\n    ),\n    components(\n        schemas(\n            // auth\n            LoginRequest,\n            LoginResponse,\n            ChangePasswordRequest,\n            MfaCodeRequest,\n            MfaSetupResponse,\n            MfaStatusResponse,\n            SessionResponse,\n            // users\n            CreateUser,\n            UpdateUser,\n            UserResponse,\n            // attendance \u0026 breaks\n            ClockInRequest,\n            ClockOutRequest,\n            BreakStartRequest,\n            BreakEndRequest,\n            AttendanceResponse,\n            AttendanceSummary,\n            AttendanceStatusResponse,\n            BreakRecordResponse,\n            AttendanceQuery,\n            AttendanceExportQuery,\n            // requests\n            CreateLeaveRequest,\n            LeaveRequestResponse,\n            LeaveType,\n            CreateOvertimeRequest,\n            OvertimeRequestResponse,\n            RequestStatus,\n            CreateDataSubjectRequest,\n            DataSubjectRequestResponse,\n            DataSubjectRequestType,\n            RecordConsentPayload,\n            ConsentLogResponse,\n            RequestListQuery,\n            AdminRequestListResponse,\n            AdminRequestListPageInfo,\n            SubjectRequestListQuery,\n            SubjectRequestListResponse,\n            DecisionPayload,\n            // holidays\n            CreateHolidayPayload,\n            HolidayResponse,\n            CreateWeeklyHolidayPayload,\n            WeeklyHolidayResponse,\n            CreateHolidayExceptionPayload,\n            HolidayExceptionResponse,\n            // admin-specific payloads\n            AdminAttendanceUpsert,\n            AdminBreakItem,\n            ApprovePayload,\n            RejectPayload,\n            ResetMfaPayload,\n            AdminHolidayListQuery,\n            AdminHolidayListResponse,\n            AdminHolidayKind,\n            AdminHolidayListItem,\n            AdminSessionResponse,\n            ExportQuery,\n            AuditLogListQuery,\n            AuditLogListResponse,\n            AuditLogResponse,\n            AuditLogExportQuery\n        )\n    ),\n    modifiers(\u0026SecuritySchemes),\n    tags(\n        (name = \"Auth\", description = \"認証・MFA・パスワード関連\"),\n        (name = \"Attendance\", description = \"勤怠・休憩・サマリー API\"),\n        (name = \"Requests\", description = \"申請 API (休暇/残業)\"),\n        (name = \"Compliance\", description = \"同意・法令対応 API\"),\n        (name = \"Admin\", description = \"管理者向け API\")\n    ),\n    security((\"BearerAuth\" = []))\n)]\npub struct ApiDoc;\n\nstruct SecuritySchemes;\n\nimpl Modify for SecuritySchemes {\n    fn modify(\u0026self, openapi: \u0026mut utoipa::openapi::OpenApi) {\n        let components = openapi.components.get_or_insert_default();\n\n        let mut bearer = Http::new(HttpAuthScheme::Bearer);\n        bearer.bearer_format = Some(\"JWT\".to_string());\n\n        components.add_security_scheme(\"BearerAuth\", SecurityScheme::Http(bearer));\n    }\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/auth/login\",\n    request_body = LoginRequest,\n    responses(\n        (status = 200, description = \"ログイン成功\", body = LoginResponse),\n        (status = 401, description = \"認証失敗\")\n    ),\n    tag = \"Auth\",\n    security(())\n)]\nfn login_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/auth/refresh\",\n    request_body = serde_json::Value,\n    responses((status = 200, description = \"トークン更新\", body = LoginResponse)),\n    tag = \"Auth\",\n    security(())\n)]\nfn refresh_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/auth/me\",\n    responses((status = 200, description = \"ログイン中のユーザー\", body = UserResponse)),\n    tag = \"Auth\"\n)]\nfn me_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/auth/mfa\",\n    responses((status = 200, body = MfaStatusResponse)),\n    tag = \"Auth\"\n)]\nfn mfa_status_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/auth/mfa/setup\",\n    responses((status = 200, body = MfaSetupResponse)),\n    tag = \"Auth\"\n)]\nfn mfa_setup_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/auth/mfa/activate\",\n    request_body = MfaCodeRequest,\n    responses((status = 200, description = \"MFA 有効化\", body = serde_json::Value)),\n    tag = \"Auth\"\n)]\nfn mfa_activate_doc() {}\n\n#[utoipa::path(\n    delete,\n    path = \"/api/auth/mfa\",\n    request_body = MfaCodeRequest,\n    responses((status = 200, description = \"MFA 無効化\", body = serde_json::Value)),\n    tag = \"Auth\"\n)]\nfn mfa_disable_doc() {}\n\n#[utoipa::path(\n    put,\n    path = \"/api/auth/change-password\",\n    request_body = ChangePasswordRequest,\n    responses((status = 200, description = \"パスワード変更完了\", body = serde_json::Value)),\n    tag = \"Auth\"\n)]\nfn change_password_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/auth/logout\",\n    request_body = serde_json::Value,\n    responses((status = 200, description = \"ログアウト\", body = serde_json::Value)),\n    tag = \"Auth\"\n)]\nfn logout_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/auth/sessions\",\n    responses((status = 200, body = [SessionResponse])),\n    tag = \"Auth\"\n)]\nfn list_sessions_doc() {}\n\n#[utoipa::path(\n    delete,\n    path = \"/api/auth/sessions/{id}\",\n    params((\"id\" = String, Path, description = \"Session ID\")),\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Auth\"\n)]\nfn revoke_session_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/attendance/clock-in\",\n    request_body = ClockInRequest,\n    responses((status = 200, body = AttendanceResponse)),\n    tag = \"Attendance\"\n)]\nfn clock_in_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/attendance/clock-out\",\n    request_body = ClockOutRequest,\n    responses((status = 200, body = AttendanceResponse)),\n    tag = \"Attendance\"\n)]\nfn clock_out_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/attendance/break-start\",\n    request_body = BreakStartRequest,\n    responses((status = 200, body = BreakRecordResponse)),\n    tag = \"Attendance\"\n)]\nfn break_start_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/attendance/break-end\",\n    request_body = BreakEndRequest,\n    responses((status = 200, body = BreakRecordResponse)),\n    tag = \"Attendance\"\n)]\nfn break_end_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/attendance/status\",\n    params(\n        (\"date\" = String, Query, description = \"対象日 YYYY-MM-DD\")\n    ),\n    responses((status = 200, body = AttendanceStatusResponse)),\n    tag = \"Attendance\"\n)]\nfn attendance_status_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/attendance/me\",\n    params(AttendanceQuery),\n    responses((status = 200, body = [AttendanceResponse])),\n    tag = \"Attendance\"\n)]\nfn my_attendance_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/attendance/me/summary\",\n    params(AttendanceQuery),\n    responses((status = 200, body = AttendanceSummary)),\n    tag = \"Attendance\"\n)]\nfn my_attendance_summary_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/attendance/export\",\n    params(AttendanceExportQuery),\n    responses((status = 200, description = \"CSV データを含む JSON\", body = serde_json::Value)),\n    tag = \"Attendance\"\n)]\nfn export_attendance_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/requests/leave\",\n    request_body = CreateLeaveRequest,\n    responses((status = 200, body = LeaveRequestResponse)),\n    tag = \"Requests\"\n)]\nfn create_leave_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/requests/overtime\",\n    request_body = CreateOvertimeRequest,\n    responses((status = 200, body = OvertimeRequestResponse)),\n    tag = \"Requests\"\n)]\nfn create_overtime_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/requests/me\",\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Requests\"\n)]\nfn my_requests_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/consents\",\n    request_body = RecordConsentPayload,\n    responses((status = 200, body = ConsentLogResponse)),\n    tag = \"Compliance\"\n)]\nfn record_consent_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/consents/me\",\n    responses((status = 200, body = [ConsentLogResponse])),\n    tag = \"Compliance\"\n)]\nfn list_my_consents_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/subject-requests\",\n    request_body = CreateDataSubjectRequest,\n    responses((status = 200, body = DataSubjectRequestResponse)),\n    tag = \"Compliance\"\n)]\nfn create_subject_request_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/subject-requests/me\",\n    responses((status = 200, body = [DataSubjectRequestResponse])),\n    tag = \"Compliance\"\n)]\nfn list_my_subject_requests_doc() {}\n\n#[utoipa::path(\n    delete,\n    path = \"/api/subject-requests/{id}\",\n    params((\"id\" = String, Path, description = \"Subject request ID\")),\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Compliance\"\n)]\nfn cancel_subject_request_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/requests\",\n    params(RequestListQuery),\n    responses((status = 200, body = AdminRequestListResponse)),\n    tag = \"Admin\"\n)]\nfn admin_list_requests_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/requests/{id}\",\n    params((\"id\" = String, Path, description = \"申請ID\")),\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_request_detail_doc() {}\n\n#[utoipa::path(\n    put,\n    path = \"/api/admin/requests/{id}/approve\",\n    params((\"id\" = String, Path, description = \"申請ID\")),\n    request_body = ApprovePayload,\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_approve_request_doc() {}\n\n#[utoipa::path(\n    put,\n    path = \"/api/admin/requests/{id}/reject\",\n    params((\"id\" = String, Path, description = \"申請ID\")),\n    request_body = RejectPayload,\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_reject_request_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/subject-requests\",\n    params(SubjectRequestListQuery),\n    responses((status = 200, body = SubjectRequestListResponse)),\n    tag = \"Admin\"\n)]\nfn admin_list_subject_requests_doc() {}\n\n#[utoipa::path(\n    put,\n    path = \"/api/admin/subject-requests/{id}/approve\",\n    params((\"id\" = String, Path, description = \"Subject request ID\")),\n    request_body = DecisionPayload,\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_approve_subject_request_doc() {}\n\n#[utoipa::path(\n    put,\n    path = \"/api/admin/subject-requests/{id}/reject\",\n    params((\"id\" = String, Path, description = \"Subject request ID\")),\n    request_body = DecisionPayload,\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_reject_subject_request_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/users\",\n    responses((status = 200, body = [UserResponse])),\n    tag = \"Admin\"\n)]\nfn admin_get_users_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/admin/users\",\n    request_body = CreateUser,\n    responses((status = 200, body = UserResponse)),\n    tag = \"Admin\"\n)]\nfn admin_create_user_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/users/{id}/sessions\",\n    params((\"id\" = String, Path, description = \"User ID\")),\n    responses((status = 200, body = [AdminSessionResponse])),\n    tag = \"Admin\"\n)]\nfn admin_list_user_sessions_doc() {}\n\n#[utoipa::path(\n    delete,\n    path = \"/api/admin/sessions/{id}\",\n    params((\"id\" = String, Path, description = \"Session ID\")),\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_revoke_session_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/holidays\",\n    params(AdminHolidayListQuery),\n    responses((status = 200, body = AdminHolidayListResponse)),\n    tag = \"Admin\"\n)]\nfn admin_list_holidays_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/admin/holidays\",\n    request_body = CreateHolidayPayload,\n    responses((status = 200, body = HolidayResponse)),\n    tag = \"Admin\"\n)]\nfn admin_create_holiday_doc() {}\n\n#[utoipa::path(\n    delete,\n    path = \"/api/admin/holidays/{id}\",\n    params((\"id\" = String, Path, description = \"休日ID\")),\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_delete_holiday_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/holidays/weekly\",\n    responses((status = 200, body = [WeeklyHolidayResponse])),\n    tag = \"Admin\"\n)]\nfn admin_list_weekly_holidays_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/admin/holidays/weekly\",\n    request_body = CreateWeeklyHolidayPayload,\n    responses((status = 200, body = WeeklyHolidayResponse)),\n    tag = \"Admin\"\n)]\nfn admin_create_weekly_holiday_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/export\",\n    params(ExportQuery),\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_export_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/audit-logs\",\n    params(AuditLogListQuery),\n    responses((status = 200, body = AuditLogListResponse)),\n    tag = \"Admin\"\n)]\nfn admin_list_audit_logs_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/audit-logs/{id}\",\n    params((\"id\" = String, Path, description = \"監査ログID\")),\n    responses((status = 200, body = AuditLogResponse)),\n    tag = \"Admin\"\n)]\nfn admin_get_audit_log_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/audit-logs/export\",\n    params(AuditLogExportQuery),\n    responses((status = 200, body = [AuditLogResponse])),\n    tag = \"Admin\"\n)]\nfn admin_export_audit_logs_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/admin/mfa/reset\",\n    request_body = ResetMfaPayload,\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn system_admin_reset_mfa_doc() {}\n\n#[utoipa::path(\n    post,\n    path = \"/api/admin/users/{user_id}/holiday-exceptions\",\n    params((\"user_id\" = String, Path, description = \"対象ユーザーID\")),\n    request_body = CreateHolidayExceptionPayload,\n    responses(\n        (status = 201, body = HolidayExceptionResponse),\n        (status = 400, description = \"不正なリクエスト\")\n    ),\n    tag = \"Admin\"\n)]\nfn admin_create_holiday_exception_doc() {}\n\n#[utoipa::path(\n    get,\n    path = \"/api/admin/users/{user_id}/holiday-exceptions\",\n    params(\n        (\"user_id\" = String, Path, description = \"対象ユーザーID\"),\n        (\"from\" = Option\u003cString\u003e, Query, description = \"開始日\"),\n        (\"to\" = Option\u003cString\u003e, Query, description = \"終了日\")\n    ),\n    responses((status = 200, body = [HolidayExceptionResponse])),\n    tag = \"Admin\"\n)]\nfn admin_list_holiday_exceptions_doc() {}\n\n#[utoipa::path(\n    delete,\n    path = \"/api/admin/users/{user_id}/holiday-exceptions/{id}\",\n    params(\n        (\"user_id\" = String, Path, description = \"対象ユーザーID\"),\n        (\"id\" = String, Path, description = \"例外ID\")\n    ),\n    responses((status = 200, body = serde_json::Value)),\n    tag = \"Admin\"\n)]\nfn admin_delete_holiday_exception_doc() {}\n","traces":[{"line":182,"address":[18512480,18513129,18513163],"length":1,"stats":{"Line":0},"fn_name":"modify"},{"line":183,"address":[18512514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[18512551],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[18512706,18512586,18512658],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[18512819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[18458208],"length":1,"stats":{"Line":0},"fn_name":"login_doc"},{"line":213,"address":[18457424],"length":1,"stats":{"Line":0},"fn_name":"refresh_doc"},{"line":221,"address":[18458192],"length":1,"stats":{"Line":0},"fn_name":"me_doc"},{"line":229,"address":[18457504],"length":1,"stats":{"Line":0},"fn_name":"mfa_status_doc"},{"line":237,"address":[18457488],"length":1,"stats":{"Line":0},"fn_name":"mfa_setup_doc"},{"line":246,"address":[18457600],"length":1,"stats":{"Line":0},"fn_name":"mfa_activate_doc"},{"line":255,"address":[18457536],"length":1,"stats":{"Line":0},"fn_name":"mfa_disable_doc"},{"line":264,"address":[18457696],"length":1,"stats":{"Line":0},"fn_name":"change_password_doc"},{"line":273,"address":[18457408],"length":1,"stats":{"Line":0},"fn_name":"logout_doc"},{"line":281,"address":[18457616],"length":1,"stats":{"Line":0},"fn_name":"list_sessions_doc"},{"line":290,"address":[18457664],"length":1,"stats":{"Line":0},"fn_name":"revoke_session_doc"},{"line":299,"address":[18457440],"length":1,"stats":{"Line":0},"fn_name":"clock_in_doc"},{"line":308,"address":[18457472],"length":1,"stats":{"Line":0},"fn_name":"clock_out_doc"},{"line":317,"address":[18457520],"length":1,"stats":{"Line":0},"fn_name":"break_start_doc"},{"line":326,"address":[18457456],"length":1,"stats":{"Line":0},"fn_name":"break_end_doc"},{"line":337,"address":[18457760],"length":1,"stats":{"Line":0},"fn_name":"attendance_status_doc"},{"line":346,"address":[18457632],"length":1,"stats":{"Line":0},"fn_name":"my_attendance_doc"},{"line":355,"address":[18457952],"length":1,"stats":{"Line":0},"fn_name":"my_attendance_summary_doc"},{"line":364,"address":[18457776],"length":1,"stats":{"Line":0},"fn_name":"export_attendance_doc"},{"line":373,"address":[18457584],"length":1,"stats":{"Line":0},"fn_name":"create_leave_doc"},{"line":382,"address":[18457712],"length":1,"stats":{"Line":0},"fn_name":"create_overtime_doc"},{"line":390,"address":[18457552],"length":1,"stats":{"Line":0},"fn_name":"my_requests_doc"},{"line":399,"address":[18457648],"length":1,"stats":{"Line":0},"fn_name":"record_consent_doc"},{"line":407,"address":[18457728],"length":1,"stats":{"Line":0},"fn_name":"list_my_consents_doc"},{"line":416,"address":[18457984],"length":1,"stats":{"Line":0},"fn_name":"create_subject_request_doc"},{"line":424,"address":[18458048],"length":1,"stats":{"Line":0},"fn_name":"list_my_subject_requests_doc"},{"line":433,"address":[18457968],"length":1,"stats":{"Line":0},"fn_name":"cancel_subject_request_doc"},{"line":442,"address":[18457824],"length":1,"stats":{"Line":0},"fn_name":"admin_list_requests_doc"},{"line":451,"address":[18457888],"length":1,"stats":{"Line":0},"fn_name":"admin_request_detail_doc"},{"line":461,"address":[18457920],"length":1,"stats":{"Line":0},"fn_name":"admin_approve_request_doc"},{"line":471,"address":[18457872],"length":1,"stats":{"Line":0},"fn_name":"admin_reject_request_doc"},{"line":480,"address":[18458096],"length":1,"stats":{"Line":0},"fn_name":"admin_list_subject_requests_doc"},{"line":490,"address":[18458128],"length":1,"stats":{"Line":0},"fn_name":"admin_approve_subject_request_doc"},{"line":500,"address":[18458112],"length":1,"stats":{"Line":0},"fn_name":"admin_reject_subject_request_doc"},{"line":508,"address":[18457680],"length":1,"stats":{"Line":0},"fn_name":"admin_get_users_doc"},{"line":517,"address":[18457744],"length":1,"stats":{"Line":0},"fn_name":"admin_create_user_doc"},{"line":526,"address":[18458032],"length":1,"stats":{"Line":0},"fn_name":"admin_list_user_sessions_doc"},{"line":535,"address":[18457904],"length":1,"stats":{"Line":0},"fn_name":"admin_revoke_session_doc"},{"line":544,"address":[18457808],"length":1,"stats":{"Line":0},"fn_name":"admin_list_holidays_doc"},{"line":553,"address":[18457840],"length":1,"stats":{"Line":0},"fn_name":"admin_create_holiday_doc"},{"line":562,"address":[18457856],"length":1,"stats":{"Line":0},"fn_name":"admin_delete_holiday_doc"},{"line":570,"address":[18458064],"length":1,"stats":{"Line":0},"fn_name":"admin_list_weekly_holidays_doc"},{"line":579,"address":[18458080],"length":1,"stats":{"Line":0},"fn_name":"admin_create_weekly_holiday_doc"},{"line":588,"address":[18457568],"length":1,"stats":{"Line":0},"fn_name":"admin_export_doc"},{"line":597,"address":[18457936],"length":1,"stats":{"Line":0},"fn_name":"admin_list_audit_logs_doc"},{"line":606,"address":[18457792],"length":1,"stats":{"Line":0},"fn_name":"admin_get_audit_log_doc"},{"line":615,"address":[18458016],"length":1,"stats":{"Line":0},"fn_name":"admin_export_audit_logs_doc"},{"line":624,"address":[18458000],"length":1,"stats":{"Line":0},"fn_name":"system_admin_reset_mfa_doc"},{"line":637,"address":[18458160],"length":1,"stats":{"Line":0},"fn_name":"admin_create_holiday_exception_doc"},{"line":650,"address":[18458144],"length":1,"stats":{"Line":0},"fn_name":"admin_list_holiday_exceptions_doc"},{"line":662,"address":[18458176],"length":1,"stats":{"Line":0},"fn_name":"admin_delete_holiday_exception_doc"}],"covered":0,"coverable":56},{"path":["/","home","marra","projects","timekeeper","backend","src","error","mod.rs"],"content":"use axum::{\n    http::StatusCode,\n    response::{IntoResponse, Response},\n    Json,\n};\nuse serde::Serialize;\nuse serde_json::Value;\n\n#[derive(Debug, Serialize)]\npub struct ErrorResponse {\n    pub error: String,\n    pub code: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub details: Option\u003cValue\u003e,\n}\n\n#[derive(Debug)]\npub enum AppError {\n    NotFound(String),\n    Unauthorized(String),\n    Forbidden(String),\n    Conflict(String),\n    BadRequest(String),\n    InternalServerError(anyhow::Error),\n    Validation(Vec\u003cString\u003e),\n}\n\nimpl IntoResponse for AppError {\n    fn into_response(self) -\u003e Response {\n        let (status, error_message, code, details) = match self {\n            AppError::NotFound(msg) =\u003e (StatusCode::NOT_FOUND, msg, \"NOT_FOUND\".to_string(), None),\n            AppError::Unauthorized(msg) =\u003e (\n                StatusCode::UNAUTHORIZED,\n                msg,\n                \"UNAUTHORIZED\".to_string(),\n                None,\n            ),\n            AppError::Forbidden(msg) =\u003e (StatusCode::FORBIDDEN, msg, \"FORBIDDEN\".to_string(), None),\n            AppError::Conflict(msg) =\u003e (StatusCode::CONFLICT, msg, \"CONFLICT\".to_string(), None),\n            AppError::BadRequest(msg) =\u003e (\n                StatusCode::BAD_REQUEST,\n                msg,\n                \"BAD_REQUEST\".to_string(),\n                None,\n            ),\n            AppError::InternalServerError(err) =\u003e {\n                tracing::error!(\"Internal server error: {:?}\", err);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Internal server error\".to_string(),\n                    \"INTERNAL_SERVER_ERROR\".to_string(),\n                    None,\n                )\n            }\n            AppError::Validation(errors) =\u003e (\n                StatusCode::BAD_REQUEST,\n                \"Validation failed\".to_string(),\n                \"VALIDATION_ERROR\".to_string(),\n                Some(serde_json::json!({ \"errors\": errors })),\n            ),\n        };\n\n        let body = Json(ErrorResponse {\n            error: error_message,\n            code,\n            details,\n        });\n\n        (status, body).into_response()\n    }\n}\n\nimpl From\u003canyhow::Error\u003e for AppError {\n    fn from(err: anyhow::Error) -\u003e Self {\n        AppError::InternalServerError(err)\n    }\n}\n\nimpl From\u003csqlx::Error\u003e for AppError {\n    fn from(err: sqlx::Error) -\u003e Self {\n        match err {\n            sqlx::Error::RowNotFound =\u003e AppError::NotFound(\"Resource not found\".to_string()),\n            _ =\u003e AppError::InternalServerError(err.into()),\n        }\n    }\n}\n\nimpl From\u003cvalidator::ValidationErrors\u003e for AppError {\n    fn from(errors: validator::ValidationErrors) -\u003e Self {\n        let messages: Vec\u003cString\u003e = errors\n            .field_errors()\n            .into_iter()\n            .flat_map(|(field, errs)| {\n                errs.iter().map(move |e| {\n                    let code = e.code.as_ref();\n                    format!(\"{}: {}\", field, code)\n                })\n            })\n            .collect();\n        AppError::Validation(messages)\n    }\n}\n","traces":[{"line":29,"address":[19445971,19444496],"length":1,"stats":{"Line":0},"fn_name":"into_response"},{"line":30,"address":[19445433,19444527],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[19444604,19445203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[19444702,19446039],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[19444726],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[19444758],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[19446031],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[19444800,19446214],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[19446441,19444898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[19446720,19444996],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[19445020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[19445052],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[19446712],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[19445094],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[19445106,19446946,19447330],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[19447296],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[19448252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[19448327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[19449116,19445145],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[19445169],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[19448568],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[19448648,19448696,19449466],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[19445689],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[19445569],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[19445609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[19445649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[19445865],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[19452352],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":75,"address":[19452360],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[19449810,19449784,19449488],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":81,"address":[19449510],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[19449567,19449692],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[19449600,19449745],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[19450029,19449824],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":93,"address":[19449942],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[22487069,22487135,22487264],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":95,"address":[22487313],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[22487334],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[19449976],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":39},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","attendance.rs"],"content":"use crate::error::AppError;\nuse crate::models::{PaginatedResponse, PaginationQuery};\nuse crate::types::{AttendanceId, BreakRecordId, UserId};\nuse axum::{\n    extract::{Extension, Path, Query, State},\n    Json,\n};\nuse chrono::Utc;\nuse serde::Deserialize;\nuse std::str::FromStr;\nuse utoipa::ToSchema;\n\nuse crate::repositories::attendance::{AttendanceRepository, AttendanceRepositoryTrait};\nuse crate::repositories::break_record::BreakRecordRepository;\nuse crate::repositories::repository::Repository;\nuse crate::repositories::transaction;\nuse crate::state::AppState;\nuse crate::{\n    handlers::attendance::recalculate_total_hours,\n    handlers::attendance_utils::{get_break_records, get_break_records_map},\n    models::{attendance::AttendanceResponse, user::User},\n    utils::time,\n};\n\npub async fn get_all_attendance(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(pagination): Query\u003cPaginationQuery\u003e,\n) -\u003e Result\u003cJson\u003cPaginatedResponse\u003cAttendanceResponse\u003e\u003e, AppError\u003e {\n    if !user.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let limit = pagination.limit();\n    let offset = pagination.offset();\n\n    let repo = AttendanceRepository::new();\n    let total = repo.count_all(state.read_pool()).await?;\n\n    let attendances = repo\n        .list_paginated(state.read_pool(), limit, offset)\n        .await?;\n\n    let attendance_ids: Vec\u003cAttendanceId\u003e = attendances.iter().map(|a| a.id).collect();\n    let mut break_map = get_break_records_map(state.read_pool(), \u0026attendance_ids).await?;\n\n    let mut data = Vec::new();\n    for attendance in attendances {\n        let break_records = break_map.remove(\u0026attendance.id).unwrap_or_default();\n        let response = AttendanceResponse {\n            id: attendance.id,\n            user_id: attendance.user_id,\n            date: attendance.date,\n            clock_in_time: attendance.clock_in_time,\n            clock_out_time: attendance.clock_out_time,\n            status: attendance.status,\n            total_work_hours: attendance.total_work_hours,\n            break_records,\n        };\n        data.push(response);\n    }\n\n    Ok(Json(PaginatedResponse::new(data, total, limit, offset)))\n}\n\n// Admin: create/replace attendance for a day (basic version)\n#[derive(Deserialize, ToSchema)]\npub struct AdminAttendanceUpsert {\n    pub user_id: String,\n    pub date: String,          // YYYY-MM-DD\n    pub clock_in_time: String, // ISO naive or with Z\n    pub clock_out_time: Option\u003cString\u003e,\n    pub breaks: Option\u003cVec\u003cAdminBreakItem\u003e\u003e,\n}\n\n#[derive(Deserialize, ToSchema)]\npub struct AdminBreakItem {\n    pub break_start_time: String,\n    pub break_end_time: Option\u003cString\u003e,\n}\n\npub async fn upsert_attendance(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(body): Json\u003cAdminAttendanceUpsert\u003e,\n) -\u003e Result\u003cJson\u003cAttendanceResponse\u003e, AppError\u003e {\n    if !user.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    use crate::models::attendance::AttendanceResponse;\n    use chrono::{NaiveDate, NaiveDateTime};\n\n    let AdminAttendanceUpsert {\n        user_id,\n        date,\n        clock_in_time,\n        clock_out_time,\n        breaks,\n    } = body;\n\n    let date = NaiveDate::parse_from_str(\u0026date, \"%Y-%m-%d\")\n        .map_err(|_| AppError::BadRequest(\"Invalid date\".into()))?;\n    let cin = NaiveDateTime::parse_from_str(\u0026clock_in_time, \"%Y-%m-%dT%H:%M:%S\")\n        .or_else(|_| chrono::NaiveDateTime::parse_from_str(\u0026clock_in_time, \"%Y-%m-%d %H:%M:%S\"))\n        .map_err(|_| AppError::BadRequest(\"Invalid clock_in_time\".into()))?;\n    let cout = match \u0026clock_out_time {\n        Some(s) =\u003e Some(\n            NaiveDateTime::parse_from_str(s, \"%Y-%m-%dT%H:%M:%S\")\n                .or_else(|_| chrono::NaiveDateTime::parse_from_str(s, \"%Y-%m-%d %H:%M:%S\"))\n                .map_err(|_| AppError::BadRequest(\"Invalid clock_out_time\".into()))?,\n        ),\n        None =\u003e None,\n    };\n\n    let mut tx = transaction::begin_transaction(\u0026state.write_pool).await?;\n\n    // Parse and validate user_id\n    let user_id_typed = UserId::from_str(\u0026user_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid user_id format\".into()))?;\n\n    let attendance_repo = AttendanceRepository::new();\n    let break_repo = BreakRecordRepository::new();\n\n    // ensure unique per user/date: delete existing and reinsert (basic upsert)\n    attendance_repo\n        .delete_by_user_and_date(\u0026mut tx, user_id_typed, date)\n        .await?;\n\n    let mut att = crate::models::attendance::Attendance::new(\n        user_id_typed,\n        date,\n        time::now_utc(\u0026state.config.time_zone),\n    );\n    att.clock_in_time = Some(cin);\n    att.clock_out_time = cout;\n\n    let mut total_break_minutes: i64 = 0;\n    let mut pending_breaks: Vec\u003ccrate::models::break_record::BreakRecord\u003e = Vec::new();\n\n    if let Some(bks) = breaks {\n        for b in bks {\n            let bs =\n                chrono::NaiveDateTime::parse_from_str(\u0026b.break_start_time, \"%Y-%m-%dT%H:%M:%S\")\n                    .or_else(|_| {\n                        chrono::NaiveDateTime::parse_from_str(\n                            \u0026b.break_start_time,\n                            \"%Y-%m-%d %H:%M:%S\",\n                        )\n                    })\n                    .map_err(|_| AppError::BadRequest(\"Invalid break_start_time\".into()))?;\n            let be: Option\u003cchrono::NaiveDateTime\u003e = b.break_end_time.as_ref().and_then(|s| {\n                chrono::NaiveDateTime::parse_from_str(s, \"%Y-%m-%dT%H:%M:%S\")\n                    .ok()\n                    .or_else(|| chrono::NaiveDateTime::parse_from_str(s, \"%Y-%m-%d %H:%M:%S\").ok())\n            });\n            let now_utc = time::now_utc(\u0026state.config.time_zone);\n            let mut br = crate::models::break_record::BreakRecord::new(att.id, bs, now_utc);\n            if let Some(bev) = be {\n                br.break_end_time = Some(bev);\n                let duration = bev.signed_duration_since(bs);\n                let d = duration.num_minutes().max(0);\n                br.duration_minutes = Some(d as i32);\n                br.updated_at = now_utc;\n                total_break_minutes += d;\n            }\n            pending_breaks.push(br);\n        }\n    }\n\n    att.calculate_work_hours(total_break_minutes);\n\n    attendance_repo.create_in_transaction(\u0026mut tx, \u0026att).await?;\n\n    // insert breaks\n    for br in pending_breaks {\n        break_repo.create_in_transaction(\u0026mut tx, \u0026br).await?;\n    }\n\n    transaction::commit_transaction(tx).await?;\n\n    let breaks = get_break_records(\u0026state.write_pool, att.id).await?;\n    Ok(Json(AttendanceResponse {\n        id: att.id,\n        user_id: att.user_id,\n        date: att.date,\n        clock_in_time: att.clock_in_time,\n        clock_out_time: att.clock_out_time,\n        status: att.status,\n        total_work_hours: att.total_work_hours,\n        break_records: breaks,\n    }))\n}\n\n// Admin: force end a break\n// Admin: force end a break\npub async fn force_end_break(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(break_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003ccrate::models::break_record::BreakRecordResponse\u003e, AppError\u003e {\n    if !user.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    let break_record_id = BreakRecordId::from_str(\u0026break_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid break record ID format\".into()))?;\n    let now_local = time::now_in_timezone(\u0026state.config.time_zone);\n    let now_utc = now_local.with_timezone(\u0026Utc);\n    let now = now_local.naive_local();\n    let break_repo = BreakRecordRepository::new();\n    let mut rec = break_repo\n        .find_by_id(\u0026state.write_pool, break_record_id)\n        .await?;\n\n    if rec.break_end_time.is_some() {\n        return Err(AppError::BadRequest(\"Break already ended\".into()));\n    }\n    rec.break_end_time = Some(now);\n    let duration = now.signed_duration_since(rec.break_start_time);\n    rec.duration_minutes = Some(duration.num_minutes() as i32);\n    rec.updated_at = now_utc;\n\n    break_repo.update(\u0026state.write_pool, \u0026rec).await?;\n\n    let attendance_repo = AttendanceRepository::new();\n    if let Some(attendance) = attendance_repo\n        .find_optional_by_id(\u0026state.write_pool, rec.attendance_id)\n        .await?\n    {\n        if attendance.clock_out_time.is_some() {\n            recalculate_total_hours(\u0026state.write_pool, attendance, now_utc).await?;\n        }\n    }\n\n    Ok(Json(\n        crate::models::break_record::BreakRecordResponse::from(rec),\n    ))\n}\n","traces":[{"line":25,"address":[22508624],"length":1,"stats":{"Line":0},"fn_name":"get_all_attendance"},{"line":30,"address":[19175025,19175181],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[19175187,19175275],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[19175466,19175233],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[19175469],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[19175527],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[19175542,19175072,19175761,19176398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[19176733,19176357,19176618,19176176,19177255,19176572],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[19176281,19176193],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[19175093,19176701,19176417,19176604,19176379,19176322],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[19176960,19179280,19179293,19176885],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":45,"address":[19175114,19177285,19177044,19177118],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[19177791],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[19177854,19177963,19178090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[19178258,19178734],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[19178741],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[19178757],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[19178773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[19178780],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[19178810],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[19178840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[19178847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[19179019],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[19178291],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[22508496],"length":1,"stats":{"Line":0},"fn_name":"upsert_attendance"},{"line":87,"address":[19162991,19163211],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[19163217,19163484],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[19163266],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[19163301],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[19163346],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[19163381],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[19163416],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[19163853,19163735,19163920,19165018,19163458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[19163830,19174469,19163888,19174448],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":103,"address":[19164013,19164168,19164235,19165016],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[19164099,19174212,19174176],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":105,"address":[19164203,19174085,19164145,19174064],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":106,"address":[19164366],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[19164961,19164525,19164435,19164627,19164694],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[19164581,19174368,19174404],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":110,"address":[19173893,19173872,19164604,19164662],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":112,"address":[19164466],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[19163038,19164484,19164888,19166098,19165054],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[19165732,19165686,19165590,19165799,19166073],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[19173790,19165767,19165709,19173776],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":121,"address":[19165903],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[19165910],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[19165925,19166329,19168565,19166283,19166444,19166021],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[19165935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[19166006,19166412,19166054,19163059,19166315,19166134],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[19166517],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[19166532],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[19166542],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[19166614],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[19166700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[19166756],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[19166768],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[19166832],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[19166920,19167056,19167183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[19167361,19167463,19167530,19167276],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[19173984,19167417],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":145,"address":[19174033],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[19174020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[19173664,19173685,19167440,19167498],"length":1,"stats":{"Line":0},"fn_name":"{closure#7}"},{"line":151,"address":[19174256,19167625],"length":1,"stats":{"Line":0},"fn_name":"{closure#8}"},{"line":152,"address":[19174288],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[19174320],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[19174592,19174345,19174560],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":156,"address":[19167677],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[19167707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[19167821,19168333],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[19167882],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[19167942,19168179],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[19168202],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[19168252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[19168272],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[19168338,19168302],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[19168049],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[19166983],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[19168578,19168440,19163080,19169394],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[19170008,19169233],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[19169434,19169407,19170152,19170394,19169739,19163101],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[19170472,19170217,19170986,19163122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[19163143,19170999,19172400,19170855],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[19171527],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[19171414],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[19171429],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[19171444],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[19171450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[19171478],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[19171506],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[19171512],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[22508368],"length":1,"stats":{"Line":0},"fn_name":"force_end_break"},{"line":201,"address":[19157153,19157334],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[19157340,19157413],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[19158044,19157386,19157595,19157641,19157708],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[19162238,19157676,19157618,19162224],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":206,"address":[19157797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[19157829],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[19157866],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[19157890],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[19158230,19157922,19157905,19157992,19158340,19158518,19159447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[19157954,19157915],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[19158083,19157977,19158025,19158326,19158486,19157200],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[19158777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[19159307,19159006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[19158817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":218,"address":[19158903,19159069],"length":1,"stats":{"Line":0},"fn_name":null},{"line":219,"address":[19159075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":220,"address":[19159133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[19159466,19159189,19160223,19157221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":224,"address":[19160062],"length":1,"stats":{"Line":0},"fn_name":null},{"line":225,"address":[19160725,19160384,19161387,19160077,19160518,19160182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[19160087],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[19160147,19160204,19160496,19160236,19160695,19157242],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[19160968,19161114,19161773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[19161131,19157263,19162171,19161400],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[19161786],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[19160994],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":119},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","audit_logs.rs"],"content":"use crate::error::AppError;\nuse axum::{\n    body::Body,\n    extract::{Extension, Path, Query, State},\n    http::{\n        header::{CONTENT_DISPOSITION, CONTENT_TYPE},\n        HeaderValue,\n    },\n    response::Response,\n    Json,\n};\nuse chrono::{DateTime, NaiveDate, NaiveDateTime, NaiveTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\nuse utoipa::{IntoParams, ToSchema};\n\nuse crate::{\n    models::{audit_log::AuditLog, user::User},\n    repositories::{\n        audit_log::{self, AuditLogFilters},\n        permissions,\n    },\n    state::AppState,\n    types::{AuditLogId, UserId},\n    utils::time,\n};\nuse std::str::FromStr;\n\nconst DEFAULT_PAGE: i64 = 1;\nconst DEFAULT_PER_PAGE: i64 = 25;\nconst MAX_PER_PAGE: i64 = 100;\nconst MAX_PAGE: i64 = 1_000;\n\n#[derive(Debug, Deserialize, Serialize, IntoParams, ToSchema)]\npub struct AuditLogListQuery {\n    pub from: Option\u003cString\u003e,\n    pub to: Option\u003cString\u003e,\n    pub actor_id: Option\u003cString\u003e,\n    pub actor_type: Option\u003cString\u003e,\n    pub event_type: Option\u003cString\u003e,\n    pub target_type: Option\u003cString\u003e,\n    pub target_id: Option\u003cString\u003e,\n    pub result: Option\u003cString\u003e,\n    pub page: Option\u003ci64\u003e,\n    pub per_page: Option\u003ci64\u003e,\n}\n\n#[derive(Debug, Deserialize, Serialize, IntoParams, ToSchema)]\npub struct AuditLogExportQuery {\n    pub from: String,\n    pub to: String,\n    pub actor_id: Option\u003cString\u003e,\n    pub actor_type: Option\u003cString\u003e,\n    pub event_type: Option\u003cString\u003e,\n    pub target_type: Option\u003cString\u003e,\n    pub target_id: Option\u003cString\u003e,\n    pub result: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\npub struct AuditLogResponse {\n    pub id: String,\n    pub occurred_at: DateTime\u003cUtc\u003e,\n    pub actor_id: Option\u003cString\u003e,\n    pub actor_type: String,\n    pub event_type: String,\n    pub target_type: Option\u003cString\u003e,\n    pub target_id: Option\u003cString\u003e,\n    pub result: String,\n    pub error_code: Option\u003cString\u003e,\n    pub metadata: Option\u003cValue\u003e,\n    pub ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub request_id: Option\u003cString\u003e,\n}\n\nimpl From\u003cAuditLog\u003e for AuditLogResponse {\n    fn from(log: AuditLog) -\u003e Self {\n        Self {\n            id: log.id.to_string(),\n            occurred_at: log.occurred_at,\n            actor_id: log.actor_id.map(|id| id.to_string()),\n            actor_type: log.actor_type,\n            event_type: log.event_type,\n            target_type: log.target_type,\n            target_id: log.target_id,\n            result: log.result,\n            error_code: log.error_code,\n            metadata: log.metadata.map(|value| value.0),\n            ip: log.ip,\n            user_agent: log.user_agent,\n            request_id: log.request_id,\n        }\n    }\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\npub struct AuditLogListResponse {\n    pub page: i64,\n    pub per_page: i64,\n    pub total: i64,\n    pub items: Vec\u003cAuditLogResponse\u003e,\n}\n\npub async fn list_audit_logs(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(q): Query\u003cAuditLogListQuery\u003e,\n) -\u003e Result\u003cJson\u003cAuditLogListResponse\u003e, AppError\u003e {\n    ensure_audit_log_access(\u0026state.write_pool, \u0026user).await?;\n\n    let (page, per_page, filters) = validate_list_query(q)?;\n    let offset = (page - 1) * per_page;\n    let (items, total): (Vec\u003ccrate::models::audit_log::AuditLog\u003e, i64) =\n        audit_log::list_audit_logs(state.read_pool(), \u0026filters, per_page, offset)\n            .await\n            .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    Ok(Json(AuditLogListResponse {\n        page,\n        per_page,\n        total,\n        items: items\n            .into_iter()\n            .map(AuditLogResponse::from)\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n    }))\n}\n\npub async fn get_audit_log_detail(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cAuditLogResponse\u003e, AppError\u003e {\n    ensure_audit_log_access(\u0026state.write_pool, \u0026user).await?;\n\n    let audit_log_id = AuditLogId::from_str(\u0026id)\n        .map_err(|_| AppError::BadRequest(\"Invalid audit log ID\".into()))?;\n\n    let log = audit_log::fetch_audit_log(state.read_pool(), audit_log_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n        .ok_or_else(|| AppError::NotFound(\"Not found\".into()))?;\n\n    Ok(Json(AuditLogResponse::from(log)))\n}\n\npub async fn export_audit_logs(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(q): Query\u003cAuditLogExportQuery\u003e,\n) -\u003e Result\u003cResponse, AppError\u003e {\n    ensure_audit_log_access(\u0026state.write_pool, \u0026user).await?;\n\n    let filters = validate_export_query(q)?;\n    let logs = audit_log::export_audit_logs(state.read_pool(), \u0026filters)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let payload: Vec\u003cAuditLogResponse\u003e = logs.into_iter().map(AuditLogResponse::from).collect();\n    let body = serde_json::to_vec(\u0026payload).map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let filename = format!(\n        \"audit_logs_{}.json\",\n        time::now_in_timezone(\u0026state.config.time_zone).format(\"%Y%m%d_%H%M%S\")\n    );\n    let mut response = Response::new(Body::from(body));\n    response\n        .headers_mut()\n        .insert(CONTENT_TYPE, HeaderValue::from_static(\"application/json\"));\n    response.headers_mut().insert(\n        CONTENT_DISPOSITION,\n        HeaderValue::from_str(\u0026format!(\"attachment; filename=\\\"{}\\\"\", filename))\n            .unwrap_or_else(|_| HeaderValue::from_static(\"attachment\")),\n    );\n    Ok(response)\n}\n\nasync fn ensure_audit_log_access(pool: \u0026sqlx::PgPool, user: \u0026User) -\u003e Result\u003c(), AppError\u003e {\n    if user.is_system_admin() {\n        return Ok(());\n    }\n\n    let user_id = user.id.to_string();\n    let allowed = permissions::user_has_permission(pool, \u0026user_id, permissions::AUDIT_LOG_READ)\n        .await\n        .map_err(|err| {\n            tracing::error!(error = %err, \"failed to check audit log permission\");\n            AppError::InternalServerError(err.into())\n        })?;\n\n    if allowed {\n        Ok(())\n    } else {\n        Err(AppError::Forbidden(\"Forbidden\".into()))\n    }\n}\n\nfn validate_list_query(q: AuditLogListQuery) -\u003e Result\u003c(i64, i64, AuditLogFilters), AppError\u003e {\n    let page = q.page.unwrap_or(DEFAULT_PAGE).clamp(1, MAX_PAGE);\n    let per_page = q\n        .per_page\n        .unwrap_or(DEFAULT_PER_PAGE)\n        .clamp(1, MAX_PER_PAGE);\n    let filters = build_filters(AuditLogFilterInput {\n        from: q.from,\n        to: q.to,\n        actor_id: q.actor_id,\n        actor_type: q.actor_type,\n        event_type: q.event_type,\n        target_type: q.target_type,\n        target_id: q.target_id,\n        result: q.result,\n    })?;\n    Ok((page, per_page, filters))\n}\n\nconst MAX_EXPORT_DAYS: i64 = 31;\n\nfn validate_export_query(q: AuditLogExportQuery) -\u003e Result\u003cAuditLogFilters, AppError\u003e {\n    let from = parse_datetime_value(\u0026q.from, true).ok_or_else(|| {\n        AppError::BadRequest(\"`from` must be a valid datetime (RFC3339 or YYYY-MM-DD)\".into())\n    })?;\n    let to = parse_datetime_value(\u0026q.to, false).ok_or_else(|| {\n        AppError::BadRequest(\"`to` must be a valid datetime (RFC3339 or YYYY-MM-DD)\".into())\n    })?;\n\n    if from \u003e to {\n        return Err(AppError::BadRequest(\n            \"`from` must be before or equal to `to`\".into(),\n        ));\n    }\n\n    let calendar_days = (to.date_naive() - from.date_naive()).num_days();\n    if calendar_days \u003e MAX_EXPORT_DAYS {\n        return Err(AppError::BadRequest(format!(\n            \"エクスポート期間は最大{}日です\",\n            MAX_EXPORT_DAYS\n        )));\n    }\n\n    let result = normalize_filter(q.result).map(|value| value.to_ascii_lowercase());\n    if let Some(ref value) = result {\n        if value != \"success\" \u0026\u0026 value != \"failure\" {\n            return Err(AppError::BadRequest(\n                \"`result` must be success or failure\".into(),\n            ));\n        }\n    }\n\n    let actor_id = q\n        .actor_id\n        .filter(|s| !s.trim().is_empty())\n        .map(|s| UserId::from_str(\u0026s))\n        .transpose()\n        .map_err(|_| AppError::BadRequest(\"Invalid actor ID\".into()))?;\n\n    Ok(AuditLogFilters {\n        from: Some(from),\n        to: Some(to),\n        actor_id,\n        actor_type: normalize_filter(q.actor_type).map(|value| value.to_ascii_lowercase()),\n        event_type: normalize_filter(q.event_type).map(|value| value.to_ascii_lowercase()),\n        target_type: normalize_filter(q.target_type).map(|value| value.to_ascii_lowercase()),\n        target_id: normalize_filter(q.target_id),\n        result,\n    })\n}\n\nstruct AuditLogFilterInput {\n    from: Option\u003cString\u003e,\n    to: Option\u003cString\u003e,\n    actor_id: Option\u003cString\u003e,\n    actor_type: Option\u003cString\u003e,\n    event_type: Option\u003cString\u003e,\n    target_type: Option\u003cString\u003e,\n    target_id: Option\u003cString\u003e,\n    result: Option\u003cString\u003e,\n}\n\nfn build_filters(input: AuditLogFilterInput) -\u003e Result\u003cAuditLogFilters, AppError\u003e {\n    let from =\n        parse_from_datetime(input.from.as_deref()).map_err(|e| AppError::BadRequest(e.into()))?;\n    let to = parse_to_datetime(input.to.as_deref()).map_err(|e| AppError::BadRequest(e.into()))?;\n\n    if let (Some(from), Some(to)) = (from, to) {\n        if from \u003e to {\n            return Err(AppError::BadRequest(\n                \"`from` must be before or equal to `to`\".into(),\n            ));\n        }\n    }\n\n    let result = normalize_filter(input.result).map(|value| value.to_ascii_lowercase());\n    if let Some(ref value) = result {\n        if value != \"success\" \u0026\u0026 value != \"failure\" {\n            return Err(AppError::BadRequest(\n                \"`result` must be success or failure\".into(),\n            ));\n        }\n    }\n\n    let actor_id = input\n        .actor_id\n        .filter(|s| !s.trim().is_empty())\n        .map(|s| UserId::from_str(\u0026s))\n        .transpose()\n        .map_err(|_| AppError::BadRequest(\"Invalid actor ID\".into()))?;\n\n    Ok(AuditLogFilters {\n        from,\n        to,\n        actor_id,\n        actor_type: normalize_filter(input.actor_type).map(|value| value.to_ascii_lowercase()),\n        event_type: normalize_filter(input.event_type).map(|value| value.to_ascii_lowercase()),\n        target_type: normalize_filter(input.target_type).map(|value| value.to_ascii_lowercase()),\n        target_id: normalize_filter(input.target_id),\n        result,\n    })\n}\n\nfn normalize_filter(value: Option\u003cString\u003e) -\u003e Option\u003cString\u003e {\n    value\n        .map(|value| value.trim().to_string())\n        .filter(|value| !value.is_empty())\n}\n\nfn parse_from_datetime(raw: Option\u003c\u0026str\u003e) -\u003e Result\u003cOption\u003cDateTime\u003cUtc\u003e\u003e, \u0026'static str\u003e {\n    match raw {\n        Some(value) =\u003e parse_datetime_value(value, true)\n            .ok_or(\"`from` must be a valid datetime (RFC3339 or YYYY-MM-DD)\")\n            .map(Some),\n        None =\u003e Ok(None),\n    }\n}\n\nfn parse_to_datetime(raw: Option\u003c\u0026str\u003e) -\u003e Result\u003cOption\u003cDateTime\u003cUtc\u003e\u003e, \u0026'static str\u003e {\n    match raw {\n        Some(value) =\u003e parse_datetime_value(value, false)\n            .ok_or(\"`to` must be a valid datetime (RFC3339 or YYYY-MM-DD)\")\n            .map(Some),\n        None =\u003e Ok(None),\n    }\n}\n\nfn parse_datetime_value(value: \u0026str, is_start: bool) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n    if let Ok(dt) = DateTime::parse_from_rfc3339(value) {\n        return Some(dt.with_timezone(\u0026Utc));\n    }\n    if let Ok(dt) = NaiveDateTime::parse_from_str(value, \"%Y-%m-%dT%H:%M:%S\") {\n        return Some(DateTime::\u003cUtc\u003e::from_naive_utc_and_offset(dt, Utc));\n    }\n    if let Ok(dt) = NaiveDateTime::parse_from_str(value, \"%Y-%m-%d %H:%M:%S\") {\n        return Some(DateTime::\u003cUtc\u003e::from_naive_utc_and_offset(dt, Utc));\n    }\n    if let Ok(date) = NaiveDate::parse_from_str(value, \"%Y-%m-%d\") {\n        let time = if is_start {\n            NaiveTime::from_hms_opt(0, 0, 0)\n        } else {\n            NaiveTime::from_hms_opt(23, 59, 59)\n        }?;\n        return Some(DateTime::\u003cUtc\u003e::from_naive_utc_and_offset(\n            NaiveDateTime::new(date, time),\n            Utc,\n        ));\n    }\n    None\n}\n","traces":[{"line":78,"address":[22789794,22789398,22788128],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":80,"address":[22788150],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[22788327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[22788349],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[22788431],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[22788462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[22788494],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[22788526],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[22788558],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[22788590],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[22788625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[22788745],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[22788790],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[22788835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[22793232],"length":1,"stats":{"Line":0},"fn_name":"list_audit_logs"},{"line":110,"address":[21754723,21753480,21753428,21753575,21753676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[21754065,21754695],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[21754544,21754517,21754384],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[21755210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[21754628,21754676,21753498,21754951,21754739],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[21755073,21756062,21756048,21755029],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":119,"address":[21755466],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21755270],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[21755282],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[21755294],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[21755350],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[21755414],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[21755437],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[22795360],"length":1,"stats":{"Line":0},"fn_name":"get_audit_log_detail"},{"line":135,"address":[21764525,21765590,21764730,21764626,21764473],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[21765289,21765122,21765559,21765222],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[21766896,21766910,21765257,21765199],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":140,"address":[21765507,21765961,21766213,21765378,21765790,21765885,21766836,21766821,21766137,21765437,21765847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[21765492,21764546,21765606,21765800,21765540],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[21765929,21765862,21767006,21766992],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":143,"address":[21766181,21767086,21766114,21767072],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":145,"address":[21766376,21766503],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[22793440],"length":1,"stats":{"Line":0},"fn_name":"export_audit_logs"},{"line":153,"address":[21756849,21757963,21756797,21757048,21756944],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[21757434,21757935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[21757883,21760842,21757743,21758353,21757830,21758199,21758137,21758286],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[21757979,21757916,21758185,21757868,21756867],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[21758263,21761008,21758321,21761022],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":160,"address":[21758610,21758490],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[21758656,21761118,21758727,21761088],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":163,"address":[21759068],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[21758962,21759025],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[21759370,21759247],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[21759565],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[21759519,21759573,21759454,21760714],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[21759635,21760006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[21759659],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[21759776,21759705,21759964],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[21761180,21761168,21759971],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":176,"address":[21760139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[22800096,22800109],"length":1,"stats":{"Line":0},"fn_name":"ensure_audit_log_access"},{"line":180,"address":[21768340,21768439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[21768470],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[21768455],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[21768492,21768629,21768573,21768921,21768980,21769058,21769116],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[20992711],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[21769440,21769041,21771010,21771042],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":188,"address":[21769997,21769471,21769563],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[21769921,21770991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[21769197,21769251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[21769239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[21769201,21769253],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[22795309,22793920,22795105],"length":1,"stats":{"Line":0},"fn_name":"validate_list_query"},{"line":200,"address":[22793942,22794154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[22794250,22794184],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[22794192],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[22794228],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[22794902,22794538,22795071],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[22794258],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[22794290],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[22794322],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[22794354],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[22794386],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[22794424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[22794462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[22794500],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[22794989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":220,"address":[22798934,22796304],"length":1,"stats":{"Line":0},"fn_name":"validate_export_query"},{"line":221,"address":[22796511,22799348,22796629,22796334],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[21767614],"length":1,"stats":{"Line":0},"fn_name":null},{"line":224,"address":[21768128],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":225,"address":[21768142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[22797043],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[22799217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[22797083],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[22797132,22797072],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[22797224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[22798977,22797296],"length":1,"stats":{"Line":0},"fn_name":null},{"line":242,"address":[22797349,22797235],"length":1,"stats":{"Line":0},"fn_name":null},{"line":243,"address":[22797356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[22797409,22797550],"length":1,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[22797642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[22797599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[22797870,22797444,22797942,22798953],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[21767849,21767840],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":254,"address":[21767312,21767339],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":256,"address":[22797847,22797910],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[22798576],"length":1,"stats":{"Line":0},"fn_name":null},{"line":259,"address":[22798034],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[22798064],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[21767984,21768011],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":263,"address":[21767723,21767696],"length":1,"stats":{"Line":0},"fn_name":"{closure#7}"},{"line":264,"address":[22798422,22798304],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[22798434],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[22798544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[22792455,22789808],"length":1,"stats":{"Line":0},"fn_name":"build_filters"},{"line":282,"address":[22789838],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[21752008,21751984],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":286,"address":[22790448,22790631],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[22790707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[22790774],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[22790731],"length":1,"stats":{"Line":0},"fn_name":null},{"line":294,"address":[22790567,22790930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[22790937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":296,"address":[22791131,22790990],"length":1,"stats":{"Line":0},"fn_name":null},{"line":297,"address":[22791223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[22791180],"length":1,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[22791025,22791451,22792474,22791523],"length":1,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[21752089,21752080],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":306,"address":[21752923,21752896],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":308,"address":[21752430,21752416],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":310,"address":[22792097],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[22791615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[21752635,21752608],"length":1,"stats":{"Line":0},"fn_name":"{closure#7}"},{"line":316,"address":[21752752,21752779],"length":1,"stats":{"Line":0},"fn_name":"{closure#8}"},{"line":317,"address":[22791955],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[22792065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[22793360],"length":1,"stats":{"Line":0},"fn_name":"normalize_filter"},{"line":323,"address":[22793374],"length":1,"stats":{"Line":0},"fn_name":null},{"line":324,"address":[21756187,21756160],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":325,"address":[21756128,21756137],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":328,"address":[22793744],"length":1,"stats":{"Line":0},"fn_name":"parse_from_datetime"},{"line":329,"address":[22793768],"length":1,"stats":{"Line":0},"fn_name":null},{"line":330,"address":[22793796],"length":1,"stats":{"Line":0},"fn_name":null},{"line":332,"address":[22793863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[22793880],"length":1,"stats":{"Line":0},"fn_name":null},{"line":337,"address":[22793568],"length":1,"stats":{"Line":0},"fn_name":"parse_to_datetime"},{"line":338,"address":[22793592],"length":1,"stats":{"Line":0},"fn_name":null},{"line":339,"address":[22793620],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[22793684],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[22793701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[22795488],"length":1,"stats":{"Line":0},"fn_name":"parse_datetime_value"},{"line":347,"address":[22795546,22795644],"length":1,"stats":{"Line":0},"fn_name":null},{"line":348,"address":[22795664],"length":1,"stats":{"Line":0},"fn_name":null},{"line":350,"address":[22795787,22795591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":351,"address":[22795805],"length":1,"stats":{"Line":0},"fn_name":null},{"line":353,"address":[22795728,22795953],"length":1,"stats":{"Line":0},"fn_name":null},{"line":354,"address":[22795983],"length":1,"stats":{"Line":0},"fn_name":null},{"line":356,"address":[22795886,22796086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[22796104,22796154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":358,"address":[22796135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":360,"address":[22796108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":362,"address":[22796250],"length":1,"stats":{"Line":0},"fn_name":null},{"line":363,"address":[22796237],"length":1,"stats":{"Line":0},"fn_name":null},{"line":367,"address":[22796071],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":160},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","common.rs"],"content":"use chrono::{DateTime, NaiveDate, NaiveDateTime};\nuse sqlx::{Postgres, QueryBuilder};\n\npub fn parse_date_value(value: \u0026str) -\u003e Option\u003cNaiveDate\u003e {\n    if let Ok(dt) = DateTime::parse_from_rfc3339(value) {\n        return Some(dt.date_naive());\n    }\n    if let Ok(dt) = NaiveDateTime::parse_from_str(value, \"%Y-%m-%d %H:%M:%S\") {\n        return Some(dt.date());\n    }\n    NaiveDate::parse_from_str(value, \"%Y-%m-%d\").ok()\n}\n\npub fn parse_optional_date(raw: Option\u003c\u0026str\u003e) -\u003e Result\u003cOption\u003cNaiveDate\u003e, \u0026'static str\u003e {\n    match raw {\n        Some(value) =\u003e parse_date_value(value)\n            .ok_or(\"`from`/`to` must be a valid date (YYYY-MM-DD or RFC3339)\")\n            .map(Some),\n        None =\u003e Ok(None),\n    }\n}\n\npub fn push_clause(builder: \u0026mut QueryBuilder\u003c'_, Postgres\u003e, has_clause: \u0026mut bool) {\n    if *has_clause {\n        builder.push(\" AND \");\n    } else {\n        builder.push(\" WHERE \");\n        *has_clause = true;\n    }\n}\n","traces":[{"line":4,"address":[23088560],"length":1,"stats":{"Line":1},"fn_name":"parse_date_value"},{"line":5,"address":[23088589,23088683],"length":1,"stats":{"Line":1},"fn_name":null},{"line":6,"address":[23088703],"length":1,"stats":{"Line":0},"fn_name":null},{"line":8,"address":[23088633,23088794],"length":1,"stats":{"Line":1},"fn_name":null},{"line":9,"address":[23088812],"length":1,"stats":{"Line":0},"fn_name":null},{"line":11,"address":[23088735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[23088832],"length":1,"stats":{"Line":1},"fn_name":"parse_optional_date"},{"line":15,"address":[23088856],"length":1,"stats":{"Line":1},"fn_name":null},{"line":16,"address":[23088884],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[23088938],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[23088955],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[23088464],"length":1,"stats":{"Line":0},"fn_name":"push_clause"},{"line":24,"address":[23088488,23088524],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[23088531],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[23088498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[23088521],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":9,"coverable":16},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","export.rs"],"content":"use axum::{\n    extract::{Extension, Query, State},\n    Json,\n};\nuse serde::Deserialize;\nuse serde_json::{json, Value};\nuse sqlx::{Postgres, QueryBuilder, Row};\nuse utoipa::{IntoParams, ToSchema};\n\nuse crate::{\n    error::AppError,\n    models::user::User,\n    state::AppState,\n    utils::{csv::append_csv_row, time},\n};\n\nuse super::common::{parse_date_value, push_clause};\n\n#[derive(Deserialize, ToSchema, IntoParams)]\npub struct ExportQuery {\n    pub username: Option\u003cString\u003e,\n    pub from: Option\u003cString\u003e, // YYYY-MM-DD\n    pub to: Option\u003cString\u003e,   // YYYY-MM-DD\n}\n\nstruct ExportRow {\n    username: String,\n    full_name: String,\n    date: String,\n    clock_in: String,\n    clock_out: String,\n    total_hours: String,\n    status: String,\n}\n\npub async fn export_data(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(q): Query\u003cExportQuery\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    // Build filtered SQL\n    let parsed_from = match q.from.as_deref() {\n        Some(raw) =\u003e parse_date_value(raw)\n            .ok_or(AppError::BadRequest(\"`from` must be a valid date\".into()))\n            .map(Some)?,\n        None =\u003e None,\n    };\n    let parsed_to = match q.to.as_deref() {\n        Some(raw) =\u003e parse_date_value(raw)\n            .ok_or(AppError::BadRequest(\"`to` must be a valid date\".into()))\n            .map(Some)?,\n        None =\u003e None,\n    };\n    if let (Some(from), Some(to)) = (parsed_from, parsed_to) {\n        if from \u003e to {\n            return Err(AppError::BadRequest(\n                \"`from` must be on or before `to`\".into(),\n            ));\n        }\n    }\n\n    let mut builder: QueryBuilder\u003cPostgres\u003e = QueryBuilder::new(\n        \"SELECT u.username, u.full_name, a.date, a.clock_in_time, a.clock_out_time, a.total_work_hours, a.status \\\n         FROM attendance a JOIN users u ON a.user_id = u.id\",\n    );\n    let mut has_clause = false;\n    if let Some(ref u_name) = q.username {\n        push_clause(\u0026mut builder, \u0026mut has_clause);\n        builder.push(\"u.username = \").push_bind(u_name);\n    }\n    if let Some(from) = parsed_from {\n        push_clause(\u0026mut builder, \u0026mut has_clause);\n        builder.push(\"a.date \u003e= \").push_bind(from);\n    }\n    if let Some(to) = parsed_to {\n        push_clause(\u0026mut builder, \u0026mut has_clause);\n        builder.push(\"a.date \u003c= \").push_bind(to);\n    }\n    builder.push(\" ORDER BY a.date DESC, u.username\");\n    let data: Vec\u003csqlx::postgres::PgRow\u003e = builder\n        .build()\n        .fetch_all(state.read_pool())\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let rows: Vec\u003cExportRow\u003e = data\n        .into_iter()\n        .map(|record| {\n            let username = record\n                .try_get::\u003cString, \u0026str\u003e(\"username\")\n                .unwrap_or_default();\n            let full_name = record.try_get::\u003cString, _\u003e(\"full_name\").unwrap_or_default();\n            let date = record\n                .try_get::\u003cchrono::NaiveDate, _\u003e(\"date\")\n                .map(|value| value.format(\"%Y-%m-%d\").to_string())\n                .unwrap_or_default();\n            let clock_in = record\n                .try_get::\u003cOption\u003cchrono::NaiveDateTime\u003e, _\u003e(\"clock_in_time\")\n                .ok()\n                .flatten()\n                .map(|t| t.format(\"%H:%M:%S\").to_string())\n                .unwrap_or_default();\n            let clock_out = record\n                .try_get::\u003cOption\u003cchrono::NaiveDateTime\u003e, _\u003e(\"clock_out_time\")\n                .ok()\n                .flatten()\n                .map(|t| t.format(\"%H:%M:%S\").to_string())\n                .unwrap_or_default();\n            let total_hours = record\n                .try_get::\u003cf64, _\u003e(\"total_work_hours\")\n                .map(|h| format!(\"{:.2}\", h))\n                .unwrap_or_else(|_| \"0.00\".to_string());\n            let status = record.try_get::\u003cString, _\u003e(\"status\").unwrap_or_default();\n\n            ExportRow {\n                username,\n                full_name,\n                date,\n                clock_in,\n                clock_out,\n                total_hours,\n                status,\n            }\n        })\n        .collect();\n\n    let csv_data = tokio::task::spawn_blocking(move || {\n        let mut csv = String::new();\n        append_csv_row(\n            \u0026mut csv,\n            \u0026[\n                \"Username\".to_string(),\n                \"Full Name\".to_string(),\n                \"Date\".to_string(),\n                \"Clock In\".to_string(),\n                \"Clock Out\".to_string(),\n                \"Total Hours\".to_string(),\n                \"Status\".to_string(),\n            ],\n        );\n\n        for row in rows {\n            append_csv_row(\n                \u0026mut csv,\n                \u0026[\n                    row.username,\n                    row.full_name,\n                    row.date,\n                    row.clock_in,\n                    row.clock_out,\n                    row.total_hours,\n                    row.status,\n                ],\n            );\n        }\n        csv\n    })\n    .await\n    .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    Ok(Json(json!({\n        \"csv_data\": csv_data,\n        \"filename\": format!(\n            \"attendance_export_{}.csv\",\n            time::now_in_timezone(\u0026state.config.time_zone).format(\"%Y%m%d_%H%M%S\")\n        )\n    })))\n}\n","traces":[{"line":36,"address":[18737120],"length":1,"stats":{"Line":0},"fn_name":"export_data"},{"line":41,"address":[18151963,18152095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[18152101,18152184],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[18152147,18152361],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[18152408,18154502,18152658,18152725],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[18152507],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[18152635,18152811,18152693],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[18152454],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[18152473,18152829],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[18153209,18153142,18152876,18154497],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[18152994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[18153295,18153119,18153177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[18152919],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[18153300,18152930,18153368],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[18153396],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[18153475],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[18153437],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[18153624],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[18153631],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[18153697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[18153812],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[18153721,18153877],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[18153895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[18153956],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[18154017,18153919],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[18154035],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[18154105],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[18154067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[18154305,18154699,18154417,18154761,18154848,18154166,18154915,18155338],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[18154192,18154262,18154243,18154329,18154469],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[18154450,18154541,18152007,18154360,18154747],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[18154883,18157422,18154825,18157408],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":89,"address":[18155059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[18159232,18155185,18160689],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":93,"address":[18159270],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[18159345],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[18159429,18159357],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[18159441],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[18161072,18161093,18159522],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":99,"address":[18159545],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[18159557],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[18159644],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[18159667],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[18161360,18159690,18161376],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":105,"address":[18159697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[18159729],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[18159816],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[18159839],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[18159862,18160928,18160944],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":111,"address":[18159869],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[18159901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[18161252,18161232,18159988],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":115,"address":[18160816,18160832,18159995],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":116,"address":[18160117,18160030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[18160404],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[18160134],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[18160173],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[18160212],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[18160260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[18160308],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[18160356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[18155579,18155650,18157328,18155717,18155533,18155304,18157488,18159199,18155215],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":131,"address":[18157509],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[18158297],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[18158079],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[18157578],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[18157647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[18157719],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[18157791],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[18157863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[18157935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[18158007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[18158538,18158357],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[18159075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[18158833],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[18158609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[18158641],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[18158673],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[18158705],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[18158737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[18158769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[18158801],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[18159107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[18155384,18155565,18155319,18155279,18152028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[18155685,18160720,18155627,18160734],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":164,"address":[18156585,18156009,18156592,18155854,18155905,18156233,18155943,18156303,18157261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[18156390],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[18156281,18156347],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":88},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","holidays.rs"],"content":"use crate::models::holiday::{AdminHolidayKind, AdminHolidayListItem};\nuse crate::repositories::holiday::{HolidayRepository, HolidayRepositoryTrait};\nuse crate::repositories::repository::Repository;\nuse crate::repositories::weekly_holiday::WeeklyHolidayRepository;\nuse axum::{\n    extract::{Extension, Path, Query, State},\n    Json,\n};\nuse chrono::{Duration, NaiveDate};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Value};\nuse std::str::FromStr;\nuse utoipa::{IntoParams, ToSchema};\n\nuse crate::{\n    error::AppError,\n    models::{\n        holiday::{\n            CreateHolidayPayload, CreateWeeklyHolidayPayload, Holiday, HolidayResponse,\n            WeeklyHoliday, WeeklyHolidayResponse,\n        },\n        user::User,\n    },\n    state::AppState,\n    utils::time,\n};\n\nuse super::common::parse_optional_date;\n\nconst DEFAULT_PAGE: i64 = 1;\nconst DEFAULT_PER_PAGE: i64 = 25;\nconst MAX_PER_PAGE: i64 = 100;\nconst MAX_PAGE: i64 = 1_000;\n\npub async fn list_holidays(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(q): Query\u003cAdminHolidayListQuery\u003e,\n) -\u003e Result\u003cJson\u003cAdminHolidayListResponse\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let AdminHolidayQueryParams {\n        page,\n        per_page,\n        kind,\n        from,\n        to,\n    } = validate_admin_holiday_query(q)?;\n    let offset = (page - 1) * per_page;\n\n    let repo = HolidayRepository::new();\n    let (items, total) = repo\n        .list_paginated_admin(state.read_pool(), kind, from, to, per_page, offset)\n        .await?;\n\n    Ok(Json(AdminHolidayListResponse {\n        page,\n        per_page,\n        total,\n        items,\n    }))\n}\n\npub async fn create_holiday(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cCreateHolidayPayload\u003e,\n) -\u003e Result\u003cJson\u003cHolidayResponse\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let CreateHolidayPayload {\n        holiday_date,\n        name,\n        description,\n    } = payload;\n\n    let trimmed_name = name.trim();\n    if trimmed_name.is_empty() {\n        return Err(AppError::BadRequest(\"Holiday name is required\".into()));\n    }\n\n    let normalized_description = description.as_deref().map(str::trim).and_then(|d| {\n        if d.is_empty() {\n            None\n        } else {\n            Some(d.to_string())\n        }\n    });\n\n    let holiday = Holiday::new(\n        holiday_date,\n        trimmed_name.to_string(),\n        normalized_description,\n    );\n\n    let repo = HolidayRepository::new();\n    let created = repo.create_unique(\u0026state.write_pool, \u0026holiday).await?;\n    Ok(Json(HolidayResponse::from(created)))\n}\n\npub async fn delete_holiday(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(holiday_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let id = crate::types::HolidayId::from_str(\u0026holiday_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid holiday ID\".into()))?;\n\n    let repo = HolidayRepository::new();\n    repo.delete(\u0026state.write_pool, id).await?;\n\n    Ok(Json(json!({\"message\":\"Holiday deleted\",\"id\": holiday_id})))\n}\n\npub async fn list_weekly_holidays(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cWeeklyHolidayResponse\u003e\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let repo = WeeklyHolidayRepository::new();\n    let holidays = repo.find_all(state.read_pool()).await?;\n\n    Ok(Json(\n        holidays\n            .into_iter()\n            .map(WeeklyHolidayResponse::from)\n            .collect(),\n    ))\n}\n\npub async fn create_weekly_holiday(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cCreateWeeklyHolidayPayload\u003e,\n) -\u003e Result\u003cJson\u003cWeeklyHolidayResponse\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    if payload.weekday \u003e 6 {\n        return Err(AppError::BadRequest(\n            \"Weekday must be between 0 (Sun) and 6 (Sat). (Sun=0, Mon=1, ..., Sat=6)\".into(),\n        ));\n    }\n\n    if let Some(ends_on) = payload.ends_on {\n        if ends_on \u003c payload.starts_on {\n            return Err(AppError::BadRequest(\n                \"End date must be on or after the start date\".into(),\n            ));\n        }\n    }\n\n    let today = time::today_local(\u0026state.config.time_zone);\n    let tomorrow = today + Duration::days(1);\n    if !user.is_system_admin() \u0026\u0026 payload.starts_on \u003c tomorrow {\n        return Err(AppError::BadRequest(\n            \"Start date must be at least tomorrow\".into(),\n        ));\n    }\n\n    let weekly = WeeklyHoliday::new(payload.weekday, payload.starts_on, payload.ends_on, user.id);\n\n    let repo = WeeklyHolidayRepository::new();\n    repo.create(\u0026state.write_pool, \u0026weekly).await?;\n\n    Ok(Json(WeeklyHolidayResponse::from(weekly)))\n}\n\npub async fn delete_weekly_holiday(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let id = crate::types::WeeklyHolidayId::from_str(\u0026id)\n        .map_err(|_| AppError::BadRequest(\"Invalid weekly holiday ID\".into()))?;\n\n    let repo = WeeklyHolidayRepository::new();\n    repo.delete(\u0026state.write_pool, id).await?;\n\n    Ok(Json(json!({\"message\":\"Weekly holiday deleted\",\"id\": id})))\n}\n\n// ============================================================================\n// Internal helpers and types\n// ============================================================================\n\n#[derive(Debug, Deserialize, ToSchema, IntoParams)]\npub struct AdminHolidayListQuery {\n    pub page: Option\u003ci64\u003e,\n    pub per_page: Option\u003ci64\u003e,\n    #[serde(rename = \"type\")]\n    pub r#type: Option\u003cString\u003e,\n    pub from: Option\u003cString\u003e,\n    pub to: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct AdminHolidayListResponse {\n    pub page: i64,\n    pub per_page: i64,\n    pub total: i64,\n    pub items: Vec\u003cAdminHolidayListItem\u003e,\n}\n\n#[derive(Debug, Clone, PartialEq, Eq)]\npub struct AdminHolidayQueryParams {\n    pub page: i64,\n    pub per_page: i64,\n    pub kind: Option\u003cAdminHolidayKind\u003e,\n    pub from: Option\u003cNaiveDate\u003e,\n    pub to: Option\u003cNaiveDate\u003e,\n}\n\npub fn validate_admin_holiday_query(\n    q: AdminHolidayListQuery,\n) -\u003e Result\u003cAdminHolidayQueryParams, AppError\u003e {\n    let page = q.page.unwrap_or(DEFAULT_PAGE).clamp(1, MAX_PAGE);\n    let per_page = q\n        .per_page\n        .unwrap_or(DEFAULT_PER_PAGE)\n        .clamp(1, MAX_PER_PAGE);\n\n    let kind =\n        parse_type_filter(q.r#type.as_deref()).map_err(|e| AppError::BadRequest(e.into()))?;\n    let from =\n        parse_optional_date(q.from.as_deref()).map_err(|e| AppError::BadRequest(e.into()))?;\n    let to = parse_optional_date(q.to.as_deref()).map_err(|e| AppError::BadRequest(e.into()))?;\n\n    if let (Some(from), Some(to)) = (from, to) {\n        if from \u003e to {\n            return Err(AppError::BadRequest(\n                \"`from` must be before or equal to `to`\".into(),\n            ));\n        }\n    }\n\n    Ok(AdminHolidayQueryParams {\n        page,\n        per_page,\n        kind,\n        from,\n        to,\n    })\n}\n\nfn parse_type_filter(raw: Option\u003c\u0026str\u003e) -\u003e Result\u003cOption\u003cAdminHolidayKind\u003e, \u0026'static str\u003e {\n    match raw {\n        Some(value) if value.eq_ignore_ascii_case(\"all\") =\u003e Ok(None),\n        Some(value) =\u003e AdminHolidayKind::from_str(value)\n            .map(Some)\n            .map_err(|_| \"`type` must be one of public, weekly, exception, all\"),\n        None =\u003e Ok(None),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::NaiveDate;\n\n    #[test]\n    fn test_admin_holiday_list_query_default_values() {\n        let query = AdminHolidayListQuery {\n            page: None,\n            per_page: None,\n            r#type: None,\n            from: None,\n            to: None,\n        };\n        assert!(query.page.is_none());\n        assert!(query.per_page.is_none());\n        assert!(query.r#type.is_none());\n        assert!(query.from.is_none());\n        assert!(query.to.is_none());\n    }\n\n    #[test]\n    fn test_admin_holiday_list_query_with_values() {\n        let query = AdminHolidayListQuery {\n            page: Some(2),\n            per_page: Some(50),\n            r#type: Some(\"public\".to_string()),\n            from: Some(\"2024-01-01\".to_string()),\n            to: Some(\"2024-12-31\".to_string()),\n        };\n        assert_eq!(query.page, Some(2));\n        assert_eq!(query.per_page, Some(50));\n        assert_eq!(query.r#type, Some(\"public\".to_string()));\n        assert_eq!(query.from, Some(\"2024-01-01\".to_string()));\n        assert_eq!(query.to, Some(\"2024-12-31\".to_string()));\n    }\n\n    #[test]\n    fn test_admin_holiday_list_response_structure() {\n        use crate::models::holiday::AdminHolidayListItem;\n        use crate::models::holiday::AdminHolidayKind;\n        use chrono::Utc;\n\n        let item = AdminHolidayListItem {\n            id: \"test-id\".to_string(),\n            kind: AdminHolidayKind::Public,\n            applies_from: NaiveDate::from_ymd_opt(2024, 1, 1).unwrap(),\n            applies_to: None,\n            date: Some(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap()),\n            weekday: None,\n            starts_on: None,\n            ends_on: None,\n            name: Some(\"New Year's Day\".to_string()),\n            description: Some(\"Public holiday\".to_string()),\n            user_id: None,\n            reason: None,\n            created_by: None,\n            created_at: Utc::now(),\n            is_override: None,\n        };\n\n        let response = AdminHolidayListResponse {\n            page: 1,\n            per_page: 25,\n            total: 100,\n            items: vec![item],\n        };\n\n        assert_eq!(response.page, 1);\n        assert_eq!(response.per_page, 25);\n        assert_eq!(response.total, 100);\n        assert_eq!(response.items.len(), 1);\n    }\n\n    #[test]\n    fn test_admin_holiday_query_params_structure() {\n        use crate::models::holiday::AdminHolidayKind;\n\n        let params = AdminHolidayQueryParams {\n            page: 1,\n            per_page: 25,\n            kind: Some(AdminHolidayKind::Public),\n            from: Some(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap()),\n            to: Some(NaiveDate::from_ymd_opt(2024, 12, 31).unwrap()),\n        };\n\n        assert_eq!(params.page, 1);\n        assert_eq!(params.per_page, 25);\n        assert_eq!(params.kind, Some(AdminHolidayKind::Public));\n        assert!(params.from.is_some());\n        assert!(params.to.is_some());\n    }\n\n    #[test]\n    fn test_validate_admin_holiday_query_with_defaults() {\n        let query = AdminHolidayListQuery {\n            page: None,\n            per_page: None,\n            r#type: None,\n            from: None,\n            to: None,\n        };\n\n        let result = validate_admin_holiday_query(query);\n        assert!(result.is_ok());\n\n        let params = result.unwrap();\n        assert_eq!(params.page, DEFAULT_PAGE);\n        assert_eq!(params.per_page, DEFAULT_PER_PAGE);\n        assert!(params.kind.is_none());\n        assert!(params.from.is_none());\n        assert!(params.to.is_none());\n    }\n\n    #[test]\n    fn test_validate_admin_holiday_query_with_valid_values() {\n        let query = AdminHolidayListQuery {\n            page: Some(2),\n            per_page: Some(50),\n            r#type: Some(\"public\".to_string()),\n            from: Some(\"2024-01-01\".to_string()),\n            to: Some(\"2024-12-31\".to_string()),\n        };\n\n        let result = validate_admin_holiday_query(query);\n        assert!(result.is_ok());\n\n        let params = result.unwrap();\n        assert_eq!(params.page, 2);\n        assert_eq!(params.per_page, 50);\n        assert_eq!(params.kind, Some(AdminHolidayKind::Public));\n        assert!(params.from.is_some());\n        assert!(params.to.is_some());\n    }\n\n    #[test]\n    fn test_validate_admin_holiday_query_rejects_invalid_date_range() {\n        let query = AdminHolidayListQuery {\n            page: None,\n            per_page: None,\n            r#type: None,\n            from: Some(\"2024-12-31\".to_string()),\n            to: Some(\"2024-01-01\".to_string()),\n        };\n\n        let result = validate_admin_holiday_query(query);\n        assert!(result.is_err());\n        assert!(matches!(result.unwrap_err(), AppError::BadRequest(_)));\n    }\n\n    #[test]\n    fn test_parse_type_filter_with_public() {\n        let result = parse_type_filter(Some(\"public\"));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), Some(AdminHolidayKind::Public));\n    }\n\n    #[test]\n    fn test_parse_type_filter_with_weekly() {\n        let result = parse_type_filter(Some(\"weekly\"));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), Some(AdminHolidayKind::Weekly));\n    }\n\n    #[test]\n    fn test_parse_type_filter_with_exception() {\n        let result = parse_type_filter(Some(\"exception\"));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), Some(AdminHolidayKind::Exception));\n    }\n\n    #[test]\n    fn test_parse_type_filter_with_all() {\n        let result = parse_type_filter(Some(\"all\"));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), None);\n    }\n\n    #[test]\n    fn test_parse_type_filter_with_none() {\n        let result = parse_type_filter(None);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), None);\n    }\n\n    #[test]\n    fn test_parse_type_filter_rejects_invalid_type() {\n        let result = parse_type_filter(Some(\"invalid\"));\n        assert!(result.is_err());\n        assert_eq!(result.unwrap_err(), \"`type` must be one of public, weekly, exception, all\");\n    }\n\n    #[test]\n    fn test_parse_type_filter_case_insensitive() {\n        let result = parse_type_filter(Some(\"PUBLIC\"));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), Some(AdminHolidayKind::Public));\n    }\n\n    #[test]\n    fn test_validate_admin_holiday_query_clamps_page() {\n        let query = AdminHolidayListQuery {\n            page: Some(10000),\n            per_page: None,\n            r#type: None,\n            from: None,\n            to: None,\n        };\n\n        let result = validate_admin_holiday_query(query);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap().page, MAX_PAGE);\n    }\n\n    #[test]\n    fn test_validate_admin_holiday_query_clamps_per_page() {\n        let query = AdminHolidayListQuery {\n            page: None,\n            per_page: Some(200),\n            r#type: None,\n            from: None,\n            to: None,\n        };\n\n        let result = validate_admin_holiday_query(query);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap().per_page, MAX_PER_PAGE);\n    }\n}\n","traces":[{"line":35,"address":[18630592],"length":1,"stats":{"Line":0},"fn_name":"list_holidays"},{"line":40,"address":[20837219,20837331],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[20837337,20837531],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[20838296,20837715,20837386],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[20837905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[20837920],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[20837935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[20837953],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[20837971],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[20838082,20837989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[20838075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[20838552,20838255,20838490,20839182,20838669,20838108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[20838122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[20838220,20838335,20838277,20838538,20837263,20838637],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[20838836],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[20838822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[20838829],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[18630704],"length":1,"stats":{"Line":0},"fn_name":"create_holiday"},{"line":71,"address":[20839817,20839929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[20839935,20840107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[20839984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[20840001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[20840046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[20840081,20840342],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[20840401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[20840458,20840993],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[20843072,20840430,20840551],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":87,"address":[20843122,20843183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[20843190],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[20843141],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[20840618],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[20840697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[20840766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[20839861,20840828,20841198,20840914],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[20841925,20842101],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[18630832],"length":1,"stats":{"Line":0},"fn_name":"delete_holiday"},{"line":110,"address":[20843542,20843648],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[20843654,20843724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[20843904,20844017,20843697,20843950,20844248],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[20843927,20843985,20845726,20845712],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":117,"address":[20844098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[20844284,20844110,20843583,20845659],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[20845627,20844661,20844771,20844998,20845065,20844706,20845599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[18631168],"length":1,"stats":{"Line":0},"fn_name":"list_weekly_holidays"},{"line":127,"address":[20846059,20846155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[20846209,20846161],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[20846199],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[20846360,20846560,20846097,20846446],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[20847146],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[20846991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[20847047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[20847111],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[20847134],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[18631248],"length":1,"stats":{"Line":0},"fn_name":"create_weekly_holiday"},{"line":147,"address":[20847791,20847893],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[20847899,20847960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[20847942],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[20848994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[20848150],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[20848122,20848196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[20848272,20848219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[20848316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[20848278],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[20848247,20848460],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[20848472],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[20848676,20848544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[20848720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[20848682],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[20848614],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[20848860],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[20849165,20847832,20848872,20850075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[20849697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[18631360],"length":1,"stats":{"Line":0},"fn_name":"delete_weekly_holiday"},{"line":186,"address":[20850523,20850423],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[20850529,20850599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[20850779,20851140,20850572,20850892,20850825],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[20850802,20852606,20850860,20852592],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":193,"address":[20850993],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[20851005,20851176,20850461,20852536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[20852476,20852504,20851654,20851589,20851881,20851544,20851948],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[18632883,18631488],"length":1,"stats":{"Line":1},"fn_name":"validate_admin_holiday_query"},{"line":233,"address":[18631590,18631510],"length":1,"stats":{"Line":2},"fn_name":null},{"line":234,"address":[18631686,18631620],"length":1,"stats":{"Line":2},"fn_name":null},{"line":236,"address":[18631628],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[18631664],"length":1,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[20852808,20852784],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":241,"address":[20852688,20852712],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":243,"address":[18632176,18632877],"length":1,"stats":{"Line":1},"fn_name":null},{"line":245,"address":[18632416,18632624],"length":1,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[18632652],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[18632739],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[18632696],"length":1,"stats":{"Line":1},"fn_name":null},{"line":253,"address":[18632521],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[18630960],"length":1,"stats":{"Line":1},"fn_name":"parse_type_filter"},{"line":263,"address":[18630983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[18631011,18631130],"length":1,"stats":{"Line":2},"fn_name":null},{"line":265,"address":[18631079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[18631104],"length":1,"stats":{"Line":1},"fn_name":null},{"line":267,"address":[18631116],"length":1,"stats":{"Line":2},"fn_name":null},{"line":268,"address":[18631058],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":20,"coverable":100},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","mod.rs"],"content":"pub mod attendance;\npub mod audit_logs;\npub mod common;\npub mod export;\npub mod holidays;\npub mod requests;\npub mod sessions;\npub mod users;\n\npub use attendance::*;\npub use audit_logs::*;\n// common is internal helpers, usually not re-exported fully, but let's see if docs.rs needs anything from it.\n// docs.rs needs structs. The structs are in their respective modules now.\n// We should re-export everything from the new modules to maintain backward compatibility for `use crate::handlers::admin::*;` if used.\npub use export::*;\npub use holidays::*;\npub use requests::*;\npub use sessions::*;\npub use users::*;\n\npub mod subject_requests;\npub use subject_requests::*;\n\n#[cfg(any(test, feature = \"test-utils\"))]\n#[allow(dead_code)]\nmod query_validation {\n    use super::*;\n    use crate::models::holiday::AdminHolidayKind;\n    use axum::http::StatusCode;\n    use axum::Json;\n    use chrono::NaiveDate;\n    use serde_json::Value;\n\n    const DEFAULT_PAGE: i64 = 1;\n    const DEFAULT_PER_PAGE: i64 = 25;\n    const MAX_PER_PAGE: i64 = 100;\n    const MAX_PAGE: i64 = 1_000;\n\n    #[derive(Debug, Clone, PartialEq, Eq)]\n    pub struct AdminHolidayQueryParams {\n        pub page: i64,\n        pub per_page: i64,\n        pub kind: Option\u003cAdminHolidayKind\u003e,\n        pub from: Option\u003cNaiveDate\u003e,\n        pub to: Option\u003cNaiveDate\u003e,\n    }\n\n    pub fn validate_admin_holiday_query(\n        q: AdminHolidayListQuery,\n    ) -\u003e Result\u003cAdminHolidayQueryParams, (StatusCode, Json\u003cValue\u003e)\u003e {\n        let page = q.page.unwrap_or(DEFAULT_PAGE).clamp(1, MAX_PAGE);\n        let per_page = q\n            .per_page\n            .unwrap_or(DEFAULT_PER_PAGE)\n            .clamp(1, MAX_PER_PAGE);\n\n        let kind = parse_type_filter(q.r#type.as_deref()).map_err(bad_request)?;\n        let from = super::common::parse_optional_date(q.from.as_deref()).map_err(bad_request)?;\n        let to = super::common::parse_optional_date(q.to.as_deref()).map_err(bad_request)?;\n\n        if let (Some(from), Some(to)) = (from, to) {\n            if from \u003e to {\n                return Err(bad_request(\"`from` must be before or equal to `to`\"));\n            }\n        }\n\n        Ok(AdminHolidayQueryParams {\n            page,\n            per_page,\n            kind,\n            from,\n            to,\n        })\n    }\n\n    fn parse_type_filter(raw: Option\u003c\u0026str\u003e) -\u003e Result\u003cOption\u003cAdminHolidayKind\u003e, \u0026'static str\u003e {\n        match raw {\n            Some(value) if value.eq_ignore_ascii_case(\"all\") =\u003e Ok(None),\n            Some(\"public\") =\u003e Ok(Some(AdminHolidayKind::Public)),\n            Some(\"weekly\") =\u003e Ok(Some(AdminHolidayKind::Weekly)),\n            Some(\"exception\") =\u003e Ok(Some(AdminHolidayKind::Exception)),\n            Some(_) =\u003e Err(\"`type` must be one of public, weekly, exception, all\"),\n            None =\u003e Ok(None),\n        }\n    }\n\n    fn bad_request(message: \u0026str) -\u003e (StatusCode, Json\u003cValue\u003e) {\n        (\n            StatusCode::BAD_REQUEST,\n            Json(serde_json::json!({ \"error\": message })),\n        )\n    }\n}\n\n#[cfg(any(test, feature = \"test-utils\"))]\n#[allow(unused_imports)]\npub use query_validation::{\n    validate_admin_holiday_query as test_validate_admin_holiday_query,\n    AdminHolidayQueryParams as TestAdminHolidayQueryParams,\n};\n","traces":[{"line":48,"address":[20071712,20073108],"length":1,"stats":{"Line":0},"fn_name":"validate_admin_holiday_query"},{"line":51,"address":[20071734,20071814],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[20071910,20071844],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[20071852],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[20071888],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[20073106,20071918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[20073104,20072190],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[20073102,20072462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[20072733,20072941],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[20072969],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[20073013],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[20072838],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[20071360],"length":1,"stats":{"Line":0},"fn_name":"parse_type_filter"},{"line":77,"address":[20071383],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[20071516,20071411],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[20071479,20071586],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[20071549,20071639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[20071602,20071686],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[20071659],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[20071458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[20071327,20071333,20070832],"length":1,"stats":{"Line":0},"fn_name":"bad_request"},{"line":90,"address":[20070990,20070859,20071305],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":22},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","requests.rs"],"content":"use axum::{\n    extract::{Extension, Path, Query, State},\n    Json,\n};\nuse chrono::{DateTime, NaiveDate, NaiveDateTime, TimeZone, Utc};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Value};\nuse std::str::FromStr;\nuse utoipa::{IntoParams, ToSchema};\n\nuse crate::{\n    error::AppError,\n    models::{\n        leave_request::LeaveRequestResponse, overtime_request::OvertimeRequestResponse, user::User,\n    },\n    repositories::{\n        repository::Repository,\n        request::{RequestListFilters, RequestRepository, RequestStatusUpdate},\n        leave_request::{LeaveRequestRepository, LeaveRequestRepositoryTrait},\n        overtime_request::{OvertimeRequestRepository, OvertimeRequestRepositoryTrait},\n    },\n    state::AppState,\n    types::{LeaveRequestId, OvertimeRequestId},\n    utils::time,\n};\n\nconst MAX_DECISION_COMMENT_LENGTH: usize = 500;\n\n#[derive(Debug, Deserialize, Serialize, ToSchema)]\npub struct ApprovePayload {\n    pub comment: String,\n}\n\npub async fn approve_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(request_id): Path\u003cString\u003e,\n    Json(body): Json\u003cApprovePayload\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    validate_decision_comment(\u0026body.comment)?;\n    let approver_id = user.id;\n    let comment = body.comment;\n    let now_utc = time::now_utc(\u0026state.config.time_zone);\n    let request_repo = RequestRepository::new();\n    if request_repo\n        .update_request_status(\n            \u0026state.write_pool,\n            \u0026request_id,\n            RequestStatusUpdate::Approve {\n                approver_id,\n                comment: \u0026comment,\n                timestamp: now_utc,\n            },\n        )\n        .await?\n    {\n        return Ok(Json(json!({\"message\": \"Request approved\"})));\n    }\n\n    Err(AppError::NotFound(\n        \"Request not found or already processed\".into(),\n    ))\n}\n\n#[derive(Debug, Deserialize, Serialize, ToSchema)]\npub struct RejectPayload {\n    pub comment: String,\n}\n\npub async fn reject_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(request_id): Path\u003cString\u003e,\n    Json(body): Json\u003cRejectPayload\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    validate_decision_comment(\u0026body.comment)?;\n    let approver_id = user.id;\n    let comment = body.comment;\n    let now_utc = time::now_utc(\u0026state.config.time_zone);\n    let request_repo = RequestRepository::new();\n    if request_repo\n        .update_request_status(\n            \u0026state.write_pool,\n            \u0026request_id,\n            RequestStatusUpdate::Reject {\n                approver_id,\n                comment: \u0026comment,\n                timestamp: now_utc,\n            },\n        )\n        .await?\n    {\n        return Ok(Json(json!({\"message\": \"Request rejected\"})));\n    }\n\n    Err(AppError::NotFound(\n        \"Request not found or already processed\".into(),\n    ))\n}\n\n#[derive(Debug, Deserialize, Serialize, IntoParams, ToSchema)]\npub struct RequestListQuery {\n    pub status: Option\u003cString\u003e,\n    #[serde(rename = \"type\")]\n    #[param(value_type = Option\u003cString\u003e)]\n    pub r#type: Option\u003cString\u003e,\n    pub user_id: Option\u003cString\u003e,\n    pub from: Option\u003cString\u003e,\n    pub to: Option\u003cString\u003e,\n    pub page: Option\u003ci64\u003e,\n    pub per_page: Option\u003ci64\u003e,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct AdminRequestListResponse {\n    pub leave_requests: Vec\u003cLeaveRequestResponse\u003e,\n    pub overtime_requests: Vec\u003cOvertimeRequestResponse\u003e,\n    pub page_info: AdminRequestListPageInfo,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct AdminRequestListPageInfo {\n    pub page: i64,\n    pub per_page: i64,\n}\n\npub async fn list_requests(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(q): Query\u003cRequestListQuery\u003e,\n) -\u003e Result\u003cJson\u003cAdminRequestListResponse\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    let (page, per_page, offset) = paginate_requests(\u0026q)?;\n\n    let type_filter = q.r#type.as_deref().map(|s| s.to_ascii_lowercase());\n    let (include_leave, include_overtime) = match type_filter.as_deref() {\n        Some(\"leave\") =\u003e (true, false),\n        Some(\"overtime\") =\u003e (false, true),\n        Some(\"all\") =\u003e (true, true),\n        _ =\u003e (true, true),\n    };\n\n    let filters = RequestListFilters {\n        status: q.status,\n        user_id: q.user_id,\n        from: q\n            .from\n            .as_deref()\n            .and_then(|value| parse_filter_datetime(value, false)),\n        to: q\n            .to\n            .as_deref()\n            .and_then(|value| parse_filter_datetime(value, true)),\n    };\n\n    let request_repo = RequestRepository::new();\n    let result = request_repo\n        .get_requests_with_relations(\n            state.read_pool(),\n            \u0026filters,\n            per_page,\n            offset,\n            include_leave,\n            include_overtime,\n        )\n        .await?;\n\n    Ok(Json(AdminRequestListResponse {\n        leave_requests: result\n            .leave_requests\n            .into_iter()\n            .map(LeaveRequestResponse::from)\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n        overtime_requests: result\n            .overtime_requests\n            .into_iter()\n            .map(OvertimeRequestResponse::from)\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n        page_info: AdminRequestListPageInfo { page, per_page },\n    }))\n}\n\npub fn paginate_requests(q: \u0026RequestListQuery) -\u003e Result\u003c(i64, i64, i64), AppError\u003e {\n    let page = q.page.unwrap_or(1).max(1);\n    let per_page = q.per_page.unwrap_or(20).clamp(1, 100);\n    let offset = page\n        .checked_sub(1)\n        .and_then(|p| p.checked_mul(per_page))\n        .ok_or(AppError::BadRequest(\"page is too large\".into()))?;\n    Ok((page, per_page, offset))\n}\n\npub(crate) fn validate_decision_comment(comment: \u0026str) -\u003e Result\u003c(), AppError\u003e {\n    if comment.trim().is_empty() {\n        return Err(AppError::BadRequest(\"comment is required\".into()));\n    }\n\n    if comment.chars().count() \u003e MAX_DECISION_COMMENT_LENGTH {\n        return Err(AppError::BadRequest(format!(\n            \"comment must be between 1 and {} characters\",\n            MAX_DECISION_COMMENT_LENGTH\n        )));\n    }\n\n    Ok(())\n}\n\npub async fn get_request_detail(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(request_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    // Try as leave request\n    if let Ok(leave_request_id) = LeaveRequestId::from_str(\u0026request_id) {\n        let leave_repo = LeaveRequestRepository::new();\n        match leave_repo\n            .find_by_id(state.read_pool(), leave_request_id)\n            .await\n        {\n            Ok(item) =\u003e {\n                return Ok(Json(\n                    json!({\"kind\":\"leave\",\"data\": LeaveRequestResponse::from(item)}),\n                ));\n            }\n            Err(AppError::NotFound(_)) =\u003e {}\n            Err(err) =\u003e return Err(err),\n        }\n    }\n\n    // Try as overtime request\n    if let Ok(overtime_request_id) = OvertimeRequestId::from_str(\u0026request_id) {\n        let overtime_repo = OvertimeRequestRepository::new();\n        match overtime_repo\n            .find_by_id(state.read_pool(), overtime_request_id)\n            .await\n        {\n            Ok(item) =\u003e {\n                return Ok(Json(\n                    json!({\"kind\":\"overtime\",\"data\": OvertimeRequestResponse::from(item)}),\n                ));\n            }\n            Err(AppError::NotFound(_)) =\u003e {}\n            Err(err) =\u003e return Err(err),\n        }\n    }\n\n    Err(AppError::NotFound(\"Request not found\".into()))\n}\n\nfn parse_filter_datetime(value: \u0026str, end_of_day: bool) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n    if let Ok(dt) = DateTime::parse_from_rfc3339(value) {\n        return Some(dt.with_timezone(\u0026Utc));\n    }\n    if let Ok(dt) = NaiveDateTime::parse_from_str(value, \"%Y-%m-%d %H:%M:%S\") {\n        return Some(Utc.from_utc_datetime(\u0026dt));\n    }\n    if let Ok(dt) = NaiveDateTime::parse_from_str(value, \"%Y-%m-%dT%H:%M:%S\") {\n        return Some(Utc.from_utc_datetime(\u0026dt));\n    }\n    if let Ok(date) = NaiveDate::parse_from_str(value, \"%Y-%m-%d\") {\n        let dt = if end_of_day {\n            date.and_hms_opt(23, 59, 59)?\n        } else {\n            date.and_hms_opt(0, 0, 0)?\n        };\n        return Some(Utc.from_utc_datetime(\u0026dt));\n    }\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::models::user::{User, UserRole};\n    use crate::types::UserId;\n    use chrono::{Utc, Timelike};\n\n    fn create_test_admin_user() -\u003e User {\n        User {\n            id: UserId::new(),\n            username: \"admin\".to_string(),\n            email: \"admin@example.com\".to_string(),\n            full_name: \"Admin User\".to_string(),\n            password_hash: \"hash\".to_string(),\n            role: UserRole::Admin,\n            is_system_admin: false,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: Utc::now(),\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n        }\n    }\n\n    fn create_test_regular_user() -\u003e User {\n        User {\n            id: UserId::new(),\n            username: \"user\".to_string(),\n            email: \"user@example.com\".to_string(),\n            full_name: \"Regular User\".to_string(),\n            password_hash: \"hash\".to_string(),\n            role: UserRole::Employee,\n            is_system_admin: false,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: Utc::now(),\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n        }\n    }\n\n    #[test]\n    fn test_validate_decision_comment_accepts_valid_comment() {\n        let comment = \"This is a valid decision comment\";\n        assert!(validate_decision_comment(comment).is_ok());\n    }\n\n    #[test]\n    fn test_validate_decision_comment_rejects_empty_comment() {\n        let comment = \"\";\n        let result = validate_decision_comment(comment);\n        assert!(result.is_err());\n        assert!(matches!(result.unwrap_err(), AppError::BadRequest(_)));\n    }\n\n    #[test]\n    fn test_validate_decision_comment_rejects_whitespace_only_comment() {\n        let comment = \"   \";\n        let result = validate_decision_comment(comment);\n        assert!(result.is_err());\n        assert!(matches!(result.unwrap_err(), AppError::BadRequest(_)));\n    }\n\n    #[test]\n    fn test_validate_decision_comment_rejects_too_long_comment() {\n        let comment = \"a\".repeat(MAX_DECISION_COMMENT_LENGTH + 1);\n        let result = validate_decision_comment(\u0026comment);\n        assert!(result.is_err());\n        assert!(matches!(result.unwrap_err(), AppError::BadRequest(_)));\n    }\n\n    #[test]\n    fn test_validate_decision_comment_accepts_max_length_comment() {\n        let comment = \"a\".repeat(MAX_DECISION_COMMENT_LENGTH);\n        assert!(validate_decision_comment(\u0026comment).is_ok());\n    }\n\n    #[test]\n    fn test_paginate_requests_with_defaults() {\n        let query = RequestListQuery {\n            status: None,\n            r#type: None,\n            user_id: None,\n            from: None,\n            to: None,\n            page: None,\n            per_page: None,\n        };\n        let result = paginate_requests(\u0026query).unwrap();\n        assert_eq!(result.0, 1);\n        assert_eq!(result.1, 20);\n        assert_eq!(result.2, 0);\n    }\n\n    #[test]\n    fn test_paginate_requests_with_custom_values() {\n        let query = RequestListQuery {\n            status: None,\n            r#type: None,\n            user_id: None,\n            from: None,\n            to: None,\n            page: Some(3),\n            per_page: Some(50),\n        };\n        let result = paginate_requests(\u0026query).unwrap();\n        assert_eq!(result.0, 3);\n        assert_eq!(result.1, 50);\n        assert_eq!(result.2, 100);\n    }\n\n    #[test]\n    fn test_paginate_requests_clamps_per_page() {\n        let query = RequestListQuery {\n            status: None,\n            r#type: None,\n            user_id: None,\n            from: None,\n            to: None,\n            page: Some(1),\n            per_page: Some(200),\n        };\n        let result = paginate_requests(\u0026query).unwrap();\n        assert_eq!(result.1, 100);\n    }\n\n    #[test]\n    fn test_paginate_requests_rejects_zero_page() {\n        let query = RequestListQuery {\n            status: None,\n            r#type: None,\n            user_id: None,\n            from: None,\n            to: None,\n            page: Some(0),\n            per_page: None,\n        };\n        let result = paginate_requests(\u0026query).unwrap();\n        assert_eq!(result.0, 1);\n    }\n\n    #[test]\n    fn test_paginate_requests_rejects_negative_per_page() {\n        let query = RequestListQuery {\n            status: None,\n            r#type: None,\n            user_id: None,\n            from: None,\n            to: None,\n            page: Some(1),\n            per_page: Some(-5),\n        };\n        let result = paginate_requests(\u0026query).unwrap();\n        assert_eq!(result.1, 1);\n    }\n\n    #[test]\n    fn test_parse_filter_datetime_parses_rfc3339() {\n        let input = \"2024-01-15T10:30:00Z\";\n        let result = parse_filter_datetime(input, false);\n        assert!(result.is_some());\n    }\n\n    #[test]\n    fn test_parse_filter_datetime_parses_date_only_start() {\n        let input = \"2024-01-15\";\n        let result = parse_filter_datetime(input, false);\n        assert!(result.is_some());\n        let dt = result.unwrap();\n        assert_eq!(dt.hour(), 0);\n        assert_eq!(dt.minute(), 0);\n        assert_eq!(dt.second(), 0);\n    }\n\n    #[test]\n    fn test_parse_filter_datetime_parses_date_only_end() {\n        let input = \"2024-01-15\";\n        let result = parse_filter_datetime(input, true);\n        assert!(result.is_some());\n        let dt = result.unwrap();\n        assert_eq!(dt.hour(), 23);\n        assert_eq!(dt.minute(), 59);\n        assert_eq!(dt.second(), 59);\n    }\n\n    #[test]\n    fn test_parse_filter_datetime_returns_none_for_invalid() {\n        let input = \"invalid-date\";\n        let result = parse_filter_datetime(input, false);\n        assert!(result.is_none());\n    }\n\n    #[test]\n    fn test_approve_payload_structure() {\n        let payload = ApprovePayload {\n            comment: \"Approved\".to_string(),\n        };\n        assert_eq!(payload.comment, \"Approved\");\n    }\n\n    #[test]\n    fn test_reject_payload_structure() {\n        let payload = RejectPayload {\n            comment: \"Rejected\".to_string(),\n        };\n        assert_eq!(payload.comment, \"Rejected\");\n    }\n\n    #[test]\n    fn test_request_list_query_default_values() {\n        let query = RequestListQuery {\n            status: None,\n            r#type: None,\n            user_id: None,\n            from: None,\n            to: None,\n            page: None,\n            per_page: None,\n        };\n        assert!(query.status.is_none());\n        assert!(query.r#type.is_none());\n        assert!(query.page.is_none());\n        assert!(query.per_page.is_none());\n    }\n\n    #[test]\n    fn test_request_list_page_info_structure() {\n        let info = AdminRequestListPageInfo { page: 1, per_page: 20 };\n        assert_eq!(info.page, 1);\n        assert_eq!(info.per_page, 20);\n    }\n\n    #[test]\n    fn test_request_list_response_structure() {\n        let response = AdminRequestListResponse {\n            leave_requests: vec![],\n            overtime_requests: vec![],\n            page_info: AdminRequestListPageInfo { page: 1, per_page: 20 },\n        };\n        assert!(response.leave_requests.is_empty());\n        assert!(response.overtime_requests.is_empty());\n        assert_eq!(response.page_info.page, 1);\n    }\n}\n","traces":[{"line":34,"address":[18130352],"length":1,"stats":{"Line":0},"fn_name":"approve_request"},{"line":40,"address":[22761068,22761180],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[22761259,22761186],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[22761439,22762053,22761232],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[22761602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22761617],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[22761652],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[22761725],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[22762241,22762287,22762001,22762402,22763586,22761740],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[22761754],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[22761768],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[22761874],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[22761820],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[22762273,22762370,22761986,22761112,22762034,22762092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[22762536,22762989,22763092,22763027,22763554],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[22762605],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[22762490],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[18130176],"length":1,"stats":{"Line":0},"fn_name":"reject_request"},{"line":79,"address":[22757916,22758028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[22758034,22758107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[22758080,22758287,22758901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[22758450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[22758465],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[22758500],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[22758573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[22760434,22759250,22758849,22759135,22759089,22758588],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[22758602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[22758616],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[22758722],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[22758668],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[22758882,22757960,22758940,22759218,22758834,22759121],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[22759940,22759837,22759875,22759384,22760402],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[22759453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[22759338],"length":1,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[18130048],"length":1,"stats":{"Line":0},"fn_name":"list_requests"},{"line":138,"address":[22753385,22753273],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[22753391,22753462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[22753437,22755030,22753646],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[22757440,22753869,22757462],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":144,"address":[22753937,22754304,22754026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[22754073,22754137,22754182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[22754249,22754204,22754143],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[22754210,22754271],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[22754112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[22754340],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[22754377],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[22754414],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[22754519],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[22754696],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[22754758,22754950,22755295,22755435,22755233],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[22754772],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[22754863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[22754873],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[22753317,22754983,22755069,22755281,22754935,22755403],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[22755933],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[22755612],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[22755668],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[22755732],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[22755755],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[22755762],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[22755818],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[22755881],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[22755904],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[22755919],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[18130528],"length":1,"stats":{"Line":1},"fn_name":"paginate_requests"},{"line":192,"address":[18130558],"length":1,"stats":{"Line":1},"fn_name":null},{"line":193,"address":[18130608],"length":1,"stats":{"Line":1},"fn_name":null},{"line":194,"address":[18130812,18130913],"length":1,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[18130671],"length":1,"stats":{"Line":3},"fn_name":null},{"line":197,"address":[18130861,18130691],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[18131022],"length":1,"stats":{"Line":1},"fn_name":null},{"line":201,"address":[18132192],"length":1,"stats":{"Line":1},"fn_name":"validate_decision_comment"},{"line":202,"address":[18132251],"length":1,"stats":{"Line":1},"fn_name":null},{"line":203,"address":[18132311],"length":1,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[18132281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[18132442],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[18132430],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[18131120],"length":1,"stats":{"Line":0},"fn_name":"get_request_detail"},{"line":221,"address":[22764409,22764273],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[22764494,22764415],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[22764758,22764683,22764461],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[22764774],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[22765222,22765271,22764844,22764954,22764789],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[22764868,22764806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[22764907,22764317,22764976,22765029,22765257],"length":1,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[22765328],"length":1,"stats":{"Line":0},"fn_name":null},{"line":233,"address":[22766226],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[22765922,22765374,22765460,22765525,22765422,22765752,22766379,22766417],"length":1,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[22766536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":243,"address":[22766798,22764725,22766723],"length":1,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[22766814],"length":1,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[22767249,22766872,22767200,22766829,22766958],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[22766843,22766896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[22764338,22767007,22766980,22767235,22766923],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[22767306],"length":1,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[22768202],"length":1,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[22768355,22767730,22767898,22767352,22767400,22767503,22767438],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[22768506],"length":1,"stats":{"Line":0},"fn_name":null},{"line":259,"address":[22766757,22768677],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[18131248],"length":1,"stats":{"Line":1},"fn_name":"parse_filter_datetime"},{"line":263,"address":[18131305,18131402],"length":1,"stats":{"Line":2},"fn_name":null},{"line":264,"address":[18131422],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[18131349,18131538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":267,"address":[18131556],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[18131675,18131485],"length":1,"stats":{"Line":1},"fn_name":null},{"line":270,"address":[18131702],"length":1,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[18131780,18131611],"length":1,"stats":{"Line":2},"fn_name":null},{"line":273,"address":[18132178,18131794],"length":1,"stats":{"Line":2},"fn_name":null},{"line":274,"address":[18132108,18131878],"length":1,"stats":{"Line":1},"fn_name":null},{"line":276,"address":[18131975,18131798],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[18132045],"length":1,"stats":{"Line":1},"fn_name":null},{"line":280,"address":[18131765],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":24,"coverable":112},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","sessions.rs"],"content":"use axum::{\n    extract::{Extension, Path, State},\n    http::{header::USER_AGENT, HeaderMap},\n    Json,\n};\nuse chrono::{DateTime, Utc};\nuse serde::Serialize;\nuse serde_json::{json, Value};\nuse std::str::FromStr;\nuse std::sync::Arc;\nuse utoipa::ToSchema;\n\nuse crate::{\n    error::AppError,\n    middleware::request_id::RequestId,\n    models::{active_session::ActiveSession, user::User},\n    repositories::{active_session, auth as auth_repo},\n    services::audit_log::{AuditLogEntry, AuditLogServiceTrait},\n    services::token_cache::TokenCacheServiceTrait,\n    state::AppState,\n    types::UserId,\n    utils::jwt::Claims,\n};\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct AdminSessionResponse {\n    pub id: String,\n    pub user_id: String,\n    pub device_label: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub last_seen_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: DateTime\u003cUtc\u003e,\n    pub is_current: bool,\n}\n\nimpl AdminSessionResponse {\n    fn from_session(session: ActiveSession, current_jti: \u0026str) -\u003e Self {\n        let is_current = session\n            .access_jti\n            .as_deref()\n            .map(|jti| jti == current_jti)\n            .unwrap_or(false);\n        Self {\n            id: session.id,\n            user_id: session.user_id.to_string(),\n            device_label: session.device_label,\n            created_at: session.created_at,\n            last_seen_at: session.last_seen_at,\n            expires_at: session.expires_at,\n            is_current,\n        }\n    }\n}\n\npub async fn list_user_sessions(\n    State(state): State\u003cAppState\u003e,\n    Extension(_user): Extension\u003cUser\u003e,\n    Extension(claims): Extension\u003cClaims\u003e,\n    Path(user_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cAdminSessionResponse\u003e\u003e, AppError\u003e {\n    let user_id =\n        UserId::from_str(\u0026user_id).map_err(|_| AppError::BadRequest(\"Invalid user ID\".into()))?;\n\n    let sessions = active_session::list_active_sessions_for_user(state.read_pool(), user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n    let responses = sessions\n        .into_iter()\n        .map(|session| AdminSessionResponse::from_session(session, \u0026claims.jti))\n        .collect();\n    Ok(Json(responses))\n}\n\npub async fn revoke_session(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(request_id): Extension\u003cRequestId\u003e,\n    Extension(audit_log_service): Extension\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    headers: HeaderMap,\n    Path(session_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if session_id.trim().is_empty() {\n        return Err(AppError::BadRequest(\"Session ID is required\".into()));\n    }\n\n    let session = active_session::find_active_session_by_id(\u0026state.write_pool, \u0026session_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n        .ok_or_else(|| AppError::NotFound(\"Session not found\".into()))?;\n\n    revoke_session_tokens(\u0026state.write_pool, state.token_cache.as_ref(), \u0026session).await?;\n\n    record_session_audit_event(\n        Some(audit_log_service),\n        \u0026user.id,\n        \u0026headers,\n        \u0026request_id,\n        \"session_destroy\",\n        Some(session.id.clone()),\n        Some(json!({\n            \"reason\": \"admin_revoke\",\n            \"target_user_id\": session.user_id.to_string()\n        })),\n    );\n\n    Ok(Json(json!({\n        \"message\": \"Session revoked\",\n        \"session_id\": session_id\n    })))\n}\n\nasync fn revoke_session_tokens(\n    pool: \u0026sqlx::PgPool,\n    token_cache: Option\u003c\u0026Arc\u003cdyn TokenCacheServiceTrait\u003e\u003e,\n    session: \u0026ActiveSession,\n) -\u003e Result\u003c(), AppError\u003e {\n    if let Some(access_jti) = session.access_jti.as_deref() {\n        auth_repo::delete_active_access_token_by_jti(pool, access_jti)\n            .await\n            .map_err(|e| AppError::InternalServerError(e.into()))?;\n        if let Some(cache) = token_cache {\n            let _ = cache.invalidate_token(access_jti).await;\n        }\n    }\n\n    auth_repo::delete_refresh_token_by_id(pool, \u0026session.refresh_token_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    active_session::delete_active_session_by_id(pool, \u0026session.id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    Ok(())\n}\n\nfn record_session_audit_event(\n    audit_log_service: Option\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    actor_id: \u0026UserId,\n    headers: \u0026HeaderMap,\n    request_id: \u0026RequestId,\n    event_type: \u0026'static str,\n    session_id: Option\u003cString\u003e,\n    metadata: Option\u003cValue\u003e,\n) {\n    let Some(audit_log_service) = audit_log_service else {\n        return;\n    };\n    let entry = AuditLogEntry {\n        occurred_at: Utc::now(),\n        actor_id: Some(*actor_id),\n        actor_type: \"user\".to_string(),\n        event_type: event_type.to_string(),\n        target_type: Some(\"session\".to_string()),\n        target_id: session_id,\n        result: \"success\".to_string(),\n        error_code: None,\n        metadata,\n        ip: extract_ip(headers),\n        user_agent: extract_user_agent(headers),\n        request_id: Some(request_id.0.clone()),\n    };\n\n    tokio::spawn(async move {\n        if let Err(err) = audit_log_service.record_event(entry).await {\n            tracing::warn!(\n                error = ?err,\n                event_type = %event_type,\n                \"Failed to record session audit log\"\n            );\n        }\n    });\n}\n\nfn extract_ip(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    if let Some(value) = headers.get(\"x-forwarded-for\").and_then(|v| v.to_str().ok()) {\n        return value\n            .split(',')\n            .next()\n            .map(|ip| ip.trim().to_string())\n            .filter(|ip| !ip.is_empty());\n    }\n    headers\n        .get(\"x-real-ip\")\n        .and_then(|v| v.to_str().ok())\n        .map(|ip| ip.trim().to_string())\n        .filter(|ip| !ip.is_empty())\n}\n\nfn extract_user_agent(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    headers\n        .get(USER_AGENT)\n        .and_then(|v| v.to_str().ok())\n        .map(|agent| agent.trim().to_string())\n        .filter(|agent| !agent.is_empty())\n}\n","traces":[{"line":37,"address":[22490736,22491331],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[22490776,22490917],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[22490873],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[22490926],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22490951],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[22491022],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[22491043],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[22491065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[22491093],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[22490576],"length":1,"stats":{"Line":0},"fn_name":"list_user_sessions"},{"line":61,"address":[21454166,21456080,21454046,21456094,21454539],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":64,"address":[21454424,21454740,21454802,21454889,21454956,21454365,21454491],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[21454090,21454598,21454479,21454788,21454521],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[21454866,21454924,21456014,21456000],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":67,"address":[21455093],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[21455776,21455817,21455202],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":71,"address":[21455260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[22490176],"length":1,"stats":{"Line":0},"fn_name":"revoke_session"},{"line":82,"address":[21448640,21448486],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[21448930,21448761],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[21448834,21449663,21450092,21449310,21449411,21449739,21448714,21449487,21449370,21448872],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[21449320,21449129,21448539,21448857,21448905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[21453200,21449455,21449388,21453214],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":89,"address":[21453280,21449707,21449640,21453294],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":91,"address":[21449889,21448560,21449987,21450116],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[21450499],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[21450544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[21450558],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[21450572],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[21450586,21450661],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[21450857,21451154,21451221,21450792,21450754,21452841,21450709,21451084],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[21451132],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[21451652,21451762,21452787,21451697,21451989,21452059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[22491440],"length":1,"stats":{"Line":0},"fn_name":"revoke_session_tokens"},{"line":117,"address":[21456348,21456555],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21457034,21457188,21456975,21456743,21457453,21457121,21456634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[20989777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21459008,21457098,21457156,21459022],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":121,"address":[21457261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[21457312,21456437,21457552],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[21458035,21457829,21458248,21457791,21458457,21458181,21456669,21458094],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[20989809],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[21458158,21458942,21458928,21458216],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":130,"address":[21458621,21458767,21458834,21458412,21458913,21458680,21458321],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[20989825],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[21458744,21458802,21459102,21459088],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":134,"address":[21458896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[22493122,22492963,22491488],"length":1,"stats":{"Line":0},"fn_name":"record_session_audit_event"},{"line":146,"address":[22491604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[22491700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[22491784],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[22491819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[22491860],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[22492000,22491923],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[22492063],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[22492205],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[22492269],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[22492322,22492382],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[22492791],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[20993604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[21459946,21460425,21460030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[22489904],"length":1,"stats":{"Line":0},"fn_name":"extract_ip"},{"line":176,"address":[22489940],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[22490030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[22490046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[21447680,21447728],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":181,"address":[21447760,21447769],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":185,"address":[22490112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[21447840,21447792],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":187,"address":[21447561,21447552],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":190,"address":[22490432],"length":1,"stats":{"Line":0},"fn_name":"extract_user_agent"},{"line":191,"address":[22490462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[22490510],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[21453417,21453408],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":194,"address":[21453456,21453504],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":195,"address":[21453385,21453376],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"}],"covered":0,"coverable":76},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","subject_requests.rs"],"content":"use axum::{\n    extract::{Extension, Path, Query, State},\n    http::StatusCode,\n    Json,\n};\nuse chrono::{DateTime, NaiveDate, NaiveDateTime, NaiveTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Value};\nuse utoipa::{IntoParams, ToSchema};\n\nuse super::requests::validate_decision_comment;\nuse crate::{\n    error::AppError,\n    models::{\n        request::RequestStatus,\n        subject_request::{DataSubjectRequestResponse, DataSubjectRequestType},\n        user::User,\n    },\n    repositories::subject_request::{self, SubjectRequestFilters},\n    state::AppState,\n    utils::time,\n};\n\nconst DEFAULT_PAGE: i64 = 1;\nconst DEFAULT_PER_PAGE: i64 = 25;\nconst MAX_PER_PAGE: i64 = 100;\nconst MAX_PAGE: i64 = 1_000;\n\n#[derive(Debug, Deserialize, Serialize, IntoParams, ToSchema)]\npub struct SubjectRequestListQuery {\n    pub status: Option\u003cString\u003e,\n    #[serde(rename = \"type\")]\n    pub r#type: Option\u003cString\u003e,\n    pub user_id: Option\u003cString\u003e,\n    pub from: Option\u003cString\u003e,\n    pub to: Option\u003cString\u003e,\n    pub page: Option\u003ci64\u003e,\n    pub per_page: Option\u003ci64\u003e,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct SubjectRequestListResponse {\n    pub page: i64,\n    pub per_page: i64,\n    pub total: i64,\n    pub items: Vec\u003cDataSubjectRequestResponse\u003e,\n}\n\n#[derive(Debug, Deserialize, Serialize, ToSchema)]\npub struct DecisionPayload {\n    pub comment: String,\n}\n\npub async fn list_subject_requests(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(q): Query\u003cSubjectRequestListQuery\u003e,\n) -\u003e Result\u003cJson\u003cSubjectRequestListResponse\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    if !user.is_admin() {\n        return Err((StatusCode::FORBIDDEN, Json(json!({\"error\":\"Forbidden\"}))));\n    }\n\n    let (page, per_page, filters) = validate_list_query(q)?;\n    let offset = (page - 1) * per_page;\n    let (items, total) =\n        subject_request::list_subject_requests(\u0026state.write_pool, \u0026filters, per_page, offset)\n            .await\n            .map_err(|err| {\n                tracing::error!(error = %err, \"failed to list subject requests\");\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    Json(json!({\"error\": \"Database error\"})),\n                )\n            })?;\n\n    Ok(Json(SubjectRequestListResponse {\n        page,\n        per_page,\n        total,\n        items: items\n            .into_iter()\n            .map(DataSubjectRequestResponse::from)\n            .collect(),\n    }))\n}\n\npub async fn approve_subject_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(request_id): Path\u003cString\u003e,\n    Json(body): Json\u003cDecisionPayload\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    if !user.is_admin() {\n        return Err((StatusCode::FORBIDDEN, Json(json!({\"error\":\"Forbidden\"}))));\n    }\n    validate_decision_comment(\u0026body.comment).map_err(map_app_error)?;\n    ensure_pending_request(\u0026state.write_pool, \u0026request_id).await?;\n    let now = time::now_utc(\u0026state.config.time_zone);\n    let approver_id = user.id.to_string();\n\n    let rows = subject_request::approve_subject_request(\n        \u0026state.write_pool,\n        \u0026request_id,\n        \u0026approver_id,\n        \u0026body.comment,\n        now,\n    )\n    .await\n    .map_err(|err| {\n        tracing::error!(error = %err, \"failed to approve subject request\");\n        (\n            StatusCode::INTERNAL_SERVER_ERROR,\n            Json(json!({\"error\": \"Database error\"})),\n        )\n    })?;\n\n    if rows == 0 {\n        return Err((\n            StatusCode::NOT_FOUND,\n            Json(json!({\"error\": \"Request not found or already processed\"})),\n        ));\n    }\n\n    Ok(Json(json!({\"message\": \"Subject request approved\"})))\n}\n\npub async fn reject_subject_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(request_id): Path\u003cString\u003e,\n    Json(body): Json\u003cDecisionPayload\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    if !user.is_admin() {\n        return Err((StatusCode::FORBIDDEN, Json(json!({\"error\":\"Forbidden\"}))));\n    }\n    validate_decision_comment(\u0026body.comment).map_err(map_app_error)?;\n    ensure_pending_request(\u0026state.write_pool, \u0026request_id).await?;\n    let now = time::now_utc(\u0026state.config.time_zone);\n    let approver_id = user.id.to_string();\n\n    let rows = subject_request::reject_subject_request(\n        \u0026state.write_pool,\n        \u0026request_id,\n        \u0026approver_id,\n        \u0026body.comment,\n        now,\n    )\n    .await\n    .map_err(|err| {\n        tracing::error!(error = %err, \"failed to reject subject request\");\n        (\n            StatusCode::INTERNAL_SERVER_ERROR,\n            Json(json!({\"error\": \"Database error\"})),\n        )\n    })?;\n\n    if rows == 0 {\n        return Err((\n            StatusCode::NOT_FOUND,\n            Json(json!({\"error\": \"Request not found or already processed\"})),\n        ));\n    }\n\n    Ok(Json(json!({\"message\": \"Subject request rejected\"})))\n}\n\nasync fn ensure_pending_request(\n    pool: \u0026sqlx::PgPool,\n    request_id: \u0026str,\n) -\u003e Result\u003c(), (StatusCode, Json\u003cValue\u003e)\u003e {\n    let existing = subject_request::fetch_subject_request(pool, request_id)\n        .await\n        .map_err(|err| {\n            tracing::error!(error = %err, \"failed to fetch subject request\");\n            (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                Json(json!({\"error\": \"Database error\"})),\n            )\n        })?;\n\n    match existing {\n        Some(request) if matches!(request.status, RequestStatus::Pending) =\u003e Ok(()),\n        _ =\u003e Err((\n            StatusCode::NOT_FOUND,\n            Json(json!({\"error\": \"Request not found or already processed\"})),\n        )),\n    }\n}\n\nfn validate_list_query(\n    q: SubjectRequestListQuery,\n) -\u003e Result\u003c(i64, i64, SubjectRequestFilters), (StatusCode, Json\u003cValue\u003e)\u003e {\n    let page = q.page.unwrap_or(DEFAULT_PAGE).clamp(1, MAX_PAGE);\n    let per_page = q\n        .per_page\n        .unwrap_or(DEFAULT_PER_PAGE)\n        .clamp(1, MAX_PER_PAGE);\n\n    let from = parse_from_datetime(q.from.as_deref()).map_err(bad_request_helper)?;\n    let to = parse_to_datetime(q.to.as_deref()).map_err(bad_request_helper)?;\n\n    if let (Some(from), Some(to)) = (from, to) {\n        if from \u003e to {\n            return Err(bad_request_helper(\"`from` must be before or equal to `to`\"));\n        }\n    }\n\n    let status = q.status.as_deref().map(parse_request_status).transpose()?;\n    let request_type = q.r#type.as_deref().map(parse_request_type).transpose()?;\n\n    let user_id = normalize_filter(q.user_id);\n\n    Ok((\n        page,\n        per_page,\n        SubjectRequestFilters {\n            status,\n            request_type,\n            user_id,\n            from,\n            to,\n        },\n    ))\n}\n\nfn normalize_filter(value: Option\u003cString\u003e) -\u003e Option\u003cString\u003e {\n    value\n        .map(|value| value.trim().to_string())\n        .filter(|value| !value.is_empty())\n}\n\nfn parse_request_status(value: \u0026str) -\u003e Result\u003cRequestStatus, (StatusCode, Json\u003cValue\u003e)\u003e {\n    match value.to_ascii_lowercase().as_str() {\n        \"pending\" =\u003e Ok(RequestStatus::Pending),\n        \"approved\" =\u003e Ok(RequestStatus::Approved),\n        \"rejected\" =\u003e Ok(RequestStatus::Rejected),\n        \"cancelled\" =\u003e Ok(RequestStatus::Cancelled),\n        _ =\u003e Err(bad_request_helper(\n            \"`status` must be pending, approved, rejected, or cancelled\",\n        )),\n    }\n}\n\nfn parse_request_type(value: \u0026str) -\u003e Result\u003cDataSubjectRequestType, (StatusCode, Json\u003cValue\u003e)\u003e {\n    match value.to_ascii_lowercase().as_str() {\n        \"access\" =\u003e Ok(DataSubjectRequestType::Access),\n        \"rectify\" =\u003e Ok(DataSubjectRequestType::Rectify),\n        \"delete\" =\u003e Ok(DataSubjectRequestType::Delete),\n        \"stop\" =\u003e Ok(DataSubjectRequestType::Stop),\n        _ =\u003e Err(bad_request_helper(\n            \"`type` must be access, rectify, delete, or stop\",\n        )),\n    }\n}\n\nfn parse_from_datetime(raw: Option\u003c\u0026str\u003e) -\u003e Result\u003cOption\u003cDateTime\u003cUtc\u003e\u003e, \u0026'static str\u003e {\n    match raw {\n        Some(value) =\u003e parse_datetime_value(value, true)\n            .ok_or(\"`from` must be a valid datetime (RFC3339 or YYYY-MM-DD)\")\n            .map(Some),\n        None =\u003e Ok(None),\n    }\n}\n\nfn parse_to_datetime(raw: Option\u003c\u0026str\u003e) -\u003e Result\u003cOption\u003cDateTime\u003cUtc\u003e\u003e, \u0026'static str\u003e {\n    match raw {\n        Some(value) =\u003e parse_datetime_value(value, false)\n            .ok_or(\"`to` must be a valid datetime (RFC3339 or YYYY-MM-DD)\")\n            .map(Some),\n        None =\u003e Ok(None),\n    }\n}\n\nfn parse_datetime_value(value: \u0026str, is_start: bool) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n    if let Ok(dt) = DateTime::parse_from_rfc3339(value) {\n        return Some(dt.with_timezone(\u0026Utc));\n    }\n    if let Ok(dt) = NaiveDateTime::parse_from_str(value, \"%Y-%m-%dT%H:%M:%S\") {\n        return Some(DateTime::\u003cUtc\u003e::from_naive_utc_and_offset(dt, Utc));\n    }\n    if let Ok(dt) = NaiveDateTime::parse_from_str(value, \"%Y-%m-%d %H:%M:%S\") {\n        return Some(DateTime::\u003cUtc\u003e::from_naive_utc_and_offset(dt, Utc));\n    }\n    if let Ok(date) = NaiveDate::parse_from_str(value, \"%Y-%m-%d\") {\n        let time = if is_start {\n            NaiveTime::from_hms_opt(0, 0, 0)\n        } else {\n            NaiveTime::from_hms_opt(23, 59, 59)\n        }?;\n        return Some(DateTime::\u003cUtc\u003e::from_naive_utc_and_offset(\n            NaiveDateTime::new(date, time),\n            Utc,\n        ));\n    }\n    None\n}\n\nfn map_app_error(err: AppError) -\u003e (StatusCode, Json\u003cValue\u003e) {\n    match err {\n        AppError::BadRequest(message) =\u003e bad_request_helper(\u0026message),\n        AppError::Forbidden(message) =\u003e (StatusCode::FORBIDDEN, Json(json!({ \"error\": message }))),\n        AppError::Unauthorized(message) =\u003e {\n            (StatusCode::UNAUTHORIZED, Json(json!({ \"error\": message })))\n        }\n        AppError::Conflict(message) =\u003e (StatusCode::CONFLICT, Json(json!({ \"error\": message }))),\n        AppError::NotFound(message) =\u003e (StatusCode::NOT_FOUND, Json(json!({ \"error\": message }))),\n        AppError::Validation(errors) =\u003e (\n            StatusCode::BAD_REQUEST,\n            Json(json!({ \"error\": \"Validation failed\", \"details\": { \"errors\": errors } })),\n        ),\n        AppError::InternalServerError(err) =\u003e {\n            tracing::error!(error = %err, \"internal server error\");\n            (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                Json(json!({ \"error\": \"Internal server error\" })),\n            )\n        }\n    }\n}\n\nfn bad_request_helper(message: \u0026str) -\u003e (StatusCode, Json\u003cValue\u003e) {\n    (StatusCode::BAD_REQUEST, Json(json!({ \"error\": message })))\n}\n","traces":[{"line":54,"address":[20769840],"length":1,"stats":{"Line":0},"fn_name":"list_subject_requests"},{"line":59,"address":[21468698,21468592],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[21468830,21468895,21468792,21468712,21469400],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[21470020,21469454,21468727],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[21469869,21469919,21469732],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[21470566],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[21470271,21470001,21469953,21470059,21468633],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[21471392,21470349,21473383],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":69,"address":[21471510,21471423,21471878],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[21471868,21472848,21473361],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[21470822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[21470626],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[21470638],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[21470650],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[21470706],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[21470770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[21470793],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[20770192],"length":1,"stats":{"Line":0},"fn_name":"approve_subject_request"},{"line":93,"address":[21485658,21485526],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[21485672,21485823,21485758,21486321,21485720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[21486776,21485687,21486383],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[21486604,21485570,21486815,21487707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[21487267],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[21487297],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[21487329],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[21487343],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[21487446],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[21487498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[21487688,21487720,21487926,21487640,21485591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[21491799,21489808,21488004],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":110,"address":[21489839,21489926,21490294],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[21491264,21491777,21490284],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[21488210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21489542],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21489120,21489687,21489185,21488239,21489082],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[21488352,21489050,21488287,21488249,21488224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[20770016],"length":1,"stats":{"Line":0},"fn_name":"reject_subject_request"},{"line":133,"address":[21478406,21478538],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[21478703,21479201,21478552,21478600,21478638],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[21479656,21478567,21479263],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[21479695,21478450,21479484,21480587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[21480147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[21480177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[21480209],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[21480223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[21480326],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[21480378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[21480520,21480600,21480806,21480568,21478471],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[21484679,21482688,21480884],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":150,"address":[21482806,21483174,21482719],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[21483164,21484144,21484657],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[21481090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[21482422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[21482065,21482567,21481119,21481962,21482000],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[21481232,21481930,21481129,21481104,21481167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[20769968],"length":1,"stats":{"Line":0},"fn_name":"ensure_pending_request"},{"line":171,"address":[21474276,21474327,21474365,21474461,21473918,21474042],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[20996599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[21474342,21477559,21475568],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":174,"address":[21475686,21476054,21475599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[21477024,21476044,21477537],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[21474599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[21474633,21474678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[21475302],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[21474880,21475487,21474842,21474668,21474945],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[20766240,20768437],"length":1,"stats":{"Line":0},"fn_name":"validate_list_query"},{"line":193,"address":[20766262,20766372],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[20766468,20766402],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[20766410],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[20766446],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[20766476,20768471],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[20766760,20768466],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[20767186,20767039],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[20767262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[20767286],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[20767158,20767392,20768461],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[20767621,20768456],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[20767893],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[20768086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":216,"address":[20767978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[20764832],"length":1,"stats":{"Line":0},"fn_name":"normalize_filter"},{"line":227,"address":[20764846],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[20764872],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[20764892],"length":1,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[20769818,20769392,20769824],"length":1,"stats":{"Line":0},"fn_name":"parse_request_status"},{"line":233,"address":[20769513,20769435],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[20769529,20769600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[20769616,20769572,20769660],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[20769632,20769673,20769717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":237,"address":[20769689,20769765,20769730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[20769779,20769736],"length":1,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[20765616,20766048,20766042],"length":1,"stats":{"Line":0},"fn_name":"parse_request_type"},{"line":245,"address":[20765659,20765737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[20765824,20765753],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[20765884,20765840,20765796],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[20765856,20765941,20765897],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[20765913,20765989,20765954],"length":1,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[20766003,20765960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[20766064],"length":1,"stats":{"Line":0},"fn_name":"parse_from_datetime"},{"line":257,"address":[20766088],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[20766116],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[20766183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[20766200],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[20764912],"length":1,"stats":{"Line":0},"fn_name":"parse_to_datetime"},{"line":266,"address":[20764936],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[20764964],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[20765028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[20765045],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[20768576],"length":1,"stats":{"Line":0},"fn_name":"parse_datetime_value"},{"line":275,"address":[20768732,20768634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[20768752],"length":1,"stats":{"Line":0},"fn_name":null},{"line":278,"address":[20768875,20768679],"length":1,"stats":{"Line":0},"fn_name":null},{"line":279,"address":[20768893],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[20768816,20769041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[20769071],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[20768974,20769174],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[20769192,20769242],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[20769223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[20769196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[20769338],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[20769325],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[20769159],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[20758928,20760004],"length":1,"stats":{"Line":0},"fn_name":"map_app_error"},{"line":299,"address":[20758959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[20761718,20759268],"length":1,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[20760586,20759168],"length":1,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[20759118],"length":1,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[20759150,20760064,20760564],"length":1,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[20759218,20761152],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[20759068,20759427,20759982],"length":1,"stats":{"Line":0},"fn_name":null},{"line":307,"address":[20759385,20764680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[20759417,20763753,20764752],"length":1,"stats":{"Line":0},"fn_name":null},{"line":311,"address":[20759334],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[20761863,20759346,20762231],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[20762221,20763185,20763687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[20765583,20765589,20765088],"length":1,"stats":{"Line":0},"fn_name":"bad_request_helper"},{"line":322,"address":[20765115,20765246,20765561],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":137},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","admin","users.rs"],"content":"use axum::{\n    extract::{Extension, Path, Query, State},\n    Json,\n};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Value};\nuse std::str::FromStr;\nuse utoipa::{IntoParams, ToSchema};\nuse validator::Validate;\n\nuse crate::{\n    error::AppError,\n    models::user::{CreateUser, UpdateUser, User, UserResponse},\n    repositories::{auth as auth_repo, user as user_repo},\n    state::AppState,\n    types::UserId,\n    utils::password::{hash_password, validate_password_complexity},\n};\n\npub async fn get_users(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cUserResponse\u003e\u003e, AppError\u003e {\n    if !(user.is_admin() || user.is_system_admin()) {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    // Normalize role to snake_case at read to be resilient to legacy rows\n    let users = user_repo::list_users(state.read_pool())\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let responses = users.into_iter().map(UserResponse::from).collect();\n    Ok(Json(responses))\n}\n\npub async fn create_user(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cCreateUser\u003e,\n) -\u003e Result\u003cJson\u003cUserResponse\u003e, AppError\u003e {\n    if !user.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    payload.validate()?;\n    validate_password_complexity(\u0026payload.password, \u0026state.config)\n        .map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    // Check if username already exists\n    if let Some(_) = auth_repo::find_user_by_username(\u0026state.write_pool, \u0026payload.username)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n    {\n        return Err(AppError::BadRequest(\"Username already exists\".into()));\n    }\n\n    let password_to_hash = payload.password.clone();\n    let password_hash = tokio::task::spawn_blocking(move || hash_password(\u0026password_to_hash))\n        .await\n        .map_err(|_| {\n            AppError::InternalServerError(anyhow::anyhow!(\"Password hashing task failed\"))\n        })?\n        .map_err(|e| {\n            AppError::InternalServerError(anyhow::anyhow!(\"Failed to hash password: {}\", e))\n        })?;\n\n    let user = User::new(\n        payload.username,\n        password_hash,\n        payload.full_name,\n        payload.email,\n        payload.role,\n        payload.is_system_admin,\n    );\n\n    user_repo::create_user(\u0026state.write_pool, \u0026user)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let response = UserResponse::from(user);\n    Ok(Json(response))\n}\n\npub async fn update_user(\n    State(state): State\u003cAppState\u003e,\n    Extension(admin): Extension\u003cUser\u003e,\n    Path(user_id): Path\u003cString\u003e,\n    Json(payload): Json\u003cUpdateUser\u003e,\n) -\u003e Result\u003cJson\u003cUserResponse\u003e, AppError\u003e {\n    if !admin.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n    payload.validate()?;\n\n    let user_id_obj =\n        UserId::from_str(\u0026user_id).map_err(|_| AppError::BadRequest(\"Invalid user ID\".into()))?;\n\n    let existing_user = auth_repo::find_user_by_id(\u0026state.write_pool, user_id_obj)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n        .ok_or_else(|| AppError::NotFound(\"User not found\".into()))?;\n\n    if let Some(ref email) = payload.email {\n        let email_exists = user_repo::email_exists_for_other_user(\n            \u0026state.write_pool,\n            email,\n            \u0026existing_user.id.to_string(),\n        )\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n        if email_exists {\n            return Err(AppError::BadRequest(\"Email already in use\".into()));\n        }\n    }\n\n    let full_name = payload.full_name.unwrap_or(existing_user.full_name);\n    let email = payload.email.unwrap_or(existing_user.email);\n    let role = payload.role.unwrap_or(existing_user.role);\n    let is_system_admin = payload\n        .is_system_admin\n        .unwrap_or(existing_user.is_system_admin);\n\n    let updated_user = user_repo::update_user(\n        \u0026state.write_pool,\n        \u0026user_id,\n        \u0026full_name,\n        \u0026email,\n        role,\n        is_system_admin,\n    )\n    .await\n    .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    Ok(Json(UserResponse::from(updated_user)))\n}\n\n#[derive(Deserialize, ToSchema)]\npub struct ResetMfaPayload {\n    pub user_id: String,\n}\n\npub async fn reset_user_mfa(\n    State(state): State\u003cAppState\u003e,\n    Extension(requester): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cResetMfaPayload\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !requester.is_system_admin() {\n        return Err(AppError::Forbidden(\n            \"Only system administrators can reset MFA\".into(),\n        ));\n    }\n    let success = user_repo::reset_mfa(\u0026state.write_pool, \u0026payload.user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    if !success {\n        return Err(AppError::NotFound(\"User not found\".into()));\n    }\n\n    let user_id = UserId::from_str(\u0026payload.user_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid user ID format\".into()))?;\n\n    auth_repo::delete_refresh_tokens_for_user(\u0026state.write_pool, user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    Ok(Json(json!({\n        \"message\": \"MFA reset and refresh tokens revoked\",\n        \"user_id\": payload.user_id\n    })))\n}\n\n#[derive(Debug, Deserialize, IntoParams)]\npub struct DeleteUserParams {\n    #[serde(default)]\n    pub hard: bool,\n}\n\npub async fn delete_user(\n    State(state): State\u003cAppState\u003e,\n    Extension(requester): Extension\u003cUser\u003e,\n    Path(user_id): Path\u003cString\u003e,\n    Query(params): Query\u003cDeleteUserParams\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !requester.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let parsed_user_id = UserId::from_str(\u0026user_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid user ID format\".into()))?;\n\n    if requester.id == parsed_user_id {\n        return Err(AppError::BadRequest(\"Cannot delete yourself\".into()));\n    }\n\n    let exists = user_repo::user_exists(\u0026state.write_pool, \u0026user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    if !exists {\n        return Err(AppError::NotFound(\"User not found\".into()));\n    }\n\n    let username = user_repo::fetch_username(\u0026state.write_pool, \u0026user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n        .unwrap_or_default();\n\n    if params.hard {\n        user_repo::hard_delete_user(\u0026state.write_pool, \u0026user_id).await?;\n\n        tracing::info!(\n            user_id = %user_id,\n            username = %username,\n            requester_id = %requester.id,\n            \"user hard deleted\"\n        );\n\n        Ok(Json(json!({\n            \"message\": \"User permanently deleted\",\n            \"user_id\": user_id,\n            \"deletion_type\": \"hard\"\n        })))\n    } else {\n        user_repo::soft_delete_user(\u0026state.write_pool, \u0026user_id, \u0026requester.id.to_string()).await?;\n\n        tracing::info!(\n            user_id = %user_id,\n            username = %username,\n            requester_id = %requester.id,\n            \"user soft deleted (archived)\"\n        );\n\n        Ok(Json(json!({\n            \"message\": \"User archived\",\n            \"user_id\": user_id,\n            \"deletion_type\": \"soft\"\n        })))\n    }\n}\n\n#[derive(Debug, Serialize)]\npub struct ArchivedUserResponse {\n    pub id: String,\n    pub username: String,\n    pub full_name: String,\n    pub role: String,\n    pub is_system_admin: bool,\n    pub archived_at: String,\n    pub archived_by: Option\u003cString\u003e,\n}\n\npub async fn get_archived_users(\n    State(state): State\u003cAppState\u003e,\n    Extension(requester): Extension\u003cUser\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cArchivedUserResponse\u003e\u003e, AppError\u003e {\n    if !requester.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let rows = user_repo::get_archived_users(state.read_pool())\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let response: Vec\u003cArchivedUserResponse\u003e = rows\n        .into_iter()\n        .map(|row| ArchivedUserResponse {\n            id: row.id,\n            username: row.username,\n            full_name: row.full_name,\n            role: row.role,\n            is_system_admin: row.is_system_admin,\n            archived_at: row.archived_at.to_rfc3339(),\n            archived_by: row.archived_by,\n        })\n        .collect();\n\n    Ok(Json(response))\n}\n\npub async fn restore_archived_user(\n    State(state): State\u003cAppState\u003e,\n    Extension(requester): Extension\u003cUser\u003e,\n    Path(user_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !requester.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let exists = user_repo::archived_user_exists(\u0026state.write_pool, \u0026user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    if !exists {\n        return Err(AppError::NotFound(\"Archived user not found\".into()));\n    }\n\n    let username = user_repo::fetch_archived_username(\u0026state.write_pool, \u0026user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n        .unwrap_or_default();\n\n    let conflict_check = user_repo::username_exists(\u0026state.write_pool, \u0026username)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    if conflict_check {\n        return Err(AppError::BadRequest(\n            \"Username already in use by another user\".into(),\n        ));\n    }\n\n    user_repo::restore_user(\u0026state.write_pool, \u0026user_id).await?;\n\n    tracing::info!(\n        user_id = %user_id,\n        username = %username,\n        requester_id = %requester.id,\n        \"user restored from archive\"\n    );\n\n    Ok(Json(json!({\n        \"message\": \"User restored\",\n        \"user_id\": user_id\n    })))\n}\n\npub async fn delete_archived_user(\n    State(state): State\u003cAppState\u003e,\n    Extension(requester): Extension\u003cUser\u003e,\n    Path(user_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if !requester.is_system_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let exists = user_repo::archived_user_exists(\u0026state.write_pool, \u0026user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    if !exists {\n        return Err(AppError::NotFound(\"Archived user not found\".into()));\n    }\n\n    let username = user_repo::fetch_archived_username(\u0026state.write_pool, \u0026user_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n        .unwrap_or_default();\n\n    user_repo::hard_delete_archived_user(\u0026state.write_pool, \u0026user_id).await?;\n\n    tracing::info!(\n        user_id = %user_id,\n        username = %username,\n        requester_id = %requester.id,\n        \"archived user permanently deleted\"\n    );\n\n    Ok(Json(json!({\n        \"message\": \"Archived user permanently deleted\",\n        \"user_id\": user_id\n    })))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_reset_mfa_payload_structure() {\n        let payload = ResetMfaPayload {\n            user_id: \"test-user-id\".to_string(),\n        };\n        assert_eq!(payload.user_id, \"test-user-id\");\n    }\n\n    #[test]\n    fn test_delete_user_params_default() {\n        let params = DeleteUserParams { hard: false };\n        assert!(!params.hard);\n    }\n\n    #[test]\n    fn test_delete_user_params_hard_delete() {\n        let params = DeleteUserParams { hard: true };\n        assert!(params.hard);\n    }\n\n    #[test]\n    fn test_archived_user_response_structure() {\n        let response = ArchivedUserResponse {\n            id: \"test-id\".to_string(),\n            username: \"testuser\".to_string(),\n            full_name: \"Test User\".to_string(),\n            role: \"employee\".to_string(),\n            is_system_admin: false,\n            archived_at: \"2024-01-15T10:00:00Z\".to_string(),\n            archived_by: Some(\"admin-id\".to_string()),\n        };\n        assert_eq!(response.id, \"test-id\");\n        assert_eq!(response.username, \"testuser\");\n        assert_eq!(response.full_name, \"Test User\");\n        assert_eq!(response.role, \"employee\");\n        assert!(!response.is_system_admin);\n        assert_eq!(response.archived_at, \"2024-01-15T10:00:00Z\");\n        assert_eq!(response.archived_by, Some(\"admin-id\".to_string()));\n    }\n\n    #[test]\n    fn test_archived_user_response_without_archived_by() {\n        let response = ArchivedUserResponse {\n            id: \"test-id\".to_string(),\n            username: \"testuser\".to_string(),\n            full_name: \"Test User\".to_string(),\n            role: \"admin\".to_string(),\n            is_system_admin: true,\n            archived_at: \"2024-01-15T10:00:00Z\".to_string(),\n            archived_by: None,\n        };\n        assert!(response.is_system_admin);\n        assert_eq!(response.archived_by, None);\n    }\n\n    #[test]\n    fn test_user_id_parsing_valid() {\n        let valid_id = UserId::new();\n        let id_string = valid_id.to_string();\n        let parsed = UserId::from_str(\u0026id_string);\n        assert!(parsed.is_ok());\n        assert_eq!(parsed.unwrap(), valid_id);\n    }\n\n    #[test]\n    fn test_user_id_parsing_invalid() {\n        let invalid_id = \"not-a-valid-uuid\";\n        let parsed = UserId::from_str(invalid_id);\n        assert!(parsed.is_err());\n    }\n\n    #[test]\n    fn test_user_role_admin_check() {\n        use crate::models::user::{User, UserRole};\n        use chrono::Utc;\n\n        let admin_user = User {\n            id: UserId::new(),\n            username: \"admin\".to_string(),\n            email: \"admin@example.com\".to_string(),\n            full_name: \"Admin User\".to_string(),\n            password_hash: \"hash\".to_string(),\n            role: UserRole::Admin,\n            is_system_admin: false,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: Utc::now(),\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n        };\n        assert!(admin_user.is_admin());\n        assert!(!admin_user.is_system_admin());\n    }\n\n    #[test]\n    fn test_user_role_system_admin_check() {\n        use crate::models::user::{User, UserRole};\n        use chrono::Utc;\n\n        let sys_admin_user = User {\n            id: UserId::new(),\n            username: \"sysadmin\".to_string(),\n            email: \"sysadmin@example.com\".to_string(),\n            full_name: \"System Admin\".to_string(),\n            password_hash: \"hash\".to_string(),\n            role: UserRole::Admin,\n            is_system_admin: true,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: Utc::now(),\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n        };\n        assert!(sys_admin_user.is_admin());\n        assert!(sys_admin_user.is_system_admin());\n    }\n\n    #[test]\n    fn test_user_role_employee_check() {\n        use crate::models::user::{User, UserRole};\n        use chrono::Utc;\n\n        let employee_user = User {\n            id: UserId::new(),\n            username: \"employee\".to_string(),\n            email: \"employee@example.com\".to_string(),\n            full_name: \"Employee User\".to_string(),\n            password_hash: \"hash\".to_string(),\n            role: UserRole::Employee,\n            is_system_admin: false,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: Utc::now(),\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n        };\n        assert!(!employee_user.is_admin());\n        assert!(!employee_user.is_system_admin());\n    }\n}\n","traces":[{"line":20,"address":[22349776],"length":1,"stats":{"Line":0},"fn_name":"get_users"},{"line":24,"address":[19614171,19614231,19614075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[19614237],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[19614725,19614504,19614205,19614469,19614787,19614941,19614874],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[19614113,19614583,19614492,19614534,19614773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[19614851,19614909,19615584,19615598],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":32,"address":[19615078,19615198],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[19615233],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[22348864],"length":1,"stats":{"Line":0},"fn_name":"create_user"},{"line":41,"address":[19569820,19569663],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[19569826,19569897],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[19569872,19570081,19570677],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[19570260,19570672,19570375,19570442],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[19570352,19575008,19570410,19575036],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":49,"address":[19570515,19570957,19571071,19570620,19570900,19570995,19571638],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[19570605,19569710,19570716,19570910,19570653],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[19570972,19574942,19571039,19574928],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":53,"address":[19571225,19571321],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[19571447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[19571923,19571604,19571473,19572158,19572815,19572837,19575424,19571806,19575449,19572225,19571990,19571852],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":58,"address":[19571651,19569731,19571619,19571838,19571579],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[19575316,19575152,19571900],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":60,"address":[19575242,19575171],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[19574900,19574656,19574894,19572135],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":63,"address":[19574744,19574683],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[19572369],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[19572406],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[19572445],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[19572482],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[19572519],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[19572527],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[19573088,19573031,19572763,19572655,19573126,19573202],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[19572847,19572796,19569752,19573041,19572748],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[19573347,19573103,19575344,19573170,19575358],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":79,"address":[19573362],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[19573431],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[22349152],"length":1,"stats":{"Line":0},"fn_name":"update_user"},{"line":89,"address":[19587737,19587580],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[19587743,19587814],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[19588619,19587789,19587998],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[19594256,19594270,19588177,19588614],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":97,"address":[19589299,19589023,19588947,19588433,19589223,19588846,19588906,19590007,19590036,19588559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[19588856,19588658,19588544,19588592,19587627],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[19588924,19588991,19594190,19594176],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":100,"address":[19589267,19593934,19593920,19589200],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":102,"address":[19589445],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[19589507],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[19589521],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[19589753],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[19589985,19589937,19590268,19590052,19587648],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[19589823,19594110,19590404,19590346,19590530,19591512,19594096],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":111,"address":[19590555],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[19590564,19591333],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[19589555],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[19590613],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[19590866,19590776],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[19590923],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[19590876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[19590932],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[19590949],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[19591054],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[19591118],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[19587669,19591263,19591733,19591311,19591538],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[19594016,19591862,19591795,19594030],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":134,"address":[19592149,19592057],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[22349312],"length":1,"stats":{"Line":0},"fn_name":"reset_user_mfa"},{"line":147,"address":[19594801,19594678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[19594891],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[19594807],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[19595107,19595072,19595488,19595401,19594850,19595555,19595339,19596199],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[19594719,19595095,19595387,19595137,19595187],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[19595465,19597872,19597886,19595523],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":156,"address":[19595639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[19595713,19595643],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[19595985,19595872,19596194,19595686,19595918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[19595895,19595953,19597790,19597776],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":163,"address":[19597644,19596145,19596367,19596429,19596516,19596071,19596583],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[19594740,19596215,19596415,19596133,19596175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[19596493,19596551,19597696,19597710],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":167,"address":[19596701,19596766,19596993,19597590,19596656,19597060],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[22348992],"length":1,"stats":{"Line":0},"fn_name":"delete_user"},{"line":185,"address":[19576019,19576200],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[19576206,19576285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[19576520,19576474,19576587,19577100,19576252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[19586032,19576497,19586046,19576555],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":192,"address":[19576701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[19576959,19576790],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[19577449,19576901,19576743,19576863,19577516,19577966,19577300,19577362],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[19576886,19577139,19576934,19577348,19576066],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[19577484,19586222,19586208,19577426],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":200,"address":[19577600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[19577604,19577700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[19577650,19578208,19579128,19577911,19578362,19578295,19578146,19577873],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[19576087,19577944,19577896,19577985,19578194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[19578272,19578330,19586128,19586142],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":209,"address":[19578533,19585591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[19579141,19578605,19576108,19582436,19579035],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[19579519,19579945],"length":1,"stats":{"Line":0},"fn_name":null},{"line":219,"address":[19579928,19581287,19581617,19581390,19581687,19582350,19581867,19581932,19581325],"length":1,"stats":{"Line":0},"fn_name":null},{"line":225,"address":[19578746,19578550,19585955,19576129,19578816,19582475],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[19583305,19582879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[19583288,19584557,19585861,19584660,19585202,19584957,19584887,19585137,19584595],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[22349440],"length":1,"stats":{"Line":0},"fn_name":"get_archived_users"},{"line":257,"address":[19598283,19598187],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[19598354,19598289],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[19598955,19598548,19598583,19598806,19599022,19598332,19598868],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[19598571,19598613,19598663,19598225,19598854],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[19600208,19598990,19600222,19598932],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":265,"address":[19599159],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[19599904,19599279,19599664,19600115,19600188],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":268,"address":[19599700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[19599717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[19599735],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[19599753],"length":1,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[19599777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[19599787],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[19599868],"length":1,"stats":{"Line":0},"fn_name":null},{"line":278,"address":[19599314],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[22349648],"length":1,"stats":{"Line":0},"fn_name":"restore_archived_user"},{"line":286,"address":[19606993,19607174],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[19607276,19607180],"length":1,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[19607473,19608427,19607977,19607910,19607511,19607823,19607226,19607761],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[19607544,19607600,19607040,19607496,19607809],"length":1,"stats":{"Line":0},"fn_name":null},{"line":292,"address":[19607945,19613760,19613774,19607887],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":294,"address":[19608061],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[19608065,19608161],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[19608372,19609217,19608111,19608823,19608334,19608756,19608669,19608607],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[19608357,19608446,19607061,19608405,19608655],"length":1,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[19608791,19613680,19608733,19613694],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":303,"address":[19608994,19609391,19609540,19610084,19609607,19609124,19609162,19609453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":304,"address":[19609147,19607082,19609439,19609195,19609230],"length":1,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[19609517,19613246,19613232,19609575],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":307,"address":[19609691],"length":1,"stats":{"Line":0},"fn_name":null},{"line":308,"address":[19609919],"length":1,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[19609750],"length":1,"stats":{"Line":0},"fn_name":null},{"line":313,"address":[19609823,19609703,19610094,19613177,19607103],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[19610472,19610898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[19610881,19612472,19613123,19612542,19612180,19612245,19612142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":328,"address":[22349520],"length":1,"stats":{"Line":0},"fn_name":"delete_archived_user"},{"line":333,"address":[19600689,19600849],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[19600951,19600855],"length":1,"stats":{"Line":0},"fn_name":null},{"line":337,"address":[19600901,19601585,19601186,19602102,19601498,19601652,19601148,19601436],"length":1,"stats":{"Line":0},"fn_name":null},{"line":338,"address":[19601219,19601171,19601275,19601484,19600736],"length":1,"stats":{"Line":0},"fn_name":null},{"line":339,"address":[19606512,19601562,19606526,19601620],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":341,"address":[19601736],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[19601740,19601836],"length":1,"stats":{"Line":0},"fn_name":null},{"line":345,"address":[19602009,19602047,19602498,19601786,19602344,19602282,19602431,19602892],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[19602121,19602032,19602330,19600757,19602080],"length":1,"stats":{"Line":0},"fn_name":null},{"line":347,"address":[19602408,19606078,19606064,19602466],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":350,"address":[19602669,19602799,19602905,19600778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":352,"address":[19603709,19603283],"length":1,"stats":{"Line":0},"fn_name":null},{"line":359,"address":[19605056,19605283,19605353,19603692,19604953,19605934,19604991],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":152},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","attendance.rs"],"content":"use axum::{\n    extract::{Extension, Path, Query, State},\n    Json,\n};\nuse chrono::{DateTime, Datelike, Duration, Months, NaiveDate, NaiveDateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Value};\nuse sqlx::PgPool;\nuse std::str::FromStr;\nuse std::sync::Arc;\nuse utoipa::{IntoParams, ToSchema};\n\nuse crate::error::AppError;\nuse crate::handlers::attendance_utils::{\n    ensure_authorized_access, ensure_clock_in_exists, ensure_clocked_in, ensure_not_clocked_in,\n    ensure_not_clocked_out, fetch_attendance_by_id, fetch_attendance_by_user_date,\n    get_break_records, get_break_records_map, insert_attendance_record, update_clock_in,\n    update_clock_out,\n};\nuse crate::repositories::{\n    attendance::{AttendanceRepository, AttendanceRepositoryTrait},\n    break_record::BreakRecordRepository,\n    repository::Repository,\n};\nuse crate::state::AppState;\nuse crate::types::{AttendanceId, UserId};\nuse crate::{\n    models::{\n        attendance::{\n            Attendance, AttendanceResponse, AttendanceSummary, ClockInRequest, ClockOutRequest,\n        },\n        break_record::{BreakRecord, BreakRecordResponse},\n        user::User,\n    },\n    services::holiday::HolidayServiceTrait,\n    utils::{csv::append_csv_row, time},\n};\n\n#[derive(Debug, Deserialize, ToSchema, IntoParams)]\npub struct AttendanceQuery {\n    pub year: Option\u003ci32\u003e,\n    pub month: Option\u003cu32\u003e,\n    pub from: Option\u003cNaiveDate\u003e,\n    pub to: Option\u003cNaiveDate\u003e,\n}\n\n#[derive(Debug, Deserialize, ToSchema, IntoParams)]\npub struct AttendanceExportQuery {\n    pub from: Option\u003cNaiveDate\u003e,\n    pub to: Option\u003cNaiveDate\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\npub struct AttendanceStatusResponse {\n    pub status: String,\n    pub attendance_id: Option\u003cString\u003e,\n    pub active_break_id: Option\u003cString\u003e,\n    pub clock_in_time: Option\u003cNaiveDateTime\u003e,\n    pub clock_out_time: Option\u003cNaiveDateTime\u003e,\n}\n\npub async fn clock_in(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(holiday_service): Extension\u003cArc\u003cdyn HolidayServiceTrait\u003e\u003e,\n    Json(payload): Json\u003cClockInRequest\u003e,\n) -\u003e Result\u003cJson\u003cAttendanceResponse\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    let tz = \u0026state.config.time_zone;\n    let now_local = time::now_in_timezone(tz);\n    let now_utc = now_local.with_timezone(\u0026Utc);\n    let date = payload.date.unwrap_or_else(|| now_local.date_naive());\n    let clock_in_time = now_local.naive_local();\n\n    reject_if_holiday(holiday_service.as_ref(), date, user_id).await?;\n\n    let attendance: Attendance =\n        match fetch_attendance_by_user_date(\u0026state.write_pool, user_id, date).await? {\n            Some(mut attendance) =\u003e {\n                ensure_not_clocked_in(\u0026attendance)?;\n                attendance.clock_in_time = Some(clock_in_time);\n                attendance.updated_at = now_utc;\n                update_clock_in(\u0026state.write_pool, \u0026attendance).await?;\n                attendance\n            }\n            None =\u003e {\n                let mut attendance = Attendance::new(user_id, date, now_utc);\n                attendance.clock_in_time = Some(clock_in_time);\n                insert_attendance_record(\u0026state.write_pool, \u0026attendance).await?;\n                attendance\n            }\n        };\n\n    let break_records = get_break_records(\u0026state.write_pool, attendance.id).await?;\n    let response = build_attendance_response(attendance, break_records);\n\n    Ok(Json(response))\n}\n\npub async fn clock_out(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(holiday_service): Extension\u003cArc\u003cdyn HolidayServiceTrait\u003e\u003e,\n    Json(payload): Json\u003cClockOutRequest\u003e,\n) -\u003e Result\u003cJson\u003cAttendanceResponse\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    let tz = \u0026state.config.time_zone;\n    let now_local = time::now_in_timezone(tz);\n    let now_utc = now_local.with_timezone(\u0026Utc);\n    let date = payload.date.unwrap_or_else(|| now_local.date_naive());\n    let clock_out_time = now_local.naive_local();\n\n    reject_if_holiday(holiday_service.as_ref(), date, user_id).await?;\n\n    let attendance_opt: Option\u003cAttendance\u003e =\n        fetch_attendance_by_user_date(\u0026state.write_pool, user_id, date).await?;\n    let mut attendance: Attendance = attendance_opt\n        .ok_or_else(|| AppError::NotFound(\"No attendance record found for today\".into()))?;\n\n    ensure_not_clocked_out(\u0026attendance)?;\n    ensure_clock_in_exists(\u0026attendance)?;\n\n    let break_repo = BreakRecordRepository::new();\n    let active_break = break_repo\n        .find_active_break(\u0026state.write_pool, attendance.id)\n        .await?;\n\n    if active_break.is_some() {\n        return Err(AppError::BadRequest(\n            \"Break in progress. End break before clocking out\".into(),\n        ));\n    }\n\n    attendance.clock_out_time = Some(clock_out_time);\n    let break_minutes = total_break_minutes(\u0026state.write_pool, attendance.id).await?;\n    attendance.calculate_work_hours(break_minutes);\n    attendance.updated_at = now_utc;\n\n    update_clock_out(\u0026state.write_pool, \u0026attendance).await?;\n\n    let break_records = get_break_records(\u0026state.write_pool, attendance.id).await?;\n    let response = build_attendance_response(attendance, break_records);\n\n    Ok(Json(response))\n}\n\npub async fn break_start(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003ccrate::models::attendance::BreakStartRequest\u003e,\n) -\u003e Result\u003cJson\u003cBreakRecordResponse\u003e, AppError\u003e {\n    let tz = \u0026state.config.time_zone;\n    let now_local = time::now_in_timezone(tz);\n    let now_utc = now_local.with_timezone(\u0026Utc);\n    let break_start_time = now_local.naive_local();\n\n    // Check if attendance record exists and user is clocked in\n    let attendance = fetch_attendance_by_id(\u0026state.write_pool, payload.attendance_id).await?;\n    ensure_authorized_access(\u0026attendance, user.id)?;\n    ensure_clocked_in(\u0026attendance)?;\n\n    // Check if there's already an active break\n    let break_repo = BreakRecordRepository::new();\n    let active_break = break_repo\n        .find_active_break(\u0026state.write_pool, payload.attendance_id)\n        .await?;\n\n    if active_break.is_some() {\n        return Err(AppError::BadRequest(\"Break already in progress\".into()));\n    }\n\n    let break_record = BreakRecord::new(payload.attendance_id, break_start_time, now_utc);\n    break_repo.create(\u0026state.write_pool, \u0026break_record).await?;\n\n    let response = BreakRecordResponse::from(break_record);\n    Ok(Json(response))\n}\n\npub async fn break_end(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003ccrate::models::attendance::BreakEndRequest\u003e,\n) -\u003e Result\u003cJson\u003cBreakRecordResponse\u003e, AppError\u003e {\n    let tz = \u0026state.config.time_zone;\n    let now_local = time::now_in_timezone(tz);\n    let now_utc = now_local.with_timezone(\u0026Utc);\n    let break_end_time = now_local.naive_local();\n\n    // Find the break record\n    let break_repo = BreakRecordRepository::new();\n    let mut break_record = break_repo\n        .find_by_id(\u0026state.write_pool, payload.break_record_id)\n        .await?;\n\n    if !break_record.is_active() {\n        return Err(AppError::BadRequest(\"Break already ended\".into()));\n    }\n    let att = fetch_attendance_by_id(\u0026state.write_pool, break_record.attendance_id).await?;\n    ensure_authorized_access(\u0026att, user.id)?;\n\n    break_record.end_break(break_end_time, now_utc);\n    break_repo.update(\u0026state.write_pool, \u0026break_record).await?;\n\n    if att.clock_out_time.is_some() {\n        recalculate_total_hours(\u0026state.write_pool, att, now_utc).await?;\n    }\n\n    let response = BreakRecordResponse::from(break_record);\n    Ok(Json(response))\n}\n\npub async fn get_my_attendance(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(params): Query\u003cAttendanceQuery\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cAttendanceResponse\u003e\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    let tz = \u0026state.config.time_zone;\n    let (from, to) = if let (Some(f), Some(t)) = (params.from, params.to) {\n        if f \u003e t {\n            return Err(AppError::BadRequest(\"from must be \u003c= to\".into()));\n        }\n        (f, t)\n    } else if params.from.is_some() || params.to.is_some() {\n        let f = params.from.unwrap_or_else(|| time::today_local(tz));\n        let t = params.to.unwrap_or_else(|| time::today_local(tz));\n        if f \u003e t {\n            return Err(AppError::BadRequest(\"from must be \u003c= to\".into()));\n        }\n        (f, t)\n    } else {\n        let now_local = time::now_in_timezone(tz);\n        let year = params.year.unwrap_or_else(|| now_local.year());\n        let month = params.month.unwrap_or_else(|| now_local.month());\n        let Some(first_day) = NaiveDate::from_ymd_opt(year, month, 1) else {\n            return Err(AppError::BadRequest(\"Invalid year/month provided\".into()));\n        };\n        let Some(last_day) = first_day\n            .checked_add_months(Months::new(1))\n            .and_then(|d| d.checked_sub_signed(Duration::days(1)))\n        else {\n            return Err(AppError::BadRequest(\"Invalid year/month provided\".into()));\n        };\n        (first_day, last_day)\n    };\n\n    let repo = AttendanceRepository::new();\n    let attendances = repo\n        .find_by_user_and_range(state.read_pool(), user_id, from, to)\n        .await?;\n\n    let attendance_ids: Vec\u003cAttendanceId\u003e = attendances.iter().map(|a| a.id).collect();\n    let mut break_map = get_break_records_map(state.read_pool(), \u0026attendance_ids).await?;\n\n    let mut responses = Vec::new();\n    for attendance in attendances {\n        let break_records = break_map.remove(\u0026attendance.id).unwrap_or_default();\n        responses.push(build_attendance_response(attendance, break_records));\n    }\n\n    Ok(Json(responses))\n}\n\npub async fn get_attendance_status(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(params): Query\u003cstd::collections::HashMap\u003cString, String\u003e\u003e,\n) -\u003e Result\u003cJson\u003cAttendanceStatusResponse\u003e, AppError\u003e {\n    let user_id = user.id;\n    let date = params\n        .get(\"date\")\n        .and_then(|s| NaiveDate::parse_from_str(s, \"%Y-%m-%d\").ok())\n        .unwrap_or_else(|| time::today_local(\u0026state.config.time_zone));\n\n    let repo = AttendanceRepository::new();\n    let attendance = repo\n        .find_by_user_and_date(state.read_pool(), user_id, date)\n        .await?;\n\n    if let Some(att) = attendance {\n        // Check active break\n        let break_repo = BreakRecordRepository::new();\n        let active_break = break_repo\n            .find_active_break(state.read_pool(), att.id)\n            .await?;\n\n        let resp = if att.clock_in_time.is_none() {\n            AttendanceStatusResponse {\n                status: \"not_started\".into(),\n                attendance_id: Some(att.id.to_string()),\n                active_break_id: None,\n                clock_in_time: None,\n                clock_out_time: None,\n            }\n        } else if att.is_clocked_out() {\n            AttendanceStatusResponse {\n                status: \"clocked_out\".into(),\n                attendance_id: Some(att.id.to_string()),\n                active_break_id: None,\n                clock_in_time: att.clock_in_time,\n                clock_out_time: att.clock_out_time,\n            }\n        } else if let Some(b) = active_break {\n            let bid: Option\u003cString\u003e = Some(b.id.to_string());\n            AttendanceStatusResponse {\n                status: \"on_break\".into(),\n                attendance_id: Some(att.id.to_string()),\n                active_break_id: bid,\n                clock_in_time: att.clock_in_time,\n                clock_out_time: None,\n            }\n        } else {\n            AttendanceStatusResponse {\n                status: \"clocked_in\".into(),\n                attendance_id: Some(att.id.to_string()),\n                active_break_id: None,\n                clock_in_time: att.clock_in_time,\n                clock_out_time: None,\n            }\n        };\n        Ok(Json(resp))\n    } else {\n        Ok(Json(AttendanceStatusResponse {\n            status: \"not_started\".into(),\n            attendance_id: None,\n            active_break_id: None,\n            clock_in_time: None,\n            clock_out_time: None,\n        }))\n    }\n}\n\npub async fn get_breaks_by_attendance(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(attendance_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cBreakRecordResponse\u003e\u003e, AppError\u003e {\n    let attendance_id = AttendanceId::from_str(\u0026attendance_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid attendance ID format\".into()))?;\n    let attendance = fetch_attendance_by_id(state.read_pool(), attendance_id).await?;\n    ensure_authorized_access(\u0026attendance, user.id)?;\n    let records = get_break_records(state.read_pool(), attendance.id).await?;\n    Ok(Json(records))\n}\n\npub async fn get_my_summary(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(params): Query\u003cAttendanceQuery\u003e,\n) -\u003e Result\u003cJson\u003cAttendanceSummary\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    let now_local = time::now_in_timezone(\u0026state.config.time_zone);\n    let year = params.year.unwrap_or_else(|| now_local.year());\n    let month = params.month.unwrap_or_else(|| now_local.month());\n\n    let Some(first_day) = NaiveDate::from_ymd_opt(year, month, 1) else {\n        return Err(AppError::BadRequest(\"Invalid year/month provided\".into()));\n    };\n    let Some(last_day) = first_day\n        .checked_add_months(Months::new(1))\n        .and_then(|d| d.checked_sub_signed(Duration::days(1)))\n    else {\n        return Err(AppError::BadRequest(\"Invalid year/month provided\".into()));\n    };\n\n    let repo = AttendanceRepository::new();\n    let (total_work_hours, total_work_days_i64) = repo\n        .get_summary_stats(state.read_pool(), user_id, first_day, last_day)\n        .await?;\n\n    let total_work_days = total_work_days_i64 as i32;\n    let average_daily_hours = if total_work_days \u003e 0 {\n        total_work_hours / total_work_days as f64\n    } else {\n        0.0\n    };\n\n    let summary = AttendanceSummary {\n        month,\n        year,\n        total_work_hours,\n        total_work_days,\n        average_daily_hours,\n    };\n\n    Ok(Json(summary))\n}\n\npub async fn export_my_attendance(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(params): Query\u003cAttendanceExportQuery\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    let from = params.from;\n    let to = params.to;\n\n    if let (Some(f), Some(t)) = (from, to) {\n        if f \u003e t {\n            return Err(AppError::BadRequest(\"from must be \u003c= to\".into()));\n        }\n    }\n\n    let repo = AttendanceRepository::new();\n    let rows = repo\n        .find_by_user_with_range_options(state.read_pool(), user.id, from, to)\n        .await?;\n\n    let mut csv_data = String::new();\n    append_csv_row(\n        \u0026mut csv_data,\n        \u0026[\n            \"Username\".to_string(),\n            \"Full Name\".to_string(),\n            \"Date\".to_string(),\n            \"Clock In\".to_string(),\n            \"Clock Out\".to_string(),\n            \"Total Hours\".to_string(),\n            \"Status\".to_string(),\n        ],\n    );\n    for row in rows {\n        let username = user.username.clone();\n        let full_name = user.full_name.clone();\n        let date = row.date.format(\"%Y-%m-%d\").to_string();\n        let clock_in = row\n            .clock_in_time\n            .map(|t| t.format(\"%H:%M:%S\").to_string())\n            .unwrap_or_default();\n        let clock_out = row\n            .clock_out_time\n            .map(|t| t.format(\"%H:%M:%S\").to_string())\n            .unwrap_or_default();\n        let total_hours = row\n            .total_work_hours\n            .map(|h| format!(\"{:.2}\", h))\n            .unwrap_or_else(|| \"0.00\".to_string());\n        let status = row.status.db_value().to_string();\n\n        append_csv_row(\n            \u0026mut csv_data,\n            \u0026[\n                username,\n                full_name,\n                date,\n                clock_in,\n                clock_out,\n                total_hours,\n                status,\n            ],\n        );\n    }\n\n    Ok(Json(json!({\n        \"csv_data\": csv_data,\n        \"filename\": format!(\n            \"my_attendance_export_{}.csv\",\n            time::now_in_timezone(\u0026state.config.time_zone).format(\"%Y%m%d_%H%M%S\")\n        )\n    })))\n}\n\nfn build_attendance_response(\n    attendance: Attendance,\n    break_records: Vec\u003cBreakRecordResponse\u003e,\n) -\u003e AttendanceResponse {\n    AttendanceResponse {\n        id: attendance.id,\n        user_id: attendance.user_id,\n        date: attendance.date,\n        clock_in_time: attendance.clock_in_time,\n        clock_out_time: attendance.clock_out_time,\n        status: attendance.status,\n        total_work_hours: attendance.total_work_hours,\n        break_records,\n    }\n}\n\npub(crate) async fn total_break_minutes(\n    pool: \u0026PgPool,\n    attendance_id: AttendanceId,\n) -\u003e Result\u003ci64, AppError\u003e {\n    let repo = BreakRecordRepository::new();\n    repo.get_total_duration(pool, attendance_id).await\n}\n\npub(crate) async fn recalculate_total_hours(\n    pool: \u0026PgPool,\n    mut attendance: Attendance,\n    updated_at: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003c(), AppError\u003e {\n    if attendance.clock_in_time.is_none() || attendance.clock_out_time.is_none() {\n        return Ok(());\n    }\n\n    let break_repo = BreakRecordRepository::new();\n    let break_minutes = break_repo.get_total_duration(pool, attendance.id).await?;\n\n    attendance.calculate_work_hours(break_minutes);\n    attendance.updated_at = updated_at;\n\n    let att_repo = AttendanceRepository::new();\n    att_repo.update(pool, \u0026attendance).await?;\n\n    Ok(())\n}\n\nasync fn reject_if_holiday(\n    holiday_service: \u0026dyn HolidayServiceTrait,\n    date: NaiveDate,\n    user_id: UserId,\n) -\u003e Result\u003c(), AppError\u003e {\n    let decision = holiday_service\n        .is_holiday(date, Some(\u0026user_id.to_string()))\n        .await?;\n\n    if decision.is_holiday {\n        let reason = decision.reason.label();\n        return Err(AppError::Forbidden(format!(\n            \"{} is a {}. Submit an overtime request before clocking in/out.\",\n            date, reason\n        )));\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::NaiveDate;\n\n    #[test]\n    fn test_attendance_query_default_values() {\n        let query = AttendanceQuery {\n            year: None,\n            month: None,\n            from: None,\n            to: None,\n        };\n        assert!(query.year.is_none());\n        assert!(query.month.is_none());\n        assert!(query.from.is_none());\n        assert!(query.to.is_none());\n    }\n\n    #[test]\n    fn test_attendance_query_with_values() {\n        let date = NaiveDate::from_ymd_opt(2024, 1, 15).unwrap();\n        let query = AttendanceQuery {\n            year: Some(2024),\n            month: Some(1),\n            from: Some(date),\n            to: Some(date),\n        };\n        assert_eq!(query.year, Some(2024));\n        assert_eq!(query.month, Some(1));\n        assert_eq!(query.from, Some(date));\n        assert_eq!(query.to, Some(date));\n    }\n\n    #[test]\n    fn test_attendance_export_query_default_values() {\n        let query = AttendanceExportQuery {\n            from: None,\n            to: None,\n        };\n        assert!(query.from.is_none());\n        assert!(query.to.is_none());\n    }\n\n    #[test]\n    fn test_attendance_status_response_structure() {\n        let response = AttendanceStatusResponse {\n            status: \"clocked_in\".to_string(),\n            attendance_id: Some(\"test-id\".to_string()),\n            active_break_id: None,\n            clock_in_time: None,\n            clock_out_time: None,\n        };\n        assert_eq!(response.status, \"clocked_in\");\n        assert!(response.attendance_id.is_some());\n        assert!(response.active_break_id.is_none());\n    }\n\n    #[test]\n    fn test_clock_in_request_structure() {\n        let date = NaiveDate::from_ymd_opt(2024, 1, 15);\n        let request = ClockInRequest { date };\n        assert_eq!(request.date, date);\n    }\n\n    #[test]\n    fn test_clock_out_request_structure() {\n        let date = NaiveDate::from_ymd_opt(2024, 1, 15);\n        let request = ClockOutRequest { date };\n        assert_eq!(request.date, date);\n    }\n\n    #[test]\n    fn test_attendance_summary_structure() {\n        let summary = AttendanceSummary {\n            month: 1,\n            year: 2024,\n            total_work_hours: 160.5,\n            total_work_days: 20,\n            average_daily_hours: 8.0,\n        };\n        assert_eq!(summary.month, 1);\n        assert_eq!(summary.year, 2024);\n        assert_eq!(summary.total_work_hours, 160.5);\n        assert_eq!(summary.total_work_days, 20);\n        assert_eq!(summary.average_daily_hours, 8.0);\n    }\n}\n","traces":[{"line":62,"address":[22984592],"length":1,"stats":{"Line":0},"fn_name":"clock_in"},{"line":68,"address":[19211532],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[19211546],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[19211564],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[19211757],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[19211795,19216261,19216256],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":74,"address":[19211850],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[19212575,19212070,19211879,19211611],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[19212444,19214046,19212610,19211632],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[19213217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[19214041,19213340,19213653],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[19213790],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[19213886],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[19214056,19213942,19214510,19211653],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[19214427],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[19213355],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[19213439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[19214520,19215037,19213535,19211674],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[19214894],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[19211695,19214459,19214977,19215047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[19215492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[19215714],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[22984864],"length":1,"stats":{"Line":0},"fn_name":"clock_out"},{"line":107,"address":[19221200],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[19221214],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[19221232],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[19221452],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[19227605,19227600,19221496],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":113,"address":[19221554],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[19221279,19222309,19221789,19221586],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[19221300,19224027,19222350,19222172],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[19223215,19223148,19224022,19222997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[19223183,19223125,19227616,19227630],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":122,"address":[19224017,19223523],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[19223686,19224012],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[19223856],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[19225177,19224188,19224476,19223960,19223871,19224298],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[19223881],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[19223945,19224040,19224444,19221321,19224284,19223993],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[19224745],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[19225036],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[19224912],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[19224778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[19225782,19221342,19224966,19224864,19225190],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[19225589],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[19225611],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[19226343,19221363,19225795,19225677],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[19221384,19226178,19226277,19226356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[19226810],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[19227035],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[22983424],"length":1,"stats":{"Line":0},"fn_name":"break_start"},{"line":154,"address":[19181531],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[19181549],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[19181679],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[19181713],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[19181742,19183183,19181590,19181898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[19183181,19182649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[19182840,19183157],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[19183010],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[19184321,19183438,19183616,19183328,19183022,19183108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[19183032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[19181605,19183584,19183424,19183096,19183138,19183196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[19183882],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[19184181,19184017],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[19183908],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[19184060,19185331,19184331,19181620],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[19184916],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[19185034],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[22984752],"length":1,"stats":{"Line":0},"fn_name":"break_end"},{"line":186,"address":[19216543],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[19216561],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[19216706],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[19216740],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[19216764],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[19216860,19217182,19216776,19217975,19217072,19217360],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[19216786],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[19216848,19217328,19216890,19217168,19216602,19216940],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[19217626],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[19217741,19217647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[19217914,19216617,19217690,19219148,19217988],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[19218739,19219143],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[19218930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[19216632,19219024,19219158,19220148],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[19220516,19219744],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[19220823,19216647,19219898,19220158],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[19219777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[19220526],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[22983664],"length":1,"stats":{"Line":0},"fn_name":"get_my_attendance"},{"line":219,"address":[19188086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":221,"address":[19188116],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[19188149,19188268,19188477,19188517,19188327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":223,"address":[19188443,19188355],"length":1,"stats":{"Line":0},"fn_name":null},{"line":224,"address":[19188569,19188479],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[19188449],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[19188303,19189700,19188725,19189253,19188813],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[19188776,19192725,19189577,19192720],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":229,"address":[19189584,19192704,19192709],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":230,"address":[19189625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":231,"address":[19189705,19189996],"length":1,"stats":{"Line":0},"fn_name":null},{"line":233,"address":[19189672],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[19188835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[19188850,19192752,19192757],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":237,"address":[19192736,19188913,19192741],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":238,"address":[19188975],"length":1,"stats":{"Line":0},"fn_name":null},{"line":239,"address":[19189083,19189425],"length":1,"stats":{"Line":0},"fn_name":null},{"line":241,"address":[19189184],"length":1,"stats":{"Line":0},"fn_name":null},{"line":242,"address":[19189060,19189138],"length":1,"stats":{"Line":0},"fn_name":null},{"line":243,"address":[19192812,19189163,19192800],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":245,"address":[19189258],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[19189239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[19188559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[19189952,19190469,19189866,19189754,19190308,19190354,19190991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[19189771,19189890],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[19190340,19189917,19190159,19188234,19189974,19190437],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[19190696,19192781,19190621,19192768],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":256,"address":[19188255,19190854,19190780,19191027],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[19191527],"length":1,"stats":{"Line":0},"fn_name":null},{"line":259,"address":[19191806,19191582,19191679],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[19191974,19192391],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[19192398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[19191999],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[22984016],"length":1,"stats":{"Line":0},"fn_name":"get_attendance_status"},{"line":272,"address":[19201720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[19201933],"length":1,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[19206544,19201881,19206553],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":276,"address":[19201904,19206528,19206533],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":278,"address":[19201940],"length":1,"stats":{"Line":0},"fn_name":null},{"line":279,"address":[19202002,19203441,19202088,19201955,19202444,19202318,19202639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":280,"address":[19201969,19202026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[19202053,19202110,19202607,19201792,19202163,19202430],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[19202730,19205041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[19202871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[19206465,19203636,19203047,19202927,19203746,19203924],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[19202941],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[19201813,19203482,19203732,19203892,19203080,19203032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[19206221,19204093],"length":1,"stats":{"Line":0},"fn_name":null},{"line":292,"address":[19204147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[19205929,19205863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[19204129,19204192,19205850],"length":1,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[19204230],"length":1,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[19205450,19205524],"length":1,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[19205590],"length":1,"stats":{"Line":0},"fn_name":null},{"line":304,"address":[19205618],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[19205437,19204198,19204271],"length":1,"stats":{"Line":0},"fn_name":null},{"line":307,"address":[19204367,19204431],"length":1,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[19204463],"length":1,"stats":{"Line":0},"fn_name":null},{"line":310,"address":[19204624,19204553],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[19204720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[19204390],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[19205054,19205128],"length":1,"stats":{"Line":0},"fn_name":null},{"line":320,"address":[19205194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":324,"address":[19204963],"length":1,"stats":{"Line":0},"fn_name":null},{"line":326,"address":[19203160],"length":1,"stats":{"Line":0},"fn_name":null},{"line":327,"address":[19202878],"length":1,"stats":{"Line":0},"fn_name":null},{"line":328,"address":[19203102],"length":1,"stats":{"Line":0},"fn_name":null},{"line":329,"address":[19203120],"length":1,"stats":{"Line":0},"fn_name":null},{"line":330,"address":[19203138],"length":1,"stats":{"Line":0},"fn_name":null},{"line":331,"address":[19203149],"length":1,"stats":{"Line":0},"fn_name":null},{"line":336,"address":[22984256],"length":1,"stats":{"Line":0},"fn_name":"get_breaks_by_attendance"},{"line":341,"address":[19208830,19208695,19208943,19208876,19209169],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[19208911,19211134,19211120,19208853],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":343,"address":[19209228,19209029,19208739,19210319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":344,"address":[19209980,19210314],"length":1,"stats":{"Line":0},"fn_name":null},{"line":345,"address":[19211069,19208754,19210335,19210171],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[19210731],"length":1,"stats":{"Line":0},"fn_name":null},{"line":349,"address":[22983536],"length":1,"stats":{"Line":0},"fn_name":"get_my_summary"},{"line":354,"address":[19185716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":356,"address":[19185731],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[19187744,19187749,19185853],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":358,"address":[19187680,19185925,19187685],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":360,"address":[19185997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":361,"address":[19186105,19186639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":363,"address":[19186188],"length":1,"stats":{"Line":0},"fn_name":null},{"line":364,"address":[19186085,19186154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":365,"address":[19186173,19187696,19187708],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":367,"address":[19186247,19186478],"length":1,"stats":{"Line":0},"fn_name":null},{"line":370,"address":[19186240],"length":1,"stats":{"Line":0},"fn_name":null},{"line":371,"address":[19186348,19187009,19187641,19186434,19186296,19186963,19187124],"length":1,"stats":{"Line":0},"fn_name":null},{"line":372,"address":[19186372,19186310],"length":1,"stats":{"Line":0},"fn_name":null},{"line":373,"address":[19186456,19186814,19186995,19186399,19187092,19185785],"length":1,"stats":{"Line":0},"fn_name":null},{"line":375,"address":[19187249],"length":1,"stats":{"Line":0},"fn_name":null},{"line":376,"address":[19187256,19187273],"length":1,"stats":{"Line":0},"fn_name":null},{"line":377,"address":[19187284],"length":1,"stats":{"Line":0},"fn_name":null},{"line":379,"address":[19187261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":390,"address":[19187378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":393,"address":[22983888],"length":1,"stats":{"Line":0},"fn_name":"export_my_attendance"},{"line":398,"address":[19195256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":399,"address":[19195263],"length":1,"stats":{"Line":0},"fn_name":null},{"line":401,"address":[19195393,19195270,19195356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":402,"address":[19195421,19195500],"length":1,"stats":{"Line":0},"fn_name":null},{"line":403,"address":[19195506],"length":1,"stats":{"Line":0},"fn_name":null},{"line":407,"address":[19195383],"length":1,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[19195707,19196251,19196090,19196136,19195881],"length":1,"stats":{"Line":0},"fn_name":null},{"line":409,"address":[19195721,19195799],"length":1,"stats":{"Line":0},"fn_name":null},{"line":410,"address":[19196122,19195849,19195900,19195950,19195343,19196219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":412,"address":[19196396],"length":1,"stats":{"Line":0},"fn_name":null},{"line":415,"address":[19196963],"length":1,"stats":{"Line":0},"fn_name":null},{"line":416,"address":[19196444],"length":1,"stats":{"Line":0},"fn_name":null},{"line":417,"address":[19196516],"length":1,"stats":{"Line":0},"fn_name":null},{"line":418,"address":[19196588],"length":1,"stats":{"Line":0},"fn_name":null},{"line":419,"address":[19196663],"length":1,"stats":{"Line":0},"fn_name":null},{"line":420,"address":[19196738],"length":1,"stats":{"Line":0},"fn_name":null},{"line":421,"address":[19196813],"length":1,"stats":{"Line":0},"fn_name":null},{"line":422,"address":[19196888],"length":1,"stats":{"Line":0},"fn_name":null},{"line":425,"address":[19200381,19197270,19197460],"length":1,"stats":{"Line":0},"fn_name":null},{"line":426,"address":[19199025,19197609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":427,"address":[19199033,19199105],"length":1,"stats":{"Line":0},"fn_name":null},{"line":428,"address":[19199113,19199210],"length":1,"stats":{"Line":0},"fn_name":null},{"line":429,"address":[19199318],"length":1,"stats":{"Line":0},"fn_name":null},{"line":431,"address":[19201152,19199364,19201168],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":433,"address":[19199438],"length":1,"stats":{"Line":0},"fn_name":null},{"line":435,"address":[19199484,19201024,19201008],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":437,"address":[19199575],"length":1,"stats":{"Line":0},"fn_name":null},{"line":439,"address":[19200880,19200900,19199600],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":440,"address":[19201296,19201308,19199656],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":441,"address":[19199694,19199767],"length":1,"stats":{"Line":0},"fn_name":null},{"line":445,"address":[19200026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":446,"address":[19199786],"length":1,"stats":{"Line":0},"fn_name":null},{"line":447,"address":[19199826],"length":1,"stats":{"Line":0},"fn_name":null},{"line":448,"address":[19199866],"length":1,"stats":{"Line":0},"fn_name":null},{"line":449,"address":[19199906],"length":1,"stats":{"Line":0},"fn_name":null},{"line":450,"address":[19199946],"length":1,"stats":{"Line":0},"fn_name":null},{"line":451,"address":[19199986],"length":1,"stats":{"Line":0},"fn_name":null},{"line":457,"address":[19198912,19197772,19197996,19198950,19198345,19197706,19197661,19198063,19198352],"length":1,"stats":{"Line":0},"fn_name":null},{"line":459,"address":[19198150],"length":1,"stats":{"Line":0},"fn_name":null},{"line":461,"address":[19198107,19198041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":466,"address":[22984384],"length":1,"stats":{"Line":0},"fn_name":"build_attendance_response"},{"line":471,"address":[22984390],"length":1,"stats":{"Line":0},"fn_name":null},{"line":472,"address":[22984408],"length":1,"stats":{"Line":0},"fn_name":null},{"line":473,"address":[22984426],"length":1,"stats":{"Line":0},"fn_name":null},{"line":474,"address":[22984430],"length":1,"stats":{"Line":0},"fn_name":null},{"line":475,"address":[22984447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":476,"address":[22984464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":477,"address":[22984468],"length":1,"stats":{"Line":0},"fn_name":null},{"line":482,"address":[22983840],"length":1,"stats":{"Line":0},"fn_name":"total_break_minutes"},{"line":486,"address":[19194428],"length":1,"stats":{"Line":0},"fn_name":null},{"line":487,"address":[19194668,19194529,19194462],"length":1,"stats":{"Line":0},"fn_name":null},{"line":490,"address":[22984144],"length":1,"stats":{"Line":0},"fn_name":"recalculate_total_hours"},{"line":495,"address":[19206935,19206985,19206814],"length":1,"stats":{"Line":0},"fn_name":null},{"line":496,"address":[19206964],"length":1,"stats":{"Line":0},"fn_name":null},{"line":499,"address":[19206991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":500,"address":[19207807,19207243,19207003,19206859],"length":1,"stats":{"Line":0},"fn_name":null},{"line":502,"address":[19207609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":503,"address":[19207625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":505,"address":[19207681],"length":1,"stats":{"Line":0},"fn_name":null},{"line":506,"address":[19208382,19206874,19207823,19207693],"length":1,"stats":{"Line":0},"fn_name":null},{"line":508,"address":[19208365],"length":1,"stats":{"Line":0},"fn_name":null},{"line":511,"address":[22983792],"length":1,"stats":{"Line":0},"fn_name":"reject_if_holiday"},{"line":516,"address":[19193673,19193454,19193251,19193191,19193513],"length":1,"stats":{"Line":0},"fn_name":null},{"line":517,"address":[19192994,19193195,19193104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":518,"address":[19193625,19193130,19193502,19193801,19193042,19193264,19194295,19193311,19193219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":520,"address":[19193816],"length":1,"stats":{"Line":0},"fn_name":null},{"line":521,"address":[19193957,19193840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":522,"address":[19193973],"length":1,"stats":{"Line":0},"fn_name":null},{"line":528,"address":[19193826],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":255},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","attendance_utils.rs"],"content":"use crate::models::break_record::BreakRecordResponse;\nuse crate::repositories::attendance::{AttendanceRepository, AttendanceRepositoryTrait};\nuse crate::repositories::break_record::BreakRecordRepository;\nuse crate::repositories::repository::Repository;\nuse crate::types::{AttendanceId, UserId};\nuse crate::{error::AppError, models::attendance::Attendance};\nuse chrono::NaiveDate;\nuse sqlx::PgPool;\nuse std::collections::HashMap;\n\npub fn ensure_authorized_access(attendance: \u0026Attendance, user_id: UserId) -\u003e Result\u003c(), AppError\u003e {\n    if attendance.user_id == user_id {\n        Ok(())\n    } else {\n        Err(AppError::Forbidden(\"Forbidden\".into()))\n    }\n}\n\npub fn ensure_not_clocked_in(attendance: \u0026Attendance) -\u003e Result\u003c(), AppError\u003e {\n    if attendance.clock_in_time.is_some() {\n        Err(AppError::BadRequest(\"Already clocked in today\".into()))\n    } else {\n        Ok(())\n    }\n}\n\npub fn ensure_not_clocked_out(attendance: \u0026Attendance) -\u003e Result\u003c(), AppError\u003e {\n    if attendance.is_clocked_out() {\n        Err(AppError::BadRequest(\"Already clocked out today\".into()))\n    } else {\n        Ok(())\n    }\n}\n\npub fn ensure_clock_in_exists(attendance: \u0026Attendance) -\u003e Result\u003c(), AppError\u003e {\n    if attendance.clock_in_time.is_none() {\n        Err(AppError::BadRequest(\n            \"Must clock in before clocking out\".into(),\n        ))\n    } else {\n        Ok(())\n    }\n}\n\npub fn ensure_clocked_in(attendance: \u0026Attendance) -\u003e Result\u003c(), AppError\u003e {\n    if attendance.is_clocked_in() {\n        Ok(())\n    } else {\n        Err(AppError::BadRequest(\n            \"Must be clocked in to start break\".into(),\n        ))\n    }\n}\n\npub async fn fetch_attendance_by_user_date(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    date: NaiveDate,\n) -\u003e Result\u003cOption\u003cAttendance\u003e, AppError\u003e {\n    let repo = AttendanceRepository::new();\n    repo.find_by_user_and_date(pool, user_id, date).await\n}\n\npub async fn fetch_attendance_by_id(\n    pool: \u0026PgPool,\n    attendance_id: AttendanceId,\n) -\u003e Result\u003cAttendance, AppError\u003e {\n    let repo = AttendanceRepository::new();\n    repo.find_by_id(pool, attendance_id).await\n}\n\npub async fn insert_attendance_record(\n    pool: \u0026PgPool,\n    attendance: \u0026Attendance,\n) -\u003e Result\u003c(), AppError\u003e {\n    let repo = AttendanceRepository::new();\n    repo.create(pool, attendance).await?;\n    Ok(())\n}\n\npub async fn update_clock_in(pool: \u0026PgPool, attendance: \u0026Attendance) -\u003e Result\u003c(), AppError\u003e {\n    let repo = AttendanceRepository::new();\n    repo.update(pool, attendance).await?;\n    Ok(())\n}\n\npub async fn update_clock_out(pool: \u0026PgPool, attendance: \u0026Attendance) -\u003e Result\u003c(), AppError\u003e {\n    let repo = AttendanceRepository::new();\n    repo.update(pool, attendance).await?;\n    Ok(())\n}\n\npub async fn get_break_records(\n    pool: \u0026PgPool,\n    attendance_id: AttendanceId,\n) -\u003e Result\u003cVec\u003cBreakRecordResponse\u003e, AppError\u003e {\n    let repo = BreakRecordRepository::new();\n    let break_records = repo.find_by_attendance(pool, attendance_id).await?;\n\n    Ok(break_records\n        .into_iter()\n        .map(BreakRecordResponse::from)\n        .collect())\n}\n\npub async fn get_break_records_map(\n    pool: \u0026PgPool,\n    attendance_ids: \u0026[AttendanceId],\n) -\u003e Result\u003cHashMap\u003cAttendanceId, Vec\u003cBreakRecordResponse\u003e\u003e, AppError\u003e {\n    if attendance_ids.is_empty() {\n        return Ok(HashMap::new());\n    }\n\n    let repo = BreakRecordRepository::new();\n    let break_records = repo.find_by_attendance_ids(pool, attendance_ids).await?;\n\n    let mut map = HashMap::new();\n    for rec in break_records {\n        let att_id = rec.attendance_id;\n        map.entry(att_id)\n            .or_insert_with(Vec::new)\n            .push(BreakRecordResponse::from(rec));\n    }\n    Ok(map)\n}\n","traces":[{"line":11,"address":[22489632],"length":1,"stats":{"Line":0},"fn_name":"ensure_authorized_access"},{"line":12,"address":[22489799,22489677],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[22489806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[22489690],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[22489024],"length":1,"stats":{"Line":0},"fn_name":"ensure_not_clocked_in"},{"line":20,"address":[22489054,22489079],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[22489081],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[22489072],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[22489424],"length":1,"stats":{"Line":0},"fn_name":"ensure_not_clocked_out"},{"line":28,"address":[22489454,22489475],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[22489477],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[22489468],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[22489248],"length":1,"stats":{"Line":0},"fn_name":"ensure_clock_in_exists"},{"line":36,"address":[22489278,22489303],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[22489340],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[22489305],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[22489296],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22488800],"length":1,"stats":{"Line":0},"fn_name":"ensure_clocked_in"},{"line":46,"address":[22488830,22488948],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[22488955],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[22488874],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[22488839],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[22489856],"length":1,"stats":{"Line":0},"fn_name":"fetch_attendance_by_user_date"},{"line":60,"address":[21947447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[20996724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[22489600],"length":1,"stats":{"Line":0},"fn_name":"fetch_attendance_by_id"},{"line":68,"address":[21945833],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[20991428],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[22489824],"length":1,"stats":{"Line":0},"fn_name":"insert_attendance_record"},{"line":76,"address":[21946481],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[21947310,21946515,21946584,21946706],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[21947224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[22488736,22488749],"length":1,"stats":{"Line":0},"fn_name":"update_clock_in"},{"line":82,"address":[21941057],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[20985044],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21941800],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[21941939,21941904,21942848,21942066,21942211,21942024],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":88,"address":[21942017],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[20986148],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21942760],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[22488976],"length":1,"stats":{"Line":0},"fn_name":"get_break_records"},{"line":97,"address":[21942980],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[21943014,21943258,21943081,21943172],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[21943666,21943810],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[21943716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[21943780],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[21943803],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[22489200],"length":1,"stats":{"Line":0},"fn_name":"get_break_records_map"},{"line":110,"address":[21944240,21944141],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[21944258,21944419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[21944246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[20990583],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[21944971],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21945019,21945119,21945246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[21945373],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21945389,21945675],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[21945524],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[21945536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[21945451],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":59},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","auth.rs"],"content":"use axum::{\n    extract::{Extension, State},\n    http::{header, header::USER_AGENT, HeaderMap},\n    Json,\n};\nuse chrono::{DateTime, Utc};\nuse serde_json::{json, Value};\nuse std::future::Future;\nuse std::str::FromStr;\nuse std::sync::Arc;\n\nuse crate::{\n    config::Config,\n    error::AppError,\n    middleware::request_id::RequestId,\n    models::{\n        active_session::ActiveSession,\n        password_reset::{RequestPasswordResetPayload, ResetPasswordPayload},\n        user::{\n            ChangePasswordRequest, LoginRequest, LoginResponse, MfaCodeRequest, MfaSetupResponse,\n            MfaStatusResponse, UpdateProfile, User, UserResponse,\n        },\n    },\n    repositories::{\n        active_session,\n        auth::{self as auth_repo, ActiveAccessToken},\n        password_reset as password_reset_repo, user as user_repo,\n    },\n    services::audit_log::{AuditLogEntry, AuditLogServiceTrait},\n    services::token_cache::TokenCacheServiceTrait,\n    state::AppState,\n    types::UserId,\n    utils::{\n        cookies::{\n            build_auth_cookie, build_clear_cookie, extract_cookie_value, CookieOptions,\n            ACCESS_COOKIE_NAME, ACCESS_COOKIE_PATH, REFRESH_COOKIE_NAME, REFRESH_COOKIE_PATH,\n        },\n        email::EmailService,\n        jwt::{\n            create_access_token, create_refresh_token, decode_refresh_token, hash_refresh_token,\n            verify_access_token, verify_refresh_token, Claims, RefreshToken,\n        },\n        mfa::{generate_otpauth_uri, generate_totp_secret, verify_totp_code},\n        password::{\n            hash_password, password_matches_any, validate_password_complexity, verify_password,\n        },\n        security::generate_token,\n    },\n    validation::Validate,\n};\n\npub type HandlerResult\u003cT\u003e = Result\u003cT, AppError\u003e;\n\n#[derive(Debug)]\npub struct AuthSession {\n    pub access_token: String,\n    pub refresh_token: String,\n    pub user: UserResponse,\n}\n\npub async fn login(\n    State(state): State\u003cAppState\u003e,\n    Extension(request_id): Extension\u003cRequestId\u003e,\n    Extension(audit_log_service): Extension\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    headers: HeaderMap,\n    Json(payload): Json\u003cLoginRequest\u003e,\n) -\u003e HandlerResult\u003cimpl axum::response::IntoResponse\u003e {\n    payload.validate()?;\n\n    let user = auth_repo::find_user_by_username(\u0026state.write_pool, \u0026payload.username)\n        .await\n        .map_err(|_| internal_error(\"Database error\"))?\n        .ok_or_else(|| unauthorized(\"Invalid username or password\"))?;\n\n    let audit_context = AuditContext::new(Some(user.id), \"user\", \u0026headers, Some(\u0026request_id));\n\n    let session = process_login_for_user(\n        user,\n        payload,\n        \u0026state.config,\n        {\n            let pool = state.write_pool.clone();\n            move |token| async move {\n                persist_refresh_token(\u0026pool, \u0026token, \"Failed to store refresh token\").await\n            }\n        },\n        {\n            let pool = state.write_pool.clone();\n            let cache = state.token_cache.clone();\n            move |claims, context| async move {\n                persist_active_access_token(\u0026pool, \u0026claims, context.clone()).await?;\n                if let Some(cache) = cache {\n                    let user_id = UserId::from_str(\u0026claims.sub)\n                        .map_err(|_| internal_error(\"Invalid user ID\"))?;\n                    let ttl = (claims.exp - Utc::now().timestamp()).max(0) as u64;\n                    let _ = cache.cache_token(\u0026claims.jti, user_id, ttl).await;\n                }\n                Ok(())\n            }\n        },\n        {\n            let pool = state.write_pool.clone();\n            let cache = state.token_cache.clone();\n            let config = state.config.clone();\n            let audit_log_service = audit_log_service.clone();\n            let audit_context = audit_context.clone();\n            move |user_id, refresh_token, claims, device_label| async move {\n                register_active_session(\n                    \u0026pool,\n                    cache.as_ref(),\n                    Some(audit_log_service.clone()),\n                    audit_context.clone(),\n                    \u0026config,\n                    user_id,\n                    refresh_token,\n                    claims,\n                    device_label,\n                    \"login\",\n                )\n                .await\n            }\n        },\n    )\n    .await?;\n\n    let mut headers = HeaderMap::new();\n    set_auth_cookies(\u0026mut headers, \u0026session, \u0026state.config);\n    Ok((headers, Json(LoginResponse { user: session.user })))\n}\n\npub async fn refresh(\n    State(state): State\u003cAppState\u003e,\n    Extension(request_id): Extension\u003cRequestId\u003e,\n    Extension(audit_log_service): Extension\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    headers: HeaderMap,\n    Json(payload): Json\u003cserde_json::Value\u003e,\n) -\u003e HandlerResult\u003cimpl axum::response::IntoResponse\u003e {\n    let cookie_header = cookie_header_value(\u0026headers);\n    let refresh_token_str =\n        extract_cookie_value(cookie_header.unwrap_or_default(), REFRESH_COOKIE_NAME)\n            .or_else(|| {\n                payload\n                    .get(\"refresh_token\")\n                    .and_then(|v| v.as_str())\n                    .map(|v| v.to_string())\n            })\n            .ok_or_else(|| bad_request(\"Refresh token is required\"))?;\n\n    let (token_id, secret) = decode_refresh_token(\u0026refresh_token_str)\n        .map_err(|_| unauthorized(\"Invalid refresh token format\"))?;\n\n    let stored = auth_repo::fetch_valid_refresh_token(\u0026state.write_pool, \u0026token_id, Utc::now())\n        .await\n        .map_err(|_| internal_error(\"Database error\"))?\n        .ok_or_else(|| unauthorized(\"Invalid or expired refresh token\"))?;\n\n    if !verify_refresh_token(\u0026secret, \u0026stored.token_hash)\n        .map_err(|_| internal_error(\"Verification error\"))?\n    {\n        return Err(unauthorized(\"Invalid refresh token secret\"));\n    }\n\n    let user = auth_repo::find_user_by_id(\u0026state.write_pool, stored.user_id)\n        .await\n        .map_err(|_| internal_error(\"Database error\"))?\n        .ok_or_else(|| unauthorized(\"User not found\"))?;\n\n    enforce_password_expiration(\u0026user, \u0026state.config)?;\n\n    let audit_context = AuditContext::new(Some(user.id), \"user\", \u0026headers, Some(\u0026request_id));\n\n    let session = create_auth_session(\u0026user, \u0026state.config).await?;\n\n    let rt_data = session.refresh_token_data(state.config.refresh_token_expiration_days)?;\n    let claims = session.access_claims(\u0026state.config.jwt_secret)?;\n    let previous_session =\n        active_session::find_active_session_by_refresh_token_id(\u0026state.write_pool, \u0026stored.id)\n            .await\n            .map_err(|_| internal_error(\"Failed to fetch active session\"))?;\n    let previous_device_label = previous_session\n        .as_ref()\n        .and_then(|session| session.device_label.clone());\n    let previous_access_jti = previous_session\n        .as_ref()\n        .and_then(|session| session.access_jti.clone());\n    persist_refresh_token(\n        \u0026state.write_pool,\n        \u0026rt_data,\n        \"Failed to store new refresh token\",\n    )\n    .await?;\n\n    persist_active_access_token(\n        \u0026state.write_pool,\n        \u0026claims,\n        Some(format!(\"refresh_{}\", stored.id)),\n    )\n    .await?;\n\n    let updated = active_session::update_active_session_tokens(\n        \u0026state.write_pool,\n        \u0026stored.id,\n        \u0026rt_data.id,\n        \u0026claims.jti,\n        Utc::now(),\n        rt_data.expires_at,\n    )\n    .await\n    .map_err(|_| internal_error(\"Failed to update active session\"))?;\n\n    if !updated {\n        register_active_session(\n            \u0026state.write_pool,\n            state.token_cache.as_ref(),\n            Some(audit_log_service.clone()),\n            audit_context.clone(),\n            \u0026state.config,\n            user.id,\n            rt_data.clone(),\n            claims.clone(),\n            previous_device_label,\n            \"refresh\",\n        )\n        .await?;\n    }\n\n    if let Some(access_jti) = previous_access_jti.as_deref() {\n        auth_repo::delete_active_access_token_by_jti(\u0026state.write_pool, access_jti)\n            .await\n            .map_err(|_| internal_error(\"Failed to revoke previous access token\"))?;\n        if let Some(cache) = \u0026state.token_cache {\n            let _ = cache.invalidate_token(access_jti).await;\n        }\n    }\n\n    auth_repo::delete_refresh_token_by_id(\u0026state.write_pool, \u0026stored.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke old refresh token\"))?;\n\n    if let Some(cache) = \u0026state.token_cache {\n        let user_id =\n            UserId::from_str(\u0026claims.sub).map_err(|_| internal_error(\"Invalid user ID\"))?;\n        let ttl = (claims.exp - Utc::now().timestamp()).max(0) as u64;\n        let _ = cache.cache_token(\u0026claims.jti, user_id, ttl).await;\n    }\n\n    let mut headers = HeaderMap::new();\n    set_auth_cookies(\u0026mut headers, \u0026session, \u0026state.config);\n    Ok((headers, Json(LoginResponse { user: session.user })))\n}\n\npub async fn logout(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(claims): Extension\u003cClaims\u003e,\n    Extension(request_id): Extension\u003cRequestId\u003e,\n    Extension(audit_log_service): Extension\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    headers: HeaderMap,\n    Json(payload): Json\u003cserde_json::Value\u003e,\n) -\u003e HandlerResult\u003cimpl axum::response::IntoResponse\u003e {\n    let all = payload\n        .get(\"all\")\n        .and_then(|v| v.as_bool())\n        .unwrap_or(false);\n    if all {\n        let sessions = active_session::list_active_sessions_for_user(\u0026state.write_pool, user.id)\n            .await\n            .map_err(|_| internal_error(\"Failed to list active sessions\"))?;\n        auth_repo::delete_refresh_tokens_for_user(\u0026state.write_pool, user.id)\n            .await\n            .map_err(|_| internal_error(\"Failed to revoke tokens\"))?;\n        auth_repo::delete_active_access_tokens_for_user(\u0026state.write_pool, user.id)\n            .await\n            .map_err(|_| internal_error(\"Failed to revoke access tokens\"))?;\n        active_session::delete_active_sessions_for_user(\u0026state.write_pool, user.id)\n            .await\n            .map_err(|_| internal_error(\"Failed to revoke active sessions\"))?;\n\n        if let Some(cache) = \u0026state.token_cache {\n            let _ = cache.invalidate_user_tokens(user.id).await;\n        }\n        let audit_context = AuditContext::new(Some(user.id), \"user\", \u0026headers, Some(\u0026request_id));\n        for session in sessions {\n            record_session_audit_event(\n                Some(audit_log_service.clone()),\n                audit_context.clone(),\n                \"session_destroy\",\n                Some(session.id),\n                Some(json!({ \"reason\": \"logout_all\" })),\n            );\n        }\n        let mut response_headers = HeaderMap::new();\n        clear_auth_cookies(\u0026mut response_headers, \u0026state.config);\n        return Ok((\n            response_headers,\n            Json(json!({\"message\":\"Logged out from all devices\"})),\n        ));\n    }\n\n    if let Some(rt_str) = payload\n        .get(\"refresh_token\")\n        .and_then(|v| v.as_str())\n        .map(|v| v.to_string())\n        .or_else(|| {\n            cookie_header_value(\u0026headers)\n                .and_then(|value| extract_cookie_value(value, REFRESH_COOKIE_NAME))\n        })\n    {\n        if let Ok((token_id, _)) = decode_refresh_token(\u0026rt_str) {\n            auth_repo::delete_refresh_token_by_id(\u0026state.write_pool, \u0026token_id)\n                .await\n                .map_err(|_| internal_error(\"Failed to revoke token\"))?;\n        }\n    }\n\n    let session = active_session::find_active_session_by_access_jti(\u0026state.write_pool, \u0026claims.jti)\n        .await\n        .map_err(|_| internal_error(\"Failed to fetch active session\"))?;\n\n    auth_repo::delete_active_access_token_by_jti(\u0026state.write_pool, \u0026claims.jti)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke access token\"))?;\n\n    active_session::delete_active_session_by_access_jti(\u0026state.write_pool, \u0026claims.jti)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke active session\"))?;\n\n    if let Some(cache) = \u0026state.token_cache {\n        let _ = cache.invalidate_token(\u0026claims.jti).await;\n    }\n    if let Some(session) = session {\n        let audit_context = AuditContext::new(Some(user.id), \"user\", \u0026headers, Some(\u0026request_id));\n        record_session_audit_event(\n            Some(audit_log_service.clone()),\n            audit_context,\n            \"session_destroy\",\n            Some(session.id),\n            Some(json!({ \"reason\": \"logout\" })),\n        );\n    }\n    let mut response_headers = HeaderMap::new();\n    clear_auth_cookies(\u0026mut response_headers, \u0026state.config);\n    Ok((response_headers, Json(json!({\"message\":\"Logged out\"}))))\n}\n\npub async fn me(Extension(user): Extension\u003cUser\u003e) -\u003e HandlerResult\u003cJson\u003cUserResponse\u003e\u003e {\n    Ok(Json(UserResponse::from(user)))\n}\n\npub async fn mfa_status(\n    Extension(user): Extension\u003cUser\u003e,\n) -\u003e HandlerResult\u003cJson\u003cMfaStatusResponse\u003e\u003e {\n    Ok(Json(MfaStatusResponse {\n        enabled: user.is_mfa_enabled(),\n        pending: user.has_pending_mfa(),\n    }))\n}\n\npub async fn update_profile(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cUpdateProfile\u003e,\n) -\u003e HandlerResult\u003cJson\u003cUserResponse\u003e\u003e {\n    payload.validate()?;\n\n    if let Some(ref email) = payload.email {\n        let email_exists =\n            user_repo::email_exists_for_other_user(\u0026state.write_pool, email, \u0026user.id.to_string())\n                .await\n                .map_err(|_| internal_error(\"Database error\"))?;\n\n        if email_exists {\n            return Err(bad_request(\"Email already in use\"));\n        }\n    }\n\n    let full_name = payload.full_name.unwrap_or(user.full_name);\n    let email = payload.email.unwrap_or(user.email);\n\n    let updated_user =\n        user_repo::update_profile(\u0026state.write_pool, \u0026user.id.to_string(), \u0026full_name, \u0026email)\n            .await\n            .map_err(|_| internal_error(\"Failed to update profile\"))?;\n\n    Ok(Json(UserResponse::from(updated_user)))\n}\n\npub async fn mfa_register(\n    State(state): State\u003cAppState\u003e,\n    headers: HeaderMap,\n    Extension(user): Extension\u003cUser\u003e,\n) -\u003e HandlerResult\u003cJson\u003cMfaSetupResponse\u003e\u003e {\n    crate::utils::security::verify_request_origin(\u0026headers, \u0026state.config)?;\n    let response = begin_mfa_enrollment(\u0026state.write_pool, \u0026state.config, \u0026user).await?;\n    Ok(Json(response))\n}\n\npub async fn mfa_setup(\n    State(state): State\u003cAppState\u003e,\n    headers: HeaderMap,\n    Extension(user): Extension\u003cUser\u003e,\n) -\u003e HandlerResult\u003cJson\u003cMfaSetupResponse\u003e\u003e {\n    crate::utils::security::verify_request_origin(\u0026headers, \u0026state.config)?;\n    let response = begin_mfa_enrollment(\u0026state.write_pool, \u0026state.config, \u0026user).await?;\n    Ok(Json(response))\n}\n\npub async fn mfa_activate(\n    State(state): State\u003cAppState\u003e,\n    headers: HeaderMap,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cMfaCodeRequest\u003e,\n) -\u003e HandlerResult\u003cJson\u003cValue\u003e\u003e {\n    crate::utils::security::verify_request_origin(\u0026headers, \u0026state.config)?;\n    let secret = user\n        .mfa_secret\n        .as_ref()\n        .ok_or_else(|| bad_request(\"MFA setup not initiated\"))?;\n\n    let code = payload.code.trim().to_string();\n    if !verify_totp_code(secret, \u0026code).map_err(|_| internal_error(\"MFA verification error\"))? {\n        return Err(unauthorized(\"Invalid MFA code\"));\n    }\n\n    let now = Utc::now();\n    if !user_repo::enable_mfa(\u0026state.write_pool, \u0026user.id.to_string(), now)\n        .await\n        .map_err(|_| internal_error(\"Failed to enable MFA\"))?\n    {\n        return Err(internal_error(\"Failed to enable MFA\"));\n    }\n\n    auth_repo::delete_refresh_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke refresh tokens\"))?;\n    auth_repo::delete_active_access_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke access tokens\"))?;\n\n    if let Some(cache) = \u0026state.token_cache {\n        let _ = cache.invalidate_user_tokens(user.id).await;\n    }\n\n    Ok(Json(json!({\"message\": \"MFA enabled\"})))\n}\n\npub async fn mfa_disable(\n    State(state): State\u003cAppState\u003e,\n    headers: HeaderMap,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cMfaCodeRequest\u003e,\n) -\u003e HandlerResult\u003cJson\u003cValue\u003e\u003e {\n    crate::utils::security::verify_request_origin(\u0026headers, \u0026state.config)?;\n    if !user.is_mfa_enabled() {\n        return Err(bad_request(\"MFA is not enabled\"));\n    }\n\n    let secret = user\n        .mfa_secret\n        .as_ref()\n        .ok_or_else(|| internal_error(\"MFA secret missing\"))?;\n\n    let code = payload.code.trim().to_string();\n    if !verify_totp_code(secret, \u0026code).map_err(|_| internal_error(\"MFA verification error\"))? {\n        return Err(unauthorized(\"Invalid MFA code\"));\n    }\n\n    if !user_repo::disable_mfa(\u0026state.write_pool, \u0026user.id.to_string())\n        .await\n        .map_err(|_| internal_error(\"Failed to disable MFA\"))?\n    {\n        return Err(internal_error(\"Failed to disable MFA\"));\n    }\n\n    auth_repo::delete_refresh_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke refresh tokens\"))?;\n    auth_repo::delete_active_access_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke access tokens\"))?;\n\n    if let Some(cache) = \u0026state.token_cache {\n        let _ = cache.invalidate_user_tokens(user.id).await;\n    }\n\n    Ok(Json(json!({\"message\": \"MFA disabled\"})))\n}\n\npub async fn change_password(\n    State(state): State\u003cAppState\u003e,\n    headers: HeaderMap,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cChangePasswordRequest\u003e,\n) -\u003e HandlerResult\u003cJson\u003cValue\u003e\u003e {\n    crate::utils::security::verify_request_origin(\u0026headers, \u0026state.config)?;\n    payload.validate()?;\n    validate_password_complexity(\u0026payload.new_password, \u0026state.config)\n        .map_err(|e| bad_request(e.to_string()))?;\n    if payload.new_password == payload.current_password {\n        return Err(bad_request(\n            \"New password must differ from current password\",\n        ));\n    }\n\n    ensure_password_matches(\n        \u0026payload.current_password,\n        \u0026user.password_hash,\n        \"Current password is incorrect\",\n    )\n    .await?;\n\n    ensure_password_not_reused(\n        \u0026state.write_pool,\n        user.id,\n        \u0026payload.new_password,\n        \u0026user.password_hash,\n        state.config.password_history_count,\n    )\n    .await?;\n\n    let new_hash = tokio::task::spawn_blocking({\n        let password = payload.new_password.clone();\n        move || hash_password(\u0026password)\n    })\n    .await\n    .map_err(|_| internal_error(\"Hashing task failed\"))?\n    .map_err(|_| internal_error(\"Failed to hash password\"))?;\n\n    auth_repo::update_user_password(\n        \u0026state.write_pool,\n        user.id,\n        \u0026new_hash,\n        \u0026user.password_hash,\n        state.config.password_history_count,\n    )\n    .await\n    .map_err(|_| internal_error(\"Failed to update password\"))?;\n\n    auth_repo::delete_refresh_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke sessions after password change\"))?;\n    auth_repo::delete_active_access_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke access tokens\"))?;\n\n    if let Some(cache) = \u0026state.token_cache {\n        let _ = cache.invalidate_user_tokens(user.id).await;\n    }\n\n    Ok(Json(json!({\"message\": \"Password changed successfully\"})))\n}\n\npub async fn request_password_reset(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRequestPasswordResetPayload\u003e,\n) -\u003e HandlerResult\u003cimpl axum::response::IntoResponse\u003e {\n    payload.validate()?;\n\n    let user_opt = auth_repo::find_user_by_email(\u0026state.write_pool, \u0026payload.email)\n        .await\n        .map_err(|_| internal_error(\"Database error\"))?;\n\n    if let Some(user) = user_opt {\n        let token = generate_token(32);\n        password_reset_repo::create_password_reset(\u0026state.write_pool, user.id, \u0026token)\n            .await\n            .map_err(|_| internal_error(\"Failed to create password reset\"))?;\n\n        let email_service =\n            EmailService::new().map_err(|_| internal_error(\"Email service error\"))?;\n        if let Err(e) = email_service.send_password_reset_email(\u0026user.email, \u0026token) {\n            tracing::error!(\"Failed to send password reset email: {:?}\", e);\n        }\n    }\n\n    Ok(Json(json!({\n        \"message\": \"If the email exists, a password reset link has been sent\"\n    })))\n}\n\npub async fn reset_password(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cResetPasswordPayload\u003e,\n) -\u003e HandlerResult\u003cimpl axum::response::IntoResponse\u003e {\n    payload.validate()?;\n    validate_password_complexity(\u0026payload.new_password, \u0026state.config)\n        .map_err(|e| bad_request(e.to_string()))?;\n\n    let reset_record =\n        password_reset_repo::find_valid_reset_by_token(\u0026state.write_pool, \u0026payload.token)\n            .await\n            .map_err(|_| internal_error(\"Database error\"))?\n            .ok_or_else(|| bad_request(\"Invalid or expired reset token\"))?;\n\n    let user = auth_repo::find_user_by_id(\u0026state.write_pool, reset_record.user_id)\n        .await\n        .map_err(|_| internal_error(\"Database error\"))?\n        .ok_or_else(|| bad_request(\"User not found\"))?;\n\n    ensure_password_not_reused(\n        \u0026state.write_pool,\n        user.id,\n        \u0026payload.new_password,\n        \u0026user.password_hash,\n        state.config.password_history_count,\n    )\n    .await?;\n\n    let new_password_hash = tokio::task::spawn_blocking({\n        let password = payload.new_password.clone();\n        move || hash_password(\u0026password)\n    })\n    .await\n    .map_err(|_| internal_error(\"Task join error\"))?\n    .map_err(|_| internal_error(\"Failed to hash password\"))?;\n\n    let user = auth_repo::update_user_password(\n        \u0026state.write_pool,\n        user.id,\n        \u0026new_password_hash,\n        \u0026user.password_hash,\n        state.config.password_history_count,\n    )\n    .await\n    .map_err(|_| internal_error(\"Failed to update password\"))?;\n\n    password_reset_repo::mark_token_as_used(\u0026state.write_pool, \u0026reset_record.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to mark token as used\"))?;\n\n    auth_repo::delete_all_refresh_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke refresh tokens\"))?;\n\n    auth_repo::delete_active_access_tokens_for_user(\u0026state.write_pool, user.id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke access tokens\"))?;\n\n    if let Some(cache) = \u0026state.token_cache {\n        let _ = cache.invalidate_user_tokens(user.id).await;\n    }\n\n    let email_service = EmailService::new().map_err(|_| internal_error(\"Email service error\"))?;\n    if let Err(e) = email_service.send_password_changed_notification(\u0026user.email, \u0026user.username) {\n        tracing::error!(\"Failed to send password changed notification: {:?}\", e);\n    }\n\n    Ok(Json(json!({\n        \"message\": \"Password has been reset successfully\"\n    })))\n}\n\n// Helper methods\n\nasync fn create_auth_session(user: \u0026User, config: \u0026Config) -\u003e HandlerResult\u003cAuthSession\u003e {\n    let (access_token, _) = create_access_token(\n        user.id.to_string(),\n        user.username.clone(),\n        user.role.as_str().to_string(),\n        \u0026config.jwt_secret,\n        config.jwt_expiration_hours,\n    )\n    .map_err(|_| internal_error(\"Failed to create access token\"))?;\n\n    let refresh_token =\n        create_refresh_token(user.id.to_string(), config.refresh_token_expiration_days)\n            .map_err(|_| internal_error(\"Failed to create refresh token\"))?\n            .encoded();\n\n    Ok(AuthSession {\n        access_token,\n        refresh_token,\n        user: UserResponse::from(user.clone()),\n    })\n}\n\nasync fn begin_mfa_enrollment(\n    pool: \u0026sqlx::PgPool,\n    config: \u0026Config,\n    user: \u0026User,\n) -\u003e HandlerResult\u003cMfaSetupResponse\u003e {\n    if user.is_mfa_enabled() {\n        return Err(bad_request(\"MFA already enabled\"));\n    }\n\n    let secret = generate_totp_secret();\n    let otpauth_url = generate_otpauth_uri(\u0026config.mfa_issuer, \u0026user.username, \u0026secret)\n        .map_err(|_| internal_error(\"Failed to issue MFA secret\"))?;\n\n    if !user_repo::set_mfa_secret(pool, \u0026user.id.to_string(), \u0026secret, Utc::now())\n        .await\n        .map_err(|_| internal_error(\"Failed to persist MFA secret\"))?\n    {\n        return Err(internal_error(\"Failed to persist MFA secret\"));\n    }\n\n    Ok(MfaSetupResponse {\n        secret,\n        otpauth_url,\n    })\n}\n\npub async fn process_login_for_user\u003cPF, AF, SF, PFut, AFut, SFut\u003e(\n    user: User,\n    payload: LoginRequest,\n    config: \u0026Config,\n    persist_refresh_token: PF,\n    persist_active_access_token: AF,\n    persist_active_session: SF,\n) -\u003e HandlerResult\u003cAuthSession\u003e\nwhere\n    PF: FnOnce(RefreshToken) -\u003e PFut,\n    PFut: Future\u003cOutput = HandlerResult\u003c()\u003e\u003e,\n    AF: FnOnce(Claims, Option\u003cString\u003e) -\u003e AFut,\n    AFut: Future\u003cOutput = HandlerResult\u003c()\u003e\u003e,\n    SF: FnOnce(UserId, RefreshToken, Claims, Option\u003cString\u003e) -\u003e SFut,\n    SFut: Future\u003cOutput = HandlerResult\u003c()\u003e\u003e,\n{\n    ensure_password_matches(\n        \u0026payload.password,\n        \u0026user.password_hash,\n        \"Invalid username or password\",\n    )\n    .await?;\n    enforce_mfa(\u0026user, payload.totp_code.as_deref())?;\n    enforce_password_expiration(\u0026user, config)?;\n\n    let (access_token, claims) = create_access_token(\n        user.id.to_string(),\n        user.username.clone(),\n        user.role.as_str().to_string(),\n        \u0026config.jwt_secret,\n        config.jwt_expiration_hours,\n    )\n    .map_err(|_| internal_error(\"Token creation error\"))?;\n\n    let refresh_token_data =\n        create_refresh_token(user.id.to_string(), config.refresh_token_expiration_days)\n            .map_err(|_| internal_error(\"Refresh token creation error\"))?;\n    let refresh_token = refresh_token_data.encoded();\n\n    persist_refresh_token(refresh_token_data.clone()).await?;\n    let context = payload\n        .device_label\n        .clone()\n        .map(|label| label.trim().to_string());\n    persist_active_access_token(claims.clone(), context.clone()).await?;\n    persist_active_session(user.id, refresh_token_data, claims, context).await?;\n\n    let response = AuthSession {\n        access_token,\n        refresh_token,\n        user: UserResponse::from(user),\n    };\n\n    Ok(response)\n}\n\nasync fn persist_refresh_token(\n    pool: \u0026sqlx::PgPool,\n    token: \u0026RefreshToken,\n    error_message: \u0026'static str,\n) -\u003e HandlerResult\u003c()\u003e {\n    auth_repo::insert_refresh_token(pool, token)\n        .await\n        .map_err(|_| internal_error(error_message))\n}\n\nfn sanitize_device_label(label: Option\u003cString\u003e) -\u003e Option\u003cString\u003e {\n    label.and_then(|value| {\n        let trimmed = value.trim();\n        if trimmed.is_empty() {\n            None\n        } else {\n            Some(trimmed.chars().take(128).collect::\u003cString\u003e())\n        }\n    })\n}\n\nasync fn persist_active_access_token(\n    pool: \u0026sqlx::PgPool,\n    claims: \u0026Claims,\n    context: Option\u003cString\u003e,\n) -\u003e HandlerResult\u003c()\u003e {\n    let expires_at = DateTime::\u003cUtc\u003e::from_timestamp(claims.exp, 0)\n        .ok_or_else(|| internal_error(\"Token expiration overflow\"))?;\n\n    auth_repo::cleanup_expired_access_tokens(pool)\n        .await\n        .map_err(|_| internal_error(\"Failed to cleanup expired tokens\"))?;\n\n    let sanitized_context = sanitize_device_label(context);\n    let user_id =\n        UserId::from_str(\u0026claims.sub).map_err(|_| internal_error(\"Invalid user ID in claims\"))?;\n    let token = ActiveAccessToken {\n        jti: \u0026claims.jti,\n        user_id,\n        expires_at,\n        context: sanitized_context.as_deref(),\n    };\n    auth_repo::insert_active_access_token(pool, \u0026token)\n        .await\n        .map_err(|_| internal_error(\"Failed to register access token\"))\n}\n\nasync fn register_active_session(\n    pool: \u0026sqlx::PgPool,\n    token_cache: Option\u003c\u0026Arc\u003cdyn TokenCacheServiceTrait\u003e\u003e,\n    audit_log_service: Option\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    audit_context: AuditContext,\n    config: \u0026Config,\n    user_id: UserId,\n    refresh_token: RefreshToken,\n    claims: Claims,\n    device_label: Option\u003cString\u003e,\n    source: \u0026'static str,\n) -\u003e HandlerResult\u003c()\u003e {\n    let device_label = sanitize_device_label(device_label);\n    let session = active_session::create_active_session(\n        pool,\n        user_id,\n        \u0026refresh_token.id,\n        \u0026claims.jti,\n        device_label.as_deref(),\n        refresh_token.expires_at,\n    )\n    .await\n    .map_err(|_| internal_error(\"Failed to create active session\"))?;\n\n    record_session_audit_event(\n        audit_log_service.clone(),\n        audit_context.clone(),\n        \"session_create\",\n        Some(session.id),\n        Some(json!({\n            \"source\": source,\n            \"device_label\": device_label\n        })),\n    );\n\n    enforce_session_limit(\n        pool,\n        token_cache,\n        audit_log_service,\n        audit_context,\n        config,\n        user_id,\n    )\n    .await?;\n    Ok(())\n}\n\nasync fn enforce_session_limit(\n    pool: \u0026sqlx::PgPool,\n    token_cache: Option\u003c\u0026Arc\u003cdyn TokenCacheServiceTrait\u003e\u003e,\n    audit_log_service: Option\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    audit_context: AuditContext,\n    config: \u0026Config,\n    user_id: UserId,\n) -\u003e HandlerResult\u003c()\u003e {\n    let limit = config.max_concurrent_sessions as usize;\n    if limit == 0 {\n        return Ok(());\n    }\n\n    let sessions = active_session::list_active_sessions_for_user(pool, user_id)\n        .await\n        .map_err(|_| internal_error(\"Failed to list active sessions\"))?;\n\n    if sessions.len() \u003c= limit {\n        return Ok(());\n    }\n\n    for session in sessions.iter().skip(limit) {\n        revoke_active_session(pool, token_cache, session).await?;\n        record_session_audit_event(\n            audit_log_service.clone(),\n            audit_context.clone(),\n            \"session_destroy\",\n            Some(session.id.clone()),\n            Some(json!({\n                \"reason\": \"max_concurrent_sessions\",\n                \"limit\": config.max_concurrent_sessions\n            })),\n        );\n    }\n\n    Ok(())\n}\n\nasync fn revoke_active_session(\n    pool: \u0026sqlx::PgPool,\n    token_cache: Option\u003c\u0026Arc\u003cdyn TokenCacheServiceTrait\u003e\u003e,\n    session: \u0026ActiveSession,\n) -\u003e HandlerResult\u003c()\u003e {\n    if let Some(access_jti) = session.access_jti.as_deref() {\n        auth_repo::delete_active_access_token_by_jti(pool, access_jti)\n            .await\n            .map_err(|_| internal_error(\"Failed to revoke access token\"))?;\n        if let Some(cache) = token_cache {\n            let _ = cache.invalidate_token(access_jti).await;\n        }\n    }\n\n    auth_repo::delete_refresh_token_by_id(pool, \u0026session.refresh_token_id)\n        .await\n        .map_err(|_| internal_error(\"Failed to revoke refresh token\"))?;\n\n    Ok(())\n}\n\n#[derive(Clone)]\nstruct AuditContext {\n    actor_id: Option\u003cUserId\u003e,\n    actor_type: String,\n    ip: Option\u003cString\u003e,\n    user_agent: Option\u003cString\u003e,\n    request_id: Option\u003cString\u003e,\n}\n\nimpl AuditContext {\n    fn new(\n        actor_id: Option\u003cUserId\u003e,\n        actor_type: \u0026str,\n        headers: \u0026HeaderMap,\n        request_id: Option\u003c\u0026RequestId\u003e,\n    ) -\u003e Self {\n        Self {\n            actor_id,\n            actor_type: actor_type.to_string(),\n            ip: extract_ip(headers),\n            user_agent: extract_user_agent(headers),\n            request_id: request_id.map(|id| id.0.clone()),\n        }\n    }\n}\n\nfn record_session_audit_event(\n    audit_log_service: Option\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    context: AuditContext,\n    event_type: \u0026'static str,\n    session_id: Option\u003cString\u003e,\n    metadata: Option\u003cValue\u003e,\n) {\n    let Some(audit_log_service) = audit_log_service else {\n        return;\n    };\n    let entry = AuditLogEntry {\n        occurred_at: Utc::now(),\n        actor_id: context.actor_id,\n        actor_type: context.actor_type,\n        event_type: event_type.to_string(),\n        target_type: Some(\"session\".to_string()),\n        target_id: session_id,\n        result: \"success\".to_string(),\n        error_code: None,\n        metadata,\n        ip: context.ip,\n        user_agent: context.user_agent,\n        request_id: context.request_id,\n    };\n\n    tokio::spawn(async move {\n        if let Err(err) = audit_log_service.record_event(entry).await {\n            tracing::warn!(\n                error = ?err,\n                event_type = %event_type,\n                \"Failed to record session audit log\"\n            );\n        }\n    });\n}\n\nfn extract_ip(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    if let Some(value) = headers.get(\"x-forwarded-for\").and_then(|v| v.to_str().ok()) {\n        return value\n            .split(',')\n            .next()\n            .map(|ip| ip.trim().to_string())\n            .filter(|ip| !ip.is_empty());\n    }\n    headers\n        .get(\"x-real-ip\")\n        .and_then(|v| v.to_str().ok())\n        .map(|ip| ip.trim().to_string())\n        .filter(|ip| !ip.is_empty())\n}\n\nfn extract_user_agent(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    headers\n        .get(USER_AGENT)\n        .and_then(|v| v.to_str().ok())\n        .map(|agent| agent.trim().to_string())\n        .filter(|agent| !agent.is_empty())\n}\n\nimpl AuthSession {\n    pub fn access_claims(\u0026self, secret: \u0026str) -\u003e HandlerResult\u003cClaims\u003e {\n        verify_access_token(\u0026self.access_token, secret)\n            .map_err(|_| internal_error(\"Failed to decode access token\"))\n    }\n\n    pub fn refresh_token_data(\u0026self, expiration_days: u64) -\u003e HandlerResult\u003cRefreshToken\u003e {\n        let (token_id, secret) = decode_refresh_token(\u0026self.refresh_token)\n            .map_err(|_| internal_error(\"Invalid refresh token format\"))?;\n        let token_hash = hash_refresh_token(\u0026secret)\n            .map_err(|_| internal_error(\"Failed to hash refresh token\"))?;\n        let expires_at = Utc::now()\n            .checked_add_signed(chrono::Duration::days(expiration_days as i64))\n            .ok_or_else(|| internal_error(\"Refresh token expiration overflow\"))?;\n        Ok(RefreshToken {\n            id: token_id,\n            user_id: self.user.id.to_string(),\n            secret,\n            token_hash,\n            expires_at,\n        })\n    }\n}\n\nfn set_auth_cookies(headers: \u0026mut HeaderMap, session: \u0026AuthSession, config: \u0026Config) {\n    let options = CookieOptions {\n        secure: config.cookie_secure,\n        same_site: config.cookie_same_site,\n    };\n    let access_max_age = std::time::Duration::from_secs(config.jwt_expiration_hours * 3600);\n    let refresh_max_age =\n        std::time::Duration::from_secs(config.refresh_token_expiration_days * 24 * 60 * 60);\n    let access_cookie = build_auth_cookie(\n        ACCESS_COOKIE_NAME,\n        \u0026session.access_token,\n        access_max_age,\n        ACCESS_COOKIE_PATH,\n        options,\n    );\n    let refresh_cookie = build_auth_cookie(\n        REFRESH_COOKIE_NAME,\n        \u0026session.refresh_token,\n        refresh_max_age,\n        REFRESH_COOKIE_PATH,\n        options,\n    );\n    headers.append(header::SET_COOKIE, access_cookie.parse().unwrap());\n    headers.append(header::SET_COOKIE, refresh_cookie.parse().unwrap());\n}\n\nfn clear_auth_cookies(headers: \u0026mut HeaderMap, config: \u0026Config) {\n    let options = CookieOptions {\n        secure: config.cookie_secure,\n        same_site: config.cookie_same_site,\n    };\n    let access_cookie = build_clear_cookie(ACCESS_COOKIE_NAME, ACCESS_COOKIE_PATH, options);\n    let refresh_cookie = build_clear_cookie(REFRESH_COOKIE_NAME, REFRESH_COOKIE_PATH, options);\n    headers.append(header::SET_COOKIE, access_cookie.parse().unwrap());\n    headers.append(header::SET_COOKIE, refresh_cookie.parse().unwrap());\n}\n\nfn cookie_header_value(headers: \u0026HeaderMap) -\u003e Option\u003c\u0026str\u003e {\n    headers.get(header::COOKIE).and_then(|v| v.to_str().ok())\n}\n\npub async fn ensure_password_matches(\n    candidate: \u0026str,\n    expected_hash: \u0026str,\n    unauthorized_message: \u0026'static str,\n) -\u003e HandlerResult\u003c()\u003e {\n    let candidate = candidate.to_owned();\n    let expected_hash = expected_hash.to_owned();\n    let matches = tokio::task::spawn_blocking(move || verify_password(\u0026candidate, \u0026expected_hash))\n        .await\n        .map_err(|_| internal_error(\"Password verification task failed\"))?\n        .map_err(|_| internal_error(\"Password verification error\"))?;\n    if matches {\n        Ok(())\n    } else {\n        Err(unauthorized(unauthorized_message))\n    }\n}\n\npub fn enforce_mfa(user: \u0026User, code: Option\u003c\u0026str\u003e) -\u003e HandlerResult\u003c()\u003e {\n    if !user.is_mfa_enabled() {\n        return Ok(());\n    }\n    let totp_code = code\n        .map(|raw| {\n            raw.chars()\n                .filter(|ch| !ch.is_whitespace())\n                .collect::\u003cString\u003e()\n        })\n        .filter(|code| !code.is_empty())\n        .ok_or_else(|| unauthorized(\"MFA code required\"))?;\n    let secret = user\n        .mfa_secret\n        .as_ref()\n        .ok_or_else(|| internal_error(\"MFA secret missing\"))?;\n    if verify_totp_code(secret, \u0026totp_code).map_err(|_| internal_error(\"MFA verification error\"))? {\n        Ok(())\n    } else {\n        Err(unauthorized(\"Invalid MFA code\"))\n    }\n}\n\nfn enforce_password_expiration(user: \u0026User, config: \u0026Config) -\u003e HandlerResult\u003c()\u003e {\n    if config.password_expiration_days == 0 {\n        return Ok(());\n    }\n    let expiry = user\n        .password_changed_at\n        .checked_add_signed(chrono::Duration::days(\n            config.password_expiration_days as i64,\n        ))\n        .ok_or_else(|| internal_error(\"Password expiration overflow\"))?;\n    if Utc::now() \u003e expiry {\n        Err(unauthorized(\"Password expired\"))\n    } else {\n        Ok(())\n    }\n}\n\nasync fn ensure_password_not_reused(\n    pool: \u0026sqlx::PgPool,\n    user_id: UserId,\n    candidate: \u0026str,\n    current_hash: \u0026str,\n    history_limit: u32,\n) -\u003e HandlerResult\u003c()\u003e {\n    if history_limit == 0 {\n        return Ok(());\n    }\n    let history_hashes = auth_repo::fetch_recent_password_hashes(pool, user_id, history_limit)\n        .await\n        .map_err(|_| internal_error(\"Failed to load password history\"))?;\n    let candidate = candidate.to_owned();\n    let current_hash = current_hash.to_owned();\n    let reused = tokio::task::spawn_blocking(move || {\n        let mut hashes = history_hashes;\n        hashes.push(current_hash);\n        password_matches_any(\u0026candidate, \u0026hashes)\n    })\n    .await\n    .map_err(|_| internal_error(\"Password reuse check failed\"))?\n    .map_err(|_| internal_error(\"Password reuse check error\"))?;\n\n    if reused {\n        Err(bad_request(\"Password was used recently\"))\n    } else {\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::http::{header, HeaderMap};\n    use base32::Alphabet::RFC4648;\n    use chrono::{Duration, Utc};\n    use chrono_tz::UTC;\n    use sqlx::postgres::PgPoolOptions;\n    use std::time::{SystemTime, UNIX_EPOCH};\n    use totp_rs::{Algorithm, TOTP};\n\n    fn config_stub() -\u003e Config {\n        Config {\n            database_url: \"postgres://127.0.0.1/timekeeper_test\".to_string(),\n            read_database_url: None,\n            jwt_secret: \"0123456789abcdef0123456789abcdef\".to_string(),\n            jwt_expiration_hours: 1,\n            refresh_token_expiration_days: 7,\n            max_concurrent_sessions: 3,\n            audit_log_retention_days: 1825,\n            audit_log_retention_forever: false,\n            consent_log_retention_days: 1825,\n            consent_log_retention_forever: false,\n            aws_region: \"ap-northeast-1\".into(),\n            aws_kms_key_id: \"alias/timekeeper-test\".into(),\n            aws_audit_log_bucket: \"timekeeper-audit-logs\".into(),\n            aws_cloudtrail_enabled: true,\n            cookie_secure: true,\n            cookie_same_site: crate::utils::cookies::SameSite::Lax,\n            cors_allow_origins: vec![\"http://localhost:8000\".into()],\n            time_zone: UTC,\n            mfa_issuer: \"Timekeeper\".into(),\n            rate_limit_ip_max_requests: 15,\n            rate_limit_ip_window_seconds: 900,\n            rate_limit_user_max_requests: 20,\n            rate_limit_user_window_seconds: 3600,\n            redis_url: None,\n            redis_pool_size: 5,\n            redis_connect_timeout: 5,\n            feature_redis_cache_enabled: true,\n            feature_read_replica_enabled: true,\n            password_min_length: 12,\n            password_require_uppercase: true,\n            password_require_lowercase: true,\n            password_require_numbers: true,\n            password_require_symbols: true,\n            password_expiration_days: 30,\n            password_history_count: 5,\n            production_mode: false,\n        }\n    }\n\n    fn build_user() -\u003e User {\n        let password_hash =\n            hash_password(\"Secret123!\").expect(\"hash password for tests\");\n        User::new(\n            \"tester\".into(),\n            password_hash,\n            \"Test User\".into(),\n            \"test@example.com\".into(),\n            crate::models::user::UserRole::Employee,\n            false,\n        )\n    }\n\n    fn current_totp_code(secret: \u0026str) -\u003e String {\n        let cleaned = secret.trim().replace(' ', \"\").to_uppercase();\n        let secret_bytes =\n            base32::decode(RFC4648 { padding: false }, cleaned.as_str()).expect(\"decode secret\");\n        let totp = TOTP::new(\n            Algorithm::SHA1,\n            6,\n            1,\n            30,\n            secret_bytes,\n            None,\n            \"\".to_string(),\n        )\n        .expect(\"build totp\");\n        let now = SystemTime::now()\n            .duration_since(UNIX_EPOCH)\n            .expect(\"time\")\n            .as_secs();\n        totp.generate(now)\n    }\n\n    #[tokio::test]\n    async fn ensure_password_matches_accepts_correct_password() {\n        let user = build_user();\n        ensure_password_matches(\"Secret123!\", \u0026user.password_hash, \"invalid\")\n            .await\n            .expect(\"password should match\");\n    }\n\n    #[tokio::test]\n    async fn ensure_password_matches_rejects_wrong_password() {\n        let user = build_user();\n        let err = ensure_password_matches(\"wrong\", \u0026user.password_hash, \"invalid\")\n            .await\n            .expect_err(\"should fail\");\n        assert!(matches!(err, AppError::Unauthorized(_)));\n    }\n\n    #[test]\n    fn enforce_mfa_accepts_valid_code() {\n        let mut user = build_user();\n        let secret = generate_totp_secret();\n        user.mfa_secret = Some(secret.clone());\n        user.mfa_enabled_at = Some(Utc::now());\n        let code = current_totp_code(\u0026secret);\n        enforce_mfa(\u0026user, Some(\u0026code)).expect(\"valid mfa code should pass\");\n    }\n\n    #[test]\n    fn enforce_mfa_rejects_missing_code() {\n        let mut user = build_user();\n        user.mfa_secret = Some(generate_totp_secret());\n        user.mfa_enabled_at = Some(Utc::now());\n        let err = enforce_mfa(\u0026user, None).expect_err(\"code required\");\n        assert!(matches!(err, AppError::Unauthorized(_)));\n    }\n\n    #[test]\n    fn enforce_password_expiration_behaves_as_expected() {\n        let mut user = build_user();\n        let mut config = config_stub();\n        config.password_expiration_days = 1;\n        user.password_changed_at = Utc::now() - Duration::days(2);\n        assert!(enforce_password_expiration(\u0026user, \u0026config).is_err());\n        user.password_changed_at = Utc::now();\n        assert!(enforce_password_expiration(\u0026user, \u0026config).is_ok());\n        config.password_expiration_days = 0;\n        assert!(enforce_password_expiration(\u0026user, \u0026config).is_ok());\n    }\n\n    #[tokio::test]\n    async fn ensure_password_not_reused_allows_history_zero() {\n        let pool = PgPoolOptions::new()\n            .max_connections(1)\n            .connect_lazy(\"postgres://127.0.0.1:1/timekeeper\")\n            .expect(\"create lazy pool\");\n        ensure_password_not_reused(\n            \u0026pool,\n            UserId::new(),\n            \"candidate\",\n            \"hash\",\n            0,\n        )\n        .await\n        .expect(\"history limit zero should skip db\");\n    }\n\n    #[tokio::test]\n    async fn auth_session_exposes_claims_and_refresh_token_data() {\n        let mut user = build_user();\n        user.mfa_enabled_at = Some(Utc::now());\n        user.mfa_secret = Some(generate_totp_secret());\n        let config = config_stub();\n        let session = create_auth_session(\u0026user, \u0026config)\n            .await\n            .expect(\"create session\");\n        let claims = session\n            .access_claims(\u0026config.jwt_secret)\n            .expect(\"claims decode\");\n        assert_eq!(claims.sub, user.id.to_string());\n        let refresh_data =\n            session.refresh_token_data(config.refresh_token_expiration_days)\n                .expect(\"refresh data\");\n        assert_eq!(refresh_data.user_id, user.id.to_string());\n    }\n\n    #[test]\n    fn sanitize_device_label_trims_and_limits_length() {\n        assert!(sanitize_device_label(Some(\"   \".into())).is_none());\n        assert_eq!(\n            sanitize_device_label(Some(\"foo\".into())),\n            Some(\"foo\".to_string())\n        );\n        let long = \"x\".repeat(200);\n        assert_eq!(\n            sanitize_device_label(Some(long.clone())),\n            Some(long.chars().take(128).collect())\n        );\n    }\n\n    #[test]\n    fn extract_ip_prefers_forwarded_for_and_falls_back_to_real_ip() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            \"x-forwarded-for\",\n            \" 1.2.3.4 , 5.6.7.8 \".parse().unwrap(),\n        );\n        headers.insert(\"x-real-ip\", \"9.9.9.9\".parse().unwrap());\n        assert_eq!(extract_ip(\u0026headers), Some(\"1.2.3.4\".to_string()));\n        headers.remove(\"x-forwarded-for\");\n        assert_eq!(extract_ip(\u0026headers), Some(\"9.9.9.9\".to_string()));\n    }\n\n    #[test]\n    fn extract_user_agent_trims_value() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            header::USER_AGENT,\n            \"  TestAgent/1.0 \".parse().unwrap(),\n        );\n        assert_eq!(\n            extract_user_agent(\u0026headers),\n            Some(\"TestAgent/1.0\".to_string())\n        );\n    }\n\n    #[test]\n    fn cookie_header_value_reads_cookie_string() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            header::COOKIE,\n            \"foo=bar; baz=qux\".parse().unwrap(),\n        );\n        assert_eq!(\n            cookie_header_value(\u0026headers),\n            Some(\"foo=bar; baz=qux\")\n        );\n    }\n\n    #[tokio::test]\n    async fn set_and_clear_auth_cookies_append_expected_headers() {\n        let mut headers = HeaderMap::new();\n        let user = build_user();\n        let config = config_stub();\n        let session = create_auth_session(\u0026user, \u0026config)\n            .await\n            .expect(\"create session\");\n        set_auth_cookies(\u0026mut headers, \u0026session, \u0026config);\n        assert_eq!(headers.get_all(header::SET_COOKIE).iter().count(), 2);\n        clear_auth_cookies(\u0026mut headers, \u0026config);\n        assert_eq!(headers.get_all(header::SET_COOKIE).iter().count(), 4);\n    }\n}\n\nfn bad_request(message: impl Into\u003cString\u003e) -\u003e AppError {\n    AppError::BadRequest(message.into())\n}\n\nfn unauthorized(message: impl Into\u003cString\u003e) -\u003e AppError {\n    AppError::Unauthorized(message.into())\n}\n\nfn internal_error(message: impl Into\u003cString\u003e) -\u003e AppError {\n    AppError::InternalServerError(anyhow::anyhow!(message.into()))\n}\n","traces":[{"line":61,"address":[18204080],"length":1,"stats":{"Line":0},"fn_name":"login"},{"line":68,"address":[19910572,19911100,19910707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[19913646,19911720,19913668,19911007,19910886,19911444,19911520,19911045,19911343,19911403,19911796],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[19911162,19910609,19911030,19911078,19911353],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[19911488,19916288,19916272,19911421],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":73,"address":[19911697,19916224,19916236,19911764],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":75,"address":[19911972],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[19912122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[19912175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[19912280],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[19912294,19912379],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[19915891,19916384,19916645,19915856,19912387,19916502,19917039,19916920,19916419],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":84,"address":[19916467,19916594,19916529,19916676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[19912403,19912488],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[19912579,19912496],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[19917470,19919132,19915712,19912595,19917072,19915750,19917119,19917230,19917273,19919090],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":91,"address":[19917176,19917504,19917377,19917260,19918730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[19917890],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[19918098,19918211,19918144,19917963],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[19918121,19921312,19918179,19921324],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":95,"address":[19918300],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[19918453,19917281,19919185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[19917994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[19912712,19912635],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[19912720,19912803],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[19912819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[19912886,19912965],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[19912981],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[19919680,19921002,19919718,19915936,19913040,19915977,19920534,19919841],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":108,"address":[19920708,19920485,19920345],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[19919808],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[19919822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[19919937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[19920000],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[19920062],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[19920069],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[19920084],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[19920196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[19920308],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[19919766,19920740,19920473,19920571,19920515,19919871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[19913678,19913972,19913519,19913866,19910630,19913424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[19914147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[19914202],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[19914273],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[18204592],"length":1,"stats":{"Line":0},"fn_name":"refresh"},{"line":138,"address":[19937836,19938203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[19938219,19938434,19938367,19939293],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[19938298,19954624],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":143,"address":[19954656],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[19954752,19954676,19954761],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":145,"address":[19954689,19954726,19954704],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":147,"address":[19938344,19938402,19953712,19953724],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":149,"address":[19939265,19938799,19938723,19938579,19938677],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[19938700,19954192,19938767,19954208],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":152,"address":[19940148,19941064,19939207,19939519,19938990,19941033,19939110,19939732,19939808,19939613,19940072],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[19939358,19937892,19939192,19939240,19939599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[19954096,19954080,19939776,19939709],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":155,"address":[19954304,19940116,19940049,19954316],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":157,"address":[19940376,19940493,19941031,19940676,19940609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[19953456,19940586,19940644,19953440],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":160,"address":[19940764,19940847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[19941362,19940799,19941438,19941714,19941261,19940976,19941638,19942443,19941321],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[19941009,19937913,19940961,19941080,19941271],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[19953984,19941406,19953968,19941339],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":166,"address":[19941615,19954364,19941682,19954352],"length":1,"stats":{"Line":0},"fn_name":"{closure#7}"},{"line":168,"address":[19941983,19941898,19942416],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[19942123],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[19942224,19942461,19942326,19944227,19937934],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[19943076,19944203,19942987],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[19943442,19943568,19944179],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[19943957,19944551,19944510,19944450,19944083,19945207,19944121,19944627],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[19944106,19937955,19944269,19944460,19944154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[19953616,19953600,19944595,19944528],"length":1,"stats":{"Line":0},"fn_name":"{closure#8}"},{"line":180,"address":[19944888],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[19944895,19953936,19953920],"length":1,"stats":{"Line":0},"fn_name":"{closure#9}"},{"line":183,"address":[19945003,19944917],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[19945010,19953776,19953760],"length":1,"stats":{"Line":0},"fn_name":"{closure#10}"},{"line":187,"address":[19945025],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[19945035],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[19945185,19937976,19945426,19945242,19945523,19945137],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[19945628],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[19945645],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[19945662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[19946289,19945899,19937997,19945947,19946008,19946192],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[19946394],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[19946411],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[19946481],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[19946551],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[19946613],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[19946696],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[19946874,19946839,19947083,19946791,19938018],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[19947219,19947161,19954416,19954400],"length":1,"stats":{"Line":0},"fn_name":"{closure#11}"},{"line":211,"address":[19948604,19947335],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[19947347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[19947364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[19947439,19947528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":216,"address":[19947552,19947627],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[19947635],"length":1,"stats":{"Line":0},"fn_name":null},{"line":218,"address":[19947652],"length":1,"stats":{"Line":0},"fn_name":null},{"line":219,"address":[19947746,19947667],"length":1,"stats":{"Line":0},"fn_name":null},{"line":220,"address":[19947754],"length":1,"stats":{"Line":0},"fn_name":null},{"line":221,"address":[19947846],"length":1,"stats":{"Line":0},"fn_name":null},{"line":224,"address":[19948107,19948410,19938039,19948226,19948507,19948059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[19947394,19948625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[19948710,19949067,19949623,19949216,19948838,19949283,19949129],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[19948906,19949115,19948823,19948871,19938060],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[19949251,19949193,19954512,19954528],"length":1,"stats":{"Line":0},"fn_name":"{closure#12}"},{"line":231,"address":[19949356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[19949636,19949431,19938081],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[19950226,19949902,19950313,19949940,19950380,19951231,19948757,19950164],"length":1,"stats":{"Line":0},"fn_name":null},{"line":237,"address":[19950212,19938102,19949973,19950003,19949925],"length":1,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[19953808,19950290,19950348,19953824],"length":1,"stats":{"Line":0},"fn_name":"{closure#13}"},{"line":240,"address":[19950453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":241,"address":[19950604,19953564,19950532,19951226,19953552],"length":1,"stats":{"Line":0},"fn_name":"{closure#14}"},{"line":243,"address":[19950806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[19951778,19938123,19950974],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[19950570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[19952005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[19952089],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[18204288],"length":1,"stats":{"Line":0},"fn_name":"logout"},{"line":261,"address":[19922650],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[19922599,19936713,19936704],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":265,"address":[19922662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[19924365,19923825,19922716,19924041,19923575,19923974,19923887],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[19923560,19923608,19922338,19923873,19923664],"length":1,"stats":{"Line":0},"fn_name":null},{"line":268,"address":[19923951,19936784,19936800,19924009],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":269,"address":[19924985,19924310,19924624,19924183,19924562,19924711,19924778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[19924610,19924401,19922359,19924343,19924295],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[19924688,19937008,19937024,19924746],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":272,"address":[19925331,19925398,19925605,19924930,19924851,19925244,19925182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[19924915,19925021,19924963,19925230,19922380],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[19925308,19936384,19925366,19936400],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":275,"address":[19926443,19925471,19925779,19925995,19925928,19925550,19925841],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[19925618,19925827,19925583,19925535,19922401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":277,"address":[19936160,19936176,19925963,19925905],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":279,"address":[19926068],"length":1,"stats":{"Line":0},"fn_name":null},{"line":280,"address":[19926289,19926456,19922422,19926139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[19926170],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[19926925,19926698,19926798,19929128],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[19927008,19928196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[19928292,19928236],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[19928300],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[19928388,19928539,19928474,19928436,19929133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":292,"address":[19927064],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[19927114],"length":1,"stats":{"Line":0},"fn_name":null},{"line":294,"address":[19927741],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[19927182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":296,"address":[19928077,19927294,19927345,19927383,19927448],"length":1,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[19922847,19922674,19922877],"length":1,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[19922775,19936496,19936505],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":303,"address":[19922822,19936736,19936758],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":304,"address":[19922837,19936640,19922862],"length":1,"stats":{"Line":0},"fn_name":"{closure#7}"},{"line":305,"address":[19936672],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[19937254,19936685,19937232],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":309,"address":[19922959,19923248,19923122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":310,"address":[19929578,19923406,19923286,19929732,19923444,19929665,19929516],"length":1,"stats":{"Line":0},"fn_name":null},{"line":311,"address":[19923429,19923477,19929355,19929564,19922443],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[19937136,19929642,19937120,19929700],"length":1,"stats":{"Line":0},"fn_name":"{closure#8}"},{"line":316,"address":[19930659,19930091,19930599,19930129,19930776,19922990,19930700,19931196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[19930114,19930162,19930418,19922464,19930609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[19936272,19930744,19936288,19930677],"length":1,"stats":{"Line":0},"fn_name":"{closure#9}"},{"line":320,"address":[19931848,19931449,19931103,19931536,19930951,19931141,19931387,19931603],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[19931126,19931435,19931174,19931226,19922485],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[19931513,19931571,19936896,19936912],"length":1,"stats":{"Line":0},"fn_name":"{closure#10}"},{"line":324,"address":[19932106,19932260,19931793,19931676,19932044,19932193,19932653],"length":1,"stats":{"Line":0},"fn_name":null},{"line":325,"address":[19931883,19932092,19931778,19922506,19931826],"length":1,"stats":{"Line":0},"fn_name":null},{"line":326,"address":[19932228,19932170,19936544,19936528],"length":1,"stats":{"Line":0},"fn_name":"{closure#11}"},{"line":328,"address":[19932333],"length":1,"stats":{"Line":0},"fn_name":null},{"line":329,"address":[19932404,19922527,19932502,19933177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":331,"address":[19932429,19934715,19933404],"length":1,"stats":{"Line":0},"fn_name":null},{"line":332,"address":[19933456,19933623],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[19933711,19933631],"length":1,"stats":{"Line":0},"fn_name":null},{"line":335,"address":[19933735],"length":1,"stats":{"Line":0},"fn_name":null},{"line":337,"address":[19933879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":338,"address":[19934053,19933967,19934015,19934118,19934720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[19933556],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[19934987],"length":1,"stats":{"Line":0},"fn_name":null},{"line":343,"address":[19935321,19935055,19935256,19936050],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[19909504,19909542,19909871,19909729,19909702],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":347,"address":[19909771,19909680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":350,"address":[18194240],"length":1,"stats":{"Line":0},"fn_name":"mfa_status"},{"line":353,"address":[19825993],"length":1,"stats":{"Line":0},"fn_name":null},{"line":354,"address":[19825896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":355,"address":[19825974],"length":1,"stats":{"Line":0},"fn_name":null},{"line":359,"address":[18198192],"length":1,"stats":{"Line":0},"fn_name":"update_profile"},{"line":364,"address":[19854360,19855047,19854225],"length":1,"stats":{"Line":0},"fn_name":null},{"line":366,"address":[19854539],"length":1,"stats":{"Line":0},"fn_name":null},{"line":367,"address":[19855492,19855338,19854793,19854992,19855276,19855425,19854954,19854601],"length":1,"stats":{"Line":0},"fn_name":null},{"line":369,"address":[19855025,19855109,19855324,19854262,19854977],"length":1,"stats":{"Line":0},"fn_name":null},{"line":370,"address":[19855586,19858864,19855402,19858848,19856361,19854863,19855460],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":372,"address":[19855611],"length":1,"stats":{"Line":0},"fn_name":null},{"line":373,"address":[19855620,19856266],"length":1,"stats":{"Line":0},"fn_name":null},{"line":377,"address":[19854646],"length":1,"stats":{"Line":0},"fn_name":null},{"line":378,"address":[19855658],"length":1,"stats":{"Line":0},"fn_name":null},{"line":380,"address":[19856211,19856637,19855929,19856675,19856580,19856751,19856041,19855821],"length":1,"stats":{"Line":0},"fn_name":null},{"line":382,"address":[19856396,19856590,19856244,19856196,19854283],"length":1,"stats":{"Line":0},"fn_name":null},{"line":383,"address":[19855967,19856902,19858752,19857755,19858736,19856652,19856719],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":385,"address":[19856961],"length":1,"stats":{"Line":0},"fn_name":null},{"line":388,"address":[18198000],"length":1,"stats":{"Line":0},"fn_name":"mfa_register"},{"line":393,"address":[19839497,19839140,19839244],"length":1,"stats":{"Line":0},"fn_name":null},{"line":394,"address":[19839552,19840354,19839174,19839378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":395,"address":[19840021],"length":1,"stats":{"Line":0},"fn_name":null},{"line":398,"address":[18204816],"length":1,"stats":{"Line":0},"fn_name":"mfa_setup"},{"line":403,"address":[19955465,19955212,19955108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":404,"address":[19955346,19956322,19955520,19955142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":405,"address":[19955989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[18197840],"length":1,"stats":{"Line":0},"fn_name":"mfa_activate"},{"line":414,"address":[19833537,19833716,19835052],"length":1,"stats":{"Line":0},"fn_name":null},{"line":415,"address":[19833921,19835025,19833856,19833988],"length":1,"stats":{"Line":0},"fn_name":null},{"line":418,"address":[19833898,19833956,19838656,19838668],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":420,"address":[19834085],"length":1,"stats":{"Line":0},"fn_name":null},{"line":421,"address":[19838448,19835020,19834204,19838432,19834318],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":422,"address":[19834635,19834589],"length":1,"stats":{"Line":0},"fn_name":null},{"line":425,"address":[19834616],"length":1,"stats":{"Line":0},"fn_name":null},{"line":426,"address":[19835308,19835462,19834884,19834748,19835395,19834968,19835246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":427,"address":[19835001,19833577,19834953,19835088,19835294],"length":1,"stats":{"Line":0},"fn_name":null},{"line":428,"address":[19835584,19835558,19835430,19835372,19834826,19838720,19835857,19838704],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":430,"address":[19835602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":433,"address":[19836470,19835797,19835718,19836050,19836112,19836199,19836266],"length":1,"stats":{"Line":0},"fn_name":null},{"line":434,"address":[19835830,19833598,19835782,19835892,19836098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":435,"address":[19836176,19838544,19838560,19836234],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":436,"address":[19836339,19836703,19836857,19836641,19836418,19836790,19837178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":437,"address":[19836689,19836403,19836451,19833619,19836483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":438,"address":[19836767,19838320,19838336,19836825],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":440,"address":[19836930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":441,"address":[19837504,19836995,19837048,19833640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":444,"address":[19837020,19837721,19837759,19837824,19838282],"length":1,"stats":{"Line":0},"fn_name":null},{"line":447,"address":[18197216],"length":1,"stats":{"Line":0},"fn_name":"mfa_disable"},{"line":453,"address":[19827649,19829261,19827828],"length":1,"stats":{"Line":0},"fn_name":null},{"line":454,"address":[19827968],"length":1,"stats":{"Line":0},"fn_name":null},{"line":455,"address":[19828063,19828002],"length":1,"stats":{"Line":0},"fn_name":null},{"line":458,"address":[19828203,19828037,19829256,19828270],"length":1,"stats":{"Line":0},"fn_name":null},{"line":461,"address":[19832764,19828238,19828180,19832752],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":463,"address":[19828367],"length":1,"stats":{"Line":0},"fn_name":null},{"line":464,"address":[19829251,19828486,19832912,19828600,19832928],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":465,"address":[19828947,19828871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":468,"address":[19829607,19829199,19829520,19829458,19829060,19828906,19829674,19829161],"length":1,"stats":{"Line":0},"fn_name":null},{"line":469,"address":[19829506,19829232,19829184,19827689,19829300],"length":1,"stats":{"Line":0},"fn_name":null},{"line":470,"address":[19832816,19829584,19829770,19832800,19829092,19830069,19829642,19829796],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":472,"address":[19829814],"length":1,"stats":{"Line":0},"fn_name":null},{"line":475,"address":[19830262,19829930,19830009,19830411,19830478,19830324,19830682],"length":1,"stats":{"Line":0},"fn_name":null},{"line":476,"address":[19830310,19827710,19829994,19830042,19830104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":477,"address":[19832640,19832656,19830446,19830388],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":478,"address":[19830630,19831002,19830551,19830853,19830915,19831390,19831069],"length":1,"stats":{"Line":0},"fn_name":null},{"line":479,"address":[19830901,19827731,19830615,19830663,19830695],"length":1,"stats":{"Line":0},"fn_name":null},{"line":480,"address":[19830979,19831037,19832528,19832544],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":482,"address":[19831142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":483,"address":[19831207,19831260,19827752,19831716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":486,"address":[19831935,19831232,19832038,19832496,19831973],"length":1,"stats":{"Line":0},"fn_name":null},{"line":489,"address":[18198320],"length":1,"stats":{"Line":0},"fn_name":"change_password"},{"line":495,"address":[19859501,19859743,19860795],"length":1,"stats":{"Line":0},"fn_name":null},{"line":496,"address":[19860793,19859883],"length":1,"stats":{"Line":0},"fn_name":null},{"line":497,"address":[19860100,19860791,19860282,19860215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":498,"address":[19860250,19866700,19866672,19860192],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":499,"address":[19860355],"length":1,"stats":{"Line":0},"fn_name":null},{"line":500,"address":[19860437,19860690],"length":1,"stats":{"Line":0},"fn_name":null},{"line":506,"address":[19860407],"length":1,"stats":{"Line":0},"fn_name":null},{"line":507,"address":[19860507],"length":1,"stats":{"Line":0},"fn_name":null},{"line":510,"address":[19860665,19860617,19861015,19859541,19860831,19861112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":513,"address":[19861217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":514,"address":[19861234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":515,"address":[19861249],"length":1,"stats":{"Line":0},"fn_name":null},{"line":516,"address":[19861319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":517,"address":[19861397],"length":1,"stats":{"Line":0},"fn_name":null},{"line":519,"address":[19861451,19861724,19859562,19861821,19861499,19861540],"length":1,"stats":{"Line":0},"fn_name":null},{"line":521,"address":[19862372,19862674,19863168,19862053,19862255,19862607,19861984,19862301,19862439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":522,"address":[19861926],"length":1,"stats":{"Line":0},"fn_name":null},{"line":523,"address":[19861952,19866432,19866457],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":525,"address":[19862103,19859583,19862022,19862287,19862068],"length":1,"stats":{"Line":0},"fn_name":null},{"line":526,"address":[19866560,19862349,19866576,19862407],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":527,"address":[19862584,19867040,19867024,19862642],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":530,"address":[19862819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":531,"address":[19862837],"length":1,"stats":{"Line":0},"fn_name":null},{"line":532,"address":[19862852],"length":1,"stats":{"Line":0},"fn_name":null},{"line":533,"address":[19862966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":534,"address":[19863044],"length":1,"stats":{"Line":0},"fn_name":null},{"line":536,"address":[19863146,19863098,19863186,19859604,19863377],"length":1,"stats":{"Line":0},"fn_name":null},{"line":537,"address":[19866800,19863707,19866816,19863512,19863445],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":539,"address":[19863722,19863801,19864266,19864112,19864470,19864199,19864050],"length":1,"stats":{"Line":0},"fn_name":null},{"line":540,"address":[19863834,19863892,19864098,19859625,19863786],"length":1,"stats":{"Line":0},"fn_name":null},{"line":541,"address":[19866912,19864234,19864176,19866928],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":542,"address":[19864857,19865178,19864418,19864703,19864790,19864641,19864339],"length":1,"stats":{"Line":0},"fn_name":null},{"line":543,"address":[19864451,19864403,19859646,19864689,19864483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":544,"address":[19866320,19866336,19864767,19864825],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":546,"address":[19864930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":547,"address":[19864995,19865048,19859667,19865504],"length":1,"stats":{"Line":0},"fn_name":null},{"line":550,"address":[19866284,19865826,19865723,19865020,19865761],"length":1,"stats":{"Line":0},"fn_name":null},{"line":553,"address":[18201072],"length":1,"stats":{"Line":0},"fn_name":"request_password_reset"},{"line":557,"address":[19888387,19888914,19888521],"length":1,"stats":{"Line":0},"fn_name":null},{"line":559,"address":[19888821,19889333,19888700,19889257,19889156,19889216,19889900,19888859],"length":1,"stats":{"Line":0},"fn_name":null},{"line":560,"address":[19888892,19888975,19889166,19888424,19888844],"length":1,"stats":{"Line":0},"fn_name":null},{"line":561,"address":[19889234,19894160,19894144,19889301],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":563,"address":[19889472],"length":1,"stats":{"Line":0},"fn_name":null},{"line":564,"address":[19889562],"length":1,"stats":{"Line":0},"fn_name":null},{"line":565,"address":[19889654,19890097,19890223,19889807,19889845,19890374,19890450,19893667],"length":1,"stats":{"Line":0},"fn_name":null},{"line":566,"address":[19888445,19889936,19889830,19890209,19889878],"length":1,"stats":{"Line":0},"fn_name":null},{"line":567,"address":[19894256,19890747,19890418,19890351,19894272],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":569,"address":[19890762,19893639,19894384,19894368],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":571,"address":[19891218,19890998,19891108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":572,"address":[19891296,19891393,19891788],"length":1,"stats":{"Line":0},"fn_name":null},{"line":576,"address":[19893549,19892907,19889589,19892945,19893010],"length":1,"stats":{"Line":0},"fn_name":null},{"line":581,"address":[18198112],"length":1,"stats":{"Line":0},"fn_name":"reset_password"},{"line":585,"address":[19842061,19841144,19841428],"length":1,"stats":{"Line":0},"fn_name":null},{"line":586,"address":[19841607,19841722,19842034,19841789],"length":1,"stats":{"Line":0},"fn_name":null},{"line":587,"address":[19852044,19841757,19852016,19841699],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":589,"address":[19841862,19843486,19842535,19842258,19841979,19842611,19842384,19842939,19843015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":591,"address":[19841184,19841964,19842370,19842097,19842012],"length":1,"stats":{"Line":0},"fn_name":null},{"line":592,"address":[19852448,19842512,19852432,19842579],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":593,"address":[19852144,19842983,19842916,19852156],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":595,"address":[19843792,19843868,19843305,19844068,19843751,19844663,19843431,19844144,19844690,19843691],"length":1,"stats":{"Line":0},"fn_name":null},{"line":596,"address":[19843464,19843416,19841205,19843510,19843701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":597,"address":[19843769,19852336,19843836,19852320],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":598,"address":[19844045,19853596,19853584,19844112],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":601,"address":[19844312],"length":1,"stats":{"Line":0},"fn_name":null},{"line":602,"address":[19844329],"length":1,"stats":{"Line":0},"fn_name":null},{"line":603,"address":[19844344],"length":1,"stats":{"Line":0},"fn_name":null},{"line":604,"address":[19844461],"length":1,"stats":{"Line":0},"fn_name":null},{"line":605,"address":[19844539],"length":1,"stats":{"Line":0},"fn_name":null},{"line":607,"address":[19844700,19841226,19844641,19844884,19844981,19844593],"length":1,"stats":{"Line":0},"fn_name":null},{"line":609,"address":[19845856,19845554,19845144,19845437,19845213,19845789,19845483,19846350,19845621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":610,"address":[19845086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":611,"address":[19852192,19845112,19852217],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":613,"address":[19845228,19841247,19845285,19845182,19845469],"length":1,"stats":{"Line":0},"fn_name":null},{"line":614,"address":[19853248,19845589,19845531,19853264],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":615,"address":[19852560,19845766,19852544,19845824],"length":1,"stats":{"Line":0},"fn_name":"{closure#7}"},{"line":618,"address":[19846001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":619,"address":[19846019],"length":1,"stats":{"Line":0},"fn_name":null},{"line":620,"address":[19846034],"length":1,"stats":{"Line":0},"fn_name":null},{"line":621,"address":[19846148],"length":1,"stats":{"Line":0},"fn_name":null},{"line":622,"address":[19846226],"length":1,"stats":{"Line":0},"fn_name":null},{"line":624,"address":[19846280,19846368,19846328,19846559,19841268],"length":1,"stats":{"Line":0},"fn_name":null},{"line":625,"address":[19846627,19852656,19846694,19852672],"length":1,"stats":{"Line":0},"fn_name":"{closure#8}"},{"line":627,"address":[19846894,19847304,19847488,19847350,19847695,19847020,19847058,19847421],"length":1,"stats":{"Line":0},"fn_name":null},{"line":628,"address":[19847152,19847043,19847091,19841289,19847336],"length":1,"stats":{"Line":0},"fn_name":null},{"line":629,"address":[19853648,19847398,19853632,19847456],"length":1,"stats":{"Line":0},"fn_name":"{closure#9}"},{"line":631,"address":[19847953,19848314,19847891,19847640,19848040,19847561,19848107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":632,"address":[19847730,19841310,19847939,19847673,19847625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":633,"address":[19848017,19853472,19853488,19848075],"length":1,"stats":{"Line":0},"fn_name":"{closure#10}"},{"line":635,"address":[19848637,19848488,19848180,19848550,19848704,19849067,19848259],"length":1,"stats":{"Line":0},"fn_name":null},{"line":636,"address":[19848244,19848292,19841331,19848327,19848536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":637,"address":[19853376,19853360,19848614,19848672],"length":1,"stats":{"Line":0},"fn_name":"{closure#11}"},{"line":639,"address":[19848777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":640,"address":[19849080,19848848,19841352,19848913],"length":1,"stats":{"Line":0},"fn_name":null},{"line":643,"address":[19852784,19852768,19848879,19849330,19851988],"length":1,"stats":{"Line":0},"fn_name":"{closure#12}"},{"line":644,"address":[19849653,19849543],"length":1,"stats":{"Line":0},"fn_name":null},{"line":645,"address":[19849801,19850293,19849898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":648,"address":[19849837,19851214,19851956,19851252,19851317],"length":1,"stats":{"Line":0},"fn_name":null},{"line":655,"address":[18200669,18200656],"length":1,"stats":{"Line":4},"fn_name":"create_auth_session"},{"line":657,"address":[19867497,19867578],"length":1,"stats":{"Line":2},"fn_name":null},{"line":658,"address":[19867659,19867586],"length":1,"stats":{"Line":2},"fn_name":null},{"line":659,"address":[19867753,19867667],"length":1,"stats":{"Line":2},"fn_name":null},{"line":660,"address":[19867785],"length":1,"stats":{"Line":1},"fn_name":null},{"line":661,"address":[19867862],"length":1,"stats":{"Line":1},"fn_name":null},{"line":663,"address":[19868293,19867978,19869792,19869808,19868089],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":665,"address":[19868354,19868479,19868410,19868555],"length":1,"stats":{"Line":3},"fn_name":null},{"line":667,"address":[19869696,19869680,19868523,19868456],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":670,"address":[19869135],"length":1,"stats":{"Line":1},"fn_name":null},{"line":671,"address":[19868976],"length":1,"stats":{"Line":1},"fn_name":null},{"line":672,"address":[19869013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":673,"address":[19869128,19869061],"length":1,"stats":{"Line":2},"fn_name":null},{"line":677,"address":[18200688],"length":1,"stats":{"Line":0},"fn_name":"begin_mfa_enrollment"},{"line":682,"address":[19870181,19870067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":683,"address":[19870206,19871115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":686,"address":[19870195],"length":1,"stats":{"Line":0},"fn_name":null},{"line":687,"address":[19870356,19870591,19870244,19870524,19871090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":688,"address":[19870501,19872192,19872176,19870559],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":690,"address":[19871508,19871595,19870893,19870728,19871041,19871449,19870799,19871662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":691,"address":[19871071,19870111,19871026,19871288,19871497],"length":1,"stats":{"Line":0},"fn_name":null},{"line":692,"address":[20975193,20975158],"length":1,"stats":{"Line":0},"fn_name":null},{"line":694,"address":[19871799],"length":1,"stats":{"Line":0},"fn_name":null},{"line":697,"address":[19872014],"length":1,"stats":{"Line":0},"fn_name":null},{"line":698,"address":[19871942],"length":1,"stats":{"Line":0},"fn_name":null},{"line":699,"address":[19871978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":703,"address":[19879408],"length":1,"stats":{"Line":0},"fn_name":"process_login_for_user\u003ctimekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#2}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#3}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#4}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#2}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#3}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#4}::{async_block_env#0}\u003e"},{"line":720,"address":[19880109],"length":1,"stats":{"Line":0},"fn_name":null},{"line":721,"address":[19880330],"length":1,"stats":{"Line":0},"fn_name":null},{"line":724,"address":[21189707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":725,"address":[19880924,19883449],"length":1,"stats":{"Line":0},"fn_name":null},{"line":726,"address":[19883444,19881152],"length":1,"stats":{"Line":0},"fn_name":null},{"line":729,"address":[19881405,19881340],"length":1,"stats":{"Line":0},"fn_name":null},{"line":730,"address":[19881413,19881496],"length":1,"stats":{"Line":0},"fn_name":null},{"line":731,"address":[19881504,19881590],"length":1,"stats":{"Line":0},"fn_name":null},{"line":732,"address":[19881625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":733,"address":[19881712],"length":1,"stats":{"Line":0},"fn_name":null},{"line":735,"address":[19887968,19881902,19881835,19887984],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}\u003ctimekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#2}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#3}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#4}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#2}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#3}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#4}::{async_block_env#0}\u003e"},{"line":737,"address":[19883231,19882423,19882186,19882347,19882271],"length":1,"stats":{"Line":0},"fn_name":null},{"line":738,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":739,"address":[19882324,19882391,19887872,19887856],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}\u003ctimekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#2}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#3}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#4}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#2}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#3}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#4}::{async_block_env#0}\u003e"},{"line":740,"address":[19882807,19882730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":742,"address":[19882866,19883145,19880193,19882814,19883467,19884557],"length":1,"stats":{"Line":0},"fn_name":null},{"line":743,"address":[19883856,19883932],"length":1,"stats":{"Line":0},"fn_name":null},{"line":744,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":746,"address":[19887707,19883947,19887680],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}\u003ctimekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#2}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#3}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure_env#4}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#2}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#3}::{async_block_env#0}, timekeeper_backend::handlers::auth::login::{async_fn#0}::{closure#4}::{async_block_env#0}\u003e"},{"line":747,"address":[19884036,19884459,19885717,19884596,19883969,19880214,19884127],"length":1,"stats":{"Line":0},"fn_name":null},{"line":748,"address":[19884985,19885753,19886763,19880235],"length":1,"stats":{"Line":0},"fn_name":null},{"line":753,"address":[19886216],"length":1,"stats":{"Line":0},"fn_name":null},{"line":756,"address":[19886541],"length":1,"stats":{"Line":0},"fn_name":null},{"line":759,"address":[18200912],"length":1,"stats":{"Line":0},"fn_name":"persist_refresh_token"},{"line":764,"address":[19876422,19876098,19876490,19876211],"length":1,"stats":{"Line":0},"fn_name":null},{"line":765,"address":[20976951],"length":1,"stats":{"Line":0},"fn_name":null},{"line":766,"address":[19876656,19876486,19876680,19876554],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":769,"address":[18201008],"length":1,"stats":{"Line":1},"fn_name":"sanitize_device_label"},{"line":770,"address":[18201020],"length":1,"stats":{"Line":2},"fn_name":null},{"line":771,"address":[19879154,19879086],"length":1,"stats":{"Line":2},"fn_name":null},{"line":772,"address":[19879213,19879278],"length":1,"stats":{"Line":2},"fn_name":null},{"line":773,"address":[19879265],"length":1,"stats":{"Line":1},"fn_name":null},{"line":775,"address":[19879299,19879244],"length":1,"stats":{"Line":2},"fn_name":null},{"line":780,"address":[18203968],"length":1,"stats":{"Line":0},"fn_name":"persist_active_access_token"},{"line":785,"address":[19907189,19907031,19907256,19907468],"length":1,"stats":{"Line":0},"fn_name":null},{"line":786,"address":[19909308,19907166,19907224,19909296],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":788,"address":[19908649,19907658,19907425,19907804,19907378,19907871,19907717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":789,"address":[19907706,19907452,19907413,19907083,19907521],"length":1,"stats":{"Line":0},"fn_name":null},{"line":790,"address":[19907839,19909344,19907781,19909360],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":792,"address":[19907941],"length":1,"stats":{"Line":0},"fn_name":null},{"line":793,"address":[19908080,19909456,19909468,19907996],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":796,"address":[19908279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":799,"address":[19908351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":801,"address":[19908949,19908574,19909053,19908482],"length":1,"stats":{"Line":0},"fn_name":null},{"line":802,"address":[20985180],"length":1,"stats":{"Line":0},"fn_name":null},{"line":803,"address":[19909117,19909200,19909184],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":806,"address":[18201264],"length":1,"stats":{"Line":0},"fn_name":"register_active_session"},{"line":818,"address":[19896824],"length":1,"stats":{"Line":0},"fn_name":null},{"line":820,"address":[19896997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":821,"address":[19897012],"length":1,"stats":{"Line":0},"fn_name":null},{"line":822,"address":[19897027],"length":1,"stats":{"Line":0},"fn_name":null},{"line":823,"address":[19897155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":824,"address":[19897219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":825,"address":[19897299],"length":1,"stats":{"Line":0},"fn_name":null},{"line":827,"address":[20979234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":828,"address":[19901072,19901088,19897812,19897745],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":831,"address":[19898078,19898001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":832,"address":[19898102,19898178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":834,"address":[19898186],"length":1,"stats":{"Line":0},"fn_name":null},{"line":835,"address":[19898430,19899479,19898319,19898271,19898724,19899451,19898357,19898654],"length":1,"stats":{"Line":0},"fn_name":null},{"line":842,"address":[19899092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":843,"address":[19899099],"length":1,"stats":{"Line":0},"fn_name":null},{"line":844,"address":[19899106],"length":1,"stats":{"Line":0},"fn_name":null},{"line":845,"address":[19899127],"length":1,"stats":{"Line":0},"fn_name":null},{"line":846,"address":[19899254],"length":1,"stats":{"Line":0},"fn_name":null},{"line":847,"address":[19899261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":849,"address":[19899381,19899429,19899625,19899806,19899903,19896929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":850,"address":[19900008],"length":1,"stats":{"Line":0},"fn_name":null},{"line":853,"address":[18200736],"length":1,"stats":{"Line":0},"fn_name":"enforce_session_limit"},{"line":861,"address":[19872648],"length":1,"stats":{"Line":0},"fn_name":null},{"line":862,"address":[19872668],"length":1,"stats":{"Line":0},"fn_name":null},{"line":863,"address":[19872795],"length":1,"stats":{"Line":0},"fn_name":null},{"line":866,"address":[19873191,19872881,19873278,19872749,19873129,19873794,19873345],"length":1,"stats":{"Line":0},"fn_name":null},{"line":867,"address":[20976562],"length":1,"stats":{"Line":0},"fn_name":null},{"line":868,"address":[19873313,19873255,19875872,19875856],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":870,"address":[19873553,19873487],"length":1,"stats":{"Line":0},"fn_name":null},{"line":871,"address":[19873591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":874,"address":[19873567,19873618,19875310],"length":1,"stats":{"Line":0},"fn_name":null},{"line":875,"address":[19875822,19873834,19875379,19873810,19872731,19875668],"length":1,"stats":{"Line":0},"fn_name":null},{"line":877,"address":[19874202,19874276],"length":1,"stats":{"Line":0},"fn_name":null},{"line":878,"address":[19874373,19874300],"length":1,"stats":{"Line":0},"fn_name":null},{"line":880,"address":[19874381,19874453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":881,"address":[19874876,19874501,19874950,19875710,19874546,19874584,19874649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":888,"address":[19875423],"length":1,"stats":{"Line":0},"fn_name":null},{"line":891,"address":[18200960],"length":1,"stats":{"Line":0},"fn_name":"revoke_active_session"},{"line":896,"address":[19876892,19877066],"length":1,"stats":{"Line":0},"fn_name":null},{"line":897,"address":[19877626,19877145,19877248,19877539,19877480,19877958,19877693],"length":1,"stats":{"Line":0},"fn_name":null},{"line":898,"address":[19877278,19877328,19876954,19877233,19877528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":899,"address":[19878832,19878848,19877661,19877603],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":900,"address":[19877766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":901,"address":[20977089],"length":1,"stats":{"Line":0},"fn_name":null},{"line":905,"address":[19878328,19878532,19877180,19878290,19878745,19878824,19878591,19878678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":906,"address":[19876996,19878313,19878580,19878358,19878381],"length":1,"stats":{"Line":0},"fn_name":null},{"line":907,"address":[19878655,19878960,19878713,19878944],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":909,"address":[19878807],"length":1,"stats":{"Line":0},"fn_name":null},{"line":922,"address":[18197376,18197809],"length":1,"stats":{"Line":0},"fn_name":null},{"line":930,"address":[18197465],"length":1,"stats":{"Line":0},"fn_name":null},{"line":931,"address":[18197489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":932,"address":[18197547],"length":1,"stats":{"Line":0},"fn_name":null},{"line":933,"address":[19833040,19833024],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":938,"address":[18201744,18203368,18203093],"length":1,"stats":{"Line":0},"fn_name":"record_session_audit_event"},{"line":945,"address":[18201810],"length":1,"stats":{"Line":0},"fn_name":null},{"line":949,"address":[18201970],"length":1,"stats":{"Line":0},"fn_name":null},{"line":950,"address":[18202064],"length":1,"stats":{"Line":0},"fn_name":null},{"line":951,"address":[18202086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":952,"address":[18202117],"length":1,"stats":{"Line":0},"fn_name":null},{"line":953,"address":[18202257,18202180],"length":1,"stats":{"Line":0},"fn_name":null},{"line":955,"address":[18202320],"length":1,"stats":{"Line":0},"fn_name":null},{"line":958,"address":[18202454],"length":1,"stats":{"Line":0},"fn_name":null},{"line":959,"address":[18202486],"length":1,"stats":{"Line":0},"fn_name":null},{"line":960,"address":[18202518],"length":1,"stats":{"Line":0},"fn_name":null},{"line":963,"address":[18202921],"length":1,"stats":{"Line":0},"fn_name":null},{"line":964,"address":[19904072,19904448,19904146,19904214,19904790],"length":1,"stats":{"Line":0},"fn_name":null},{"line":965,"address":[19904762,19905241,19904846],"length":1,"stats":{"Line":0},"fn_name":null},{"line":974,"address":[18193968],"length":1,"stats":{"Line":1},"fn_name":"extract_ip"},{"line":975,"address":[18194004],"length":1,"stats":{"Line":3},"fn_name":null},{"line":977,"address":[18194094],"length":1,"stats":{"Line":1},"fn_name":null},{"line":978,"address":[18194110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":979,"address":[18194124],"length":1,"stats":{"Line":3},"fn_name":null},{"line":980,"address":[18194139],"length":1,"stats":{"Line":3},"fn_name":null},{"line":984,"address":[19825433,19825424],"length":1,"stats":{"Line":3},"fn_name":"{closure#3}"},{"line":985,"address":[19825520,19825472],"length":1,"stats":{"Line":3},"fn_name":"{closure#4}"},{"line":986,"address":[19825721,19825712],"length":1,"stats":{"Line":3},"fn_name":"{closure#5}"},{"line":989,"address":[18200448],"length":1,"stats":{"Line":1},"fn_name":"extract_user_agent"},{"line":990,"address":[18200478],"length":1,"stats":{"Line":1},"fn_name":null},{"line":991,"address":[18200526],"length":1,"stats":{"Line":1},"fn_name":null},{"line":992,"address":[18200540],"length":1,"stats":{"Line":3},"fn_name":null},{"line":993,"address":[19867168,19867216],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":994,"address":[18200563],"length":1,"stats":{"Line":3},"fn_name":null},{"line":998,"address":[18194304],"length":1,"stats":{"Line":1},"fn_name":null},{"line":999,"address":[18194368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1000,"address":[19826224,19826208],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":1003,"address":[18195957,18196055,18194432],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1004,"address":[18194537,18194668,18194483],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1005,"address":[19826320,19826336],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":1006,"address":[18194992,18194870,18194946,18195064,18195998],"length":1,"stats":{"Line":3},"fn_name":null},{"line":1007,"address":[18194969,18195032],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1008,"address":[18195412,18195185,18195340],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1009,"address":[18195253],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1010,"address":[18195317,18195380],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1011,"address":[18195696],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1012,"address":[18195504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1013,"address":[18195538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1014,"address":[18195609],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1015,"address":[18195648],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1021,"address":[18199669,18198464,18199644],"length":1,"stats":{"Line":1},"fn_name":"set_auth_cookies"},{"line":1023,"address":[18198535],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1024,"address":[18198548],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1026,"address":[18198578,18198690],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1027,"address":[18198711,18198968,18198660],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1031,"address":[18198833],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1038,"address":[18198947],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1043,"address":[18199126,18199650,18199189],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1044,"address":[18199407,18199344,18199625],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1047,"address":[18199696,18200406,18200428],"length":1,"stats":{"Line":1},"fn_name":"clear_auth_cookies"},{"line":1049,"address":[18199740],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1050,"address":[18199767],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1052,"address":[18199783,18199756],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1053,"address":[18199832],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1054,"address":[18200412,18199915,18199972],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1055,"address":[18200387,18200181,18200121],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1058,"address":[18200592],"length":1,"stats":{"Line":1},"fn_name":"cookie_header_value"},{"line":1059,"address":[19867296,19867305],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":1062,"address":[18201168],"length":1,"stats":{"Line":1},"fn_name":"ensure_password_matches"},{"line":1067,"address":[19894642,19894749],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1068,"address":[19894758],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1069,"address":[19896043,19895404,19895760,19895268,19895201,19895747,19894919,19894809,19895471,19895087,19895130,19896016],"length":1,"stats":{"Line":8},"fn_name":"{closure#0}"},{"line":1070,"address":[19894928,19894974,19894676,19894897,19895119],"length":1,"stats":{"Line":4},"fn_name":null},{"line":1071,"address":[19895808,19895178,19895792,19895236],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":1072,"address":[19895439,19895920,19895904,19895381],"length":1,"stats":{"Line":1},"fn_name":"{closure#2}"},{"line":1073,"address":[19895555,19895598],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1074,"address":[19895586],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1076,"address":[19895600,19895564],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1080,"address":[18197190,18197196,18196096],"length":1,"stats":{"Line":1},"fn_name":"enforce_mfa"},{"line":1081,"address":[18196160],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1082,"address":[18196174],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1084,"address":[18196248,18196384],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1085,"address":[18196193],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1086,"address":[19826896],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1087,"address":[19827136,19826907,19827150],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":1088,"address":[19826920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1090,"address":[19826953,19826944],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":1091,"address":[19827088,19827100],"length":1,"stats":{"Line":4},"fn_name":"{closure#2}"},{"line":1092,"address":[18196633,18196705,18196536,18197188],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1095,"address":[19826800,19826812],"length":1,"stats":{"Line":1},"fn_name":"{closure#3}"},{"line":1096,"address":[18197170,18197100,18196778],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1097,"address":[18197093],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1099,"address":[18197107,18197061],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1103,"address":[18203408],"length":1,"stats":{"Line":1},"fn_name":"enforce_password_expiration"},{"line":1104,"address":[18203451],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1105,"address":[18203608],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1107,"address":[18203677,18203475,18203558],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1109,"address":[18203510],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1110,"address":[18203503],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1112,"address":[18203625,18203543],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1113,"address":[18203862,18203814],"length":1,"stats":{"Line":2},"fn_name":null},{"line":1114,"address":[18203864],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1116,"address":[18203855],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1120,"address":[18201648],"length":1,"stats":{"Line":1},"fn_name":"ensure_password_not_reused"},{"line":1127,"address":[19901352],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1128,"address":[19901456],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1130,"address":[19901420,19901546,19901893,19901834,19902047,19902507,19901980],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1131,"address":[20983711],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1132,"address":[19902015,19903440,19901957,19903424],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":1133,"address":[19902256,19902182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1134,"address":[19902260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1135,"address":[19903261,19903648,19902762,19902648,19903960,19902965,19902829,19902482,19902691,19902327,19903245,19903032],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":1136,"address":[19903670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1137,"address":[19903687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1138,"address":[19903775],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1140,"address":[20983726],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1141,"address":[19903312,19902739,19903328,19902797],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":1142,"address":[20983828,20983792],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1144,"address":[19903243,19903116,19903132],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1145,"address":[19903179,19903134],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1147,"address":[19903120],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1390,"address":[19826592,19826704],"length":1,"stats":{"Line":0},"fn_name":"bad_request\u003calloc::string::String\u003e"},{"line":1391,"address":[19826606,19826727],"length":1,"stats":{"Line":0},"fn_name":null},{"line":1394,"address":[19840416],"length":1,"stats":{"Line":1},"fn_name":"unauthorized\u003c\u0026str\u003e"},{"line":1395,"address":[19840439],"length":1,"stats":{"Line":1},"fn_name":null},{"line":1398,"address":[19840742,19840771,19840512],"length":1,"stats":{"Line":0},"fn_name":"internal_error\u003c\u0026str\u003e"},{"line":1399,"address":[19840539,19840755,19840612],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":106,"coverable":596},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","config.rs"],"content":"use axum::{extract::State, Json};\nuse serde::Serialize;\n\nuse crate::state::AppState;\n\n#[derive(Serialize)]\npub struct TimeZoneResponse {\n    pub time_zone: String,\n}\n\npub async fn get_time_zone(State(state): State\u003cAppState\u003e) -\u003e Json\u003cTimeZoneResponse\u003e {\n    Json(TimeZoneResponse {\n        time_zone: state.config.time_zone.to_string(),\n    })\n}\n","traces":[{"line":11,"address":[18078256,18078273],"length":1,"stats":{"Line":0},"fn_name":"get_time_zone"},{"line":12,"address":[19562912],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[19562830],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":3},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","consents.rs"],"content":"use axum::{\n    extract::{Extension, State},\n    http::{header::USER_AGENT, HeaderMap, StatusCode},\n    Json,\n};\nuse serde_json::{json, Value};\nuse uuid::Uuid;\n\nuse crate::{\n    middleware::request_id::RequestId,\n    models::{\n        consent_log::{ConsentLog, ConsentLogResponse, RecordConsentPayload},\n        user::User,\n    },\n    repositories::consent_log,\n    state::AppState,\n    utils::time,\n};\n\nconst MAX_PURPOSE_LENGTH: usize = 200;\nconst MAX_POLICY_VERSION_LENGTH: usize = 100;\n\npub async fn record_consent(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(request_id): Extension\u003cRequestId\u003e,\n    headers: HeaderMap,\n    Json(payload): Json\u003cRecordConsentPayload\u003e,\n) -\u003e Result\u003cJson\u003cConsentLogResponse\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    let purpose = validate_string_field(\u0026payload.purpose, \"purpose\", MAX_PURPOSE_LENGTH)?;\n    let policy_version = validate_string_field(\n        \u0026payload.policy_version,\n        \"policy_version\",\n        MAX_POLICY_VERSION_LENGTH,\n    )?;\n    let now = time::now_utc(\u0026state.config.time_zone);\n\n    let log = ConsentLog {\n        id: Uuid::new_v4().to_string(),\n        user_id: user.id.to_string(),\n        purpose,\n        policy_version,\n        consented_at: now,\n        ip: extract_ip(\u0026headers),\n        user_agent: extract_user_agent(\u0026headers),\n        request_id: Some(request_id.0),\n        created_at: now,\n    };\n\n    consent_log::insert_consent_log(\u0026state.write_pool, \u0026log)\n        .await\n        .map_err(|err| {\n            tracing::error!(error = %err, \"failed to insert consent log\");\n            (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                Json(json!({\"error\": \"Database error\"})),\n            )\n        })?;\n\n    Ok(Json(log.into()))\n}\n\npub async fn list_my_consents(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cConsentLogResponse\u003e\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    let user_id = user.id.to_string();\n    let logs = consent_log::list_consent_logs_for_user(state.read_pool(), \u0026user_id)\n        .await\n        .map_err(|err| {\n            tracing::error!(error = %err, \"failed to list consent logs\");\n            (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                Json(json!({\"error\": \"Database error\"})),\n            )\n        })?;\n\n    Ok(Json(\n        logs.into_iter().map(ConsentLogResponse::from).collect(),\n    ))\n}\n\nfn validate_string_field(\n    value: \u0026str,\n    field: \u0026str,\n    max_len: usize,\n) -\u003e Result\u003cString, (StatusCode, Json\u003cValue\u003e)\u003e {\n    let trimmed = value.trim();\n    if trimmed.is_empty() {\n        return Err((\n            StatusCode::BAD_REQUEST,\n            Json(json!({\"error\": format!(\"{} is required\", field)})),\n        ));\n    }\n    if trimmed.chars().count() \u003e max_len {\n        return Err((\n            StatusCode::BAD_REQUEST,\n            Json(json!({\"error\": format!(\"{} is too long\", field)})),\n        ));\n    }\n    Ok(trimmed.to_string())\n}\n\nfn extract_ip(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    if let Some(value) = headers.get(\"x-forwarded-for\").and_then(|v| v.to_str().ok()) {\n        return value\n            .split(',')\n            .next()\n            .map(|ip| ip.trim().to_string())\n            .filter(|ip| !ip.is_empty());\n    }\n    headers\n        .get(\"x-real-ip\")\n        .and_then(|v| v.to_str().ok())\n        .map(|ip| ip.trim().to_string())\n        .filter(|ip| !ip.is_empty())\n}\n\nfn extract_user_agent(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    headers\n        .get(USER_AGENT)\n        .and_then(|v| v.to_str().ok())\n        .map(|agent| agent.trim().to_string())\n        .filter(|agent| !agent.is_empty())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn validate_string_field_accepts_valid_value() {\n        let result = validate_string_field(\"valid purpose\", \"purpose\", 200);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"valid purpose\");\n    }\n\n    #[test]\n    fn validate_string_field_trims_whitespace() {\n        let result = validate_string_field(\"  test  \", \"purpose\", 200);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"test\");\n    }\n\n    #[test]\n    fn validate_string_field_rejects_empty() {\n        let result = validate_string_field(\"\", \"purpose\", 200);\n        assert!(result.is_err());\n        let (status, _) = result.unwrap_err();\n        assert_eq!(status, StatusCode::BAD_REQUEST);\n    }\n\n    #[test]\n    fn validate_string_field_rejects_whitespace_only() {\n        let result = validate_string_field(\"   \", \"purpose\", 200);\n        assert!(result.is_err());\n        let (status, _) = result.unwrap_err();\n        assert_eq!(status, StatusCode::BAD_REQUEST);\n    }\n\n    #[test]\n    fn validate_string_field_rejects_too_long() {\n        let long_value = \"a\".repeat(201);\n        let result = validate_string_field(\u0026long_value, \"purpose\", 200);\n        assert!(result.is_err());\n        let (status, _) = result.unwrap_err();\n        assert_eq!(status, StatusCode::BAD_REQUEST);\n    }\n\n    #[test]\n    fn validate_string_field_accepts_max_length() {\n        let max_value = \"a\".repeat(200);\n        let result = validate_string_field(\u0026max_value, \"purpose\", 200);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn extract_ip_from_x_forwarded_for() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-forwarded-for\", \"203.0.113.195, 70.41.3.18\".parse().unwrap());\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, Some(\"203.0.113.195\".to_string()));\n    }\n\n    #[test]\n    fn extract_ip_from_x_real_ip() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-real-ip\", \"192.168.1.100\".parse().unwrap());\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, Some(\"192.168.1.100\".to_string()));\n    }\n\n    #[test]\n    fn extract_ip_prefers_x_forwarded_for() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-forwarded-for\", \"203.0.113.195\".parse().unwrap());\n        headers.insert(\"x-real-ip\", \"192.168.1.100\".parse().unwrap());\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, Some(\"203.0.113.195\".to_string()));\n    }\n\n    #[test]\n    fn extract_ip_returns_none_when_missing() {\n        let headers = HeaderMap::new();\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, None);\n    }\n\n    #[test]\n    fn extract_user_agent_from_header() {\n        let mut headers = HeaderMap::new();\n        headers.insert(USER_AGENT, \"Mozilla/5.0\".parse().unwrap());\n        \n        let result = extract_user_agent(\u0026headers);\n        \n        assert_eq!(result, Some(\"Mozilla/5.0\".to_string()));\n    }\n\n    #[test]\n    fn extract_user_agent_returns_none_when_missing() {\n        let headers = HeaderMap::new();\n        \n        let result = extract_user_agent(\u0026headers);\n        \n        assert_eq!(result, None);\n    }\n}\n","traces":[{"line":23,"address":[20601664],"length":1,"stats":{"Line":0},"fn_name":"record_consent"},{"line":30,"address":[22866929,22868716,22866808],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[22867222],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[22867601],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[22867723,22867668],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[22867755],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[22867901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22867972],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[22868043],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[22868490,22869171,22868395,22869085,22868936,22868998],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[22868478,22868520,22868778,22866855,22868984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[22869062,22870048,22872039],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":53,"address":[22870166,22870079,22870534],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[22871504,22870524,22872017],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[22869257],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[20601856],"length":1,"stats":{"Line":0},"fn_name":"list_my_consents"},{"line":67,"address":[22872662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[22873149,22872772,22873211,22873384,22872849,22872931,22873298],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[22872961,22872919,22872713,22873010,22873197],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[22873275,22874064,22876055],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":71,"address":[22874550,22874095,22874182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[22875520,22874540,22876033],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[22873692],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[22873657,22873537],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[20602080,20603200,20603206],"length":1,"stats":{"Line":1},"fn_name":"validate_string_field"},{"line":88,"address":[20602162],"length":1,"stats":{"Line":1},"fn_name":null},{"line":89,"address":[20602215],"length":1,"stats":{"Line":1},"fn_name":null},{"line":90,"address":[20603846],"length":1,"stats":{"Line":1},"fn_name":null},{"line":92,"address":[20602270,20603219,20603934,20603468],"length":1,"stats":{"Line":1},"fn_name":null},{"line":95,"address":[20602234],"length":1,"stats":{"Line":1},"fn_name":null},{"line":96,"address":[20603081],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[20603178,20602395,20602451,20602703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[20602326],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[20601392],"length":1,"stats":{"Line":1},"fn_name":"extract_ip"},{"line":105,"address":[22866185,22866176],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":107,"address":[20601518],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[20601534],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[20601548],"length":1,"stats":{"Line":3},"fn_name":null},{"line":110,"address":[22866281,22866272],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":114,"address":[20601600],"length":1,"stats":{"Line":3},"fn_name":null},{"line":115,"address":[20601608],"length":1,"stats":{"Line":3},"fn_name":null},{"line":116,"address":[20601626],"length":1,"stats":{"Line":3},"fn_name":null},{"line":119,"address":[20601936],"length":1,"stats":{"Line":1},"fn_name":"extract_user_agent"},{"line":120,"address":[20601966],"length":1,"stats":{"Line":1},"fn_name":null},{"line":121,"address":[20602014],"length":1,"stats":{"Line":1},"fn_name":null},{"line":122,"address":[20602028],"length":1,"stats":{"Line":3},"fn_name":null},{"line":123,"address":[20602036],"length":1,"stats":{"Line":3},"fn_name":null},{"line":124,"address":[20602051],"length":1,"stats":{"Line":3},"fn_name":null}],"covered":24,"coverable":48},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","holiday_exceptions.rs"],"content":"use std::str::FromStr;\nuse std::sync::Arc;\n\nuse axum::{\n    extract::{Extension, Path, Query, State},\n    http::StatusCode,\n    Json,\n};\nuse chrono::NaiveDate;\n\nuse crate::{\n    error::AppError,\n    models::{\n        holiday_exception::{CreateHolidayExceptionPayload, HolidayExceptionResponse},\n        user::User,\n    },\n    services::holiday_exception::{HolidayExceptionError, HolidayExceptionServiceTrait},\n    state::AppState,\n    types::{HolidayExceptionId, UserId},\n};\n\n#[derive(Debug, serde::Deserialize)]\npub struct HolidayExceptionQuery {\n    pub from: Option\u003cNaiveDate\u003e,\n    pub to: Option\u003cNaiveDate\u003e,\n}\n\npub async fn create_holiday_exception(\n    State(_state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(service): Extension\u003cArc\u003cdyn HolidayExceptionServiceTrait\u003e\u003e,\n    Path(target_user_id): Path\u003cString\u003e,\n    Json(payload): Json\u003cCreateHolidayExceptionPayload\u003e,\n) -\u003e Result\u003c(StatusCode, Json\u003cHolidayExceptionResponse\u003e), AppError\u003e {\n    ensure_admin_or_system(\u0026user)?;\n\n    let user_id = UserId::from_str(\u0026target_user_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid user ID format\".into()))?;\n\n    let created = service\n        .create_workday_override(user_id, payload, user.id)\n        .await\n        .map_err(holiday_exception_error_to_app_error)?;\n\n    Ok((\n        StatusCode::CREATED,\n        Json(HolidayExceptionResponse::from(created)),\n    ))\n}\n\npub async fn list_holiday_exceptions(\n    State(_state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(service): Extension\u003cArc\u003cdyn HolidayExceptionServiceTrait\u003e\u003e,\n    Path(target_user_id): Path\u003cString\u003e,\n    Query(query): Query\u003cHolidayExceptionQuery\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cHolidayExceptionResponse\u003e\u003e, AppError\u003e {\n    ensure_admin_or_system(\u0026user)?;\n\n    let user_id = UserId::from_str(\u0026target_user_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid user ID format\".into()))?;\n\n    let exceptions = service\n        .list_for_user(user_id, query.from, query.to)\n        .await\n        .map_err(holiday_exception_error_to_app_error)?;\n\n    let response = exceptions\n        .into_iter()\n        .map(HolidayExceptionResponse::from)\n        .collect();\n\n    Ok(Json(response))\n}\n\npub async fn delete_holiday_exception(\n    State(_state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(service): Extension\u003cArc\u003cdyn HolidayExceptionServiceTrait\u003e\u003e,\n    Path((target_user_id, id)): Path\u003c(String, String)\u003e,\n) -\u003e Result\u003cStatusCode, AppError\u003e {\n    ensure_admin_or_system(\u0026user)?;\n\n    let exception_id = HolidayExceptionId::from_str(\u0026id)\n        .map_err(|_| AppError::BadRequest(\"Invalid exception ID format\".into()))?;\n    let user_id = UserId::from_str(\u0026target_user_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid user ID format\".into()))?;\n\n    service\n        .delete_for_user(exception_id, user_id)\n        .await\n        .map_err(holiday_exception_error_to_app_error)?;\n\n    Ok(StatusCode::NO_CONTENT)\n}\n\nfn holiday_exception_error_to_app_error(error: HolidayExceptionError) -\u003e AppError {\n    match error {\n        HolidayExceptionError::Conflict =\u003e {\n            AppError::Conflict(\"Holiday exception already exists for this date\".into())\n        }\n        HolidayExceptionError::NotFound =\u003e AppError::NotFound(\"Holiday exception not found\".into()),\n        HolidayExceptionError::UserNotFound =\u003e AppError::NotFound(\"User not found\".into()),\n        HolidayExceptionError::Database(err) =\u003e AppError::InternalServerError(err.into()),\n    }\n}\n\nfn ensure_admin_or_system(user: \u0026User) -\u003e Result\u003c(), AppError\u003e {\n    if user.is_admin() || user.is_system_admin() {\n        Ok(())\n    } else {\n        Err(AppError::Forbidden(\"Forbidden\".into()))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::models::user::UserRole;\n\n    #[test]\n    fn map_exception_error_handles_user_not_found() {\n        let err = holiday_exception_error_to_app_error(HolidayExceptionError::UserNotFound);\n        match err {\n            AppError::NotFound(msg) =\u003e assert_eq!(msg, \"User not found\"),\n            _ =\u003e panic!(\"Expected NotFound\"),\n        }\n    }\n\n    #[test]\n    fn map_exception_error_handles_not_found() {\n        let err = holiday_exception_error_to_app_error(HolidayExceptionError::NotFound);\n        match err {\n            AppError::NotFound(msg) =\u003e assert_eq!(msg, \"Holiday exception not found\"),\n            _ =\u003e panic!(\"Expected NotFound\"),\n        }\n    }\n\n    #[test]\n    fn map_exception_error_handles_conflict() {\n        let err = holiday_exception_error_to_app_error(HolidayExceptionError::Conflict);\n        match err {\n            AppError::Conflict(msg) =\u003e assert_eq!(msg, \"Holiday exception already exists for this date\"),\n            _ =\u003e panic!(\"Expected Conflict\"),\n        }\n    }\n\n    #[test]\n    fn map_exception_error_handles_database_error() {\n        let db_err = sqlx::Error::PoolTimedOut;\n        let err = holiday_exception_error_to_app_error(HolidayExceptionError::Database(db_err));\n        match err {\n            AppError::InternalServerError(_) =\u003e (),\n            _ =\u003e panic!(\"Expected InternalServerError\"),\n        }\n    }\n\n    #[test]\n    fn ensure_admin_or_system_allows_admin() {\n        let now = chrono::Utc::now();\n        let admin_user = User {\n            id: UserId::new(),\n            username: \"admin\".to_string(),\n            password_hash: \"hash\".to_string(),\n            full_name: \"Admin\".to_string(),\n            email: \"admin@example.com\".to_string(),\n            role: UserRole::Admin,\n            is_system_admin: false,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: now,\n            created_at: now,\n            updated_at: now,\n        };\n\n        let result = ensure_admin_or_system(\u0026admin_user);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn ensure_admin_or_system_allows_system_admin() {\n        let now = chrono::Utc::now();\n        let system_admin = User {\n            id: UserId::new(),\n            username: \"sysadmin\".to_string(),\n            password_hash: \"hash\".to_string(),\n            full_name: \"System Admin\".to_string(),\n            email: \"sysadmin@example.com\".to_string(),\n            role: UserRole::Employee,\n            is_system_admin: true,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: now,\n            created_at: now,\n            updated_at: now,\n        };\n\n        let result = ensure_admin_or_system(\u0026system_admin);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn ensure_admin_or_system_rejects_regular_user() {\n        let now = chrono::Utc::now();\n        let user = User {\n            id: UserId::new(),\n            username: \"user\".to_string(),\n            password_hash: \"hash\".to_string(),\n            full_name: \"User\".to_string(),\n            email: \"user@example.com\".to_string(),\n            role: UserRole::Employee,\n            is_system_admin: false,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: now,\n            created_at: now,\n            updated_at: now,\n        };\n\n        let result = ensure_admin_or_system(\u0026user);\n        assert!(result.is_err());\n        match result.unwrap_err() {\n            AppError::Forbidden(msg) =\u003e assert_eq!(msg, \"Forbidden\"),\n            _ =\u003e panic!(\"Expected Forbidden error\"),\n        }\n    }\n}\n","traces":[{"line":28,"address":[21853088],"length":1,"stats":{"Line":0},"fn_name":"create_holiday_exception"},{"line":35,"address":[21680041,21679262,21679373],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[21679598,21680016,21679510,21679665],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[21679633,21681790,21679575,21681776],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":40,"address":[21680509,21680358,21680585,21679751,21679879,21680232,21679979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[21679825,21679923],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[21679998,21680074,21680344,21679299,21679947],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[21680553,21680486],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[21681119],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[21681071,21680882],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[21852864],"length":1,"stats":{"Line":0},"fn_name":"list_holiday_exceptions"},{"line":58,"address":[21677473,21676730,21676847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[21676987,21677075,21677442,21677142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[21677110,21678734,21678720,21677052],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":63,"address":[21677401,21677667,21677816,21677883,21677314,21677729,21677231],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[21677342],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[21677366,21677423,21677509,21676767,21677715],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[21677793,21677851],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[21678020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[21678140],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[21678178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[21853312],"length":1,"stats":{"Line":0},"fn_name":"delete_holiday_exception"},{"line":82,"address":[21682303,21683266,21682420],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21682715,21682648,21682560,21683264],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[21684400,21682683,21682625,21684414],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":86,"address":[21682959,21683233,21682892,21682804],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[21684304,21682869,21682927,21684318],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":89,"address":[21683193,21683608,21683048,21683459,21684196,21683521,21683675],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21683134],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[21683215,21683507,21683158,21682340,21683302],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[21683585,21683643],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[21683748],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[21853472],"length":1,"stats":{"Line":1},"fn_name":"holiday_exception_error_to_app_error"},{"line":98,"address":[21853493],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[21853562],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[21853636],"length":1,"stats":{"Line":1},"fn_name":null},{"line":103,"address":[21853710],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[21853785],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[21852672],"length":1,"stats":{"Line":1},"fn_name":"ensure_admin_or_system"},{"line":109,"address":[21852702,21852738],"length":1,"stats":{"Line":2},"fn_name":null},{"line":110,"address":[21852731],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[21852740],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":10,"coverable":42},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","holidays.rs"],"content":"use axum::{\n    extract::{Extension, Query, State},\n    Json,\n};\nuse chrono::{Datelike, NaiveDate};\nuse reqwest::Client;\nuse serde::{Deserialize, Serialize};\nuse std::sync::Arc;\n\nuse crate::{\n    error::AppError,\n    models::{\n        holiday::{CreateHolidayPayload, HolidayResponse},\n        user::User,\n    },\n    repositories::repository::Repository,\n    repositories::holiday::{HolidayRepository, HolidayRepositoryTrait},\n    services::holiday::HolidayServiceTrait,\n    state::AppState,\n};\n\nconst GOOGLE_JP_HOLIDAY_ICS: \u0026str =\n    \"https://calendar.google.com/calendar/ical/japanese__ja%40holiday.calendar.google.com/public/basic.ics\";\nconst HOLIDAY_DESCRIPTION_PREFIX: \u0026str = \"\\u{795d}\\u{65e5}\"; // Japanese word for \"holiday\"\n\npub async fn list_public_holidays(\n    State(state): State\u003cAppState\u003e,\n    Extension(_user): Extension\u003cUser\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cHolidayResponse\u003e\u003e, AppError\u003e {\n    let repo = HolidayRepository::new();\n    let holidays = repo.find_all(state.read_pool()).await?;\n\n    Ok(Json(\n        holidays\n            .into_iter()\n            .map(HolidayResponse::from)\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n    ))\n}\n\n#[derive(Debug, Deserialize)]\npub struct GoogleHolidayQuery {\n    pub year: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct HolidayCheckQuery {\n    pub date: NaiveDate,\n}\n\n#[derive(Debug, Deserialize)]\npub struct HolidayMonthQuery {\n    pub year: i32,\n    pub month: u32,\n}\n\n#[derive(Debug, Serialize)]\npub struct HolidayCheckResponse {\n    pub is_holiday: bool,\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct HolidayMonthEntry {\n    pub date: NaiveDate,\n    pub reason: String,\n}\n\npub async fn fetch_google_holidays(\n    State(_state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Query(params): Query\u003cGoogleHolidayQuery\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cCreateHolidayPayload\u003e\u003e, AppError\u003e {\n    if !user.is_admin() {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    let client = Client::builder()\n        .user_agent(\"timekeeper-backend/1.0\")\n        .build()\n        .map_err(|e: reqwest::Error| {\n            AppError::InternalServerError(anyhow::anyhow!(\n                \"Failed to initialize HTTP client: {}\",\n                e\n            ))\n        })?;\n\n    let resp: reqwest::Response =\n        client\n            .get(GOOGLE_JP_HOLIDAY_ICS)\n            .send()\n            .await\n            .map_err(|e: reqwest::Error| {\n                AppError::InternalServerError(anyhow::anyhow!(\n                    \"Failed to fetch Google Calendar: {}\",\n                    e\n                ))\n            })?;\n\n    let response_text = resp.text().await.map_err(|e: reqwest::Error| {\n        AppError::InternalServerError(anyhow::anyhow!(\"Failed to read Google Calendar: {}\", e))\n    })?;\n\n    let parsed = parse_google_calendar_ics(\u0026response_text, params.year);\n    Ok(Json(parsed))\n}\n\npub async fn check_holiday(\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(holiday_service): Extension\u003cArc\u003cdyn HolidayServiceTrait\u003e\u003e,\n    Query(query): Query\u003cHolidayCheckQuery\u003e,\n) -\u003e Result\u003cJson\u003cHolidayCheckResponse\u003e, AppError\u003e {\n    let decision = holiday_service\n        .is_holiday(query.date, Some(\u0026user.id.to_string()))\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let reason = if decision.is_holiday {\n        Some(decision.reason.label().to_string())\n    } else {\n        None\n    };\n\n    Ok(Json(HolidayCheckResponse {\n        is_holiday: decision.is_holiday,\n        reason,\n    }))\n}\n\npub async fn list_month_holidays(\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(holiday_service): Extension\u003cArc\u003cdyn HolidayServiceTrait\u003e\u003e,\n    Query(query): Query\u003cHolidayMonthQuery\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cHolidayMonthEntry\u003e\u003e, AppError\u003e {\n    if !(1..=12).contains(\u0026query.month) {\n        return Err(AppError::BadRequest(\n            \"Month must be between 1 and 12\".into(),\n        ));\n    }\n\n    let entries = holiday_service\n        .list_month(query.year, query.month, Some(\u0026user.id.to_string()))\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    let response = entries\n        .into_iter()\n        .map(|entry| HolidayMonthEntry {\n            date: entry.date,\n            reason: entry.reason.label().to_string(),\n        })\n        .collect();\n\n    Ok(Json(response))\n}\n\nfn parse_google_calendar_ics(content: \u0026str, year_filter: Option\u003ci32\u003e) -\u003e Vec\u003cCreateHolidayPayload\u003e {\n    let mut unfolded: Vec\u003cString\u003e = Vec::new();\n    for line in content.lines() {\n        if let Some(last) = unfolded.last_mut() {\n            if line.starts_with(' ') || line.starts_with('\\t') {\n                last.push_str(line.trim_start());\n                continue;\n            }\n        }\n        unfolded.push(line.to_string());\n    }\n\n    let mut events = Vec::new();\n    let mut current_date: Option\u003cNaiveDate\u003e = None;\n    let mut summary: Option\u003cString\u003e = None;\n    let mut description: Option\u003cString\u003e = None;\n\n    for line in unfolded {\n        if line.starts_with(\"BEGIN:VEVENT\") {\n            current_date = None;\n            summary = None;\n            description = None;\n        } else if line.starts_with(\"DTSTART\") {\n            if let Some(pos) = line.find(':') {\n                let value = \u0026line[pos + 1..];\n                if let Ok(date) = NaiveDate::parse_from_str(value, \"%Y%m%d\") {\n                    current_date = Some(date);\n                }\n            }\n        } else if let Some(stripped) = line.strip_prefix(\"SUMMARY:\") {\n            summary = Some(decode_ics_text(stripped));\n        } else if let Some(stripped) = line.strip_prefix(\"DESCRIPTION:\") {\n            description = Some(decode_ics_text(stripped));\n        } else if line.starts_with(\"END:VEVENT\") {\n            if let (Some(date), Some(name)) = (current_date, summary.clone()) {\n                if year_filter.map(|y| date.year() == y).unwrap_or(true) {\n                    let normalized_description = description.clone().and_then(|d| {\n                        let trimmed = d.trim();\n                        if trimmed.is_empty() {\n                            None\n                        } else {\n                            Some(trimmed.to_string())\n                        }\n                    });\n\n                    let is_public_holiday = normalized_description\n                        .as_deref()\n                        .map(|desc| desc.starts_with(HOLIDAY_DESCRIPTION_PREFIX))\n                        .unwrap_or(false);\n\n                    if is_public_holiday {\n                        events.push(CreateHolidayPayload {\n                            holiday_date: date,\n                            name: name.trim().to_string(),\n                            description: normalized_description,\n                        });\n                    } else {\n                        tracing::debug!(\n                            \"Skipping non-holiday calendar event: {} ({:?})\",\n                            name,\n                            normalized_description\n                        );\n                    }\n                }\n            }\n            current_date = None;\n            summary = None;\n            description = None;\n        }\n    }\n\n    events.sort_by_key(|h| (h.holiday_date, h.name.clone()));\n    events\n}\n\nfn decode_ics_text(raw: \u0026str) -\u003e String {\n    raw.replace(\"\\\\n\", \"\\n\")\n        .replace(\"\\\\,\", \",\")\n        .replace(\"\\\\;\", \";\")\n        .replace(\"\\\\\\\\\", \"\\\\\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn decode_ics_text_decodes_newlines() {\n        let input = \"Line1\\\\nLine2\";\n        let result = decode_ics_text(input);\n        assert_eq!(result, \"Line1\\nLine2\");\n    }\n\n    #[test]\n    fn decode_ics_text_decodes_commas() {\n        let input = \"Value\\\\,With\\\\,Commas\";\n        let result = decode_ics_text(input);\n        assert_eq!(result, \"Value,With,Commas\");\n    }\n\n    #[test]\n    fn decode_ics_text_decodes_semicolons() {\n        let input = \"Value\\\\;With\\\\;Semicolons\";\n        let result = decode_ics_text(input);\n        assert_eq!(result, \"Value;With;Semicolons\");\n    }\n\n    #[test]\n    fn decode_ics_text_decodes_backslashes() {\n        let input = \"Value\\\\\\\\With\\\\\\\\Backslash\";\n        let result = decode_ics_text(input);\n        assert_eq!(result, \"Value\\\\With\\\\Backslash\");\n    }\n\n    #[test]\n    fn decode_ics_text_decodes_mixed() {\n        let input = \"Line1\\\\nLine2\\\\,with\\\\;special\\\\\\\\chars\";\n        let result = decode_ics_text(input);\n        assert_eq!(result, \"Line1\\nLine2,with;special\\\\chars\");\n    }\n\n    #[test]\n    fn parse_google_calendar_ics_extracts_holiday_events() {\n        let ics_content = r#\"BEGIN:VCALENDAR\nBEGIN:VEVENT\nDTSTART:20240101\nSUMMARY:元日\nDESCRIPTION:祝日\nEND:VEVENT\nBEGIN:VEVENT\nDTSTART:20240108\nSUMMARY:成人の日\nDESCRIPTION:祝日\nEND:VEVENT\nEND:VCALENDAR\"#;\n\n        let result = parse_google_calendar_ics(ics_content, None);\n        \n        assert_eq!(result.len(), 2);\n        assert_eq!(result[0].name, \"元日\");\n        assert_eq!(result[0].holiday_date, NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert_eq!(result[1].name, \"成人の日\");\n        assert_eq!(result[1].holiday_date, NaiveDate::from_ymd_opt(2024, 1, 8).unwrap());\n    }\n\n    #[test]\n    fn parse_google_calendar_ics_filters_by_year() {\n        let ics_content = r#\"BEGIN:VCALENDAR\nBEGIN:VEVENT\nDTSTART:20230101\nSUMMARY:元日 2023\nDESCRIPTION:祝日\nEND:VEVENT\nBEGIN:VEVENT\nDTSTART:20240101\nSUMMARY:元日 2024\nDESCRIPTION:祝日\nEND:VEVENT\nEND:VCALENDAR\"#;\n\n        let result = parse_google_calendar_ics(ics_content, Some(2024));\n        \n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].name, \"元日 2024\");\n    }\n\n    #[test]\n    fn parse_google_calendar_ics_skips_non_holiday_events() {\n        let ics_content = r#\"BEGIN:VCALENDAR\nBEGIN:VEVENT\nDTSTART:20240101\nSUMMARY:Regular Meeting\nDESCRIPTION:Some other event\nEND:VEVENT\nBEGIN:VEVENT\nDTSTART:20240108\nSUMMARY:成人の日\nDESCRIPTION:祝日\nEND:VEVENT\nEND:VCALENDAR\"#;\n\n        let result = parse_google_calendar_ics(ics_content, None);\n        \n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].name, \"成人の日\");\n    }\n\n    #[test]\n    fn parse_google_calendar_ics_handles_continuation_lines() {\n        let ics_content = r#\"BEGIN:VCALENDAR\nBEGIN:VEVENT\nDTSTART:20240101\nSUMMARY:Very Long Holiday\n Name That Continues\nDESCRIPTION:祝日\nEND:VEVENT\nEND:VCALENDAR\"#;\n\n        let result = parse_google_calendar_ics(ics_content, None);\n        \n        assert_eq!(result.len(), 1);\n        // ICS continuation lines concatenate without adding a space\n        assert_eq!(result[0].name, \"Very Long HolidayName That Continues\");\n    }\n\n    #[test]\n    fn parse_google_calendar_ics_sorts_by_date() {\n        let ics_content = r#\"BEGIN:VCALENDAR\nBEGIN:VEVENT\nDTSTART:20241225\nSUMMARY:Christmas\nDESCRIPTION:祝日\nEND:VEVENT\nBEGIN:VEVENT\nDTSTART:20240101\nSUMMARY:元日\nDESCRIPTION:祝日\nEND:VEVENT\nBEGIN:VEVENT\nDTSTART:20240704\nSUMMARY:Independence Day\nDESCRIPTION:祝日\nEND:VEVENT\nEND:VCALENDAR\"#;\n\n        let result = parse_google_calendar_ics(ics_content, None);\n        \n        assert_eq!(result.len(), 3);\n        assert_eq!(result[0].name, \"元日\");\n        assert_eq!(result[1].name, \"Independence Day\");\n        assert_eq!(result[2].name, \"Christmas\");\n    }\n}\n","traces":[{"line":26,"address":[22656672],"length":1,"stats":{"Line":0},"fn_name":"list_public_holidays"},{"line":30,"address":[23050925],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[23051024,23050962,23051227,23051099],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[23051817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[23051662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[23051718],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[23051782],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[23051805],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[22656752],"length":1,"stats":{"Line":0},"fn_name":"fetch_google_holidays"},{"line":74,"address":[23052546,23052678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[23052684,23052744],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[23053071,23052722,23053377,23053004],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[23055684,23055440,23055678,23052981],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":82,"address":[23055467,23055528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[23053654,23053336,23053692,23053759,23054114,23053593],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[23053177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[23053301,23053358,23053416,23052590,23053603],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[23055406,23055412,23055168,23053669],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":94,"address":[23055256,23055195],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[23054512,23054166,23052611,23055950,23055956,23055108,23055712,23054047,23053937],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":101,"address":[23055739,23055800],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[23054649,23054728],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[23054756],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[22655872],"length":1,"stats":{"Line":0},"fn_name":"check_holiday"},{"line":113,"address":[23047186,23047635,23046851,23047568,23047123,23047481,23047419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[23046992,23047127],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[23047208,23046901,23047261,23047467,23047151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[23047545,23047750,23047056,23047603,23048336,23048263,23048350],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":118,"address":[23047768,23048077,23047796],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[23048010,23047798],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[23047778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[23047872],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[23047833],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[23047840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[22656528],"length":1,"stats":{"Line":0},"fn_name":"list_month_holidays"},{"line":135,"address":[23048697,23048813],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[23048892],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[23048819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[23049769,23049259,23049615,23048865,23049322,23049553,23049702],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[23049263,23049104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[23049396,23048749,23049287,23049344,23049601],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[23049188,23049679,23049737,23050494,23049914,23050480,23050422],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":146,"address":[23049973],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[23050052,23050644,23050560],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":149,"address":[23050594],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[23050602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[23050090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[22661600,22656880,22662878],"length":1,"stats":{"Line":1},"fn_name":"parse_google_calendar_ics"},{"line":158,"address":[22656965],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[22657046,22657094],"length":1,"stats":{"Line":2},"fn_name":null},{"line":160,"address":[22657297,22662582],"length":1,"stats":{"Line":2},"fn_name":null},{"line":161,"address":[22662734,22662813,22662675],"length":1,"stats":{"Line":3},"fn_name":null},{"line":162,"address":[22662834,22662792],"length":1,"stats":{"Line":2},"fn_name":null},{"line":166,"address":[22662711,22662846],"length":1,"stats":{"Line":2},"fn_name":null},{"line":169,"address":[22657331],"length":1,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[22657338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":171,"address":[22657367],"length":1,"stats":{"Line":1},"fn_name":null},{"line":172,"address":[22657375],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[22657383,22657494,22657621],"length":1,"stats":{"Line":3},"fn_name":null},{"line":175,"address":[22658044,22662543,22657698],"length":1,"stats":{"Line":3},"fn_name":null},{"line":176,"address":[22658118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":177,"address":[22658139,22662276],"length":1,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[22662393,22662420],"length":1,"stats":{"Line":1},"fn_name":null},{"line":179,"address":[22658095,22658185],"length":1,"stats":{"Line":2},"fn_name":null},{"line":180,"address":[22658267,22661979],"length":1,"stats":{"Line":2},"fn_name":null},{"line":181,"address":[22662065],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[22662271,22662169],"length":1,"stats":{"Line":2},"fn_name":null},{"line":183,"address":[22662264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":186,"address":[22658309,22658236],"length":1,"stats":{"Line":2},"fn_name":null},{"line":187,"address":[22658492,22658451,22658543],"length":1,"stats":{"Line":2},"fn_name":null},{"line":188,"address":[22659061,22658466,22658704],"length":1,"stats":{"Line":3},"fn_name":null},{"line":189,"address":[22658846,22658938,22658887],"length":1,"stats":{"Line":2},"fn_name":null},{"line":190,"address":[22658861,22659082,22661958],"length":1,"stats":{"Line":3},"fn_name":null},{"line":191,"address":[22659363,22659128],"length":1,"stats":{"Line":2},"fn_name":null},{"line":192,"address":[22661554,22659425,22659490],"length":1,"stats":{"Line":5},"fn_name":null},{"line":193,"address":[23056032,23056308],"length":1,"stats":{"Line":2},"fn_name":"{closure#1}"},{"line":194,"address":[23056062,23056127],"length":1,"stats":{"Line":2},"fn_name":null},{"line":195,"address":[23056186,23056251],"length":1,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[23056238],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[23056258,23056217],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[22659752],"length":1,"stats":{"Line":1},"fn_name":null},{"line":204,"address":[22659701],"length":1,"stats":{"Line":3},"fn_name":null},{"line":207,"address":[22659764],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[22661440],"length":1,"stats":{"Line":1},"fn_name":null},{"line":210,"address":[22659804,22661354],"length":1,"stats":{"Line":2},"fn_name":null},{"line":211,"address":[22661400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[22659768,22659837,22660206],"length":1,"stats":{"Line":3},"fn_name":null},{"line":222,"address":[22661624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":223,"address":[22661645,22661691],"length":1,"stats":{"Line":1},"fn_name":null},{"line":224,"address":[22661808,22661835],"length":1,"stats":{"Line":1},"fn_name":null},{"line":228,"address":[22657747],"length":1,"stats":{"Line":3},"fn_name":null},{"line":229,"address":[22657801],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[22656510,22656000,22656504],"length":1,"stats":{"Line":1},"fn_name":"decode_ics_text"},{"line":233,"address":[22656033,22656331,22656212],"length":1,"stats":{"Line":3},"fn_name":null}],"covered":46,"coverable":94},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","mod.rs"],"content":"pub mod admin;\npub mod attendance;\npub mod attendance_utils;\npub mod auth;\npub mod config;\npub mod consents;\npub mod holiday_exceptions;\npub mod holidays;\npub mod requests;\npub mod sessions;\npub mod subject_requests;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","requests.rs"],"content":"use axum::{\n    extract::{Extension, Path, State},\n    Json,\n};\nuse serde_json::{json, Value};\nuse validator::Validate;\n\nuse crate::{\n    error::AppError,\n    models::{\n        leave_request::{CreateLeaveRequest, LeaveRequest, LeaveRequestResponse},\n        overtime_request::{CreateOvertimeRequest, OvertimeRequest, OvertimeRequestResponse},\n    },\n    repositories::{\n        repository::Repository,\n        request::{RequestCreate, RequestRecord, RequestRepository},\n        leave_request::{LeaveRequestRepository, LeaveRequestRepositoryTrait},\n        overtime_request::{OvertimeRequestRepository, OvertimeRequestRepositoryTrait},\n    },\n    state::AppState,\n    types::{LeaveRequestId, OvertimeRequestId},\n};\n\nuse chrono::Utc;\nuse serde::Deserialize;\nuse std::str::FromStr;\n\npub async fn create_leave_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003ccrate::models::user::User\u003e,\n    Json(payload): Json\u003cCreateLeaveRequest\u003e,\n) -\u003e Result\u003cJson\u003cLeaveRequestResponse\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    payload.validate()?;\n\n    let leave_request = LeaveRequest::new(\n        user_id,\n        payload.leave_type,\n        payload.start_date,\n        payload.end_date,\n        payload.reason,\n    );\n\n    let repo = RequestRepository::new();\n    let saved = repo\n        .create_request_with_history(\u0026state.write_pool, RequestCreate::Leave(\u0026leave_request))\n        .await?;\n    let response = match saved {\n        RequestRecord::Leave(item) =\u003e LeaveRequestResponse::from(item),\n        RequestRecord::Overtime(_) =\u003e {\n            return Err(AppError::InternalServerError(anyhow::anyhow!(\n                \"Repository returned OvertimeRequest when LeaveRequest was expected\"\n            )))\n        }\n    };\n    Ok(Json(response))\n}\n\npub async fn create_overtime_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003ccrate::models::user::User\u003e,\n    Json(payload): Json\u003cCreateOvertimeRequest\u003e,\n) -\u003e Result\u003cJson\u003cOvertimeRequestResponse\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    payload.validate()?;\n\n    let overtime_request =\n        OvertimeRequest::new(user_id, payload.date, payload.planned_hours, payload.reason);\n\n    let repo = RequestRepository::new();\n    let saved = repo\n        .create_request_with_history(\n            \u0026state.write_pool,\n            RequestCreate::Overtime(\u0026overtime_request),\n        )\n        .await?;\n    let response = match saved {\n        RequestRecord::Overtime(item) =\u003e OvertimeRequestResponse::from(item),\n        RequestRecord::Leave(_) =\u003e {\n            return Err(AppError::InternalServerError(anyhow::anyhow!(\n                \"Repository returned LeaveRequest when OvertimeRequest was expected\"\n            )))\n        }\n    };\n    Ok(Json(response))\n}\n\npub async fn get_my_requests(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003ccrate::models::user::User\u003e,\n) -\u003e Result\u003cJson\u003cserde_json::Value\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    let repo = RequestRepository::new();\n    let requests = repo.get_user_requests(state.read_pool(), user_id).await?;\n\n    let response = json!({\n        \"leave_requests\": requests.leave_requests.into_iter().map(LeaveRequestResponse::from).collect::\u003cVec\u003c_\u003e\u003e(),\n        \"overtime_requests\": requests.overtime_requests.into_iter().map(OvertimeRequestResponse::from).collect::\u003cVec\u003c_\u003e\u003e()\n    });\n\n    Ok(Json(response))\n}\n\n#[derive(Deserialize)]\npub struct UpdateLeavePayload {\n    pub leave_type: Option\u003ccrate::models::leave_request::LeaveType\u003e,\n    pub start_date: Option\u003cchrono::NaiveDate\u003e,\n    pub end_date: Option\u003cchrono::NaiveDate\u003e,\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Deserialize)]\npub struct UpdateOvertimePayload {\n    pub date: Option\u003cchrono::NaiveDate\u003e,\n    pub planned_hours: Option\u003cf64\u003e,\n    pub reason: Option\u003cString\u003e,\n}\n\npub async fn update_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003ccrate::models::user::User\u003e,\n    Path(request_id): Path\u003cString\u003e,\n    Json(payload): Json\u003cserde_json::Value\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    let user_id = user.id;\n\n    // Try leave update first\n    let leave_request_id = LeaveRequestId::from_str(\u0026request_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid request ID format\".into()))?;\n\n    let leave_repo = LeaveRequestRepository::new();\n    if let Some(req) = leave_repo\n        .find_by_id_for_user(\u0026state.write_pool, leave_request_id, user_id)\n        .await?\n    {\n        if !req.is_pending() {\n            return Err(AppError::BadRequest(\n                \"Only pending requests can be updated\".into(),\n            ));\n        }\n        let upd: UpdateLeavePayload = serde_json::from_value(payload.clone())\n            .map_err(|_| AppError::BadRequest(\"Invalid payload\".into()))?;\n        let mut updated = req;\n        let new_type = upd.leave_type.unwrap_or_else(|| updated.leave_type.clone());\n        let new_start = upd.start_date.unwrap_or(updated.start_date);\n        let new_end = upd.end_date.unwrap_or(updated.end_date);\n        if new_start \u003e new_end {\n            return Err(AppError::BadRequest(\n                \"start_date must be \u003c= end_date\".into(),\n            ));\n        }\n        let new_reason = upd.reason.or(updated.reason.clone());\n        let now = Utc::now();\n        updated.leave_type = new_type;\n        updated.start_date = new_start;\n        updated.end_date = new_end;\n        updated.reason = new_reason;\n        updated.updated_at = now;\n        leave_repo.update(\u0026state.write_pool, \u0026updated).await?;\n        return Ok(Json(json!({\"message\":\"Leave request updated\"})));\n    }\n\n    // Try overtime update\n    let overtime_request_id = OvertimeRequestId::from_str(\u0026request_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid request ID format\".into()))?;\n\n    let overtime_repo = OvertimeRequestRepository::new();\n    if let Some(req) = overtime_repo\n        .find_by_id_for_user(\u0026state.write_pool, overtime_request_id, user_id)\n        .await?\n    {\n        if !req.is_pending() {\n            return Err(AppError::BadRequest(\n                \"Only pending requests can be updated\".into(),\n            ));\n        }\n        let upd: UpdateOvertimePayload = serde_json::from_value(payload.clone())\n            .map_err(|_| AppError::BadRequest(\"Invalid payload\".into()))?;\n        let new_date = upd.date.unwrap_or(req.date);\n        let new_hours = upd.planned_hours.unwrap_or(req.planned_hours);\n        if new_hours \u003c= 0.0 {\n            return Err(AppError::BadRequest(\"planned_hours must be \u003e 0\".into()));\n        }\n        let new_reason = upd.reason.or(req.reason.clone());\n        let now = Utc::now();\n        let mut updated = req;\n        updated.date = new_date;\n        updated.planned_hours = new_hours;\n        updated.reason = new_reason;\n        updated.updated_at = now;\n        overtime_repo.update(\u0026state.write_pool, \u0026updated).await?;\n        return Ok(Json(json!({\"message\":\"Overtime request updated\"})));\n    }\n\n    Err(AppError::NotFound(\"Request not found\".into()))\n}\n\npub async fn cancel_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003ccrate::models::user::User\u003e,\n    Path(request_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    let user_id = user.id;\n    let now = Utc::now();\n\n    // Try leave cancellation first\n    let leave_request_id = LeaveRequestId::from_str(\u0026request_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid request ID format\".into()))?;\n    let leave_repo = LeaveRequestRepository::new();\n    let result = leave_repo\n        .cancel(\u0026state.write_pool, leave_request_id, user_id, now)\n        .await?;\n    if result \u003e 0 {\n        return Ok(Json(json!({\"id\": request_id, \"status\":\"cancelled\"})));\n    }\n\n    // Try overtime cancellation\n    let overtime_request_id = OvertimeRequestId::from_str(\u0026request_id)\n        .map_err(|_| AppError::BadRequest(\"Invalid request ID format\".into()))?;\n    let overtime_repo = OvertimeRequestRepository::new();\n    let result = overtime_repo\n        .cancel(\u0026state.write_pool, overtime_request_id, user_id, Utc::now())\n        .await?;\n    if result \u003e 0 {\n        return Ok(Json(json!({\"id\": request_id, \"status\":\"cancelled\"})));\n    }\n\n    Err(AppError::NotFound(\n        \"Request not found or not cancellable\".into(),\n    ))\n}\n\n#[cfg(test)]\nmod tests {\n    use chrono::NaiveDate;\n\n    fn is_valid_leave_window(start: NaiveDate, end: NaiveDate) -\u003e bool {\n        start \u003c= end\n    }\n\n    fn is_valid_planned_hours(hours: f64) -\u003e bool {\n        hours \u003e 0.0\n    }\n\n    #[test]\n    fn leave_window_validation_requires_start_before_end() {\n        let start = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let end = NaiveDate::from_ymd_opt(2024, 1, 2).unwrap();\n        assert!(is_valid_leave_window(start, end));\n        assert!(!is_valid_leave_window(end, start));\n    }\n\n    #[test]\n    fn planned_hours_validation_disallows_non_positive_values() {\n        assert!(is_valid_planned_hours(0.5));\n        assert!(!is_valid_planned_hours(0.0));\n        assert!(!is_valid_planned_hours(-1.0));\n    }\n}\n","traces":[{"line":28,"address":[23057248],"length":1,"stats":{"Line":0},"fn_name":"create_leave_request"},{"line":33,"address":[19548602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[19549225,19548625,19548736],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[19548912],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[19548918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[19548931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[19549014],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[19549607,19550579,19549176,19549462,19549516,19549070],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[19549080],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[19549575,19549164,19548662,19549206,19549281,19549469],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[19549732],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[19549801],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[19550298,19549769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[19549970],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[23057376],"length":1,"stats":{"Line":0},"fn_name":"create_overtime_request"},{"line":65,"address":[19551098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[19551121,19551232,19551717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[19551408],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[19551505],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[19551668,19552099,19552008,19551561,19553071,19551954],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[19551571],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[19551581],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[19551158,19551773,19551961,19551656,19551698,19552067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[19552224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[19552261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[19552367,19552472],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[19552696],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[23057168],"length":1,"stats":{"Line":0},"fn_name":"get_my_requests"},{"line":94,"address":[19545630],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[19545645],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[19545738,19545679,19545821,19545968],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[19547298,19547874,19546498,19546803,19547836,19546584,19546546,19547291,19546690,19546796,19547082,19547185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[19546627,19546750],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[19547245,19547122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[19547575],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[23056992],"length":1,"stats":{"Line":0},"fn_name":"update_request"},{"line":128,"address":[19535505],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[19535519,19536132,19535772,19535726,19535839],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[19544862,19535807,19535749,19544848],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":134,"address":[19535920],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[19535970,19539221,19536088,19536378,19536410,19536567,19535935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[19536002,19535945],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[19536197,19536537,19536110,19535575,19536041,19536388],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[19536804,19536914],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[19536991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[19536920],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[19536966,19537333,19537257,19538761,19537211],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[19545074,19537301,19537234,19545056],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":146,"address":[19537506],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[19537552,19545045,19545040,19537651],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":148,"address":[19537658],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[19537727],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[19537796],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[19538600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[19537923],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[19537852,19538545,19537964],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[19538067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[19538149],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[19538165],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[19538177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[19538189,19538247],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[19538367],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[19539234,19538395,19540348,19535596],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[19540316,19539753,19539798,19539863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[19539216,19538807,19538853,19538920,19536826],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[19538888,19538830,19544944,19544958],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":170,"address":[19539001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[19540826,19540977,19543460,19539169,19539016,19540794,19539051],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[19539083,19539026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[19535617,19539191,19540613,19540804,19540947,19539122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[19541312,19541208],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[19541389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[19541318],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[19541609,19541655,19543011,19541364,19541722],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[19545234,19541632,19541690,19545216],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":182,"address":[19541895,19541982],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[19541989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[19542040],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[19542128,19542852],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[19542169,19542803,19542057],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[19542272],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[19542347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[19542413],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[19542419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[19542427,19542485],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[19542605],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[19544554,19535638,19542633,19542724,19543473],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[19544522,19544067,19543957,19544002],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[19543041,19541219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[23056864],"length":1,"stats":{"Line":0},"fn_name":"cancel_request"},{"line":206,"address":[19530642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[19530656],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[19531257,19530886,19530798,19530953],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[19534814,19530863,19534800,19530921],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":212,"address":[19531034],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[19533071,19531049,19531084,19531216,19531471,19531517,19531632],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[19531059,19531154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[19531600,19531503,19531181,19531238,19530705,19531322],"length":1,"stats":{"Line":0},"fn_name":null},{"line":216,"address":[19531713],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[19532258,19532331,19532555,19532617,19533049,19531759,19532220],"length":1,"stats":{"Line":0},"fn_name":null},{"line":221,"address":[19531833,19532215,19531727,19531787,19531900],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[19531810,19534910,19534896,19531868],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":223,"address":[19531981],"length":1,"stats":{"Line":0},"fn_name":null},{"line":224,"address":[19533232,19531996,19532070,19533393,19532172,19534734,19533278],"length":1,"stats":{"Line":0},"fn_name":null},{"line":225,"address":[19532011,19532110],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[19532194,19533084,19533361,19530726,19533264,19532137],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[19533474],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[19534000,19533927,19534224,19534286,19533526,19533889],"length":1,"stats":{"Line":0},"fn_name":null},{"line":231,"address":[19533544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[19533480],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":110},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","sessions.rs"],"content":"use axum::{\n    extract::{Extension, Path, State},\n    http::{header::USER_AGENT, HeaderMap},\n    Json,\n};\nuse chrono::{DateTime, Utc};\nuse serde::Serialize;\nuse serde_json::{json, Value};\nuse std::sync::Arc;\nuse utoipa::ToSchema;\n\nuse crate::{\n    error::AppError,\n    middleware::request_id::RequestId,\n    models::{active_session::ActiveSession, user::User},\n    repositories::{active_session, auth as auth_repo},\n    services::audit_log::{AuditLogEntry, AuditLogServiceTrait},\n    services::token_cache::TokenCacheServiceTrait,\n    state::AppState,\n    utils::jwt::Claims,\n};\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct SessionResponse {\n    pub id: String,\n    pub device_label: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub last_seen_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: DateTime\u003cUtc\u003e,\n    pub is_current: bool,\n}\n\nimpl SessionResponse {\n    fn from_session(session: ActiveSession, current_jti: \u0026str) -\u003e Self {\n        let is_current = session\n            .access_jti\n            .as_deref()\n            .map(|jti| jti == current_jti)\n            .unwrap_or(false);\n        Self {\n            id: session.id,\n            device_label: session.device_label,\n            created_at: session.created_at,\n            last_seen_at: session.last_seen_at,\n            expires_at: session.expires_at,\n            is_current,\n        }\n    }\n}\n\npub async fn list_sessions(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(claims): Extension\u003cClaims\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cSessionResponse\u003e\u003e, AppError\u003e {\n    let sessions = active_session::list_active_sessions_for_user(state.read_pool(), user.id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n    let responses = sessions\n        .into_iter()\n        .map(|session| SessionResponse::from_session(session, \u0026claims.jti))\n        .collect();\n    Ok(Json(responses))\n}\n\npub async fn revoke_session(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Extension(claims): Extension\u003cClaims\u003e,\n    Extension(request_id): Extension\u003cRequestId\u003e,\n    Extension(audit_log_service): Extension\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    headers: HeaderMap,\n    Path(session_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, AppError\u003e {\n    if session_id.trim().is_empty() {\n        return Err(AppError::BadRequest(\"Session ID is required\".into()));\n    }\n\n    let session = active_session::find_active_session_by_id(\u0026state.write_pool, \u0026session_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?\n        .ok_or_else(|| AppError::NotFound(\"Session not found\".into()))?;\n\n    if session.user_id != user.id {\n        return Err(AppError::Forbidden(\"Forbidden\".into()));\n    }\n\n    if session\n        .access_jti\n        .as_deref()\n        .map(|jti| jti == claims.jti.as_str())\n        .unwrap_or(false)\n    {\n        return Err(AppError::BadRequest(\n            \"Cannot revoke current session; use logout instead\".into(),\n        ));\n    }\n\n    revoke_session_tokens(\u0026state.write_pool, state.token_cache.as_ref(), \u0026session).await?;\n\n    record_session_audit_event(\n        Some(audit_log_service),\n        \u0026user.id,\n        \u0026headers,\n        \u0026request_id,\n        \"session_destroy\",\n        Some(session.id.clone()),\n        Some(json!({ \"reason\": \"user_revoke\" })),\n    );\n\n    Ok(Json(json!({\n        \"message\": \"Session revoked\",\n        \"session_id\": session_id\n    })))\n}\n\nasync fn revoke_session_tokens(\n    pool: \u0026sqlx::PgPool,\n    token_cache: Option\u003c\u0026Arc\u003cdyn TokenCacheServiceTrait\u003e\u003e,\n    session: \u0026ActiveSession,\n) -\u003e Result\u003c(), AppError\u003e {\n    if let Some(access_jti) = session.access_jti.as_deref() {\n        auth_repo::delete_active_access_token_by_jti(pool, access_jti)\n            .await\n            .map_err(|e| AppError::InternalServerError(e.into()))?;\n        if let Some(cache) = token_cache {\n            let _ = cache.invalidate_token(access_jti).await;\n        }\n    }\n\n    auth_repo::delete_refresh_token_by_id(pool, \u0026session.refresh_token_id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    active_session::delete_active_session_by_id(pool, \u0026session.id)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n    Ok(())\n}\n\nfn record_session_audit_event(\n    audit_log_service: Option\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e,\n    actor_id: \u0026crate::types::UserId,\n    headers: \u0026HeaderMap,\n    request_id: \u0026RequestId,\n    event_type: \u0026'static str,\n    session_id: Option\u003cString\u003e,\n    metadata: Option\u003cValue\u003e,\n) {\n    let Some(audit_log_service) = audit_log_service else {\n        return;\n    };\n    let entry = AuditLogEntry {\n        occurred_at: Utc::now(),\n        actor_id: Some(*actor_id),\n        actor_type: \"user\".to_string(),\n        event_type: event_type.to_string(),\n        target_type: Some(\"session\".to_string()),\n        target_id: session_id,\n        result: \"success\".to_string(),\n        error_code: None,\n        metadata,\n        ip: extract_ip(headers),\n        user_agent: extract_user_agent(headers),\n        request_id: Some(request_id.0.clone()),\n    };\n\n    tokio::spawn(async move {\n        if let Err(err) = audit_log_service.record_event(entry).await {\n            tracing::warn!(\n                error = ?err,\n                event_type = %event_type,\n                \"Failed to record session audit log\"\n            );\n        }\n    });\n}\n\nfn extract_ip(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    if let Some(value) = headers.get(\"x-forwarded-for\").and_then(|v| v.to_str().ok()) {\n        return value\n            .split(',')\n            .next()\n            .map(|ip| ip.trim().to_string())\n            .filter(|ip| !ip.is_empty());\n    }\n    headers\n        .get(\"x-real-ip\")\n        .and_then(|v| v.to_str().ok())\n        .map(|ip| ip.trim().to_string())\n        .filter(|ip| !ip.is_empty())\n}\n\nfn extract_user_agent(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    headers\n        .get(USER_AGENT)\n        .and_then(|v| v.to_str().ok())\n        .map(|agent| agent.trim().to_string())\n        .filter(|agent| !agent.is_empty())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::http::HeaderMap;\n\n    #[test]\n    fn extract_ip_from_x_forwarded_for() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-forwarded-for\", \"203.0.113.195, 70.41.3.18, 150.172.238.178\".parse().unwrap());\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, Some(\"203.0.113.195\".to_string()));\n    }\n\n    #[test]\n    fn extract_ip_from_x_real_ip() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-real-ip\", \"192.168.1.100\".parse().unwrap());\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, Some(\"192.168.1.100\".to_string()));\n    }\n\n    #[test]\n    fn extract_ip_prefers_x_forwarded_for() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-forwarded-for\", \"203.0.113.195\".parse().unwrap());\n        headers.insert(\"x-real-ip\", \"192.168.1.100\".parse().unwrap());\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, Some(\"203.0.113.195\".to_string()));\n    }\n\n    #[test]\n    fn extract_ip_returns_none_when_missing() {\n        let headers = HeaderMap::new();\n        \n        let result = extract_ip(\u0026headers);\n        \n        assert_eq!(result, None);\n    }\n\n    #[test]\n    fn extract_user_agent_from_header() {\n        let mut headers = HeaderMap::new();\n        headers.insert(USER_AGENT, \"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\".parse().unwrap());\n        \n        let result = extract_user_agent(\u0026headers);\n        \n        assert_eq!(result, Some(\"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\".to_string()));\n    }\n\n    #[test]\n    fn extract_user_agent_returns_none_when_missing() {\n        let headers = HeaderMap::new();\n        \n        let result = extract_user_agent(\u0026headers);\n        \n        assert_eq!(result, None);\n    }\n\n    #[test]\n    fn extract_user_agent_trims_whitespace() {\n        let mut headers = HeaderMap::new();\n        headers.insert(USER_AGENT, \"  TestAgent  \".parse().unwrap());\n        \n        let result = extract_user_agent(\u0026headers);\n        \n        assert_eq!(result, Some(\"TestAgent\".to_string()));\n    }\n}\n","traces":[{"line":34,"address":[22806139,22805664],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[22805830,22805704],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[19819312,19819336],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":41,"address":[22805840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[22805857],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[22805875],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[22805897],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22805925],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[22805248],"length":1,"stats":{"Line":0},"fn_name":"list_sessions"},{"line":56,"address":[19811793,19812082,19812298,19811859,19812144,19811682,19812231],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[19811721,19811889,19811847,19811939,19812130],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[19813054,19812208,19813040,19812266],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":59,"address":[19812435],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[19812544,19813120,19813161],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":63,"address":[19812602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[22805376],"length":1,"stats":{"Line":0},"fn_name":"revoke_session"},{"line":75,"address":[19814160,19814314],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[19814435,19814604],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[19815361,19815161,19815437,19814388,19814984,19814546,19815044,19814508,19815085,19816326],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[19814213,19814994,19814531,19814803,19814579],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[19815062,19815129,19819072,19819086],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":82,"address":[19815405,19819230,19815338,19819216],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":84,"address":[19815587,19815666],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[19816185,19815708],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[19815680,19815813],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[19819170,19819152,19815767],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":94,"address":[19816024],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[19815860],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[19818840,19816350,19815827,19815916,19814234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[19816733],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[19816778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[19816792],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[19816806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[19816895,19816820],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[19816943,19817026,19818758,19817091,19816988],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[19817548,19817613,19817503,19817910,19817840,19818704],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[22806304],"length":1,"stats":{"Line":0},"fn_name":"revoke_session_tokens"},{"line":122,"address":[19819851,19819644],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[19820271,19819930,19820330,19820484,19820039,19820417,19820749],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[20982769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[19820394,19822224,19822238,19820452],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":126,"address":[19820557],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[19819733,19820608,19820848],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[19821125,19821544,19821753,19821087,19821331,19819965,19821390,19821477],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[19821110,19821379,19821155,19821179,19819754],"length":1,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[19822318,19821512,19822304,19821454],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":135,"address":[19822209,19822130,19821617,19821708,19821976,19822063,19821917],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[20982817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[19822040,19822384,19822098,19822398],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":139,"address":[19822192],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[22807986,22806352,22807827],"length":1,"stats":{"Line":0},"fn_name":"record_session_audit_event"},{"line":151,"address":[22806468],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[22806564],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[22806648],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[22806683],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[22806724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[22806864,22806787],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[22806927],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[22807069],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[22807133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[22807246,22807186],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[22807655],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[20988500],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[19823242,19823326,19823721],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[22804976],"length":1,"stats":{"Line":1},"fn_name":"extract_ip"},{"line":181,"address":[19810921,19810912],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":183,"address":[22805102],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[22805118],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[22805132],"length":1,"stats":{"Line":3},"fn_name":null},{"line":186,"address":[19811200,19811209],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":190,"address":[19811152,19811161],"length":1,"stats":{"Line":3},"fn_name":"{closure#3}"},{"line":191,"address":[19811120,19811072],"length":1,"stats":{"Line":3},"fn_name":"{closure#4}"},{"line":192,"address":[19811049,19811040],"length":1,"stats":{"Line":3},"fn_name":"{closure#5}"},{"line":195,"address":[22806160],"length":1,"stats":{"Line":1},"fn_name":"extract_user_agent"},{"line":196,"address":[22806190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":197,"address":[22806238],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[19819472,19819481],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":199,"address":[19819360,19819408],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":200,"address":[19819449,19819440],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"}],"covered":15,"coverable":79},{"path":["/","home","marra","projects","timekeeper","backend","src","handlers","subject_requests.rs"],"content":"use axum::{\n    extract::{Extension, Path, State},\n    http::StatusCode,\n    Json,\n};\nuse serde_json::{json, Value};\n\nuse crate::{\n    models::{\n        subject_request::{\n            CreateDataSubjectRequest, DataSubjectRequest, DataSubjectRequestResponse,\n        },\n        user::User,\n    },\n    repositories::subject_request,\n    state::AppState,\n    utils::time,\n};\n\nconst MAX_DETAILS_LENGTH: usize = 2000;\n\npub async fn create_subject_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Json(payload): Json\u003cCreateDataSubjectRequest\u003e,\n) -\u003e Result\u003cJson\u003cDataSubjectRequestResponse\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    let details = validate_details(payload.details)?;\n    let now = time::now_utc(\u0026state.config.time_zone);\n    let user_id = user.id.to_string();\n    let request = DataSubjectRequest::new(user_id, payload.request_type, details, now);\n\n    subject_request::insert_subject_request(\u0026state.write_pool, \u0026request)\n        .await\n        .map_err(|err| {\n            tracing::error!(error = %err, \"failed to create subject request\");\n            (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                Json(json!({\"error\": \"Database error\"})),\n            )\n        })?;\n\n    Ok(Json(DataSubjectRequestResponse::from(request)))\n}\n\npub async fn list_my_subject_requests(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cDataSubjectRequestResponse\u003e\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    let user_id = user.id.to_string();\n    let requests = subject_request::list_subject_requests_by_user(state.read_pool(), \u0026user_id)\n        .await\n        .map_err(|err| {\n            tracing::error!(error = %err, \"failed to list subject requests\");\n            (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                Json(json!({\"error\": \"Database error\"})),\n            )\n        })?;\n\n    Ok(Json(\n        requests\n            .into_iter()\n            .map(DataSubjectRequestResponse::from)\n            .collect(),\n    ))\n}\n\npub async fn cancel_subject_request(\n    State(state): State\u003cAppState\u003e,\n    Extension(user): Extension\u003cUser\u003e,\n    Path(request_id): Path\u003cString\u003e,\n) -\u003e Result\u003cJson\u003cValue\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    let now = time::now_utc(\u0026state.config.time_zone);\n    let user_id = user.id.to_string();\n    let rows =\n        subject_request::cancel_subject_request(\u0026state.write_pool, \u0026request_id, \u0026user_id, now)\n            .await\n            .map_err(|err| {\n                tracing::error!(error = %err, \"failed to cancel subject request\");\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    Json(json!({\"error\": \"Database error\"})),\n                )\n            })?;\n\n    if rows == 0 {\n        return Err((\n            StatusCode::NOT_FOUND,\n            Json(json!({\"error\": \"Request not found or not cancellable\"})),\n        ));\n    }\n\n    Ok(Json(json!({\"id\": request_id, \"status\": \"cancelled\"})))\n}\n\nfn validate_details(details: Option\u003cString\u003e) -\u003e Result\u003cOption\u003cString\u003e, (StatusCode, Json\u003cValue\u003e)\u003e {\n    if let Some(details) = details {\n        let trimmed = details.trim();\n        if trimmed.is_empty() {\n            return Ok(None);\n        }\n        if trimmed.chars().count() \u003e MAX_DETAILS_LENGTH {\n            return Err((\n                StatusCode::BAD_REQUEST,\n                Json(json!({\"error\": \"details is too long\"})),\n            ));\n        }\n        return Ok(Some(trimmed.to_string()));\n    }\n    Ok(None)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn validate_details_returns_none_for_none() {\n        let result = validate_details(None);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), None);\n    }\n\n    #[test]\n    fn validate_details_returns_none_for_empty() {\n        let result = validate_details(Some(\"\".to_string()));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), None);\n    }\n\n    #[test]\n    fn validate_details_returns_none_for_whitespace_only() {\n        let result = validate_details(Some(\"   \".to_string()));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), None);\n    }\n\n    #[test]\n    fn validate_details_accepts_valid_details() {\n        let result = validate_details(Some(\"Valid details\".to_string()));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), Some(\"Valid details\".to_string()));\n    }\n\n    #[test]\n    fn validate_details_trims_whitespace() {\n        let result = validate_details(Some(\"  test details  \".to_string()));\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), Some(\"test details\".to_string()));\n    }\n\n    #[test]\n    fn validate_details_rejects_too_long() {\n        let long_details = \"a\".repeat(MAX_DETAILS_LENGTH + 1);\n        let result = validate_details(Some(long_details));\n        assert!(result.is_err());\n        let (status, _) = result.unwrap_err();\n        assert_eq!(status, StatusCode::BAD_REQUEST);\n    }\n\n    #[test]\n    fn validate_details_accepts_max_length() {\n        let max_details = \"a\".repeat(MAX_DETAILS_LENGTH);\n        let result = validate_details(Some(max_details));\n        assert!(result.is_ok());\n    }\n}\n","traces":[{"line":22,"address":[18078032],"length":1,"stats":{"Line":0},"fn_name":"create_subject_request"},{"line":27,"address":[18087390,18086700,18086541],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[18086943],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[18087015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[18087232,18087042],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[18087601,18087663,18087750,18087341,18087239,18087836],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[18087329,18086623,18087371,18087452,18087649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[18090343,18088352,18087727],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":35,"address":[18088838,18088470,18088383],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[18089808,18088828,18090321],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[18087922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[18078176],"length":1,"stats":{"Line":0},"fn_name":"list_my_subject_requests"},{"line":49,"address":[18090966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[18091235,18091602,18091153,18091688,18091453,18091515,18091076],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[18091314,18091501,18091017,18091265,18091223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[18094359,18091579,18092368],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":53,"address":[18092486,18092854,18092399],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[18092844,18093824,18094337],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[18091996],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[18091841],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[18091897],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[18091961],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[18091984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[18077904],"length":1,"stats":{"Line":0},"fn_name":"cancel_subject_request"},{"line":73,"address":[18081140],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[18081258],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[18081828,18081398,18081915,18081534,18082001,18081766,18083782,18081287],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[18081192,18081564,18081522,18081614,18081814],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[18083856,18085847,18081892],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":79,"address":[18083974,18083887,18084342],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[18084332,18085312,18085825],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[18082098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[18083611],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[18083151,18083750,18082127,18083189,18083254],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[18082469,18082112,18082137,18082245,18083091,18082531,18082175,18083129],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[18076720,18077876,18077857],"length":1,"stats":{"Line":1},"fn_name":"validate_details"},{"line":97,"address":[18076742],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[18076812,18076948],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[18077007],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[18077060],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[18077038,18077133],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[18077738],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[18077311,18077835,18077195],"length":1,"stats":{"Line":2},"fn_name":null},{"line":108,"address":[18077207,18077168],"length":1,"stats":{"Line":2},"fn_name":null},{"line":110,"address":[18076834],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":10,"coverable":45},{"path":["/","home","marra","projects","timekeeper","backend","src","lib.rs"],"content":"pub mod config;\npub mod db;\npub mod docs;\npub mod error;\npub mod handlers;\npub mod middleware;\npub mod models;\npub mod repositories;\npub mod services;\npub mod state;\npub use state::AppState;\npub mod types;\npub mod utils;\npub mod validation;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","main.rs"],"content":"use axum::{\n    http::{\n        header::{ACCEPT, AUTHORIZATION, CONTENT_TYPE},\n        HeaderValue, Method,\n    },\n    middleware as axum_middleware,\n    routing::{delete, get, post, put},\n    Extension, Router,\n};\nuse chrono::Utc;\nuse std::{net::SocketAddr, sync::Arc, time::Duration};\nuse tower::ServiceBuilder;\nuse tower_http::{\n    cors::{AllowOrigin, CorsLayer},\n    trace::{DefaultOnResponse, TraceLayer},\n};\nuse tracing::Level;\n\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\nuse utoipa::OpenApi;\nuse utoipa_swagger_ui::SwaggerUi;\n\nmod config;\nmod db;\nmod docs;\npub mod error;\nmod handlers;\nmod middleware;\nmod models;\nmod repositories;\nmod services;\nmod state;\nmod types;\nmod utils;\nmod validation;\n\nuse config::{AuditLogRetentionPolicy, Config};\nuse db::connection::create_pools;\nuse db::redis::create_redis_pool;\nuse middleware::rate_limit::create_auth_rate_limiter;\nuse services::{\n    audit_log::{AuditLogService, AuditLogServiceTrait},\n    consent_log::ConsentLogService,\n    holiday::{HolidayService, HolidayServiceTrait},\n    holiday_exception::{HolidayExceptionService, HolidayExceptionServiceTrait},\n    token_cache::{TokenCacheService, TokenCacheServiceTrait},\n};\n\npub use state::AppState;\n\n#[tokio::main]\nasync fn main() -\u003e anyhow::Result\u003c()\u003e {\n    init_tracing();\n\n    let config = Config::load()?;\n    log_config(\u0026config);\n\n    let (write_pool, read_pool) =\n        create_pools(\u0026config.database_url, config.read_database_url.as_deref()).await?;\n\n    sqlx::migrate!(\"./migrations\").run(\u0026write_pool).await?;\n\n    let audit_log_service: Arc\u003cdyn AuditLogServiceTrait\u003e =\n        Arc::new(AuditLogService::new(write_pool.clone()));\n    let consent_log_service = Arc::new(ConsentLogService::new(write_pool.clone()));\n    let holiday_service: Arc\u003cdyn HolidayServiceTrait\u003e =\n        Arc::new(HolidayService::new(write_pool.clone()));\n    let holiday_exception_service: Arc\u003cdyn HolidayExceptionServiceTrait\u003e =\n        Arc::new(HolidayExceptionService::new(write_pool.clone()));\n\n    let redis_pool = create_redis_pool(\u0026config).await?;\n    let token_cache: Option\u003cArc\u003cdyn TokenCacheServiceTrait\u003e\u003e = redis_pool.as_ref().map(|pool| {\n        Arc::new(TokenCacheService::new(pool.clone())) as Arc\u003cdyn TokenCacheServiceTrait\u003e\n    });\n\n    let shared_state = AppState::new(\n        write_pool,\n        read_pool,\n        redis_pool,\n        token_cache,\n        config.clone(),\n    );\n\n    spawn_audit_log_cleanup(\n        audit_log_service.clone(),\n        config.audit_log_retention_policy(),\n    );\n    spawn_consent_log_cleanup(\n        consent_log_service.clone(),\n        config.consent_log_retention_policy(),\n    );\n\n    let openapi = docs::ApiDoc::openapi();\n\n    let app = Router::new()\n        .merge(public_routes(shared_state.clone()))\n        .merge(user_routes(shared_state.clone()))\n        .merge(admin_routes(shared_state.clone()))\n        .merge(system_admin_routes(shared_state.clone()))\n        .merge(SwaggerUi::new(\"/api/docs\").url(\"/api-doc/openapi.json\", openapi.clone()))\n        .layer(\n            ServiceBuilder::new()\n                .layer(\n                    TraceLayer::new_for_http()\n                        .make_span_with(build_http_request_span)\n                        .on_response(\n                            DefaultOnResponse::new()\n                                .level(Level::INFO)\n                                .latency_unit(tower_http::LatencyUnit::Millis),\n                        ),\n                )\n                .layer(axum_middleware::from_fn(middleware::request_id))\n                .layer(axum_middleware::from_fn(middleware::log_error_responses))\n                .layer(cors_layer(\u0026config)),\n        )\n        .layer(Extension(audit_log_service))\n        .layer(Extension(holiday_service))\n        .layer(Extension(holiday_exception_service))\n        .with_state(shared_state);\n\n    let addr = SocketAddr::from(([0, 0, 0, 0], 3000));\n    tracing::info!(\"Server listening on {}\", addr);\n\n    let listener = tokio::net::TcpListener::bind(addr).await?;\n    axum::serve(\n        listener,\n        app.into_make_service_with_connect_info::\u003cSocketAddr\u003e(),\n    )\n    .await?;\n\n    Ok(())\n}\n\nfn build_http_request_span(request: \u0026axum::http::Request\u003caxum::body::Body\u003e) -\u003e tracing::Span {\n    let request_id = request\n        .extensions()\n        .get::\u003cmiddleware::RequestId\u003e()\n        .map(|id| id.0.as_str())\n        .unwrap_or(\"unknown\");\n\n    tracing::info_span!(\n        \"http_request\",\n        method = %request.method(),\n        uri = %request.uri(),\n        version = ?request.version(),\n        request_id = %request_id,\n        user_id = tracing::field::Empty,\n        username = tracing::field::Empty,\n    )\n}\n\nfn public_routes(state: AppState) -\u003e Router\u003cAppState\u003e {\n    let rate_limiter = create_auth_rate_limiter(\u0026state.config);\n    Router::new()\n        .route(\"/api/auth/login\", post(handlers::auth::login))\n        .route(\"/api/auth/refresh\", post(handlers::auth::refresh))\n        .route(\n            \"/api/auth/request-password-reset\",\n            post(handlers::auth::request_password_reset),\n        )\n        .route(\n            \"/api/auth/reset-password\",\n            post(handlers::auth::reset_password),\n        )\n        .route(\"/api/config/timezone\", get(handlers::config::get_time_zone))\n        .route_layer(rate_limiter)\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            middleware::audit_log,\n        ))\n}\n\nfn user_routes(state: AppState) -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\n            \"/api/attendance/clock-in\",\n            post(handlers::attendance::clock_in),\n        )\n        .route(\n            \"/api/attendance/clock-out\",\n            post(handlers::attendance::clock_out),\n        )\n        .route(\n            \"/api/attendance/break-start\",\n            post(handlers::attendance::break_start),\n        )\n        .route(\n            \"/api/attendance/break-end\",\n            post(handlers::attendance::break_end),\n        )\n        .route(\n            \"/api/attendance/status\",\n            get(handlers::attendance::get_attendance_status),\n        )\n        .route(\n            \"/api/attendance/me\",\n            get(handlers::attendance::get_my_attendance),\n        )\n        .route(\n            \"/api/attendance/me/summary\",\n            get(handlers::attendance::get_my_summary),\n        )\n        .route(\n            \"/api/attendance/{id}/breaks\",\n            get(handlers::attendance::get_breaks_by_attendance),\n        )\n        .route(\n            \"/api/attendance/export\",\n            get(handlers::attendance::export_my_attendance),\n        )\n        .route(\n            \"/api/requests/leave\",\n            post(handlers::requests::create_leave_request),\n        )\n        .route(\n            \"/api/requests/overtime\",\n            post(handlers::requests::create_overtime_request),\n        )\n        .route(\"/api/requests/me\", get(handlers::requests::get_my_requests))\n        .route(\n            \"/api/requests/{id}\",\n            put(handlers::requests::update_request),\n        )\n        .route(\n            \"/api/requests/{id}\",\n            delete(handlers::requests::cancel_request),\n        )\n        .route(\"/api/consents\", post(handlers::consents::record_consent))\n        .route(\n            \"/api/consents/me\",\n            get(handlers::consents::list_my_consents),\n        )\n        .route(\n            \"/api/subject-requests\",\n            post(handlers::subject_requests::create_subject_request),\n        )\n        .route(\n            \"/api/subject-requests/me\",\n            get(handlers::subject_requests::list_my_subject_requests),\n        )\n        .route(\n            \"/api/subject-requests/{id}\",\n            delete(handlers::subject_requests::cancel_subject_request),\n        )\n        .route(\"/api/auth/mfa\", get(handlers::auth::mfa_status))\n        .route(\"/api/auth/mfa\", delete(handlers::auth::mfa_disable))\n        .route(\"/api/auth/mfa/register\", post(handlers::auth::mfa_register))\n        .route(\"/api/auth/mfa/setup\", post(handlers::auth::mfa_setup))\n        .route(\"/api/auth/mfa/activate\", post(handlers::auth::mfa_activate))\n        .route(\"/api/auth/me\", get(handlers::auth::me))\n        .route(\"/api/auth/me\", put(handlers::auth::update_profile))\n        .route(\"/api/auth/sessions\", get(handlers::sessions::list_sessions))\n        .route(\n            \"/api/auth/sessions/{id}\",\n            delete(handlers::sessions::revoke_session),\n        )\n        .route(\n            \"/api/auth/change-password\",\n            put(handlers::auth::change_password),\n        )\n        .route(\"/api/auth/logout\", post(handlers::auth::logout))\n        .route(\n            \"/api/holidays\",\n            get(handlers::holidays::list_public_holidays),\n        )\n        .route(\n            \"/api/holidays/check\",\n            get(handlers::holidays::check_holiday),\n        )\n        .route(\n            \"/api/holidays/month\",\n            get(handlers::holidays::list_month_holidays),\n        )\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            middleware::auth,\n        ))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            middleware::audit_log,\n        ))\n}\n\nfn admin_routes(state: AppState) -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/api/admin/requests\", get(handlers::admin::list_requests))\n        .route(\n            \"/api/admin/requests/{id}\",\n            get(handlers::admin::get_request_detail),\n        )\n        .route(\n            \"/api/admin/requests/{id}/approve\",\n            put(handlers::admin::approve_request),\n        )\n        .route(\n            \"/api/admin/requests/{id}/reject\",\n            put(handlers::admin::reject_request),\n        )\n        .route(\n            \"/api/admin/subject-requests\",\n            get(handlers::admin::list_subject_requests),\n        )\n        .route(\n            \"/api/admin/subject-requests/{id}/approve\",\n            put(handlers::admin::approve_subject_request),\n        )\n        .route(\n            \"/api/admin/subject-requests/{id}/reject\",\n            put(handlers::admin::reject_subject_request),\n        )\n        .route(\n            \"/api/admin/audit-logs\",\n            get(handlers::admin::list_audit_logs),\n        )\n        .route(\n            \"/api/admin/audit-logs/export\",\n            get(handlers::admin::export_audit_logs),\n        )\n        .route(\n            \"/api/admin/audit-logs/{id}\",\n            get(handlers::admin::get_audit_log_detail),\n        )\n        .route(\n            \"/api/admin/holidays\",\n            get(handlers::admin::list_holidays).post(handlers::admin::create_holiday),\n        )\n        .route(\n            \"/api/admin/holidays/weekly\",\n            get(handlers::admin::list_weekly_holidays).post(handlers::admin::create_weekly_holiday),\n        )\n        .route(\n            \"/api/admin/holidays/weekly/{id}\",\n            delete(handlers::admin::delete_weekly_holiday),\n        )\n        .route(\"/api/admin/users\", get(handlers::admin::get_users))\n        .route(\n            \"/api/admin/users/{id}/sessions\",\n            get(handlers::admin::list_user_sessions),\n        )\n        .route(\n            \"/api/admin/sessions/{id}\",\n            delete(handlers::admin::revoke_session),\n        )\n        .route(\n            \"/api/admin/attendance\",\n            get(handlers::admin::get_all_attendance),\n        )\n        .route(\n            \"/api/admin/holidays/{id}\",\n            delete(handlers::admin::delete_holiday),\n        )\n        .route(\n            \"/api/admin/holidays/google\",\n            get(handlers::holidays::fetch_google_holidays),\n        )\n        .route(\n            \"/api/admin/users/{user_id}/holiday-exceptions\",\n            post(handlers::holiday_exceptions::create_holiday_exception)\n                .get(handlers::holiday_exceptions::list_holiday_exceptions),\n        )\n        .route(\n            \"/api/admin/users/{user_id}/holiday-exceptions/{id}\",\n            delete(handlers::holiday_exceptions::delete_holiday_exception),\n        )\n        .route(\"/api/admin/export\", get(handlers::admin::export_data))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            middleware::auth_admin,\n        ))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            middleware::audit_log,\n        ))\n}\n\nfn system_admin_routes(state: AppState) -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/api/admin/users\", post(handlers::admin::create_user))\n        .route(\n            \"/api/admin/attendance\",\n            put(handlers::admin::upsert_attendance),\n        )\n        .route(\n            \"/api/admin/breaks/{id}/force-end\",\n            put(handlers::admin::force_end_break),\n        )\n        .route(\n            \"/api/admin/mfa/reset\",\n            post(handlers::admin::reset_user_mfa),\n        )\n        .route(\"/api/admin/users/{id}\", put(handlers::admin::update_user))\n        .route(\n            \"/api/admin/users/{id}\",\n            delete(handlers::admin::delete_user),\n        )\n        .route(\n            \"/api/admin/archived-users\",\n            get(handlers::admin::get_archived_users),\n        )\n        .route(\n            \"/api/admin/archived-users/{id}\",\n            delete(handlers::admin::delete_archived_user),\n        )\n        .route(\n            \"/api/admin/archived-users/{id}/restore\",\n            post(handlers::admin::restore_archived_user),\n        )\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            middleware::auth_system_admin,\n        ))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state,\n            middleware::audit_log,\n        ))\n}\n\nfn init_tracing() {\n    tracing_subscriber::registry()\n        .with(\n            tracing_subscriber::EnvFilter::try_from_default_env()\n                .unwrap_or_else(|_| \"timekeeper_backend=debug,tower_http=debug\".into()),\n        )\n        .with(tracing_subscriber::fmt::layer())\n        .init();\n}\n\nfn log_config(config: \u0026Config) {\n    tracing::info!(\n        \"Database URL: {}\",\n        crate::utils::security::mask_database_url(\u0026config.database_url)\n    );\n    if let Some(url) = \u0026config.read_database_url {\n        tracing::info!(\n            \"Read Database URL: {}\",\n            crate::utils::security::mask_database_url(url)\n        );\n    } else {\n        tracing::info!(\"Read Database URL: None\");\n    }\n    tracing::info!(\"JWT Expiration: {} hours\", config.jwt_expiration_hours);\n    tracing::info!(\"Time Zone: {}\", config.time_zone);\n    tracing::info!(\"CORS Allowed Origins: {:?}\", config.cors_allow_origins);\n\n    if config.cors_allow_origins.iter().any(|o| o == \"*\") {\n        if config.production_mode {\n            tracing::error!(\"SECURITY ERROR: CORS is configured to allow all origins ('*') in PRODUCTION MODE. This is a severe security risk. The server will refuse to start.\");\n            panic!(\"Refusing to start due to insecure CORS configuration in production mode.\");\n        }\n        tracing::warn!(\"SECURITY WARNING: CORS is configured to allow all origins ('*'). This is dangerous for production!\");\n    }\n}\n\nfn cors_layer(config: \u0026Config) -\u003e CorsLayer {\n    let mut layer = CorsLayer::new()\n        .allow_methods([Method::GET, Method::POST, Method::PUT, Method::DELETE])\n        .allow_headers([ACCEPT, AUTHORIZATION, CONTENT_TYPE])\n        .allow_credentials(true)\n        .max_age(Duration::from_secs(24 * 60 * 60));\n\n    if config.cors_allow_origins.contains(\u0026\"*\".to_string()) {\n        layer = layer.allow_origin(AllowOrigin::predicate(|_, _| true));\n    } else {\n        let origins: Vec\u003cHeaderValue\u003e = config\n            .cors_allow_origins\n            .iter()\n            .map(|s| s.parse().expect(\"Invalid CORS origin\"))\n            .collect();\n        layer = layer.allow_origin(origins);\n    }\n\n    layer\n}\n\nfn spawn_audit_log_cleanup(\n    audit_log_service: Arc\u003cdyn AuditLogServiceTrait\u003e,\n    retention_policy: AuditLogRetentionPolicy,\n) {\n    if !retention_policy.is_recording_enabled() {\n        return;\n    }\n\n    tracing::info!(\n        retention_days = retention_policy.retention_days(),\n        \"Starting daily audit log cleanup task\"\n    );\n\n    tokio::spawn(async move {\n        let mut interval = tokio::time::interval(Duration::from_secs(24 * 3600));\n        loop {\n            interval.tick().await;\n            let Some(cutoff) = retention_policy.cleanup_cutoff(Utc::now()) else {\n                continue;\n            };\n            match audit_log_service.delete_logs_before(cutoff).await {\n                Ok(deleted) =\u003e {\n                    tracing::info!(deleted, \"Audit log cleanup completed\");\n                }\n                Err(err) =\u003e {\n                    tracing::warn!(error = ?err, \"Audit log cleanup failed\");\n                }\n            }\n        }\n    });\n}\n\nfn spawn_consent_log_cleanup(\n    consent_log_service: Arc\u003cConsentLogService\u003e,\n    retention_policy: AuditLogRetentionPolicy,\n) {\n    if !retention_policy.is_recording_enabled() {\n        return;\n    }\n    tracing::info!(\n        retention_days = retention_policy.retention_days(),\n        \"Starting daily consent log cleanup task\"\n    );\n\n    tokio::spawn(async move {\n        let mut interval = tokio::time::interval(Duration::from_secs(24 * 3600));\n        loop {\n            interval.tick().await;\n            let Some(cutoff) = retention_policy.cleanup_cutoff(Utc::now()) else {\n                continue;\n            };\n            match consent_log_service.delete_logs_before(cutoff).await {\n                Ok(deleted) =\u003e {\n                    tracing::info!(deleted, \"Consent log cleanup completed\");\n                }\n                Err(err) =\u003e {\n                    tracing::warn!(error = ?err, \"Consent log cleanup failed\");\n                }\n            }\n        }\n    });\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::{body::Body, extract::ConnectInfo, http::Request};\n    use chrono_tz::UTC;\n    use sqlx::postgres::PgPoolOptions;\n    use std::{\n        collections::HashMap,\n        io,\n        net::SocketAddr,\n        sync::{Arc, Mutex},\n    };\n    use tower::Service;\n    use tracing::{\n        field::{Field, Visit},\n        span::{Attributes, Id, Record},\n    };\n    use tracing_subscriber::{\n        fmt::MakeWriter,\n        layer::{Context, Layer},\n        registry::LookupSpan,\n    };\n\n    fn test_config(cors_allow_origins: Vec\u003cString\u003e) -\u003e Config {\n        Config {\n            database_url: \"postgres://test\".to_string(),\n            read_database_url: None,\n            jwt_secret: \"test-jwt-secret-32-chars-minimum!\".to_string(),\n            jwt_expiration_hours: 1,\n            refresh_token_expiration_days: 7,\n            max_concurrent_sessions: 3,\n            audit_log_retention_days: 1825,\n            audit_log_retention_forever: false,\n            consent_log_retention_days: 1825,\n            consent_log_retention_forever: false,\n            aws_region: \"ap-northeast-1\".to_string(),\n            aws_kms_key_id: \"alias/timekeeper-test\".to_string(),\n            aws_audit_log_bucket: \"timekeeper-audit-logs\".to_string(),\n            aws_cloudtrail_enabled: true,\n            cookie_secure: false,\n            cookie_same_site: crate::utils::cookies::SameSite::Lax,\n            cors_allow_origins,\n            time_zone: UTC,\n            mfa_issuer: \"Timekeeper\".to_string(),\n            rate_limit_ip_max_requests: 15,\n            rate_limit_ip_window_seconds: 900,\n            rate_limit_user_max_requests: 20,\n            rate_limit_user_window_seconds: 3600,\n            redis_url: None,\n            redis_pool_size: 10,\n            redis_connect_timeout: 5,\n            feature_redis_cache_enabled: true,\n            feature_read_replica_enabled: true,\n            password_min_length: 12,\n            password_require_uppercase: true,\n            password_require_lowercase: true,\n            password_require_numbers: true,\n            password_require_symbols: true,\n            password_expiration_days: 90,\n            password_history_count: 5,\n            production_mode: false,\n        }\n    }\n\n    #[test]\n    #[should_panic(\n        expected = \"Refusing to start due to insecure CORS configuration in production mode\"\n    )]\n    fn test_production_mode_wildcard_cors_panics() {\n        let mut config = test_config(vec![\"*\".to_string()]);\n        config.production_mode = true;\n        log_config(\u0026config);\n    }\n\n    #[test]\n    fn test_production_mode_specific_cors_allows() {\n        let mut config = test_config(vec![\"https://example.com\".to_string()]);\n        config.production_mode = true;\n        log_config(\u0026config);\n    }\n\n    #[tokio::test]\n    async fn test_app_router_builds() {\n        let config = test_config(vec![\"*\".to_string()]);\n        let pool = PgPoolOptions::new()\n            .max_connections(1)\n            .connect_lazy(\u0026config.database_url)\n            .expect(\"create lazy pool\");\n        let state = AppState::new(pool, None, None, None, config);\n\n        let mut app = Router::new()\n            .merge(public_routes(state.clone()))\n            .with_state(state);\n\n        let mut request = Request::builder()\n            .uri(\"/api/config/timezone\")\n            .body(Body::empty())\n            .unwrap();\n        request\n            .extensions_mut()\n            .insert(ConnectInfo(SocketAddr::from(([127, 0, 0, 1], 3000))));\n        let response = app.call(request).await.unwrap();\n\n        assert_eq!(response.status(), axum::http::StatusCode::OK);\n    }\n\n    #[derive(Default, Clone)]\n    struct SpanStore {\n        data: Arc\u003cMutex\u003cHashMap\u003cString, HashMap\u003cString, String\u003e\u003e\u003e\u003e,\n    }\n\n    #[derive(Default, Clone)]\n    struct CaptureWriter {\n        buffer: Arc\u003cMutex\u003cVec\u003cu8\u003e\u003e\u003e,\n    }\n\n    struct CaptureWriterGuard {\n        buffer: Arc\u003cMutex\u003cVec\u003cu8\u003e\u003e\u003e,\n    }\n\n    impl\u003c'a\u003e MakeWriter\u003c'a\u003e for CaptureWriter {\n        type Writer = CaptureWriterGuard;\n\n        fn make_writer(\u0026'a self) -\u003e Self::Writer {\n            CaptureWriterGuard {\n                buffer: Arc::clone(\u0026self.buffer),\n            }\n        }\n    }\n\n    impl io::Write for CaptureWriterGuard {\n        fn write(\u0026mut self, buf: \u0026[u8]) -\u003e io::Result\u003cusize\u003e {\n            let mut buffer = self.buffer.lock().expect(\"lock log buffer\");\n            buffer.extend_from_slice(buf);\n            Ok(buf.len())\n        }\n\n        fn flush(\u0026mut self) -\u003e io::Result\u003c()\u003e {\n            Ok(())\n        }\n    }\n\n    #[derive(Default)]\n    struct FieldCapture {\n        fields: HashMap\u003cString, String\u003e,\n    }\n\n    impl FieldCapture {\n        fn record_value(\u0026mut self, field: \u0026Field, value: String) {\n            self.fields.insert(field.name().to_string(), value);\n        }\n    }\n\n    impl Visit for FieldCapture {\n        fn record_i64(\u0026mut self, field: \u0026Field, value: i64) {\n            self.record_value(field, value.to_string());\n        }\n\n        fn record_u64(\u0026mut self, field: \u0026Field, value: u64) {\n            self.record_value(field, value.to_string());\n        }\n\n        fn record_bool(\u0026mut self, field: \u0026Field, value: bool) {\n            self.record_value(field, value.to_string());\n        }\n\n        fn record_str(\u0026mut self, field: \u0026Field, value: \u0026str) {\n            self.record_value(field, value.to_string());\n        }\n\n        fn record_f64(\u0026mut self, field: \u0026Field, value: f64) {\n            self.record_value(field, value.to_string());\n        }\n\n        fn record_debug(\u0026mut self, field: \u0026Field, value: \u0026dyn std::fmt::Debug) {\n            self.record_value(field, format!(\"{:?}\", value));\n        }\n    }\n\n    struct SpanName(String);\n\n    impl\u003cS\u003e Layer\u003cS\u003e for SpanStore\n    where\n        S: tracing::Subscriber + for\u003c'a\u003e LookupSpan\u003c'a\u003e,\n    {\n        fn on_new_span(\u0026self, attrs: \u0026Attributes\u003c'_\u003e, id: \u0026Id, ctx: Context\u003c'_, S\u003e) {\n            let mut visitor = FieldCapture::default();\n            attrs.record(\u0026mut visitor);\n            let name = attrs.metadata().name().to_string();\n\n            {\n                let mut data = self.data.lock().expect(\"lock span data\");\n                data.insert(name.clone(), visitor.fields);\n            }\n\n            if let Some(span) = ctx.span(id) {\n                span.extensions_mut().insert(SpanName(name));\n            }\n        }\n\n        fn on_record(\u0026self, id: \u0026Id, values: \u0026Record\u003c'_\u003e, ctx: Context\u003c'_, S\u003e) {\n            let mut visitor = FieldCapture::default();\n            values.record(\u0026mut visitor);\n            if visitor.fields.is_empty() {\n                return;\n            }\n\n            if let Some(span) = ctx.span(id) {\n                if let Some(name) = span.extensions().get::\u003cSpanName\u003e() {\n                    let mut data = self.data.lock().expect(\"lock span data\");\n                    let entry = data.entry(name.0.clone()).or_default();\n                    entry.extend(visitor.fields);\n                }\n            }\n        }\n    }\n\n    #[test]\n    fn test_http_request_span_fields_are_recorded() {\n        let store = SpanStore::default();\n        let subscriber = tracing_subscriber::registry()\n            .with(\n                tracing_subscriber::fmt::layer()\n                    .with_test_writer()\n                    .with_ansi(false),\n            )\n            .with(store.clone());\n\n        tracing::subscriber::with_default(subscriber, || {\n            let mut request = Request::builder()\n                .method(\"GET\")\n                .uri(\"/api/attendance/status\")\n                .version(axum::http::Version::HTTP_11)\n                .body(Body::empty())\n                .expect(\"build request\");\n            request\n                .extensions_mut()\n                .insert(middleware::RequestId(\"req-123\".to_string()));\n\n            let span = build_http_request_span(\u0026request);\n            span.record(\"user_id\", \u0026\"42\");\n            span.record(\"username\", \u0026\"alice\");\n\n            let _guard = span.enter();\n            tracing::info!(\"span capture test\");\n        });\n\n        let data = store.data.lock().expect(\"lock span data\");\n        let span_fields = data\n            .get(\"http_request\")\n            .expect(\"http_request span recorded\");\n\n        assert_eq!(span_fields.get(\"method\").map(String::as_str), Some(\"GET\"));\n        assert_eq!(\n            span_fields.get(\"uri\").map(String::as_str),\n            Some(\"/api/attendance/status\")\n        );\n        assert_eq!(\n            span_fields.get(\"version\").map(String::as_str),\n            Some(\"HTTP/1.1\")\n        );\n        assert_eq!(\n            span_fields.get(\"request_id\").map(String::as_str),\n            Some(\"req-123\")\n        );\n        assert_eq!(span_fields.get(\"user_id\").map(String::as_str), Some(\"42\"));\n        assert_eq!(\n            span_fields.get(\"username\").map(String::as_str),\n            Some(\"alice\")\n        );\n    }\n\n    #[test]\n    fn test_http_request_span_does_not_log_sensitive_values() {\n        let store = SpanStore::default();\n        let writer = CaptureWriter::default();\n        let subscriber = tracing_subscriber::registry()\n            .with(\n                tracing_subscriber::fmt::layer()\n                    .with_writer(writer.clone())\n                    .with_ansi(false),\n            )\n            .with(store.clone());\n\n        tracing::subscriber::with_default(subscriber, || {\n            let mut request = Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/auth/login\")\n                .header(\"Authorization\", \"Bearer super-secret-token\")\n                .body(Body::from(\n                    r#\"{\"password\":\"P@ssw0rd\",\"token\":\"secret-token\"}\"#,\n                ))\n                .expect(\"build request\");\n            request\n                .extensions_mut()\n                .insert(middleware::RequestId(\"req-123\".to_string()));\n\n            let span = build_http_request_span(\u0026request);\n            let _guard = span.enter();\n            tracing::info!(\"login attempt\");\n        });\n\n        let data = store.data.lock().expect(\"lock span data\");\n        let span_fields = data\n            .get(\"http_request\")\n            .expect(\"http_request span recorded\");\n        let sensitive_values = [\"super-secret-token\", \"P@ssw0rd\", \"secret-token\"];\n\n        for value in sensitive_values {\n            let leaked_field = span_fields.values().any(|field| field.contains(value));\n            assert!(\n                !leaked_field,\n                \"span fields should not contain sensitive value: {}\",\n                value\n            );\n        }\n\n        let output = String::from_utf8(writer.buffer.lock().expect(\"lock log buffer\").clone())\n            .expect(\"log output should be valid utf-8\");\n        for value in sensitive_values {\n            assert!(\n                !output.contains(value),\n                \"log output should not contain sensitive value: {}\",\n                value\n            );\n        }\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","middleware","audit_log.rs"],"content":"use axum::{\n    body::{Body, Bytes},\n    extract::{Request, State},\n    http::{header::USER_AGENT, HeaderMap, Method},\n    middleware::Next,\n    response::Response,\n};\nuse chrono::Utc;\nuse http_body::{Body as HttpBody, Frame};\nuse http_body_util::BodyExt;\nuse serde_json::{json, Map, Value};\nuse std::collections::VecDeque;\nuse std::pin::Pin;\nuse std::sync::Arc;\nuse std::task::{Context, Poll};\nuse uuid::Uuid;\n\nuse crate::{\n    middleware::request_id::RequestId,\n    models::user::User,\n    services::audit_log::{AuditLogEntry, AuditLogServiceTrait},\n    state::AppState,\n};\n\nconst DEFAULT_CLOCK_SOURCE: \u0026str = \"api\";\nconst MAX_BUFFERED_BODY_BYTES: usize = 64 * 1024;\nconst REQUEST_TYPE_UNKNOWN: \u0026str = \"unknown\";\n\nstruct AuditEventDescriptor {\n    event_type: \u0026'static str,\n    target_type: Option\u003c\u0026'static str\u003e,\n    target_id: Option\u003cString\u003e,\n}\n\npub async fn audit_log(\n    State(state): State\u003cAppState\u003e,\n    mut request: Request,\n    next: Next,\n) -\u003e Response {\n    let method = request.method().clone();\n    let path = request.uri().path().to_string();\n    let descriptor = classify_event(\u0026method, \u0026path);\n\n    if descriptor.is_none() {\n        return next.run(request).await;\n    }\n\n    let headers = request.headers().clone();\n    let body_bytes = if let Some(descriptor_ref) = descriptor.as_ref() {\n        if needs_body_for_metadata(descriptor_ref.event_type) {\n            let (buffered_request, bytes) = buffer_request_body(request).await;\n            request = buffered_request;\n            bytes\n        } else {\n            None\n        }\n    } else {\n        None\n    };\n\n    let audit_service = request\n        .extensions()\n        .get::\u003cArc\u003cdyn AuditLogServiceTrait\u003e\u003e()\n        .cloned();\n    let actor_before = request.extensions().get::\u003cUser\u003e().cloned();\n    let request_id = request\n        .extensions()\n        .get::\u003cRequestId\u003e()\n        .map(|id| id.0.clone())\n        .unwrap_or_else(|| extract_request_id(\u0026headers));\n\n    let response = next.run(request).await;\n\n    if !state\n        .config\n        .audit_log_retention_policy()\n        .is_recording_enabled()\n    {\n        return response;\n    }\n\n    let Some(descriptor) = descriptor else {\n        return response;\n    };\n    let Some(audit_service) = audit_service else {\n        return response;\n    };\n\n    let status = response.status();\n    let actor = response\n        .extensions()\n        .get::\u003cUser\u003e()\n        .cloned()\n        .or_else(|| actor_before.clone());\n    let result = if status.is_client_error() || status.is_server_error() {\n        \"failure\"\n    } else {\n        \"success\"\n    };\n    let error_code = if result == \"failure\" {\n        Some(format!(\"http_{}\", status.as_u16()))\n    } else {\n        None\n    };\n\n    let entry = AuditLogEntry {\n        occurred_at: Utc::now(),\n        actor_id: actor.as_ref().map(|user| user.id),\n        actor_type: actor\n            .as_ref()\n            .map(|_| \"user\".to_string())\n            .unwrap_or_else(|| \"anonymous\".to_string()),\n        event_type: descriptor.event_type.to_string(),\n        target_type: descriptor.target_type.map(|value| value.to_string()),\n        target_id: descriptor.target_id,\n        result: result.to_string(),\n        error_code,\n        metadata: build_metadata(\n            descriptor.event_type,\n            \u0026headers,\n            \u0026state,\n            actor.as_ref(),\n            body_bytes.as_ref(),\n        ),\n        ip: extract_ip(\u0026headers),\n        user_agent: extract_user_agent(\u0026headers),\n        request_id: Some(request_id),\n    };\n\n    let method = method.to_string();\n    tokio::spawn(async move {\n        if let Err(err) = audit_service.record_event(entry).await {\n            tracing::warn!(\n                error = ?err,\n                method = %method,\n                path = %path,\n                \"Failed to record audit log\"\n            );\n        }\n    });\n\n    response\n}\n\nstruct BufferedBody {\n    buffered: VecDeque\u003cFrame\u003cBytes\u003e\u003e,\n    inner: Body,\n    pending_error: Option\u003caxum::Error\u003e,\n}\n\nimpl BufferedBody {\n    fn new(\n        buffered: VecDeque\u003cFrame\u003cBytes\u003e\u003e,\n        inner: Body,\n        pending_error: Option\u003caxum::Error\u003e,\n    ) -\u003e Self {\n        Self {\n            buffered,\n            inner,\n            pending_error,\n        }\n    }\n\n    fn buffered_len(\u0026self) -\u003e u64 {\n        self.buffered\n            .iter()\n            .filter_map(|frame| frame.data_ref().map(|data| data.len() as u64))\n            .sum()\n    }\n}\n\nimpl HttpBody for BufferedBody {\n    type Data = Bytes;\n    type Error = axum::Error;\n\n    fn poll_frame(\n        self: Pin\u003c\u0026mut Self\u003e,\n        cx: \u0026mut Context\u003c'_\u003e,\n    ) -\u003e Poll\u003cOption\u003cResult\u003cFrame\u003cSelf::Data\u003e, Self::Error\u003e\u003e\u003e {\n        let this = self.get_mut();\n        if let Some(frame) = this.buffered.pop_front() {\n            return Poll::Ready(Some(Ok(frame)));\n        }\n        if let Some(err) = this.pending_error.take() {\n            this.inner = Body::empty();\n            return Poll::Ready(Some(Err(err)));\n        }\n        Pin::new(\u0026mut this.inner).poll_frame(cx)\n    }\n\n    fn size_hint(\u0026self) -\u003e http_body::SizeHint {\n        let buffered_len = self.buffered_len();\n        let mut hint = self.inner.size_hint();\n        hint.set_lower(hint.lower().saturating_add(buffered_len));\n        if let Some(upper) = hint.upper() {\n            hint.set_upper(upper.saturating_add(buffered_len));\n        }\n        hint\n    }\n\n    fn is_end_stream(\u0026self) -\u003e bool {\n        if !self.buffered.is_empty() || self.pending_error.is_some() {\n            return false;\n        }\n        self.inner.is_end_stream()\n    }\n}\n\nasync fn buffer_request_body(request: Request) -\u003e (Request, Option\u003cBytes\u003e) {\n    let (parts, mut body) = request.into_parts();\n    let mut buffered_frames = VecDeque::new();\n    let mut buffered_bytes = Vec::new();\n    let mut overflowed = false;\n    let mut pending_error = None;\n\n    while let Some(frame_result) = body.frame().await {\n        match frame_result {\n            Ok(frame) =\u003e {\n                if let Some(data) = frame.data_ref() {\n                    if !overflowed {\n                        let new_len = buffered_bytes.len() + data.len();\n                        if new_len \u003e MAX_BUFFERED_BODY_BYTES {\n                            overflowed = true;\n                        } else {\n                            buffered_bytes.extend_from_slice(data);\n                        }\n                    }\n                }\n                buffered_frames.push_back(frame);\n                if overflowed {\n                    break;\n                }\n            }\n            Err(err) =\u003e {\n                pending_error = Some(err);\n                break;\n            }\n        }\n    }\n\n    let body_bytes = if overflowed || pending_error.is_some() {\n        None\n    } else {\n        Some(Bytes::from(buffered_bytes))\n    };\n    let replay_body = BufferedBody::new(buffered_frames, body, pending_error);\n    let request = Request::from_parts(parts, Body::new(replay_body));\n    (request, body_bytes)\n}\n\nfn needs_body_for_metadata(event_type: \u0026str) -\u003e bool {\n    matches!(\n        event_type,\n        \"request_leave_create\"\n            | \"request_overtime_create\"\n            | \"request_update\"\n            | \"request_cancel\"\n            | \"consent_record\"\n            | \"subject_request_create\"\n            | \"admin_subject_request_approve\"\n            | \"admin_subject_request_reject\"\n    )\n}\n\nfn build_metadata(\n    event_type: \u0026str,\n    headers: \u0026HeaderMap,\n    state: \u0026AppState,\n    actor: Option\u003c\u0026User\u003e,\n    body_bytes: Option\u003c\u0026Bytes\u003e,\n) -\u003e Option\u003cValue\u003e {\n    match event_type {\n        \"attendance_clock_in\"\n        | \"attendance_clock_out\"\n        | \"attendance_break_start\"\n        | \"attendance_break_end\" =\u003e Some(build_attendance_metadata(event_type, headers, state)),\n        \"request_leave_create\"\n        | \"request_overtime_create\"\n        | \"request_update\"\n        | \"request_cancel\" =\u003e {\n            let payload = parse_json_body(body_bytes);\n            Some(build_request_metadata(event_type, payload.as_ref()))\n        }\n        \"consent_record\" =\u003e {\n            let payload = parse_json_body(body_bytes);\n            Some(build_consent_metadata(payload.as_ref()))\n        }\n        \"subject_request_create\"\n        | \"subject_request_cancel\"\n        | \"admin_subject_request_approve\"\n        | \"admin_subject_request_reject\" =\u003e {\n            let payload = parse_json_body(body_bytes);\n            Some(build_subject_request_metadata(event_type, payload.as_ref()))\n        }\n        \"admin_request_approve\" | \"admin_request_reject\" =\u003e {\n            Some(build_approval_metadata(event_type))\n        }\n        \"password_change\" =\u003e Some(build_password_change_metadata(actor)),\n        _ =\u003e None,\n    }\n}\n\nfn build_attendance_metadata(event_type: \u0026str, headers: \u0026HeaderMap, state: \u0026AppState) -\u003e Value {\n    let clock_type = match event_type {\n        \"attendance_clock_in\" =\u003e \"clock_in\",\n        \"attendance_clock_out\" =\u003e \"clock_out\",\n        \"attendance_break_start\" =\u003e \"break_start\",\n        \"attendance_break_end\" =\u003e \"break_end\",\n        _ =\u003e \"unknown\",\n    };\n    let source = extract_source(headers);\n    json!({\n        \"clock_type\": clock_type,\n        \"timezone\": state.config.time_zone.to_string(),\n        \"source\": source,\n    })\n}\n\nfn build_request_metadata(event_type: \u0026str, payload: Option\u003c\u0026Value\u003e) -\u003e Value {\n    let request_type = match event_type {\n        \"request_leave_create\" =\u003e \"leave\",\n        \"request_overtime_create\" =\u003e \"overtime\",\n        _ =\u003e infer_request_type(payload).unwrap_or(REQUEST_TYPE_UNKNOWN),\n    };\n    let payload_summary = build_request_payload_summary(request_type, payload);\n    json!({\n        \"request_type\": request_type,\n        \"payload_summary\": payload_summary,\n    })\n}\n\nfn build_request_payload_summary(request_type: \u0026str, payload: Option\u003c\u0026Value\u003e) -\u003e Value {\n    let mut summary = Map::new();\n    if let Some(payload) = payload {\n        match request_type {\n            \"leave\" =\u003e {\n                insert_string_if_present(\u0026mut summary, payload, \"leave_type\");\n                insert_string_if_present(\u0026mut summary, payload, \"start_date\");\n                insert_string_if_present(\u0026mut summary, payload, \"end_date\");\n            }\n            \"overtime\" =\u003e {\n                insert_string_if_present(\u0026mut summary, payload, \"date\");\n                insert_number_if_present(\u0026mut summary, payload, \"planned_hours\");\n            }\n            _ =\u003e {\n                insert_string_if_present(\u0026mut summary, payload, \"leave_type\");\n                insert_string_if_present(\u0026mut summary, payload, \"start_date\");\n                insert_string_if_present(\u0026mut summary, payload, \"end_date\");\n                insert_string_if_present(\u0026mut summary, payload, \"date\");\n                insert_number_if_present(\u0026mut summary, payload, \"planned_hours\");\n            }\n        }\n    }\n    Value::Object(summary)\n}\n\nfn build_consent_metadata(payload: Option\u003c\u0026Value\u003e) -\u003e Value {\n    let mut summary = Map::new();\n    if let Some(payload) = payload {\n        insert_string_if_present(\u0026mut summary, payload, \"purpose\");\n        insert_string_if_present(\u0026mut summary, payload, \"policy_version\");\n    }\n    Value::Object(summary)\n}\n\nfn build_subject_request_metadata(event_type: \u0026str, payload: Option\u003c\u0026Value\u003e) -\u003e Value {\n    let mut summary = Map::new();\n    match event_type {\n        \"subject_request_create\" =\u003e {\n            let request_type = payload\n                .and_then(|value| value.get(\"request_type\"))\n                .and_then(Value::as_str)\n                .unwrap_or(\"unknown\");\n            summary.insert(\n                \"request_type\".to_string(),\n                Value::String(request_type.to_string()),\n            );\n            let details_len = payload\n                .and_then(|value| value.get(\"details\"))\n                .and_then(Value::as_str)\n                .map(|value| value.chars().count() as u64);\n            summary.insert(\n                \"details_present\".to_string(),\n                Value::Bool(details_len.unwrap_or(0) \u003e 0),\n            );\n            if let Some(len) = details_len {\n                summary.insert(\n                    \"details_length\".to_string(),\n                    Value::Number(serde_json::Number::from(len)),\n                );\n            }\n        }\n        \"admin_subject_request_approve\" | \"admin_subject_request_reject\" =\u003e {\n            let decision = if event_type == \"admin_subject_request_approve\" {\n                \"approve\"\n            } else {\n                \"reject\"\n            };\n            summary.insert(\"decision\".to_string(), Value::String(decision.to_string()));\n            let comment_len = payload\n                .and_then(|value| value.get(\"comment\"))\n                .and_then(Value::as_str)\n                .map(|value| value.chars().count() as u64);\n            summary.insert(\n                \"comment_present\".to_string(),\n                Value::Bool(comment_len.unwrap_or(0) \u003e 0),\n            );\n            if let Some(len) = comment_len {\n                summary.insert(\n                    \"comment_length\".to_string(),\n                    Value::Number(serde_json::Number::from(len)),\n                );\n            }\n        }\n        \"subject_request_cancel\" =\u003e {\n            summary.insert(\"status\".to_string(), Value::String(\"cancelled\".to_string()));\n        }\n        _ =\u003e {}\n    }\n    Value::Object(summary)\n}\n\nfn insert_string_if_present(summary: \u0026mut Map\u003cString, Value\u003e, payload: \u0026Value, key: \u0026str) {\n    if let Some(value) = payload.get(key).and_then(Value::as_str) {\n        summary.insert(key.to_string(), Value::String(value.to_string()));\n    }\n}\n\nfn insert_number_if_present(summary: \u0026mut Map\u003cString, Value\u003e, payload: \u0026Value, key: \u0026str) {\n    if let Some(value) = payload.get(key).and_then(Value::as_f64) {\n        summary.insert(key.to_string(), json!(value));\n    }\n}\n\nfn infer_request_type(payload: Option\u003c\u0026Value\u003e) -\u003e Option\u003c\u0026'static str\u003e {\n    let payload = payload?;\n    if payload.get(\"leave_type\").is_some()\n        || payload.get(\"start_date\").is_some()\n        || payload.get(\"end_date\").is_some()\n    {\n        return Some(\"leave\");\n    }\n    if payload.get(\"planned_hours\").is_some() || payload.get(\"date\").is_some() {\n        return Some(\"overtime\");\n    }\n    None\n}\n\nfn build_approval_metadata(event_type: \u0026str) -\u003e Value {\n    let decision = if event_type == \"admin_request_approve\" {\n        \"approve\"\n    } else {\n        \"reject\"\n    };\n    json!({\n        \"approval_step\": \"single\",\n        \"decision\": decision,\n    })\n}\n\nfn build_password_change_metadata(actor: Option\u003c\u0026User\u003e) -\u003e Value {\n    let mfa_value = actor\n        .map(|user| Value::Bool(user.is_mfa_enabled()))\n        .unwrap_or(Value::Null);\n    json!({\n        \"method\": \"password\",\n        \"mfa_enabled\": mfa_value,\n    })\n}\n\nfn parse_json_body(body_bytes: Option\u003c\u0026Bytes\u003e) -\u003e Option\u003cValue\u003e {\n    let bytes = body_bytes?;\n    if bytes.is_empty() {\n        return None;\n    }\n    serde_json::from_slice(bytes).ok()\n}\n\nfn extract_source(headers: \u0026HeaderMap) -\u003e String {\n    headers\n        .get(\"x-client-source\")\n        .or_else(|| headers.get(\"x-source\"))\n        .and_then(|value| value.to_str().ok())\n        .map(|value| value.trim())\n        .filter(|value| !value.is_empty())\n        .map(|value| value.to_string())\n        .unwrap_or_else(|| DEFAULT_CLOCK_SOURCE.to_string())\n}\n\nfn classify_event(method: \u0026Method, path: \u0026str) -\u003e Option\u003cAuditEventDescriptor\u003e {\n    let normalized = path.trim_end_matches('/');\n    if !normalized.starts_with(\"/api/\") {\n        return None;\n    }\n    if is_excluded(method, normalized) {\n        return None;\n    }\n\n    let segments: Vec\u003c\u0026str\u003e = normalized.trim_start_matches('/').split('/').collect();\n\n    match (method, segments.as_slice()) {\n        (\u0026Method::POST, [\"api\", \"auth\", \"login\"]) =\u003e Some(event(\"auth_login\", \"user\", None)),\n        (\u0026Method::POST, [\"api\", \"auth\", \"refresh\"]) =\u003e Some(event(\"auth_refresh\", \"user\", None)),\n        (\u0026Method::POST, [\"api\", \"auth\", \"logout\"]) =\u003e Some(event(\"auth_logout\", \"user\", None)),\n        (\u0026Method::GET, [\"api\", \"auth\", \"sessions\"]) =\u003e {\n            Some(event(\"auth_session_list\", \"session\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"auth\", \"mfa\", \"register\"]) =\u003e {\n            Some(event(\"mfa_register\", \"user\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"auth\", \"mfa\", \"setup\"]) =\u003e Some(event(\"mfa_setup\", \"user\", None)),\n        (\u0026Method::POST, [\"api\", \"auth\", \"mfa\", \"activate\"]) =\u003e {\n            Some(event(\"mfa_activate\", \"user\", None))\n        }\n        (\u0026Method::DELETE, [\"api\", \"auth\", \"mfa\"]) =\u003e Some(event(\"mfa_disable\", \"user\", None)),\n        (\u0026Method::PUT, [\"api\", \"auth\", \"change-password\"]) =\u003e {\n            Some(event(\"password_change\", \"user\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"attendance\", \"clock-in\"]) =\u003e {\n            Some(event(\"attendance_clock_in\", \"attendance\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"attendance\", \"clock-out\"]) =\u003e {\n            Some(event(\"attendance_clock_out\", \"attendance\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"attendance\", \"break-start\"]) =\u003e {\n            Some(event(\"attendance_break_start\", \"break_record\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"attendance\", \"break-end\"]) =\u003e {\n            Some(event(\"attendance_break_end\", \"break_record\", None))\n        }\n        (\u0026Method::GET, [\"api\", \"attendance\", \"export\"]) =\u003e {\n            Some(event(\"attendance_export\", \"export\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"requests\", \"leave\"]) =\u003e {\n            Some(event(\"request_leave_create\", \"request\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"requests\", \"overtime\"]) =\u003e {\n            Some(event(\"request_overtime_create\", \"request\", None))\n        }\n        (\u0026Method::PUT, [\"api\", \"requests\", request_id]) =\u003e Some(event(\n            \"request_update\",\n            \"request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::DELETE, [\"api\", \"requests\", request_id]) =\u003e Some(event(\n            \"request_cancel\",\n            \"request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::POST, [\"api\", \"consents\"]) =\u003e Some(event(\"consent_record\", \"consent_log\", None)),\n        (\u0026Method::POST, [\"api\", \"subject-requests\"]) =\u003e {\n            Some(event(\"subject_request_create\", \"subject_request\", None))\n        }\n        (\u0026Method::DELETE, [\"api\", \"subject-requests\", request_id]) =\u003e Some(event(\n            \"subject_request_cancel\",\n            \"subject_request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::GET, [\"api\", \"admin\", \"subject-requests\"]) =\u003e {\n            Some(event(\"admin_subject_request_list\", \"subject_request\", None))\n        }\n        (\u0026Method::PUT, [\"api\", \"admin\", \"subject-requests\", request_id, \"approve\"]) =\u003e Some(event(\n            \"admin_subject_request_approve\",\n            \"subject_request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::PUT, [\"api\", \"admin\", \"subject-requests\", request_id, \"reject\"]) =\u003e Some(event(\n            \"admin_subject_request_reject\",\n            \"subject_request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::GET, [\"api\", \"admin\", \"requests\"]) =\u003e {\n            Some(event(\"admin_request_list\", \"system\", None))\n        }\n        (\u0026Method::GET, [\"api\", \"admin\", \"requests\", request_id]) =\u003e Some(event(\n            \"admin_request_detail\",\n            \"request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::GET, [\"api\", \"admin\", \"audit-logs\"]) =\u003e {\n            Some(event(\"admin_audit_log_list\", \"audit_log\", None))\n        }\n        (\u0026Method::GET, [\"api\", \"admin\", \"audit-logs\", \"export\"]) =\u003e {\n            Some(event(\"admin_audit_log_export\", \"audit_log\", None))\n        }\n        (\u0026Method::GET, [\"api\", \"admin\", \"audit-logs\", audit_log_id]) =\u003e Some(event(\n            \"admin_audit_log_detail\",\n            \"audit_log\",\n            Some((*audit_log_id).to_string()),\n        )),\n        (\u0026Method::PUT, [\"api\", \"admin\", \"requests\", request_id, \"approve\"]) =\u003e Some(event(\n            \"admin_request_approve\",\n            \"request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::PUT, [\"api\", \"admin\", \"requests\", request_id, \"reject\"]) =\u003e Some(event(\n            \"admin_request_reject\",\n            \"request\",\n            Some((*request_id).to_string()),\n        )),\n        (\u0026Method::GET, [\"api\", \"admin\", \"holidays\"]) =\u003e {\n            Some(event(\"admin_holiday_list\", \"system\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"admin\", \"holidays\"]) =\u003e {\n            Some(event(\"admin_holiday_create\", \"holiday\", None))\n        }\n        (\u0026Method::DELETE, [\"api\", \"admin\", \"holidays\", holiday_id]) =\u003e Some(event(\n            \"admin_holiday_delete\",\n            \"holiday\",\n            Some((*holiday_id).to_string()),\n        )),\n        (\u0026Method::GET, [\"api\", \"admin\", \"holidays\", \"weekly\"]) =\u003e {\n            Some(event(\"admin_weekly_holiday_list\", \"system\", None))\n        }\n        (\u0026Method::POST, [\"api\", \"admin\", \"holidays\", \"weekly\"]) =\u003e {\n            Some(event(\"admin_weekly_holiday_create\", \"weekly_holiday\", None))\n        }\n        (\u0026Method::GET, [\"api\", \"admin\", \"holidays\", \"google\"]) =\u003e {\n            Some(event(\"admin_holiday_google_fetch\", \"system\", None))\n        }\n        (\u0026Method::GET, [\"api\", \"admin\", \"users\", user_id, \"holiday-exceptions\"]) =\u003e Some(event(\n            \"admin_holiday_exception_list\",\n            \"user\",\n            Some((*user_id).to_string()),\n        )),\n        (\u0026Method::POST, [\"api\", \"admin\", \"users\", _, \"holiday-exceptions\"]) =\u003e Some(event(\n            \"admin_holiday_exception_create\",\n            \"holiday_exception\",\n            None,\n        )),\n        (\u0026Method::DELETE, [\"api\", \"admin\", \"users\", _, \"holiday-exceptions\", exception_id]) =\u003e {\n            Some(event(\n                \"admin_holiday_exception_delete\",\n                \"holiday_exception\",\n                Some((*exception_id).to_string()),\n            ))\n        }\n        (\u0026Method::GET, [\"api\", \"admin\", \"export\"]) =\u003e Some(event(\"admin_export\", \"export\", None)),\n        (\u0026Method::GET, [\"api\", \"admin\", \"users\"]) =\u003e Some(event(\"admin_user_list\", \"system\", None)),\n        (\u0026Method::POST, [\"api\", \"admin\", \"users\"]) =\u003e {\n            Some(event(\"admin_user_create\", \"user\", None))\n        }\n        (\u0026Method::GET, [\"api\", \"admin\", \"users\", user_id, \"sessions\"]) =\u003e Some(event(\n            \"admin_user_session_list\",\n            \"user\",\n            Some((*user_id).to_string()),\n        )),\n        (\u0026Method::GET, [\"api\", \"admin\", \"attendance\"]) =\u003e {\n            Some(event(\"admin_attendance_list\", \"system\", None))\n        }\n        (\u0026Method::PUT, [\"api\", \"admin\", \"attendance\"]) =\u003e {\n            Some(event(\"admin_attendance_upsert\", \"attendance\", None))\n        }\n        (\u0026Method::PUT, [\"api\", \"admin\", \"breaks\", break_id, \"force-end\"]) =\u003e Some(event(\n            \"admin_break_force_end\",\n            \"break_record\",\n            Some((*break_id).to_string()),\n        )),\n        (\u0026Method::POST, [\"api\", \"admin\", \"mfa\", \"reset\"]) =\u003e {\n            Some(event(\"admin_mfa_reset\", \"user\", None))\n        }\n        _ =\u003e None,\n    }\n}\n\nfn event(\n    event_type: \u0026'static str,\n    target_type: \u0026'static str,\n    target_id: Option\u003cString\u003e,\n) -\u003e AuditEventDescriptor {\n    AuditEventDescriptor {\n        event_type,\n        target_type: Some(target_type),\n        target_id,\n    }\n}\n\nfn is_excluded(method: \u0026Method, path: \u0026str) -\u003e bool {\n    let segments: Vec\u003c\u0026str\u003e = path.trim_start_matches('/').split('/').collect();\n    match (method, segments.as_slice()) {\n        (\u0026Method::GET, [\"api\", \"config\", \"timezone\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"auth\", \"me\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"auth\", \"mfa\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"holidays\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"holidays\", \"check\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"holidays\", \"month\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"attendance\", \"status\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"attendance\", \"me\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"attendance\", \"me\", \"summary\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"attendance\", _, \"breaks\"]) =\u003e true,\n        (\u0026Method::GET, [\"api\", \"requests\", \"me\"]) =\u003e true,\n        _ =\u003e path.starts_with(\"/api/docs\") || path.starts_with(\"/api-doc/\"),\n    }\n}\n\nfn extract_request_id(headers: \u0026HeaderMap) -\u003e String {\n    headers\n        .get(\"x-request-id\")\n        .or_else(|| headers.get(\"x-correlation-id\"))\n        .and_then(|value| value.to_str().ok())\n        .map(|value| value.to_string())\n        .unwrap_or_else(|| Uuid::new_v4().to_string())\n}\n\nfn extract_ip(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    headers\n        .get(\"x-forwarded-for\")\n        .or_else(|| headers.get(\"x-real-ip\"))\n        .and_then(|value| value.to_str().ok())\n        .map(|value| value.split(',').next().unwrap_or(value).trim().to_string())\n}\n\nfn extract_user_agent(headers: \u0026HeaderMap) -\u003e Option\u003cString\u003e {\n    headers\n        .get(USER_AGENT)\n        .and_then(|value| value.to_str().ok())\n        .map(|value| value.to_string())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::body::to_bytes;\n    use axum::http::StatusCode;\n\n    #[test]\n    fn classify_event_matches_dynamic_paths() {\n        let event = classify_event(\u0026Method::PUT, \"/api/admin/requests/req-123/approve\")\n            .expect(\"event should map\");\n        assert_eq!(event.event_type, \"admin_request_approve\");\n        assert_eq!(event.target_type, Some(\"request\"));\n        assert_eq!(event.target_id.as_deref(), Some(\"req-123\"));\n    }\n\n    #[test]\n    fn classify_event_matches_subject_request_paths() {\n        let create_event =\n            classify_event(\u0026Method::POST, \"/api/subject-requests\").expect(\"create maps\");\n        assert_eq!(create_event.event_type, \"subject_request_create\");\n        assert_eq!(create_event.target_type, Some(\"subject_request\"));\n        assert!(create_event.target_id.is_none());\n\n        let cancel_event =\n            classify_event(\u0026Method::DELETE, \"/api/subject-requests/req-1\").expect(\"cancel maps\");\n        assert_eq!(cancel_event.event_type, \"subject_request_cancel\");\n        assert_eq!(cancel_event.target_type, Some(\"subject_request\"));\n        assert_eq!(cancel_event.target_id.as_deref(), Some(\"req-1\"));\n\n        let admin_list =\n            classify_event(\u0026Method::GET, \"/api/admin/subject-requests\").expect(\"admin list maps\");\n        assert_eq!(admin_list.event_type, \"admin_subject_request_list\");\n        assert_eq!(admin_list.target_type, Some(\"subject_request\"));\n        assert!(admin_list.target_id.is_none());\n\n        let admin_approve =\n            classify_event(\u0026Method::PUT, \"/api/admin/subject-requests/req-2/approve\")\n                .expect(\"admin approve maps\");\n        assert_eq!(admin_approve.event_type, \"admin_subject_request_approve\");\n        assert_eq!(admin_approve.target_type, Some(\"subject_request\"));\n        assert_eq!(admin_approve.target_id.as_deref(), Some(\"req-2\"));\n    }\n\n    #[test]\n    fn classify_event_matches_session_list_paths() {\n        let user_event =\n            classify_event(\u0026Method::GET, \"/api/auth/sessions\").expect(\"auth list maps\");\n        assert_eq!(user_event.event_type, \"auth_session_list\");\n        assert_eq!(user_event.target_type, Some(\"session\"));\n        assert!(user_event.target_id.is_none());\n\n        let admin_event = classify_event(\u0026Method::GET, \"/api/admin/users/user-1/sessions\")\n            .expect(\"admin list maps\");\n        assert_eq!(admin_event.event_type, \"admin_user_session_list\");\n        assert_eq!(admin_event.target_type, Some(\"user\"));\n        assert_eq!(admin_event.target_id.as_deref(), Some(\"user-1\"));\n    }\n\n    #[test]\n    fn classify_event_matches_audit_log_paths() {\n        let list_event = classify_event(\u0026Method::GET, \"/api/admin/audit-logs\")\n            .expect(\"audit log list should map\");\n        assert_eq!(list_event.event_type, \"admin_audit_log_list\");\n        assert_eq!(list_event.target_type, Some(\"audit_log\"));\n        assert!(list_event.target_id.is_none());\n\n        let detail_event = classify_event(\u0026Method::GET, \"/api/admin/audit-logs/log-123\")\n            .expect(\"audit log detail should map\");\n        assert_eq!(detail_event.event_type, \"admin_audit_log_detail\");\n        assert_eq!(detail_event.target_type, Some(\"audit_log\"));\n        assert_eq!(detail_event.target_id.as_deref(), Some(\"log-123\"));\n\n        let export_event = classify_event(\u0026Method::GET, \"/api/admin/audit-logs/export\")\n            .expect(\"audit log export should map\");\n        assert_eq!(export_event.event_type, \"admin_audit_log_export\");\n        assert_eq!(export_event.target_type, Some(\"audit_log\"));\n        assert!(export_event.target_id.is_none());\n    }\n\n    #[test]\n    fn classify_event_skips_excluded_paths() {\n        let event = classify_event(\u0026Method::GET, \"/api/attendance/status\");\n        assert!(event.is_none());\n    }\n\n    #[test]\n    fn classify_event_returns_none_for_unknown_paths() {\n        let event = classify_event(\u0026Method::GET, \"/api/unknown\");\n        assert!(event.is_none());\n    }\n\n    #[test]\n    fn extract_ip_prefers_forwarded_for() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-forwarded-for\", \"203.0.113.1, 10.0.0.1\".parse().unwrap());\n        headers.insert(\"x-real-ip\", \"203.0.113.2\".parse().unwrap());\n        assert_eq!(extract_ip(\u0026headers).as_deref(), Some(\"203.0.113.1\"));\n    }\n\n    #[test]\n    fn extract_request_id_generates_when_missing() {\n        let headers = HeaderMap::new();\n        let value = extract_request_id(\u0026headers);\n        assert!(!value.is_empty());\n    }\n\n    #[test]\n    fn extract_request_id_uses_header_value() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\"x-request-id\", \"req-001\".parse().unwrap());\n        assert_eq!(extract_request_id(\u0026headers), \"req-001\");\n    }\n\n    #[test]\n    fn extract_user_agent_reads_header() {\n        let mut headers = HeaderMap::new();\n        headers.insert(USER_AGENT, \"test-agent\".parse().unwrap());\n        assert_eq!(extract_user_agent(\u0026headers).as_deref(), Some(\"test-agent\"));\n    }\n\n    #[tokio::test]\n    async fn buffer_request_body_preserves_large_body() {\n        let body = vec![b'a'; MAX_BUFFERED_BODY_BYTES + 1];\n        let request = Request::builder()\n            .method(Method::POST)\n            .uri(\"/api/requests/leave\")\n            .body(Body::from(body.clone()))\n            .unwrap();\n\n        let (buffered_request, body_bytes) = buffer_request_body(request).await;\n        let bytes = to_bytes(buffered_request.into_body(), body.len() + 1)\n            .await\n            .expect(\"body should remain readable\");\n\n        assert_eq!(bytes.as_ref(), body.as_slice());\n        assert!(body_bytes.is_none());\n    }\n\n    #[test]\n    fn result_error_code_uses_http_status() {\n        let status = StatusCode::BAD_REQUEST;\n        let result = if status.is_client_error() || status.is_server_error() {\n            \"failure\"\n        } else {\n            \"success\"\n        };\n        let error_code = if result == \"failure\" {\n            Some(format!(\"http_{}\", status.as_u16()))\n        } else {\n            None\n        };\n        assert_eq!(result, \"failure\");\n        assert_eq!(error_code.as_deref(), Some(\"http_400\"));\n    }\n}\n","traces":[{"line":35,"address":[18118608],"length":1,"stats":{"Line":0},"fn_name":"audit_log"},{"line":40,"address":[18210794,18210965],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[18210987,18211075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[18211155,18211289],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[18211318,18211419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[18210846,18212065,18211466,18212169],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[18211433,18211609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[18211635,18211812,18211716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[18211771,18211846,18211821,18213056],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[18211976,18210867,18212662,18211856],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[18212956],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[18212996],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[18211835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[18211801],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[18213158,18213227,18211931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[18213342,18213241],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[18213395,18213539],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[18218800,18218816,18213514],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":70,"address":[18213529,18221792,18213546,18221809],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":72,"address":[18213779,18213583,18210888,18213857],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[18214299,18214431,18214386],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[18214306],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[18214410],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[18214437],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[18214481,18214564],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[18214644],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[18214612,18214691],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[18214766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[18214736,18214969],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[18218929,18215046,18218912],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":95,"address":[18215191,18215084,18215139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[18215164],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[18215203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[18215331,18215299,18215583,18215230],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[18215341,18215380],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[18215305],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[18215353],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[18215645,18218832,18218840],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":113,"address":[18215747],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[18218886,18218864,18215826],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":115,"address":[18215898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[18215938],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[18216242],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[18216271],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[18216345],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[18216419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[18216876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[18219076,18219374,18221456,18218944,18221618,18218975,18216947],"length":1,"stats":{"Line":0},"fn_name":"{async_block#7}"},{"line":132,"address":[20999924],"length":1,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[18219722,18219806,18220201],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[18217171],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[18096544],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[18096496],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[18096518],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[18118736,18119365,18119359],"length":1,"stats":{"Line":1},"fn_name":"poll_frame"},{"line":180,"address":[18118787],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[18118808],"length":1,"stats":{"Line":1},"fn_name":null},{"line":182,"address":[18118866],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[18119019,18118948],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[18119176,18119051,18119206],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[18119261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[18119077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[18119472],"length":1,"stats":{"Line":0},"fn_name":"size_hint"},{"line":192,"address":[18119504],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[18119524],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[18119538],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[18119574],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[18119620],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[18119648],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[18119392],"length":1,"stats":{"Line":0},"fn_name":"is_end_stream"},{"line":202,"address":[18119425,18119405],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[18119414],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[18119442],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[18109921,18109904],"length":1,"stats":{"Line":4},"fn_name":"buffer_request_body"},{"line":210,"address":[18207345,18207471],"length":1,"stats":{"Line":2},"fn_name":null},{"line":211,"address":[18207552],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[18207629],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[18207714],"length":1,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[18207728],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[18207817,18208823,18207754,18207400,18208849,18207893],"length":1,"stats":{"Line":4},"fn_name":null},{"line":217,"address":[18208074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[18208197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[18208371,18208301],"length":1,"stats":{"Line":2},"fn_name":null},{"line":220,"address":[18208439],"length":1,"stats":{"Line":1},"fn_name":null},{"line":221,"address":[18208686,18208597],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[18208762,18208676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":223,"address":[18208755],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[18208782,18208719],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[18208460],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[18208806],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[18208138],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[18208180,18208946],"length":1,"stats":{"Line":0},"fn_name":null},{"line":241,"address":[18209046,18209076,18208112],"length":1,"stats":{"Line":2},"fn_name":null},{"line":242,"address":[18209064],"length":1,"stats":{"Line":1},"fn_name":null},{"line":244,"address":[18209099],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[18209235],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[18209522,18209922,18209389,18209909],"length":1,"stats":{"Line":1},"fn_name":null},{"line":248,"address":[18209612],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[18111872],"length":1,"stats":{"Line":0},"fn_name":"needs_body_for_metadata"},{"line":252,"address":[18111948],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[18096624,18097758,18097764],"length":1,"stats":{"Line":0},"fn_name":"build_metadata"},{"line":273,"address":[18096809,18096911],"length":1,"stats":{"Line":0},"fn_name":null},{"line":277,"address":[18097084],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[18097018],"length":1,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[18097976,18097028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[18097115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[18097187],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[18097831,18097197],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[18097146],"length":1,"stats":{"Line":0},"fn_name":null},{"line":292,"address":[18097262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[18097271,18097680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[18097358],"length":1,"stats":{"Line":0},"fn_name":null},{"line":296,"address":[18097422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[18097499,18097535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[18097525],"length":1,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[18114315,18112992,18114365],"length":1,"stats":{"Line":0},"fn_name":"build_attendance_metadata"},{"line":304,"address":[18113077],"length":1,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[18113101,18113155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[18113132,18113214],"length":1,"stats":{"Line":0},"fn_name":null},{"line":307,"address":[18113270,18113191],"length":1,"stats":{"Line":0},"fn_name":null},{"line":308,"address":[18113247,18113316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[18113293],"length":1,"stats":{"Line":0},"fn_name":null},{"line":311,"address":[18113347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[18114321,18113509,18113721,18113357,18114293,18113405,18113788,18114056],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[18113699],"length":1,"stats":{"Line":0},"fn_name":null},{"line":319,"address":[18111124,18111096,18110224],"length":1,"stats":{"Line":0},"fn_name":"build_request_metadata"},{"line":320,"address":[18110295],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[18110365,18110311],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[18110433,18110342],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[18110392],"length":1,"stats":{"Line":0},"fn_name":null},{"line":325,"address":[18110458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":326,"address":[18110531,18110635,18110840,18111074,18111102,18110483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":332,"address":[18114995,18114384,18115001],"length":1,"stats":{"Line":0},"fn_name":"build_request_payload_summary"},{"line":333,"address":[18114426],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[18114436],"length":1,"stats":{"Line":0},"fn_name":null},{"line":336,"address":[18114638,18114492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":337,"address":[18114682],"length":1,"stats":{"Line":0},"fn_name":null},{"line":338,"address":[18114937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":339,"address":[18114966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[18114713,18114654],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[18114753],"length":1,"stats":{"Line":0},"fn_name":null},{"line":343,"address":[18114903],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[18114724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":347,"address":[18114782],"length":1,"stats":{"Line":0},"fn_name":null},{"line":348,"address":[18114811],"length":1,"stats":{"Line":0},"fn_name":null},{"line":349,"address":[18114840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":350,"address":[18114869],"length":1,"stats":{"Line":0},"fn_name":null},{"line":354,"address":[18114525],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[18109968,18110203,18110209],"length":1,"stats":{"Line":0},"fn_name":"build_consent_metadata"},{"line":358,"address":[18109987],"length":1,"stats":{"Line":0},"fn_name":null},{"line":359,"address":[18109997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":360,"address":[18110039],"length":1,"stats":{"Line":0},"fn_name":null},{"line":361,"address":[18110174],"length":1,"stats":{"Line":0},"fn_name":null},{"line":363,"address":[18110073],"length":1,"stats":{"Line":0},"fn_name":null},{"line":366,"address":[18118516,18115808,18116619],"length":1,"stats":{"Line":0},"fn_name":"build_subject_request_metadata"},{"line":367,"address":[18115863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":369,"address":[18116025,18115932],"length":1,"stats":{"Line":0},"fn_name":null},{"line":370,"address":[18117644],"length":1,"stats":{"Line":0},"fn_name":null},{"line":371,"address":[18116081],"length":1,"stats":{"Line":0},"fn_name":null},{"line":372,"address":[18117574],"length":1,"stats":{"Line":0},"fn_name":null},{"line":374,"address":[18117825],"length":1,"stats":{"Line":0},"fn_name":null},{"line":375,"address":[18117676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":376,"address":[18117785,18117725],"length":1,"stats":{"Line":0},"fn_name":null},{"line":378,"address":[18117978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":379,"address":[18210265,18210256],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":380,"address":[18117924],"length":1,"stats":{"Line":0},"fn_name":null},{"line":381,"address":[18210352,18210366],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":382,"address":[18118134],"length":1,"stats":{"Line":0},"fn_name":null},{"line":383,"address":[18117994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":384,"address":[18118033,18118115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":386,"address":[18118208],"length":1,"stats":{"Line":0},"fn_name":null},{"line":387,"address":[18118373],"length":1,"stats":{"Line":0},"fn_name":null},{"line":388,"address":[18118246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":389,"address":[18118289,18118349],"length":1,"stats":{"Line":0},"fn_name":null},{"line":393,"address":[18116197,18116031,18116106],"length":1,"stats":{"Line":0},"fn_name":null},{"line":394,"address":[18116665,18116154,18116632],"length":1,"stats":{"Line":0},"fn_name":null},{"line":395,"address":[18116667],"length":1,"stats":{"Line":0},"fn_name":null},{"line":397,"address":[18116638],"length":1,"stats":{"Line":0},"fn_name":null},{"line":399,"address":[18116768,18116694,18117544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":400,"address":[18117026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":401,"address":[18116931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":402,"address":[18116954],"length":1,"stats":{"Line":0},"fn_name":null},{"line":403,"address":[18210208,18210222],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":404,"address":[18117182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":405,"address":[18117042],"length":1,"stats":{"Line":0},"fn_name":null},{"line":406,"address":[18117081,18117163],"length":1,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[18117256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":409,"address":[18117423],"length":1,"stats":{"Line":0},"fn_name":null},{"line":410,"address":[18117295],"length":1,"stats":{"Line":0},"fn_name":null},{"line":411,"address":[18117339,18117399],"length":1,"stats":{"Line":0},"fn_name":null},{"line":415,"address":[18116203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":416,"address":[18116369,18116439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":420,"address":[18116274],"length":1,"stats":{"Line":0},"fn_name":null},{"line":423,"address":[18112544,18112950,18112982],"length":1,"stats":{"Line":0},"fn_name":"insert_string_if_present"},{"line":424,"address":[18112637],"length":1,"stats":{"Line":0},"fn_name":null},{"line":425,"address":[18112807,18112963,18112742],"length":1,"stats":{"Line":0},"fn_name":null},{"line":429,"address":[18112525,18112496,18112160],"length":1,"stats":{"Line":0},"fn_name":"insert_number_if_present"},{"line":430,"address":[18112251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":431,"address":[18112316,18112509,18112366],"length":1,"stats":{"Line":0},"fn_name":null},{"line":435,"address":[18109536],"length":1,"stats":{"Line":0},"fn_name":"infer_request_type"},{"line":436,"address":[18109545],"length":1,"stats":{"Line":0},"fn_name":null},{"line":437,"address":[18109620],"length":1,"stats":{"Line":0},"fn_name":null},{"line":438,"address":[18109661],"length":1,"stats":{"Line":0},"fn_name":null},{"line":439,"address":[18109730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":441,"address":[18109699],"length":1,"stats":{"Line":0},"fn_name":null},{"line":443,"address":[18109771],"length":1,"stats":{"Line":0},"fn_name":null},{"line":444,"address":[18109850],"length":1,"stats":{"Line":0},"fn_name":null},{"line":446,"address":[18109873],"length":1,"stats":{"Line":0},"fn_name":null},{"line":449,"address":[18111819,18111152,18111847],"length":1,"stats":{"Line":0},"fn_name":"build_approval_metadata"},{"line":450,"address":[18111178,18111237],"length":1,"stats":{"Line":0},"fn_name":null},{"line":451,"address":[18111239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":453,"address":[18111216],"length":1,"stats":{"Line":0},"fn_name":null},{"line":455,"address":[18111379,18111265,18111578,18111825,18111797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":461,"address":[18115753,18115781,18115024],"length":1,"stats":{"Line":0},"fn_name":"build_password_change_metadata"},{"line":462,"address":[18115048],"length":1,"stats":{"Line":0},"fn_name":null},{"line":463,"address":[18115074],"length":1,"stats":{"Line":0},"fn_name":null},{"line":464,"address":[18115084],"length":1,"stats":{"Line":0},"fn_name":null},{"line":465,"address":[18115112,18115160,18115477,18115759,18115269,18115731],"length":1,"stats":{"Line":0},"fn_name":null},{"line":471,"address":[18109104],"length":1,"stats":{"Line":0},"fn_name":"parse_json_body"},{"line":472,"address":[18109136],"length":1,"stats":{"Line":0},"fn_name":null},{"line":473,"address":[18109201],"length":1,"stats":{"Line":0},"fn_name":null},{"line":474,"address":[18109256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":476,"address":[18109215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":479,"address":[18108960],"length":1,"stats":{"Line":0},"fn_name":"extract_source"},{"line":482,"address":[18109015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":483,"address":[18206729,18206720],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":484,"address":[18109034],"length":1,"stats":{"Line":0},"fn_name":null},{"line":485,"address":[18206608,18206620],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":486,"address":[18206768,18206790],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":487,"address":[18109068],"length":1,"stats":{"Line":0},"fn_name":null},{"line":490,"address":[18108938,18108944,18098064],"length":1,"stats":{"Line":1},"fn_name":"classify_event"},{"line":491,"address":[18098172],"length":1,"stats":{"Line":1},"fn_name":null},{"line":492,"address":[18098221],"length":1,"stats":{"Line":1},"fn_name":null},{"line":493,"address":[18098251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":495,"address":[18098290],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[18098448],"length":1,"stats":{"Line":1},"fn_name":null},{"line":499,"address":[18098337],"length":1,"stats":{"Line":1},"fn_name":null},{"line":501,"address":[18098416,18098531],"length":1,"stats":{"Line":2},"fn_name":null},{"line":502,"address":[18098640,18101907,18103787,18105188,18105133,18105511,18103690],"length":1,"stats":{"Line":1},"fn_name":null},{"line":503,"address":[18105306,18105251,18105480,18105139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":504,"address":[18105257,18105366],"length":1,"stats":{"Line":0},"fn_name":null},{"line":505,"address":[18098627,18098713,18101788,18100488,18100391],"length":1,"stats":{"Line":5},"fn_name":null},{"line":506,"address":[18101807],"length":1,"stats":{"Line":1},"fn_name":null},{"line":508,"address":[18102675,18101894,18101961,18102772,18103233],"length":1,"stats":{"Line":1},"fn_name":null},{"line":509,"address":[18103340,18103663],"length":1,"stats":{"Line":0},"fn_name":null},{"line":511,"address":[18103632,18103458,18103291,18103403],"length":1,"stats":{"Line":0},"fn_name":null},{"line":512,"address":[18103409,18103518],"length":1,"stats":{"Line":0},"fn_name":null},{"line":513,"address":[18103537],"length":1,"stats":{"Line":0},"fn_name":null},{"line":515,"address":[18108304,18108401,18108832,18098680,18107556],"length":1,"stats":{"Line":3},"fn_name":null},{"line":516,"address":[18107437,18098660,18105550,18106919,18107016],"length":1,"stats":{"Line":1},"fn_name":null},{"line":517,"address":[18107456],"length":1,"stats":{"Line":0},"fn_name":null},{"line":519,"address":[18103833,18103878,18103748,18104579],"length":1,"stats":{"Line":0},"fn_name":null},{"line":520,"address":[18104634,18105106],"length":1,"stats":{"Line":0},"fn_name":null},{"line":522,"address":[18104585,18104697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":523,"address":[18104752,18105075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":525,"address":[18104815,18104703],"length":1,"stats":{"Line":0},"fn_name":null},{"line":526,"address":[18104870,18105044],"length":1,"stats":{"Line":0},"fn_name":null},{"line":528,"address":[18104821,18104930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":529,"address":[18104949],"length":1,"stats":{"Line":0},"fn_name":null},{"line":531,"address":[18100534,18101678,18100579,18100449],"length":1,"stats":{"Line":2},"fn_name":null},{"line":532,"address":[18101697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":534,"address":[18103839,18103924,18103969,18104323],"length":1,"stats":{"Line":0},"fn_name":null},{"line":535,"address":[18104378,18104552],"length":1,"stats":{"Line":0},"fn_name":null},{"line":537,"address":[18104329,18104438],"length":1,"stats":{"Line":0},"fn_name":null},{"line":538,"address":[18104457],"length":1,"stats":{"Line":0},"fn_name":null},{"line":540,"address":[18106977,18107062,18107354,18107107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":543,"address":[18107322,18107130],"length":1,"stats":{"Line":0},"fn_name":null},{"line":545,"address":[18108491,18108749,18108447,18108362],"length":1,"stats":{"Line":2},"fn_name":null},{"line":548,"address":[18108514,18108717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":550,"address":[18101948,18102474,18102648,18102018,18102367],"length":1,"stats":{"Line":3},"fn_name":null},{"line":551,"address":[18102534,18102425],"length":1,"stats":{"Line":2},"fn_name":null},{"line":552,"address":[18102553],"length":1,"stats":{"Line":1},"fn_name":null},{"line":554,"address":[18108547,18108638,18108453],"length":1,"stats":{"Line":3},"fn_name":null},{"line":557,"address":[18108579],"length":1,"stats":{"Line":1},"fn_name":null},{"line":559,"address":[18100625,18100540],"length":1,"stats":{"Line":2},"fn_name":null},{"line":560,"address":[18100732,18101651],"length":1,"stats":{"Line":2},"fn_name":null},{"line":562,"address":[18105782,18105534,18106577,18106532,18106836,18105591],"length":1,"stats":{"Line":6},"fn_name":null},{"line":565,"address":[18106804,18106600],"length":1,"stats":{"Line":2},"fn_name":null},{"line":567,"address":[18106725,18106538,18106634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":570,"address":[18106666],"length":1,"stats":{"Line":0},"fn_name":null},{"line":572,"address":[18100683,18100795],"length":1,"stats":{"Line":2},"fn_name":null},{"line":573,"address":[18100850,18101620],"length":1,"stats":{"Line":0},"fn_name":null},{"line":575,"address":[18098770,18098700,18099556,18100308,18099407],"length":1,"stats":{"Line":3},"fn_name":null},{"line":578,"address":[18099579,18100276],"length":1,"stats":{"Line":0},"fn_name":null},{"line":580,"address":[18100801,18100913],"length":1,"stats":{"Line":2},"fn_name":null},{"line":581,"address":[18100968,18101589],"length":1,"stats":{"Line":2},"fn_name":null},{"line":583,"address":[18099613,18099517,18099658,18100012],"length":1,"stats":{"Line":4},"fn_name":null},{"line":584,"address":[18100078,18100253],"length":1,"stats":{"Line":2},"fn_name":null},{"line":586,"address":[18100166,18100018],"length":1,"stats":{"Line":2},"fn_name":null},{"line":589,"address":[18100041,18100134],"length":1,"stats":{"Line":2},"fn_name":null},{"line":591,"address":[18106449,18105828,18105873,18105743,18106145,18106190],"length":1,"stats":{"Line":6},"fn_name":null},{"line":594,"address":[18106417,18106213],"length":1,"stats":{"Line":2},"fn_name":null},{"line":596,"address":[18106247,18106338,18106151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":599,"address":[18106279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":601,"address":[18100919,18101031],"length":1,"stats":{"Line":0},"fn_name":null},{"line":602,"address":[18101558,18101086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":604,"address":[18103930,18104015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":605,"address":[18104122,18104296],"length":1,"stats":{"Line":0},"fn_name":null},{"line":607,"address":[18108026,18107543,18107613,18108221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":610,"address":[18108162],"length":1,"stats":{"Line":0},"fn_name":null},{"line":612,"address":[18099619,18099704],"length":1,"stats":{"Line":0},"fn_name":null},{"line":613,"address":[18099811,18099985],"length":1,"stats":{"Line":0},"fn_name":null},{"line":615,"address":[18102818,18102915,18102733,18103123],"length":1,"stats":{"Line":0},"fn_name":null},{"line":616,"address":[18103142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":618,"address":[18099871,18099762],"length":1,"stats":{"Line":0},"fn_name":null},{"line":619,"address":[18099890],"length":1,"stats":{"Line":0},"fn_name":null},{"line":621,"address":[18098754,18098811,18099327,18099054],"length":1,"stats":{"Line":2},"fn_name":null},{"line":624,"address":[18099077,18099295],"length":1,"stats":{"Line":0},"fn_name":null},{"line":626,"address":[18102002,18102059,18102284],"length":1,"stats":{"Line":0},"fn_name":null},{"line":629,"address":[18102276],"length":1,"stats":{"Line":0},"fn_name":null},{"line":631,"address":[18107654,18107597],"length":1,"stats":{"Line":0},"fn_name":null},{"line":632,"address":[18107943],"length":1,"stats":{"Line":0},"fn_name":null},{"line":635,"address":[18107884],"length":1,"stats":{"Line":0},"fn_name":null},{"line":638,"address":[18101527,18101204,18101037,18101149],"length":1,"stats":{"Line":0},"fn_name":null},{"line":639,"address":[18101155,18101267,18101322,18101496],"length":1,"stats":{"Line":0},"fn_name":null},{"line":640,"address":[18104073,18104182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":641,"address":[18104201],"length":1,"stats":{"Line":0},"fn_name":null},{"line":643,"address":[18099015,18099202,18099111],"length":1,"stats":{"Line":3},"fn_name":null},{"line":646,"address":[18099143],"length":1,"stats":{"Line":1},"fn_name":null},{"line":648,"address":[18101273,18101382],"length":1,"stats":{"Line":0},"fn_name":null},{"line":649,"address":[18101401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":651,"address":[18107068,18107164],"length":1,"stats":{"Line":0},"fn_name":null},{"line":652,"address":[18107235],"length":1,"stats":{"Line":0},"fn_name":null},{"line":654,"address":[18106062,18105834,18105919],"length":1,"stats":{"Line":0},"fn_name":null},{"line":657,"address":[18106003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":659,"address":[18102961,18102876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":660,"address":[18103032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":662,"address":[18098609],"length":1,"stats":{"Line":1},"fn_name":null},{"line":666,"address":[18118544],"length":1,"stats":{"Line":1},"fn_name":"event"},{"line":678,"address":[18096472,18094848,18096466],"length":1,"stats":{"Line":1},"fn_name":"is_excluded"},{"line":679,"address":[18094920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":680,"address":[18094996,18095073],"length":1,"stats":{"Line":2},"fn_name":null},{"line":681,"address":[18095114,18095641,18095180,18095738,18096375],"length":1,"stats":{"Line":3},"fn_name":null},{"line":682,"address":[18095699,18095784,18096338,18096293,18095829],"length":1,"stats":{"Line":4},"fn_name":null},{"line":683,"address":[18096299,18096352],"length":1,"stats":{"Line":2},"fn_name":null},{"line":684,"address":[18095167,18095234,18095569],"length":1,"stats":{"Line":3},"fn_name":null},{"line":685,"address":[18095875,18095790,18096211,18096256,18095920],"length":1,"stats":{"Line":2},"fn_name":null},{"line":686,"address":[18096217,18096270],"length":1,"stats":{"Line":0},"fn_name":null},{"line":687,"address":[18095966,18095881,18096129,18096174,18096011],"length":1,"stats":{"Line":5},"fn_name":null},{"line":688,"address":[18096188,18096135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":689,"address":[18095275,18095221,18095466],"length":1,"stats":{"Line":2},"fn_name":null},{"line":690,"address":[18095427,18095526],"length":1,"stats":{"Line":0},"fn_name":null},{"line":691,"address":[18095972,18096054],"length":1,"stats":{"Line":2},"fn_name":null},{"line":692,"address":[18096398,18095137],"length":1,"stats":{"Line":2},"fn_name":null},{"line":696,"address":[18109280],"length":1,"stats":{"Line":1},"fn_name":"extract_request_id"},{"line":699,"address":[18206981,18206976],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":700,"address":[18109343],"length":1,"stats":{"Line":3},"fn_name":null},{"line":701,"address":[18109351],"length":1,"stats":{"Line":3},"fn_name":null},{"line":702,"address":[18109366],"length":1,"stats":{"Line":3},"fn_name":null},{"line":705,"address":[18094752],"length":1,"stats":{"Line":1},"fn_name":"extract_ip"},{"line":708,"address":[18094810],"length":1,"stats":{"Line":1},"fn_name":null},{"line":709,"address":[18206441,18206432],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":710,"address":[18094831],"length":1,"stats":{"Line":3},"fn_name":null},{"line":713,"address":[18109408],"length":1,"stats":{"Line":1},"fn_name":"extract_user_agent"},{"line":714,"address":[18109440],"length":1,"stats":{"Line":1},"fn_name":null},{"line":715,"address":[18109488],"length":1,"stats":{"Line":1},"fn_name":null},{"line":716,"address":[18109502],"length":1,"stats":{"Line":3},"fn_name":null},{"line":717,"address":[18109515],"length":1,"stats":{"Line":3},"fn_name":null}],"covered":93,"coverable":358},{"path":["/","home","marra","projects","timekeeper","backend","src","middleware","auth.rs"],"content":"use axum::{\n    extract::{Request, State},\n    http::{header, StatusCode},\n    middleware::Next,\n    response::{IntoResponse, Response},\n};\nuse jsonwebtoken::{decode, DecodingKey, Validation};\nuse sqlx::PgPool;\nuse tracing::Span;\n\nuse crate::types::UserId;\nuse crate::{\n    models::user::User,\n    repositories::{active_session, auth as auth_repo},\n    state::AppState,\n    utils::{\n        cookies::{extract_cookie_value, ACCESS_COOKIE_NAME},\n        jwt::Claims,\n    },\n};\nuse chrono::Utc;\nuse std::str::FromStr;\n\npub async fn auth(\n    State(state): State\u003cAppState\u003e,\n    mut request: Request,\n    next: Next,\n) -\u003e Result\u003cResponse, StatusCode\u003e {\n    let (auth_header, cookie_header) = extract_auth_headers(request.headers());\n    let (claims, user) =\n        authenticate_request(auth_header.as_deref(), cookie_header.as_deref(), \u0026state).await?;\n    Span::current().record(\"user_id\", \u0026user.id.to_string());\n    Span::current().record(\"username\", \u0026user.username);\n    request.extensions_mut().insert(claims.clone());\n    request.extensions_mut().insert(user.clone());\n\n    let mut response = next.run(request).await;\n    response.extensions_mut().insert(user);\n    Ok(response)\n}\n\nfn verify_token(token: \u0026str, secret: \u0026str) -\u003e Result\u003cClaims, jsonwebtoken::errors::Error\u003e {\n    let validation = Validation::default();\n    let token_data = decode::\u003cClaims\u003e(\n        token,\n        \u0026DecodingKey::from_secret(secret.as_ref()),\n        \u0026validation,\n    )?;\n\n    Ok(token_data.claims)\n}\n\n// Auth + require admin role for admin-only routes\npub async fn auth_admin(\n    State(state): State\u003cAppState\u003e,\n    mut request: Request,\n    next: Next,\n) -\u003e Result\u003cResponse, StatusCode\u003e {\n    let (auth_header, cookie_header) = extract_auth_headers(request.headers());\n    let (claims, user) =\n        authenticate_request(auth_header.as_deref(), cookie_header.as_deref(), \u0026state).await?;\n    Span::current().record(\"user_id\", \u0026user.id.to_string());\n    Span::current().record(\"username\", \u0026user.username);\n    if !(user.is_admin() || user.is_system_admin()) {\n        let mut response = StatusCode::FORBIDDEN.into_response();\n        response.extensions_mut().insert(user);\n        return Ok(response);\n    }\n\n    request.extensions_mut().insert(claims.clone());\n    request.extensions_mut().insert(user.clone());\n    let mut response = next.run(request).await;\n    response.extensions_mut().insert(user);\n    Ok(response)\n}\n\n// Auth + require system admin flag for system-level routes\npub async fn auth_system_admin(\n    State(state): State\u003cAppState\u003e,\n    mut request: Request,\n    next: Next,\n) -\u003e Result\u003cResponse, StatusCode\u003e {\n    let (auth_header, cookie_header) = extract_auth_headers(request.headers());\n    let (claims, user) =\n        authenticate_request(auth_header.as_deref(), cookie_header.as_deref(), \u0026state).await?;\n    if !user.is_system_admin() {\n        let mut response = StatusCode::FORBIDDEN.into_response();\n        response.extensions_mut().insert(user);\n        return Ok(response);\n    }\n\n    request.extensions_mut().insert(claims.clone());\n    request.extensions_mut().insert(user.clone());\n    let mut response = next.run(request).await;\n    response.extensions_mut().insert(user);\n    Ok(response)\n}\n\nasync fn get_user_by_id(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003cOption\u003cUser\u003e, sqlx::Error\u003e {\n    let user = sqlx::query_as::\u003c_, User\u003e(\n        \"SELECT id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at FROM users WHERE id = $1\",\n    )\n    .bind(user_id)\n    .fetch_optional(pool)\n    .await?;\n\n    Ok(user)\n}\nfn parse_bearer_token(header: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n    if let Some(rest) = header.strip_prefix(\"Bearer \") {\n        return Some(rest);\n    }\n    if let Some(rest) = header.strip_prefix(\"bearer \") {\n        return Some(rest);\n    }\n    if let Some(space_idx) = header.find(' ') {\n        let (scheme, rest) = header.split_at(space_idx);\n        if scheme.eq_ignore_ascii_case(\"bearer\") {\n            return Some(rest.trim_start());\n        }\n    }\n    None\n}\n\nasync fn authenticate_request(\n    auth_header: Option\u003c\u0026str\u003e,\n    cookie_header: Option\u003c\u0026str\u003e,\n    state: \u0026AppState,\n) -\u003e Result\u003c(Claims, User), StatusCode\u003e {\n    let token = auth_header\n        .and_then(parse_bearer_token)\n        .map(|value| value.to_string())\n        .or_else(|| cookie_header.and_then(|raw| extract_cookie_value(raw, ACCESS_COOKIE_NAME)))\n        .ok_or(StatusCode::UNAUTHORIZED)?;\n\n    let claims =\n        verify_token(\u0026token, \u0026state.config.jwt_secret).map_err(|_| StatusCode::UNAUTHORIZED)?;\n\n    // Cache-aside pattern for token validation\n    let is_active = if state.config.feature_redis_cache_enabled {\n        if let Some(cache) = \u0026state.token_cache {\n            match cache.is_token_active(\u0026claims.jti).await {\n                Ok(Some(active)) =\u003e active,\n                _ =\u003e {\n                    // Fallback to DB\n                    let active = auth_repo::access_token_exists(\u0026state.write_pool, \u0026claims.jti)\n                        .await\n                        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n\n                    // Try to backfill cache if token is active\n                    if active {\n                        if let Ok(user_id) = UserId::from_str(\u0026claims.sub) {\n                            let _ = cache\n                                .cache_token(\n                                    \u0026claims.jti,\n                                    user_id,\n                                    (claims.exp - Utc::now().timestamp()).max(0) as u64,\n                                )\n                                .await;\n                        } else {\n                            tracing::warn!(\n                                jti = %claims.jti,\n                                sub = %claims.sub,\n                                \"Skipping cache backfill for invalid user id\"\n                            );\n                        }\n                    }\n                    active\n                }\n            }\n        } else {\n            auth_repo::access_token_exists(\u0026state.write_pool, \u0026claims.jti)\n                .await\n                .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?\n        }\n    } else {\n        auth_repo::access_token_exists(\u0026state.write_pool, \u0026claims.jti)\n            .await\n            .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?\n    };\n\n    if !is_active {\n        return Err(StatusCode::UNAUTHORIZED);\n    }\n\n    if let Err(err) = active_session::touch_active_session_by_access_jti(\n        \u0026state.write_pool,\n        \u0026claims.jti,\n        Utc::now(),\n    )\n    .await\n    {\n        tracing::warn!(error = ?err, jti = %claims.jti, \"Failed to update active session\");\n    }\n\n    let user = get_user_by_id(\u0026state.write_pool, \u0026claims.sub)\n        .await\n        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?\n        .ok_or(StatusCode::UNAUTHORIZED)?;\n\n    Ok((claims, user))\n}\n\nfn extract_auth_headers(headers: \u0026axum::http::HeaderMap) -\u003e (Option\u003cString\u003e, Option\u003cString\u003e) {\n    let auth_header = headers\n        .get(header::AUTHORIZATION)\n        .and_then(|value| value.to_str().ok())\n        .map(|value| value.to_owned());\n    let cookie_header = headers\n        .get(header::COOKIE)\n        .and_then(|value| value.to_str().ok())\n        .map(|value| value.to_owned());\n    (auth_header, cookie_header)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::http::HeaderMap;\n\n    #[test]\n    fn test_parse_bearer_token_with_bearer_prefix() {\n        let header = \"Bearer test_token_123\";\n        let result = parse_bearer_token(header);\n        assert_eq!(result, Some(\"test_token_123\"));\n    }\n\n    #[test]\n    fn test_parse_bearer_token_lowercase_bearer() {\n        let header = \"bearer test_token_123\";\n        let result = parse_bearer_token(header);\n        assert_eq!(result, Some(\"test_token_123\"));\n    }\n\n    #[test]\n    fn test_parse_bearer_token_with_multiple_spaces() {\n        let header = \"Bearer   test_token_123\";\n        let result = parse_bearer_token(header);\n        assert_eq!(result, Some(\"  test_token_123\"));\n    }\n\n    #[test]\n    fn test_parse_bearer_token_returns_none_for_invalid_prefix() {\n        let header = \"Basic test_token_123\";\n        let result = parse_bearer_token(header);\n        assert_eq!(result, None);\n    }\n\n    #[test]\n    fn test_parse_bearer_token_returns_none_for_missing_token() {\n        let header = \"Bearer \";\n        let result = parse_bearer_token(header);\n        assert_eq!(result, Some(\"\"));\n    }\n\n    #[test]\n    fn test_parse_bearer_token_returns_none_for_empty_string() {\n        let header = \"\";\n        let result = parse_bearer_token(header);\n        assert_eq!(result, None);\n    }\n\n    #[test]\n    fn test_extract_auth_headers_with_authorization() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            header::AUTHORIZATION,\n            \"Bearer test_token\".parse().unwrap(),\n        );\n        let (auth, cookie) = extract_auth_headers(\u0026headers);\n        assert_eq!(auth, Some(\"Bearer test_token\".to_string()));\n        assert_eq!(cookie, None);\n    }\n\n    #[test]\n    fn test_extract_auth_headers_with_cookie() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            header::COOKIE,\n            \"access_token=cookie_token\".parse().unwrap(),\n        );\n        let (auth, cookie) = extract_auth_headers(\u0026headers);\n        assert_eq!(auth, None);\n        assert_eq!(cookie, Some(\"access_token=cookie_token\".to_string()));\n    }\n\n    #[test]\n    fn test_extract_auth_headers_with_both() {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            header::AUTHORIZATION,\n            \"Bearer test_token\".parse().unwrap(),\n        );\n        headers.insert(\n            header::COOKIE,\n            \"access_token=cookie_token\".parse().unwrap(),\n        );\n        let (auth, cookie) = extract_auth_headers(\u0026headers);\n        assert_eq!(auth, Some(\"Bearer test_token\".to_string()));\n        assert_eq!(cookie, Some(\"access_token=cookie_token\".to_string()));\n    }\n\n    #[test]\n    fn test_extract_auth_headers_empty() {\n        let headers = HeaderMap::new();\n        let (auth, cookie) = extract_auth_headers(\u0026headers);\n        assert_eq!(auth, None);\n        assert_eq!(cookie, None);\n    }\n\n    #[test]\n    fn test_verify_token_with_valid_token() {\n        use crate::utils::jwt::{create_access_token, verify_access_token};\n        use crate::types::UserId;\n        use crate::models::user::UserRole;\n\n        let user_id = UserId::new();\n        let username = \"testuser\".to_string();\n        let role = format!(\"{:?}\", UserRole::Employee);\n        let secret = \"test_secret_key_for_jwt_tokens\";\n        let (token_string, _claims) = create_access_token(user_id.to_string(), username, role, \u0026secret, 1).unwrap();\n\n        let result = verify_access_token(\u0026token_string, secret);\n        assert!(result.is_ok());\n        \n        let claims = result.unwrap();\n        assert_eq!(claims.sub, user_id.to_string());\n    }\n\n    #[test]\n    fn test_verify_token_with_invalid_secret() {\n        use crate::utils::jwt::{create_access_token, verify_access_token};\n        use crate::types::UserId;\n        use crate::models::user::UserRole;\n\n        let user_id = UserId::new();\n        let username = \"testuser\".to_string();\n        let role = format!(\"{:?}\", UserRole::Employee);\n        let secret = \"correct_secret\";\n        let wrong_secret = \"wrong_secret\";\n        let (token_string, _claims) = create_access_token(user_id.to_string(), username, role, \u0026secret, 1).unwrap();\n\n        let result = verify_access_token(\u0026token_string, wrong_secret);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_verify_token_with_malformed_token() {\n        let secret = \"test_secret\";\n        let result = verify_token(\"not.a.valid.token\", secret);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_verify_token_with_empty_token() {\n        let secret = \"test_secret\";\n        let result = verify_token(\"\", secret);\n        assert!(result.is_err());\n    }\n}\n","traces":[{"line":24,"address":[20468384],"length":1,"stats":{"Line":0},"fn_name":"auth"},{"line":29,"address":[21888844,21888701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[21889615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[21889824,21889749],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[21890001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[21890133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[21890233],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[21890333,21890940,21888767],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[21891439,21891363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[21891526],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[20467241,20466512,20467279],"length":1,"stats":{"Line":1},"fn_name":"verify_token"},{"line":43,"address":[20466581],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[20466673,20466605],"length":1,"stats":{"Line":2},"fn_name":null},{"line":50,"address":[20467003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[20466384],"length":1,"stats":{"Line":0},"fn_name":"auth_admin"},{"line":59,"address":[21868605,21868748],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[21869543],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[21869677,21869752],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[21869929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[21870061,21870149],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[21870155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[21870179,21870255],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[21870344],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[21870123,21870664],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[21870737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[21871417,21870837,21868671],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[21871916,21871840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[21872005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[20467344],"length":1,"stats":{"Line":0},"fn_name":"auth_system_admin"},{"line":83,"address":[21873884,21873741],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21874087,21874300,21873786,21873969,21875802],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[21874829,21874892],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[21874898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[21874952,21875028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[21875117],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[21875437,21874930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[21875510],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[21876190,21873807,21875610],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[21876613,21876689],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[21876778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[20467314,20467296],"length":1,"stats":{"Line":0},"fn_name":"get_user_by_id"},{"line":104,"address":[21872766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[21872794],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[20971239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[21873314],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[20467472],"length":1,"stats":{"Line":1},"fn_name":"parse_bearer_token"},{"line":111,"address":[20467505],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[20467587],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[20467609,20467685],"length":1,"stats":{"Line":2},"fn_name":null},{"line":115,"address":[20467711],"length":1,"stats":{"Line":1},"fn_name":null},{"line":117,"address":[20467733],"length":1,"stats":{"Line":1},"fn_name":null},{"line":118,"address":[20467788],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[20467859],"length":1,"stats":{"Line":1},"fn_name":null},{"line":120,"address":[20467903],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[20467880],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[20467936],"length":1,"stats":{"Line":0},"fn_name":"authenticate_request"},{"line":131,"address":[21879148,21877800,21877862],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[21877445],"length":1,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[21887248,21887270,21877714],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":134,"address":[21888134,21888112,21887220,21887200,21877729],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":135,"address":[21877851,21877777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[21887664,21877958,21878069,21887673,21879123],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":141,"address":[21883841,21878337],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[21878414,21878663,21883341],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[20977524],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[21879571],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[21880238,21879478,21879740,21879976,21879702,21880038,21880115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[20977546],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[21888096,21880227,21880094,21888097],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":152,"address":[21880299],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[21880468,21880344],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[21882779,21880484,21880814,21880925],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[21880554],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[21880624],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[21882803,21877543,21880878,21880947,21882595],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[21880429,21880979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[21880316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[21883346,21883029,21879065,21879027,21878708,21883091,21883168,21883291],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[21883077,21882862,21877564,21879050,21879098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[21883147,21887713,21887712,21883280],"length":1,"stats":{"Line":0},"fn_name":"{closure#4}"},{"line":178,"address":[21883788,21883526,21878589,21878551,21883588,21884119,21883665,21878358],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[21878574,21883574,21877585,21883359,21878622],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[21883644,21887696,21887697,21883777],"length":1,"stats":{"Line":0},"fn_name":"{closure#5}"},{"line":183,"address":[21882835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[21883846],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[21883887],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[21883905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[21883967],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[20977634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[21884976,21884446,21884581],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[21886201,21886743,21886163,21886445,21886502,21886602,21886540,21884482,21887170,21886805],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[20977656],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[21887184,21887185,21886517,21886591],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":200,"address":[20977930,20977907],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[21886898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[20468366,20468000,20468360],"length":1,"stats":{"Line":1},"fn_name":"extract_auth_headers"},{"line":206,"address":[20468038],"length":1,"stats":{"Line":1},"fn_name":null},{"line":207,"address":[20468068],"length":1,"stats":{"Line":1},"fn_name":null},{"line":208,"address":[20468093],"length":1,"stats":{"Line":3},"fn_name":null},{"line":209,"address":[20468106],"length":1,"stats":{"Line":3},"fn_name":null},{"line":210,"address":[20468121],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[20468159],"length":1,"stats":{"Line":1},"fn_name":null},{"line":212,"address":[20468214],"length":1,"stats":{"Line":3},"fn_name":null},{"line":213,"address":[20468246],"length":1,"stats":{"Line":3},"fn_name":null},{"line":214,"address":[20468263],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":22,"coverable":105},{"path":["/","home","marra","projects","timekeeper","backend","src","middleware","logging.rs"],"content":"use axum::{\n    body::{to_bytes, Body, Bytes},\n    http::{header::CONTENT_LENGTH, Request},\n    middleware::Next,\n    response::Response,\n    Error as AxumError,\n};\nuse std::time::Instant;\n\nconst MAX_BUFFERED_BODY_BYTES: usize = 64 * 1024;\nconst MAX_LOGGED_BODY_BYTES: usize = 2048;\n\n/// Middleware that records detailed diagnostics whenever a handler returns an\n/// HTTP status in the 4xx or 5xx range. The response body is buffered so the\n/// same payload can still be forwarded to the caller after logging.\npub async fn log_error_responses(req: Request\u003cBody\u003e, next: Next) -\u003e Response {\n    let method = req.method().to_string();\n    let uri = req.uri().to_string();\n    let version = format!(\"{:?}\", req.version());\n    let start = Instant::now();\n\n    let response = next.run(req).await;\n    let status = response.status();\n\n    if !(status.is_client_error() || status.is_server_error()) {\n        return response;\n    }\n\n    let latency = start.elapsed();\n    let (mut parts, body) = response.into_parts();\n    match buffer_body(body).await {\n        Ok((bytes, truncated_preview)) =\u003e {\n            log_error_event(\n                status.as_u16(),\n                \u0026method,\n                \u0026uri,\n                \u0026version,\n                latency.as_millis() as u64,\n                \u0026truncated_preview,\n                None,\n            );\n\n            Response::from_parts(parts, Body::from(bytes))\n        }\n        Err(err) =\u003e {\n            parts.headers.remove(CONTENT_LENGTH);\n            log_error_event(\n                status.as_u16(),\n                \u0026method,\n                \u0026uri,\n                \u0026version,\n                latency.as_millis() as u64,\n                \"\",\n                Some(err),\n            );\n            Response::from_parts(parts, Body::empty())\n        }\n    }\n}\n\nasync fn buffer_body(body: Body) -\u003e Result\u003c(Bytes, String), AxumError\u003e {\n    let bytes = to_bytes(body, MAX_BUFFERED_BODY_BYTES).await?;\n    let preview = if bytes.len() \u003e MAX_LOGGED_BODY_BYTES {\n        let slice = bytes.slice(0..MAX_LOGGED_BODY_BYTES);\n        format!(\n            \"{}... (truncated, {} bytes total)\",\n            String::from_utf8_lossy(\u0026slice),\n            bytes.len()\n        )\n    } else {\n        String::from_utf8_lossy(\u0026bytes).to_string()\n    };\n    Ok((bytes, preview))\n}\n\nfn log_error_event(\n    status: u16,\n    method: \u0026str,\n    uri: \u0026str,\n    version: \u0026str,\n    latency_ms: u64,\n    body_preview: \u0026str,\n    body_error: Option\u003cAxumError\u003e,\n) {\n    if let Some(err) = body_error {\n        if status \u003e= 500 {\n            tracing::error!(\n                status,\n                method,\n                uri,\n                version,\n                latency_ms,\n                error = ?err,\n                \"Failed to read error response body\"\n            );\n        } else {\n            tracing::warn!(\n                status,\n                method,\n                uri,\n                version,\n                latency_ms,\n                error = ?err,\n                \"Failed to read error response body\"\n            );\n        }\n        return;\n    }\n\n    if status \u003e= 500 {\n        tracing::error!(\n            status,\n            method,\n            uri,\n            version,\n            latency_ms,\n            body = body_preview,\n            \"Request completed with error status\"\n        );\n    } else {\n        tracing::warn!(\n            status,\n            method,\n            uri,\n            version,\n            latency_ms,\n            body = body_preview,\n            \"Request completed with error status\"\n        );\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[tokio::test]\n    async fn buffer_body_returns_bytes_and_preview() {\n        let body = Body::from(\"test body\");\n        let (bytes, preview) = buffer_body(body).await.unwrap();\n        assert_eq!(bytes, b\"test body\"[..]);\n        assert_eq!(preview, \"test body\");\n    }\n\n    #[tokio::test]\n    async fn buffer_body_truncates_large_body() {\n        let large_body = \"x\".repeat(10000);\n        let body = Body::from(large_body.clone());\n        let (bytes, preview) = buffer_body(body).await.unwrap();\n        assert_eq!(bytes.len(), 10000);\n        assert!(preview.starts_with(\"x\"));\n        assert!(preview.contains(\"... (truncated\"));\n        assert!(preview.contains(\"10000 bytes total\"));\n    }\n\n    #[tokio::test]\n    async fn buffer_body_handles_empty_body() {\n        let body = Body::empty();\n        let (bytes, preview) = buffer_body(body).await.unwrap();\n        assert_eq!(bytes.len(), 0);\n        assert_eq!(preview, \"\");\n    }\n\n    #[tokio::test]\n    async fn buffer_body_handles_invalid_utf8() {\n        let invalid_bytes = vec![0xFF, 0xFE, 0xFD];\n        let body = Body::from(invalid_bytes);\n        let (bytes, preview) = buffer_body(body).await.unwrap();\n        assert_eq!(bytes.len(), 3);\n        assert!(preview.contains(\"\\u{FFFD}\"));\n    }\n\n    #[tokio::test]\n    async fn buffer_body_exceeds_max_size() {\n        let huge_body = vec![0u8; 100000];\n        let body = Body::from(huge_body);\n        let result = buffer_body(body).await;\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn buffer_body_constants_are_defined() {\n        assert_eq!(MAX_BUFFERED_BODY_BYTES, 64 * 1024);\n        assert_eq!(MAX_LOGGED_BODY_BYTES, 2048);\n    }\n\n    #[test]\n    fn log_error_responses_constants_are_defined() {\n        assert_eq!(MAX_BUFFERED_BODY_BYTES, 64 * 1024);\n        assert_eq!(MAX_LOGGED_BODY_BYTES, 2048);\n    }\n}\n","traces":[{"line":16,"address":[20503584,20503621],"length":1,"stats":{"Line":0},"fn_name":"log_error_responses"},{"line":17,"address":[22381924,22382071],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[22382093,22382182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[22382287,22382208],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[22382582,22382460],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[22381973,22382588,22382765,22382869],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[22383414,22383306],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[22383417,22383548],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[22383562],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[22383881,22383488],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[22383887],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[22384198,22384269,22381994,22384774,22384481],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[22384934],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[22385006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[22385080],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[22385150],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[22385220],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[22385290],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[22385336],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[22385883,22385483,22385678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22384819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[22384859,22386011],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[22386038],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[22386068],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[22386135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[22386199],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[22386251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[22386316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[22386855,22386533,22386392],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[20497293,20497280],"length":1,"stats":{"Line":4},"fn_name":"buffer_body"},{"line":62,"address":[20971361],"length":1,"stats":{"Line":3},"fn_name":null},{"line":63,"address":[22379237,22379295],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[22379325],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[22379850,22379912],"length":1,"stats":{"Line":1},"fn_name":null},{"line":67,"address":[22379743,22379814],"length":1,"stats":{"Line":2},"fn_name":null},{"line":68,"address":[22379896,22379838],"length":1,"stats":{"Line":2},"fn_name":null},{"line":71,"address":[22379308,22379371],"length":1,"stats":{"Line":2},"fn_name":null},{"line":73,"address":[22379480],"length":1,"stats":{"Line":1},"fn_name":null},{"line":76,"address":[20497312,20501064,20501070],"length":1,"stats":{"Line":0},"fn_name":"log_error_event"},{"line":85,"address":[20497469],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[20497532],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[20497595,20499387],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[20498046,20497677,20497567],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[20497546],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[20502357,20501108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[20501140,20501083],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":9,"coverable":46},{"path":["/","home","marra","projects","timekeeper","backend","src","middleware","mod.rs"],"content":"pub mod audit_log;\npub mod auth;\npub mod logging;\n\npub mod rate_limit;\npub mod request_id;\n\npub use audit_log::*;\npub use auth::*;\npub use logging::*;\npub use request_id::*;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","middleware","rate_limit.rs"],"content":"use axum::body::Body;\nuse axum::http::{header::CONTENT_TYPE, HeaderValue, Response, StatusCode};\nuse governor::middleware::StateInformationMiddleware;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tower_governor::{\n    governor::GovernorConfigBuilder, key_extractor::PeerIpKeyExtractor, GovernorError,\n    GovernorLayer,\n};\n\nuse crate::config::Config;\n\npub fn create_auth_rate_limiter(\n    config: \u0026Config,\n) -\u003e GovernorLayer\u003cPeerIpKeyExtractor, StateInformationMiddleware, Body\u003e {\n    let burst_size = config.rate_limit_ip_max_requests.max(1);\n    let window_seconds = config.rate_limit_ip_window_seconds.max(1);\n    let governor_conf = Arc::new(\n        GovernorConfigBuilder::default()\n            .period(Duration::from_secs(window_seconds))\n            .burst_size(burst_size)\n            .key_extractor(PeerIpKeyExtractor)\n            .use_headers()\n            .finish()\n            .expect(\"rate limiter config should be valid\"),\n    );\n\n    GovernorLayer::new(governor_conf).error_handler(rate_limit_error_handler)\n}\n\nfn rate_limit_error_handler(error: GovernorError) -\u003e Response\u003cBody\u003e {\n    match error {\n        GovernorError::TooManyRequests { wait_time, headers } =\u003e {\n            tracing::warn!(wait_time, \"Rate limit exceeded\");\n            let body = serde_json::json!({\n                \"error\": \"rate_limit_exceeded\",\n                \"message\": \"Too many requests. Please try again later.\",\n                \"retry_after\": wait_time,\n            })\n            .to_string();\n            let mut response = Response::new(Body::from(body));\n            *response.status_mut() = StatusCode::TOO_MANY_REQUESTS;\n            if let Some(headers) = headers {\n                response.headers_mut().extend(headers);\n            }\n            response\n                .headers_mut()\n                .insert(CONTENT_TYPE, HeaderValue::from_static(\"application/json\"));\n            response\n        }\n        GovernorError::UnableToExtractKey =\u003e {\n            let body = serde_json::json!({\n                \"error\": \"rate_limit_key_error\",\n                \"message\": \"Unable to determine request identity.\",\n            })\n            .to_string();\n            let mut response = Response::new(Body::from(body));\n            *response.status_mut() = StatusCode::INTERNAL_SERVER_ERROR;\n            response\n                .headers_mut()\n                .insert(CONTENT_TYPE, HeaderValue::from_static(\"application/json\"));\n            response\n        }\n        GovernorError::Other { code, msg, headers } =\u003e {\n            let body = serde_json::json!({\n                \"error\": \"rate_limit_error\",\n                \"message\": msg.unwrap_or_else(|| \"Rate limit error\".to_string()),\n            })\n            .to_string();\n            let mut response = Response::new(Body::from(body));\n            *response.status_mut() = code;\n            if let Some(headers) = headers {\n                response.headers_mut().extend(headers);\n            }\n            response\n                .headers_mut()\n                .insert(CONTENT_TYPE, HeaderValue::from_static(\"application/json\"));\n            response\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn create_auth_rate_limiter_uses_config_values() {\n        let database_url = \"postgres://localhost/test\".to_string();\n        let jwt_secret = \"test-secret-key\".to_string();\n        let config = crate::config::Config {\n            database_url,\n            read_database_url: None,\n            jwt_secret,\n            jwt_expiration_hours: 1,\n            refresh_token_expiration_days: 7,\n            max_concurrent_sessions: 3,\n            audit_log_retention_days: 1825,\n            audit_log_retention_forever: false,\n            consent_log_retention_days: 1825,\n            consent_log_retention_forever: false,\n            aws_region: \"us-east-1\".into(),\n            aws_kms_key_id: \"key-id\".into(),\n            aws_audit_log_bucket: \"bucket\".into(),\n            aws_cloudtrail_enabled: false,\n            cookie_secure: true,\n            cookie_same_site: crate::utils::cookies::SameSite::Lax,\n            cors_allow_origins: vec![\"http://localhost:8000\".into()],\n            time_zone: chrono_tz::UTC,\n            mfa_issuer: \"Timekeeper\".into(),\n            rate_limit_ip_max_requests: 10,\n            rate_limit_ip_window_seconds: 60,\n            rate_limit_user_max_requests: 20,\n            rate_limit_user_window_seconds: 3600,\n            redis_url: None,\n            redis_pool_size: 5,\n            redis_connect_timeout: 5,\n            feature_redis_cache_enabled: true,\n            feature_read_replica_enabled: true,\n            password_min_length: 12,\n            password_require_uppercase: true,\n            password_require_lowercase: true,\n            password_require_numbers: true,\n            password_require_symbols: true,\n            password_expiration_days: 30,\n            password_history_count: 5,\n            production_mode: false,\n        };\n\n        let _limiter = create_auth_rate_limiter(\u0026config);\n    }\n\n    #[test]\n    fn create_auth_rate_limiter_handles_zero_values() {\n        let database_url = \"postgres://localhost/test\".to_string();\n        let jwt_secret = \"test-secret-key\".to_string();\n        let config = crate::config::Config {\n            database_url,\n            read_database_url: None,\n            jwt_secret,\n            jwt_expiration_hours: 1,\n            refresh_token_expiration_days: 7,\n            max_concurrent_sessions: 3,\n            audit_log_retention_days: 1825,\n            audit_log_retention_forever: false,\n            consent_log_retention_days: 1825,\n            consent_log_retention_forever: false,\n            aws_region: \"us-east-1\".into(),\n            aws_kms_key_id: \"key-id\".into(),\n            aws_audit_log_bucket: \"bucket\".into(),\n            aws_cloudtrail_enabled: false,\n            cookie_secure: true,\n            cookie_same_site: crate::utils::cookies::SameSite::Lax,\n            cors_allow_origins: vec![\"http://localhost:8000\".into()],\n            time_zone: chrono_tz::UTC,\n            mfa_issuer: \"Timekeeper\".into(),\n            rate_limit_ip_max_requests: 0,\n            rate_limit_ip_window_seconds: 0,\n            rate_limit_user_max_requests: 20,\n            rate_limit_user_window_seconds: 3600,\n            redis_url: None,\n            redis_pool_size: 5,\n            redis_connect_timeout: 5,\n            feature_redis_cache_enabled: true,\n            feature_read_replica_enabled: true,\n            password_min_length: 12,\n            password_require_uppercase: true,\n            password_require_lowercase: true,\n            password_require_numbers: true,\n            password_require_symbols: true,\n            password_expiration_days: 30,\n            password_history_count: 5,\n            production_mode: false,\n        };\n\n        let _limiter = create_auth_rate_limiter(\u0026config);\n    }\n\n    #[test]\n    fn rate_limit_error_handler_too_many_requests() {\n        use std::time::Duration;\n\n        let error = GovernorError::TooManyRequests {\n            wait_time: Duration::from_secs(5).as_secs(),\n            headers: None,\n        };\n\n        let response = rate_limit_error_handler(error);\n        assert_eq!(response.status(), StatusCode::TOO_MANY_REQUESTS);\n        assert!(response.headers().get(CONTENT_TYPE).is_some());\n    }\n\n    #[test]\n    fn rate_limit_error_handler_unable_to_extract_key() {\n        let error = GovernorError::UnableToExtractKey;\n\n        let response = rate_limit_error_handler(error);\n        assert_eq!(response.status(), StatusCode::INTERNAL_SERVER_ERROR);\n        assert!(response.headers().get(CONTENT_TYPE).is_some());\n    }\n\n    #[test]\n    fn rate_limit_error_handler_other_error() {\n        let error = GovernorError::Other {\n            code: StatusCode::BAD_REQUEST,\n            msg: Some(\"custom error\".to_string()),\n            headers: None,\n        };\n\n        let response = rate_limit_error_handler(error);\n        assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n        assert!(response.headers().get(CONTENT_TYPE).is_some());\n    }\n\n    #[test]\n    fn rate_limit_error_handler_other_error_with_headers() {\n        let mut headers = axum::http::HeaderMap::new();\n        headers.insert(\"x-custom\", \"value\".parse().unwrap());\n\n        let error = GovernorError::Other {\n            code: StatusCode::BAD_REQUEST,\n            msg: Some(\"error with headers\".to_string()),\n            headers: Some(headers),\n        };\n\n        let response = rate_limit_error_handler(error);\n        assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n        assert!(response.headers().get(\"x-custom\").is_some());\n    }\n}\n","traces":[{"line":13,"address":[18738368,18739069,18739075],"length":1,"stats":{"Line":1},"fn_name":"create_auth_rate_limiter"},{"line":16,"address":[18738398],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[18738444],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[18738478],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[18738500,18738577],"length":1,"stats":{"Line":2},"fn_name":null},{"line":21,"address":[18738598],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[18738623],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[18738646],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[18738713],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[18738757],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[18739000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[18739104,18742549,18742914],"length":1,"stats":{"Line":1},"fn_name":"rate_limit_error_handler"},{"line":32,"address":[18739135],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[18739352],"length":1,"stats":{"Line":1},"fn_name":null},{"line":34,"address":[18739750,18739444,18740118],"length":1,"stats":{"Line":3},"fn_name":null},{"line":35,"address":[18741086,18742838,18740108],"length":1,"stats":{"Line":2},"fn_name":null},{"line":41,"address":[18741974],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[18742072,18742145],"length":1,"stats":{"Line":2},"fn_name":null},{"line":43,"address":[18742150,18742522],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[18742391,18742294],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[18742666],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[18742555,18742674,18742794],"length":1,"stats":{"Line":2},"fn_name":null},{"line":49,"address":[18742744],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[18739483,18744043,18742946],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[18743579],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[18743677,18743750],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[18743890],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[18743999,18743779,18743898],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[18743968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[18739537],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[18744511,18744144,18745851,18739676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":67,"address":[18744441],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[18744990],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[18745169,18745088],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[18745544,18745172],"length":1,"stats":{"Line":2},"fn_name":null},{"line":73,"address":[18745316,18745413],"length":1,"stats":{"Line":2},"fn_name":null},{"line":75,"address":[18745682],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[18745690,18745571,18745807],"length":1,"stats":{"Line":2},"fn_name":null},{"line":78,"address":[18745760],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":38,"coverable":39},{"path":["/","home","marra","projects","timekeeper","backend","src","middleware","request_id.rs"],"content":"use axum::{\n    extract::Request,\n    http::{header::HeaderName, HeaderValue},\n    middleware::Next,\n    response::Response,\n};\nuse uuid::Uuid;\n\nconst REQUEST_ID_HEADER: \u0026str = \"x-request-id\";\nconst CORRELATION_ID_HEADER: \u0026str = \"x-correlation-id\";\n\n#[derive(Clone, Debug)]\npub struct RequestId(pub String);\n\npub async fn request_id(mut req: Request, next: Next) -\u003e Response {\n    let header_name = HeaderName::from_static(REQUEST_ID_HEADER);\n\n    let id = req\n        .headers()\n        .get(\u0026header_name)\n        .or_else(|| {\n            req.headers()\n                .get(HeaderName::from_static(CORRELATION_ID_HEADER))\n        })\n        .and_then(|v| v.to_str().ok())\n        .map(|v| v.to_string())\n        .unwrap_or_else(|| Uuid::new_v4().to_string());\n\n    let request_id = RequestId(id.clone());\n    req.extensions_mut().insert(request_id.clone());\n\n    let mut response = next.run(req).await;\n\n    if let Ok(value) = HeaderValue::from_str(\u0026id) {\n        response.headers_mut().insert(header_name, value);\n    }\n\n    response\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::http::StatusCode;\n    use tower::ServiceExt;\n\n    #[tokio::test]\n    async fn request_id_generates_new_id_when_not_provided() {\n        let app = axum::Router::new()\n            .route(\"/\", axum::routing::get(|| async { \"ok\" }))\n            .layer(axum::middleware::from_fn(request_id));\n\n        let response = app\n            .oneshot(\n                axum::http::Request::builder()\n                    .uri(\"/\")\n                    .body(axum::body::Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n        assert!(response.headers().get(\"x-request-id\").is_some());\n    }\n\n    #[tokio::test]\n    async fn request_id_uses_provided_x_request_id() {\n        let app = axum::Router::new()\n            .route(\"/\", axum::routing::get(|| async { \"ok\" }))\n            .layer(axum::middleware::from_fn(request_id));\n\n        let response = app\n            .oneshot(\n                axum::http::Request::builder()\n                    .uri(\"/\")\n                    .header(\"x-request-id\", \"test-id-123\")\n                    .body(axum::body::Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n        assert_eq!(\n            response.headers().get(\"x-request-id\").unwrap(),\n            \"test-id-123\"\n        );\n    }\n\n    #[tokio::test]\n    async fn request_id_falls_back_to_correlation_id() {\n        let app = axum::Router::new()\n            .route(\"/\", axum::routing::get(|| async { \"ok\" }))\n            .layer(axum::middleware::from_fn(request_id));\n\n        let response = app\n            .oneshot(\n                axum::http::Request::builder()\n                    .uri(\"/\")\n                    .header(\"x-correlation-id\", \"corr-id-456\")\n                    .body(axum::body::Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n        assert_eq!(\n            response.headers().get(\"x-request-id\").unwrap(),\n            \"corr-id-456\"\n        );\n    }\n\n    #[tokio::test]\n    async fn request_id_prefers_x_request_id_over_correlation_id() {\n        let app = axum::Router::new()\n            .route(\"/\", axum::routing::get(|| async { \"ok\" }))\n            .layer(axum::middleware::from_fn(request_id));\n\n        let response = app\n            .oneshot(\n                axum::http::Request::builder()\n                    .uri(\"/\")\n                    .header(\"x-request-id\", \"req-id\")\n                    .header(\"x-correlation-id\", \"corr-id\")\n                    .body(axum::body::Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n        assert_eq!(\n            response.headers().get(\"x-request-id\").unwrap(),\n            \"req-id\"\n        );\n    }\n\n    #[test]\n    fn request_id_struct_has_inner_string() {\n        let req_id = RequestId(\"test-id\".to_string());\n        assert_eq!(req_id.0, \"test-id\");\n    }\n}\n","traces":[{"line":15,"address":[20010409,20009478,20011451,20009664,20011671,20009440],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":16,"address":[20009634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":18,"address":[20009946,20009764],"length":1,"stats":{"Line":2},"fn_name":null},{"line":20,"address":[20009842],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[20009875,20011776],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":22,"address":[20011785],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[20011795],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[20011904,20011913,20009899],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":26,"address":[20009934,20011750,20011728],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":27,"address":[20009953,20011840,20011853],"length":1,"stats":{"Line":3},"fn_name":"{closure#3}"},{"line":29,"address":[20010059,20009980],"length":1,"stats":{"Line":2},"fn_name":null},{"line":30,"address":[20010154,20010089],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[20009694,20010224,20010440],"length":1,"stats":{"Line":1},"fn_name":null},{"line":34,"address":[20011414,20011130,20010856,20010942],"length":1,"stats":{"Line":4},"fn_name":null},{"line":35,"address":[20011186,20011259],"length":1,"stats":{"Line":2},"fn_name":null},{"line":38,"address":[20010985],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":16,"coverable":16},{"path":["/","home","marra","projects","timekeeper","backend","src","models","active_session.rs"],"content":"//! Models for tracking active user sessions.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\nuse crate::types::UserId;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\n/// Database representation of an active user session.\npub struct ActiveSession {\n    /// Unique identifier for the session record.\n    pub id: String,\n    /// User ID associated with the session.\n    pub user_id: UserId,\n    /// Refresh token ID linked to the session.\n    pub refresh_token_id: String,\n    /// Access token JTI associated with the session.\n    pub access_jti: Option\u003cString\u003e,\n    /// Optional label identifying the client/device.\n    pub device_label: Option\u003cString\u003e,\n    /// Timestamp when the session was created.\n    pub created_at: DateTime\u003cUtc\u003e,\n    /// Timestamp when the session was last used.\n    pub last_seen_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Timestamp when the session expires.\n    pub expires_at: DateTime\u003cUtc\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","models","attendance.rs"],"content":"//! Models that represent employee attendance records and related requests.\n\nuse crate::models::break_record::BreakRecordResponse;\nuse crate::types::{AttendanceId, BreakRecordId, UserId};\nuse chrono::{DateTime, NaiveDate, NaiveDateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\n/// Persistent record of a single day's attendance for an employee.\npub struct Attendance {\n    /// Unique identifier for the attendance record.\n    pub id: AttendanceId,\n    /// Identifier of the employee that owns the record.\n    pub user_id: UserId,\n    /// Calendar day the record tracks.\n    pub date: NaiveDate,\n    /// Timestamp when the employee clocked in, if any.\n    pub clock_in_time: Option\u003cNaiveDateTime\u003e,\n    /// Timestamp when the employee clocked out, if any.\n    pub clock_out_time: Option\u003cNaiveDateTime\u003e,\n    /// High-level status describing the attendance outcome for the day.\n    pub status: AttendanceStatus,\n    /// Total hours worked for the day once both clock-in and clock-out are present.\n    pub total_work_hours: Option\u003cf64\u003e,\n    /// Creation timestamp for auditing.\n    pub created_at: DateTime\u003cUtc\u003e,\n    /// Last update timestamp for auditing.\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type, ToSchema, Default)]\n#[sqlx(type_name = \"TEXT\", rename_all = \"snake_case\")]\n#[serde(rename_all = \"snake_case\")]\n/// Normalized status values stored in the database.\npub enum AttendanceStatus {\n    /// Employee was present and on time.\n    #[default]\n    Present,\n    /// Employee was absent for the entire day.\n    Absent,\n    /// Employee arrived late relative to the configured threshold.\n    Late,\n    /// Employee was present for only part of the day.\n    HalfDay,\n}\n\nimpl AttendanceStatus {\n    pub fn db_value(\u0026self) -\u003e \u0026'static str {\n        match self {\n            AttendanceStatus::Present =\u003e \"present\",\n            AttendanceStatus::Absent =\u003e \"absent\",\n            AttendanceStatus::Late =\u003e \"late\",\n            AttendanceStatus::HalfDay =\u003e \"half_day\",\n        }\n    }\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Request payload used when an employee clocks in.\npub struct ClockInRequest {\n    pub date: Option\u003cNaiveDate\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Request payload used when an employee clocks out.\npub struct ClockOutRequest {\n    pub date: Option\u003cNaiveDate\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Request payload for starting a break against an attendance record.\npub struct BreakStartRequest {\n    pub attendance_id: AttendanceId,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Request payload for ending a break session.\npub struct BreakEndRequest {\n    pub break_record_id: BreakRecordId,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// API representation of attendance with associated break records.\npub struct AttendanceResponse {\n    pub id: AttendanceId,\n    pub user_id: UserId,\n    pub date: NaiveDate,\n    pub clock_in_time: Option\u003cNaiveDateTime\u003e,\n    pub clock_out_time: Option\u003cNaiveDateTime\u003e,\n    pub status: AttendanceStatus,\n    pub total_work_hours: Option\u003cf64\u003e,\n    pub break_records: Vec\u003cBreakRecordResponse\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// High-level summary for reporting an employee's monthly attendance.\npub struct AttendanceSummary {\n    pub month: u32,\n    pub year: i32,\n    pub total_work_hours: f64,\n    pub total_work_days: i32,\n    pub average_daily_hours: f64,\n}\n\nimpl From\u003cAttendance\u003e for AttendanceResponse {\n    fn from(a: Attendance) -\u003e Self {\n        Self {\n            id: a.id,\n            user_id: a.user_id,\n            date: a.date,\n            clock_in_time: a.clock_in_time,\n            clock_out_time: a.clock_out_time,\n            status: a.status,\n            total_work_hours: a.total_work_hours,\n            break_records: Vec::new(),\n        }\n    }\n}\n\nimpl Attendance {\n    /// Builds a new attendance record with default status and timestamps.\n    pub fn new(user_id: UserId, date: NaiveDate, now: DateTime\u003cUtc\u003e) -\u003e Self {\n        Self {\n            id: AttendanceId::new(),\n            user_id,\n            date,\n            clock_in_time: None,\n            clock_out_time: None,\n            status: AttendanceStatus::Present,\n            total_work_hours: None,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    /// Recomputes `total_work_hours` when both clock-in and clock-out exist.\n    /// `break_minutes` should be the total minutes spent on breaks for the day.\n    pub fn calculate_work_hours(\u0026mut self, break_minutes: i64) {\n        if let (Some(clock_in), Some(clock_out)) = (self.clock_in_time, self.clock_out_time) {\n            let duration = clock_out - clock_in;\n            let gross_minutes = duration.num_minutes();\n            let net_minutes = gross_minutes - break_minutes.max(0);\n            let effective_minutes = net_minutes.max(0);\n            self.total_work_hours = Some(effective_minutes as f64 / 60.0);\n        }\n    }\n\n    /// Returns `true` when the record has a clock-in but no clock-out yet.\n    pub fn is_clocked_in(\u0026self) -\u003e bool {\n        self.clock_in_time.is_some() \u0026\u0026 self.clock_out_time.is_none()\n    }\n\n    /// Returns `true` once a clock-out timestamp has been recorded.\n    pub fn is_clocked_out(\u0026self) -\u003e bool {\n        self.clock_out_time.is_some()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn attendance_status_serde_snake_case() {\n        let s: AttendanceStatus = serde_json::from_str(\"\\\"half_day\\\"\").unwrap();\n        assert!(matches!(s, AttendanceStatus::HalfDay));\n        let v = serde_json::to_value(AttendanceStatus::HalfDay).unwrap();\n        assert_eq!(v, serde_json::json!(\"half_day\"));\n    }\n\n    #[test]\n    fn attendance_clock_state_helpers() {\n        use chrono::NaiveDate;\n\n        let date = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let now = Utc::now();\n        let mut attendance = Attendance::new(UserId::new(), date, now);\n\n        assert!(!attendance.is_clocked_in());\n        assert!(!attendance.is_clocked_out());\n\n        let clock_in = date.and_hms_opt(9, 0, 0).unwrap();\n        attendance.clock_in_time = Some(clock_in);\n        assert!(attendance.is_clocked_in());\n        assert!(!attendance.is_clocked_out());\n\n        let clock_out = date.and_hms_opt(17, 0, 0).unwrap();\n        attendance.clock_out_time = Some(clock_out);\n        assert!(attendance.is_clocked_out());\n    }\n\n    #[test]\n    fn attendance_status_db_value_matches_schema() {\n        assert_eq!(AttendanceStatus::Present.db_value(), \"present\");\n        assert_eq!(AttendanceStatus::Absent.db_value(), \"absent\");\n        assert_eq!(AttendanceStatus::Late.db_value(), \"late\");\n        assert_eq!(AttendanceStatus::HalfDay.db_value(), \"half_day\");\n    }\n}\n","traces":[{"line":50,"address":[19641056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[19641061],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[19641092],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[19641115],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[19641138],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[19641161],"length":1,"stats":{"Line":1},"fn_name":null},{"line":108,"address":[19640064],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":110,"address":[19640078],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[19640096],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[19640114],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[19640120],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[19640136],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[19640152],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[19640159],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[19640178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[19640848],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[19640879],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[19640432],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[19640462,19640825,19640586],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[19640622],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[19640700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[19640727,19640830],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[19640770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[19640796],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[19640336],"length":1,"stats":{"Line":1},"fn_name":null},{"line":152,"address":[19640349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[19640400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":157,"address":[19640405],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":12,"coverable":28},{"path":["/","home","marra","projects","timekeeper","backend","src","models","audit_log.rs"],"content":"use crate::types::{AuditLogId, UserId};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\nuse sqlx::{types::Json, FromRow};\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct AuditLog {\n    pub id: AuditLogId,\n    pub occurred_at: DateTime\u003cUtc\u003e,\n    pub actor_id: Option\u003cUserId\u003e,\n    pub actor_type: String,\n    pub event_type: String,\n    pub target_type: Option\u003cString\u003e,\n    pub target_id: Option\u003cString\u003e,\n    pub result: String,\n    pub error_code: Option\u003cString\u003e,\n    pub metadata: Option\u003cJson\u003cValue\u003e\u003e,\n    pub ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub request_id: Option\u003cString\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","models","break_record.rs"],"content":"//! Models that capture break sessions within an attendance record.\n\nuse crate::types::{AttendanceId, BreakRecordId};\nuse chrono::{DateTime, NaiveDateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\n/// Persistent representation of a single break interval.\npub struct BreakRecord {\n    /// Unique identifier for the break record.\n    pub id: BreakRecordId,\n    /// Associated attendance record identifier.\n    pub attendance_id: AttendanceId,\n    /// Timestamp when the break started.\n    pub break_start_time: NaiveDateTime,\n    /// Timestamp when the break ended, if the break is closed.\n    pub break_end_time: Option\u003cNaiveDateTime\u003e,\n    /// Duration of the break in minutes, filled when the break ends.\n    pub duration_minutes: Option\u003ci32\u003e,\n    /// Creation timestamp for auditing.\n    pub created_at: DateTime\u003cUtc\u003e,\n    /// Last update timestamp for auditing.\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// API-friendly representation of a break interval.\npub struct BreakRecordResponse {\n    pub id: BreakRecordId,\n    pub attendance_id: AttendanceId,\n    pub break_start_time: NaiveDateTime,\n    pub break_end_time: Option\u003cNaiveDateTime\u003e,\n    pub duration_minutes: Option\u003ci32\u003e,\n}\n\nimpl From\u003cBreakRecord\u003e for BreakRecordResponse {\n    /// Converts a database model into the response payload variant.\n    fn from(record: BreakRecord) -\u003e Self {\n        BreakRecordResponse {\n            id: record.id,\n            attendance_id: record.attendance_id,\n            break_start_time: record.break_start_time,\n            break_end_time: record.break_end_time,\n            duration_minutes: record.duration_minutes,\n        }\n    }\n}\n\nimpl BreakRecord {\n    /// Creates a new break record that starts immediately.\n    pub fn new(\n        attendance_id: AttendanceId,\n        break_start_time: NaiveDateTime,\n        now: DateTime\u003cUtc\u003e,\n    ) -\u003e Self {\n        Self {\n            id: BreakRecordId::new(),\n            attendance_id,\n            break_start_time,\n            break_end_time: None,\n            duration_minutes: None,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    /// Marks the break as completed and computes its duration.\n    pub fn end_break(\u0026mut self, break_end_time: NaiveDateTime, now: DateTime\u003cUtc\u003e) {\n        self.break_end_time = Some(break_end_time);\n        let duration = break_end_time - self.break_start_time;\n        self.duration_minutes = Some(duration.num_minutes() as i32);\n        self.updated_at = now;\n    }\n\n    /// Returns `true` while the break is still active.\n    pub fn is_active(\u0026self) -\u003e bool {\n        self.break_end_time.is_none()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::NaiveDate;\n\n    #[test]\n    fn break_record_activity_reflects_end_state() {\n        let start = NaiveDate::from_ymd_opt(2024, 1, 1)\n            .unwrap()\n            .and_hms_opt(12, 0, 0)\n            .unwrap();\n        let now = Utc::now();\n        let mut record = BreakRecord::new(AttendanceId::new(), start, now);\n        assert!(record.is_active());\n\n        let end = start + chrono::Duration::minutes(15);\n        record.end_break(end, now);\n        assert!(!record.is_active());\n    }\n}\n","traces":[{"line":40,"address":[23087936],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":42,"address":[23087939],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[23087957],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[23087975],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[23087991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[23088007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[23088096],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[23088124],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[23088272],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[23088290],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[23088321],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[23088376],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[23088404],"length":1,"stats":{"Line":1},"fn_name":null},{"line":78,"address":[23088432],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[23088437],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":9,"coverable":15},{"path":["/","home","marra","projects","timekeeper","backend","src","models","consent_log.rs"],"content":"use chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct ConsentLog {\n    pub id: String,\n    pub user_id: String,\n    pub purpose: String,\n    pub policy_version: String,\n    pub consented_at: DateTime\u003cUtc\u003e,\n    pub ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub request_id: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct ConsentLogResponse {\n    pub id: String,\n    pub purpose: String,\n    pub policy_version: String,\n    pub consented_at: DateTime\u003cUtc\u003e,\n    pub ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub request_id: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl From\u003cConsentLog\u003e for ConsentLogResponse {\n    fn from(log: ConsentLog) -\u003e Self {\n        Self {\n            id: log.id,\n            purpose: log.purpose,\n            policy_version: log.policy_version,\n            consented_at: log.consented_at,\n            ip: log.ip,\n            user_agent: log.user_agent,\n            request_id: log.request_id,\n            created_at: log.created_at,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct RecordConsentPayload {\n    pub purpose: String,\n    pub policy_version: String,\n}\n","traces":[{"line":32,"address":[21898784],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":34,"address":[21898812],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[21898838],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[21898865],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[21898892],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[21898914],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[21898944],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[21898986],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[21899031],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":9},{"path":["/","home","marra","projects","timekeeper","backend","src","models","holiday.rs"],"content":"use crate::types::{HolidayId, UserId, WeeklyHolidayId};\nuse chrono::{DateTime, NaiveDate, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse std::str::FromStr;\nuse utoipa::ToSchema;\n\n#[derive(Debug, Serialize, Clone, Copy, PartialEq, Eq, ToSchema)]\n#[serde(rename_all = \"snake_case\")]\npub enum AdminHolidayKind {\n    Public,\n    Weekly,\n    Exception,\n}\n\nimpl AdminHolidayKind {\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            AdminHolidayKind::Public =\u003e \"public\",\n            AdminHolidayKind::Weekly =\u003e \"weekly\",\n            AdminHolidayKind::Exception =\u003e \"exception\",\n        }\n    }\n}\n\nimpl FromStr for AdminHolidayKind {\n    type Err = ();\n\n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        match s.to_ascii_lowercase().as_str() {\n            \"public\" =\u003e Ok(AdminHolidayKind::Public),\n            \"weekly\" =\u003e Ok(AdminHolidayKind::Weekly),\n            \"exception\" =\u003e Ok(AdminHolidayKind::Exception),\n            _ =\u003e Err(()),\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\npub struct Holiday {\n    pub id: HolidayId,\n    pub holiday_date: NaiveDate,\n    pub name: String,\n    pub description: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\nimpl Holiday {\n    pub fn new(holiday_date: NaiveDate, name: String, description: Option\u003cString\u003e) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: HolidayId::new(),\n            holiday_date,\n            name,\n            description,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct CreateHolidayPayload {\n    pub holiday_date: NaiveDate,\n    pub name: String,\n    #[serde(default)]\n    pub description: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct HolidayResponse {\n    pub id: HolidayId,\n    pub holiday_date: NaiveDate,\n    pub name: String,\n    pub description: Option\u003cString\u003e,\n}\n\nimpl From\u003cHoliday\u003e for HolidayResponse {\n    fn from(value: Holiday) -\u003e Self {\n        Self {\n            id: value.id,\n            holiday_date: value.holiday_date,\n            name: value.name,\n            description: value.description,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct CreateWeeklyHolidayPayload {\n    pub weekday: u8,\n    pub starts_on: NaiveDate,\n    #[serde(default)]\n    pub ends_on: Option\u003cNaiveDate\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\npub struct WeeklyHoliday {\n    pub id: WeeklyHolidayId,\n    pub weekday: i16,\n    pub starts_on: NaiveDate,\n    pub ends_on: Option\u003cNaiveDate\u003e,\n    pub enforced_from: NaiveDate,\n    pub enforced_to: Option\u003cNaiveDate\u003e,\n    pub created_by: UserId,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\nimpl WeeklyHoliday {\n    pub fn new(\n        weekday: u8,\n        starts_on: NaiveDate,\n        ends_on: Option\u003cNaiveDate\u003e,\n        created_by: UserId,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: WeeklyHolidayId::new(),\n            weekday: weekday as i16,\n            starts_on,\n            ends_on,\n            enforced_from: starts_on,\n            enforced_to: ends_on,\n            created_by,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct WeeklyHolidayResponse {\n    pub id: WeeklyHolidayId,\n    pub weekday: u8,\n    pub starts_on: NaiveDate,\n    pub ends_on: Option\u003cNaiveDate\u003e,\n    pub enforced_from: NaiveDate,\n    pub enforced_to: Option\u003cNaiveDate\u003e,\n}\n\nimpl From\u003cWeeklyHoliday\u003e for WeeklyHolidayResponse {\n    fn from(value: WeeklyHoliday) -\u003e Self {\n        Self {\n            id: value.id,\n            weekday: value.weekday as u8,\n            starts_on: value.starts_on,\n            ends_on: value.ends_on,\n            enforced_from: value.enforced_from,\n            enforced_to: value.enforced_to,\n        }\n    }\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct AdminHolidayListItem {\n    pub id: String,\n    pub kind: AdminHolidayKind,\n    pub applies_from: NaiveDate,\n    pub applies_to: Option\u003cNaiveDate\u003e,\n    pub date: Option\u003cNaiveDate\u003e,\n    pub weekday: Option\u003ci16\u003e,\n    pub starts_on: Option\u003cNaiveDate\u003e,\n    pub ends_on: Option\u003cNaiveDate\u003e,\n    pub name: Option\u003cString\u003e,\n    pub description: Option\u003cString\u003e,\n    pub user_id: Option\u003cString\u003e,\n    pub reason: Option\u003cString\u003e,\n    pub created_by: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub is_override: Option\u003cbool\u003e,\n}\n","traces":[{"line":17,"address":[21418032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[21418037],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[21418069],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[21418092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[21418115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[21399377,21399088,21399371],"length":1,"stats":{"Line":1},"fn_name":"from_str"},{"line":30,"address":[21399118,21399190],"length":1,"stats":{"Line":2},"fn_name":null},{"line":31,"address":[21399272,21399206],"length":1,"stats":{"Line":2},"fn_name":null},{"line":32,"address":[21399249,21399283,21399322],"length":1,"stats":{"Line":3},"fn_name":null},{"line":33,"address":[21399299,21399346,21399333],"length":1,"stats":{"Line":3},"fn_name":null},{"line":34,"address":[21399339],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[21418479,21418160,21418457],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[21418198],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[21418260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[21416640],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":82,"address":[21416643],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[21416661],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21416664],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[21416690],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[21417840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21417886],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21417897],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[21417935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[21416800],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":146,"address":[21416806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[21416824],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[21416831],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[21416834],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[21416837],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[21416840],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":6,"coverable":30},{"path":["/","home","marra","projects","timekeeper","backend","src","models","holiday_exception.rs"],"content":"use crate::types::{HolidayExceptionId, UserId};\nuse chrono::{DateTime, NaiveDate, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\npub struct HolidayException {\n    pub id: HolidayExceptionId,\n    pub user_id: UserId,\n    pub exception_date: NaiveDate,\n    #[serde(default)]\n    #[sqlx(rename = \"override\")]\n    pub is_holiday_override: bool,\n    pub reason: Option\u003cString\u003e,\n    pub created_by: UserId,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\nimpl HolidayException {\n    pub fn new(\n        user_id: UserId,\n        exception_date: NaiveDate,\n        reason: Option\u003cString\u003e,\n        created_by: UserId,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: HolidayExceptionId::new(),\n            user_id,\n            exception_date,\n            is_holiday_override: false,\n            reason,\n            created_by,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    pub fn is_workday(\u0026self) -\u003e bool {\n        !self.is_holiday_override\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct CreateHolidayExceptionPayload {\n    pub exception_date: NaiveDate,\n    #[serde(default)]\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct HolidayExceptionResponse {\n    pub id: HolidayExceptionId,\n    pub exception_date: NaiveDate,\n    pub is_workday: bool,\n    pub reason: Option\u003cString\u003e,\n}\n\nimpl From\u003cHolidayException\u003e for HolidayExceptionResponse {\n    fn from(value: HolidayException) -\u003e Self {\n        let is_workday = value.is_workday();\n        Self {\n            id: value.id,\n            exception_date: value.exception_date,\n            is_workday,\n            reason: value.reason,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn new_sets_workday_override() {\n        let user_id = UserId::new();\n        let admin_id = UserId::new();\n        let exception = HolidayException::new(\n            user_id,\n            NaiveDate::from_ymd_opt(2024, 12, 24).unwrap(),\n            Some(\"オフサイト参加\".to_string()),\n            admin_id,\n        );\n\n        assert_eq!(exception.user_id, user_id);\n        assert_eq!(\n            exception.exception_date,\n            NaiveDate::from_ymd_opt(2024, 12, 24).unwrap()\n        );\n        assert!(!exception.is_holiday_override);\n        assert!(exception.is_workday());\n        assert_eq!(exception.reason.as_deref(), Some(\"オフサイト参加\"));\n        assert_eq!(exception.created_by, admin_id);\n    }\n}\n","traces":[{"line":22,"address":[19627498,19627216],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[19627256],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[19627315],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[19627200],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[19627205],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[19627181,19626976],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":63,"address":[19627003,19627064],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[19627076],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[19627094],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[19627097],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":5,"coverable":10},{"path":["/","home","marra","projects","timekeeper","backend","src","models","leave_request.rs"],"content":"//! Models describing employee leave requests and their lifecycle.\n\nuse crate::types::{LeaveRequestId, UserId};\nuse chrono::{DateTime, NaiveDate, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\nuse validator::Validate;\n\npub use crate::models::request::RequestStatus;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\n/// Database representation of a leave request submitted by an employee.\npub struct LeaveRequest {\n    /// Unique identifier for the leave request.\n    pub id: LeaveRequestId,\n    /// Identifier of the employee who submitted the request.\n    pub user_id: UserId,\n    /// Type of leave being requested.\n    pub leave_type: LeaveType,\n    /// First day of the requested leave period.\n    pub start_date: NaiveDate,\n    /// Last day of the requested leave period.\n    pub end_date: NaiveDate,\n    /// Optional user-provided explanation for the leave.\n    pub reason: Option\u003cString\u003e,\n    /// Current status of the leave request.\n    pub status: RequestStatus,\n    /// Administrator who approved the request, if any.\n    pub approved_by: Option\u003cUserId\u003e,\n    /// Timestamp when the request was approved.\n    pub approved_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Administrator who rejected the request, if any.\n    pub rejected_by: Option\u003cUserId\u003e,\n    /// Timestamp when the request was rejected.\n    pub rejected_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Timestamp when the requester cancelled the request.\n    pub cancelled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Supplemental notes recorded during approval or rejection.\n    pub decision_comment: Option\u003cString\u003e,\n    /// Creation timestamp for auditing.\n    pub created_at: DateTime\u003cUtc\u003e,\n    /// Last update timestamp for auditing.\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type, ToSchema)]\n#[sqlx(type_name = \"TEXT\", rename_all = \"snake_case\")]\n#[serde(rename_all = \"snake_case\")]\n/// Supported leave categories.\npub enum LeaveType {\n    /// Planned vacation or personal time off.\n    Annual,\n    /// Sick leave.\n    Sick,\n    /// Personal leave not covered by other categories.\n    Personal,\n    /// Custom leave type stored as free-form text.\n    Other,\n}\n\nimpl LeaveType {\n    pub fn db_value(\u0026self) -\u003e \u0026'static str {\n        match self {\n            LeaveType::Annual =\u003e \"annual\",\n            LeaveType::Sick =\u003e \"sick\",\n            LeaveType::Personal =\u003e \"personal\",\n            LeaveType::Other =\u003e \"other\",\n        }\n    }\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema, Validate)]\n/// Payload used to create a new leave request.\n#[validate(schema(function = \"validate_leave_date_range\"))]\npub struct CreateLeaveRequest {\n    pub leave_type: LeaveType,\n    pub start_date: NaiveDate,\n    pub end_date: NaiveDate,\n    #[validate(length(max = 500))]\n    pub reason: Option\u003cString\u003e,\n}\n\nfn validate_leave_date_range(req: \u0026CreateLeaveRequest) -\u003e Result\u003c(), validator::ValidationError\u003e {\n    if req.start_date \u003e req.end_date {\n        return Err(validator::ValidationError::new(\"start_date_after_end_date\"));\n    }\n    Ok(())\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// API representation shared with clients.\npub struct LeaveRequestResponse {\n    pub id: LeaveRequestId,\n    pub user_id: UserId,\n    pub leave_type: LeaveType,\n    pub start_date: NaiveDate,\n    pub end_date: NaiveDate,\n    pub reason: Option\u003cString\u003e,\n    pub status: RequestStatus,\n    pub approved_by: Option\u003cUserId\u003e,\n    pub approved_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub rejected_by: Option\u003cUserId\u003e,\n    pub rejected_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub cancelled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub decision_comment: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl From\u003cLeaveRequest\u003e for LeaveRequestResponse {\n    /// Converts the database entity into its transport-friendly variant.\n    fn from(request: LeaveRequest) -\u003e Self {\n        LeaveRequestResponse {\n            id: request.id,\n            user_id: request.user_id,\n            leave_type: request.leave_type,\n            start_date: request.start_date,\n            end_date: request.end_date,\n            reason: request.reason,\n            status: request.status,\n            approved_by: request.approved_by,\n            approved_at: request.approved_at,\n            rejected_by: request.rejected_by,\n            rejected_at: request.rejected_at,\n            cancelled_at: request.cancelled_at,\n            decision_comment: request.decision_comment,\n            created_at: request.created_at,\n        }\n    }\n}\n\nimpl LeaveRequest {\n    /// Creates a new leave request pending approval.\n    pub fn new(\n        user_id: UserId,\n        leave_type: LeaveType,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n        reason: Option\u003cString\u003e,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: LeaveRequestId::new(),\n            user_id,\n            leave_type,\n            start_date,\n            end_date,\n            reason,\n            status: RequestStatus::Pending,\n            approved_by: None,\n            approved_at: None,\n            rejected_by: None,\n            rejected_at: None,\n            cancelled_at: None,\n            decision_comment: None,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    /// Marks the request as approved and records reviewer details.\n    #[allow(dead_code)]\n    pub fn approve(\u0026mut self, approved_by: UserId) {\n        self.status = RequestStatus::Approved;\n        self.approved_by = Some(approved_by);\n        self.approved_at = Some(Utc::now());\n        self.updated_at = Utc::now();\n    }\n\n    /// Marks the request as rejected and records reviewer details.\n    #[allow(dead_code)]\n    pub fn reject(\u0026mut self, approved_by: UserId) {\n        self.status = RequestStatus::Rejected;\n        self.rejected_by = Some(approved_by);\n        self.rejected_at = Some(Utc::now());\n        self.updated_at = Utc::now();\n    }\n\n    /// Returns `true` while the request is awaiting a reviewer decision.\n    pub fn is_pending(\u0026self) -\u003e bool {\n        matches!(self.status, RequestStatus::Pending)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn leave_type_and_status_serde_snake_case() {\n        // LeaveType\n        let lt: LeaveType = serde_json::from_str(\"\\\"annual\\\"\").unwrap();\n        assert!(matches!(lt, LeaveType::Annual));\n        let vlt = serde_json::to_value(LeaveType::Personal).unwrap();\n        assert_eq!(vlt, serde_json::json!(\"personal\"));\n        assert_eq!(LeaveType::Annual.db_value(), \"annual\");\n\n        // RequestStatus\n        let rs: RequestStatus = serde_json::from_str(\"\\\"rejected\\\"\").unwrap();\n        assert!(matches!(rs, RequestStatus::Rejected));\n        let vrs = serde_json::to_value(RequestStatus::Cancelled).unwrap();\n        assert_eq!(vrs, serde_json::json!(\"cancelled\"));\n        assert_eq!(RequestStatus::Pending.db_value(), \"pending\");\n    }\n\n    #[test]\n    fn leave_request_state_transitions() {\n        use chrono::NaiveDate;\n\n        let start = NaiveDate::from_ymd_opt(2024, 4, 1).unwrap();\n        let end = NaiveDate::from_ymd_opt(2024, 4, 2).unwrap();\n\n        let user_id = UserId::new();\n        let admin_id = UserId::new();\n        let admin2_id = UserId::new();\n\n        let mut request = LeaveRequest::new(user_id, LeaveType::Annual, start, end, None);\n        assert!(request.is_pending());\n\n        request.approve(admin_id);\n        assert!(matches!(request.status, RequestStatus::Approved));\n        assert_eq!(request.approved_by, Some(admin_id));\n        assert!(request.approved_at.is_some());\n\n        let mut rejected = LeaveRequest::new(user_id, LeaveType::Sick, start, end, None);\n        rejected.reject(admin2_id);\n        assert!(matches!(rejected.status, RequestStatus::Rejected));\n        assert_eq!(rejected.rejected_by, Some(admin2_id));\n        assert!(rejected.rejected_at.is_some());\n    }\n}\n","traces":[{"line":63,"address":[21520288],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[21520293],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[21520324],"length":1,"stats":{"Line":1},"fn_name":null},{"line":66,"address":[21520347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[21520370],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[21520393],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21520176],"length":1,"stats":{"Line":0},"fn_name":"validate_leave_date_range"},{"line":85,"address":[21520194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[21520234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[21520219],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[21518672],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":114,"address":[21518682],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[21518700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[21518718],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[21518725],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21518729],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[21518733],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21518759],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[21518766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[21518802],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[21518820],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[21518856],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[21518877],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[21518901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[21518928],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[21519232,21519798],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[21519296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":143,"address":[21519358],"length":1,"stats":{"Line":1},"fn_name":null},{"line":163,"address":[21520000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":164,"address":[21520013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[21520020],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[21520076],"length":1,"stats":{"Line":1},"fn_name":null},{"line":167,"address":[21520125],"length":1,"stats":{"Line":1},"fn_name":null},{"line":172,"address":[21519824],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[21519837],"length":1,"stats":{"Line":1},"fn_name":null},{"line":174,"address":[21519844],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[21519900],"length":1,"stats":{"Line":1},"fn_name":null},{"line":176,"address":[21519952],"length":1,"stats":{"Line":1},"fn_name":null},{"line":180,"address":[21519200],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[21519205],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":18,"coverable":40},{"path":["/","home","marra","projects","timekeeper","backend","src","models","mod.rs"],"content":"//! Data models shared across database access and API handlers.\n\nuse serde::{Deserialize, Serialize};\nuse utoipa::{IntoParams, ToSchema};\n\n/// Query parameters for paginated endpoints.\n#[derive(Debug, Clone, Deserialize, IntoParams, ToSchema)]\npub struct PaginationQuery {\n    /// Maximum number of records to return (default: 50, max: 500).\n    #[serde(default = \"default_limit\")]\n    pub limit: i64,\n    /// Number of records to skip (default: 0).\n    #[serde(default)]\n    pub offset: i64,\n}\n\nfn default_limit() -\u003e i64 {\n    50\n}\n\nimpl PaginationQuery {\n    /// Returns a clamped limit value (1..=500).\n    pub fn limit(\u0026self) -\u003e i64 {\n        self.limit.clamp(1, 500)\n    }\n\n    /// Returns offset, floored at 0.\n    pub fn offset(\u0026self) -\u003e i64 {\n        self.offset.max(0)\n    }\n}\n\nimpl Default for PaginationQuery {\n    fn default() -\u003e Self {\n        Self {\n            limit: default_limit(),\n            offset: 0,\n        }\n    }\n}\n\n/// Wrapper for paginated API responses.\n#[derive(Debug, Clone, Serialize, ToSchema)]\npub struct PaginatedResponse\u003cT: Serialize\u003e {\n    /// The data items for the current page.\n    pub data: Vec\u003cT\u003e,\n    /// Total number of records matching the query.\n    pub total: i64,\n    /// Number of records returned in this response.\n    pub limit: i64,\n    /// Number of records skipped.\n    pub offset: i64,\n}\n\nimpl\u003cT: Serialize\u003e PaginatedResponse\u003cT\u003e {\n    pub fn new(data: Vec\u003cT\u003e, total: i64, limit: i64, offset: i64) -\u003e Self {\n        Self {\n            data,\n            total,\n            limit,\n            offset,\n        }\n    }\n}\n\npub mod active_session;\npub mod attendance;\npub mod audit_log;\npub mod break_record;\npub mod consent_log;\npub mod holiday;\npub mod holiday_exception;\npub mod leave_request;\npub mod overtime_request;\npub mod password_reset;\npub mod request;\npub mod subject_request;\npub mod user;\n","traces":[{"line":23,"address":[20293392],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[20293397],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[20293424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[20293429],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[20295904],"length":1,"stats":{"Line":0},"fn_name":"default"},{"line":36,"address":[20295905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[22996944],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":7},{"path":["/","home","marra","projects","timekeeper","backend","src","models","overtime_request.rs"],"content":"//! Models describing overtime requests and review workflow.\n\nuse crate::types::{OvertimeRequestId, UserId};\nuse chrono::{DateTime, NaiveDate, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\nuse validator::Validate;\n\npub use crate::models::request::RequestStatus;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\n/// Database representation of an overtime work request.\npub struct OvertimeRequest {\n    /// Unique identifier for the overtime request.\n    pub id: OvertimeRequestId,\n    /// Identifier of the employee submitting the request.\n    pub user_id: UserId,\n    /// Date when the overtime is planned.\n    pub date: NaiveDate,\n    /// Number of overtime hours planned.\n    pub planned_hours: f64,\n    /// Optional justification provided by the requester.\n    pub reason: Option\u003cString\u003e,\n    /// Current status of the request.\n    pub status: RequestStatus,\n    /// Administrator who approved the request, if any.\n    pub approved_by: Option\u003cUserId\u003e,\n    /// Timestamp when the request received approval.\n    pub approved_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Administrator who rejected the request, if any.\n    pub rejected_by: Option\u003cUserId\u003e,\n    /// Timestamp when the request was rejected.\n    pub rejected_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Timestamp when the requester cancelled the request.\n    pub cancelled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Supplemental comments recorded during review.\n    pub decision_comment: Option\u003cString\u003e,\n    /// Creation timestamp for auditing.\n    pub created_at: DateTime\u003cUtc\u003e,\n    /// Last update timestamp for auditing.\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema, Validate)]\n/// Payload used to create a new overtime request.\npub struct CreateOvertimeRequest {\n    pub date: NaiveDate,\n    #[validate(range(min = 0.5, max = 24.0))]\n    pub planned_hours: f64,\n    #[validate(length(max = 500))]\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// API response returned for overtime requests.\npub struct OvertimeRequestResponse {\n    pub id: OvertimeRequestId,\n    pub user_id: UserId,\n    pub date: NaiveDate,\n    pub planned_hours: f64,\n    pub reason: Option\u003cString\u003e,\n    pub status: RequestStatus,\n    pub approved_by: Option\u003cUserId\u003e,\n    pub approved_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub rejected_by: Option\u003cUserId\u003e,\n    pub rejected_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub cancelled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub decision_comment: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl From\u003cOvertimeRequest\u003e for OvertimeRequestResponse {\n    /// Converts a persisted overtime request into its response form.\n    fn from(request: OvertimeRequest) -\u003e Self {\n        OvertimeRequestResponse {\n            id: request.id,\n            user_id: request.user_id,\n            date: request.date,\n            planned_hours: request.planned_hours,\n            reason: request.reason,\n            status: request.status,\n            approved_by: request.approved_by,\n            approved_at: request.approved_at,\n            rejected_by: request.rejected_by,\n            rejected_at: request.rejected_at,\n            cancelled_at: request.cancelled_at,\n            decision_comment: request.decision_comment,\n            created_at: request.created_at,\n        }\n    }\n}\n\nimpl OvertimeRequest {\n    /// Creates a new overtime request pending review.\n    pub fn new(\n        user_id: UserId,\n        date: NaiveDate,\n        planned_hours: f64,\n        reason: Option\u003cString\u003e,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: OvertimeRequestId::new(),\n            user_id,\n            date,\n            planned_hours,\n            reason,\n            status: RequestStatus::Pending,\n            approved_by: None,\n            approved_at: None,\n            rejected_by: None,\n            rejected_at: None,\n            cancelled_at: None,\n            decision_comment: None,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    /// Marks the request as approved.\n    #[allow(dead_code)]\n    pub fn approve(\u0026mut self, approved_by: UserId) {\n        self.status = RequestStatus::Approved;\n        self.approved_by = Some(approved_by);\n        self.approved_at = Some(Utc::now());\n        self.updated_at = Utc::now();\n    }\n\n    /// Marks the request as rejected.\n    #[allow(dead_code)]\n    pub fn reject(\u0026mut self, approved_by: UserId) {\n        self.status = RequestStatus::Rejected;\n        self.rejected_by = Some(approved_by);\n        self.rejected_at = Some(Utc::now());\n        self.updated_at = Utc::now();\n    }\n\n    /// Returns `true` while the request is awaiting review.\n    pub fn is_pending(\u0026self) -\u003e bool {\n        matches!(self.status, RequestStatus::Pending)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn overtime_request_status_serde_snake_case() {\n        let s: RequestStatus = serde_json::from_str(\"\\\"approved\\\"\").unwrap();\n        assert!(matches!(s, RequestStatus::Approved));\n        let v = serde_json::to_value(RequestStatus::Pending).unwrap();\n        assert_eq!(v, serde_json::json!(\"pending\"));\n        assert_eq!(RequestStatus::Approved.db_value(), \"approved\");\n    }\n\n    #[test]\n    fn overtime_request_state_transitions() {\n        use chrono::NaiveDate;\n\n        let date = NaiveDate::from_ymd_opt(2024, 5, 1).unwrap();\n\n        let user_id = UserId::new();\n        let admin_id = UserId::new();\n        let admin2_id = UserId::new();\n\n        let mut request = OvertimeRequest::new(user_id, date, 2.5, None);\n        assert!(request.is_pending());\n        request.approve(admin_id);\n        assert!(matches!(request.status, RequestStatus::Approved));\n        assert_eq!(request.approved_by, Some(admin_id));\n        assert!(request.approved_at.is_some());\n\n        let mut rejected = OvertimeRequest::new(user_id, date, 1.0, None);\n        rejected.reject(admin2_id);\n        assert!(matches!(rejected.status, RequestStatus::Rejected));\n        assert_eq!(rejected.rejected_by, Some(admin2_id));\n        assert!(rejected.rejected_at.is_some());\n    }\n}\n","traces":[{"line":75,"address":[20208624],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":77,"address":[20208631],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[20208649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[20208667],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[20208670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[20208675],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[20208701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[20208707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[20208743],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[20208761],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[20208797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[20208821],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[20208845],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[20208872],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[20209718,20209168],"length":1,"stats":{"Line":1},"fn_name":null},{"line":102,"address":[20209221],"length":1,"stats":{"Line":1},"fn_name":null},{"line":104,"address":[20209283],"length":1,"stats":{"Line":1},"fn_name":null},{"line":123,"address":[20209920],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[20209933],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[20209940],"length":1,"stats":{"Line":1},"fn_name":null},{"line":126,"address":[20209996],"length":1,"stats":{"Line":1},"fn_name":null},{"line":127,"address":[20210045],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[20209744],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[20209757],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[20209764],"length":1,"stats":{"Line":1},"fn_name":null},{"line":135,"address":[20209820],"length":1,"stats":{"Line":1},"fn_name":null},{"line":136,"address":[20209875],"length":1,"stats":{"Line":1},"fn_name":null},{"line":140,"address":[20209136],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[20209141],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":15,"coverable":29},{"path":["/","home","marra","projects","timekeeper","backend","src","models","password_reset.rs"],"content":"//! Models for password reset functionality.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\nuse validator::Validate;\n\nuse crate::types::UserId;\nuse crate::validation::rules;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\n/// Database representation of a password reset token.\npub struct PasswordReset {\n    /// Unique identifier for the password reset record.\n    pub id: String,\n    /// User ID associated with this reset token.\n    pub user_id: UserId,\n    /// SHA-256 hash of the reset token (for security).\n    pub token_hash: String,\n    /// Timestamp when this token expires.\n    pub expires_at: DateTime\u003cUtc\u003e,\n    /// Creation timestamp for auditing.\n    pub created_at: DateTime\u003cUtc\u003e,\n    /// Timestamp when this token was used (null if not yet used).\n    pub used_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, ToSchema)]\n/// Payload for requesting a password reset.\npub struct RequestPasswordResetPayload {\n    /// Email address of the user requesting password reset.\n    #[validate(email(message = \"Invalid email address\"))]\n    pub email: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, ToSchema)]\n/// Payload for resetting password with a token.\npub struct ResetPasswordPayload {\n    /// Password reset token from the email.\n    #[validate(length(min = 32, message = \"Invalid reset token\"))]\n    pub token: String,\n    #[validate(custom(function = \"rules::validate_password_strength\"))]\n    pub new_password: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","models","request.rs"],"content":"//! Shared request-related enums used by multiple models.\n\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type, ToSchema, Default)]\n#[sqlx(type_name = \"TEXT\", rename_all = \"snake_case\")]\n#[serde(rename_all = \"snake_case\")]\n/// Common workflow status for leave and overtime requests.\npub enum RequestStatus {\n    #[default]\n    Pending,\n    Approved,\n    Rejected,\n    Cancelled,\n}\n\nimpl RequestStatus {\n    pub fn db_value(\u0026self) -\u003e \u0026'static str {\n        match self {\n            RequestStatus::Pending =\u003e \"pending\",\n            RequestStatus::Approved =\u003e \"approved\",\n            RequestStatus::Rejected =\u003e \"rejected\",\n            RequestStatus::Cancelled =\u003e \"cancelled\",\n        }\n    }\n}\n","traces":[{"line":19,"address":[21940800],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[21940805],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[21940836],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[21940859],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[21940882],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[21940905],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":4,"coverable":6},{"path":["/","home","marra","projects","timekeeper","backend","src","models","subject_request.rs"],"content":"use chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\nuse uuid::Uuid;\n\nuse crate::models::request::RequestStatus;\n\n#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type, ToSchema)]\n#[sqlx(type_name = \"TEXT\", rename_all = \"snake_case\")]\n#[serde(rename_all = \"snake_case\")]\npub enum DataSubjectRequestType {\n    Access,\n    Rectify,\n    Delete,\n    Stop,\n}\n\nimpl DataSubjectRequestType {\n    pub fn db_value(\u0026self) -\u003e \u0026'static str {\n        match self {\n            DataSubjectRequestType::Access =\u003e \"access\",\n            DataSubjectRequestType::Rectify =\u003e \"rectify\",\n            DataSubjectRequestType::Delete =\u003e \"delete\",\n            DataSubjectRequestType::Stop =\u003e \"stop\",\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\npub struct DataSubjectRequest {\n    pub id: String,\n    pub user_id: String,\n    pub request_type: DataSubjectRequestType,\n    pub status: RequestStatus,\n    pub details: Option\u003cString\u003e,\n    pub approved_by: Option\u003cString\u003e,\n    pub approved_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub rejected_by: Option\u003cString\u003e,\n    pub rejected_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub cancelled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub decision_comment: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\nimpl DataSubjectRequest {\n    pub fn new(\n        user_id: String,\n        request_type: DataSubjectRequestType,\n        details: Option\u003cString\u003e,\n        now: DateTime\u003cUtc\u003e,\n    ) -\u003e Self {\n        Self {\n            id: Uuid::new_v4().to_string(),\n            user_id,\n            request_type,\n            status: RequestStatus::Pending,\n            details,\n            approved_by: None,\n            approved_at: None,\n            rejected_by: None,\n            rejected_at: None,\n            cancelled_at: None,\n            decision_comment: None,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct CreateDataSubjectRequest {\n    pub request_type: DataSubjectRequestType,\n    pub details: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]\npub struct DataSubjectRequestResponse {\n    pub id: String,\n    pub user_id: String,\n    pub request_type: DataSubjectRequestType,\n    pub status: RequestStatus,\n    pub details: Option\u003cString\u003e,\n    pub approved_by: Option\u003cString\u003e,\n    pub approved_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub rejected_by: Option\u003cString\u003e,\n    pub rejected_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub cancelled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub decision_comment: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\nimpl From\u003cDataSubjectRequest\u003e for DataSubjectRequestResponse {\n    fn from(request: DataSubjectRequest) -\u003e Self {\n        Self {\n            id: request.id,\n            user_id: request.user_id,\n            request_type: request.request_type,\n            status: request.status,\n            details: request.details,\n            approved_by: request.approved_by,\n            approved_at: request.approved_at,\n            rejected_by: request.rejected_by,\n            rejected_at: request.rejected_at,\n            cancelled_at: request.cancelled_at,\n            decision_comment: request.decision_comment,\n            created_at: request.created_at,\n            updated_at: request.updated_at,\n        }\n    }\n}\n","traces":[{"line":20,"address":[18245216],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[18245221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[18245252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[18245275],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[18245298],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[18245321],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[18245170,18245192,18244528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[18244630,18244573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[18243920],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":98,"address":[18243927],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[18243953],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[18243980],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[18243986],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[18243992],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[18244019],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[18244046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[18244070],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[18244096],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[18244120],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[18244144],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[18244177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[18244201],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":22},{"path":["/","home","marra","projects","timekeeper","backend","src","models","user.rs"],"content":"//! Models that represent users, authentication payloads, and role metadata.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Deserializer, Serialize, Serializer};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\nuse validator::Validate;\n\nuse crate::types::UserId;\nuse crate::validation::rules;\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow, ToSchema)]\n/// Database representation of an authenticated user account.\npub struct User {\n    /// Unique identifier for the user.\n    pub id: UserId,\n    /// Immutable username used for login.\n    pub username: String,\n    /// Argon2/Bcrypt/Scrypt hash of the user's password.\n    pub password_hash: String,\n    /// Human-readable full name.\n    pub full_name: String,\n    /// Email address for notifications and password reset.\n    pub email: String,\n    /// Role describing the user's privileges.\n    pub role: UserRole,\n    /// Flag promoting the user to the highest administrative tier.\n    pub is_system_admin: bool,\n    /// Shared secret for RFC6238 TOTP verification (base32 encoded).\n    pub mfa_secret: Option\u003cString\u003e,\n    /// Timestamp marking when the user completed MFA enrollment.\n    pub mfa_enabled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Timestamp marking when the password was last changed.\n    pub password_changed_at: DateTime\u003cUtc\u003e,\n    /// Creation timestamp for auditing.\n    pub created_at: DateTime\u003cUtc\u003e,\n    /// Last update timestamp for auditing.\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Clone, sqlx::Type, ToSchema, Default)]\n#[sqlx(type_name = \"TEXT\", rename_all = \"snake_case\")]\n/// Supported user roles stored in the database.\npub enum UserRole {\n    /// Standard employee role with limited permissions.\n    #[default]\n    Employee,\n    /// Administrator role with elevated permissions.\n    Admin,\n}\n\nimpl UserRole {\n    /// Returns the canonical snake_case representation of the role.\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            UserRole::Employee =\u003e \"employee\",\n            UserRole::Admin =\u003e \"admin\",\n        }\n    }\n}\n\nimpl Serialize for UserRole {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        serializer.serialize_str(self.as_str())\n    }\n}\n\nimpl\u003c'de\u003e Deserialize\u003c'de\u003e for UserRole {\n    fn deserialize\u003cD\u003e(deserializer: D) -\u003e Result\u003cSelf, D::Error\u003e\n    where\n        D: Deserializer\u003c'de\u003e,\n    {\n        let s = String::deserialize(deserializer)?;\n        match s.as_str() {\n            // primary canonical values (snake_case)\n            \"employee\" =\u003e Ok(UserRole::Employee),\n            \"admin\" =\u003e Ok(UserRole::Admin),\n            // tolerate common legacy casings\n            \"Employee\" | \"EMPLOYEE\" =\u003e Ok(UserRole::Employee),\n            \"Admin\" | \"ADMIN\" =\u003e Ok(UserRole::Admin),\n            other =\u003e Err(serde::de::Error::unknown_variant(\n                other,\n                \u0026[\"employee\", \"admin\"],\n            )),\n        }\n    }\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema, Validate)]\n/// Payload for creating a new user account.\npub struct CreateUser {\n    #[validate(\n        length(min = 1, max = 50),\n        custom(function = \"validate_username_format\")\n    )]\n    pub username: String,\n    #[validate(length(min = 8), custom(function = \"validate_password_format\"))]\n    pub password: String,\n    #[validate(length(min = 1, max = 100))]\n    pub full_name: String,\n    #[validate(email)]\n    pub email: String,\n    pub role: UserRole,\n    #[serde(default)]\n    pub is_system_admin: bool,\n}\n\nfn validate_username_format(username: \u0026str) -\u003e Result\u003c(), validator::ValidationError\u003e {\n    rules::validate_username(username)\n}\n\nfn validate_password_format(password: \u0026str) -\u003e Result\u003c(), validator::ValidationError\u003e {\n    rules::validate_password_strength(password)\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema, Validate)]\n/// Payload for updating portions of an existing user.\npub struct UpdateUser {\n    #[validate(length(min = 1, max = 100))]\n    pub full_name: Option\u003cString\u003e,\n    #[validate(email)]\n    pub email: Option\u003cString\u003e,\n    pub role: Option\u003cUserRole\u003e,\n    pub is_system_admin: Option\u003cbool\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema, Validate)]\n/// Payload for users updating their own profile.\npub struct UpdateProfile {\n    #[validate(length(min = 1, max = 100))]\n    pub full_name: Option\u003cString\u003e,\n    #[validate(email)]\n    pub email: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema, Validate)]\n/// Credentials submitted by a user attempting to authenticate.\npub struct LoginRequest {\n    #[validate(length(min = 1))]\n    pub username: String,\n    #[validate(length(min = 1))]\n    pub password: String,\n    /// Optional TOTP code required when MFA is enabled.\n    #[serde(default)]\n    pub totp_code: Option\u003cString\u003e,\n    /// Optional label to identify the client/device for long-lived tokens.\n    #[serde(default)]\n    pub device_label: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema, Validate)]\n/// Payload submitted when a user requests to change their password.\npub struct ChangePasswordRequest {\n    /// Existing password that will be verified before applying the change.\n    #[validate(length(min = 1))]\n    pub current_password: String,\n    /// Replacement password that will be stored if verification succeeds.\n    #[validate(length(min = 8), custom(function = \"validate_new_password\"))]\n    pub new_password: String,\n}\n\nfn validate_new_password(password: \u0026str) -\u003e Result\u003c(), validator::ValidationError\u003e {\n    rules::validate_password_strength(password)\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Authentication payload returned after a successful login.\npub struct LoginResponse {\n    pub user: UserResponse,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Response returned when initiating MFA setup.\npub struct MfaSetupResponse {\n    pub secret: String,\n    pub otpauth_url: String,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Request payload carrying a one-time MFA code.\npub struct MfaCodeRequest {\n    pub code: String,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Exposes MFA enrollment status for the current user.\npub struct MfaStatusResponse {\n    pub enabled: bool,\n    pub pending: bool,\n}\n\n#[derive(Debug, Serialize, Deserialize, ToSchema)]\n/// Public-facing representation of a user returned by the API.\npub struct UserResponse {\n    pub id: UserId,\n    pub username: String,\n    pub full_name: String,\n    pub email: String,\n    pub role: String,\n    pub is_system_admin: bool,\n    pub mfa_enabled: bool,\n}\n\nimpl From\u003cUser\u003e for UserResponse {\n    /// Converts the persistent user model into the API response DTO.\n    fn from(user: User) -\u003e Self {\n        let mfa_enabled = user.is_mfa_enabled();\n        UserResponse {\n            id: user.id,\n            username: user.username,\n            full_name: user.full_name,\n            email: user.email,\n            role: user.role.as_str().to_string(),\n            is_system_admin: user.is_system_admin,\n            mfa_enabled,\n        }\n    }\n}\n\nimpl User {\n    /// Constructs a new user with freshly generated identifiers.\n    pub fn new(\n        username: String,\n        password_hash: String,\n        full_name: String,\n        email: String,\n        role: UserRole,\n        is_system_admin: bool,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: UserId::new(),\n            username,\n            password_hash,\n            full_name,\n            email,\n            role,\n            is_system_admin,\n            mfa_secret: None,\n            mfa_enabled_at: None,\n            password_changed_at: now,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    /// Returns `true` when the user holds the `Admin` role.\n    pub fn is_admin(\u0026self) -\u003e bool {\n        matches!(self.role, UserRole::Admin)\n    }\n\n    /// Returns `true` when the user is flagged as a system administrator.\n    pub fn is_system_admin(\u0026self) -\u003e bool {\n        self.is_system_admin\n    }\n\n    /// Returns `true` when the user has completed MFA enrollment.\n    pub fn is_mfa_enabled(\u0026self) -\u003e bool {\n        self.mfa_secret.is_some() \u0026\u0026 self.mfa_enabled_at.is_some()\n    }\n\n    /// Returns `true` when setup has been started but not yet confirmed.\n    pub fn has_pending_mfa(\u0026self) -\u003e bool {\n        self.mfa_secret.is_some() \u0026\u0026 self.mfa_enabled_at.is_none()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::Value;\n\n    #[test]\n    fn user_role_serde_accepts_and_emits_snake_case() {\n        // Accept snake_case\n        let e: UserRole = serde_json::from_str(\"\\\"employee\\\"\").unwrap();\n        let a: UserRole = serde_json::from_str(\"\\\"admin\\\"\").unwrap();\n        assert!(matches!(e, UserRole::Employee));\n        assert!(matches!(a, UserRole::Admin));\n\n        // Tolerate legacy casings\n        let e2: UserRole = serde_json::from_str(\"\\\"Employee\\\"\").unwrap();\n        let a2: UserRole = serde_json::from_str(\"\\\"ADMIN\\\"\").unwrap();\n        assert!(matches!(e2, UserRole::Employee));\n        assert!(matches!(a2, UserRole::Admin));\n\n        // Emit snake_case\n        let se = serde_json::to_value(UserRole::Employee).unwrap();\n        let sa = serde_json::to_value(UserRole::Admin).unwrap();\n        assert_eq!(se, Value::String(\"employee\".into()));\n        assert_eq!(sa, Value::String(\"admin\".into()));\n    }\n\n    #[test]\n    fn user_response_role_is_snake_case_string() {\n        let user = User::new(\n            \"alice\".to_string(),\n            \"hash\".to_string(),\n            \"Alice Example\".to_string(),\n            \"alice@example.com\".to_string(),\n            UserRole::Admin,\n            true,\n        );\n        let resp: UserResponse = user.into();\n        assert_eq!(resp.role, \"admin\");\n        assert_eq!(resp.email, \"alice@example.com\");\n        assert!(resp.is_system_admin);\n        assert!(!resp.mfa_enabled);\n    }\n\n    #[test]\n    fn update_user_payload_supports_optional_fields() {\n        let update = UpdateUser {\n            full_name: Some(\"Alice Example\".into()),\n            email: Some(\"alice@example.com\".into()),\n            role: Some(UserRole::Admin),\n            is_system_admin: Some(true),\n        };\n        assert_eq!(update.full_name.as_deref(), Some(\"Alice Example\"));\n        assert_eq!(update.email.as_deref(), Some(\"alice@example.com\"));\n        assert!(matches!(update.role, Some(UserRole::Admin)));\n        assert_eq!(update.is_system_admin, Some(true));\n    }\n}\n","traces":[{"line":54,"address":[19474896],"length":1,"stats":{"Line":1},"fn_name":null},{"line":55,"address":[19474901],"length":1,"stats":{"Line":1},"fn_name":null},{"line":56,"address":[19474939],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[19474916],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[19787248,19787374],"length":1,"stats":{"Line":1},"fn_name":"serialize\u003cserde_json::value::ser::Serializer\u003e"},{"line":67,"address":[19787307,19787280,19787384],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[19787392,19788076,19788070],"length":1,"stats":{"Line":1},"fn_name":"deserialize\u003c\u0026mut serde_json::de::Deserializer\u003cserde_json::read::StrRead\u003e\u003e"},{"line":76,"address":[19787417],"length":1,"stats":{"Line":1},"fn_name":null},{"line":77,"address":[19787646,19787578],"length":1,"stats":{"Line":2},"fn_name":null},{"line":79,"address":[19787678,19787749],"length":1,"stats":{"Line":2},"fn_name":null},{"line":80,"address":[19787765,19787809,19787721],"length":1,"stats":{"Line":3},"fn_name":null},{"line":82,"address":[19787825,19787781],"length":1,"stats":{"Line":2},"fn_name":null},{"line":83,"address":[19787901],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[19788001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[19473920],"length":1,"stats":{"Line":0},"fn_name":"validate_username_format"},{"line":112,"address":[19473941],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[19473872],"length":1,"stats":{"Line":0},"fn_name":"validate_password_format"},{"line":116,"address":[19473893],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[19473824],"length":1,"stats":{"Line":0},"fn_name":"validate_new_password"},{"line":166,"address":[19473845],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[19473645,19473104],"length":1,"stats":{"Line":1},"fn_name":"from"},{"line":210,"address":[19473134,19473243],"length":1,"stats":{"Line":2},"fn_name":null},{"line":212,"address":[19473252],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[19473261],"length":1,"stats":{"Line":1},"fn_name":null},{"line":214,"address":[19473286],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[19473312],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[19473420,19473344],"length":1,"stats":{"Line":2},"fn_name":null},{"line":217,"address":[19473453],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[19474847,19474144,19474793],"length":1,"stats":{"Line":1},"fn_name":null},{"line":233,"address":[19474218],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[19474280],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[19474864],"length":1,"stats":{"Line":1},"fn_name":null},{"line":252,"address":[19474869],"length":1,"stats":{"Line":1},"fn_name":null},{"line":256,"address":[19474128],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[19474133],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[19473968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[19473981],"length":1,"stats":{"Line":1},"fn_name":null},{"line":266,"address":[19474048],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[19474061],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":30,"coverable":41},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","active_session.rs"],"content":"use chrono::{DateTime, Utc};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::models::active_session::ActiveSession;\nuse crate::types::UserId;\n\npub async fn create_active_session(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    refresh_token_id: \u0026str,\n    access_jti: \u0026str,\n    device_label: Option\u003c\u0026str\u003e,\n    expires_at: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cActiveSession, sqlx::Error\u003e {\n    let session_id = Uuid::new_v4().to_string();\n    let last_seen_at = Utc::now();\n\n    sqlx::query_as::\u003c_, ActiveSession\u003e(\n        r#\"\n        INSERT INTO active_sessions\n            (id, user_id, refresh_token_id, access_jti, device_label, expires_at, last_seen_at)\n        VALUES ($1, $2, $3, $4, $5, $6, $7)\n        RETURNING id, user_id, refresh_token_id, access_jti, device_label, created_at, last_seen_at, expires_at\n        \"#,\n    )\n    .bind(\u0026session_id)\n    .bind(user_id)\n    .bind(refresh_token_id)\n    .bind(access_jti)\n    .bind(device_label)\n    .bind(expires_at)\n    .bind(last_seen_at)\n    .fetch_one(pool)\n    .await\n}\n\npub async fn list_active_sessions_for_user(\n    pool: \u0026PgPool,\n    user_id: UserId,\n) -\u003e Result\u003cVec\u003cActiveSession\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, ActiveSession\u003e(\n        r#\"\n        SELECT id, user_id, refresh_token_id, access_jti, device_label, created_at, last_seen_at, expires_at\n        FROM active_sessions\n        WHERE user_id = $1\n        ORDER BY last_seen_at DESC NULLS LAST, created_at DESC, id DESC\n        \"#,\n    )\n    .bind(user_id)\n    .fetch_all(pool)\n    .await\n}\n\npub async fn find_active_session_by_id(\n    pool: \u0026PgPool,\n    session_id: \u0026str,\n) -\u003e Result\u003cOption\u003cActiveSession\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, ActiveSession\u003e(\n        r#\"\n        SELECT id, user_id, refresh_token_id, access_jti, device_label, created_at, last_seen_at, expires_at\n        FROM active_sessions\n        WHERE id = $1\n        \"#,\n    )\n    .bind(session_id)\n    .fetch_optional(pool)\n    .await\n}\n\npub async fn find_active_session_by_refresh_token_id(\n    pool: \u0026PgPool,\n    refresh_token_id: \u0026str,\n) -\u003e Result\u003cOption\u003cActiveSession\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, ActiveSession\u003e(\n        r#\"\n        SELECT id, user_id, refresh_token_id, access_jti, device_label, created_at, last_seen_at, expires_at\n        FROM active_sessions\n        WHERE refresh_token_id = $1\n        \"#,\n    )\n    .bind(refresh_token_id)\n    .fetch_optional(pool)\n    .await\n}\n\npub async fn find_active_session_by_access_jti(\n    pool: \u0026PgPool,\n    access_jti: \u0026str,\n) -\u003e Result\u003cOption\u003cActiveSession\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, ActiveSession\u003e(\n        r#\"\n        SELECT id, user_id, refresh_token_id, access_jti, device_label, created_at, last_seen_at, expires_at\n        FROM active_sessions\n        WHERE access_jti = $1\n        \"#,\n    )\n    .bind(access_jti)\n    .fetch_optional(pool)\n    .await\n}\n\npub async fn touch_active_session_by_access_jti(\n    pool: \u0026PgPool,\n    access_jti: \u0026str,\n    last_seen_at: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result = sqlx::query(\n        r#\"\n        UPDATE active_sessions\n        SET last_seen_at = $1\n        WHERE access_jti = $2\n        \"#,\n    )\n    .bind(last_seen_at)\n    .bind(access_jti)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected() \u003e 0)\n}\n\npub async fn update_active_session_tokens(\n    pool: \u0026PgPool,\n    current_refresh_token_id: \u0026str,\n    new_refresh_token_id: \u0026str,\n    new_access_jti: \u0026str,\n    last_seen_at: DateTime\u003cUtc\u003e,\n    expires_at: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result = sqlx::query(\n        r#\"\n        UPDATE active_sessions\n        SET refresh_token_id = $1,\n            access_jti = $2,\n            last_seen_at = $3,\n            expires_at = $4\n        WHERE refresh_token_id = $5\n        \"#,\n    )\n    .bind(new_refresh_token_id)\n    .bind(new_access_jti)\n    .bind(last_seen_at)\n    .bind(expires_at)\n    .bind(current_refresh_token_id)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected() \u003e 0)\n}\n\npub async fn delete_active_session_by_id(\n    pool: \u0026PgPool,\n    session_id: \u0026str,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM active_sessions WHERE id = $1\")\n        .bind(session_id)\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\npub async fn delete_active_session_by_access_jti(\n    pool: \u0026PgPool,\n    access_jti: \u0026str,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM active_sessions WHERE access_jti = $1\")\n        .bind(access_jti)\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\npub async fn delete_active_sessions_for_user(\n    pool: \u0026PgPool,\n    user_id: UserId,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM active_sessions WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\n#[allow(dead_code)]\npub async fn cleanup_expired_sessions(pool: \u0026PgPool) -\u003e Result\u003cu64, sqlx::Error\u003e {\n    let result = sqlx::query(\"DELETE FROM active_sessions WHERE expires_at \u003c= NOW()\")\n        .execute(pool)\n        .await?;\n    Ok(result.rows_affected())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn active_session_functions_exist() {\n        let _create_active_session = create_active_session;\n        let _list_active_sessions_for_user = list_active_sessions_for_user;\n        let _find_active_session_by_id = find_active_session_by_id;\n        let _find_active_session_by_refresh_token_id = find_active_session_by_refresh_token_id;\n        let _find_active_session_by_access_jti = find_active_session_by_access_jti;\n        let _touch_active_session_by_access_jti = touch_active_session_by_access_jti;\n        let _update_active_session_tokens = update_active_session_tokens;\n        let _delete_active_session_by_id = delete_active_session_by_id;\n        let _delete_active_session_by_access_jti = delete_active_session_by_access_jti;\n        let _delete_active_sessions_for_user = delete_active_sessions_for_user;\n        let _cleanup_expired_sessions = cleanup_expired_sessions;\n    }\n}\n","traces":[{"line":8,"address":[18164048],"length":1,"stats":{"Line":0},"fn_name":"create_active_session"},{"line":16,"address":[21773790,21773898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[21773921],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[21774059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[21774123],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[21774156],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[21774189],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[21774222],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[21774283],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[21774344],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[21774372],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[21773836,21774487,21774434,21774663,21774395],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[18164496],"length":1,"stats":{"Line":0},"fn_name":"list_active_sessions_for_user"},{"line":50,"address":[21778704],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[21778732],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[20998151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[18164240],"length":1,"stats":{"Line":0},"fn_name":"find_active_session_by_id"},{"line":66,"address":[21775966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[21775994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[20995783],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[18164752],"length":1,"stats":{"Line":0},"fn_name":"find_active_session_by_refresh_token_id"},{"line":82,"address":[21782622],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[21782650],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21782929,21782706,21782539,21782670,21782753],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[18164592],"length":1,"stats":{"Line":0},"fn_name":"find_active_session_by_access_jti"},{"line":98,"address":[21780126],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[21780154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[21001687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[18164640],"length":1,"stats":{"Line":0},"fn_name":"touch_active_session_by_access_jti"},{"line":115,"address":[21780830],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[21780847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[21780895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21003015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[21781460],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[18164336],"length":1,"stats":{"Line":0},"fn_name":"update_active_session_tokens"},{"line":140,"address":[21777499],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[21777536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[21777614],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[21777675],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[21777692],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[21777740],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[20997959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[21778327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[18164288],"length":1,"stats":{"Line":0},"fn_name":"delete_active_session_by_id"},{"line":154,"address":[21776905,21776485,21776964,21776690],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[21776610],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[21776658],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[20996823],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[21777104,21777109,21777028],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":161,"address":[18164704],"length":1,"stats":{"Line":0},"fn_name":"delete_active_session_by_access_jti"},{"line":165,"address":[21782196,21781717,21782137,21781922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[21781842],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[21781890],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[21003687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[21782341,21782260,21782336],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":172,"address":[18164544],"length":1,"stats":{"Line":0},"fn_name":"delete_active_sessions_for_user"},{"line":176,"address":[21779327,21779424,21779700,21779641,21779212],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[21779364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[21779392],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[21000439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[21779840,21779845,21779764],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":184,"address":[18164216,18164208],"length":1,"stats":{"Line":0},"fn_name":"cleanup_expired_sessions"},{"line":185,"address":[21775340,21775064,21775485,21775281,21774899,21775681],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[21775032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[21774957,21775135,21775052,21775329,21775446,21775088],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[21775581],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":66},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","attendance.rs"],"content":"//! Attendance repository.\n//!\n//! Provides CRUD operations for attendance records.\n//! This module re-exports the trait-based implementation from attendance_repository.\n\npub use crate::repositories::attendance_repository::{\n    AttendanceRepository, AttendanceRepositoryTrait,\n};\n\n// MockAttendanceRepositoryTrait is only available in test builds via #[cfg(test)]\n#[cfg(test)]\npub use crate::repositories::attendance_repository::MockAttendanceRepositoryTrait;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","attendance_repository.rs"],"content":"//! Attendance repository trait for dependency injection and testing.\n//!\n//! This module defines the AttendanceRepository trait which can be mocked\n//! using mockall for testing purposes.\n\nuse async_trait::async_trait;\nuse chrono::NaiveDate;\nuse sqlx::{PgPool, Postgres};\nuse sqlx::postgres::PgTransaction;\nuse sqlx::Row as _;\n\nuse crate::error::AppError;\nuse crate::models::attendance::Attendance;\nuse crate::types::{AttendanceId, UserId};\n\n/// Repository trait for Attendance operations.\n///\n/// This trait is designed to be mockable using mockall for testing.\n/// Use `MockAttendanceRepository` in tests to mock the behavior.\n#[cfg_attr(test, mockall::automock)]\n#[async_trait]\npub trait AttendanceRepositoryTrait: Send + Sync {\n    /// Find all attendance records\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e;\n\n    /// Find an attendance record by ID\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: AttendanceId) -\u003e Result\u003cAttendance, AppError\u003e;\n\n    /// Create a new attendance record\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026Attendance) -\u003e Result\u003cAttendance, AppError\u003e;\n\n    /// Update an existing attendance record\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026Attendance) -\u003e Result\u003cAttendance, AppError\u003e;\n\n    /// Delete an attendance record by ID\n    async fn delete(\u0026self, db: \u0026PgPool, id: AttendanceId) -\u003e Result\u003c(), AppError\u003e;\n\n    /// Count all attendance records\n    async fn count_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003ci64, AppError\u003e;\n\n    /// List attendance records with pagination\n    async fn list_paginated(\n        \u0026self,\n        db: \u0026PgPool,\n        limit: i64,\n        offset: i64,\n    ) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e;\n\n    /// Find attendance record by user and date\n    async fn find_by_user_and_date(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        date: NaiveDate,\n    ) -\u003e Result\u003cOption\u003cAttendance\u003e, AppError\u003e;\n\n    /// Find attendance record by ID optionally\n    async fn find_optional_by_id(\n        \u0026self,\n        db: \u0026PgPool,\n        id: AttendanceId,\n    ) -\u003e Result\u003cOption\u003cAttendance\u003e, AppError\u003e;\n\n    /// Find attendance records by user and date range\n    async fn find_by_user_and_range(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        from: NaiveDate,\n        to: NaiveDate,\n    ) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e;\n\n    /// Find attendance records by user with optional date range\n    async fn find_by_user_with_range_options(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n    ) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e;\n\n    /// Get summary statistics for a user in a date range\n    async fn get_summary_stats(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        from: NaiveDate,\n        to: NaiveDate,\n    ) -\u003e Result\u003c(f64, i64), AppError\u003e;\n}\n\n/// Concrete implementation of AttendanceRepositoryTrait\n#[derive(Debug, Default, Clone, Copy)]\npub struct AttendanceRepository;\n\nimpl AttendanceRepository {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl AttendanceRepositoryTrait for AttendanceRepository {\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"SELECT {} FROM attendance ORDER BY date DESC\",\n            SELECT_COLUMNS\n        );\n        let rows = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: AttendanceId) -\u003e Result\u003cAttendance, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"SELECT {} FROM attendance WHERE id = $1\",\n            SELECT_COLUMNS\n        );\n        let result = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(id)\n            .fetch_optional(db)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Attendance record not found\".into()))?;\n        Ok(result)\n    }\n\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026Attendance) -\u003e Result\u003cAttendance, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"INSERT INTO attendance (id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at) \\\n             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) \\\n             RETURNING {}\",\n            SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.user_id)\n            .bind(item.date)\n            .bind(item.clock_in_time)\n            .bind(item.clock_out_time)\n            .bind(item.status.db_value())\n            .bind(item.total_work_hours)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026Attendance) -\u003e Result\u003cAttendance, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"UPDATE attendance SET user_id = $2, date = $3, clock_in_time = $4, clock_out_time = $5, \\\n             status = $6, total_work_hours = $7, updated_at = $8 WHERE id = $1 \\\n             RETURNING {}\",\n            SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.user_id)\n            .bind(item.date)\n            .bind(item.clock_in_time)\n            .bind(item.clock_out_time)\n            .bind(item.status.db_value())\n            .bind(item.total_work_hours)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn delete(\u0026self, db: \u0026PgPool, id: AttendanceId) -\u003e Result\u003c(), AppError\u003e {\n        sqlx::query(\"DELETE FROM attendance WHERE id = $1\")\n            .bind(id)\n            .execute(db)\n            .await?;\n        Ok(())\n    }\n\n    async fn count_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003ci64, AppError\u003e {\n        let total = sqlx::query_scalar(\"SELECT COUNT(*) FROM attendance\")\n            .fetch_one(db)\n            .await?;\n        Ok(total)\n    }\n\n    async fn list_paginated(\n        \u0026self,\n        db: \u0026PgPool,\n        limit: i64,\n        offset: i64,\n    ) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"SELECT {} FROM attendance ORDER BY date DESC, user_id LIMIT $1 OFFSET $2\",\n            SELECT_COLUMNS\n        );\n        let rows = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(limit)\n            .bind(offset)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_user_and_date(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        date: NaiveDate,\n    ) -\u003e Result\u003cOption\u003cAttendance\u003e, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"SELECT {} FROM attendance WHERE user_id = $1 AND date = $2\",\n            SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(user_id)\n            .bind(date)\n            .fetch_optional(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn find_optional_by_id(\n        \u0026self,\n        db: \u0026PgPool,\n        id: AttendanceId,\n    ) -\u003e Result\u003cOption\u003cAttendance\u003e, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"SELECT {} FROM attendance WHERE id = $1\",\n            SELECT_COLUMNS\n        );\n        let result = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(id)\n            .fetch_optional(db)\n            .await?;\n        Ok(result)\n    }\n\n    async fn find_by_user_and_range(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        from: NaiveDate,\n        to: NaiveDate,\n    ) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"SELECT {} FROM attendance WHERE user_id = $1 AND date BETWEEN $2 AND $3 ORDER BY date DESC\",\n            SELECT_COLUMNS\n        );\n        let rows = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(user_id)\n            .bind(from)\n            .bind(to)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_user_with_range_options(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n    ) -\u003e Result\u003cVec\u003cAttendance\u003e, AppError\u003e {\n        use sqlx::{Postgres, QueryBuilder};\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let mut builder: QueryBuilder\u003cPostgres\u003e = QueryBuilder::new(format!(\n            \"SELECT {} FROM attendance WHERE user_id = \",\n            SELECT_COLUMNS\n        ));\n        builder.push_bind(user_id);\n\n        if let Some(f) = from {\n            builder.push(\" AND date \u003e= \").push_bind(f);\n        }\n        if let Some(t) = to {\n            builder.push(\" AND date \u003c= \").push_bind(t);\n        }\n        builder.push(\" ORDER BY date DESC\");\n\n        let rows = builder.build_query_as::\u003cAttendance\u003e().fetch_all(db).await?;\n        Ok(rows)\n    }\n\n    async fn get_summary_stats(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        from: NaiveDate,\n        to: NaiveDate,\n    ) -\u003e Result\u003c(f64, i64), AppError\u003e {\n        let row = sqlx::query(\n            \"SELECT COALESCE(SUM(total_work_hours), 0) as total_hours, COUNT(*) as total_days \\\n             FROM attendance \\\n             WHERE user_id = $1 AND date BETWEEN $2 AND $3 AND total_work_hours IS NOT NULL\",\n        )\n        .bind(user_id)\n        .bind(from)\n        .bind(to)\n        .fetch_one(db)\n        .await?;\n\n        let total_work_hours: f64 = row.try_get(\"total_hours\").unwrap_or(0.0);\n        let total_work_days: i64 = row.try_get(\"total_days\").unwrap_or(0);\n\n        Ok((total_work_hours, total_work_days))\n    }\n}\n\nimpl AttendanceRepository {\n    pub async fn delete_by_user_and_date(\n        \u0026self,\n        tx: \u0026mut PgTransaction\u003c'_\u003e,\n        user_id: UserId,\n        date: NaiveDate,\n    ) -\u003e Result\u003c(), AppError\u003e {\n        sqlx::query(\"DELETE FROM attendance WHERE user_id = $1 AND date = $2\")\n            .bind(user_id)\n            .bind(date)\n            .execute(tx.as_mut())\n            .await?;\n        Ok(())\n    }\n\n    pub async fn create_in_transaction(\n        \u0026self,\n        tx: \u0026mut PgTransaction\u003c'_\u003e,\n        item: \u0026Attendance,\n    ) -\u003e Result\u003cAttendance, AppError\u003e {\n        const SELECT_COLUMNS: \u0026str =\n            \"id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\";\n        let query = format!(\n            \"INSERT INTO attendance (id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at) \\\n             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) \\\n             RETURNING {}\",\n            SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, Attendance\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.user_id)\n            .bind(item.date)\n            .bind(item.clock_in_time)\n            .bind(item.clock_out_time)\n            .bind(item.status.db_value())\n            .bind(item.total_work_hours)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(tx.as_mut())\n            .await?;\n        Ok(row)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_mock_attendance_repository_can_be_created() {\n        let _mock = MockAttendanceRepositoryTrait::new();\n    }\n\n    #[test]\n    fn test_mock_attendance_repository_trait_bounds() {\n        fn check_send_sync\u003cT: Send + Sync\u003e() {}\n        check_send_sync::\u003cMockAttendanceRepositoryTrait\u003e();\n    }\n\n    #[test]\n    fn attendance_repository_new_creates_instance() {\n        let repo = AttendanceRepository::new();\n        let _repo = repo;\n    }\n}\n","traces":[{"line":104,"address":[20276215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[18913384,18913226],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[18913494,18913645,18913918,18913578,18913859,18914078],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[18913590],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[21084983],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[18914196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[18895917,18895855,18895965,18895683,18895648,18897602,18897634,18895762,18896357],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":120,"address":[18895878,18896007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[18896117,18896518,18896315,18896641,18897267,18896856,18897200,18897607,18897632,18896201],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[18896248],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[18896260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[18896808,18896342,18895789,18896303,18896388,18896630],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[18897177,18897235,18897648,18897662],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":129,"address":[18897449],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[18907571,18907801,18908798,18909654,18907849,18907536,18907751,18907658],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":135,"address":[18907891,18907762],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[18908071,18908965,18909088,18907997,18908738,18909303,18908430],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[18908083],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[18908135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[18908187],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[18908222],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[18908284],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[18908788,18908018,18908454,18908354,18908379],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[18908474],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[18908559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[18908621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[18908683],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[18908765,18908726,18907685,18908835,18909077,18909255],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[18909501],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[18910848,18911113,18912048,18911063,18910970,18912904,18910883,18911161],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":159,"address":[18911074,18911203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[18911309,18911383,18911742,18912338,18912553,18912215,18911988],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[18911395],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[18911447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[18911499],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[18911534],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[18911596],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[18911766,18911330,18911666,18911691,18912038],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[18911786],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[18911871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[18911933],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[18912505,18910997,18912085,18912327,18911976,18912015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[18912751],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[20276055],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[18910228,18910440,18910499,18910659,18910834,18909969,18910124],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[18910161],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[18910173],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[21083719],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[18910753],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[20276279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[18914632,18915055,18914843,18915445,18915114,18915274],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[18914788],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[21086439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[18915368],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[20275383],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[18898069,18898227],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[18898977,18898421,18898337,18898544,18898758,18898817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[18898449],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[18898477],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[18898489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[18898806,18898929,18898571,18898532,18898618,18897888],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[18899095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[20275662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[18902952,18902823],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[18903146,18903287,18903615,18903492,18903062,18903830],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[18903193],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[18903220],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[18903232],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[21092983],"length":1,"stats":{"Line":0},"fn_name":null},{"line":231,"address":[18904028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[18901293,18901245,18901685,18901011,18902563,18902535,18901090,18900976],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":241,"address":[18901335,18901206],"length":1,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[18901643,18902184,18901445,18901846,18901969,18901529],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[18901576],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[18901588],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[21092183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[18902382],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[20275766],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[18904558,18904716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[18904910,18905078,18905511,18905292,18904826,18905351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[18904957],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[18904984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":268,"address":[18905011],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[18905023],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[21093479],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[18905629],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[20275878],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[18906118,18906276],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[18906409],"length":1,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[18906489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[18906539,18906609],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[18906571,18906623],"length":1,"stats":{"Line":0},"fn_name":null},{"line":294,"address":[18906641,18906714],"length":1,"stats":{"Line":0},"fn_name":null},{"line":296,"address":[18906678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[18906886,18906728,18905936],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[18907368],"length":1,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[20275478],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[18899781],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[18899808],"length":1,"stats":{"Line":0},"fn_name":null},{"line":316,"address":[18899835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[18899847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[21091207],"length":1,"stats":{"Line":0},"fn_name":null},{"line":320,"address":[18900730,18900640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[18900758],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[18900836],"length":1,"stats":{"Line":0},"fn_name":null},{"line":328,"address":[20277728],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[18934368,18934622,18934833,18934246,18934685,18934001,18934104,18935013],"length":1,"stats":{"Line":0},"fn_name":null},{"line":335,"address":[18934141],"length":1,"stats":{"Line":0},"fn_name":null},{"line":336,"address":[18934168],"length":1,"stats":{"Line":0},"fn_name":null},{"line":337,"address":[18934069,18934254,18934415,18934200,18934188],"length":1,"stats":{"Line":0},"fn_name":null},{"line":338,"address":[21019719],"length":1,"stats":{"Line":0},"fn_name":null},{"line":339,"address":[18934924],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[20277680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":349,"address":[18931840,18931958],"length":1,"stats":{"Line":0},"fn_name":null},{"line":355,"address":[18932467,18933244,18932058,18933121,18932764,18932132,18932876,18933459],"length":1,"stats":{"Line":0},"fn_name":null},{"line":356,"address":[18932144],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[18932192],"length":1,"stats":{"Line":0},"fn_name":null},{"line":358,"address":[18932240],"length":1,"stats":{"Line":0},"fn_name":null},{"line":359,"address":[18932271],"length":1,"stats":{"Line":0},"fn_name":null},{"line":360,"address":[18932329],"length":1,"stats":{"Line":0},"fn_name":null},{"line":361,"address":[18932950,18932416,18932395,18932491,18932079],"length":1,"stats":{"Line":0},"fn_name":null},{"line":362,"address":[18932511],"length":1,"stats":{"Line":0},"fn_name":null},{"line":363,"address":[18932582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":364,"address":[18932640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":365,"address":[18932926,18932542,18932788,18932718,18932706],"length":1,"stats":{"Line":0},"fn_name":null},{"line":366,"address":[18932819,18932991,18933233,18933411,18932903,18931901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":367,"address":[18933657],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":127},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","audit_log.rs"],"content":"use chrono::{DateTime, Utc};\nuse sqlx::{PgPool, Postgres, QueryBuilder};\n\nuse crate::models::audit_log::AuditLog;\nuse crate::types::{AuditLogId, UserId};\n\n#[derive(Debug, Clone, Default)]\npub struct AuditLogFilters {\n    pub from: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub to: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub actor_id: Option\u003cUserId\u003e,\n    pub actor_type: Option\u003cString\u003e,\n    pub event_type: Option\u003cString\u003e,\n    pub target_type: Option\u003cString\u003e,\n    pub target_id: Option\u003cString\u003e,\n    pub result: Option\u003cString\u003e,\n}\n\npub async fn insert_audit_log(pool: \u0026PgPool, log: \u0026AuditLog) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\n        \"INSERT INTO audit_logs \\\n         (id, occurred_at, actor_id, actor_type, event_type, target_type, target_id, result, \\\n         error_code, metadata, ip, user_agent, request_id) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)\",\n    )\n    .bind(log.id.to_string())\n    .bind(log.occurred_at)\n    .bind(log.actor_id.as_ref().map(|id| id.to_string()))\n    .bind(\u0026log.actor_type)\n    .bind(\u0026log.event_type)\n    .bind(\u0026log.target_type)\n    .bind(\u0026log.target_id)\n    .bind(\u0026log.result)\n    .bind(\u0026log.error_code)\n    .bind(\u0026log.metadata)\n    .bind(\u0026log.ip)\n    .bind(\u0026log.user_agent)\n    .bind(\u0026log.request_id)\n    .execute(pool)\n    .await\n    .map(|_| ())\n}\n\npub async fn fetch_audit_log(\n    pool: \u0026PgPool,\n    id: AuditLogId,\n) -\u003e Result\u003cOption\u003cAuditLog\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, AuditLog\u003e(\n        \"SELECT id, occurred_at, actor_id, actor_type, event_type, target_type, target_id, result, \\\n         error_code, metadata, ip, user_agent, request_id \\\n         FROM audit_logs WHERE id = $1\",\n    )\n    .bind(id.to_string())\n    .fetch_optional(pool)\n    .await\n}\n\npub async fn list_audit_logs(\n    pool: \u0026PgPool,\n    filters: \u0026AuditLogFilters,\n    per_page: i64,\n    offset: i64,\n) -\u003e Result\u003c(Vec\u003cAuditLog\u003e, i64), sqlx::Error\u003e {\n    let items = query_audit_logs(pool, filters, Some((per_page, offset))).await?;\n\n    let mut count_builder: QueryBuilder\u003cPostgres\u003e =\n        QueryBuilder::new(\"SELECT COUNT(*) FROM audit_logs\");\n    let mut count_has_clause = false;\n    apply_audit_log_filters(\u0026mut count_builder, \u0026mut count_has_clause, filters);\n    let total = count_builder\n        .build_query_scalar::\u003ci64\u003e()\n        .fetch_one(pool)\n        .await?;\n\n    Ok((items, total))\n}\n\npub async fn export_audit_logs(\n    pool: \u0026PgPool,\n    filters: \u0026AuditLogFilters,\n) -\u003e Result\u003cVec\u003cAuditLog\u003e, sqlx::Error\u003e {\n    query_audit_logs(pool, filters, None).await\n}\n\npub async fn delete_audit_logs_before(\n    pool: \u0026PgPool,\n    cutoff: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cu64, sqlx::Error\u003e {\n    let result = sqlx::query(\"DELETE FROM audit_logs WHERE occurred_at \u003c $1\")\n        .bind(cutoff)\n        .execute(pool)\n        .await?;\n    Ok(result.rows_affected())\n}\n\nasync fn query_audit_logs(\n    pool: \u0026PgPool,\n    filters: \u0026AuditLogFilters,\n    pagination: Option\u003c(i64, i64)\u003e,\n) -\u003e Result\u003cVec\u003cAuditLog\u003e, sqlx::Error\u003e {\n    let mut builder: QueryBuilder\u003cPostgres\u003e = QueryBuilder::new(\n        \"SELECT id, occurred_at, actor_id, actor_type, event_type, target_type, target_id, result, \\\n         error_code, metadata, ip, user_agent, request_id FROM audit_logs\",\n    );\n    let mut has_clause = false;\n    apply_audit_log_filters(\u0026mut builder, \u0026mut has_clause, filters);\n    builder.push(\" ORDER BY occurred_at DESC, id DESC\");\n\n    if let Some((per_page, offset)) = pagination {\n        builder\n            .push(\" LIMIT \")\n            .push_bind(per_page)\n            .push(\" OFFSET \")\n            .push_bind(offset);\n    }\n\n    builder.build_query_as::\u003cAuditLog\u003e().fetch_all(pool).await\n}\n\nfn apply_audit_log_filters(\n    builder: \u0026mut QueryBuilder\u003c'_, Postgres\u003e,\n    has_clause: \u0026mut bool,\n    filters: \u0026AuditLogFilters,\n) {\n    if let Some(from) = filters.from.as_ref() {\n        push_clause(builder, has_clause);\n        builder.push(\"occurred_at \u003e= \").push_bind(from.to_owned());\n    }\n    if let Some(to) = filters.to.as_ref() {\n        push_clause(builder, has_clause);\n        builder.push(\"occurred_at \u003c= \").push_bind(to.to_owned());\n    }\n    if let Some(actor_id) = filters.actor_id.as_ref() {\n        push_clause(builder, has_clause);\n        builder.push(\"actor_id = \").push_bind(actor_id.to_string());\n    }\n    if let Some(actor_type) = filters.actor_type.as_ref() {\n        push_clause(builder, has_clause);\n        builder\n            .push(\"actor_type = \")\n            .push_bind(actor_type.to_string());\n    }\n    if let Some(event_type) = filters.event_type.as_ref() {\n        push_clause(builder, has_clause);\n        builder\n            .push(\"event_type = \")\n            .push_bind(event_type.to_string());\n    }\n    if let Some(target_type) = filters.target_type.as_ref() {\n        push_clause(builder, has_clause);\n        builder\n            .push(\"target_type = \")\n            .push_bind(target_type.to_string());\n    }\n    if let Some(target_id) = filters.target_id.as_ref() {\n        push_clause(builder, has_clause);\n        builder\n            .push(\"target_id = \")\n            .push_bind(target_id.to_string());\n    }\n    if let Some(result) = filters.result.as_ref() {\n        push_clause(builder, has_clause);\n        builder.push(\"result = \").push_bind(result.to_string());\n    }\n}\n\nfn push_clause(builder: \u0026mut QueryBuilder\u003c'_, Postgres\u003e, has_clause: \u0026mut bool) {\n    if *has_clause {\n        builder.push(\" AND \");\n    } else {\n        builder.push(\" WHERE \");\n        *has_clause = true;\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn audit_log_filters_default_all_none() {\n        let filters = AuditLogFilters::default();\n        assert!(filters.from.is_none());\n        assert!(filters.to.is_none());\n        assert!(filters.actor_id.is_none());\n        assert!(filters.actor_type.is_none());\n        assert!(filters.event_type.is_none());\n        assert!(filters.target_type.is_none());\n        assert!(filters.target_id.is_none());\n        assert!(filters.result.is_none());\n    }\n\n    #[test]\n    fn audit_log_filters_all_fields() {\n        let user_id = UserId::new();\n        let filters = AuditLogFilters {\n            from: Some(Utc::now()),\n            to: Some(Utc::now()),\n            actor_id: Some(user_id.clone()),\n            actor_type: Some(\"user\".to_string()),\n            event_type: Some(\"login\".to_string()),\n            target_type: Some(\"attendance\".to_string()),\n            target_id: Some(\"att123\".to_string()),\n            result: Some(\"success\".to_string()),\n        };\n        assert!(filters.from.is_some());\n        assert!(filters.to.is_some());\n        assert_eq!(filters.actor_id, Some(user_id));\n        assert_eq!(filters.actor_type, Some(\"user\".to_string()));\n        assert_eq!(filters.event_type, Some(\"login\".to_string()));\n        assert_eq!(filters.target_type, Some(\"attendance\".to_string()));\n        assert_eq!(filters.target_id, Some(\"att123\".to_string()));\n        assert_eq!(filters.result, Some(\"success\".to_string()));\n    }\n}\n","traces":[{"line":19,"address":[18406560,18406573],"length":1,"stats":{"Line":0},"fn_name":"insert_audit_log"},{"line":26,"address":[21638734,21637902,21637948,21637832,21637880],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[21637996,21638095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[21638103,21639120,21638122,21638055,21638212,21638706,21639136],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":29,"address":[21638232],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[21638311],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[21638347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[21638379],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[21638411],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[21638447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[21638479],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[21638514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[21638549],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[21638584],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[21638635],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[21638691,21637822,21638787,21638980,21638655],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[21639157,21639055,21639152],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":44,"address":[18406464],"length":1,"stats":{"Line":0},"fn_name":"fetch_audit_log"},{"line":53,"address":[21635292,21635455,21635155,21635203,21635222],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[21635328],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[20981239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[18406512],"length":1,"stats":{"Line":0},"fn_name":"list_audit_logs"},{"line":64,"address":[21635953,21635867,21636036,21636119,21636879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[21636602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[21636676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[21636687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[21637113,21637051,21636752,21636831,21637277],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[21636776],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[20981374],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[21637379],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[18406656],"length":1,"stats":{"Line":0},"fn_name":"export_audit_logs"},{"line":82,"address":[20984631],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[18408096],"length":1,"stats":{"Line":0},"fn_name":"delete_audit_logs_before"},{"line":89,"address":[21641426,21641147,21641036,21641367,21641574,21640921,21641770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21641084],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[21641112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[20990695],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[21641670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[18406592],"length":1,"stats":{"Line":0},"fn_name":"query_audit_logs"},{"line":105,"address":[21639426],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[21639443],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[21639501],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[21639528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[21639583,21639711],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[21639649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[21639704],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[21639359,21639779,21639900,21639620],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[18406688],"length":1,"stats":{"Line":0},"fn_name":"apply_audit_log_filters"},{"line":125,"address":[18406762],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[18406847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[18406860],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[18406927],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[18407015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[18407028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[18407095],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[18407183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[18407196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[18407263],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[18407345],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[18407386],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[18407426],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[18407512],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[18407553],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[18407593],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[18407679],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[18407720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[18407760],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[18407846],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[18407887],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[18407927],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[18408012],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[18408025],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[18406368],"length":1,"stats":{"Line":0},"fn_name":"push_clause"},{"line":168,"address":[18406428,18406392],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[18406435],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[18406402],"length":1,"stats":{"Line":0},"fn_name":null},{"line":172,"address":[18406425],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":77},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","auth.rs"],"content":"use chrono::{DateTime, Utc};\nuse sqlx::{FromRow, PgPool};\n\nuse crate::types::UserId;\nuse crate::{models::user::User, utils::jwt::RefreshToken};\n\n#[allow(dead_code)]\n#[derive(Debug, FromRow)]\n/// Represents a stored refresh token in the database.\npub struct StoredRefreshToken {\n    pub id: String,\n    pub user_id: UserId,\n    pub token_hash: String,\n    pub expires_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug)]\n/// Represents an active access token to be stored for revocation checks.\npub struct ActiveAccessToken\u003c'a\u003e {\n    pub jti: \u0026'a str,\n    pub user_id: UserId,\n    pub expires_at: DateTime\u003cUtc\u003e,\n    pub context: Option\u003c\u0026'a str\u003e,\n}\n\n/// Finds a user by their username.\npub async fn find_user_by_username(\n    pool: \u0026PgPool,\n    username: \u0026str,\n) -\u003e Result\u003cOption\u003cUser\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, User\u003e(\n        \"SELECT id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at FROM users WHERE username = $1\",\n    )\n    .bind(username)\n    .fetch_optional(pool)\n    .await\n}\n\n/// Finds a user by their ID.\npub async fn find_user_by_id(pool: \u0026PgPool, user_id: UserId) -\u003e Result\u003cOption\u003cUser\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, User\u003e(\n        \"SELECT id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at FROM users WHERE id = $1\",\n    )\n    .bind(user_id.to_string())\n    .fetch_optional(pool)\n    .await\n}\n\n/// Inserts a new refresh token into the database.\npub async fn insert_refresh_token(pool: \u0026PgPool, token: \u0026RefreshToken) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\n        \"INSERT INTO refresh_tokens (id, user_id, token_hash, expires_at) VALUES ($1, $2, $3, $4)\",\n    )\n    .bind(\u0026token.id)\n    .bind(token.user_id.to_string())\n    .bind(\u0026token.token_hash)\n    .bind(token.expires_at)\n    .execute(pool)\n    .await\n    .map(|_| ())\n}\n\n/// Deletes a specific refresh token by its ID.\npub async fn delete_refresh_token_by_id(pool: \u0026PgPool, token_id: \u0026str) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM refresh_tokens WHERE id = $1\")\n        .bind(token_id)\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\n/// Deletes all refresh tokens for a specific user.\npub async fn delete_refresh_tokens_for_user(\n    pool: \u0026PgPool,\n    user_id: UserId,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM refresh_tokens WHERE user_id = $1\")\n        .bind(user_id.to_string())\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\n/// Fetches a valid (non-expired) refresh token by its ID.\npub async fn fetch_valid_refresh_token(\n    pool: \u0026PgPool,\n    token_id: \u0026str,\n    now: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cOption\u003cStoredRefreshToken\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, StoredRefreshToken\u003e(\n        \"SELECT id, user_id, token_hash, expires_at FROM refresh_tokens \\\n         WHERE id = $1 AND expires_at \u003e $2\",\n    )\n    .bind(token_id)\n    .bind(now)\n    .fetch_optional(pool)\n    .await\n}\n\n/// Inserts an active access token into the database (for revocation tracking).\npub async fn insert_active_access_token(\n    pool: \u0026PgPool,\n    token: \u0026ActiveAccessToken\u003c'_\u003e,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\n        \"INSERT INTO active_access_tokens (jti, user_id, expires_at, context) \\\n         VALUES ($1, $2, $3, $4)\",\n    )\n    .bind(token.jti)\n    .bind(token.user_id.to_string())\n    .bind(token.expires_at)\n    .bind(token.context)\n    .execute(pool)\n    .await\n    .map(|_| ())\n}\n\n/// Checks if an access token exists (is active/valid) by its JTI.\npub async fn access_token_exists(pool: \u0026PgPool, jti: \u0026str) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    sqlx::query_scalar::\u003c_, bool\u003e(\n        \"SELECT EXISTS (SELECT 1 FROM active_access_tokens WHERE jti = $1 LIMIT 1)\",\n    )\n    .bind(jti)\n    .fetch_one(pool)\n    .await\n}\n\n/// Deletes a specific active access token by its JTI (revocation).\npub async fn delete_active_access_token_by_jti(\n    pool: \u0026PgPool,\n    jti: \u0026str,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM active_access_tokens WHERE jti = $1\")\n        .bind(jti)\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\n/// Deletes all active access tokens for a specific user (revocation).\npub async fn delete_active_access_tokens_for_user(\n    pool: \u0026PgPool,\n    user_id: UserId,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM active_access_tokens WHERE user_id = $1\")\n        .bind(user_id.to_string())\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\n/// Removes all expired access tokens from the database.\npub async fn cleanup_expired_access_tokens(pool: \u0026PgPool) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM active_access_tokens WHERE expires_at \u003c= NOW()\")\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\n/// Finds a user by their email address.\npub async fn find_user_by_email(pool: \u0026PgPool, email: \u0026str) -\u003e Result\u003cOption\u003cUser\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, User\u003e(\n        \"SELECT id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at FROM users WHERE email = $1\",\n    )\n    .bind(email)\n    .fetch_optional(pool)\n    .await\n}\n\n/// Updates a user's password hash.\npub async fn update_user_password(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    new_password_hash: \u0026str,\n    previous_password_hash: \u0026str,\n    history_limit: u32,\n) -\u003e Result\u003cUser, sqlx::Error\u003e {\n    if history_limit \u003e 0 {\n        let mut tx = pool.begin().await?;\n\n        sqlx::query(\n            \"INSERT INTO password_histories (id, user_id, password_hash, changed_at) \\\n             VALUES ($1, $2, $3, NOW())\",\n        )\n        .bind(uuid::Uuid::new_v4().to_string())\n        .bind(user_id.to_string())\n        .bind(previous_password_hash)\n        .execute(\u0026mut *tx)\n        .await?;\n\n        let history_limit = history_limit as i64;\n        sqlx::query(\n            \"DELETE FROM password_histories WHERE id IN (\\\n             SELECT id FROM password_histories WHERE user_id = $1 \\\n             ORDER BY changed_at DESC OFFSET $2)\",\n        )\n        .bind(user_id.to_string())\n        .bind(history_limit)\n        .execute(\u0026mut *tx)\n        .await?;\n\n        let user = sqlx::query_as::\u003c_, User\u003e(\n            \"UPDATE users SET password_hash = $1, password_changed_at = NOW(), updated_at = NOW() \\\n             WHERE id = $2 \\\n             RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n             mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\",\n        )\n        .bind(new_password_hash)\n        .bind(user_id)\n        .fetch_one(\u0026mut *tx)\n        .await?;\n\n        tx.commit().await?;\n        Ok(user)\n    } else {\n        sqlx::query_as::\u003c_, User\u003e(\n            \"UPDATE users SET password_hash = $1, password_changed_at = NOW(), updated_at = NOW() \\\n             WHERE id = $2 \\\n             RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n             mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\",\n        )\n        .bind(new_password_hash)\n        .bind(user_id)\n        .fetch_one(pool)\n        .await\n    }\n}\n\n/// Fetches recent password hashes for history enforcement.\npub async fn fetch_recent_password_hashes(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    limit: u32,\n) -\u003e Result\u003cVec\u003cString\u003e, sqlx::Error\u003e {\n    if limit == 0 {\n        return Ok(Vec::new());\n    }\n    sqlx::query_scalar::\u003c_, String\u003e(\n        \"SELECT password_hash FROM password_histories WHERE user_id = $1 \\\n         ORDER BY changed_at DESC LIMIT $2\",\n    )\n    .bind(user_id.to_string())\n    .bind(limit as i64)\n    .fetch_all(pool)\n    .await\n}\n\n/// Deletes all refresh tokens for a specific user (alias).\npub async fn delete_all_refresh_tokens_for_user(\n    pool: \u0026PgPool,\n    user_id: UserId,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\"DELETE FROM refresh_tokens WHERE user_id = $1\")\n        .bind(user_id.to_string())\n        .execute(pool)\n        .await\n        .map(|_| ())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[tokio::test]\n    async fn fetch_recent_password_hashes_returns_empty_for_zero_limit() {\n        let pool = sqlx::postgres::PgPoolOptions::new()\n            .max_connections(1)\n            .connect_lazy(\"postgres://127.0.0.1:1/timekeeper\")\n            .expect(\"create lazy pool\");\n\n        let result = fetch_recent_password_hashes(\u0026pool, UserId::new(), 0).await;\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), Vec::\u003cString\u003e::new());\n    }\n\n    #[test]\n    fn active_access_token_struct_has_fields() {\n        let jti = \"test-jti\";\n        let user_id = UserId::new();\n        let expires_at = chrono::Utc::now();\n        let context = Some(\"test-context\");\n\n        let token = ActiveAccessToken {\n            jti,\n            user_id: user_id.clone(),\n            expires_at,\n            context,\n        };\n\n        assert_eq!(token.jti, jti);\n        assert_eq!(token.user_id, user_id);\n        assert_eq!(token.expires_at, expires_at);\n        assert_eq!(token.context, context);\n    }\n\n    #[test]\n    fn active_access_token_struct_allows_none_context() {\n        let token = ActiveAccessToken {\n            jti: \"test-jti\",\n            user_id: UserId::new(),\n            expires_at: chrono::Utc::now(),\n            context: None,\n        };\n\n        assert!(token.context.is_none());\n    }\n\n    #[test]\n    fn stored_refresh_token_struct_derives_debug() {\n        let token = StoredRefreshToken {\n            id: \"test-id\".to_string(),\n            user_id: UserId::new(),\n            token_hash: \"hash\".to_string(),\n            expires_at: chrono::Utc::now(),\n        };\n\n        let debug_str = format!(\"{:?}\", token);\n        assert!(debug_str.contains(\"StoredRefreshToken\"));\n    }\n}\n","traces":[{"line":27,"address":[22835760],"length":1,"stats":{"Line":0},"fn_name":"find_user_by_username"},{"line":35,"address":[18184094],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[18184122],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[20983255],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[18174830,18175177,18174723,18174688,18175052],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":46,"address":[18174867,18174915,18174934,18175004,18175167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[18175040],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[20974343],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[22835629,22835616],"length":1,"stats":{"Line":0},"fn_name":"insert_refresh_token"},{"line":56,"address":[18177016],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[18177125,18177056,18176976,18177079,18177401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[18177173],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[18177256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[18177330],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[20981623],"length":1,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[18177792,18177728,18177797],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":66,"address":[18185470,18185264,18185641,18185299,18185428,18185995],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":67,"address":[18185602,18185817,18185397,18185876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[18185522],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[18185570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[18185590,18185626,18185672,18185865,18185455],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[18186016,18186021,18185940],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":75,"address":[22836032],"length":1,"stats":{"Line":0},"fn_name":"delete_refresh_tokens_for_user"},{"line":79,"address":[18189479,18189420,18188851,18189175,18189024,18188959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[18188919,18189215,18188967,18189032,18188986],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[18189096],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[18188909,18189274,18189468,18189199,18189163],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[18189600,18189605,18189543],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":87,"address":[22835808],"length":1,"stats":{"Line":0},"fn_name":"fetch_valid_refresh_token"},{"line":96,"address":[18184772],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[18184827],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[18184855],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[20987159],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[22835920],"length":1,"stats":{"Line":0},"fn_name":"insert_active_access_token"},{"line":111,"address":[18186264],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[18186224,18186330,18186376,18186652,18186311],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[18186424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[18186529],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[18186581],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[20988855],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[18187040,18186979,18187045],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":121,"address":[18176768,18176147,18176318,18176112,18176276,18176485],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":125,"address":[18176386],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[18176414],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[18176303,18176516,18176434,18176470,18176709],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[22836080],"length":1,"stats":{"Line":0},"fn_name":"delete_active_access_token_by_jti"},{"line":135,"address":[18190228,18189749,18189954,18190169],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[18189874],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[18189922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[18189942,18190217,18189978,18189807,18190024],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[18190368,18190292,18190373],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":143,"address":[22836176],"length":1,"stats":{"Line":0},"fn_name":"delete_active_access_tokens_for_user"},{"line":147,"address":[18191703,18191948,18191379,18192007,18191552,18191487],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[18191743,18191560,18191447,18191495,18191514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[18191624],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[20996455],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[18192128,18192071,18192133],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":155,"address":[22836000,22836008],"length":1,"stats":{"Line":0},"fn_name":"cleanup_expired_access_tokens"},{"line":156,"address":[18188586,18188312,18188527,18188147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[18188280],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[20990807],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[18188650,18188720,18188725],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":163,"address":[22835520,22835538],"length":1,"stats":{"Line":0},"fn_name":"find_user_by_email"},{"line":168,"address":[18175726],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[18175754],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[20978087],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[22835648],"length":1,"stats":{"Line":0},"fn_name":"update_user_password"},{"line":181,"address":[18178085],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[20981748],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[18179397,18179415,18179498,18180080,18179330],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[18179625,18180048,18179338,18179557,18179576],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[18179754,18179676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[18179762,18179782,18179711,18179836,18180013,18179346],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[20981770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[18180646],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[18181173,18180747,18180766,18180812,18180696],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[18180930,18180860],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[18181012,18180887,18180958,18181141,18180938],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[20981796],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[18181800],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[18181839],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[18181988,18182086,18181898,18181757,18181918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[20981822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":216,"address":[20981844],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[18183357],"length":1,"stats":{"Line":0},"fn_name":null},{"line":225,"address":[18178362],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[18178401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[18178468],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[18178491,18178238,18178539,18183802,18183565],"length":1,"stats":{"Line":0},"fn_name":null},{"line":233,"address":[22835952],"length":1,"stats":{"Line":1},"fn_name":"fetch_recent_password_hashes"},{"line":238,"address":[18187196],"length":1,"stats":{"Line":1},"fn_name":null},{"line":239,"address":[18187271,18187644],"length":1,"stats":{"Line":2},"fn_name":null},{"line":245,"address":[18187616,18187357,18187290,18187427,18187338],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[18187446],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[18187541],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[18188022,18187597,18187230,18187561,18187780],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[22836128],"length":1,"stats":{"Line":0},"fn_name":"delete_all_refresh_tokens_for_user"},{"line":256,"address":[18190823,18190607,18191127,18191068,18190499,18190672],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[18190615,18190863,18190680,18190567,18190634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[18190744],"length":1,"stats":{"Line":0},"fn_name":null},{"line":259,"address":[18190847,18190557,18190811,18190922,18191116],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[18191248,18191253,18191191],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"}],"covered":3,"coverable":102},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","break_record.rs"],"content":"//! Break record repository.\n//!\n//! Provides CRUD operations for break records.\n\n#![allow(dead_code)]\n\nuse crate::error::AppError;\nuse crate::models::break_record::BreakRecord;\nuse crate::repositories::repository::Repository;\nuse crate::types::{AttendanceId, BreakRecordId};\nuse sqlx::postgres::PgTransaction;\nuse sqlx::{PgPool, Row};\n\nconst TABLE_NAME: \u0026str = \"break_records\";\nconst SELECT_COLUMNS: \u0026str =\n    \"id, attendance_id, break_start_time, break_end_time, duration_minutes, created_at, updated_at\";\n\n#[derive(Debug, Default, Clone, Copy)]\npub struct BreakRecordRepository;\n\nimpl BreakRecordRepository {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    pub async fn find_by_attendance(\n        \u0026self,\n        db: \u0026PgPool,\n        attendance_id: AttendanceId,\n    ) -\u003e Result\u003cVec\u003cBreakRecord\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE attendance_id = $1 ORDER BY break_start_time ASC\",\n            SELECT_COLUMNS, TABLE_NAME\n        );\n        let rows = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .bind(attendance_id)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n    pub async fn find_by_attendance_ids(\n        \u0026self,\n        db: \u0026PgPool,\n        attendance_ids: \u0026[AttendanceId],\n    ) -\u003e Result\u003cVec\u003cBreakRecord\u003e, AppError\u003e {\n        if attendance_ids.is_empty() {\n            return Ok(Vec::new());\n        }\n\n        let ids: Vec\u003cString\u003e = attendance_ids.iter().map(|id| id.to_string()).collect();\n\n        let query = format!(\n            \"SELECT {} FROM {} WHERE attendance_id = ANY($1) ORDER BY attendance_id, break_start_time ASC\",\n            SELECT_COLUMNS, TABLE_NAME\n        );\n        let rows = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .bind(\u0026ids)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    pub async fn find_active_break(\n        \u0026self,\n        db: \u0026PgPool,\n        attendance_id: AttendanceId,\n    ) -\u003e Result\u003cOption\u003cBreakRecord\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE attendance_id = $1 AND break_end_time IS NULL ORDER BY break_start_time DESC LIMIT 1\",\n            SELECT_COLUMNS, TABLE_NAME\n        );\n        let row = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .bind(attendance_id)\n            .fetch_optional(db)\n            .await?;\n        Ok(row)\n    }\n\n    pub async fn get_total_duration(\n        \u0026self,\n        db: \u0026PgPool,\n        attendance_id: AttendanceId,\n    ) -\u003e Result\u003ci64, AppError\u003e {\n        let row = sqlx::query(\n            \"SELECT COALESCE(SUM(duration_minutes), 0) AS minutes FROM break_records WHERE attendance_id = $1 AND duration_minutes IS NOT NULL\",\n        )\n        .bind(attendance_id)\n        .fetch_one(db)\n        .await?;\n\n        let minutes: i64 = row.try_get(\"minutes\").unwrap_or(0);\n        Ok(minutes)\n    }\n\n    pub async fn create_in_transaction(\n        \u0026self,\n        tx: \u0026mut PgTransaction\u003c'_\u003e,\n        item: \u0026BreakRecord,\n    ) -\u003e Result\u003cBreakRecord, AppError\u003e {\n        let query = format!(\n            \"INSERT INTO {} (id, attendance_id, break_start_time, break_end_time, duration_minutes, created_at, updated_at) \\\n             VALUES ($1, $2, $3, $4, $5, $6, $7) \\\n             RETURNING {}\",\n            TABLE_NAME, SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.attendance_id)\n            .bind(item.break_start_time)\n            .bind(item.break_end_time)\n            .bind(item.duration_minutes)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(tx.as_mut())\n            .await?;\n        Ok(row)\n    }\n\n    fn base_select_query() -\u003e String {\n        format!(\"SELECT {} FROM {}\", SELECT_COLUMNS, TABLE_NAME)\n    }\n}\n\nimpl Repository\u003cBreakRecord\u003e for BreakRecordRepository {\n    const TABLE: \u0026'static str = TABLE_NAME;\n    type Id = BreakRecordId;\n\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cBreakRecord\u003e, AppError\u003e {\n        let query = format!(\n            \"{} ORDER BY break_start_time DESC\",\n            Self::base_select_query()\n        );\n        let rows = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: BreakRecordId) -\u003e Result\u003cBreakRecord, AppError\u003e {\n        let query = format!(\"{} WHERE id = $1\", Self::base_select_query());\n        let result = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .bind(id)\n            .fetch_optional(db)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Break record not found\".into()))?;\n        Ok(result)\n    }\n\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026BreakRecord) -\u003e Result\u003cBreakRecord, AppError\u003e {\n        let query = format!(\n            \"INSERT INTO {} (id, attendance_id, break_start_time, break_end_time, duration_minutes, created_at, updated_at) \\\n             VALUES ($1, $2, $3, $4, $5, $6, $7) \\\n             RETURNING {}\",\n            TABLE_NAME, SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.attendance_id)\n            .bind(item.break_start_time)\n            .bind(item.break_end_time)\n            .bind(item.duration_minutes)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026BreakRecord) -\u003e Result\u003cBreakRecord, AppError\u003e {\n        let query = format!(\n            \"UPDATE {} SET attendance_id = $2, break_start_time = $3, break_end_time = $4, \\\n             duration_minutes = $5, updated_at = $6 WHERE id = $1 \\\n             RETURNING {}\",\n            TABLE_NAME, SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, BreakRecord\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.attendance_id)\n            .bind(item.break_start_time)\n            .bind(item.break_end_time)\n            .bind(item.duration_minutes)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn delete(\u0026self, db: \u0026PgPool, id: BreakRecordId) -\u003e Result\u003c(), AppError\u003e {\n        let query = format!(\"DELETE FROM {} WHERE id = $1\", TABLE_NAME);\n        sqlx::query(\u0026query).bind(id).execute(db).await?;\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn break_record_select_columns_include_expected_fields() {\n        assert!(SELECT_COLUMNS.contains(\"break_start_time\"));\n        assert!(SELECT_COLUMNS.contains(\"duration_minutes\"));\n    }\n\n    #[test]\n    fn break_record_repository_new_creates_instance() {\n        let repo = BreakRecordRepository::new();\n        let _repo = repo;\n    }\n\n    #[test]\n    fn table_name_is_correct() {\n        assert_eq!(TABLE_NAME, \"break_records\");\n    }\n}\n","traces":[{"line":26,"address":[22143184],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[18769133,18769000],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[18769684,18769363,18769279,18769903,18769470,18769743],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[18769407],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[18769435],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[21007223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[18770021],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[22143328],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[18773683,18773578],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[18774257,18773724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[18773699,18773744,18775075,18775040],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":52,"address":[18773787,18773881],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[18774117,18774782,18774033,18774567,18774626,18774212],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[18774129],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[18774177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[18774734,18774200,18774239,18774615,18773619,18774425],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[18774897],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[22143136],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[18767661,18767528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[18767803,18767887,18768304,18768502,18767994,18768197],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[18767931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[18767959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[21006343],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[18768684],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[22143232],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[18770464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[18770492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[18770554,18770601,18770515,18770976,18770370,18770821],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[18771341,18771256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[18771364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[22143280],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[18771624,18771757],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[18772524,18772412,18772749,18772856,18771973,18773054,18771899],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[18771985],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[18772033],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[18772081],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[18772139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[18772197],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[18772230],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[18772288],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[18772366,18771920,18772436,18772354,18772574],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[21010519],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[18773236],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[22142960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[22142973],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[18781776,18781899,18781811,18781941,18782363],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":129,"address":[18781988],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[18781892],"length":1,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[18782759,18782320,18782173,18782257,18782599,18782540],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[18782285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[18782711,18781926,18782400,18782588,18782308,18782347],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[18782877],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[18775239,18775104,18775139,18775281,18775756],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":140,"address":[18775232,18775331],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[18775713,18776952,18775522,18776029,18775606,18776227,18776539,18776930,18776605,18775922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[18775650],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[18775678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[18776179,18775740,18775701,18775793,18775266,18776018],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[21103238,21103283],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[18776771],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[22144738,22144720],"length":1,"stats":{"Line":0},"fn_name":"create"},{"line":150,"address":[18777317,18777184],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[18777967,18777459,18778170,18778277,18777543,18778475],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[18777555],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[18777603],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[18777651],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[18777709],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[18777767],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[18777800],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[18777858],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[18777932],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[21100535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[18778657],"length":1,"stats":{"Line":0},"fn_name":null},{"line":169,"address":[22144834,22144816],"length":1,"stats":{"Line":0},"fn_name":"update"},{"line":170,"address":[18780309,18780176],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[18781409,18781104,18780901,18780451,18780535,18781211],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[18780547],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[18780595],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[18780643],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[18780701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[18780759],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[18780792],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[18780866],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[18780975,18781200,18780252,18780889,18781361,18780928],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[18781591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[18778848,18778883,18779002,18779044,18779428,18780041],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":189,"address":[18778968,18779086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[18779190,18779266,18779459,18779029],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[18779917],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":89},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","common.rs"],"content":"//! Shared repository utilities.\n\nuse sqlx::{Postgres, QueryBuilder};\n\n/// Appends WHERE or AND to the query builder depending on whether a clause has already been added.\npub fn push_clause(builder: \u0026mut QueryBuilder\u003c'_, Postgres\u003e, has_clause: \u0026mut bool) {\n    if *has_clause {\n        builder.push(\" AND \");\n    } else {\n        builder.push(\" WHERE \");\n        *has_clause = true;\n    }\n}\n","traces":[{"line":6,"address":[18167888],"length":1,"stats":{"Line":1},"fn_name":"push_clause"},{"line":7,"address":[18167948,18167912],"length":1,"stats":{"Line":2},"fn_name":null},{"line":8,"address":[18167955],"length":1,"stats":{"Line":1},"fn_name":null},{"line":10,"address":[18167922],"length":1,"stats":{"Line":1},"fn_name":null},{"line":11,"address":[18167945],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":5,"coverable":5},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","consent_log.rs"],"content":"use sqlx::PgPool;\n\nuse crate::models::consent_log::ConsentLog;\n\npub async fn insert_consent_log(pool: \u0026PgPool, log: \u0026ConsentLog) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\n        \"INSERT INTO consent_logs \\\n         (id, user_id, purpose, policy_version, consented_at, ip, user_agent, request_id) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\",\n    )\n    .bind(\u0026log.id)\n    .bind(\u0026log.user_id)\n    .bind(\u0026log.purpose)\n    .bind(\u0026log.policy_version)\n    .bind(log.consented_at)\n    .bind(\u0026log.ip)\n    .bind(\u0026log.user_agent)\n    .bind(\u0026log.request_id)\n    .execute(pool)\n    .await\n    .map(|_| ())\n}\n\npub async fn list_consent_logs_for_user(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n) -\u003e Result\u003cVec\u003cConsentLog\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, ConsentLog\u003e(\n        \"SELECT id, user_id, purpose, policy_version, consented_at, ip, user_agent, request_id, \\\n         created_at FROM consent_logs WHERE user_id = $1 ORDER BY consented_at DESC, id DESC\",\n    )\n    .bind(user_id)\n    .fetch_all(pool)\n    .await\n}\n\npub async fn delete_consent_logs_before(\n    pool: \u0026PgPool,\n    cutoff: chrono::DateTime\u003cchrono::Utc\u003e,\n) -\u003e Result\u003cu64, sqlx::Error\u003e {\n    let result = sqlx::query(\"DELETE FROM consent_logs WHERE consented_at \u003c $1\")\n        .bind(cutoff)\n        .execute(pool)\n        .await?;\n    Ok(result.rows_affected())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn consent_log_functions_exist() {\n        let _insert_consent_log = insert_consent_log;\n        let _list_consent_logs_for_user = list_consent_logs_for_user;\n        let _delete_consent_logs_before = delete_consent_logs_before;\n    }\n}\n","traces":[{"line":5,"address":[21390096,21390109],"length":1,"stats":{"Line":0},"fn_name":"insert_consent_log"},{"line":11,"address":[22227452],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[22227484],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[22227520],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[22227556],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[22227592],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[22227656],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[22227688],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[22227720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[22227771],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[22228068,22227390,22227827,22227874,22227791],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[22228208,22228213,22228143],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":24,"address":[21390176],"length":1,"stats":{"Line":0},"fn_name":"list_consent_logs_for_user"},{"line":32,"address":[22229486],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[22229514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[20994071],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[21390128],"length":1,"stats":{"Line":0},"fn_name":"delete_consent_logs_before"},{"line":41,"address":[22228345,22229194,22228571,22228850,22228998,22228791,22228460],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[22228508],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[22228536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[20993959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22229094],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":22},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","holiday.rs"],"content":"//! Holiday repository.\n//!\n//! Provides CRUD operations for holidays.\n//! This module re-exports the trait-based implementation from holiday_repository.\n\npub use crate::repositories::holiday_repository::{HolidayRepository, HolidayRepositoryTrait};\n\n#[cfg(test)]\npub use crate::repositories::holiday_repository::MockHolidayRepositoryTrait;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","holiday_exception.rs"],"content":"use chrono::NaiveDate;\nuse sqlx::PgPool;\n\nuse crate::models::holiday_exception::HolidayException;\nuse crate::types::{HolidayExceptionId, UserId};\n\n/// Inserts a new holiday exception into the database.\npub async fn insert_holiday_exception(\n    pool: \u0026PgPool,\n    exception: \u0026HolidayException,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\n        \"INSERT INTO holiday_exceptions \\\n            (id, user_id, exception_date, override, reason, created_by, created_at, updated_at) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\",\n    )\n    .bind(exception.id.to_string())\n    .bind(exception.user_id.to_string())\n    .bind(exception.exception_date)\n    .bind(exception.is_holiday_override)\n    .bind(\u0026exception.reason)\n    .bind(exception.created_by.to_string())\n    .bind(exception.created_at)\n    .bind(exception.updated_at)\n    .execute(pool)\n    .await\n    .map(|_| ())\n}\n\n/// Lists holiday exceptions for a user within a given date range.\npub async fn list_holiday_exceptions_for_user(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    from: Option\u003cNaiveDate\u003e,\n    to: Option\u003cNaiveDate\u003e,\n) -\u003e Result\u003cVec\u003cHolidayException\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, HolidayException\u003e(\n        r#\"\n        SELECT id, user_id, exception_date, override, reason, created_by, created_at, updated_at\n        FROM holiday_exceptions\n        WHERE user_id = $1\n          AND ($2::date IS NULL OR exception_date \u003e= $2)\n          AND ($3::date IS NULL OR exception_date \u003c= $3)\n        ORDER BY exception_date\n        \"#,\n    )\n    .bind(user_id.to_string())\n    .bind(from)\n    .bind(to)\n    .fetch_all(pool)\n    .await\n}\n\n/// Deletes a holiday exception by ID and User ID.\npub async fn delete_holiday_exception(\n    pool: \u0026PgPool,\n    id: HolidayExceptionId,\n    user_id: UserId,\n) -\u003e Result\u003cu64, sqlx::Error\u003e {\n    sqlx::query(\n        r#\"\n        DELETE FROM holiday_exceptions\n        WHERE id = $1 AND user_id = $2\n        \"#,\n    )\n    .bind(id.to_string())\n    .bind(user_id.to_string())\n    .execute(pool)\n    .await\n    .map(|res| res.rows_affected())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn holiday_exception_functions_exist() {\n        let _insert_holiday_exception = insert_holiday_exception;\n        let _list_holiday_exceptions_for_user = list_holiday_exceptions_for_user;\n        let _delete_holiday_exception = delete_holiday_exception;\n    }\n}\n","traces":[{"line":8,"address":[19783024],"length":1,"stats":{"Line":0},"fn_name":"insert_holiday_exception"},{"line":17,"address":[21550288,21550355,21551136,21550336,21550401],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[21550457,21550525,21551104,21550476],"length":1,"stats":{"Line":0},"fn_name":null},{"line":19,"address":[21550573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[21550639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[21550687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[21550599,21550707,21550726,21551076,21550775],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[21550823],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[21550928],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[21551002],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[20997047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[21551525,21551520,21551457],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":31,"address":[19783056],"length":1,"stats":{"Line":0},"fn_name":"list_holiday_exceptions_for_user"},{"line":47,"address":[21551749,21551886,21551816,21552102,21551797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[21551921],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[21551995],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[21552023],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[21003799],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[19782960],"length":1,"stats":{"Line":0},"fn_name":"delete_holiday_exception"},{"line":66,"address":[21549207,21549255,21549320,21549661,21549274],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[21549376,21549444,21549626,21549395],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[21549508],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[20996935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[21549982,21550048,21550057],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"}],"covered":0,"coverable":24},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","holiday_repository.rs"],"content":"//! Holiday repository trait for dependency injection and testing.\n//!\n//! This module defines the HolidayRepository trait which can be mocked\n//! using mockall for testing purposes.\n\nuse async_trait::async_trait;\nuse chrono::NaiveDate;\nuse sqlx::PgPool;\n\nuse crate::error::AppError;\nuse crate::models::holiday::{AdminHolidayKind, AdminHolidayListItem, Holiday};\nuse crate::types::HolidayId;\n\n/// Repository trait for Holiday operations.\n///\n/// This trait is designed to be mockable using mockall for testing.\n/// Use `MockHolidayRepository` in tests to mock the behavior.\n#[cfg_attr(test, mockall::automock)]\n#[async_trait]\npub trait HolidayRepositoryTrait: Send + Sync {\n    /// Find all holidays\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cHoliday\u003e, AppError\u003e;\n\n    /// Find a holiday by ID\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: HolidayId) -\u003e Result\u003cHoliday, AppError\u003e;\n\n    /// Create a new holiday\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026Holiday) -\u003e Result\u003cHoliday, AppError\u003e;\n\n    /// Update an existing holiday\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026Holiday) -\u003e Result\u003cHoliday, AppError\u003e;\n\n    /// Delete a holiday by ID\n    async fn delete(\u0026self, db: \u0026PgPool, id: HolidayId) -\u003e Result\u003c(), AppError\u003e;\n\n    /// Find holiday by date\n    async fn find_by_date(\u0026self, db: \u0026PgPool, date: NaiveDate) -\u003e Result\u003cOption\u003cHoliday\u003e, AppError\u003e;\n\n    /// Create a holiday with duplicate date checking\n    async fn create_unique(\u0026self, db: \u0026PgPool, item: \u0026Holiday) -\u003e Result\u003cHoliday, AppError\u003e;\n\n    /// List holidays for admin with pagination and filters\n    async fn list_paginated_admin(\n        \u0026self,\n        pool: \u0026PgPool,\n        kind: Option\u003cAdminHolidayKind\u003e,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n        per_page: i64,\n        offset: i64,\n    ) -\u003e Result\u003c(Vec\u003cAdminHolidayListItem\u003e, i64), AppError\u003e;\n}\n\n/// Concrete implementation of HolidayRepositoryTrait\n#[derive(Debug, Default, Clone, Copy)]\npub struct HolidayRepository;\n\nimpl HolidayRepository {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl HolidayRepositoryTrait for HolidayRepository {\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cHoliday\u003e, AppError\u003e {\n        let query = \"SELECT id, holiday_date, name, description, created_at, updated_at FROM holidays ORDER BY holiday_date ASC\";\n        let rows = sqlx::query_as::\u003c_, Holiday\u003e(query).fetch_all(db).await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: HolidayId) -\u003e Result\u003cHoliday, AppError\u003e {\n        let query = \"SELECT id, holiday_date, name, description, created_at, updated_at FROM holidays WHERE id = $1\";\n        let result = sqlx::query_as::\u003c_, Holiday\u003e(query)\n            .bind(id)\n            .fetch_optional(db)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Holiday not found\".into()))?;\n        Ok(result)\n    }\n\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026Holiday) -\u003e Result\u003cHoliday, AppError\u003e {\n        let query = \"INSERT INTO holidays (id, holiday_date, name, description, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6) RETURNING id, holiday_date, name, description, created_at, updated_at\";\n        let row = sqlx::query_as::\u003c_, Holiday\u003e(query)\n            .bind(item.id)\n            .bind(item.holiday_date)\n            .bind(\u0026item.name)\n            .bind(\u0026item.description)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026Holiday) -\u003e Result\u003cHoliday, AppError\u003e {\n        let query = \"UPDATE holidays SET holiday_date = $2, name = $3, description = $4, updated_at = $5 WHERE id = $1 RETURNING id, holiday_date, name, description, created_at, updated_at\";\n        let row = sqlx::query_as::\u003c_, Holiday\u003e(query)\n            .bind(item.id)\n            .bind(item.holiday_date)\n            .bind(\u0026item.name)\n            .bind(\u0026item.description)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn delete(\u0026self, db: \u0026PgPool, id: HolidayId) -\u003e Result\u003c(), AppError\u003e {\n        sqlx::query(\"DELETE FROM holidays WHERE id = $1\").bind(id).execute(db).await?;\n        Ok(())\n    }\n\n    async fn find_by_date(\u0026self, db: \u0026PgPool, date: NaiveDate) -\u003e Result\u003cOption\u003cHoliday\u003e, AppError\u003e {\n        let query = \"SELECT id, holiday_date, name, description, created_at, updated_at FROM holidays WHERE holiday_date = $1\";\n        let row = sqlx::query_as::\u003c_, Holiday\u003e(query)\n            .bind(date)\n            .fetch_optional(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn create_unique(\u0026self, db: \u0026PgPool, item: \u0026Holiday) -\u003e Result\u003cHoliday, AppError\u003e {\n        match self.create(db, item).await {\n            Ok(row) =\u003e Ok(row),\n            Err(AppError::InternalServerError(err)) =\u003e {\n                if let Some(sqlx_err) = err.downcast_ref::\u003csqlx::Error\u003e() {\n                    if let sqlx::Error::Database(db_err) = sqlx_err {\n                        if db_err.constraint() == Some(\"holidays_holiday_date_key\") {\n                            return Err(AppError::BadRequest(\n                                \"Holiday already exists for that date\".into(),\n                            ));\n                        }\n                    }\n                }\n                Err(AppError::InternalServerError(err))\n            }\n            Err(e) =\u003e Err(e),\n        }\n    }\n\n    async fn list_paginated_admin(\n        \u0026self,\n        pool: \u0026PgPool,\n        kind: Option\u003cAdminHolidayKind\u003e,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n        per_page: i64,\n        offset: i64,\n    ) -\u003e Result\u003c(Vec\u003cAdminHolidayListItem\u003e, i64), AppError\u003e {\n        use sqlx::{FromRow, Postgres, QueryBuilder};\n        use std::str::FromStr;\n        use chrono::DateTime;\n        use crate::repositories::common::push_clause;\n\n        const ADMIN_HOLIDAY_UNION_CTE: \u0026str = r#\"\n        WITH unioned AS (\n            SELECT id,\n                   'public'::text AS kind,\n                   holiday_date AS applies_from,\n                   holiday_date AS applies_to,\n                   holiday_date AS date,\n                   NULL::smallint AS weekday,\n                   NULL::date AS starts_on,\n                   NULL::date AS ends_on,\n                   name,\n                   description,\n                   NULL::text AS user_id,\n                   description AS reason,\n                   NULL::text AS created_by,\n                   created_at,\n                   NULL::boolean AS is_override\n            FROM holidays\n            UNION ALL\n            SELECT id,\n                   'weekly'::text AS kind,\n                   enforced_from AS applies_from,\n                   enforced_to AS applies_to,\n                   NULL::date AS date,\n                   weekday,\n                   starts_on,\n                   ends_on,\n                   NULL::text AS name,\n                   NULL::text AS description,\n                   NULL::text AS user_id,\n                   NULL::text AS reason,\n                   created_by,\n                   created_at,\n                   NULL::boolean AS is_override\n            FROM weekly_holidays\n            UNION ALL\n            SELECT id,\n                   'exception'::text AS kind,\n                   exception_date AS applies_from,\n                   exception_date AS applies_to,\n                   exception_date AS date,\n                   NULL::smallint AS weekday,\n                   NULL::date AS starts_on,\n                   NULL::date AS ends_on,\n                   NULL::text AS name,\n                   NULL::text AS description,\n                   user_id,\n                   reason,\n                   created_by,\n                   created_at,\n                   override AS is_override\n            FROM holiday_exceptions\n        )\n        \"#;\n\n        #[derive(Debug, FromRow)]\n        struct AdminHolidayRow {\n            id: String,\n            kind: String,\n            applies_from: NaiveDate,\n            applies_to: Option\u003cNaiveDate\u003e,\n            date: Option\u003cNaiveDate\u003e,\n            weekday: Option\u003ci16\u003e,\n            starts_on: Option\u003cNaiveDate\u003e,\n            ends_on: Option\u003cNaiveDate\u003e,\n            name: Option\u003cString\u003e,\n            description: Option\u003cString\u003e,\n            user_id: Option\u003cString\u003e,\n            reason: Option\u003cString\u003e,\n            created_by: Option\u003cString\u003e,\n            created_at: DateTime\u003cchrono::Utc\u003e,\n            is_override: Option\u003cbool\u003e,\n        }\n\n        impl TryFrom\u003cAdminHolidayRow\u003e for AdminHolidayListItem {\n            type Error = ();\n\n            fn try_from(row: AdminHolidayRow) -\u003e Result\u003cSelf, Self::Error\u003e {\n                let kind = AdminHolidayKind::from_str(\u0026row.kind)?;\n                Ok(Self {\n                    id: row.id,\n                    kind,\n                    applies_from: row.applies_from,\n                    applies_to: row.applies_to,\n                    date: row.date,\n                    weekday: row.weekday,\n                    starts_on: row.starts_on,\n                    ends_on: row.ends_on,\n                    name: row.name,\n                    description: row.description,\n                    user_id: row.user_id,\n                    reason: row.reason,\n                    created_by: row.created_by,\n                    created_at: row.created_at,\n                    is_override: row.is_override,\n                })\n            }\n        }\n\n        fn apply_holiday_filters(\n            builder: \u0026mut QueryBuilder\u003c'_, Postgres\u003e,\n            has_clause: \u0026mut bool,\n            kind: Option\u003cAdminHolidayKind\u003e,\n            from: Option\u003cNaiveDate\u003e,\n            to: Option\u003cNaiveDate\u003e,\n        ) {\n            if let Some(kind) = kind {\n                push_clause(builder, has_clause);\n                builder.push(\"kind = \").push_bind(kind.as_str());\n            }\n            if let Some(from) = from {\n                push_clause(builder, has_clause);\n                builder.push(\"applies_from \u003e= \").push_bind(from);\n            }\n            if let Some(to) = to {\n                push_clause(builder, has_clause);\n                builder.push(\"applies_from \u003c= \").push_bind(to);\n            }\n        }\n\n        let mut data_builder = QueryBuilder::new(format!(\n            \"{}\\nSELECT id, kind, applies_from, applies_to, date, weekday, starts_on, ends_on, name, description, user_id, reason, created_by, created_at, is_override FROM unioned\",\n            ADMIN_HOLIDAY_UNION_CTE\n        ));\n\n        let mut data_has_clause = false;\n        apply_holiday_filters(\u0026mut data_builder, \u0026mut data_has_clause, kind, from, to);\n\n        data_builder\n            .push(\" ORDER BY applies_from DESC, kind ASC, created_at DESC\")\n            .push(\" LIMIT \")\n            .push_bind(per_page)\n            .push(\" OFFSET \")\n            .push_bind(offset);\n\n        let mut count_builder = QueryBuilder::new(format!(\n            \"SELECT COUNT(*) FROM ({}\\nSELECT 1 FROM unioned\",\n            ADMIN_HOLIDAY_UNION_CTE\n        ));\n\n        let mut count_has_clause = false;\n        apply_holiday_filters(\u0026mut count_builder, \u0026mut count_has_clause, kind, from, to);\n        count_builder.push(\") AS counted\");\n\n        let rows = data_builder\n            .build_query_as::\u003cAdminHolidayRow\u003e()\n            .fetch_all(pool)\n            .await\n            .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n        let total = count_builder\n            .build_query_scalar::\u003ci64\u003e()\n            .fetch_one(pool)\n            .await\n            .map_err(|e| AppError::InternalServerError(e.into()))?;\n\n        let items = rows\n            .into_iter()\n            .map(AdminHolidayListItem::try_from)\n            .collect::\u003cResult\u003cVec\u003c_\u003e, _\u003e\u003e()\n            .map_err(|_| AppError::InternalServerError(anyhow::anyhow!(\"Invalid holiday kind\")))?;\n\n        Ok((items, total))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_mock_holiday_repository_can_be_created() {\n        let _mock = MockHolidayRepositoryTrait::new();\n    }\n\n    #[test]\n    fn test_mock_holiday_repository_trait_bounds() {\n        fn check_send_sync\u003cT: Send + Sync\u003e() {}\n        check_send_sync::\u003cMockHolidayRepositoryTrait\u003e();\n    }\n\n    #[test]\n    fn holiday_repository_new_creates_instance() {\n        let repo = HolidayRepository::new();\n        let _repo = repo;\n    }\n}\n","traces":[{"line":66,"address":[20274679],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[21603459],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[21078279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[21604486],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[20273751],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[21591091],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[21591882,21591450,21592402,21591557,21591328,21592478,21592090,21591775,21592623],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[21591490],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[21591502],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[21592042,21591871,21591630,21591239,21591545,21591584],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[21592640,21592446,21592379,21592654],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":79,"address":[21592566],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[21599737,21599828,21599780,21599550,21600904,21599488,21599644,21600251,21600894],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":83,"address":[21599523],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[21599748,21600209,21600534,21600899,21600427,21600738],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[21599875],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[21599927],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[21599962],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[21599994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[21600030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21600092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[21600154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[21077367],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[21600842],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[20274607],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[21602099],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[21602723,21602324,21602941,21603048,21603252,21603413],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[21602451],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[21602503],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[21602538],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[21602570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[21602606],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[21602668],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[21077591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[21603356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[20274519],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[21077479],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[21601969],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[21593265,21593093,21593909,21593045,21593919,21592892,21592798,21592736,21592985],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":115,"address":[21592771],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[21593222,21593442,21593549,21593013,21593753,21593914],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[21593155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21593167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[21080007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21593857],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[21593936,21595960,21594359,21594172,21593971,21595869,21594213,21595754,21595784,21594076,21595926],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":124,"address":[21594298,21594183,21594103,21594390],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[21594797],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[21594895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[21594919,21595142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[21595369,21595202],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[21595384],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[21595520],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[21595482],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[21595249],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[21594934],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[21595984,21596137,21596031,21599121,21596180,21597380,21598159,21596407,21596464],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":233,"address":[21416880,21417820],"length":1,"stats":{"Line":0},"fn_name":"try_from"},{"line":234,"address":[21416914,21416982],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[21417398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[21417086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[21417121],"length":1,"stats":{"Line":0},"fn_name":null},{"line":239,"address":[21417128],"length":1,"stats":{"Line":0},"fn_name":null},{"line":240,"address":[21417135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":241,"address":[21417142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":242,"address":[21417157],"length":1,"stats":{"Line":0},"fn_name":null},{"line":243,"address":[21417163],"length":1,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[21417169],"length":1,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[21417205],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[21417241],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[21417277],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[21417319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[21417364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[21417392],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[20274096],"length":1,"stats":{"Line":0},"fn_name":"apply_holiday_filters"},{"line":262,"address":[20274135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[20274177],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[20274187],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[20274233],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[20274279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":268,"address":[20274289],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[20274319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[20274364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[20274374],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[21596365,21596506],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[21596654],"length":1,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[21596671],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[21596741],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[21596816],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[21596871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[21596878],"length":1,"stats":{"Line":0},"fn_name":null},{"line":296,"address":[21597067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":297,"address":[21597084],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[21597160],"length":1,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[21597634,21597328,21597572,21597198,21597788,21597721,21598121],"length":1,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[21597267],"length":1,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[21085154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":304,"address":[21599422,21597698,21599408,21597756],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":306,"address":[21597930,21598331,21598547,21598480,21598069,21598393,21599150],"length":1,"stats":{"Line":0},"fn_name":null},{"line":308,"address":[21598008],"length":1,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[21085172],"length":1,"stats":{"Line":0},"fn_name":null},{"line":310,"address":[21599246,21599232,21598457,21598515],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":312,"address":[21598853,21598641,21599126,21598786],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[21598717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":316,"address":[21599312,21599326,21598821,21598763],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":318,"address":[21598963],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":106},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","leave_request.rs"],"content":"//! Leave request repository.\n//!\n//! Provides CRUD operations for leave requests.\n//! This module re-exports the trait-based implementation from leave_request_repository.\n\npub use crate::repositories::leave_request_repository::{\n    LeaveRequestRepository, LeaveRequestRepositoryTrait,\n};\n\n// MockLeaveRequestRepositoryTrait is only available in test builds via #[cfg(test)]\n#[cfg(test)]\npub use crate::repositories::leave_request_repository::MockLeaveRequestRepositoryTrait;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","leave_request_repository.rs"],"content":"//! Leave request repository trait for dependency injection and testing.\n//!\n//! This module defines the LeaveRequestRepository trait which can be mocked\n//! using mockall for testing purposes.\n\nuse async_trait::async_trait;\nuse chrono::{DateTime, NaiveDate, Utc};\nuse sqlx::PgPool;\n\nuse crate::error::AppError;\nuse crate::models::leave_request::LeaveRequest;\nuse crate::types::{LeaveRequestId, UserId};\n\n/// Repository trait for LeaveRequest operations.\n///\n/// This trait is designed to be mockable using mockall for testing.\n/// Use `MockLeaveRequestRepository` in tests to mock the behavior.\n#[cfg_attr(test, mockall::automock)]\n#[async_trait]\npub trait LeaveRequestRepositoryTrait: Send + Sync {\n    /// Find all leave requests\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cLeaveRequest\u003e, AppError\u003e;\n\n    /// Find a leave request by ID\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: LeaveRequestId) -\u003e Result\u003cLeaveRequest, AppError\u003e;\n\n    /// Create a new leave request\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026LeaveRequest) -\u003e Result\u003cLeaveRequest, AppError\u003e;\n\n    /// Update an existing leave request\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026LeaveRequest) -\u003e Result\u003cLeaveRequest, AppError\u003e;\n\n    /// Delete a leave request by ID\n    async fn delete(\u0026self, db: \u0026PgPool, id: LeaveRequestId) -\u003e Result\u003c(), AppError\u003e;\n\n    /// Find leave requests by user\n    async fn find_by_user(\u0026self, db: \u0026PgPool, user_id: UserId) -\u003e Result\u003cVec\u003cLeaveRequest\u003e, AppError\u003e;\n\n    /// Find leave requests by user and date range\n    async fn find_by_user_and_date_range(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e Result\u003cVec\u003cLeaveRequest\u003e, AppError\u003e;\n\n    /// Find leave request by ID for a specific user\n    async fn find_by_id_for_user(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        user_id: UserId,\n    ) -\u003e Result\u003cOption\u003cLeaveRequest\u003e, AppError\u003e;\n\n    /// Cancel a leave request\n    async fn cancel(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        user_id: UserId,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e;\n\n    /// Approve a leave request\n    async fn approve(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e;\n\n    /// Reject a leave request\n    async fn reject(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e;\n}\n\n/// Concrete implementation of LeaveRequestRepositoryTrait\n#[derive(Debug, Default, Clone, Copy)]\npub struct LeaveRequestRepository;\n\nimpl LeaveRequestRepository {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl LeaveRequestRepositoryTrait for LeaveRequestRepository {\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cLeaveRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} ORDER BY start_date DESC\",\n            \"id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"leave_requests\"\n        );\n        let rows = sqlx::query_as::\u003c_, LeaveRequest\u003e(\u0026query)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: LeaveRequestId) -\u003e Result\u003cLeaveRequest, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE id = $1\",\n            \"id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"leave_requests\"\n        );\n        let result = sqlx::query_as::\u003c_, LeaveRequest\u003e(\u0026query)\n            .bind(id)\n            .fetch_optional(db)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Leave request not found\".into()))?;\n        Ok(result)\n    }\n\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026LeaveRequest) -\u003e Result\u003cLeaveRequest, AppError\u003e {\n        use crate::models::leave_request::LeaveType;\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"INSERT INTO {} (id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, decision_comment, rejected_by, rejected_at, cancelled_at, created_at, updated_at) \\\n             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15) \\\n             RETURNING {}\",\n            \"leave_requests\",\n            \"id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\"\n        );\n        let row = sqlx::query_as::\u003c_, LeaveRequest\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.user_id)\n            .bind(match item.leave_type {\n                LeaveType::Annual =\u003e \"annual\",\n                LeaveType::Sick =\u003e \"sick\",\n                LeaveType::Personal =\u003e \"personal\",\n                LeaveType::Other =\u003e \"other\",\n            })\n            .bind(item.start_date)\n            .bind(item.end_date)\n            .bind(\u0026item.reason)\n            .bind(match item.status {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(item.approved_by)\n            .bind(item.approved_at)\n            .bind(\u0026item.decision_comment)\n            .bind(item.rejected_by)\n            .bind(item.rejected_at)\n            .bind(item.cancelled_at)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026LeaveRequest) -\u003e Result\u003cLeaveRequest, AppError\u003e {\n        use crate::models::leave_request::LeaveType;\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET user_id = $2, leave_type = $3, start_date = $4, end_date = $5, reason = $6, \\\n             status = $7, approved_by = $8, approved_at = $9, decision_comment = $10, rejected_by = $11, \\\n             rejected_at = $12, cancelled_at = $13, updated_at = $14 WHERE id = $1 \\\n             RETURNING {}\",\n            \"leave_requests\",\n            \"id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\"\n        );\n        let row = sqlx::query_as::\u003c_, LeaveRequest\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.user_id)\n            .bind(match item.leave_type {\n                LeaveType::Annual =\u003e \"annual\",\n                LeaveType::Sick =\u003e \"sick\",\n                LeaveType::Personal =\u003e \"personal\",\n                LeaveType::Other =\u003e \"other\",\n            })\n            .bind(item.start_date)\n            .bind(item.end_date)\n            .bind(\u0026item.reason)\n            .bind(match item.status {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(item.approved_by)\n            .bind(item.approved_at)\n            .bind(\u0026item.decision_comment)\n            .bind(item.rejected_by)\n            .bind(item.rejected_at)\n            .bind(item.cancelled_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn delete(\u0026self, db: \u0026PgPool, id: LeaveRequestId) -\u003e Result\u003c(), AppError\u003e {\n        let query = format!(\"DELETE FROM {} WHERE id = $1\", \"leave_requests\");\n        sqlx::query(\u0026query).bind(id).execute(db).await?;\n        Ok(())\n    }\n\n    async fn find_by_user(\u0026self, db: \u0026PgPool, user_id: UserId) -\u003e Result\u003cVec\u003cLeaveRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE user_id = $1 ORDER BY created_at DESC\",\n            \"id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"leave_requests\"\n        );\n        let rows = sqlx::query_as::\u003c_, LeaveRequest\u003e(\u0026query)\n            .bind(user_id)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_user_and_date_range(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e Result\u003cVec\u003cLeaveRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE user_id = $1 AND start_date \u003e= $2 AND end_date \u003c= $3 \\\n             ORDER BY start_date DESC\",\n            \"id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"leave_requests\"\n        );\n        let rows = sqlx::query_as::\u003c_, LeaveRequest\u003e(\u0026query)\n            .bind(user_id)\n            .bind(start_date)\n            .bind(end_date)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id_for_user(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        user_id: UserId,\n    ) -\u003e Result\u003cOption\u003cLeaveRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE id = $1 AND user_id = $2\",\n            \"id, user_id, leave_type, start_date, end_date, reason, status, \\\n             approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"leave_requests\"\n        );\n        let row = sqlx::query_as::\u003c_, LeaveRequest\u003e(\u0026query)\n            .bind(id)\n            .bind(user_id)\n            .fetch_optional(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn cancel(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        user_id: UserId,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET status = $1, cancelled_at = $2, updated_at = $3 \\\n             WHERE id = $4 AND user_id = $5 AND status = 'pending'\",\n            \"leave_requests\"\n        );\n        let result = sqlx::query(\u0026query)\n            .bind(match RequestStatus::Cancelled {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(timestamp)\n            .bind(timestamp)\n            .bind(id)\n            .bind(user_id)\n            .execute(db)\n            .await?;\n        Ok(result.rows_affected())\n    }\n\n    async fn approve(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET status = $1, approved_by = $2, approved_at = $3, decision_comment = $4, \\\n             updated_at = $5 WHERE id = $6 AND status = 'pending'\",\n            \"leave_requests\"\n        );\n        let result = sqlx::query(\u0026query)\n            .bind(match RequestStatus::Approved {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(approver_id)\n            .bind(timestamp)\n            .bind(comment)\n            .bind(timestamp)\n            .bind(id)\n            .execute(db)\n            .await?;\n        Ok(result.rows_affected())\n    }\n\n    async fn reject(\n        \u0026self,\n        db: \u0026PgPool,\n        id: LeaveRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET status = $1, rejected_by = $2, rejected_at = $3, decision_comment = $4, \\\n             updated_at = $5 WHERE id = $6 AND status = 'pending'\",\n            \"leave_requests\"\n        );\n        let result = sqlx::query(\u0026query)\n            .bind(match RequestStatus::Rejected {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(approver_id)\n            .bind(timestamp)\n            .bind(comment)\n            .bind(timestamp)\n            .bind(id)\n            .execute(db)\n            .await?;\n        Ok(result.rows_affected())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_mock_leave_request_repository_can_be_created() {\n        let _mock = MockLeaveRequestRepositoryTrait::new();\n    }\n\n    #[test]\n    fn test_mock_leave_request_repository_trait_bounds() {\n        fn check_send_sync\u003cT: Send + Sync\u003e() {}\n        check_send_sync::\u003cMockLeaveRequestRepositoryTrait\u003e();\n    }\n\n    #[test]\n    fn leave_request_repository_new_creates_instance() {\n        let repo = LeaveRequestRepository::new();\n        let _repo = repo;\n    }\n}\n","traces":[{"line":98,"address":[20525943],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[21980410,21980581],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[21981045,21980621,21980772,21980986,21980705,21981205],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[21980717],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[21981034,21980799,21980760,21980272,21980846,21981157],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[21981323],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[21963455,21963248,21963104,21963407,21963350,21964605,21963142,21963796,21964637],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":112,"address":[21963373,21963515],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[21964610,21963999,21963753,21964161,21964353,21964429,21963555,21964050,21964635,21963639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[21963686],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[21963698],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[21092535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[21092595,21092550],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[21964557],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[20525423],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[21970970,21971112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[21971236,21971503,21972794,21972636,21971152,21971800,21972390,21972687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[21971248],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[21971300],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[21971352,21971535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[21971389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[21971418],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[21971447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[21971476],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[21971547],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[21971582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[21971617],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[21971649,21971832],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[21971686],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[21971715],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[21971744],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[21971773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[21971844],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[21971912],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[21971974],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[21972010],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[21972078],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[21972143],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[21972211],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[21972273],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[21972335],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[21972643,21972378,21972746,21970887,21972417,21972464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[21972940],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[21977795,21976476,21976383,21978378,21976181,21976428,21978350,21976128,21976281],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":174,"address":[21976536,21976394],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[21976576,21976927,21977998,21978049,21977224,21976660,21977752,21978156],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[21976672],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[21976724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[21976776,21976959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[21976813],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[21976842],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[21976871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[21976900],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[21976971],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[21977006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[21977041],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[21977256,21977073],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[21977110],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[21977139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[21977168],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[21977197],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[21977268],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[21977336],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[21977398],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[21977434],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[21977502],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[21977567],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[21977635],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[21977697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[21977740,21978108,21976311,21978005,21977779,21977826],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[21978302],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[20525495],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[21973312,21973483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[21973599,21973168,21973523,21973798],"length":1,"stats":{"Line":0},"fn_name":null},{"line":216,"address":[21974255],"length":1,"stats":{"Line":0},"fn_name":null},{"line":219,"address":[20525015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":220,"address":[21965211,21965040],"length":1,"stats":{"Line":0},"fn_name":null},{"line":226,"address":[21965661,21965335,21965449,21965880,21965720,21965251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[21965382],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[21965394],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[21093639],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[21965998],"length":1,"stats":{"Line":0},"fn_name":null},{"line":233,"address":[20525206],"length":1,"stats":{"Line":0},"fn_name":null},{"line":240,"address":[21967977,21967806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[21968017,21968269,21968483,21968542,21968101,21968702],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[21968148],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[21968175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[21968202],"length":1,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[21968214],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[21968257,21968343,21968296,21968531,21967616,21968654],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[21968820],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[21966195,21966451,21966160,21967465,21966289,21966499,21966887,21967437],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":262,"address":[21966417,21966559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":268,"address":[21967138,21966844,21967245,21966737,21966599,21967087,21966683],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[21966730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[21966777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[21966789],"length":1,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[21966918,21967094,21967197,21966832,21966316,21966871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[21967389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[21969376,21969443,21970689,21970661,21969027,21969109,21970029,21968992],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":285,"address":[21969332,21969503],"length":1,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[21969619,21969543,21970200,21970259,21969832,21969710,21969986,21970423,21969771,21969667,21969879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[21969683,21969638],"length":1,"stats":{"Line":0},"fn_name":null},{"line":295,"address":[21969640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":297,"address":[21969764],"length":1,"stats":{"Line":0},"fn_name":null},{"line":298,"address":[21969825],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[21969872],"length":1,"stats":{"Line":0},"fn_name":null},{"line":300,"address":[21969919],"length":1,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[21969931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[21089959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[21970528],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[21980093,21978835,21978419,21978768,21978384,21980121,21978501,21979461],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":316,"address":[21978724,21978895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[21979418,21979691,21979632,21978935,21979250,21979149,21979102,21979011,21979855,21979311,21979059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[21979030,21979075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":324,"address":[21979032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":328,"address":[21979142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":329,"address":[21979203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":330,"address":[21979215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":331,"address":[21979304],"length":1,"stats":{"Line":0},"fn_name":null},{"line":332,"address":[21979351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[21979363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[21091351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":335,"address":[21979960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":338,"address":[20525599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":348,"address":[21974724,21974895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":353,"address":[21975102,21975149,21975311,21975418,21975011,21975250,21974935,21975691,21975059,21975855,21975632],"length":1,"stats":{"Line":0},"fn_name":null},{"line":354,"address":[21975075,21975030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[21975032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":360,"address":[21975142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":361,"address":[21975203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":362,"address":[21975215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":363,"address":[21975304],"length":1,"stats":{"Line":0},"fn_name":null},{"line":364,"address":[21975351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":365,"address":[21975363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":366,"address":[21090439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":367,"address":[21975960],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":137},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","mod.rs"],"content":"#![allow(unused_imports)]\n\npub mod active_session;\npub mod attendance;\npub mod audit_log;\npub mod auth;\npub mod break_record;\npub mod common;\npub mod consent_log;\npub mod holiday;\npub mod holiday_exception;\npub mod leave_request;\npub mod overtime_request;\npub mod password_reset;\npub mod permissions;\npub mod repository;\npub mod request;\npub mod subject_request;\npub mod transaction;\npub mod user;\npub mod user_repository;\npub mod attendance_repository;\npub mod leave_request_repository;\npub mod overtime_request_repository;\npub mod holiday_repository;\npub mod weekly_holiday;\n\npub use active_session::*;\npub use audit_log::*;\npub use auth::*;\npub use break_record::*;\npub use common::*;\npub use holiday::*;\npub use holiday_exception::*;\npub use password_reset::*;\npub use permissions::*;\npub use repository::*;\npub use subject_request::*;\npub use transaction::*;\npub use user::*;\npub use user_repository::*;\npub use weekly_holiday::*;\n\npub use attendance::{AttendanceRepository, AttendanceRepositoryTrait};\npub use leave_request::{LeaveRequestRepository, LeaveRequestRepositoryTrait};\npub use overtime_request::{OvertimeRequestRepository, OvertimeRequestRepositoryTrait};\npub use holiday::{HolidayRepository, HolidayRepositoryTrait};\npub use request::{RequestCreate, RequestListFilters, RequestRecord, RequestRepository, RequestStatusUpdate};\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","overtime_request.rs"],"content":"//! Overtime request repository.\n//!\n//! Provides CRUD operations for overtime requests.\n//! This module re-exports the trait-based implementation from overtime_request_repository.\n\npub use crate::repositories::overtime_request_repository::{\n    OvertimeRequestRepository, OvertimeRequestRepositoryTrait,\n};\n\n// MockOvertimeRequestRepositoryTrait is only available in test builds via #[cfg(test)]\n#[cfg(test)]\npub use crate::repositories::overtime_request_repository::MockOvertimeRequestRepositoryTrait;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","overtime_request_repository.rs"],"content":"//! Overtime request repository trait for dependency injection and testing.\n//!\n//! This module defines the OvertimeRequestRepository trait which can be mocked\n//! using mockall for testing purposes.\n\nuse async_trait::async_trait;\nuse chrono::{DateTime, NaiveDate, Utc};\nuse sqlx::PgPool;\n\nuse crate::error::AppError;\nuse crate::models::overtime_request::OvertimeRequest;\nuse crate::types::{OvertimeRequestId, UserId};\n\n/// Repository trait for OvertimeRequest operations.\n///\n/// This trait is designed to be mockable using mockall for testing.\n/// Use `MockOvertimeRequestRepository` in tests to mock the behavior.\n#[cfg_attr(test, mockall::automock)]\n#[async_trait]\npub trait OvertimeRequestRepositoryTrait: Send + Sync {\n    /// Find all overtime requests\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cOvertimeRequest\u003e, AppError\u003e;\n\n    /// Find an overtime request by ID\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: OvertimeRequestId) -\u003e Result\u003cOvertimeRequest, AppError\u003e;\n\n    /// Create a new overtime request\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026OvertimeRequest) -\u003e Result\u003cOvertimeRequest, AppError\u003e;\n\n    /// Update an existing overtime request\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026OvertimeRequest) -\u003e Result\u003cOvertimeRequest, AppError\u003e;\n\n    /// Delete an overtime request by ID\n    async fn delete(\u0026self, db: \u0026PgPool, id: OvertimeRequestId) -\u003e Result\u003c(), AppError\u003e;\n\n    /// Find overtime requests by user\n    async fn find_by_user(\u0026self, db: \u0026PgPool, user_id: UserId) -\u003e Result\u003cVec\u003cOvertimeRequest\u003e, AppError\u003e;\n\n    /// Find overtime requests by user and date range\n    async fn find_by_user_and_date_range(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e Result\u003cVec\u003cOvertimeRequest\u003e, AppError\u003e;\n\n    /// Find overtime request by ID for a specific user\n    async fn find_by_id_for_user(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        user_id: UserId,\n    ) -\u003e Result\u003cOption\u003cOvertimeRequest\u003e, AppError\u003e;\n\n    /// Cancel an overtime request\n    async fn cancel(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        user_id: UserId,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e;\n\n    /// Approve an overtime request\n    async fn approve(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e;\n\n    /// Reject an overtime request\n    async fn reject(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e;\n}\n\n/// Concrete implementation of OvertimeRequestRepositoryTrait\n#[derive(Debug, Default, Clone, Copy)]\npub struct OvertimeRequestRepository;\n\nimpl OvertimeRequestRepository {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl OvertimeRequestRepositoryTrait for OvertimeRequestRepository {\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cOvertimeRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} ORDER BY date DESC\",\n            \"id, user_id, date, planned_hours, reason, status, approved_by, \\\n             approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"overtime_requests\"\n        );\n        let rows = sqlx::query_as::\u003c_, OvertimeRequest\u003e(\u0026query)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: OvertimeRequestId) -\u003e Result\u003cOvertimeRequest, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE id = $1\",\n            \"id, user_id, date, planned_hours, reason, status, approved_by, \\\n             approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"overtime_requests\"\n        );\n        let result = sqlx::query_as::\u003c_, OvertimeRequest\u003e(\u0026query)\n            .bind(id)\n            .fetch_optional(db)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Overtime request not found\".into()))?;\n        Ok(result)\n    }\n\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026OvertimeRequest) -\u003e Result\u003cOvertimeRequest, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"INSERT INTO {} (id, user_id, date, planned_hours, reason, status, approved_by, approved_at, \\\n             decision_comment, rejected_by, rejected_at, cancelled_at, created_at, updated_at) \\\n             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) \\\n             RETURNING {}\",\n            \"overtime_requests\",\n            \"id, user_id, date, planned_hours, reason, status, approved_by, \\\n             approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\"\n        );\n        let row = sqlx::query_as::\u003c_, OvertimeRequest\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.user_id)\n            .bind(item.date)\n            .bind(item.planned_hours)\n            .bind(\u0026item.reason)\n            .bind(match item.status {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(item.approved_by)\n            .bind(item.approved_at)\n            .bind(\u0026item.decision_comment)\n            .bind(item.rejected_by)\n            .bind(item.rejected_at)\n            .bind(item.cancelled_at)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026OvertimeRequest) -\u003e Result\u003cOvertimeRequest, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET user_id = $2, date = $3, planned_hours = $4, reason = $5, status = $6, \\\n             approved_by = $7, approved_at = $8, decision_comment = $9, rejected_by = $10, rejected_at = $11, \\\n             cancelled_at = $12, updated_at = $13 WHERE id = $1 RETURNING {}\",\n            \"overtime_requests\",\n            \"id, user_id, date, planned_hours, reason, status, approved_by, \\\n             approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\"\n        );\n        let row = sqlx::query_as::\u003c_, OvertimeRequest\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.user_id)\n            .bind(item.date)\n            .bind(item.planned_hours)\n            .bind(\u0026item.reason)\n            .bind(match item.status {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(item.approved_by)\n            .bind(item.approved_at)\n            .bind(\u0026item.decision_comment)\n            .bind(item.rejected_by)\n            .bind(item.rejected_at)\n            .bind(item.cancelled_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn delete(\u0026self, db: \u0026PgPool, id: OvertimeRequestId) -\u003e Result\u003c(), AppError\u003e {\n        let query = format!(\"DELETE FROM {} WHERE id = $1\", \"overtime_requests\");\n        sqlx::query(\u0026query).bind(id).execute(db).await?;\n        Ok(())\n    }\n\n    async fn find_by_user(\u0026self, db: \u0026PgPool, user_id: UserId) -\u003e Result\u003cVec\u003cOvertimeRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE user_id = $1 ORDER BY created_at DESC\",\n            \"id, user_id, date, planned_hours, reason, status, approved_by, \\\n             approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"overtime_requests\"\n        );\n        let rows = sqlx::query_as::\u003c_, OvertimeRequest\u003e(\u0026query)\n            .bind(user_id)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_user_and_date_range(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e Result\u003cVec\u003cOvertimeRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE user_id = $1 AND date \u003e= $2 AND date \u003c= $3 \\\n             ORDER BY date DESC\",\n            \"id, user_id, date, planned_hours, reason, status, approved_by, \\\n             approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"overtime_requests\"\n        );\n        let rows = sqlx::query_as::\u003c_, OvertimeRequest\u003e(\u0026query)\n            .bind(user_id)\n            .bind(start_date)\n            .bind(end_date)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id_for_user(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        user_id: UserId,\n    ) -\u003e Result\u003cOption\u003cOvertimeRequest\u003e, AppError\u003e {\n        let query = format!(\n            \"SELECT {} FROM {} WHERE id = $1 AND user_id = $2\",\n            \"id, user_id, date, planned_hours, reason, status, approved_by, \\\n             approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at\",\n            \"overtime_requests\"\n        );\n        let row = sqlx::query_as::\u003c_, OvertimeRequest\u003e(\u0026query)\n            .bind(id)\n            .bind(user_id)\n            .fetch_optional(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn cancel(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        user_id: UserId,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET status = $1, cancelled_at = $2, updated_at = $3 \\\n             WHERE id = $4 AND user_id = $5 AND status = 'pending'\",\n            \"overtime_requests\"\n        );\n        let result = sqlx::query(\u0026query)\n            .bind(match RequestStatus::Cancelled {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(timestamp)\n            .bind(timestamp)\n            .bind(id)\n            .bind(user_id)\n            .execute(db)\n            .await?;\n        Ok(result.rows_affected())\n    }\n\n    async fn approve(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET status = $1, approved_by = $2, approved_at = $3, decision_comment = $4, \\\n             updated_at = $5 WHERE id = $6 AND status = 'pending'\",\n            \"overtime_requests\"\n        );\n        let result = sqlx::query(\u0026query)\n            .bind(match RequestStatus::Approved {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(approver_id)\n            .bind(timestamp)\n            .bind(comment)\n            .bind(timestamp)\n            .bind(id)\n            .execute(db)\n            .await?;\n        Ok(result.rows_affected())\n    }\n\n    async fn reject(\n        \u0026self,\n        db: \u0026PgPool,\n        id: OvertimeRequestId,\n        approver_id: UserId,\n        comment: \u0026str,\n        timestamp: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cu64, AppError\u003e {\n        use crate::models::request::RequestStatus;\n\n        let query = format!(\n            \"UPDATE {} SET status = $1, rejected_by = $2, rejected_at = $3, decision_comment = $4, \\\n             updated_at = $5 WHERE id = $6 AND status = 'pending'\",\n            \"overtime_requests\"\n        );\n        let result = sqlx::query(\u0026query)\n            .bind(match RequestStatus::Rejected {\n                RequestStatus::Pending =\u003e \"pending\",\n                RequestStatus::Approved =\u003e \"approved\",\n                RequestStatus::Rejected =\u003e \"rejected\",\n                RequestStatus::Cancelled =\u003e \"cancelled\",\n            })\n            .bind(approver_id)\n            .bind(timestamp)\n            .bind(comment)\n            .bind(timestamp)\n            .bind(id)\n            .execute(db)\n            .await?;\n        Ok(result.rows_affected())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_mock_overtime_request_repository_can_be_created() {\n        let _mock = MockOvertimeRequestRepositoryTrait::new();\n    }\n\n    #[test]\n    fn test_mock_overtime_request_repository_trait_bounds() {\n        fn check_send_sync\u003cT: Send + Sync\u003e() {}\n        check_send_sync::\u003cMockOvertimeRequestRepositoryTrait\u003e();\n    }\n\n    #[test]\n    fn overtime_request_repository_new_creates_instance() {\n        let repo = OvertimeRequestRepository::new();\n        let _repo = repo;\n    }\n}\n","traces":[{"line":98,"address":[21397367],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[22210202,22210373],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[22210413,22210564,22210778,22210497,22210837,22210997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[22210509],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[22210826,22210591,22210064,22210638,22210552,22210949],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[22211115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[22193312,22194845,22194813,22193350,22193615,22193558,22193663,22194004,22193456],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":112,"address":[22193723,22193581],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[22193763,22194369,22194207,22194843,22193847,22194561,22194637,22193961,22194818,22194258],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[22193894],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[22193906],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[21099943],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[21099958,21100003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[22194765],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[21396847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[22201302,22201160],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[22201797,22201426,22202390,22201342,22202633,22202684,22202791],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[22201438],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[22201490],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[22201542],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[22201577],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[22201614],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[22201829,22201646],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[22201683],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[22201712],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[22201741],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[22201770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[22201841],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[22201909],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[22201971],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[22202007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[22202075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[22202143],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[22202211],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[22202273],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[22202335],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[21096855],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[22202935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[21397151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[22206518,22206376],"length":1,"stats":{"Line":0},"fn_name":null},{"line":174,"address":[22207544,22207787,22207945,22207838,22206558,22207013,22206642],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[22206654],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[22206706],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[22206758],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[22206793],"length":1,"stats":{"Line":0},"fn_name":null},{"line":179,"address":[22206830],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[22206862,22207045],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[22206899],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[22206928],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[22206957],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[22206986],"length":1,"stats":{"Line":0},"fn_name":null},{"line":186,"address":[22207057],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[22207125],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[22207187],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[22207223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[22207291],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[22207359],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[22207427],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[22207489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[22206299,22207532,22207794,22207897,22207571,22207618],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[22208089],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[22203289,22204374,22203024,22203356,22203423,22203767,22203141,22204346,22203059],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":199,"address":[22203312,22203483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[21097015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[22204255],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[22195077,22195225,22195292,22195359,22195699,22196357,22196329,22194960,22194995],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":205,"address":[22195248,22195419],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[22195543,22195657,22195459,22195869,22196088,22195928],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[22195590],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[22195602],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[21101463],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[22196206],"length":1,"stats":{"Line":0},"fn_name":null},{"line":218,"address":[22198125,22197715,22197797,22199151,22198520,22197680,22198058,22199179],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":225,"address":[22198014,22198185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[22198750,22198225,22198477,22198691,22198309,22198910],"length":1,"stats":{"Line":0},"fn_name":null},{"line":233,"address":[22198356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[22198383],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[22198410],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[22198422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":237,"address":[21108391],"length":1,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[22199028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":241,"address":[22196497,22196368,22196403,22196707,22196659,22197645,22197673,22197095],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":247,"address":[22196625,22196767],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[22197052,22197295,22197346,22197453,22196807,22196945,22196891],"length":1,"stats":{"Line":0},"fn_name":null},{"line":254,"address":[22196938],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[22196985],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[22196997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[21105255],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[22197597],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[22200897,22199200,22200237,22199584,22199235,22200869,22199317,22199651],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":270,"address":[22199711,22199540],"length":1,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[22200194,22199751,22199875,22200408,22200087,22200631,22199827,22199918,22199979,22200467,22200040],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[22199891,22199846],"length":1,"stats":{"Line":0},"fn_name":null},{"line":280,"address":[22199848],"length":1,"stats":{"Line":0},"fn_name":null},{"line":282,"address":[22199972],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[22200033],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[22200080],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[22200127],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[22200139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[22200456,22200268,22200583,22199344,22200182,22200221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[22200736],"length":1,"stats":{"Line":0},"fn_name":null},{"line":291,"address":[21397247],"length":1,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[22208516,22208687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[22208803,22208851,22209210,22209424,22209483,22209647,22208894,22209103,22208727,22209042,22208941],"length":1,"stats":{"Line":0},"fn_name":null},{"line":307,"address":[22208822,22208867],"length":1,"stats":{"Line":0},"fn_name":null},{"line":309,"address":[22208824],"length":1,"stats":{"Line":0},"fn_name":null},{"line":313,"address":[22208934],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[22208995],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[22209007],"length":1,"stats":{"Line":0},"fn_name":null},{"line":316,"address":[22209096],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[22209143],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[22209155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":319,"address":[21098247],"length":1,"stats":{"Line":0},"fn_name":null},{"line":320,"address":[22209752],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[21397023],"length":1,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[22204895,22204724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":338,"address":[22204935,22205011,22205102,22205149,22205311,22205632,22205855,22205250,22205059,22205691,22205418],"length":1,"stats":{"Line":0},"fn_name":null},{"line":339,"address":[22205030,22205075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[22205032],"length":1,"stats":{"Line":0},"fn_name":null},{"line":345,"address":[22205142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[22205203],"length":1,"stats":{"Line":0},"fn_name":null},{"line":347,"address":[22205215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":348,"address":[22205304],"length":1,"stats":{"Line":0},"fn_name":null},{"line":349,"address":[22205351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":350,"address":[22205363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":351,"address":[21097175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":352,"address":[22205960],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":127},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","password_reset.rs"],"content":"use chrono::{Duration, Utc};\nuse sha2::{Digest, Sha256};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::error::AppError;\nuse crate::models::password_reset::PasswordReset;\nuse crate::types::UserId;\n\npub async fn create_password_reset(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    token: \u0026str,\n) -\u003e Result\u003cPasswordReset, AppError\u003e {\n    let reset_id = Uuid::new_v4().to_string();\n    let token_hash = hash_token(token);\n    let expires_at = Utc::now() + Duration::hours(1);\n\n    let record = sqlx::query_as::\u003c_, PasswordReset\u003e(\n        r#\"\n        INSERT INTO password_resets (id, user_id, token_hash, expires_at)\n        VALUES ($1, $2, $3, $4)\n        RETURNING id, user_id, token_hash, expires_at, created_at, used_at\n        \"#,\n    )\n    .bind(\u0026reset_id)\n    .bind(user_id)\n    .bind(\u0026token_hash)\n    .bind(expires_at)\n    .fetch_one(pool)\n    .await?;\n\n    Ok(record)\n}\n\npub async fn find_valid_reset_by_token(\n    pool: \u0026PgPool,\n    token: \u0026str,\n) -\u003e Result\u003cOption\u003cPasswordReset\u003e, AppError\u003e {\n    let token_hash = hash_token(token);\n    let now = Utc::now();\n\n    let record = sqlx::query_as::\u003c_, PasswordReset\u003e(\n        r#\"\n        SELECT id, user_id, token_hash, expires_at, created_at, used_at\n        FROM password_resets\n        WHERE token_hash = $1\n        AND expires_at \u003e $2\n        AND used_at IS NULL\n        \"#,\n    )\n    .bind(\u0026token_hash)\n    .bind(now)\n    .fetch_optional(pool)\n    .await?;\n\n    Ok(record)\n}\n\npub async fn mark_token_as_used(pool: \u0026PgPool, reset_id: \u0026str) -\u003e Result\u003c(), AppError\u003e {\n    let now = Utc::now();\n\n    sqlx::query(\n        r#\"\n        UPDATE password_resets\n        SET used_at = $1\n        WHERE id = $2\n        \"#,\n    )\n    .bind(now)\n    .bind(reset_id)\n    .execute(pool)\n    .await?;\n\n    Ok(())\n}\n\n#[allow(dead_code)]\npub async fn delete_expired_tokens(pool: \u0026PgPool) -\u003e Result\u003cu64, AppError\u003e {\n    let now = Utc::now();\n\n    let result = sqlx::query(\n        r#\"\n        DELETE FROM password_resets\n        WHERE expires_at \u003c $1\n        \"#,\n    )\n    .bind(now)\n    .execute(pool)\n    .await?;\n\n    Ok(result.rows_affected())\n}\n\nfn hash_token(token: \u0026str) -\u003e String {\n    let mut hasher = Sha256::new();\n    hasher.update(token.as_bytes());\n    format!(\"{:x}\", hasher.finalize())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_hash_token() {\n        let token = \"test-token-123\";\n        let hash1 = hash_token(token);\n        let hash2 = hash_token(token);\n        assert_eq!(hash1, hash2);\n        assert_ne!(hash_token(\"different-token\"), hash1);\n    }\n}\n","traces":[{"line":10,"address":[22465680],"length":1,"stats":{"Line":0},"fn_name":"create_password_reset"},{"line":15,"address":[21369854,21369959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[21369994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[21370113,21370047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[21370193],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[21370257],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[21370269],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[21370350],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[21370378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[20992343],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[21371178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[22465776],"length":1,"stats":{"Line":0},"fn_name":"find_valid_reset_by_token"},{"line":40,"address":[21372539],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[21372634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[21372724],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[21372799],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[21372827],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[21373371,21372850,21372889,21372936,21372577,21373194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[21373599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[22465650,22465632],"length":1,"stats":{"Line":0},"fn_name":"mark_token_as_used"},{"line":61,"address":[21368821],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[21369000],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[21369017],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[21369065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[20990119],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[21369612],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[21371808,21371424,21371459,21372410,21371581,21371539],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":80,"address":[21371523],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[21371702],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[21371730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21371566,21371792,21372027,21371753,21372144,21371839],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[21372285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[22465360],"length":1,"stats":{"Line":1},"fn_name":"hash_token"},{"line":96,"address":[22465403],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[22465423],"length":1,"stats":{"Line":1},"fn_name":null},{"line":98,"address":[22465441],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":4,"coverable":36},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","permissions.rs"],"content":"use sqlx::PgPool;\n\npub const AUDIT_LOG_READ: \u0026str = \"audit_log_read\";\n\npub async fn user_has_permission(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n    permission: \u0026str,\n) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let exists: Option\u003c(i32,)\u003e = sqlx::query_as(\n        \"SELECT 1 FROM user_permissions WHERE user_id = $1 AND permission_name = $2\",\n    )\n    .bind(user_id)\n    .bind(permission)\n    .fetch_optional(pool)\n    .await?;\n    Ok(exists.is_some())\n}\n","traces":[{"line":5,"address":[20597216],"length":1,"stats":{"Line":0},"fn_name":"user_has_permission"},{"line":13,"address":[22343440],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[22343473],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[22343501],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[20988967],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[22344079],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":6},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","repository.rs"],"content":"//! Repository trait and common functionality\n//!\n//! This module defines the standard repository trait that all repository modules\n//! should implement.\n\nuse crate::error::AppError;\nuse sqlx::PgPool;\n\n/// Standard repository trait for database operations\n///\n/// All repository modules should implement this trait to ensure consistent\n/// data access patterns.\n#[allow(async_fn_in_trait, dead_code)]\npub trait Repository\u003cT\u003e {\n    /// Target table name.\n    const TABLE: \u0026'static str;\n    /// Primary key type for the record.\n    type Id;\n    /// Find all records of type T\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cT\u003e, AppError\u003e;\n\n    /// Find a single record by ID\n    async fn find_by_id(\u0026self, db: \u0026PgPool, id: Self::Id) -\u003e Result\u003cT, AppError\u003e;\n\n    /// Create a new record\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026T) -\u003e Result\u003cT, AppError\u003e;\n\n    /// Update an existing record\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026T) -\u003e Result\u003cT, AppError\u003e;\n\n    /// Delete a record by ID\n    async fn delete(\u0026self, db: \u0026PgPool, id: Self::Id) -\u003e Result\u003c(), AppError\u003e;\n}\n\n#[cfg(test)]\nmod mock_tests {\n    use super::*;\n\n    /// Test that the Repository trait exists and can be referenced\n    #[test]\n    fn repository_trait_exists() {\n        // This test verifies that the Repository trait is properly defined\n        // and can be used as a trait bound\n        fn check_trait\u003cT, Id\u003e()\n        where\n            T: Repository\u003cId\u003e,\n        {\n        }\n        \n        // Trait exists - test passes\n        assert!(true);\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","request.rs"],"content":"use chrono::{DateTime, Utc};\nuse sqlx::{PgPool, Postgres, QueryBuilder};\nuse std::str::FromStr;\n\nuse crate::error::AppError;\nuse crate::models::{leave_request::LeaveRequest, overtime_request::OvertimeRequest};\nuse crate::repositories::{\n    common::push_clause, repository::Repository,\n    leave_request::{LeaveRequestRepository, LeaveRequestRepositoryTrait},\n    overtime_request::{OvertimeRequestRepository, OvertimeRequestRepositoryTrait},\n};\nuse crate::types::{LeaveRequestId, OvertimeRequestId, UserId};\n\n/// Filters for querying request lists.\n///\n/// Used to filter leave and overtime requests by status, user, and date range.\n#[derive(Debug, Clone, Default)]\npub struct RequestListFilters {\n    /// Filter by request status (e.g., \"pending\", \"approved\", \"rejected\")\n    pub status: Option\u003cString\u003e,\n    /// Filter by user ID\n    pub user_id: Option\u003cString\u003e,\n    /// Filter requests created from this timestamp (inclusive)\n    pub from: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Filter requests created until this timestamp (inclusive)\n    pub to: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n/// Result container for leave and overtime request lists.\n#[derive(Debug, Clone, Default)]\npub struct RequestListResult {\n    /// List of leave requests matching the query\n    pub leave_requests: Vec\u003cLeaveRequest\u003e,\n    /// List of overtime requests matching the query\n    pub overtime_requests: Vec\u003cOvertimeRequest\u003e,\n}\n\n/// Input type for creating a new request (leave or overtime).\npub enum RequestCreate\u003c'a\u003e {\n    /// Create a leave request\n    Leave(\u0026'a LeaveRequest),\n    /// Create an overtime request\n    Overtime(\u0026'a OvertimeRequest),\n}\n\n/// Output type representing a created request record.\npub enum RequestRecord {\n    /// A created leave request\n    Leave(LeaveRequest),\n    /// A created overtime request\n    Overtime(OvertimeRequest),\n}\n\n/// Update operation for changing request status (approve or reject).\npub enum RequestStatusUpdate\u003c'a\u003e {\n    /// Approve a request with approver details and comment\n    Approve {\n        /// ID of the user approving the request\n        approver_id: UserId,\n        /// Decision comment explaining the approval\n        comment: \u0026'a str,\n        /// Timestamp when the approval occurred\n        timestamp: DateTime\u003cUtc\u003e,\n    },\n    /// Reject a request with approver details and comment\n    Reject {\n        /// ID of the user rejecting the request\n        approver_id: UserId,\n        /// Decision comment explaining the rejection\n        comment: \u0026'a str,\n        /// Timestamp when the rejection occurred\n        timestamp: DateTime\u003cUtc\u003e,\n    },\n}\n\n/// Unified repository for managing leave and overtime requests.\n///\n/// Provides higher-level operations that delegate to specialized repositories\n/// while offering polymorphic handling of both request types.\n#[derive(Debug, Default, Clone, Copy)]\npub struct RequestRepository;\n\nimpl RequestRepository {\n    /// Creates a new instance of the request repository.\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Retrieves paginated lists of leave and/or overtime requests with optional filtering.\n    ///\n    /// # Arguments\n    ///\n    /// * `db` - Database connection pool\n    /// * `filters` - Filter criteria (status, user_id, date range)\n    /// * `per_page` - Maximum number of results per request type\n    /// * `offset` - Number of records to skip per request type\n    /// * `include_leave` - Whether to query leave requests\n    /// * `include_overtime` - Whether to query overtime requests\n    ///\n    /// # Returns\n    ///\n    /// A `RequestListResult` containing separate vectors for leave and overtime requests.\n    /// Empty vectors are returned for excluded request types.\n    ///\n    /// # Example\n    ///\n    /// ```ignore\n    /// let filters = RequestListFilters {\n    ///     status: Some(\"pending\".to_string()),\n    ///     ..Default::default()\n    /// };\n    /// let result = repo.get_requests_with_relations(\u0026pool, \u0026filters, 20, 0, true, true).await?;\n    /// ```\n    pub async fn get_requests_with_relations(\n        \u0026self,\n        db: \u0026PgPool,\n        filters: \u0026RequestListFilters,\n        per_page: i64,\n        offset: i64,\n        include_leave: bool,\n        include_overtime: bool,\n    ) -\u003e Result\u003cRequestListResult, AppError\u003e {\n        let leave_requests = if include_leave {\n            list_leave_requests(db, filters, per_page, offset).await?\n        } else {\n            Vec::new()\n        };\n\n        let overtime_requests = if include_overtime {\n            list_overtime_requests(db, filters, per_page, offset).await?\n        } else {\n            Vec::new()\n        };\n\n        Ok(RequestListResult {\n            leave_requests,\n            overtime_requests,\n        })\n    }\n\n    /// Retrieves all leave and overtime requests for a specific user.\n    ///\n    /// # Arguments\n    ///\n    /// * `db` - Database connection pool\n    /// * `user_id` - ID of the user whose requests to retrieve\n    ///\n    /// # Returns\n    ///\n    /// A `RequestListResult` containing all leave and overtime requests for the user,\n    /// ordered by creation date (descending).\n    pub async fn get_user_requests(\n        \u0026self,\n        db: \u0026PgPool,\n        user_id: UserId,\n    ) -\u003e Result\u003cRequestListResult, AppError\u003e {\n        let leave_repo = LeaveRequestRepository::new();\n        let overtime_repo = OvertimeRequestRepository::new();\n\n        let leave_requests = leave_repo.find_by_user(db, user_id).await?;\n        let overtime_requests = overtime_repo.find_by_user(db, user_id).await?;\n\n        Ok(RequestListResult {\n            leave_requests,\n            overtime_requests,\n        })\n    }\n\n    /// Creates a new leave or overtime request with automatic history tracking.\n    ///\n    /// # Arguments\n    ///\n    /// * `db` - Database connection pool\n    /// * `request` - The request to create (either leave or overtime)\n    ///\n    /// # Returns\n    ///\n    /// The created request record wrapped in the corresponding variant.\n    ///\n    /// # Errors\n    ///\n    /// Returns `AppError` if the database operation fails.\n    pub async fn create_request_with_history(\n        \u0026self,\n        db: \u0026PgPool,\n        request: RequestCreate\u003c'_\u003e,\n    ) -\u003e Result\u003cRequestRecord, AppError\u003e {\n        match request {\n            RequestCreate::Leave(item) =\u003e {\n                let repo = LeaveRequestRepository::new();\n                let saved = repo.create(db, item).await?;\n                Ok(RequestRecord::Leave(saved))\n            }\n            RequestCreate::Overtime(item) =\u003e {\n                let repo = OvertimeRequestRepository::new();\n                let saved = repo.create(db, item).await?;\n                Ok(RequestRecord::Overtime(saved))\n            }\n        }\n    }\n\n    /// Updates the status of a request (approve or reject).\n    ///\n    /// Attempts to parse the request ID as either a leave or overtime request ID\n    /// and applies the status update to the matching request type.\n    ///\n    /// # Arguments\n    ///\n    /// * `db` - Database connection pool\n    /// * `request_id` - String representation of the request ID (leave or overtime)\n    /// * `update` - The status update to apply (approve or reject with metadata)\n    ///\n    /// # Returns\n    ///\n    /// * `Ok(true)` - If the request was found and successfully updated\n    /// * `Ok(false)` - If the request ID was invalid or request not found\n    ///\n    /// # Errors\n    ///\n    /// Returns `AppError` if the database operation fails.\n    pub async fn update_request_status(\n        \u0026self,\n        db: \u0026PgPool,\n        request_id: \u0026str,\n        update: RequestStatusUpdate\u003c'_\u003e,\n    ) -\u003e Result\u003cbool, AppError\u003e {\n        let leave_repo = LeaveRequestRepository::new();\n        if let Ok(leave_request_id) = LeaveRequestId::from_str(request_id) {\n            let affected = match \u0026update {\n                RequestStatusUpdate::Approve {\n                    approver_id,\n                    comment,\n                    timestamp,\n                } =\u003e {\n                    leave_repo\n                        .approve(db, leave_request_id, *approver_id, comment, *timestamp)\n                        .await?\n                }\n                RequestStatusUpdate::Reject {\n                    approver_id,\n                    comment,\n                    timestamp,\n                } =\u003e {\n                    leave_repo\n                        .reject(db, leave_request_id, *approver_id, comment, *timestamp)\n                        .await?\n                }\n            };\n\n            if affected \u003e 0 {\n                return Ok(true);\n            }\n        }\n\n        let overtime_repo = OvertimeRequestRepository::new();\n        if let Ok(overtime_request_id) = OvertimeRequestId::from_str(request_id) {\n            let affected = match \u0026update {\n                RequestStatusUpdate::Approve {\n                    approver_id,\n                    comment,\n                    timestamp,\n                } =\u003e {\n                    overtime_repo\n                        .approve(db, overtime_request_id, *approver_id, comment, *timestamp)\n                        .await?\n                }\n                RequestStatusUpdate::Reject {\n                    approver_id,\n                    comment,\n                    timestamp,\n                } =\u003e {\n                    overtime_repo\n                        .reject(db, overtime_request_id, *approver_id, comment, *timestamp)\n                        .await?\n                }\n            };\n\n            if affected \u003e 0 {\n                return Ok(true);\n            }\n        }\n\n        Ok(false)\n    }\n}\n\nasync fn list_leave_requests(\n    db: \u0026PgPool,\n    filters: \u0026RequestListFilters,\n    per_page: i64,\n    offset: i64,\n) -\u003e Result\u003cVec\u003cLeaveRequest\u003e, AppError\u003e {\n    let mut builder: QueryBuilder\u003cPostgres\u003e = QueryBuilder::new(\n        \"SELECT id, user_id, leave_type, start_date, end_date, reason, status, approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at FROM leave_requests\",\n    );\n    apply_request_filters(\u0026mut builder, filters);\n    builder\n        .push(\" ORDER BY created_at DESC LIMIT \")\n        .push_bind(per_page)\n        .push(\" OFFSET \")\n        .push_bind(offset);\n    builder\n        .build_query_as::\u003cLeaveRequest\u003e()\n        .fetch_all(db)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))\n}\n\nasync fn list_overtime_requests(\n    db: \u0026PgPool,\n    filters: \u0026RequestListFilters,\n    per_page: i64,\n    offset: i64,\n) -\u003e Result\u003cVec\u003cOvertimeRequest\u003e, AppError\u003e {\n    let mut builder: QueryBuilder\u003cPostgres\u003e = QueryBuilder::new(\n        \"SELECT id, user_id, date, planned_hours, reason, status, approved_by, approved_at, rejected_by, rejected_at, cancelled_at, decision_comment, created_at, updated_at FROM overtime_requests\",\n    );\n    apply_request_filters(\u0026mut builder, filters);\n    builder\n        .push(\" ORDER BY created_at DESC LIMIT \")\n        .push_bind(per_page)\n        .push(\" OFFSET \")\n        .push_bind(offset);\n    builder\n        .build_query_as::\u003cOvertimeRequest\u003e()\n        .fetch_all(db)\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))\n}\n\nfn apply_request_filters\u003c'a\u003e(\n    builder: \u0026mut QueryBuilder\u003c'a, Postgres\u003e,\n    filters: \u0026'a RequestListFilters,\n) {\n    let mut has_clause = false;\n    if let Some(ref uid) = filters.user_id {\n        push_clause(builder, \u0026mut has_clause);\n        builder.push(\"user_id = \").push_bind(uid);\n    }\n    if let Some(ref status) = filters.status {\n        push_clause(builder, \u0026mut has_clause);\n        builder.push(\"status = \").push_bind(status);\n    }\n    if let Some(from) = filters.from.as_ref() {\n        push_clause(builder, \u0026mut has_clause);\n        builder.push(\"created_at \u003e= \").push_bind(*from);\n    }\n    if let Some(to) = filters.to.as_ref() {\n        push_clause(builder, \u0026mut has_clause);\n        builder.push(\"created_at \u003c= \").push_bind(*to);\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::{Duration, Utc};\n    use sqlx::{postgres::Postgres, QueryBuilder};\n\n    #[test]\n    fn apply_request_filters_without_filters_is_noop() {\n        let mut builder = QueryBuilder::\u003cPostgres\u003e::new(\"SELECT 1\");\n        let filters = RequestListFilters::default();\n        apply_request_filters(\u0026mut builder, \u0026filters);\n    }\n\n    #[test]\n    fn apply_request_filters_with_all_fields_appends_clauses() {\n        let mut builder = QueryBuilder::\u003cPostgres\u003e::new(\"SELECT 1\");\n        let now = Utc::now();\n        let filters = RequestListFilters {\n            user_id: Some(\"user-id\".to_string()),\n            status: Some(\"pending\".to_string()),\n            from: Some(now - Duration::days(1)),\n            to: Some(now),\n        };\n        apply_request_filters(\u0026mut builder, \u0026filters);\n    }\n}\n","traces":[{"line":114,"address":[21538960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[21661859,21662556],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[21007647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":126,"address":[21662013,21661922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[21662020,21663450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[21007662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[21662569,21662656],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[21662747],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[21662663],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[21662699],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[21538768],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[21654971],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[21655074],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[20998271],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[20998286],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[21656318],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[21656282],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[21538912],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[21660217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[21660328],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[21660349],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[21660675,21660263,21660421,21661217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[21661089],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[21660297],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[21660318],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[21660540,21661701,21660284,21661233],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[21661644],"length":1,"stats":{"Line":0},"fn_name":null},{"line":221,"address":[21538816],"length":1,"stats":{"Line":0},"fn_name":null},{"line":227,"address":[21656630],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[21656804,21656872],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[21656904],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[21657154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[21657861,21657967,21657240,21657746,21657184,21657372,21657700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[21657194,21657256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":237,"address":[21657732,21657394,21657548,21657829,21657325,21656670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":239,"address":[21656950],"length":1,"stats":{"Line":0},"fn_name":null},{"line":244,"address":[21657051,21658379,21657470,21658218,21659183,21656995,21658264],"length":1,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[21657005,21657067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":246,"address":[21658250,21656691,21658347,21657435,21658069,21657492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[21657947],"length":1,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[21658473],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[21656854],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[21658506,21658589],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[21658621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[21658856],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[21659391,21658886,21659506,21659345,21658942,21659612,21659050],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[21658958,21658896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[21002454],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[21658676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[21658762,21658706,21659774,21659820,21660051,21659935,21659139],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[21658778,21658716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[21002472],"length":1,"stats":{"Line":0},"fn_name":null},{"line":278,"address":[21659592],"length":1,"stats":{"Line":0},"fn_name":null},{"line":279,"address":[21660026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[21658556],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[21539088],"length":1,"stats":{"Line":0},"fn_name":"list_leave_requests"},{"line":296,"address":[21663759],"length":1,"stats":{"Line":0},"fn_name":null},{"line":297,"address":[21663817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[21663859],"length":1,"stats":{"Line":0},"fn_name":null},{"line":301,"address":[21663914],"length":1,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[21663926,21664374,21664043,21664267],"length":1,"stats":{"Line":0},"fn_name":null},{"line":304,"address":[21664011],"length":1,"stats":{"Line":0},"fn_name":null},{"line":305,"address":[21664315,21664125,21664070,21663692,21664031],"length":1,"stats":{"Line":0},"fn_name":null},{"line":306,"address":[21664544,21664558,21664438],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":309,"address":[21539664],"length":1,"stats":{"Line":0},"fn_name":"list_overtime_requests"},{"line":318,"address":[21664895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":319,"address":[21664953],"length":1,"stats":{"Line":0},"fn_name":null},{"line":321,"address":[21664995],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[21665050],"length":1,"stats":{"Line":0},"fn_name":null},{"line":324,"address":[21665062,21665403,21665179,21665510],"length":1,"stats":{"Line":0},"fn_name":null},{"line":326,"address":[21665147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":327,"address":[21665206,21664828,21665261,21665451,21665167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":328,"address":[21665694,21665680,21665574],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":331,"address":[21539136],"length":1,"stats":{"Line":1},"fn_name":"apply_request_filters"},{"line":335,"address":[21539163],"length":1,"stats":{"Line":1},"fn_name":null},{"line":336,"address":[21539168],"length":1,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[21539225],"length":1,"stats":{"Line":1},"fn_name":null},{"line":338,"address":[21539240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":340,"address":[21539276],"length":1,"stats":{"Line":1},"fn_name":null},{"line":341,"address":[21539326],"length":1,"stats":{"Line":1},"fn_name":null},{"line":342,"address":[21539341],"length":1,"stats":{"Line":1},"fn_name":null},{"line":344,"address":[21539377],"length":1,"stats":{"Line":1},"fn_name":null},{"line":345,"address":[21539442],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[21539457],"length":1,"stats":{"Line":1},"fn_name":null},{"line":348,"address":[21539513],"length":1,"stats":{"Line":1},"fn_name":null},{"line":349,"address":[21539578],"length":1,"stats":{"Line":1},"fn_name":null},{"line":350,"address":[21539593],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":14,"coverable":87},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","subject_request.rs"],"content":"use chrono::{DateTime, Utc};\nuse sqlx::{PgPool, Postgres, QueryBuilder};\n\nuse crate::models::{\n    request::RequestStatus,\n    subject_request::{DataSubjectRequest, DataSubjectRequestType},\n};\n\n#[derive(Debug, Clone, Default)]\npub struct SubjectRequestFilters {\n    pub status: Option\u003cRequestStatus\u003e,\n    pub request_type: Option\u003cDataSubjectRequestType\u003e,\n    pub user_id: Option\u003cString\u003e,\n    pub from: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub to: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\npub async fn insert_subject_request(\n    pool: \u0026PgPool,\n    request: \u0026DataSubjectRequest,\n) -\u003e Result\u003c(), sqlx::Error\u003e {\n    sqlx::query(\n        \"INSERT INTO subject_requests \\\n         (id, user_id, request_type, status, details, approved_by, approved_at, rejected_by, rejected_at, \\\n          cancelled_at, decision_comment, created_at, updated_at) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)\",\n    )\n    .bind(\u0026request.id)\n    .bind(\u0026request.user_id)\n    .bind(request.request_type.db_value())\n    .bind(request.status.db_value())\n    .bind(\u0026request.details)\n    .bind(\u0026request.approved_by)\n    .bind(request.approved_at)\n    .bind(\u0026request.rejected_by)\n    .bind(request.rejected_at)\n    .bind(request.cancelled_at)\n    .bind(\u0026request.decision_comment)\n    .bind(request.created_at)\n    .bind(request.updated_at)\n    .execute(pool)\n    .await\n    .map(|_| ())\n}\n\npub async fn list_subject_requests_by_user(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n) -\u003e Result\u003cVec\u003cDataSubjectRequest\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, DataSubjectRequest\u003e(\n        \"SELECT id, user_id, request_type, status, details, approved_by, approved_at, rejected_by, \\\n         rejected_at, cancelled_at, decision_comment, created_at, updated_at \\\n         FROM subject_requests WHERE user_id = $1 ORDER BY created_at DESC\",\n    )\n    .bind(user_id)\n    .fetch_all(pool)\n    .await\n}\n\npub async fn fetch_subject_request(\n    pool: \u0026PgPool,\n    id: \u0026str,\n) -\u003e Result\u003cOption\u003cDataSubjectRequest\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, DataSubjectRequest\u003e(\n        \"SELECT id, user_id, request_type, status, details, approved_by, approved_at, rejected_by, \\\n         rejected_at, cancelled_at, decision_comment, created_at, updated_at \\\n         FROM subject_requests WHERE id = $1\",\n    )\n    .bind(id)\n    .fetch_optional(pool)\n    .await\n}\n\npub async fn cancel_subject_request(\n    pool: \u0026PgPool,\n    id: \u0026str,\n    user_id: \u0026str,\n    cancelled_at: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cu64, sqlx::Error\u003e {\n    let result = sqlx::query(\n        \"UPDATE subject_requests SET status = $1, cancelled_at = $2, updated_at = $2 \\\n         WHERE id = $3 AND user_id = $4 AND status = 'pending'\",\n    )\n    .bind(RequestStatus::Cancelled.db_value())\n    .bind(cancelled_at)\n    .bind(id)\n    .bind(user_id)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected())\n}\n\npub async fn approve_subject_request(\n    pool: \u0026PgPool,\n    id: \u0026str,\n    approver_id: \u0026str,\n    comment: \u0026str,\n    approved_at: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cu64, sqlx::Error\u003e {\n    let result = sqlx::query(\n        \"UPDATE subject_requests SET status = $1, approved_by = $2, approved_at = $3, \\\n         decision_comment = $4, updated_at = $3 \\\n         WHERE id = $5 AND status = 'pending'\",\n    )\n    .bind(RequestStatus::Approved.db_value())\n    .bind(approver_id)\n    .bind(approved_at)\n    .bind(comment)\n    .bind(id)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected())\n}\n\npub async fn reject_subject_request(\n    pool: \u0026PgPool,\n    id: \u0026str,\n    approver_id: \u0026str,\n    comment: \u0026str,\n    rejected_at: DateTime\u003cUtc\u003e,\n) -\u003e Result\u003cu64, sqlx::Error\u003e {\n    let result = sqlx::query(\n        \"UPDATE subject_requests SET status = $1, rejected_by = $2, rejected_at = $3, \\\n         decision_comment = $4, updated_at = $3 \\\n         WHERE id = $5 AND status = 'pending'\",\n    )\n    .bind(RequestStatus::Rejected.db_value())\n    .bind(approver_id)\n    .bind(rejected_at)\n    .bind(comment)\n    .bind(id)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected())\n}\n\npub async fn list_subject_requests(\n    pool: \u0026PgPool,\n    filters: \u0026SubjectRequestFilters,\n    per_page: i64,\n    offset: i64,\n) -\u003e Result\u003c(Vec\u003cDataSubjectRequest\u003e, i64), sqlx::Error\u003e {\n    let items = query_subject_requests(pool, filters, Some((per_page, offset))).await?;\n\n    let mut count_builder: QueryBuilder\u003cPostgres\u003e =\n        QueryBuilder::new(\"SELECT COUNT(*) FROM subject_requests\");\n    let mut has_clause = false;\n    apply_subject_request_filters(\u0026mut count_builder, \u0026mut has_clause, filters);\n    let total = count_builder\n        .build_query_scalar::\u003ci64\u003e()\n        .fetch_one(pool)\n        .await?;\n\n    Ok((items, total))\n}\n\nasync fn query_subject_requests(\n    pool: \u0026PgPool,\n    filters: \u0026SubjectRequestFilters,\n    pagination: Option\u003c(i64, i64)\u003e,\n) -\u003e Result\u003cVec\u003cDataSubjectRequest\u003e, sqlx::Error\u003e {\n    let mut builder: QueryBuilder\u003cPostgres\u003e = QueryBuilder::new(\n        \"SELECT id, user_id, request_type, status, details, approved_by, approved_at, rejected_by, \\\n         rejected_at, cancelled_at, decision_comment, created_at, updated_at FROM subject_requests\",\n    );\n    let mut has_clause = false;\n    apply_subject_request_filters(\u0026mut builder, \u0026mut has_clause, filters);\n    builder.push(\" ORDER BY created_at DESC, id DESC\");\n\n    if let Some((per_page, offset)) = pagination {\n        builder\n            .push(\" LIMIT \")\n            .push_bind(per_page)\n            .push(\" OFFSET \")\n            .push_bind(offset);\n    }\n\n    builder\n        .build_query_as::\u003cDataSubjectRequest\u003e()\n        .fetch_all(pool)\n        .await\n}\n\nfn apply_subject_request_filters\u003c'a\u003e(\n    builder: \u0026mut QueryBuilder\u003c'a, Postgres\u003e,\n    has_clause: \u0026mut bool,\n    filters: \u0026SubjectRequestFilters,\n) {\n    if let Some(status) = filters.status.as_ref() {\n        push_clause(builder, has_clause);\n        builder\n            .push(\"status = \")\n            .push_bind(status.db_value().to_string());\n    }\n    if let Some(request_type) = filters.request_type.as_ref() {\n        push_clause(builder, has_clause);\n        builder\n            .push(\"request_type = \")\n            .push_bind(request_type.db_value().to_string());\n    }\n    if let Some(user_id) = filters.user_id.as_ref() {\n        push_clause(builder, has_clause);\n        builder.push(\"user_id = \").push_bind(user_id.to_string());\n    }\n    if let Some(from) = filters.from.as_ref() {\n        push_clause(builder, has_clause);\n        builder.push(\"created_at \u003e= \").push_bind(from.to_owned());\n    }\n    if let Some(to) = filters.to.as_ref() {\n        push_clause(builder, has_clause);\n        builder.push(\"created_at \u003c= \").push_bind(to.to_owned());\n    }\n}\n\nfn push_clause\u003c'a\u003e(builder: \u0026mut QueryBuilder\u003c'a, Postgres\u003e, has_clause: \u0026mut bool) {\n    if *has_clause {\n        builder.push(\" AND \");\n    } else {\n        builder.push(\" WHERE \");\n        *has_clause = true;\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn subject_request_filters_default() {\n        let filters = SubjectRequestFilters::default();\n        assert!(filters.status.is_none());\n        assert!(filters.request_type.is_none());\n        assert!(filters.user_id.is_none());\n    }\n}\n","traces":[{"line":18,"address":[19417824],"length":1,"stats":{"Line":0},"fn_name":"insert_subject_request"},{"line":28,"address":[21933424],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[21933456],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[21934375,21933500,21933583,21933384,21933524],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[21934337,21933714,21933631,21933655],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[21933754],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[21933833],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[21933865],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[21933929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[21933961],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[21934025],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[21934089],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[21934121],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[21934185],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[21934265],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[21933374,21934321,21934622,21934285,21934428],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[21934752,21934757,21934697],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":46,"address":[19419024],"length":1,"stats":{"Line":0},"fn_name":"list_subject_requests_by_user"},{"line":55,"address":[21938974],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[21939002],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[20999239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[19417616],"length":1,"stats":{"Line":0},"fn_name":"fetch_subject_request"},{"line":69,"address":[21929550],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[21929578],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[20992967],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[19417712],"length":1,"stats":{"Line":0},"fn_name":"cancel_subject_request"},{"line":84,"address":[21932135,21932159,21932218,21932531,21932092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[21932304],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[21932368],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[21932405],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[21932453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[20994183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21933067],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[19418048],"length":1,"stats":{"Line":0},"fn_name":"approve_subject_request"},{"line":105,"address":[21937578,21937645,21937704,21938057,21937621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[21937749],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[21937877],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[21937894],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[21937931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":110,"address":[21937979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[20995383],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[21938596],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[19417920],"length":1,"stats":{"Line":0},"fn_name":"reject_subject_request"},{"line":127,"address":[21936181,21936264,21936617,21936205,21936138],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[21936309],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[21936437],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[21936454],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[21936491],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[21936539],"length":1,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[21936686,21936125,21936562,21936883,21936601,21937006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[21937156],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[19417664],"length":1,"stats":{"Line":0},"fn_name":"list_subject_requests"},{"line":143,"address":[20993087],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[21930794],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[21930868],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[21930879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[21931243,21931469,21931305,21931023,21930944],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[21930968],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[20993102],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[21931571],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[19417856],"length":1,"stats":{"Line":0},"fn_name":"query_subject_requests"},{"line":166,"address":[21935026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[21935043],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[21935101],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[21935128],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[21935311,21935183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[21935249],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[21935304],"length":1,"stats":{"Line":0},"fn_name":null},{"line":178,"address":[21935414,21935220,21935649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[21935379],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[21935444,21935697,21935402,21935500,21934959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[19418176],"length":1,"stats":{"Line":0},"fn_name":"apply_subject_request_filters"},{"line":189,"address":[19418235],"length":1,"stats":{"Line":0},"fn_name":null},{"line":190,"address":[19418305],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[19418343],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[19418388],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[19418467],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[19418505],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[19418550],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[19418626],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[19418636],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[19418701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[19418780],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[19418790],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[19418854],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[19418933],"length":1,"stats":{"Line":0},"fn_name":null},{"line":211,"address":[19418943],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[19417520],"length":1,"stats":{"Line":0},"fn_name":"push_clause"},{"line":216,"address":[19417544,19417580],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[19417587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":219,"address":[19417554],"length":1,"stats":{"Line":0},"fn_name":null},{"line":220,"address":[19417577],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":94},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","transaction.rs"],"content":"//! Transaction management utilities for repositories.\n\nuse crate::error::AppError;\nuse sqlx::postgres::PgTransaction;\nuse sqlx::PgPool;\n\n/// Begin a new database transaction.\n///\n/// Returns a transaction handle that can be used for multiple database operations.\n/// On success, the transaction can be committed via [`commit_transaction`].\n/// On failure, the transaction can be rolled back via [`rollback_transaction`].\npub async fn begin_transaction(db: \u0026PgPool) -\u003e Result\u003cPgTransaction\u003c'_\u003e, AppError\u003e {\n    db.begin()\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))\n}\n\n/// Commit a transaction.\n///\n/// Commits all changes made within the transaction to the database.\npub async fn commit_transaction(tx: PgTransaction\u003c'_\u003e) -\u003e Result\u003c(), AppError\u003e {\n    tx.commit()\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))\n}\n\n/// Rollback a transaction.\n///\n/// Undoes all changes made within the transaction since it began.\n#[allow(dead_code)]\npub async fn rollback_transaction(tx: PgTransaction\u003c'_\u003e) -\u003e Result\u003c(), AppError\u003e {\n    tx.rollback()\n        .await\n        .map_err(|e| AppError::InternalServerError(e.into()))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn transaction_module_is_compilable() {\n        let _ = begin_transaction;\n        let _ = commit_transaction;\n        let _ = rollback_transaction;\n    }\n}\n","traces":[{"line":12,"address":[21817229,21817120,21817747,21817268,21817155,21817375],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":13,"address":[21817612,21817222,21817335,21817537],"length":1,"stats":{"Line":0},"fn_name":null},{"line":14,"address":[20986247],"length":1,"stats":{"Line":0},"fn_name":null},{"line":15,"address":[21817760,21817774,21817692],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":21,"address":[21818015,21818054,21817875,21817840,21818168,21818557],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":22,"address":[21818346,21818125,21817949,21818409],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[20987553],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[21818576,21818590,21818473],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":31,"address":[21818827,21818691,21818866,21818972,21818656,21819349],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":32,"address":[21818933,21819201,21818765,21819142],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[21818854,21819003,21819190,21818921,21818957],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[21819265,21819374,21819360],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"}],"covered":0,"coverable":12},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","user.rs"],"content":"//! Repository functions for user management operations.\n\nuse chrono::Utc;\nuse sqlx::PgPool;\n\nuse crate::error::AppError;\nuse crate::repositories::transaction;\n\nuse crate::models::user::{User, UserRole};\n\n/// Fetches all users ordered by creation date (descending).\npub async fn list_users(pool: \u0026PgPool) -\u003e Result\u003cVec\u003cUser\u003e, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, User\u003e(\n        \"SELECT id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at FROM users ORDER BY created_at DESC\",\n    )\n    .fetch_all(pool)\n    .await\n}\n\n/// Creates a new user.\npub async fn create_user(pool: \u0026PgPool, user: \u0026User) -\u003e Result\u003cUser, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, User\u003e(\n        \"INSERT INTO users (id, username, password_hash, full_name, email, role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12) \\\n         RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\",\n    )\n    .bind(user.id.to_string())\n    .bind(\u0026user.username)\n    .bind(\u0026user.password_hash)\n    .bind(\u0026user.full_name)\n    .bind(\u0026user.email)\n    .bind(match user.role {\n        UserRole::Employee =\u003e \"employee\",\n        UserRole::Admin =\u003e \"admin\",\n    })\n    .bind(user.is_system_admin)\n    .bind(\u0026user.mfa_secret)\n    .bind(user.mfa_enabled_at)\n    .bind(user.password_changed_at)\n    .bind(user.created_at)\n    .bind(user.updated_at)\n    .fetch_one(pool)\n    .await\n}\n\n/// Updates an existing user's profile.\npub async fn update_user(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n    full_name: \u0026str,\n    email: \u0026str,\n    role: UserRole,\n    is_system_admin: bool,\n) -\u003e Result\u003cUser, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, User\u003e(\n        \"UPDATE users SET full_name = $1, email = $2, role = $3, is_system_admin = $4, updated_at = NOW() \\\n         WHERE id = $5 \\\n         RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\",\n    )\n    .bind(full_name)\n    .bind(email)\n    .bind(role.as_str())\n    .bind(is_system_admin)\n    .bind(user_id)\n    .fetch_one(pool)\n    .await\n}\n\n/// Checks if an email exists for a different user (for uniqueness check).\npub async fn email_exists_for_other_user(\n    pool: \u0026PgPool,\n    email: \u0026str,\n    exclude_user_id: \u0026str,\n) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result: (bool,) =\n        sqlx::query_as(\"SELECT EXISTS(SELECT 1 FROM users WHERE email = $1 AND id != $2)\")\n            .bind(email)\n            .bind(exclude_user_id)\n            .fetch_one(pool)\n            .await?;\n    Ok(result.0)\n}\n\n/// Resets MFA for a user.\npub async fn reset_mfa(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result = sqlx::query(\n        \"UPDATE users SET mfa_secret = NULL, mfa_enabled_at = NULL, updated_at = NOW() WHERE id = $1\",\n    )\n    .bind(user_id)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected() \u003e 0)\n}\n\n/// Checks if a username exists (for conflict check).\npub async fn username_exists(pool: \u0026PgPool, username: \u0026str) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result: Option\u003c(i64,)\u003e = sqlx::query_as(\"SELECT 1 FROM users WHERE username = $1\")\n        .bind(username)\n        .fetch_optional(pool)\n        .await?;\n    Ok(result.is_some())\n}\n\n/// Updates a user's profile (self-service).\npub async fn update_profile(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n    full_name: \u0026str,\n    email: \u0026str,\n) -\u003e Result\u003cUser, sqlx::Error\u003e {\n    sqlx::query_as::\u003c_, User\u003e(\n        \"UPDATE users SET full_name = $1, email = $2, updated_at = NOW() \\\n         WHERE id = $3 \\\n         RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\",\n    )\n    .bind(full_name)\n    .bind(email)\n    .bind(user_id)\n    .fetch_one(pool)\n    .await\n}\n\n/// Enables MFA for a user.\npub async fn enable_mfa(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n    at: chrono::DateTime\u003cchrono::Utc\u003e,\n) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result = sqlx::query(\"UPDATE users SET mfa_enabled_at = $1, updated_at = $1 WHERE id = $2\")\n        .bind(at)\n        .bind(user_id)\n        .execute(pool)\n        .await?;\n    Ok(result.rows_affected() \u003e 0)\n}\n\n/// Disables MFA for a user (self-service).\npub async fn disable_mfa(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result = sqlx::query(\n        \"UPDATE users SET mfa_secret = NULL, mfa_enabled_at = NULL, updated_at = NOW() WHERE id = $1\",\n    )\n    .bind(user_id)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected() \u003e 0)\n}\n\n/// Sets the MFA secret for enrollment.\npub async fn set_mfa_secret(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n    secret: \u0026str,\n    at: chrono::DateTime\u003cchrono::Utc\u003e,\n) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result = sqlx::query(\n        \"UPDATE users SET mfa_secret = $1, mfa_enabled_at = NULL, updated_at = $2 WHERE id = $3\",\n    )\n    .bind(secret)\n    .bind(at)\n    .bind(user_id)\n    .execute(pool)\n    .await?;\n    Ok(result.rows_affected() \u003e 0)\n}\n\n/// Archives a user and all related data (soft delete).\n/// - Moves user to archived_users\n/// - Moves attendance, break_records, leave_requests, overtime_requests, holiday_exceptions to archived tables\n/// - Deletes session tokens (refresh_tokens, active_access_tokens)\npub async fn soft_delete_user(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n    archived_by: \u0026str,\n) -\u003e Result\u003c(), AppError\u003e {\n    let mut tx = transaction::begin_transaction(pool).await?;\n    let now = Utc::now();\n\n    // 1. Archive break records (via attendance)\n    sqlx::query(\n        r#\"\n        INSERT INTO archived_break_records (id, attendance_id, break_start_time, break_end_time, duration_minutes, created_at, updated_at, archived_at)\n        SELECT br.id, br.attendance_id, br.break_start_time, br.break_end_time, br.duration_minutes, br.created_at, br.updated_at, $2\n        FROM break_records br\n        INNER JOIN attendance a ON br.attendance_id = a.id\n        WHERE a.user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .bind(now)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 2. Archive attendance\n    sqlx::query(\n        r#\"\n        INSERT INTO archived_attendance (id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at, archived_at)\n        SELECT id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at, $2\n        FROM attendance\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .bind(now)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 3. Archive leave requests\n    sqlx::query(\n        r#\"\n        INSERT INTO archived_leave_requests (id, user_id, leave_type, start_date, end_date, reason, status, approved_by, approved_at, created_at, updated_at, archived_at)\n        SELECT id, user_id, leave_type, start_date, end_date, reason, status, approved_by, approved_at, created_at, updated_at, $2\n        FROM leave_requests\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .bind(now)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 4. Archive overtime requests\n    sqlx::query(\n        r#\"\n        INSERT INTO archived_overtime_requests (id, user_id, date, planned_hours, reason, status, approved_by, approved_at, created_at, updated_at, archived_at)\n        SELECT id, user_id, date, planned_hours, reason, status, approved_by, approved_at, created_at, updated_at, $2\n        FROM overtime_requests\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .bind(now)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 5. Archive holiday exceptions\n    sqlx::query(\n        r#\"\n        INSERT INTO archived_holiday_exceptions (id, user_id, exception_date, override, reason, created_by, created_at, updated_at, archived_at)\n        SELECT id, user_id, exception_date, override, reason, created_by, created_at, updated_at, $2\n        FROM holiday_exceptions\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .bind(now)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 6. Archive user\n    sqlx::query(\n        r#\"\n        INSERT INTO archived_users (id, username, password_hash, full_name, role, is_system_admin, mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at, archived_at, archived_by)\n        SELECT id, username, password_hash, full_name, role, is_system_admin, mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at, $2, $3\n        FROM users\n        WHERE id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .bind(now)\n    .bind(archived_by)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 7. Delete user (will cascade delete related records and session tokens)\n    sqlx::query(\"DELETE FROM users WHERE id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n\n    transaction::commit_transaction(tx).await?;\n    Ok(())\n}\n\n/// Permanently deletes a user and all related data (hard delete).\n/// Uses CASCADE delete to remove all related records.\npub async fn hard_delete_user(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003c(), AppError\u003e {\n    sqlx::query(\"DELETE FROM users WHERE id = $1\")\n        .bind(user_id)\n        .execute(pool)\n        .await?;\n    Ok(())\n}\n\n/// Restores a user from the archive.\npub async fn restore_user(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003c(), AppError\u003e {\n    let mut tx = transaction::begin_transaction(pool).await?;\n\n    // 1. Restore user\n    sqlx::query(\n        r#\"\n        INSERT INTO users (id, username, password_hash, full_name, role, is_system_admin, mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at)\n        SELECT id, username, password_hash, full_name, role, is_system_admin, mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\n        FROM archived_users\n        WHERE id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 2. Restore attendance\n    sqlx::query(\n        r#\"\n        INSERT INTO attendance (id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at)\n        SELECT id, user_id, date, clock_in_time, clock_out_time, status, total_work_hours, created_at, updated_at\n        FROM archived_attendance\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 3. Restore break records\n    sqlx::query(\n        r#\"\n        INSERT INTO break_records (id, attendance_id, break_start_time, break_end_time, duration_minutes, created_at, updated_at)\n        SELECT abr.id, abr.attendance_id, abr.break_start_time, abr.break_end_time, abr.duration_minutes, abr.created_at, abr.updated_at\n        FROM archived_break_records abr\n        INNER JOIN archived_attendance aa ON abr.attendance_id = aa.id\n        WHERE aa.user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 4. Restore leave requests\n    sqlx::query(\n        r#\"\n        INSERT INTO leave_requests (id, user_id, leave_type, start_date, end_date, reason, status, approved_by, approved_at, created_at, updated_at)\n        SELECT id, user_id, leave_type, start_date, end_date, reason, status, approved_by, approved_at, created_at, updated_at\n        FROM archived_leave_requests\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 5. Restore overtime requests\n    sqlx::query(\n        r#\"\n        INSERT INTO overtime_requests (id, user_id, date, planned_hours, reason, status, approved_by, approved_at, created_at, updated_at)\n        SELECT id, user_id, date, planned_hours, reason, status, approved_by, approved_at, created_at, updated_at\n        FROM archived_overtime_requests\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 6. Restore holiday exceptions\n    sqlx::query(\n        r#\"\n        INSERT INTO holiday_exceptions (id, user_id, exception_date, override, reason, created_by, created_at, updated_at)\n        SELECT id, user_id, exception_date, override, reason, created_by, created_at, updated_at\n        FROM archived_holiday_exceptions\n        WHERE user_id = $1\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    // 7. Delete from archive\n    sqlx::query(\"DELETE FROM archived_holiday_exceptions WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n    sqlx::query(\"DELETE FROM archived_overtime_requests WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n    sqlx::query(\"DELETE FROM archived_leave_requests WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n    sqlx::query(\n        r#\"\n        DELETE FROM archived_break_records\n        WHERE attendance_id IN (SELECT id FROM archived_attendance WHERE user_id = $1)\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n    sqlx::query(\"DELETE FROM archived_attendance WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n    sqlx::query(\"DELETE FROM archived_users WHERE id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n\n    transaction::commit_transaction(tx).await?;\n    Ok(())\n}\n\n/// Checks if a user exists by ID.\npub async fn user_exists(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result: Option\u003c(i64,)\u003e = sqlx::query_as(\"SELECT 1 FROM users WHERE id = $1\")\n        .bind(user_id)\n        .fetch_optional(pool)\n        .await?;\n    Ok(result.is_some())\n}\n\n/// Fetches username by user ID.\npub async fn fetch_username(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003cOption\u003cString\u003e, sqlx::Error\u003e {\n    let result: Option\u003c(String,)\u003e = sqlx::query_as(\"SELECT username FROM users WHERE id = $1\")\n        .bind(user_id)\n        .fetch_optional(pool)\n        .await?;\n    Ok(result.map(|(u,)| u))\n}\n\n// ============================================================================\n// Archived user functions\n// ============================================================================\n\n/// Permanently deletes an archived user and all related archived data.\npub async fn hard_delete_archived_user(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003c(), AppError\u003e {\n    let mut tx = transaction::begin_transaction(pool).await?;\n\n    // Delete in reverse order of dependencies\n    sqlx::query(\n        r#\"\n        DELETE FROM archived_break_records\n        WHERE attendance_id IN (SELECT id FROM archived_attendance WHERE user_id = $1)\n        \"#,\n    )\n    .bind(user_id)\n    .execute(\u0026mut *tx)\n    .await?;\n\n    sqlx::query(\"DELETE FROM archived_attendance WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n\n    sqlx::query(\"DELETE FROM archived_leave_requests WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n\n    sqlx::query(\"DELETE FROM archived_overtime_requests WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n\n    sqlx::query(\"DELETE FROM archived_holiday_exceptions WHERE user_id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n\n    sqlx::query(\"DELETE FROM archived_users WHERE id = $1\")\n        .bind(user_id)\n        .execute(\u0026mut *tx)\n        .await?;\n\n    transaction::commit_transaction(tx).await?;\n    Ok(())\n}\n\n/// Checks if an archived user exists by ID.\npub async fn archived_user_exists(pool: \u0026PgPool, user_id: \u0026str) -\u003e Result\u003cbool, sqlx::Error\u003e {\n    let result: Option\u003c(i64,)\u003e = sqlx::query_as(\"SELECT 1 FROM archived_users WHERE id = $1\")\n        .bind(user_id)\n        .fetch_optional(pool)\n        .await?;\n    Ok(result.is_some())\n}\n\n/// Fetches archived username by user ID.\npub async fn fetch_archived_username(\n    pool: \u0026PgPool,\n    user_id: \u0026str,\n) -\u003e Result\u003cOption\u003cString\u003e, sqlx::Error\u003e {\n    let result: Option\u003c(String,)\u003e =\n        sqlx::query_as(\"SELECT username FROM archived_users WHERE id = $1\")\n            .bind(user_id)\n            .fetch_optional(pool)\n            .await?;\n    Ok(result.map(|(u,)| u))\n}\n\n/// Archived user data for API response.\n#[derive(Debug, Clone, sqlx::FromRow)]\npub struct ArchivedUserRow {\n    pub id: String,\n    pub username: String,\n    pub full_name: String,\n    pub role: String,\n    pub is_system_admin: bool,\n    pub archived_at: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub archived_by: Option\u003cString\u003e,\n}\n\n/// Fetches all archived users.\npub async fn get_archived_users(pool: \u0026PgPool) -\u003e Result\u003cVec\u003cArchivedUserRow\u003e, sqlx::Error\u003e {\n    let rows = sqlx::query_as::\u003c_, ArchivedUserRow\u003e(\n        r#\"\n        SELECT id, username, full_name, role, is_system_admin, archived_at, archived_by\n        FROM archived_users\n        ORDER BY archived_at DESC\n        \"#,\n    )\n    .fetch_all(pool)\n    .await?;\n    Ok(rows)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn archived_user_row_struct_exists() {\n        let row = ArchivedUserRow {\n            id: \"test-id\".to_string(),\n            username: \"testuser\".to_string(),\n            full_name: \"Test User\".to_string(),\n            role: \"employee\".to_string(),\n            is_system_admin: false,\n            archived_at: Utc::now(),\n            archived_by: None,\n        };\n        assert_eq!(row.id, \"test-id\");\n        assert_eq!(row.username, \"testuser\");\n    }\n\n    #[test]\n    fn user_role_to_string_conversion() {\n        let employee = UserRole::Employee;\n        let admin = UserRole::Admin;\n        \n        let emp_str = match employee {\n            UserRole::Employee =\u003e \"employee\",\n            UserRole::Admin =\u003e \"admin\",\n        };\n        let adm_str = match admin {\n            UserRole::Employee =\u003e \"employee\",\n            UserRole::Admin =\u003e \"admin\",\n        };\n        \n        assert_eq!(emp_str, \"employee\");\n        assert_eq!(adm_str, \"admin\");\n    }\n}\n","traces":[{"line":12,"address":[21537672,21537664],"length":1,"stats":{"Line":0},"fn_name":"list_users"},{"line":17,"address":[18266436],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[18266456,18266538,18266731,18266361,18266492],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[18266835,18266800,18267864,18266951,18267173],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":30,"address":[18267125,18267854,18266988,18267055,18267036],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[18267161],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[18267220],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[18267252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[18267284],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[18267423,18267316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[18267364],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[18267335],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[18267435],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[18267470],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[18267502],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[18267566],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[18267630],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[18267694],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[18267774],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[18266978,18268077,18267794,18267830,18267901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[21537776],"length":1,"stats":{"Line":0},"fn_name":"update_user"},{"line":64,"address":[18269521],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[18269554],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[18269899,18269598,18269460,18269574,18269673],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[18269692],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[18269794],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[18269822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[18269946,18269450,18269845,18269880,18270117],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[21538656],"length":1,"stats":{"Line":0},"fn_name":"email_exists_for_other_user"},{"line":79,"address":[18307316,18307739,18307912,18307595,18307079,18307536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[18307220],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[18307253],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[18307281],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[18307343,18307697,18307137,18307390,18307304,18307584],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[18307837],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[18308304,18308126,18308898,18307920,18307955,18308084],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":93,"address":[18308178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[18308226],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[18308111,18308335,18308646,18308529,18308288,18308249],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[18308788],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[21538320,21538338],"length":1,"stats":{"Line":0},"fn_name":"username_exists"},{"line":101,"address":[18287388,18286757,18287604,18286961,18287181,18287240],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[18286898],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[18286926],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[18287346,18286988,18286949,18286815,18287035,18287229],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[18287514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[21538208],"length":1,"stats":{"Line":0},"fn_name":"update_profile"},{"line":121,"address":[18286178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[18286211],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[18286244],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[18286272],"length":1,"stats":{"Line":0},"fn_name":null},{"line":125,"address":[18286292,18286375,18286095,18286328,18286551],"length":1,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[21537600],"length":1,"stats":{"Line":0},"fn_name":"enable_mfa"},{"line":134,"address":[18265291,18265406,18266192,18265774,18265833,18265984,18265554],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[18265454],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[18265471],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[18265519],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[18265542,18265628,18265822,18265939,18265581,18265349],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[18266084],"length":1,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[18268144,18268528,18268308,18268350,18269122,18268179],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":147,"address":[18268402],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[18268450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[20970135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[18269012],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[21538096],"length":1,"stats":{"Line":0},"fn_name":"set_mfa_secret"},{"line":163,"address":[18284986],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[18285061],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[18285078],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[18285126],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[18285149,18284919,18285235,18285429,18285188,18285556],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[18285710],"length":1,"stats":{"Line":0},"fn_name":null},{"line":175,"address":[21538416],"length":1,"stats":{"Line":0},"fn_name":"soft_delete_user"},{"line":180,"address":[18288848,18289206,18290219,18288808,18289102],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[18289733],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[18289867],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[18289909],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[18290181,18289981,18289827,18290001,18290055],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[18290158,18290463,18290249,18288869,18290090,18290597],"length":1,"stats":{"Line":0},"fn_name":null},{"line":207,"address":[18290816],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[18290858],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[18291004,18290773,18290950,18291130,18290930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":210,"address":[20975588],"length":1,"stats":{"Line":0},"fn_name":null},{"line":221,"address":[18291765],"length":1,"stats":{"Line":0},"fn_name":null},{"line":222,"address":[18291807],"length":1,"stats":{"Line":0},"fn_name":null},{"line":223,"address":[18292079,18291722,18291953,18291879,18291899],"length":1,"stats":{"Line":0},"fn_name":null},{"line":224,"address":[20975614],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[18292691],"length":1,"stats":{"Line":0},"fn_name":null},{"line":236,"address":[18292733],"length":1,"stats":{"Line":0},"fn_name":null},{"line":237,"address":[18292805,18292648,18292825,18292879,18293005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[20975640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[18293617],"length":1,"stats":{"Line":0},"fn_name":null},{"line":250,"address":[18293659],"length":1,"stats":{"Line":0},"fn_name":null},{"line":251,"address":[18293751,18293931,18293731,18293574,18293805],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[18294324,18293976,18293908,18288953,18293840,18294190],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[18294543],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[18294585],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[18294649],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[18294720,18294700,18294774,18294900,18294500],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[20975692],"length":1,"stats":{"Line":0},"fn_name":null},{"line":270,"address":[18296203,18295438,18295628,18296039,18296457,18295973,18295706],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[18295512],"length":1,"stats":{"Line":0},"fn_name":null},{"line":272,"address":[18295636,18295562,18295469,18295762,18295582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":273,"address":[18295671,18296021,18296155,18295807,18288995,18295739],"length":1,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[20975744],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[18296850],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[18287994,18288551,18287780,18287651,18287616,18287822],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":282,"address":[18288165,18288369,18288549,18287749,18287954,18288224],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[18287874],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[18287922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[18288025,18288213,18288330,18287942,18287807,18287978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[18288460],"length":1,"stats":{"Line":0},"fn_name":null},{"line":290,"address":[21538000,21538018],"length":1,"stats":{"Line":0},"fn_name":"restore_user"},{"line":291,"address":[18272862,18271489,18271449,18271940,18271842],"length":1,"stats":{"Line":0},"fn_name":null},{"line":302,"address":[18272529],"length":1,"stats":{"Line":0},"fn_name":null},{"line":303,"address":[18272827,18272579,18272486,18272602,18272659],"length":1,"stats":{"Line":0},"fn_name":null},{"line":304,"address":[20971524],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[18273450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":316,"address":[18273580,18273500,18273407,18273523,18273703],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[20971547],"length":1,"stats":{"Line":0},"fn_name":null},{"line":329,"address":[18274329],"length":1,"stats":{"Line":0},"fn_name":null},{"line":330,"address":[18274379,18274459,18274286,18274582,18274402],"length":1,"stats":{"Line":0},"fn_name":null},{"line":331,"address":[18274838,18274969,18274494,18274627,18274559,18271552],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[18275188],"length":1,"stats":{"Line":0},"fn_name":null},{"line":343,"address":[18275145,18275238,18275318,18275441,18275261],"length":1,"stats":{"Line":0},"fn_name":null},{"line":344,"address":[18275697,18275828,18275418,18275486,18271573,18275353],"length":1,"stats":{"Line":0},"fn_name":null},{"line":355,"address":[18276047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":356,"address":[18276120,18276177,18276004,18276097,18276300],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[20971616],"length":1,"stats":{"Line":0},"fn_name":null},{"line":368,"address":[18276906],"length":1,"stats":{"Line":0},"fn_name":null},{"line":369,"address":[18276956,18277030,18277150,18276976,18276863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":370,"address":[18277534,18277195,18271615,18277403,18277065,18277130],"length":1,"stats":{"Line":0},"fn_name":null},{"line":373,"address":[18277679,18277869,18278265,18278202,18278429,18278876,18277947],"length":1,"stats":{"Line":0},"fn_name":null},{"line":374,"address":[18277753],"length":1,"stats":{"Line":0},"fn_name":null},{"line":375,"address":[18277710,18277823,18277803,18277877,18277997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":376,"address":[18277977,18278250,18278042,18271636,18278381,18277912],"length":1,"stats":{"Line":0},"fn_name":null},{"line":377,"address":[18279112,18278716,18279276,18279723,18278526,18279049,18278794],"length":1,"stats":{"Line":0},"fn_name":null},{"line":378,"address":[18278600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":379,"address":[18278844,18278650,18278557,18278724,18278670],"length":1,"stats":{"Line":0},"fn_name":null},{"line":380,"address":[18278824,18278759,18271657,18278889,18279097,18279228],"length":1,"stats":{"Line":0},"fn_name":null},{"line":381,"address":[18279373,18279896,18279641,18279563,18279959,18280123,18280570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":382,"address":[18279447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":383,"address":[18279404,18279571,18279517,18279497,18279691],"length":1,"stats":{"Line":0},"fn_name":null},{"line":384,"address":[18271678,18279944,18280075,18279736,18279671,18279606],"length":1,"stats":{"Line":0},"fn_name":null},{"line":391,"address":[18280294],"length":1,"stats":{"Line":0},"fn_name":null},{"line":392,"address":[18280418,18280344,18280364,18280251,18280538],"length":1,"stats":{"Line":0},"fn_name":null},{"line":393,"address":[20971731],"length":1,"stats":{"Line":0},"fn_name":null},{"line":394,"address":[18281067,18281257,18281335,18281590,18281817,18282264,18281653],"length":1,"stats":{"Line":0},"fn_name":null},{"line":395,"address":[18281141],"length":1,"stats":{"Line":0},"fn_name":null},{"line":396,"address":[18281211,18281385,18281191,18281265,18281098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":397,"address":[18271720,18281430,18281769,18281300,18281365,18281638],"length":1,"stats":{"Line":0},"fn_name":null},{"line":398,"address":[18282909,18282104,18282500,18282182,18281914,18282437,18282664],"length":1,"stats":{"Line":0},"fn_name":null},{"line":399,"address":[18281988],"length":1,"stats":{"Line":0},"fn_name":null},{"line":400,"address":[18281945,18282112,18282232,18282058,18282038],"length":1,"stats":{"Line":0},"fn_name":null},{"line":401,"address":[18282616,18271741,18282147,18282277,18282212,18282485],"length":1,"stats":{"Line":0},"fn_name":null},{"line":403,"address":[18283392,18271762,18282922,18282769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":404,"address":[18283293],"length":1,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[21537952,21537970],"length":1,"stats":{"Line":0},"fn_name":"user_exists"},{"line":409,"address":[18270513,18270309,18270792,18270940,18270733,18271156],"length":1,"stats":{"Line":0},"fn_name":null},{"line":410,"address":[18270450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":411,"address":[18270478],"length":1,"stats":{"Line":0},"fn_name":null},{"line":412,"address":[20970343],"length":1,"stats":{"Line":0},"fn_name":null},{"line":413,"address":[18271066],"length":1,"stats":{"Line":0},"fn_name":null},{"line":417,"address":[18284622,18283491,18283852,18283628,18283456,18283678],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":418,"address":[18283597,18283809,18284029,18284088,18284239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":419,"address":[18283746],"length":1,"stats":{"Line":0},"fn_name":null},{"line":420,"address":[18283774],"length":1,"stats":{"Line":0},"fn_name":null},{"line":421,"address":[18283797,18283655,18284077,18283883,18283836,18284194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":422,"address":[18284643,18284481,18284383,18284640],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":430,"address":[18301602,18300382,18300234,18300509,18300530,18300425,18300160,18300581,18300446,18300691,18300467,18300551,18300488],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":431,"address":[18301608,18300636,18300412,18300372,18300722],"length":1,"stats":{"Line":0},"fn_name":null},{"line":440,"address":[18301296],"length":1,"stats":{"Line":0},"fn_name":null},{"line":441,"address":[18301256,18301363,18301343,18301573,18301417],"length":1,"stats":{"Line":0},"fn_name":null},{"line":442,"address":[20987716],"length":1,"stats":{"Line":0},"fn_name":null},{"line":444,"address":[18302626,18302689,18302853,18302366,18302291,18303288,18302107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":445,"address":[18302178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":446,"address":[18302299,18302413,18302245,18302138,18302225],"length":1,"stats":{"Line":0},"fn_name":null},{"line":447,"address":[20987739],"length":1,"stats":{"Line":0},"fn_name":null},{"line":449,"address":[18303209,18303452,18303134,18303515,18303679,18302950,18304114],"length":1,"stats":{"Line":0},"fn_name":null},{"line":450,"address":[18303021],"length":1,"stats":{"Line":0},"fn_name":null},{"line":451,"address":[18303088,18303068,18303256,18303142,18302981],"length":1,"stats":{"Line":0},"fn_name":null},{"line":452,"address":[18303500,18303298,18303631,18303177,18300475,18303236],"length":1,"stats":{"Line":0},"fn_name":null},{"line":454,"address":[18303960,18304940,18304278,18304505,18303776,18304341,18304035],"length":1,"stats":{"Line":0},"fn_name":null},{"line":455,"address":[18303847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":456,"address":[18303968,18303894,18304082,18303807,18303914],"length":1,"stats":{"Line":0},"fn_name":null},{"line":457,"address":[18304124,18304326,18304003,18304062,18300496,18304457],"length":1,"stats":{"Line":0},"fn_name":null},{"line":459,"address":[18305766,18305331,18304861,18304602,18305167,18304786,18305104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":460,"address":[18304673],"length":1,"stats":{"Line":0},"fn_name":null},{"line":461,"address":[18304794,18304908,18304633,18304720,18304740],"length":1,"stats":{"Line":0},"fn_name":null},{"line":462,"address":[20987808],"length":1,"stats":{"Line":0},"fn_name":null},{"line":464,"address":[18306393,18305930,18305993,18305687,18305612,18305428,18306157],"length":1,"stats":{"Line":0},"fn_name":null},{"line":465,"address":[18305499],"length":1,"stats":{"Line":0},"fn_name":null},{"line":466,"address":[18305620,18305546,18305459,18305734,18305566],"length":1,"stats":{"Line":0},"fn_name":null},{"line":467,"address":[20987831],"length":1,"stats":{"Line":0},"fn_name":null},{"line":469,"address":[20987854],"length":1,"stats":{"Line":0},"fn_name":null},{"line":470,"address":[18306765],"length":1,"stats":{"Line":0},"fn_name":null},{"line":474,"address":[21538530,21538512],"length":1,"stats":{"Line":0},"fn_name":"archived_user_exists"},{"line":475,"address":[18298509,18298568,18298289,18298085,18298716,18298932],"length":1,"stats":{"Line":0},"fn_name":null},{"line":476,"address":[18298226],"length":1,"stats":{"Line":0},"fn_name":null},{"line":477,"address":[18298254],"length":1,"stats":{"Line":0},"fn_name":null},{"line":478,"address":[20982295],"length":1,"stats":{"Line":0},"fn_name":null},{"line":479,"address":[18298842],"length":1,"stats":{"Line":0},"fn_name":null},{"line":483,"address":[21538560],"length":1,"stats":{"Line":0},"fn_name":"fetch_archived_username"},{"line":487,"address":[18299727,18299517,18299576,18299085,18299297],"length":1,"stats":{"Line":0},"fn_name":null},{"line":489,"address":[18299234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":490,"address":[18299262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":491,"address":[18299682,18299324,18299143,18299371,18299565,18299285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":492,"address":[18299871,18300131,18299969,18300128],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":508,"address":[18297150,18297189,18297324,18297059,18297937,18297024],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":516,"address":[18297252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":517,"address":[18297177,18297308,18297662,18297549,18297355,18297272],"length":1,"stats":{"Line":0},"fn_name":null},{"line":518,"address":[18297821],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":211},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","user_repository.rs"],"content":"//! User repository trait for dependency injection and testing.\n//!\n//! This module defines the UserRepository trait which can be mocked\n//! using mockall for testing purposes.\n\nuse async_trait::async_trait;\nuse sqlx::PgPool;\n\nuse crate::error::AppError;\nuse crate::models::user::User;\nuse crate::types::UserId;\n\n/// Repository trait for User operations.\n///\n/// This trait is designed to be mockable using mockall for testing.\n/// Use `MockUserRepository` in tests to mock the behavior.\n#[cfg_attr(test, mockall::automock)]\n#[async_trait]\npub trait UserRepository: Send + Sync {\n    /// Find all users\n    async fn find_all(\u0026self, db: PgPool) -\u003e Result\u003cVec\u003cUser\u003e, AppError\u003e;\n\n    /// Find a user by ID\n    async fn find_by_id(\u0026self, db: PgPool, id: UserId) -\u003e Result\u003cUser, AppError\u003e;\n\n    /// Create a new user\n    async fn create(\u0026self, db: PgPool, user: \u0026User) -\u003e Result\u003cUser, AppError\u003e;\n\n    /// Update an existing user\n    async fn update(\u0026self, db: PgPool, user: \u0026User) -\u003e Result\u003cUser, AppError\u003e;\n\n    /// Delete a user by ID\n    async fn delete(\u0026self, db: PgPool, id: UserId) -\u003e Result\u003c(), AppError\u003e;\n\n    /// Find user by username\n    async fn find_by_username(\u0026self, db: PgPool, username: \u0026str) -\u003e Result\u003cOption\u003cUser\u003e, AppError\u003e;\n\n    /// Find user by email\n    async fn find_by_email(\u0026self, db: PgPool, email: \u0026str) -\u003e Result\u003cOption\u003cUser\u003e, AppError\u003e;\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_mock_user_repository_can_be_created() {\n        let _mock = MockUserRepository::new();\n    }\n\n    #[test]\n    fn test_mock_user_repository_trait_bounds() {\n        fn check_send_sync\u003cT: Send + Sync\u003e() {}\n        check_send_sync::\u003cMockUserRepository\u003e();\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","repositories","weekly_holiday.rs"],"content":"//! Weekly holiday repository.\n//!\n//! Provides CRUD operations for weekly holidays.\n\n#![allow(dead_code)]\n\nuse crate::error::AppError;\nuse crate::models::holiday::WeeklyHoliday;\nuse crate::repositories::repository::Repository;\nuse crate::types::WeeklyHolidayId;\nuse sqlx::{PgPool, Row};\n\nconst TABLE_NAME: \u0026str = \"weekly_holidays\";\nconst SELECT_COLUMNS: \u0026str = \"id, weekday, starts_on, ends_on, enforced_from, enforced_to, created_by, created_at, updated_at\";\n\n#[derive(Debug, Default, Clone, Copy)]\npub struct WeeklyHolidayRepository;\n\nimpl WeeklyHolidayRepository {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    fn base_select_query() -\u003e String {\n        format!(\"SELECT {} FROM {}\", SELECT_COLUMNS, TABLE_NAME)\n    }\n}\n\nimpl Repository\u003cWeeklyHoliday\u003e for WeeklyHolidayRepository {\n    const TABLE: \u0026'static str = TABLE_NAME;\n    type Id = WeeklyHolidayId;\n\n    async fn find_all(\u0026self, db: \u0026PgPool) -\u003e Result\u003cVec\u003cWeeklyHoliday\u003e, AppError\u003e {\n        let query = format!(\n            \"{} ORDER BY enforced_from, weekday\",\n            Self::base_select_query()\n        );\n        let rows = sqlx::query_as::\u003c_, WeeklyHoliday\u003e(\u0026query)\n            .fetch_all(db)\n            .await?;\n        Ok(rows)\n    }\n\n    async fn find_by_id(\n        \u0026self,\n        db: \u0026PgPool,\n        id: WeeklyHolidayId,\n    ) -\u003e Result\u003cWeeklyHoliday, AppError\u003e {\n        let query = format!(\"{} WHERE id = $1\", Self::base_select_query());\n        let result = sqlx::query_as::\u003c_, WeeklyHoliday\u003e(\u0026query)\n            .bind(id)\n            .fetch_optional(db)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Weekly holiday not found\".into()))?;\n        Ok(result)\n    }\n\n    async fn create(\u0026self, db: \u0026PgPool, item: \u0026WeeklyHoliday) -\u003e Result\u003cWeeklyHoliday, AppError\u003e {\n        let query = format!(\n            \"INSERT INTO {} (id, weekday, starts_on, ends_on, enforced_from, enforced_to, created_by, created_at, updated_at) \\\n             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) \\\n             RETURNING {}\",\n            TABLE_NAME, SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, WeeklyHoliday\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.weekday)\n            .bind(item.starts_on)\n            .bind(item.ends_on)\n            .bind(item.enforced_from)\n            .bind(item.enforced_to)\n            .bind(item.created_by)\n            .bind(item.created_at)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn update(\u0026self, db: \u0026PgPool, item: \u0026WeeklyHoliday) -\u003e Result\u003cWeeklyHoliday, AppError\u003e {\n        let query = format!(\n            \"UPDATE {} SET weekday = $2, starts_on = $3, ends_on = $4, enforced_from = $5, enforced_to = $6, updated_at = $7 \\\n             WHERE id = $1 RETURNING {}\",\n            TABLE_NAME, SELECT_COLUMNS\n        );\n        let row = sqlx::query_as::\u003c_, WeeklyHoliday\u003e(\u0026query)\n            .bind(item.id)\n            .bind(item.weekday)\n            .bind(item.starts_on)\n            .bind(item.ends_on)\n            .bind(item.enforced_from)\n            .bind(item.enforced_to)\n            .bind(item.updated_at)\n            .fetch_one(db)\n            .await?;\n        Ok(row)\n    }\n\n    async fn delete(\u0026self, db: \u0026PgPool, id: WeeklyHolidayId) -\u003e Result\u003c(), AppError\u003e {\n        let query = format!(\"DELETE FROM {} WHERE id = $1\", TABLE_NAME);\n        let result = sqlx::query(\u0026query).bind(id).execute(db).await?;\n        if result.rows_affected() == 0 {\n            return Err(AppError::NotFound(\"Weekly holiday not found\".into()));\n        }\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn weekly_holiday_repository_new_returns_instance() {\n        let repo = WeeklyHolidayRepository::new();\n        let _repo = repo;\n    }\n\n    #[test]\n    fn base_select_query_contains_table_name() {\n        let query = WeeklyHolidayRepository::base_select_query();\n        assert!(query.contains(\"SELECT\"));\n        assert!(query.contains(TABLE_NAME));\n    }\n\n    #[test]\n    fn base_select_query_contains_columns() {\n        let query = WeeklyHolidayRepository::base_select_query();\n        assert!(query.contains(\"weekday\"));\n        assert!(query.contains(\"enforced_from\"));\n        assert!(query.contains(\"enforced_to\"));\n    }\n\n    #[test]\n    fn constants_are_defined() {\n        assert_eq!(TABLE_NAME, \"weekly_holidays\");\n        assert!(SELECT_COLUMNS.contains(\"weekday\"));\n        assert!(SELECT_COLUMNS.contains(\"starts_on\"));\n    }\n}\n","traces":[{"line":24,"address":[21667984],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[21667997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[20316016,20316051,20316139,20316603,20316181],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":34,"address":[20316228],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[20316132],"length":1,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[20316839,20316999,20316497,20316560,20316780,20316413],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[20316525],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[20316828,20316951,20316548,20316640,20316166,20316587],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[20317117],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[21671552],"length":1,"stats":{"Line":0},"fn_name":"find_by_id"},{"line":49,"address":[20309619,20309520],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[20309810,20311109,20310210,20310751,20310805,20311131,20310301,20310471,20309894,20310001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[20309938],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[20309966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[20309989,20310081,20310423,20310290,20309554,20310028],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[20310728,20311150,20310773,20311136],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":55,"address":[20310955],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[21671618,21671600],"length":1,"stats":{"Line":0},"fn_name":"create"},{"line":59,"address":[20311360,20311493],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[20311719,20311635,20312148,20312351,20312442,20312612],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[20311731],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[20311779],"length":1,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[20311810],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[20311840],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[20311871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[20311902],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[20311933],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[20311981],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[20312039],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[20312113],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[21101623],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[20312778],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[21671696,21671714],"length":1,"stats":{"Line":0},"fn_name":"update"},{"line":81,"address":[20314512,20314645],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[20314791,20315401,20314875,20315492,20315198,20315662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[20314887],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[20314935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[20314966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[20314996],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[20315027],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[20315058],"length":1,"stats":{"Line":0},"fn_name":null},{"line":93,"address":[20315089],"length":1,"stats":{"Line":0},"fn_name":null},{"line":94,"address":[20315163],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[20315186,20315225,20315272,20315614,20314588,20315481],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[20315828],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[20314368,20313114,20313540,20312995,20312960,20313156],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":100,"address":[20313198,20313080],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[20313302,20313141,20314366,20313571,20313378],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[20314039],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[20314219,20314104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[20314077],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":2,"coverable":51},{"path":["/","home","marra","projects","timekeeper","backend","src","services","audit_log.rs"],"content":"use chrono::{DateTime, Utc};\nuse serde_json::Value;\nuse sqlx::{types::Json, PgPool};\n\nuse crate::types::{AuditLogId, UserId};\nuse crate::{models::audit_log::AuditLog, repositories::audit_log};\n\n#[derive(Debug, Clone)]\npub struct AuditLogEntry {\n    pub occurred_at: DateTime\u003cUtc\u003e,\n    pub actor_id: Option\u003cUserId\u003e,\n    pub actor_type: String,\n    pub event_type: String,\n    pub target_type: Option\u003cString\u003e,\n    pub target_id: Option\u003cString\u003e,\n    pub result: String,\n    pub error_code: Option\u003cString\u003e,\n    pub metadata: Option\u003cValue\u003e,\n    pub ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub request_id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct AuditLogService {\n    pool: PgPool,\n}\n\nimpl AuditLogService {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n}\n\n#[async_trait::async_trait]\npub trait AuditLogServiceTrait: Send + Sync {\n    async fn record_event(\u0026self, entry: AuditLogEntry) -\u003e Result\u003c(), sqlx::Error\u003e;\n    async fn delete_logs_before(\u0026self, cutoff: DateTime\u003cUtc\u003e) -\u003e Result\u003cu64, sqlx::Error\u003e;\n}\n\n#[async_trait::async_trait]\nimpl AuditLogServiceTrait for AuditLogService {\n    async fn record_event(\u0026self, entry: AuditLogEntry) -\u003e Result\u003c(), sqlx::Error\u003e {\n        let log = AuditLog {\n            id: AuditLogId::new(),\n            occurred_at: entry.occurred_at,\n            actor_id: entry.actor_id,\n            actor_type: entry.actor_type,\n            event_type: entry.event_type,\n            target_type: entry.target_type,\n            target_id: entry.target_id,\n            result: entry.result,\n            error_code: entry.error_code,\n            metadata: entry.metadata.map(Json),\n            ip: entry.ip,\n            user_agent: entry.user_agent,\n            request_id: entry.request_id,\n        };\n\n        audit_log::insert_audit_log(\u0026self.pool, \u0026log).await\n    }\n\n    async fn delete_logs_before(\u0026self, cutoff: DateTime\u003cUtc\u003e) -\u003e Result\u003cu64, sqlx::Error\u003e {\n        audit_log::delete_audit_logs_before(\u0026self.pool, cutoff).await\n    }\n}\n","traces":[{"line":30,"address":[18337680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[18331967],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22940031],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[22940186],"length":1,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[22940214],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[22940242],"length":1,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[22940279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[22940316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[22940353],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[22940390],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[22940427],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[22940464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[22940578],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[22940615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[22940652],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[21063853],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[18332047],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[21067815],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":18},{"path":["/","home","marra","projects","timekeeper","backend","src","services","consent_log.rs"],"content":"use chrono::{DateTime, Utc};\nuse sqlx::PgPool;\n\nuse crate::repositories::consent_log;\n\n#[derive(Debug, Clone)]\npub struct ConsentLogService {\n    pool: PgPool,\n}\n\nimpl ConsentLogService {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    pub async fn delete_logs_before(\u0026self, cutoff: DateTime\u003cUtc\u003e) -\u003e Result\u003cu64, sqlx::Error\u003e {\n        consent_log::delete_consent_logs_before(\u0026self.pool, cutoff).await\n    }\n}\n","traces":[{"line":12,"address":[21385904],"length":1,"stats":{"Line":0},"fn_name":null},{"line":16,"address":[21385856,21385864],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[22512814,22512964,22512740,22512881],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":3},{"path":["/","home","marra","projects","timekeeper","backend","src","services","holiday.rs"],"content":"use std::{\n    collections::{BTreeSet, HashMap},\n    future::Future,\n    pin::Pin,\n    sync::Arc,\n};\n\nuse chrono::{Datelike, Duration, NaiveDate};\nuse sqlx::{PgPool, Row};\n\ntype SourceLoader = Arc\u003c\n    dyn Fn(\n            NaiveDate,\n            NaiveDate,\n            Option\u003c\u0026str\u003e,\n        ) -\u003e Pin\u003cBox\u003cdyn Future\u003cOutput = sqlx::Result\u003cHolidaySources\u003e\u003e + Send + 'static\u003e\u003e\n        + Send\n        + Sync,\n\u003e;\n\n#[derive(Clone)]\npub struct HolidayService {\n    load_sources: SourceLoader,\n}\n\nimpl HolidayService {\n    pub fn new(pool: PgPool) -\u003e Self {\n        let load_sources =\n            move |window_start: NaiveDate, window_end: NaiveDate, user_id: Option\u003c\u0026str\u003e| {\n                let pool = pool.clone();\n                let user_id = user_id.map(str::to_owned);\n                Box::pin(async move {\n                    load_sources_from_db(\u0026pool, window_start, window_end, user_id.as_deref()).await\n                })\n                    as Pin\u003cBox\u003cdyn Future\u003cOutput = sqlx::Result\u003cHolidaySources\u003e\u003e + Send + 'static\u003e\u003e\n            };\n\n        Self {\n            load_sources: Arc::new(load_sources),\n        }\n    }\n\n    fn with_loader\u003cF, Fut\u003e(loader: F) -\u003e Self\n    where\n        F: Fn(NaiveDate, NaiveDate, Option\u003c\u0026str\u003e) -\u003e Fut + Send + Sync + 'static,\n        Fut: Future\u003cOutput = sqlx::Result\u003cHolidaySources\u003e\u003e + Send + 'static,\n    {\n        Self {\n            load_sources: Arc::new(move |window_start, window_end, user_id| {\n                let user_id = user_id.map(str::to_owned);\n                Box::pin(loader(window_start, window_end, user_id.as_deref()))\n                    as Pin\u003cBox\u003cdyn Future\u003cOutput = sqlx::Result\u003cHolidaySources\u003e\u003e + Send + 'static\u003e\u003e\n            }),\n        }\n    }\n}\n\n#[async_trait::async_trait]\npub trait HolidayServiceTrait: Send + Sync {\n    async fn is_holiday(\n        \u0026self,\n        date: NaiveDate,\n        user_id: Option\u003c\u0026str\u003e,\n    ) -\u003e sqlx::Result\u003cHolidayDecision\u003e;\n\n    async fn list_month(\n        \u0026self,\n        year: i32,\n        month: u32,\n        user_id: Option\u003c\u0026str\u003e,\n    ) -\u003e sqlx::Result\u003cVec\u003cHolidayCalendarEntry\u003e\u003e;\n}\n\n#[async_trait::async_trait]\nimpl HolidayServiceTrait for HolidayService {\n    async fn is_holiday(\n        \u0026self,\n        date: NaiveDate,\n        user_id: Option\u003c\u0026str\u003e,\n    ) -\u003e sqlx::Result\u003cHolidayDecision\u003e {\n        let end = date\n            .succ_opt()\n            .ok_or_else(|| sqlx::Error::Protocol(\"date overflow\".into()))?;\n        let sources = (self.load_sources)(date, end, user_id).await?;\n        Ok(sources.decision_for(date))\n    }\n\n    async fn list_month(\n        \u0026self,\n        year: i32,\n        month: u32,\n        user_id: Option\u003c\u0026str\u003e,\n    ) -\u003e sqlx::Result\u003cVec\u003cHolidayCalendarEntry\u003e\u003e {\n        let (window_start, window_end) = month_bounds(year, month)?;\n        let sources = (self.load_sources)(window_start, window_end, user_id).await?;\n\n        let mut cursor = window_start;\n        let mut entries = Vec::new();\n        while cursor \u003c window_end {\n            if let Some(entry) = sources.entry_for(cursor) {\n                entries.push(entry);\n            }\n            cursor = cursor\n                .succ_opt()\n                .ok_or_else(|| sqlx::Error::Protocol(\"date overflow\".into()))?;\n        }\n\n        Ok(entries)\n    }\n}\n\nasync fn load_sources_from_db(\n    pool: \u0026PgPool,\n    window_start: NaiveDate,\n    window_end: NaiveDate,\n    user_id: Option\u003c\u0026str\u003e,\n) -\u003e sqlx::Result\u003cHolidaySources\u003e {\n    ensure_valid_window(window_start, window_end)?;\n\n    let mut sources = HolidaySources::default();\n    let last_inclusive = window_end\n        .pred_opt()\n        .ok_or_else(|| sqlx::Error::Protocol(\"invalid calendar window\".into()))?;\n\n    let public_rows = sqlx::query(\n        r#\"\n        SELECT holiday_date\n        FROM holidays\n        WHERE holiday_date \u003e= $1\n          AND holiday_date \u003c= $2\n        ORDER BY holiday_date\n        \"#,\n    )\n    .bind(window_start)\n    .bind(last_inclusive)\n    .fetch_all(pool)\n    .await?;\n\n    for row in public_rows {\n        let date: NaiveDate = row.try_get(\"holiday_date\")?;\n        sources.public_holidays.insert(date);\n    }\n\n    let weekly_rows = sqlx::query(\n        r#\"\n        SELECT weekday, enforced_from, enforced_to\n        FROM weekly_holidays\n        WHERE enforced_from \u003c= $1\n          AND (enforced_to IS NULL OR enforced_to \u003e= $2)\n        \"#,\n    )\n    .bind(last_inclusive)\n    .bind(window_start)\n    .fetch_all(pool)\n    .await?;\n\n    for row in weekly_rows {\n        let weekday: i16 = row.try_get(\"weekday\")?;\n        let enforced_from: NaiveDate = row.try_get(\"enforced_from\")?;\n        let enforced_to: Option\u003cNaiveDate\u003e = row.try_get(\"enforced_to\")?;\n        let dates = expand_weekly_dates(\n            weekday,\n            enforced_from,\n            enforced_to,\n            window_start,\n            window_end,\n        );\n        sources.weekly_holidays.extend(dates);\n    }\n\n    if let Some(user_id) = user_id {\n        let exception_rows = sqlx::query(\n            r#\"\n            SELECT exception_date, override\n            FROM holiday_exceptions\n            WHERE user_id = $1\n              AND exception_date \u003e= $2\n              AND exception_date \u003c= $3\n            \"#,\n        )\n        .bind(user_id)\n        .bind(window_start)\n        .bind(last_inclusive)\n        .fetch_all(pool)\n        .await?;\n\n        for row in exception_rows {\n            let exception_date: NaiveDate = row.try_get(\"exception_date\")?;\n            let override_value: bool = row.try_get(\"override\")?;\n            sources\n                .exception_overrides\n                .insert(exception_date, override_value);\n        }\n    }\n\n    Ok(sources)\n}\n\n#[derive(Debug, Clone, PartialEq, Eq)]\npub struct HolidayDecision {\n    pub is_holiday: bool,\n    pub reason: HolidayReason,\n}\n\n#[derive(Debug, Clone, PartialEq, Eq)]\npub enum HolidayReason {\n    PublicHoliday,\n    WeeklyHoliday,\n    ExceptionOverride,\n    None,\n}\n\nimpl HolidayReason {\n    pub fn label(\u0026self) -\u003e \u0026'static str {\n        match self {\n            HolidayReason::PublicHoliday =\u003e \"public holiday\",\n            HolidayReason::WeeklyHoliday =\u003e \"weekly holiday\",\n            HolidayReason::ExceptionOverride =\u003e \"forced holiday\",\n            HolidayReason::None =\u003e \"working day\",\n        }\n    }\n}\n\n#[derive(Debug, Clone, PartialEq, Eq)]\npub struct HolidayCalendarEntry {\n    pub date: NaiveDate,\n    pub is_holiday: bool,\n    pub reason: HolidayReason,\n}\n\n#[derive(Default, Clone)]\nstruct HolidaySources {\n    public_holidays: BTreeSet\u003cNaiveDate\u003e,\n    weekly_holidays: BTreeSet\u003cNaiveDate\u003e,\n    exception_overrides: HashMap\u003cNaiveDate, bool\u003e,\n}\n\n#[allow(dead_code)]\npub struct HolidayServiceStub {\n    sources: Arc\u003cHolidaySources\u003e,\n}\n\n#[allow(dead_code)]\nimpl HolidayServiceStub {\n    pub fn new(\n        public_holidays: impl IntoIterator\u003cItem = NaiveDate\u003e,\n        weekly_holidays: impl IntoIterator\u003cItem = NaiveDate\u003e,\n        exception_overrides: impl IntoIterator\u003cItem = (NaiveDate, bool)\u003e,\n    ) -\u003e Self {\n        let sources = HolidaySources {\n            public_holidays: public_holidays.into_iter().collect(),\n            weekly_holidays: weekly_holidays.into_iter().collect(),\n            exception_overrides: exception_overrides.into_iter().collect(),\n        };\n\n        Self {\n            sources: Arc::new(sources),\n        }\n    }\n\n    pub fn service(\u0026self) -\u003e HolidayService {\n        let sources = Arc::clone(\u0026self.sources);\n\n        HolidayService::with_loader(move |window_start, window_end, _| {\n            let sources = Arc::clone(\u0026sources);\n\n            async move {\n                ensure_valid_window(window_start, window_end)?;\n                Ok((*sources).clone())\n            }\n        })\n    }\n}\n\nimpl HolidaySources {\n    fn decision_for(\u0026self, date: NaiveDate) -\u003e HolidayDecision {\n        if let Some(\u0026flag) = self.exception_overrides.get(\u0026date) {\n            return HolidayDecision {\n                is_holiday: flag,\n                reason: HolidayReason::ExceptionOverride,\n            };\n        }\n\n        if self.public_holidays.contains(\u0026date) {\n            return HolidayDecision {\n                is_holiday: true,\n                reason: HolidayReason::PublicHoliday,\n            };\n        }\n\n        if self.weekly_holidays.contains(\u0026date) {\n            return HolidayDecision {\n                is_holiday: true,\n                reason: HolidayReason::WeeklyHoliday,\n            };\n        }\n\n        HolidayDecision {\n            is_holiday: false,\n            reason: HolidayReason::None,\n        }\n    }\n\n    fn entry_for(\u0026self, date: NaiveDate) -\u003e Option\u003cHolidayCalendarEntry\u003e {\n        let decision = self.decision_for(date);\n        decision.is_holiday.then_some(HolidayCalendarEntry {\n            date,\n            is_holiday: true,\n            reason: decision.reason,\n        })\n    }\n}\n\nfn month_bounds(year: i32, month: u32) -\u003e sqlx::Result\u003c(NaiveDate, NaiveDate)\u003e {\n    let start = NaiveDate::from_ymd_opt(year, month, 1)\n        .ok_or_else(|| sqlx::Error::Protocol(format!(\"invalid year/month: {}/{}\", year, month)))?;\n\n    let (next_year, next_month) = if month == 12 {\n        (year + 1, 1)\n    } else {\n        (year, month + 1)\n    };\n\n    let end = NaiveDate::from_ymd_opt(next_year, next_month, 1).ok_or_else(|| {\n        sqlx::Error::Protocol(format!(\"invalid year/month: {}/{}\", next_year, next_month))\n    })?;\n\n    Ok((start, end))\n}\n\nfn ensure_valid_window(window_start: NaiveDate, window_end: NaiveDate) -\u003e sqlx::Result\u003c()\u003e {\n    if window_start \u003e= window_end {\n        Err(sqlx::Error::Protocol(\n            \"invalid calendar window: start must be before end\".into(),\n        ))\n    } else {\n        Ok(())\n    }\n}\n\nfn expand_weekly_dates(\n    weekday: i16,\n    enforced_from: NaiveDate,\n    enforced_to: Option\u003cNaiveDate\u003e,\n    window_start: NaiveDate,\n    window_end: NaiveDate,\n) -\u003e Vec\u003cNaiveDate\u003e {\n    let mut result = Vec::new();\n    if window_start \u003e= window_end {\n        return result;\n    }\n\n    let target_weekday = (weekday.rem_euclid(7)) as u32;\n    let mut effective_start = enforced_from.max(window_start);\n    let last_inclusive = match enforced_to {\n        Some(limit) =\u003e limit.min(\n            window_end\n                .pred_opt()\n                .expect(\"window_end must be greater than start\"),\n        ),\n        None =\u003e window_end\n            .pred_opt()\n            .expect(\"window_end must be greater than start\"),\n    };\n\n    if effective_start \u003e last_inclusive {\n        return result;\n    }\n\n    effective_start = align_weekday_on_or_after(effective_start, target_weekday);\n    if effective_start \u003e last_inclusive {\n        return result;\n    }\n\n    let mut cursor = effective_start;\n    while cursor \u003c= last_inclusive {\n        result.push(cursor);\n        cursor += Duration::days(7);\n    }\n\n    result\n}\n\nfn align_weekday_on_or_after(date: NaiveDate, weekday: u32) -\u003e NaiveDate {\n    let current = date.weekday().num_days_from_sunday();\n    let diff = (weekday + 7 - current) % 7;\n    date + Duration::days(diff as i64)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn holiday_reason_label_returns_correct_strings() {\n        assert_eq!(HolidayReason::PublicHoliday.label(), \"public holiday\");\n        assert_eq!(HolidayReason::WeeklyHoliday.label(), \"weekly holiday\");\n        assert_eq!(HolidayReason::ExceptionOverride.label(), \"forced holiday\");\n        assert_eq!(HolidayReason::None.label(), \"working day\");\n    }\n\n    #[test]\n    fn month_bounds_returns_correct_range() {\n        let result = month_bounds(2024, 1).unwrap();\n        assert_eq!(result.0, NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert_eq!(result.1, NaiveDate::from_ymd_opt(2024, 2, 1).unwrap());\n    }\n\n    #[test]\n    fn month_bounds_handles_december() {\n        let result = month_bounds(2024, 12).unwrap();\n        assert_eq!(result.0, NaiveDate::from_ymd_opt(2024, 12, 1).unwrap());\n        assert_eq!(result.1, NaiveDate::from_ymd_opt(2025, 1, 1).unwrap());\n    }\n\n    #[test]\n    fn month_bounds_invalid_month_returns_error() {\n        let result = month_bounds(2024, 13);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn ensure_valid_window_accepts_valid_range() {\n        let start = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let end = NaiveDate::from_ymd_opt(2024, 2, 1).unwrap();\n        assert!(ensure_valid_window(start, end).is_ok());\n    }\n\n    #[test]\n    fn ensure_valid_window_rejects_invalid_range() {\n        let start = NaiveDate::from_ymd_opt(2024, 2, 1).unwrap();\n        let end = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        assert!(ensure_valid_window(start, end).is_err());\n    }\n\n    #[test]\n    fn ensure_valid_window_rejects_equal_dates() {\n        let date = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        assert!(ensure_valid_window(date, date).is_err());\n    }\n\n    #[test]\n    fn align_weekday_on_or_after_same_day() {\n        let date = NaiveDate::from_ymd_opt(2024, 1, 8).unwrap();\n        let result = align_weekday_on_or_after(date, 1);\n        assert_eq!(result, date);\n    }\n\n    #[test]\n    fn align_weekday_on_or_after_future_day() {\n        let date = NaiveDate::from_ymd_opt(2024, 1, 8).unwrap();\n        let result = align_weekday_on_or_after(date, 3);\n        assert_eq!(result, NaiveDate::from_ymd_opt(2024, 1, 10).unwrap());\n    }\n\n    #[test]\n    fn align_weekday_on_or_after_previous_day() {\n        let date = NaiveDate::from_ymd_opt(2024, 1, 8).unwrap();\n        let result = align_weekday_on_or_after(date, 0);\n        assert_eq!(result, NaiveDate::from_ymd_opt(2024, 1, 14).unwrap());\n    }\n\n    #[test]\n    fn expand_weekly_dates_empty_window() {\n        let start = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let end = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let result = expand_weekly_dates(0, start, None, start, end);\n        assert!(result.is_empty());\n    }\n\n    #[test]\n    fn expand_weekly_dates_no_matches() {\n        let start = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let end = NaiveDate::from_ymd_opt(2024, 1, 10).unwrap();\n        let enforced_from = NaiveDate::from_ymd_opt(2024, 2, 1).unwrap();\n        let result = expand_weekly_dates(0, enforced_from, None, start, end);\n        assert!(result.is_empty());\n    }\n\n    #[test]\n    fn holiday_sources_decision_for_exception_override_true() {\n        let mut sources = HolidaySources::default();\n        sources\n            .exception_overrides\n            .insert(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap(), true);\n\n        let decision = sources.decision_for(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert!(decision.is_holiday);\n        assert_eq!(decision.reason, HolidayReason::ExceptionOverride);\n    }\n\n    #[test]\n    fn holiday_sources_decision_for_exception_override_false() {\n        let mut sources = HolidaySources::default();\n        sources\n            .exception_overrides\n            .insert(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap(), false);\n\n        let decision = sources.decision_for(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert!(!decision.is_holiday);\n        assert_eq!(decision.reason, HolidayReason::ExceptionOverride);\n    }\n\n    #[test]\n    fn holiday_sources_decision_for_public_holiday() {\n        let mut sources = HolidaySources::default();\n        sources\n            .public_holidays\n            .insert(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n\n        let decision = sources.decision_for(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert!(decision.is_holiday);\n        assert_eq!(decision.reason, HolidayReason::PublicHoliday);\n    }\n\n    #[test]\n    fn holiday_sources_decision_for_weekly_holiday() {\n        let mut sources = HolidaySources::default();\n        sources\n            .weekly_holidays\n            .insert(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n\n        let decision = sources.decision_for(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert!(decision.is_holiday);\n        assert_eq!(decision.reason, HolidayReason::WeeklyHoliday);\n    }\n\n    #[test]\n    fn holiday_sources_decision_for_working_day() {\n        let sources = HolidaySources::default();\n\n        let decision = sources.decision_for(NaiveDate::from_ymd_opt(2024, 1, 2).unwrap());\n        assert!(!decision.is_holiday);\n        assert_eq!(decision.reason, HolidayReason::None);\n    }\n\n    #[test]\n    fn holiday_sources_entry_for_returns_some_for_holiday() {\n        let mut sources = HolidaySources::default();\n        sources\n            .public_holidays\n            .insert(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n\n        let entry = sources.entry_for(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert!(entry.is_some());\n        let entry = entry.unwrap();\n        assert!(entry.is_holiday);\n        assert_eq!(entry.date, NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n    }\n\n    #[test]\n    fn holiday_sources_entry_for_returns_none_for_working_day() {\n        let sources = HolidaySources::default();\n\n        let entry = sources.entry_for(NaiveDate::from_ymd_opt(2024, 1, 2).unwrap());\n        assert!(entry.is_none());\n    }\n\n    #[test]\n    fn holiday_service_stub_new_creates_stub() {\n        let stub = HolidayServiceStub::new(\n            vec![NaiveDate::from_ymd_opt(2024, 1, 1).unwrap()],\n            vec![],\n            vec![],\n        );\n\n        let service = stub.service();\n        let _service = service;\n        let _stub = stub;\n    }\n\n    #[test]\n    fn holiday_decision_implements_partial_eq() {\n        let decision1 = HolidayDecision {\n            is_holiday: true,\n            reason: HolidayReason::PublicHoliday,\n        };\n        let decision2 = HolidayDecision {\n            is_holiday: true,\n            reason: HolidayReason::PublicHoliday,\n        };\n\n        assert_eq!(decision1, decision2);\n    }\n\n    #[test]\n    fn holiday_calendar_entry_has_fields() {\n        let entry = HolidayCalendarEntry {\n            date: NaiveDate::from_ymd_opt(2024, 1, 1).unwrap(),\n            is_holiday: true,\n            reason: HolidayReason::PublicHoliday,\n        };\n\n        assert_eq!(entry.date, NaiveDate::from_ymd_opt(2024, 1, 1).unwrap());\n        assert!(entry.is_holiday);\n        assert_eq!(entry.reason, HolidayReason::PublicHoliday);\n    }\n\n    #[test]\n    fn expand_weekly_dates_with_enforced_to() {\n        let start = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let end = NaiveDate::from_ymd_opt(2024, 1, 31).unwrap();\n        let enforced_from = NaiveDate::from_ymd_opt(2024, 1, 1).unwrap();\n        let enforced_to = NaiveDate::from_ymd_opt(2024, 1, 15).unwrap();\n        let result = expand_weekly_dates(0, enforced_from, Some(enforced_to), start, end);\n\n        assert!(!result.is_empty());\n        assert!(result.len() \u003c= 3);\n        assert!(result.iter().all(|d| *d \u003e= start \u0026\u0026 *d \u003c enforced_to));\n    }\n}\n","traces":[{"line":27,"address":[23068480],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[23068489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[20218615],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[20218647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[20218899,20218864,20219182,20219622,20219000,20219516,20218712,20218607],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":33,"address":[20219213,20219110,20218947,20219027],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[23068494],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[20218192],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[20218524,20218518,20218224,20218197],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}\u003ctimekeeper_backend::services::holiday::{impl#2}::service::{closure_env#0}, timekeeper_backend::services::holiday::{impl#2}::service::{closure#0}::{async_block_env#0}\u003e"},{"line":76,"address":[20213376,20213520,20213749,20214228,20215122,20215127,20213417,20213701],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":81,"address":[20213823,20213919,20214223],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[20213800,20213871,20215166,20215152],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":84,"address":[20214259,20214023,20215133,20213550],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[20215046,20214972],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[20217168,20215600,20215305,20217585,20215408,20215648,20216128,20215264],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":94,"address":[20215703,20216123,20215588],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[21058612],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[20216872],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[20216890,20216937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[20216944,20217012,20217547],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[20217115,20217178],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[20217245,20217319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[20217448,20217356],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[20217308],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[20217333,20217600,20217400,20217614],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":108,"address":[20217018],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[23069888],"length":1,"stats":{"Line":0},"fn_name":"load_sources_from_db"},{"line":118,"address":[20222147,20221246,20221387],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[20221576],"length":1,"stats":{"Line":0},"fn_name":null},{"line":121,"address":[20222133,20221774,20221588,20221678],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[20227648,20221655,20221726,20227662],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":134,"address":[20221955],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[20221989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":136,"address":[20222023],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[20980402],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[20223000,20222766,20222873],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[20223117,20223483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[20223672],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[20223245],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[20223279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[20223313],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[20223769,20221315,20223960,20223359,20223401,20224086],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[20224398,20224291,20224525],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[20224642,20226022,20225169],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[20225387,20226020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[20225633,20225999],"length":1,"stats":{"Line":0},"fn_name":null},{"line":165,"address":[20225889],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[20225896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[20225926],"length":1,"stats":{"Line":0},"fn_name":null},{"line":171,"address":[20224700,20226987],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[20224915],"length":1,"stats":{"Line":0},"fn_name":null},{"line":182,"address":[20224947],"length":1,"stats":{"Line":0},"fn_name":null},{"line":183,"address":[20224981],"length":1,"stats":{"Line":0},"fn_name":null},{"line":184,"address":[20225015],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[20980438],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[20226812,20226581,20226685],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[20226929,20227052,20227548],"length":1,"stats":{"Line":0},"fn_name":null},{"line":189,"address":[20227527,20227247],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[20227498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[20224802],"length":1,"stats":{"Line":0},"fn_name":null},{"line":214,"address":[23068336],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[23068341],"length":1,"stats":{"Line":1},"fn_name":null},{"line":216,"address":[23068372],"length":1,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[23068395],"length":1,"stats":{"Line":1},"fn_name":null},{"line":218,"address":[23068418],"length":1,"stats":{"Line":1},"fn_name":null},{"line":219,"address":[23068441],"length":1,"stats":{"Line":1},"fn_name":null},{"line":245,"address":[20220283,20219648,20220253],"length":1,"stats":{"Line":1},"fn_name":null},{"line":251,"address":[20219800,20219697],"length":1,"stats":{"Line":2},"fn_name":null},{"line":252,"address":[20219922,20219812],"length":1,"stats":{"Line":2},"fn_name":null},{"line":253,"address":[20219934,20220044],"length":1,"stats":{"Line":2},"fn_name":null},{"line":257,"address":[20220142],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[23068816],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[23068825],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[20220320],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":265,"address":[20220376],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[20220407,20220432,20221026,20220470,20220530,20220914],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":268,"address":[20220589,20220512],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[20220769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":276,"address":[23068512],"length":1,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[23068529],"length":1,"stats":{"Line":1},"fn_name":null},{"line":278,"address":[23068588],"length":1,"stats":{"Line":1},"fn_name":null},{"line":284,"address":[23068605],"length":1,"stats":{"Line":1},"fn_name":null},{"line":285,"address":[23068662],"length":1,"stats":{"Line":1},"fn_name":null},{"line":291,"address":[23068642],"length":1,"stats":{"Line":1},"fn_name":null},{"line":292,"address":[23068686],"length":1,"stats":{"Line":1},"fn_name":null},{"line":304,"address":[23068704],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[23068721],"length":1,"stats":{"Line":1},"fn_name":null},{"line":306,"address":[23068743],"length":1,"stats":{"Line":1},"fn_name":null},{"line":314,"address":[23067712],"length":1,"stats":{"Line":1},"fn_name":"month_bounds"},{"line":315,"address":[23067737,23067778,23067850],"length":1,"stats":{"Line":3},"fn_name":null},{"line":316,"address":[20217749,20217712],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":318,"address":[23067993,23068008,23067921,23068174],"length":1,"stats":{"Line":4},"fn_name":null},{"line":319,"address":[23068156,23068179,23067947],"length":1,"stats":{"Line":2},"fn_name":null},{"line":321,"address":[23067975,23067995,23067928],"length":1,"stats":{"Line":2},"fn_name":null},{"line":324,"address":[20217952],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":325,"address":[20217989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":328,"address":[23068294],"length":1,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[23068848],"length":1,"stats":{"Line":1},"fn_name":"ensure_valid_window"},{"line":332,"address":[23068906,23068869],"length":1,"stats":{"Line":2},"fn_name":null},{"line":333,"address":[23068942],"length":1,"stats":{"Line":1},"fn_name":null},{"line":334,"address":[23068908],"length":1,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[23068893],"length":1,"stats":{"Line":1},"fn_name":null},{"line":341,"address":[23069857,23069863,23069024],"length":1,"stats":{"Line":1},"fn_name":"expand_weekly_dates"},{"line":348,"address":[23069082],"length":1,"stats":{"Line":1},"fn_name":null},{"line":349,"address":[23069096,23069166],"length":1,"stats":{"Line":2},"fn_name":null},{"line":350,"address":[23069209],"length":1,"stats":{"Line":1},"fn_name":null},{"line":353,"address":[23069177,23069252],"length":1,"stats":{"Line":2},"fn_name":null},{"line":354,"address":[23069264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":355,"address":[23069294],"length":1,"stats":{"Line":1},"fn_name":null},{"line":356,"address":[23069318,23069491],"length":1,"stats":{"Line":2},"fn_name":null},{"line":358,"address":[23069338],"length":1,"stats":{"Line":1},"fn_name":null},{"line":359,"address":[23069449],"length":1,"stats":{"Line":1},"fn_name":null},{"line":361,"address":[23069407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":366,"address":[23069523,23069414],"length":1,"stats":{"Line":2},"fn_name":null},{"line":367,"address":[23069556],"length":1,"stats":{"Line":1},"fn_name":null},{"line":370,"address":[23069533,23069594],"length":1,"stats":{"Line":2},"fn_name":null},{"line":371,"address":[23069601],"length":1,"stats":{"Line":1},"fn_name":null},{"line":372,"address":[23069663],"length":1,"stats":{"Line":0},"fn_name":null},{"line":375,"address":[23069642],"length":1,"stats":{"Line":1},"fn_name":null},{"line":376,"address":[23069656,23069694],"length":1,"stats":{"Line":2},"fn_name":null},{"line":377,"address":[23069771],"length":1,"stats":{"Line":1},"fn_name":null},{"line":378,"address":[23069812],"length":1,"stats":{"Line":1},"fn_name":null},{"line":381,"address":[23069740],"length":1,"stats":{"Line":1},"fn_name":null},{"line":384,"address":[23069952],"length":1,"stats":{"Line":1},"fn_name":"align_weekday_on_or_after"},{"line":385,"address":[23069968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":386,"address":[23070097,23070006],"length":1,"stats":{"Line":1},"fn_name":null},{"line":387,"address":[23070071],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":63,"coverable":127},{"path":["/","home","marra","projects","timekeeper","backend","src","services","holiday_exception.rs"],"content":"use chrono::NaiveDate;\nuse sqlx::PgPool;\n\nuse crate::types::{HolidayExceptionId, UserId};\nuse crate::{\n    models::holiday_exception::{CreateHolidayExceptionPayload, HolidayException},\n    repositories::{holiday_exception as holiday_exception_repo, user as user_repo},\n};\n\n#[derive(Debug)]\npub enum HolidayExceptionError {\n    Conflict,\n    NotFound,\n    UserNotFound,\n    Database(sqlx::Error),\n}\n\n#[derive(Clone)]\npub struct HolidayExceptionService {\n    pool: PgPool,\n}\n\nimpl HolidayExceptionService {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n}\n\n#[async_trait::async_trait]\npub trait HolidayExceptionServiceTrait: Send + Sync {\n    async fn list_for_user(\n        \u0026self,\n        user_id: UserId,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n    ) -\u003e Result\u003cVec\u003cHolidayException\u003e, HolidayExceptionError\u003e;\n\n    async fn create_workday_override(\n        \u0026self,\n        user_id: UserId,\n        payload: CreateHolidayExceptionPayload,\n        created_by: UserId,\n    ) -\u003e Result\u003cHolidayException, HolidayExceptionError\u003e;\n\n    async fn delete_for_user(\n        \u0026self,\n        id: HolidayExceptionId,\n        user_id: UserId,\n    ) -\u003e Result\u003c(), HolidayExceptionError\u003e;\n}\n\n#[async_trait::async_trait]\nimpl HolidayExceptionServiceTrait for HolidayExceptionService {\n    async fn list_for_user(\n        \u0026self,\n        user_id: UserId,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n    ) -\u003e Result\u003cVec\u003cHolidayException\u003e, HolidayExceptionError\u003e {\n        if !self.user_exists(user_id).await? {\n            return Err(HolidayExceptionError::UserNotFound);\n        }\n        let result =\n            holiday_exception_repo::list_holiday_exceptions_for_user(\u0026self.pool, user_id, from, to)\n                .await?;\n        Ok(result)\n    }\n\n    async fn create_workday_override(\n        \u0026self,\n        user_id: UserId,\n        payload: CreateHolidayExceptionPayload,\n        created_by: UserId,\n    ) -\u003e Result\u003cHolidayException, HolidayExceptionError\u003e {\n        if !self.user_exists(user_id).await? {\n            return Err(HolidayExceptionError::UserNotFound);\n        }\n\n        let exception =\n            HolidayException::new(user_id, payload.exception_date, payload.reason, created_by);\n\n        holiday_exception_repo::insert_holiday_exception(\u0026self.pool, \u0026exception)\n            .await\n            .map_err(map_unique_violation)?;\n\n        Ok(exception)\n    }\n\n    async fn delete_for_user(\n        \u0026self,\n        id: HolidayExceptionId,\n        user_id: UserId,\n    ) -\u003e Result\u003c(), HolidayExceptionError\u003e {\n        let affected =\n            holiday_exception_repo::delete_holiday_exception(\u0026self.pool, id, user_id).await?;\n\n        if affected == 0 {\n            Err(HolidayExceptionError::NotFound)\n        } else {\n            Ok(())\n        }\n    }\n}\n\nimpl HolidayExceptionService {\n    async fn user_exists(\u0026self, user_id: UserId) -\u003e Result\u003cbool, HolidayExceptionError\u003e {\n        let exists = user_repo::user_exists(\u0026self.pool, \u0026user_id.to_string()).await?;\n        Ok(exists)\n    }\n}\n\nfn map_unique_violation(err: sqlx::Error) -\u003e HolidayExceptionError {\n    if let sqlx::Error::Database(db_err) = \u0026err {\n        if db_err.constraint() == Some(\"holiday_exceptions_user_date_key\") {\n            return HolidayExceptionError::Conflict;\n        }\n    }\n    HolidayExceptionError::Database(err)\n}\n\nimpl From\u003csqlx::Error\u003e for HolidayExceptionError {\n    fn from(value: sqlx::Error) -\u003e Self {\n        HolidayExceptionError::Database(value)\n    }\n}\n","traces":[{"line":24,"address":[22236928],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[18677502,18677675,18677411,18677539,18677720,18677830,18677376,18678503,18679097],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":60,"address":[21081935],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[18678327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[18678381,18678657,18678716,18678455,18679102,18678876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[21081950],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[18679005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[22236431],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[18680527,18681564,18680650,18680390,18680742],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[18681217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[18681290],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[18681729,18681515,18681791,18681878,18681417,18681974],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[21088030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[18681855,18681926],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[18682060],"length":1,"stats":{"Line":0},"fn_name":null},{"line":89,"address":[18679487,18679155,18679599,18679439,18679120,18680190,18679249,18680180],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":94,"address":[21082871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[18680084,18680108],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[18680110],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[18680090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[18686368,18686403,18686535,18686493,18686740,18687333],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":107,"address":[18686608,18686582,18686482,18686520,18686771,18687318],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[18687238],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[22236854,22236560],"length":1,"stats":{"Line":0},"fn_name":"map_unique_violation"},{"line":113,"address":[22236582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[22236646,22236762],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[22236822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[22236680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[22236224],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":123,"address":[22236232],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":30},{"path":["/","home","marra","projects","timekeeper","backend","src","services","mod.rs"],"content":"pub mod audit_log;\npub mod consent_log;\npub mod holiday;\npub mod holiday_exception;\npub mod token_cache;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","services","token_cache.rs"],"content":"use crate::db::redis::RedisPool;\nuse crate::types::UserId;\nuse async_trait::async_trait;\nuse bb8_redis::redis::{self, AsyncCommands};\n\n#[async_trait]\npub trait TokenCacheServiceTrait: Send + Sync {\n    async fn cache_token(\u0026self, jti: \u0026str, user_id: UserId, ttl_seconds: u64)\n        -\u003e anyhow::Result\u003c()\u003e;\n    async fn is_token_active(\u0026self, jti: \u0026str) -\u003e anyhow::Result\u003cOption\u003cbool\u003e\u003e;\n    async fn invalidate_token(\u0026self, jti: \u0026str) -\u003e anyhow::Result\u003c()\u003e;\n    async fn invalidate_user_tokens(\u0026self, user_id: UserId) -\u003e anyhow::Result\u003c()\u003e;\n}\n\npub struct TokenCacheService {\n    pool: RedisPool,\n}\n\nimpl TokenCacheService {\n    pub fn new(pool: RedisPool) -\u003e Self {\n        Self { pool }\n    }\n\n    fn token_key(jti: \u0026str) -\u003e String {\n        format!(\"token:{}\", jti)\n    }\n\n    fn user_tokens_key(user_id: UserId) -\u003e String {\n        format!(\"user_tokens:{}\", user_id)\n    }\n}\n\n#[async_trait]\nimpl TokenCacheServiceTrait for TokenCacheService {\n    async fn cache_token(\n        \u0026self,\n        jti: \u0026str,\n        user_id: UserId,\n        ttl_seconds: u64,\n    ) -\u003e anyhow::Result\u003c()\u003e {\n        let span = tracing::debug_span!(\"redis_cache_token\", jti, %user_id);\n        let _enter = span.enter();\n\n        let mut conn = self.pool.get().await?;\n        let key = Self::token_key(jti);\n        let user_key = Self::user_tokens_key(user_id);\n\n        redis::pipe()\n            .atomic()\n            .set_ex(\u0026key, user_id.to_string(), ttl_seconds)\n            .sadd(\u0026user_key, jti)\n            .expire(\u0026user_key, ttl_seconds as i64)\n            .query_async::\u003c_, ()\u003e(\u0026mut *conn)\n            .await?;\n\n        Ok(())\n    }\n\n    async fn is_token_active(\u0026self, jti: \u0026str) -\u003e anyhow::Result\u003cOption\u003cbool\u003e\u003e {\n        let span = tracing::debug_span!(\"redis_is_token_active\", jti);\n        let _enter = span.enter();\n\n        let mut conn = self.pool.get().await?;\n        let key = Self::token_key(jti);\n        let exists: bool = conn.exists(key).await?;\n        Ok(Some(exists))\n    }\n\n    async fn invalidate_token(\u0026self, jti: \u0026str) -\u003e anyhow::Result\u003c()\u003e {\n        let span = tracing::debug_span!(\"redis_invalidate_token\", jti);\n        let _enter = span.enter();\n\n        let mut conn = self.pool.get().await?;\n        let key = Self::token_key(jti);\n\n        // We don't easily know user_id here to remove from user_tokens set\n        // but it will expire eventually. For a full logout/invalidation,\n        // we usually have the JTI.\n        conn.del::\u003c_, ()\u003e(key).await?;\n        Ok(())\n    }\n\n    async fn invalidate_user_tokens(\u0026self, user_id: UserId) -\u003e anyhow::Result\u003c()\u003e {\n        let span = tracing::debug_span!(\"redis_invalidate_user_tokens\", %user_id);\n        let _enter = span.enter();\n\n        let mut conn = self.pool.get().await?;\n        let user_key = Self::user_tokens_key(user_id);\n\n        let jtis: Vec\u003cString\u003e = conn.smembers(\u0026user_key).await?;\n        if jtis.is_empty() {\n            return Ok(());\n        }\n\n        let mut pipe = redis::pipe();\n        pipe.atomic();\n        for jti in jtis {\n            pipe.del(Self::token_key(\u0026jti));\n        }\n        pipe.del(user_key);\n\n        pipe.query_async::\u003c_, ()\u003e(\u0026mut *conn).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":20,"address":[21939680],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[21939696],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[21939720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[21939568],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[21939582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[21928999],"length":1,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[22997902,22998034,22998825],"length":1,"stats":{"Line":0},"fn_name":null},{"line":42,"address":[22998780,22999100],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[21068289],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[22999972],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[23000046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[23000210,23001336,23000873,23000136,23000791,23000530,23001059],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[23000285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[23000373],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[23000416],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[23000450],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[23001160,23000633,23000495,23000237,23000995,23000855,23000563,22997820,23001344],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[23001186],"length":1,"stats":{"Line":0},"fn_name":null},{"line":59,"address":[21929087],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[23001902,23002574,23001775],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[23002532,23002769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[21071471],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[23003701,23003623],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[23001668,23003959,23003776,23003705],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[23004483],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[21929167],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[23005039,23005723,23004907],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[23005678,23005921],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[21072017],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[23006859,23006781],"length":1,"stats":{"Line":0},"fn_name":null},{"line":79,"address":[21072033],"length":1,"stats":{"Line":0},"fn_name":null},{"line":80,"address":[23007641],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[21929231],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[23008103,23008998,23008241],"length":1,"stats":{"Line":0},"fn_name":null},{"line":85,"address":[23009251,23008947],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[23009434,23010434,23009262,23009330,23007984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[23010135,23010228],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[21074967],"length":1,"stats":{"Line":0},"fn_name":null},{"line":91,"address":[23011070,23011137],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[23011169],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[23011151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":96,"address":[23011194],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[23011267,23011458],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[23011882,23011535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[23011597],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[21074986],"length":1,"stats":{"Line":0},"fn_name":null},{"line":103,"address":[23012539],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":47},{"path":["/","home","marra","projects","timekeeper","backend","src","state.rs"],"content":"use crate::{\n    config::Config, db::connection::DbPool, db::redis::RedisPool,\n    services::token_cache::TokenCacheServiceTrait,\n};\nuse std::sync::Arc;\n\n#[derive(Clone)]\npub struct AppState {\n    pub write_pool: DbPool,\n    pub read_pool: Option\u003cDbPool\u003e,\n    pub redis_pool: Option\u003cRedisPool\u003e,\n    pub token_cache: Option\u003cArc\u003cdyn TokenCacheServiceTrait\u003e\u003e,\n    pub config: Config,\n}\n\nimpl AppState {\n    pub fn new(\n        write_pool: DbPool,\n        read_pool: Option\u003cDbPool\u003e,\n        redis_pool: Option\u003cRedisPool\u003e,\n        token_cache: Option\u003cArc\u003cdyn TokenCacheServiceTrait\u003e\u003e,\n        config: Config,\n    ) -\u003e Self {\n        Self {\n            write_pool,\n            read_pool,\n            redis_pool,\n            token_cache,\n            config,\n        }\n    }\n\n    /// Returns the read pool if configured, otherwise falls back to the write pool.\n    /// Use this for SELECT queries that don't require read-after-write consistency.\n    pub fn read_pool(\u0026self) -\u003e \u0026DbPool {\n        if self.config.feature_read_replica_enabled {\n            self.read_pool.as_ref().unwrap_or(\u0026self.write_pool)\n        } else {\n            \u0026self.write_pool\n        }\n    }\n\n    /// Returns the Redis pool if configured and enabled.\n    pub fn redis(\u0026self) -\u003e Option\u003c\u0026RedisPool\u003e {\n        if self.config.feature_redis_cache_enabled {\n            self.redis_pool.as_ref()\n        } else {\n            None\n        }\n    }\n\n    /// For backward compatibility: returns (write_pool, config) tuple.\n    /// Deprecated - use AppState directly instead.\n    pub fn into_parts(self) -\u003e (DbPool, Config) {\n        (self.write_pool, self.config)\n    }\n\n    /// For backward compatibility: returns (write_pool, config) tuple.\n    /// Deprecated - use AppState directly instead.\n    pub fn as_tuple(\u0026self) -\u003e (DbPool, Config) {\n        (self.write_pool.clone(), self.config.clone())\n    }\n}\n\nimpl From\u003cAppState\u003e for (DbPool, Config) {\n    fn from(state: AppState) -\u003e Self {\n        state.into_parts()\n    }\n}\n\nimpl From\u003c(DbPool, Config)\u003e for AppState {\n    fn from((db_pool, config): (DbPool, Config)) -\u003e Self {\n        Self::new(db_pool, None, None, None, config)\n    }\n}\n","traces":[{"line":17,"address":[20708768],"length":1,"stats":{"Line":0},"fn_name":null},{"line":35,"address":[20709136],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[20709149,20709173],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[20709179],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[20709162],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[20708880],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[20708893,20708911],"length":1,"stats":{"Line":0},"fn_name":null},{"line":46,"address":[20708917],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[20708902],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[20708480,20708736],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[20708502],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[20708944,20709109,20709103],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[20708982],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[18408144],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":67,"address":[18408161],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[20709249,20709232],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":73,"address":[20709284],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":17},{"path":["/","home","marra","projects","timekeeper","backend","src","types","id.rs"],"content":"//! Typed ID wrappers for compile-time type safety.\n//!\n//! These types wrap UUIDs to prevent accidental mixing of different entity IDs.\n\nuse serde::{Deserialize, Deserializer, Serialize, Serializer};\nuse sqlx::{Database, Decode, Encode, Type};\nuse std::fmt;\nuse std::str::FromStr;\nuse utoipa::ToSchema;\nuse uuid::Uuid;\n\n/// Macro to generate typed ID wrappers with common trait implementations.\nmacro_rules! typed_id {\n    ($name:ident, $doc:literal) =\u003e {\n        #[doc = $doc]\n        #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, ToSchema)]\n        pub struct $name(Uuid);\n\n        impl $name {\n            /// Creates a new random ID.\n            pub fn new() -\u003e Self {\n                Self(Uuid::new_v4())\n            }\n\n            /// Creates an ID from an existing UUID.\n            pub fn from_uuid(uuid: Uuid) -\u003e Self {\n                Self(uuid)\n            }\n\n            /// Returns the inner UUID.\n            pub fn as_uuid(\u0026self) -\u003e \u0026Uuid {\n                \u0026self.0\n            }\n        }\n\n        impl Default for $name {\n            fn default() -\u003e Self {\n                Self::new()\n            }\n        }\n\n        impl fmt::Display for $name {\n            fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n                write!(f, \"{}\", self.0)\n            }\n        }\n\n        impl FromStr for $name {\n            type Err = uuid::Error;\n\n            fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n                Ok(Self(Uuid::parse_str(s)?))\n            }\n        }\n\n        impl From\u003c\u0026str\u003e for $name {\n            fn from(s: \u0026str) -\u003e Self {\n                Self(Uuid::parse_str(s).expect(\"Invalid UUID string\"))\n            }\n        }\n\n        impl From\u003cString\u003e for $name {\n            fn from(s: String) -\u003e Self {\n                Self(Uuid::parse_str(\u0026s).expect(\"Invalid UUID string\"))\n            }\n        }\n\n        impl From\u003cUuid\u003e for $name {\n            fn from(uuid: Uuid) -\u003e Self {\n                Self(uuid)\n            }\n        }\n\n        impl From\u003c$name\u003e for Uuid {\n            fn from(id: $name) -\u003e Self {\n                id.0\n            }\n        }\n\n        impl From\u003c$name\u003e for String {\n            fn from(id: $name) -\u003e Self {\n                id.0.to_string()\n            }\n        }\n\n        impl Serialize for $name {\n            fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n            where\n                S: Serializer,\n            {\n                serializer.serialize_str(\u0026self.0.to_string())\n            }\n        }\n\n        impl\u003c'de\u003e Deserialize\u003c'de\u003e for $name {\n            fn deserialize\u003cD\u003e(deserializer: D) -\u003e Result\u003cSelf, D::Error\u003e\n            where\n                D: Deserializer\u003c'de\u003e,\n            {\n                let s = String::deserialize(deserializer)?;\n                Uuid::parse_str(\u0026s)\n                    .map(Self)\n                    .map_err(serde::de::Error::custom)\n            }\n        }\n\n        // SQLx integration for reading from database\n        impl\u003c'r, DB: Database\u003e Decode\u003c'r, DB\u003e for $name\n        where\n            String: Decode\u003c'r, DB\u003e,\n        {\n            fn decode(\n                value: \u003cDB as Database\u003e::ValueRef\u003c'r\u003e,\n            ) -\u003e Result\u003cSelf, sqlx::error::BoxDynError\u003e {\n                let s = String::decode(value)?;\n                Uuid::parse_str(\u0026s).map(Self).map_err(|e| e.into())\n            }\n        }\n\n        // SQLx integration for writing to database\n        impl\u003c'q, DB: Database\u003e Encode\u003c'q, DB\u003e for $name\n        where\n            String: Encode\u003c'q, DB\u003e,\n        {\n            fn encode_by_ref(\n                \u0026self,\n                buf: \u0026mut \u003cDB as Database\u003e::ArgumentBuffer\u003c'q\u003e,\n            ) -\u003e Result\u003csqlx::encode::IsNull, sqlx::error::BoxDynError\u003e {\n                self.0.to_string().encode_by_ref(buf)\n            }\n        }\n\n        impl\u003cDB: Database\u003e Type\u003cDB\u003e for $name\n        where\n            String: Type\u003cDB\u003e,\n        {\n            fn type_info() -\u003e \u003cDB as Database\u003e::TypeInfo {\n                String::type_info()\n            }\n\n            fn compatible(ty: \u0026\u003cDB as Database\u003e::TypeInfo) -\u003e bool {\n                String::compatible(ty)\n            }\n        }\n    };\n}\n\n// Define all typed IDs\ntyped_id!(UserId, \"Unique identifier for a user.\");\ntyped_id!(AttendanceId, \"Unique identifier for an attendance record.\");\ntyped_id!(BreakRecordId, \"Unique identifier for a break record.\");\ntyped_id!(LeaveRequestId, \"Unique identifier for a leave request.\");\ntyped_id!(\n    OvertimeRequestId,\n    \"Unique identifier for an overtime request.\"\n);\ntyped_id!(HolidayId, \"Unique identifier for a holiday.\");\ntyped_id!(WeeklyHolidayId, \"Unique identifier for a weekly holiday.\");\ntyped_id!(\n    HolidayExceptionId,\n    \"Unique identifier for a holiday exception.\"\n);\ntyped_id!(AuditLogId, \"Unique identifier for an audit log entry.\");\n","traces":[{"line":16,"address":[19806256,19806275],"length":1,"stats":{"Line":6},"fn_name":"hash\u003cstd::hash::random::DefaultHasher\u003e"},{"line":17,"address":[19806270],"length":1,"stats":{"Line":2},"fn_name":null},{"line":21,"address":[23026336,23026624,23026480,23026912,23027056,23027200,23027344,23027488,23026768],"length":1,"stats":{"Line":6},"fn_name":null},{"line":22,"address":[23026350,23026926,23027358,23026494,23027502,23026782,23026638,23027070,23027214],"length":1,"stats":{"Line":6},"fn_name":null},{"line":26,"address":[23027136,23026704,23027280,23027424,23026992,23026560,23026416,23027568,23026848],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[23027571,23027427,23026419,23027139,23026707,23026563,23026851,23026995,23027283],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[23027408,23026688,23026976,23026400,23027120,23027552,23026832,23027264,23026544],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[23034128,23032064,23032560,23028736,23029456,23033664,23029664,23031104,23030464],"length":1,"stats":{"Line":0},"fn_name":"default"},{"line":38,"address":[23029672,23029464,23034136,23031112,23030472,23033672,23028744,23032072,23032568],"length":1,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[23028624,23028320,23030352,23031952,23028992,23031472,23029328,23027824,23029728],"length":1,"stats":{"Line":1},"fn_name":"fmt"},{"line":44,"address":[23031497,23029753,23029017,23029353,23031977,23030377,23028649,23028345,23027849],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[23035008,23035856,23032592,23034160,23031136,23031616,23036736,23029840,23033360],"length":1,"stats":{"Line":1},"fn_name":"from_str"},{"line":52,"address":[23031649,23029873,23035041,23033393,23035889,23032625,23034193,23036769,23031169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[23034464,23023936,23038080,23023792,23037472,23024112,23024224,23036624,23035744],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":58,"address":[23024136,23034488,23024248,23037496,23023960,23036648,23035768,23023816,23038104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[23025056,23024577,23025472,23026065,23025025,23025233,23025264,23026273,23026096,23024817,23024400,23025441,23025649,23024640,23025857,23025888,23024848,23025680],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":64,"address":[23024665,23024873,23024931,23024425,23025971,23025139,23025705,23026121,23025289,23025081,23025347,23025497,23025555,23024483,23025763,23026179,23025913,23024723],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[23024080,23024336,23024368,23024048,23024608,23038048,23023904,23036160,23038016],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":70,"address":[23024611,23023907,23024051,23038019,23024371,23036163,23038051,23024339,23024083],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[20532864,20532832,20532800,20532928,20532896,20532736,20532768,20532960,20532704],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":76,"address":[20532803,20532931,20532707,20532835,20532739,20532771,20532963,20532867,20532899],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[19412352,19412512,19412448,19412480,19412416,19412320,19412384,19412288,19412256],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":82,"address":[19412328,19412392,19412296,19412488,19412424,19412456,19412520,19412360,19412264],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[19806690,19806946,19808444,19808238,19808450,19806960,19808048,19808256,19806472,19806752,19807144,19808232,19807982,19806288,19806940,19807976,19806478,19806496,19806684,19807150,19807792],"length":1,"stats":{"Line":0},"fn_name":"serialize\u003cserde_json::value::ser::Serializer\u003e"},{"line":91,"address":[19806470,19807974,19808067,19807048,19808301,19806938,19807837,19807880,19808442,19806840,19808136,19806515,19808275,19807811,19808093,19806584,19806797,19806307,19806979,19806541,19808344,19808230,19806376,19806771,19806682,19807142,19806333,19807005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[19802176,19807568,19802752,19800928,19800000,19800352,19808864,19800576,19801600,19807216,19802400,19809440,19809616,19809968,19801248,19801824,19808512,19809088],"length":1,"stats":{"Line":0},"fn_name":"decode\u003csqlx_postgres::database::Postgres\u003e"},{"line":115,"address":[19800017,19809105,19809633,19800593,19801265,19808529,19807233,19801841,19802417],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[19800266,19800203,19810004,19801451,19800388,19801632,19802212,19800384,19807482,19807600,19810000,19808900,19801514,19808896,19802027,19802788,19802208,19800964,19808778,19800779,19809354,19800842,19809476,19807604,19808715,19809472,19801636,19802603,19800960,19802090,19802784,19802666,19807419,19809819,19809291,19809882],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}\u003csqlx_postgres::database::Postgres\u003e"},{"line":125,"address":[19800432,19801008,19801811,19802256,19800563,19808944,19807773,19801133,19801805,19800557,19802387,19801139,19809069,19810048,19810173,19807779,19809075,19801680,19802381,19807648,19810179],"length":1,"stats":{"Line":0},"fn_name":"encode_by_ref\u003csqlx_postgres::database::Postgres\u003e"},{"line":129,"address":[19800460,19801036,19801708,19802284,19807676,19810076,19808972],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[19810208,19808016,19809536,19801216,19806720,19801168,19808480,19809584,19807184],"length":1,"stats":{"Line":0},"fn_name":"type_info\u003csqlx_postgres::database::Postgres\u003e"},{"line":138,"address":[19801176,19801224,19807192,19808024,19809592,19806728,19808488,19809544,19810216],"length":1,"stats":{"Line":0},"fn_name":null},{"line":141,"address":[19806704,19809520,19801200,19807168,19809568,19810192,19801152,19808464,19808000],"length":1,"stats":{"Line":0},"fn_name":"compatible\u003csqlx_postgres::database::Postgres\u003e"},{"line":142,"address":[19801157,19801205,19806709,19807173,19808005,19808469,19810197,19809573,19809525],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":8,"coverable":34},{"path":["/","home","marra","projects","timekeeper","backend","src","types","mod.rs"],"content":"//! Shared types used across the application.\n\npub mod id;\n\npub use id::*;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","cookies.rs"],"content":"use std::time::Duration;\n\nuse serde::{Deserialize, Serialize};\n\n#[derive(Debug, Clone, Copy, Serialize, Deserialize)]\npub enum SameSite {\n    Lax,\n    Strict,\n    None,\n}\n\n#[derive(Debug, Clone, Copy)]\npub struct CookieOptions {\n    pub secure: bool,\n    pub same_site: SameSite,\n}\n\npub const ACCESS_COOKIE_NAME: \u0026str = \"access_token\";\npub const REFRESH_COOKIE_NAME: \u0026str = \"refresh_token\";\npub const ACCESS_COOKIE_PATH: \u0026str = \"/\";\npub const REFRESH_COOKIE_PATH: \u0026str = \"/api/auth\";\n\npub fn build_auth_cookie(\n    name: \u0026str,\n    value: \u0026str,\n    max_age: Duration,\n    path: \u0026str,\n    options: CookieOptions,\n) -\u003e String {\n    let mut cookie = format!(\n        \"{}={}; Path={}; Max-Age={}; HttpOnly; SameSite={}\",\n        name,\n        value,\n        path,\n        max_age.as_secs(),\n        same_site_value(options.same_site)\n    );\n    if options.secure {\n        cookie.push_str(\"; Secure\");\n    }\n    cookie\n}\n\npub fn build_clear_cookie(name: \u0026str, path: \u0026str, options: CookieOptions) -\u003e String {\n    let mut cookie = format!(\n        \"{}=; Path={}; Max-Age=0; HttpOnly; SameSite={}\",\n        name,\n        path,\n        same_site_value(options.same_site)\n    );\n    if options.secure {\n        cookie.push_str(\"; Secure\");\n    }\n    cookie\n}\n\npub fn extract_cookie_value(header: \u0026str, name: \u0026str) -\u003e Option\u003cString\u003e {\n    header.split(';').map(str::trim).find_map(|pair| {\n        let mut parts = pair.splitn(2, '=');\n        let key = parts.next()?.trim();\n        let value = parts.next()?.trim();\n        if key == name {\n            Some(value.to_string())\n        } else {\n            None\n        }\n    })\n}\n\nfn same_site_value(same_site: SameSite) -\u003e \u0026'static str {\n    match same_site {\n        SameSite::Lax =\u003e \"Lax\",\n        SameSite::Strict =\u003e \"Strict\",\n        SameSite::None =\u003e \"None\",\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn build_auth_cookie_includes_security_attributes() {\n        let opts = CookieOptions {\n            secure: true,\n            same_site: SameSite::Lax,\n        };\n        let cookie = build_auth_cookie(\"access_token\", \"abc\", Duration::from_secs(3600), \"/\", opts);\n        assert!(cookie.contains(\"access_token=abc\"));\n        assert!(cookie.contains(\"Path=/\"));\n        assert!(cookie.contains(\"Max-Age=3600\"));\n        assert!(cookie.contains(\"HttpOnly\"));\n        assert!(cookie.contains(\"SameSite=Lax\"));\n        assert!(cookie.contains(\"Secure\"));\n    }\n\n    #[test]\n    fn build_clear_cookie_sets_max_age_zero() {\n        let opts = CookieOptions {\n            secure: false,\n            same_site: SameSite::Strict,\n        };\n        let cookie = build_clear_cookie(\"refresh_token\", \"/api/auth\", opts);\n        assert!(cookie.contains(\"refresh_token=\"));\n        assert!(cookie.contains(\"Path=/api/auth\"));\n        assert!(cookie.contains(\"Max-Age=0\"));\n        assert!(cookie.contains(\"HttpOnly\"));\n        assert!(cookie.contains(\"SameSite=Strict\"));\n        assert!(!cookie.contains(\"Secure\"));\n    }\n\n    #[test]\n    fn extract_cookie_value_finds_matching_name() {\n        let header = \"a=1; access_token=token-value; b=2\";\n        assert_eq!(\n            extract_cookie_value(header, \"access_token\").as_deref(),\n            Some(\"token-value\")\n        );\n        assert!(extract_cookie_value(header, \"missing\").is_none());\n    }\n}\n","traces":[{"line":23,"address":[20308251,20308257,20307568],"length":1,"stats":{"Line":1},"fn_name":"build_auth_cookie"},{"line":30,"address":[20307744],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[20307695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[20307720],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[20308139],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[20308249,20308187],"length":1,"stats":{"Line":2},"fn_name":null},{"line":41,"address":[20308152],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[20308772,20308778,20308272],"length":1,"stats":{"Line":1},"fn_name":"build_clear_cookie"},{"line":45,"address":[20308403],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[20308379],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[20308660],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[20308770,20308708],"length":1,"stats":{"Line":2},"fn_name":null},{"line":54,"address":[20308674],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[20308800],"length":1,"stats":{"Line":1},"fn_name":"extract_cookie_value"},{"line":58,"address":[20279936],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":59,"address":[20280008],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[20280030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":61,"address":[20280169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[20280326,20280365],"length":1,"stats":{"Line":2},"fn_name":null},{"line":63,"address":[20280377],"length":1,"stats":{"Line":1},"fn_name":null},{"line":65,"address":[20280352],"length":1,"stats":{"Line":1},"fn_name":null},{"line":70,"address":[20307440],"length":1,"stats":{"Line":1},"fn_name":"same_site_value"},{"line":71,"address":[20307447],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[20307478],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[20307501],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[20307524],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":25,"coverable":26},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","csv.rs"],"content":"fn needs_formula_guard(value: \u0026str) -\u003e bool {\n    value\n        .chars()\n        .find(|c| !c.is_whitespace())\n        .is_some_and(|c| matches!(c, '=' | '+' | '-' | '@'))\n}\n\nfn escape_cell(value: \u0026str) -\u003e String {\n    let mut sanitized = value.replace('\"', \"\\\"\\\"\");\n    if needs_formula_guard(\u0026sanitized) {\n        sanitized.insert(0, '\\'');\n    }\n    format!(\"\\\"{}\\\"\", sanitized)\n}\n\npub fn append_csv_row(buffer: \u0026mut String, fields: \u0026[String]) {\n    for (idx, field) in fields.iter().enumerate() {\n        if idx \u003e 0 {\n            buffer.push(',');\n        }\n        buffer.push_str(\u0026escape_cell(field));\n    }\n    buffer.push('\\n');\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn escapes_formulas_and_quotes() {\n        let mut buffer = String::new();\n        append_csv_row(\n            \u0026mut buffer,\n            \u0026[\"=SUM(A1)\".to_string(), \"\\\"quoted\\\"\".to_string()],\n        );\n\n        assert_eq!(buffer, \"\\\"'=SUM(A1)\\\",\\\"\\\"\\\"quoted\\\"\\\"\\\"\\n\");\n    }\n\n    #[test]\n    fn guards_formula_after_leading_whitespace() {\n        let mut buffer = String::new();\n        append_csv_row(\u0026mut buffer, \u0026[\"  -1\".to_string()]);\n\n        assert_eq!(buffer, \"\\\"'  -1\\\"\\n\");\n    }\n}\n","traces":[{"line":1,"address":[22665616],"length":1,"stats":{"Line":1},"fn_name":"needs_formula_guard"},{"line":4,"address":[20437582,20437568],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":5,"address":[20437608,20437600],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":8,"address":[22664816,22665159,22665153],"length":1,"stats":{"Line":1},"fn_name":"escape_cell"},{"line":9,"address":[22664849],"length":1,"stats":{"Line":1},"fn_name":null},{"line":10,"address":[22664959,22664891],"length":1,"stats":{"Line":2},"fn_name":null},{"line":11,"address":[22665012],"length":1,"stats":{"Line":1},"fn_name":null},{"line":13,"address":[22664985,22665042],"length":1,"stats":{"Line":2},"fn_name":null},{"line":16,"address":[22665599,22665184,22665593],"length":1,"stats":{"Line":1},"fn_name":"append_csv_row"},{"line":17,"address":[22665315,22665246],"length":1,"stats":{"Line":2},"fn_name":null},{"line":18,"address":[22665410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[22665499],"length":1,"stats":{"Line":1},"fn_name":null},{"line":21,"address":[22665511,22665446],"length":1,"stats":{"Line":1},"fn_name":null},{"line":23,"address":[22665423],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":14,"coverable":14},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","email.rs"],"content":"use anyhow::Result;\nuse lettre::message::header::ContentType;\nuse lettre::transport::smtp::authentication::Credentials;\nuse lettre::{Message, SmtpTransport, Transport};\nuse std::env;\n\npub struct EmailService {\n    mailer: SmtpTransport,\n    from_address: String,\n}\n\nimpl EmailService {\n    pub fn new() -\u003e Result\u003cSelf\u003e {\n        let smtp_host = env::var(\"SMTP_HOST\").unwrap_or_else(|_| \"localhost\".to_string());\n        let smtp_port = env::var(\"SMTP_PORT\")\n            .unwrap_or_else(|_| \"587\".to_string())\n            .parse::\u003cu16\u003e()\n            .unwrap_or(587);\n        let smtp_username = env::var(\"SMTP_USERNAME\").unwrap_or_default();\n        let smtp_password = env::var(\"SMTP_PASSWORD\").unwrap_or_default();\n        let from_address = env::var(\"SMTP_FROM_ADDRESS\")\n            .unwrap_or_else(|_| \"noreply@timekeeper.local\".to_string());\n\n        let mailer = if smtp_username.is_empty() {\n            SmtpTransport::builder_dangerous(\u0026smtp_host)\n                .port(smtp_port)\n                .build()\n        } else {\n            let creds = Credentials::new(smtp_username, smtp_password);\n            SmtpTransport::relay(\u0026smtp_host)?\n                .port(smtp_port)\n                .credentials(creds)\n                .build()\n        };\n\n        Ok(Self {\n            mailer,\n            from_address,\n        })\n    }\n\n    pub fn send_password_reset_email(\u0026self, to_email: \u0026str, reset_token: \u0026str) -\u003e Result\u003c()\u003e {\n        if env::var(\"SMTP_SKIP_SEND\").unwrap_or_default() == \"true\" {\n            return Ok(());\n        }\n        let reset_url = format!(\n            \"{}/reset-password?token={}\",\n            env::var(\"FRONTEND_URL\").unwrap_or_else(|_| \"http://localhost:8000\".to_string()),\n            reset_token\n        );\n\n        let body = format!(\n            r#\"\nパスワードリセットのリクエストを受け付けました。\n\n以下のリンクをクリックして、新しいパスワードを設定してください:\n\n{}\n\nこのリンクは1時間有効です。\n\nこのリクエストに心当たりがない場合は、このメールを無視してください。\n\n---\nTimekeeper 勤怠管理システム\n\"#,\n            reset_url\n        );\n\n        let email = Message::builder()\n            .from(self.from_address.parse()?)\n            .to(to_email.parse()?)\n            .subject(\"パスワードリセットのリクエスト - Timekeeper\")\n            .header(ContentType::TEXT_PLAIN)\n            .body(body)?;\n\n        self.mailer.send(\u0026email)?;\n        Ok(())\n    }\n\n    pub fn send_password_changed_notification(\u0026self, to_email: \u0026str, username: \u0026str) -\u003e Result\u003c()\u003e {\n        if env::var(\"SMTP_SKIP_SEND\").unwrap_or_default() == \"true\" {\n            return Ok(());\n        }\n        let body = format!(\n            r#\"\n{}さんのパスワードが変更されました。\n\nこの変更に心当たりがない場合は、すぐに管理者に連絡してください。\n\n変更日時: {}\n\n---\nTimekeeper 勤怠管理システム\n\"#,\n            username,\n            chrono::Utc::now().format(\"%Y-%m-%d %H:%M:%S UTC\")\n        );\n\n        let email = Message::builder()\n            .from(self.from_address.parse()?)\n            .to(to_email.parse()?)\n            .subject(\"パスワード変更通知 - Timekeeper\")\n            .header(ContentType::TEXT_PLAIN)\n            .body(body)?;\n\n        self.mailer.send(\u0026email)?;\n        Ok(())\n    }\n}\n\nimpl Default for EmailService {\n    fn default() -\u003e Self {\n        Self::new().expect(\"Failed to initialize email service\")\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn email_service_new_creates_service() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n        std::env::remove_var(\"SMTP_FROM_ADDRESS\");\n        let service = EmailService::new();\n        assert!(service.is_ok());\n        let service = service.unwrap();\n        assert_eq!(service.from_address, \"noreply@timekeeper.local\");\n    }\n\n    #[test]\n    fn email_service_new_uses_env_vars() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n        std::env::set_var(\"SMTP_HOST\", \"smtp.example.com\");\n        std::env::set_var(\"SMTP_PORT\", \"2525\");\n        std::env::set_var(\"SMTP_FROM_ADDRESS\", \"test@example.com\");\n\n        let service = EmailService::new().unwrap();\n        assert_eq!(service.from_address, \"test@example.com\");\n    }\n\n    #[test]\n    fn email_service_send_password_reset_email_skips_when_enabled() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n        std::env::set_var(\"FRONTEND_URL\", \"http://test.example.com\");\n\n        let service = EmailService::new().unwrap();\n        let result = service.send_password_reset_email(\"test@example.com\", \"token123\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn email_service_send_password_changed_notification_skips_when_enabled() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n\n        let service = EmailService::new().unwrap();\n        let result = service.send_password_changed_notification(\"test@example.com\", \"testuser\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn email_service_send_password_reset_email_includes_token() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n        std::env::set_var(\"FRONTEND_URL\", \"http://test.example.com\");\n\n        let service = EmailService::new().unwrap();\n        let result = service.send_password_reset_email(\"test@example.com\", \"abc123\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn email_service_send_password_changed_notification_includes_username() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n\n        let service = EmailService::new().unwrap();\n        let result = service.send_password_changed_notification(\"test@example.com\", \"testuser\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn email_service_default_impl_new() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n        let service = EmailService::default();\n        assert_eq!(service.from_address, \"noreply@timekeeper.local\");\n    }\n\n    #[test]\n    fn email_service_send_password_reset_email_valid_to_address() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n        std::env::set_var(\"FRONTEND_URL\", \"http://test.example.com\");\n\n        let service = EmailService::new().unwrap();\n        let result = service.send_password_reset_email(\"valid@example.com\", \"abc123\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn email_service_send_password_changed_notification_valid_to_address() {\n        std::env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n\n        let service = EmailService::new().unwrap();\n        let result = service.send_password_changed_notification(\"valid@example.com\", \"testuser\");\n        assert!(result.is_ok());\n    }\n}\n","traces":[{"line":13,"address":[18317493,18317705,18315840],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[18315857],"length":1,"stats":{"Line":3},"fn_name":null},{"line":15,"address":[18316218,18316067,18315966,18316154],"length":1,"stats":{"Line":4},"fn_name":null},{"line":16,"address":[18316029],"length":1,"stats":{"Line":3},"fn_name":null},{"line":19,"address":[18316245],"length":1,"stats":{"Line":1},"fn_name":null},{"line":20,"address":[18316307,18316395],"length":1,"stats":{"Line":2},"fn_name":null},{"line":21,"address":[18316410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[18316479],"length":1,"stats":{"Line":3},"fn_name":null},{"line":24,"address":[18316573,18316517],"length":1,"stats":{"Line":2},"fn_name":null},{"line":25,"address":[18316710,18317563],"length":1,"stats":{"Line":2},"fn_name":null},{"line":26,"address":[18317504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":29,"address":[18316579,18316720],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[18316736,18316807,18317183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[18317000],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[18317063],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[18317260],"length":1,"stats":{"Line":1},"fn_name":null},{"line":37,"address":[18317204],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[18317212],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[18313090,18310592,18313318],"length":1,"stats":{"Line":1},"fn_name":null},{"line":43,"address":[18310663,18310978],"length":1,"stats":{"Line":2},"fn_name":null},{"line":44,"address":[18310992],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[18310935,18311009],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[20829904,20829920],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":52,"address":[18311296,18311225],"length":1,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[18311734,18312335,18312543,18312610,18313101,18311404,18312144],"length":1,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[18311841,18311472,18311806,18313180,18313274],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[18312216,18313116,18312251,18313215,18311914],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[18312449],"length":1,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[18312578,18312456],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[18312787,18312720,18313044],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[18312971],"length":1,"stats":{"Line":0},"fn_name":null},{"line":81,"address":[18313344,18315796,18315607],"length":1,"stats":{"Line":1},"fn_name":null},{"line":82,"address":[18313710,18313412],"length":1,"stats":{"Line":2},"fn_name":null},{"line":83,"address":[18313724],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[18313749,18313675],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[18313605],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[18314676,18315075,18315618,18314266,18313939,18315142,18314867],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[18315774,18314373,18314338,18315697,18314004],"length":1,"stats":{"Line":0},"fn_name":null},{"line":102,"address":[18314783,18315633,18314446,18314748,18315732],"length":1,"stats":{"Line":0},"fn_name":null},{"line":104,"address":[18314981],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[18315110,18314988],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[18315561,18315249,18315316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":108,"address":[18315501],"length":1,"stats":{"Line":0},"fn_name":null},{"line":113,"address":[18321184],"length":1,"stats":{"Line":1},"fn_name":"default"},{"line":114,"address":[18321198],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":22,"coverable":45},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","jwt.rs"],"content":"use chrono::{Duration, Utc};\nuse jsonwebtoken::{decode, encode, Algorithm, DecodingKey, EncodingKey, Header, Validation};\nuse serde::{Deserialize, Serialize};\nuse uuid::Uuid;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Claims {\n    pub sub: String, // user_id\n    pub username: String,\n    pub role: String,\n    pub exp: i64,    // expiration time\n    pub iat: i64,    // issued at\n    pub jti: String, // JWT ID\n}\n\n#[derive(Debug, Clone)]\npub struct RefreshToken {\n    pub id: String,\n    pub user_id: String,\n    pub secret: String,\n    pub token_hash: String,\n    pub expires_at: chrono::DateTime\u003cUtc\u003e,\n}\n\nimpl Claims {\n    pub fn new(user_id: String, username: String, role: String, expiration_hours: u64) -\u003e Self {\n        let now = Utc::now();\n        let exp = now + Duration::hours(expiration_hours as i64);\n\n        Self {\n            sub: user_id,\n            username,\n            role,\n            exp: exp.timestamp(),\n            iat: now.timestamp(),\n            jti: Uuid::new_v4().to_string(),\n        }\n    }\n}\n\npub fn create_access_token(\n    user_id: String,\n    username: String,\n    role: String,\n    secret: \u0026str,\n    expiration_hours: u64,\n) -\u003e anyhow::Result\u003c(String, Claims)\u003e {\n    let claims = Claims::new(user_id, username, role, expiration_hours);\n    let token = encode(\n        \u0026Header::new(Algorithm::HS256),\n        \u0026claims,\n        \u0026EncodingKey::from_secret(secret.as_ref()),\n    )?;\n\n    Ok((token, claims))\n}\n\nimpl RefreshToken {\n    pub fn encoded(\u0026self) -\u003e String {\n        format!(\"{}:{}\", self.id, self.secret)\n    }\n}\n\npub fn create_refresh_token(user_id: String, expiration_days: u64) -\u003e anyhow::Result\u003cRefreshToken\u003e {\n    let secret = Uuid::new_v4().to_string();\n    let token_hash = hash_refresh_token(\u0026secret)?;\n    let expires_at = Utc::now()\n        .checked_add_signed(Duration::days(expiration_days as i64))\n        .ok_or_else(|| anyhow::anyhow!(\"Refresh token expiration overflow\"))?;\n\n    Ok(RefreshToken {\n        id: Uuid::new_v4().to_string(),\n        user_id,\n        secret,\n        token_hash,\n        expires_at,\n    })\n}\n\n#[allow(dead_code)]\npub fn verify_access_token(token: \u0026str, secret: \u0026str) -\u003e anyhow::Result\u003cClaims\u003e {\n    let validation = Validation::default();\n    let token_data = decode::\u003cClaims\u003e(\n        token,\n        \u0026DecodingKey::from_secret(secret.as_ref()),\n        \u0026validation,\n    )?;\n\n    Ok(token_data.claims)\n}\n\npub fn hash_refresh_token(token: \u0026str) -\u003e anyhow::Result\u003cString\u003e {\n    use argon2::password_hash::{rand_core::OsRng, SaltString};\n    use argon2::{Argon2, PasswordHasher};\n\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let argon2 = Argon2::default();\n\n    let token_hash = argon2\n        .hash_password(token.as_bytes(), \u0026salt)\n        .map_err(|e| anyhow::anyhow!(\"Failed to hash refresh token: {}\", e))?;\n\n    Ok(token_hash.to_string())\n}\n\npub fn verify_refresh_token(token: \u0026str, hash: \u0026str) -\u003e anyhow::Result\u003cbool\u003e {\n    use argon2::password_hash::PasswordHash;\n    use argon2::{Argon2, PasswordVerifier};\n\n    let parsed_hash = PasswordHash::new(hash)\n        .map_err(|e| anyhow::anyhow!(\"Invalid refresh token hash: {}\", e))?;\n\n    let argon2 = Argon2::default();\n    let result = argon2.verify_password(token.as_bytes(), \u0026parsed_hash);\n\n    match result {\n        Ok(_) =\u003e Ok(true),\n        Err(argon2::password_hash::Error::Password) =\u003e Ok(false),\n        Err(e) =\u003e Err(anyhow::anyhow!(\"Refresh token verification error: {}\", e)),\n    }\n}\n\npub fn decode_refresh_token(compound: \u0026str) -\u003e anyhow::Result\u003c(String, String)\u003e {\n    let mut parts = compound.splitn(2, ':');\n    let id = parts\n        .next()\n        .ok_or_else(|| anyhow::anyhow!(\"Malformed refresh token\"))?;\n    let secret = parts\n        .next()\n        .ok_or_else(|| anyhow::anyhow!(\"Malformed refresh token\"))?;\n\n    if id.is_empty() || secret.is_empty() {\n        return Err(anyhow::anyhow!(\"Malformed refresh token\"));\n    }\n\n    Ok((id.to_string(), secret.to_string()))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn create_and_verify_with_snake_case_role() {\n        let (token, _) =\n            create_access_token(\"user-123\".into(), \"bob\".into(), \"admin\".into(), \"secret\", 1)\n                .expect(\"create token\");\n        let claims = verify_access_token(\u0026token, \"secret\").expect(\"verify token\");\n        assert_eq!(claims.sub, \"user-123\");\n        assert_eq!(claims.username, \"bob\");\n        assert_eq!(claims.role, \"admin\");\n    }\n\n    #[test]\n    fn decode_refresh_token_requires_two_parts() {\n        assert!(decode_refresh_token(\"abc:def\").is_ok());\n        assert!(decode_refresh_token(\"abc\").is_err());\n        assert!(decode_refresh_token(\":def\").is_err());\n    }\n}\n","traces":[{"line":26,"address":[19307504,19308238,19308138],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[19307549],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[19307659],"length":1,"stats":{"Line":1},"fn_name":null},{"line":34,"address":[19307833],"length":1,"stats":{"Line":1},"fn_name":null},{"line":35,"address":[19307898],"length":1,"stats":{"Line":1},"fn_name":null},{"line":36,"address":[19307919],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[19304229,19303312,19304173],"length":1,"stats":{"Line":1},"fn_name":"create_access_token"},{"line":48,"address":[19303366],"length":1,"stats":{"Line":1},"fn_name":null},{"line":50,"address":[19303469],"length":1,"stats":{"Line":1},"fn_name":null},{"line":52,"address":[19303603,19303537],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[19303988],"length":1,"stats":{"Line":1},"fn_name":null},{"line":59,"address":[19302784],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[19302806],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[19306096,19306117,19305040],"length":1,"stats":{"Line":1},"fn_name":"create_refresh_token"},{"line":65,"address":[19305075,19305132],"length":1,"stats":{"Line":2},"fn_name":null},{"line":66,"address":[19305231,19305158,19306102],"length":1,"stats":{"Line":2},"fn_name":null},{"line":67,"address":[19305592,19305549,19305397],"length":1,"stats":{"Line":2},"fn_name":null},{"line":68,"address":[19305462],"length":1,"stats":{"Line":1},"fn_name":null},{"line":69,"address":[18390420,18390416],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":71,"address":[19305811],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[19305639],"length":1,"stats":{"Line":1},"fn_name":null},{"line":73,"address":[19305695],"length":1,"stats":{"Line":1},"fn_name":null},{"line":74,"address":[19305730],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[19305769],"length":1,"stats":{"Line":1},"fn_name":null},{"line":81,"address":[19305023,19304256,19304985],"length":1,"stats":{"Line":1},"fn_name":"verify_access_token"},{"line":82,"address":[19304325],"length":1,"stats":{"Line":1},"fn_name":null},{"line":85,"address":[19304417,19304349],"length":1,"stats":{"Line":2},"fn_name":null},{"line":89,"address":[19304747],"length":1,"stats":{"Line":1},"fn_name":null},{"line":92,"address":[19302960],"length":1,"stats":{"Line":1},"fn_name":"hash_refresh_token"},{"line":96,"address":[19303003],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[19303018],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[19303170,19303101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":100,"address":[19303039],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[18388752,18388759],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":103,"address":[19303236],"length":1,"stats":{"Line":1},"fn_name":null},{"line":106,"address":[19306896],"length":1,"stats":{"Line":0},"fn_name":"verify_refresh_token"},{"line":110,"address":[19306981,19307016,19307085],"length":1,"stats":{"Line":0},"fn_name":null},{"line":111,"address":[18390615,18390608],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":113,"address":[19307151],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[19307175],"length":1,"stats":{"Line":0},"fn_name":null},{"line":116,"address":[19307217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[19307265],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[19307290],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[19307299],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[19306872,19306144,19306866],"length":1,"stats":{"Line":1},"fn_name":"decode_refresh_token"},{"line":124,"address":[19306177],"length":1,"stats":{"Line":1},"fn_name":null},{"line":125,"address":[19306299,19306226],"length":1,"stats":{"Line":1},"fn_name":null},{"line":127,"address":[18390544,18390548],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":128,"address":[19306385,19306458],"length":1,"stats":{"Line":2},"fn_name":null},{"line":130,"address":[18390484,18390480],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":132,"address":[19306527],"length":1,"stats":{"Line":1},"fn_name":null},{"line":133,"address":[19306557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":136,"address":[19306641],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":44,"coverable":53},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","mfa.rs"],"content":"use anyhow::{anyhow, Result};\nuse base32::Alphabet::RFC4648;\nuse rand::{rngs::OsRng, RngCore};\nuse totp_rs::{Algorithm, TOTP};\n\nconst SECRET_BYTE_LENGTH: usize = 20;\nconst CODE_DIGITS: usize = 6;\nconst STEP_SECONDS: u64 = 30;\nconst ALLOWED_SKEW: u8 = 1;\n\n/// Generates a random base32-encoded secret suitable for RFC6238 TOTP.\npub fn generate_totp_secret() -\u003e String {\n    let mut bytes = [0u8; SECRET_BYTE_LENGTH];\n    OsRng.fill_bytes(\u0026mut bytes);\n    base32::encode(RFC4648 { padding: false }, \u0026bytes)\n}\n\n/// Produces an `otpauth://` URI that OTP clients like Authy can import.\npub fn generate_otpauth_uri(issuer: \u0026str, account_name: \u0026str, secret: \u0026str) -\u003e Result\u003cString\u003e {\n    if issuer.contains(':') {\n        return Err(anyhow!(\"Issuer must not contain ':'\"));\n    }\n    let sanitized_account = account_name.trim();\n    if sanitized_account.contains(':') {\n        return Err(anyhow!(\"Account name must not contain ':'\"));\n    }\n    let totp = build_totp_with_labels(secret, Some(issuer), sanitized_account)?;\n    Ok(totp.get_url())\n}\n\n/// Validates the submitted TOTP code against the stored secret.\npub fn verify_totp_code(secret: \u0026str, code: \u0026str) -\u003e Result\u003cbool\u003e {\n    let sanitized_code = code.trim();\n    if sanitized_code.len() != CODE_DIGITS || !sanitized_code.chars().all(|c| c.is_ascii_digit()) {\n        return Ok(false);\n    }\n    let totp = build_totp(secret)?;\n    totp.check_current(sanitized_code)\n        .map_err(|e| anyhow!(\"Failed to verify TOTP code: {}\", e))\n}\n\nfn build_totp(secret: \u0026str) -\u003e Result\u003cTOTP\u003e {\n    build_totp_with_labels(secret, None, \"\")\n}\n\nfn build_totp_with_labels(secret: \u0026str, issuer: Option\u003c\u0026str\u003e, account_name: \u0026str) -\u003e Result\u003cTOTP\u003e {\n    let secret_bytes = decode_secret(secret)?;\n    TOTP::new(\n        Algorithm::SHA1,\n        CODE_DIGITS,\n        ALLOWED_SKEW,\n        STEP_SECONDS,\n        secret_bytes,\n        issuer.map(|value| value.to_string()),\n        account_name.to_string(),\n    )\n    .map_err(|e| anyhow!(\"Failed to configure TOTP: {}\", e))\n}\n\nfn decode_secret(secret: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n    let cleaned = secret.trim().replace(' ', \"\").to_uppercase();\n    base32::decode(RFC4648 { padding: false }, cleaned.as_str())\n        .ok_or_else(|| anyhow!(\"Invalid base32 secret\"))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::time::{SystemTime, UNIX_EPOCH};\n\n    #[test]\n    fn secret_round_trip_verification() {\n        let secret = generate_totp_secret();\n        let totp = build_totp(\u0026secret).expect(\"totp build\");\n        let now = SystemTime::now()\n            .duration_since(UNIX_EPOCH)\n            .expect(\"time\")\n            .as_secs();\n        let current = totp.generate(now);\n        assert!(verify_totp_code(\u0026secret, \u0026current).unwrap());\n    }\n}\n","traces":[{"line":12,"address":[19315552],"length":1,"stats":{"Line":1},"fn_name":"generate_totp_secret"},{"line":13,"address":[19315565],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[19315582],"length":1,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[19315607],"length":1,"stats":{"Line":1},"fn_name":null},{"line":19,"address":[19314720,19315527,19315533],"length":1,"stats":{"Line":0},"fn_name":"generate_otpauth_uri"},{"line":20,"address":[19314839],"length":1,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[19314922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[19314864],"length":1,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[19314901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":25,"address":[19315103],"length":1,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[19315182,19315026],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[19315401,19315468],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[19314096,19314701,19314707],"length":1,"stats":{"Line":1},"fn_name":"verify_totp_code"},{"line":33,"address":[19314180],"length":1,"stats":{"Line":1},"fn_name":null},{"line":34,"address":[19314217],"length":1,"stats":{"Line":3},"fn_name":null},{"line":35,"address":[19314272],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[19314293],"length":1,"stats":{"Line":1},"fn_name":null},{"line":38,"address":[19314595],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[19314670],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[19313664],"length":1,"stats":{"Line":1},"fn_name":"build_totp"},{"line":43,"address":[19313686],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[19316335,19316310,19315648],"length":1,"stats":{"Line":1},"fn_name":"build_totp_with_labels"},{"line":47,"address":[19315741,19315877],"length":1,"stats":{"Line":2},"fn_name":null},{"line":53,"address":[19315937],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[19316045,19315987],"length":1,"stats":{"Line":2},"fn_name":null},{"line":55,"address":[19316053],"length":1,"stats":{"Line":1},"fn_name":null},{"line":57,"address":[19316226],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[19314070,19314076,19313728],"length":1,"stats":{"Line":1},"fn_name":"decode_secret"},{"line":61,"address":[19313787],"length":1,"stats":{"Line":1},"fn_name":null},{"line":62,"address":[19313978],"length":1,"stats":{"Line":1},"fn_name":null},{"line":63,"address":[19314039],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":22,"coverable":31},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","mod.rs"],"content":"pub mod cookies;\npub mod csv;\npub mod email;\npub mod jwt;\npub mod mfa;\npub mod password;\npub mod security;\npub mod time;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","password.rs"],"content":"use argon2::password_hash::{rand_core::OsRng, SaltString};\nuse argon2::{Argon2, PasswordHash, PasswordHasher, PasswordVerifier};\n\nuse crate::config::Config;\n\npub fn hash_password(password: \u0026str) -\u003e anyhow::Result\u003cString\u003e {\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let argon2 = Argon2::default();\n\n    let password_hash = argon2\n        .hash_password(password.as_bytes(), \u0026salt)\n        .map_err(|e| anyhow::anyhow!(\"Failed to hash password: {}\", e))?;\n\n    Ok(password_hash.to_string())\n}\n\npub fn verify_password(password: \u0026str, hash: \u0026str) -\u003e anyhow::Result\u003cbool\u003e {\n    let parsed_hash =\n        PasswordHash::new(hash).map_err(|e| anyhow::anyhow!(\"Invalid password hash: {}\", e))?;\n\n    let argon2 = Argon2::default();\n    let result = argon2.verify_password(password.as_bytes(), \u0026parsed_hash);\n\n    match result {\n        Ok(_) =\u003e Ok(true),\n        Err(argon2::password_hash::Error::Password) =\u003e Ok(false),\n        Err(e) =\u003e Err(anyhow::anyhow!(\"Password verification error: {}\", e)),\n    }\n}\n\npub fn password_matches_any(password: \u0026str, hashes: \u0026[String]) -\u003e anyhow::Result\u003cbool\u003e {\n    for hash in hashes {\n        if verify_password(password, hash)? {\n            return Ok(true);\n        }\n    }\n    Ok(false)\n}\n\npub fn validate_password_complexity(password: \u0026str, config: \u0026Config) -\u003e anyhow::Result\u003c()\u003e {\n    if password.len() \u003c config.password_min_length {\n        return Err(anyhow::anyhow!(\n            \"Password must be at least {} characters long\",\n            config.password_min_length\n        ));\n    }\n\n    if config.password_require_uppercase \u0026\u0026 !password.chars().any(|c| c.is_uppercase()) {\n        return Err(anyhow::anyhow!(\n            \"Password must contain at least one uppercase letter\"\n        ));\n    }\n\n    if config.password_require_lowercase \u0026\u0026 !password.chars().any(|c| c.is_lowercase()) {\n        return Err(anyhow::anyhow!(\n            \"Password must contain at least one lowercase letter\"\n        ));\n    }\n\n    if config.password_require_numbers \u0026\u0026 !password.chars().any(|c| c.is_numeric()) {\n        return Err(anyhow::anyhow!(\"Password must contain at least one number\"));\n    }\n\n    if config.password_require_symbols \u0026\u0026 !password.chars().any(|c| !c.is_alphanumeric()) {\n        return Err(anyhow::anyhow!(\"Password must contain at least one symbol\"));\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::utils::cookies::SameSite;\n    use chrono_tz::UTC;\n\n    fn test_config() -\u003e Config {\n        Config {\n            database_url: \"\".to_string(),\n            read_database_url: None,\n            jwt_secret: \"\".to_string(),\n            jwt_expiration_hours: 1,\n            refresh_token_expiration_days: 7,\n            max_concurrent_sessions: 3,\n            audit_log_retention_days: 0,\n            audit_log_retention_forever: false,\n            consent_log_retention_days: 0,\n            consent_log_retention_forever: false,\n            aws_region: \"\".to_string(),\n            aws_kms_key_id: \"\".to_string(),\n            aws_audit_log_bucket: \"\".to_string(),\n            aws_cloudtrail_enabled: false,\n            cookie_secure: false,\n            cookie_same_site: SameSite::Lax,\n            cors_allow_origins: vec![],\n            time_zone: UTC,\n            mfa_issuer: \"\".to_string(),\n            rate_limit_ip_max_requests: 0,\n            rate_limit_ip_window_seconds: 0,\n            rate_limit_user_max_requests: 0,\n            rate_limit_user_window_seconds: 0,\n            redis_url: None,\n            redis_pool_size: 0,\n            redis_connect_timeout: 0,\n            feature_redis_cache_enabled: false,\n            feature_read_replica_enabled: false,\n            password_min_length: 8,\n            password_require_uppercase: true,\n            password_require_lowercase: true,\n            password_require_numbers: true,\n            password_require_symbols: true,\n            password_expiration_days: 90,\n            password_history_count: 5,\n            production_mode: false,\n        }\n    }\n\n    #[test]\n    fn validate_password_complexity_success() {\n        let config = test_config();\n        assert!(validate_password_complexity(\"StrongP@ss1\", \u0026config).is_ok());\n    }\n\n    #[test]\n    fn validate_password_complexity_fails_length() {\n        let config = test_config();\n        let err = validate_password_complexity(\"Short1!\", \u0026config).unwrap_err();\n        assert!(err.to_string().contains(\"at least 8 characters\"));\n    }\n\n    #[test]\n    fn validate_password_complexity_fails_uppercase() {\n        let config = test_config();\n        let err = validate_password_complexity(\"weakp@ss1\", \u0026config).unwrap_err();\n        assert!(err.to_string().contains(\"uppercase\"));\n    }\n\n    #[test]\n    fn validate_password_complexity_fails_lowercase() {\n        let config = test_config();\n        let err = validate_password_complexity(\"WEAKP@SS1\", \u0026config).unwrap_err();\n        assert!(err.to_string().contains(\"lowercase\"));\n    }\n\n    #[test]\n    fn validate_password_complexity_fails_numbers() {\n        let config = test_config();\n        let err = validate_password_complexity(\"NoNumbers!\", \u0026config).unwrap_err();\n        assert!(err.to_string().contains(\"number\"));\n    }\n\n    #[test]\n    fn validate_password_complexity_fails_symbols() {\n        let config = test_config();\n        let err = validate_password_complexity(\"NoSymbols1\", \u0026config).unwrap_err();\n        assert!(err.to_string().contains(\"symbol\"));\n    }\n\n    #[test]\n    fn hash_and_verify_roundtrip() {\n        let pw = \"S3cr3t!\";\n        let hash = hash_password(pw).expect(\"hash should succeed\");\n        assert!(verify_password(pw, \u0026hash).unwrap());\n        assert!(!verify_password(\"wrong\", \u0026hash).unwrap());\n    }\n}\n","traces":[{"line":6,"address":[20004208],"length":1,"stats":{"Line":1},"fn_name":"hash_password"},{"line":7,"address":[20004251],"length":1,"stats":{"Line":1},"fn_name":null},{"line":8,"address":[20004266],"length":1,"stats":{"Line":1},"fn_name":null},{"line":10,"address":[20004418,20004349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":11,"address":[20004287],"length":1,"stats":{"Line":1},"fn_name":null},{"line":12,"address":[20004402,20004328],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[20004484],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[20004560],"length":1,"stats":{"Line":1},"fn_name":"verify_password"},{"line":18,"address":[21641911,21641904],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":21,"address":[20004815],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[20004839],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[20004881],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[20004929],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[20004954],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[20004963],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[20005168],"length":1,"stats":{"Line":0},"fn_name":"password_matches_any"},{"line":32,"address":[20005247,20005262],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[20005414,20005319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[20005471],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[20005389],"length":1,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[20005488],"length":1,"stats":{"Line":1},"fn_name":"validate_password_complexity"},{"line":41,"address":[20005534],"length":1,"stats":{"Line":1},"fn_name":null},{"line":42,"address":[20005578],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[20005558,20005715],"length":1,"stats":{"Line":4},"fn_name":null},{"line":49,"address":[20005747],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[20005835,20005694],"length":1,"stats":{"Line":4},"fn_name":null},{"line":55,"address":[20005873],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[20005814,20005950],"length":1,"stats":{"Line":4},"fn_name":null},{"line":61,"address":[20005988],"length":1,"stats":{"Line":1},"fn_name":null},{"line":64,"address":[20005929,20006066],"length":1,"stats":{"Line":4},"fn_name":null},{"line":65,"address":[20006104],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[20006042],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":26,"coverable":32},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","security.rs"],"content":"use crate::config::Config;\nuse crate::error::AppError;\nuse axum::http::HeaderMap;\nuse rand::Rng;\n\npub fn generate_token(length: usize) -\u003e String {\n    const CHARSET: \u0026[u8] = b\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\n    let mut rng = rand::thread_rng();\n    (0..length)\n        .map(|_| {\n            let idx = rng.gen_range(0..CHARSET.len());\n            CHARSET[idx] as char\n        })\n        .collect()\n}\n\npub fn verify_request_origin(headers: \u0026HeaderMap, config: \u0026Config) -\u003e Result\u003c(), AppError\u003e {\n    let origin = headers\n        .get(\"Origin\")\n        .and_then(|v| v.to_str().ok())\n        .or_else(|| headers.get(\"Referer\").and_then(|v| v.to_str().ok()));\n\n    let origin_str = match origin {\n        Some(o) =\u003e o,\n        None =\u003e {\n            return Err(AppError::Forbidden(\n                \"Missing Origin or Referer header\".into(),\n            ))\n        }\n    };\n\n    // If config allows specific origins, check against them.\n    if config\n        .cors_allow_origins\n        .iter()\n        .any(|o| o == \"*\" || o == origin_str.trim_end_matches('/'))\n    {\n        Ok(())\n    } else {\n        Err(AppError::Forbidden(\"Invalid Origin or Referer\".into()))\n    }\n}\n\npub fn mask_database_url(url: \u0026str) -\u003e String {\n    if let Some(start_scheme) = url.find(\"://\") {\n        let after_scheme = start_scheme + 3;\n        if let Some(at_symbol) = url[after_scheme..].find('@') {\n            let at_index = after_scheme + at_symbol;\n            let user_pass_part = \u0026url[after_scheme..at_index];\n\n            if let Some(colon) = user_pass_part.find(':') {\n                let user = \u0026user_pass_part[..colon];\n                let remainder = \u0026url[at_index..];\n                return format!(\"{}://{}:*****{}\", \u0026url[..start_scheme], user, remainder);\n            }\n        }\n    }\n    url.to_string()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono_tz::UTC;\n\n    #[test]\n    fn test_mask_database_url() {\n        assert_eq!(\n            mask_database_url(\"postgres://user:password@localhost:5432/db\"),\n            \"postgres://user:*****@localhost:5432/db\"\n        );\n        assert_eq!(\n            mask_database_url(\"postgres://user:pass-word@localhost:5432/db\"),\n            \"postgres://user:*****@localhost:5432/db\"\n        );\n        assert_eq!(\n            mask_database_url(\"postgres://user@localhost:5432/db\"),\n            \"postgres://user@localhost:5432/db\"\n        );\n        assert_eq!(mask_database_url(\"invalid-url\"), \"invalid-url\");\n    }\n\n    fn test_config(allowed: Vec\u003cString\u003e) -\u003e Config {\n        Config {\n            database_url: \"\".into(),\n            read_database_url: None,\n            jwt_secret: \"\".into(),\n            jwt_expiration_hours: 1,\n            refresh_token_expiration_days: 1,\n            max_concurrent_sessions: 3,\n            audit_log_retention_days: 1825,\n            audit_log_retention_forever: false,\n            consent_log_retention_days: 1825,\n            consent_log_retention_forever: false,\n            aws_region: \"ap-northeast-1\".into(),\n            aws_kms_key_id: \"alias/timekeeper-test\".into(),\n            aws_audit_log_bucket: \"timekeeper-audit-logs\".into(),\n            aws_cloudtrail_enabled: true,\n            cookie_secure: false,\n            cookie_same_site: crate::utils::cookies::SameSite::Lax,\n            cors_allow_origins: allowed,\n            time_zone: UTC,\n            mfa_issuer: \"\".into(),\n            rate_limit_ip_max_requests: 15,\n            rate_limit_ip_window_seconds: 900,\n            rate_limit_user_max_requests: 20,\n            rate_limit_user_window_seconds: 3600,\n            redis_url: None,\n            redis_pool_size: 10,\n            redis_connect_timeout: 5,\n            feature_redis_cache_enabled: true,\n            feature_read_replica_enabled: true,\n            password_min_length: 12,\n            password_require_uppercase: true,\n            password_require_lowercase: true,\n            password_require_numbers: true,\n            password_require_symbols: true,\n            password_expiration_days: 90,\n            password_history_count: 5,\n            production_mode: false,\n        }\n    }\n\n    #[test]\n    fn verify_origin_success() {\n        let config = test_config(vec![\"http://localhost:3000\".into()]);\n        let mut headers = HeaderMap::new();\n        headers.insert(\"Origin\", \"http://localhost:3000\".parse().unwrap());\n        assert!(verify_request_origin(\u0026headers, \u0026config).is_ok());\n    }\n\n    #[test]\n    fn verify_origin_failure_mismatch() {\n        let config = test_config(vec![\"http://localhost:3000\".into()]);\n        let mut headers = HeaderMap::new();\n        headers.insert(\"Origin\", \"http://evil.com\".parse().unwrap());\n        assert!(verify_request_origin(\u0026headers, \u0026config).is_err());\n    }\n\n    #[test]\n    fn verify_origin_failure_missing() {\n        let config = test_config(vec![\"http://localhost:3000\".into()]);\n        let headers = HeaderMap::new();\n        assert!(verify_request_origin(\u0026headers, \u0026config).is_err());\n    }\n\n    #[test]\n    fn verify_origin_success_wildcard() {\n        let config = test_config(vec![\"*\".into()]);\n        let mut headers = HeaderMap::new();\n        headers.insert(\"Origin\", \"http://anywhere.com\".parse().unwrap());\n        assert!(verify_request_origin(\u0026headers, \u0026config).is_ok());\n    }\n\n    #[test]\n    fn verify_referer_fallback() {\n        let config = test_config(vec![\"http://localhost:3000\".into()]);\n        let mut headers = HeaderMap::new();\n        headers.insert(\"Referer\", \"http://localhost:3000\".parse().unwrap());\n        assert!(verify_request_origin(\u0026headers, \u0026config).is_ok());\n    }\n}\n","traces":[{"line":6,"address":[22244576,22244710,22244716],"length":1,"stats":{"Line":0},"fn_name":"generate_token"},{"line":8,"address":[22244600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":10,"address":[22855232],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":11,"address":[22855246],"length":1,"stats":{"Line":0},"fn_name":null},{"line":12,"address":[22855274,22855306],"length":1,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[22245584],"length":1,"stats":{"Line":1},"fn_name":"verify_request_origin"},{"line":20,"address":[22855376,22855385],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":21,"address":[22855552,22855328,22855333,22855561],"length":1,"stats":{"Line":5},"fn_name":"{closure#1}"},{"line":23,"address":[22245687],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[22245720],"length":1,"stats":{"Line":1},"fn_name":null},{"line":26,"address":[22245868],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[22245833],"length":1,"stats":{"Line":1},"fn_name":null},{"line":33,"address":[22245756,22245823,22246117,22246100],"length":1,"stats":{"Line":4},"fn_name":null},{"line":36,"address":[22855424,22855443],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":38,"address":[22246110],"length":1,"stats":{"Line":1},"fn_name":null},{"line":40,"address":[22245955],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[22244736],"length":1,"stats":{"Line":1},"fn_name":"mask_database_url"},{"line":45,"address":[22244795],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[22244912,22244973,22244852],"length":1,"stats":{"Line":2},"fn_name":null},{"line":47,"address":[22244920,22244991],"length":1,"stats":{"Line":2},"fn_name":null},{"line":48,"address":[22245130,22245004],"length":1,"stats":{"Line":1},"fn_name":null},{"line":49,"address":[22245048],"length":1,"stats":{"Line":1},"fn_name":null},{"line":51,"address":[22245153,22245093],"length":1,"stats":{"Line":2},"fn_name":null},{"line":52,"address":[22245166],"length":1,"stats":{"Line":1},"fn_name":null},{"line":53,"address":[22245216],"length":1,"stats":{"Line":1},"fn_name":null},{"line":54,"address":[22245266],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[22244886],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":22,"coverable":27},{"path":["/","home","marra","projects","timekeeper","backend","src","utils","time.rs"],"content":"use chrono::{DateTime, NaiveDate, Utc};\nuse chrono_tz::Tz;\n\n/// Returns the current time in the configured timezone.\npub fn now_in_timezone(tz: \u0026Tz) -\u003e DateTime\u003cTz\u003e {\n    Utc::now().with_timezone(tz)\n}\n\n/// Returns the current UTC time, aligned with the configured timezone.\npub fn now_utc(tz: \u0026Tz) -\u003e DateTime\u003cUtc\u003e {\n    now_in_timezone(tz).with_timezone(\u0026Utc)\n}\n\n/// Returns today's date in the configured timezone.\npub fn today_local(tz: \u0026Tz) -\u003e NaiveDate {\n    now_in_timezone(tz).date_naive()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn now_in_timezone_returns_datetime_in_tz() {\n        let tz = chrono_tz::UTC;\n        let result = now_in_timezone(\u0026tz);\n        assert_eq!(result.timezone(), tz);\n    }\n\n    #[test]\n    fn now_utc_returns_utc_datetime() {\n        let tz = chrono_tz::UTC;\n        let result = now_utc(\u0026tz);\n        assert_eq!(result.timezone(), Utc);\n    }\n\n    #[test]\n    fn today_local_returns_naive_date() {\n        let tz = chrono_tz::UTC;\n        let result = today_local(\u0026tz);\n        assert_eq!(\n            result.and_hms_opt(0, 0, 0),\n            Some(result.and_hms_opt(0, 0, 0).unwrap())\n        );\n    }\n\n    #[test]\n    fn now_utc_is_close_to_utc_now() {\n        let tz = chrono_tz::UTC;\n        let result = now_utc(\u0026tz);\n        let utc_now = Utc::now();\n        let diff = (result - utc_now).num_seconds().abs();\n        assert!(diff \u003c 2, \"Difference should be less than 2 seconds\");\n    }\n}\n","traces":[{"line":5,"address":[18747440],"length":1,"stats":{"Line":1},"fn_name":"now_in_timezone"},{"line":6,"address":[18747464],"length":1,"stats":{"Line":1},"fn_name":null},{"line":10,"address":[18747520],"length":1,"stats":{"Line":1},"fn_name":"now_utc"},{"line":11,"address":[18747538],"length":1,"stats":{"Line":1},"fn_name":null},{"line":15,"address":[18747392],"length":1,"stats":{"Line":1},"fn_name":"today_local"},{"line":16,"address":[18747404],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":6,"coverable":6},{"path":["/","home","marra","projects","timekeeper","backend","src","validation","mod.rs"],"content":"//! Unified validation framework for request payloads.\n//!\n//! This module provides reusable validation rules and utilities\n//! to ensure consistent input validation across all API endpoints.\n\npub mod rules;\n\npub use validator::Validate;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","src","validation","rules.rs"],"content":"//! Common validation rules shared across request payloads.\n\nuse validator::ValidationError;\n\n/// Validates password strength requirements.\n///\n/// Requirements:\n/// - At least 8 characters\n/// - Contains at least one uppercase letter\n/// - Contains at least one lowercase letter\n/// - Contains at least one digit\npub fn validate_password_strength(password: \u0026str) -\u003e Result\u003c(), ValidationError\u003e {\n    if password.len() \u003c 8 {\n        return Err(ValidationError::new(\"password_too_short\"));\n    }\n\n    let has_uppercase = password.chars().any(|c| c.is_uppercase());\n    let has_lowercase = password.chars().any(|c| c.is_lowercase());\n    let has_digit = password.chars().any(|c| c.is_ascii_digit());\n\n    if !has_uppercase {\n        return Err(ValidationError::new(\"password_missing_uppercase\"));\n    }\n    if !has_lowercase {\n        return Err(ValidationError::new(\"password_missing_lowercase\"));\n    }\n    if !has_digit {\n        return Err(ValidationError::new(\"password_missing_digit\"));\n    }\n\n    Ok(())\n}\n\n/// Validates username format.\n///\n/// Requirements:\n/// - Only alphanumeric characters and underscores\n/// - 1-50 characters in length\npub fn validate_username(username: \u0026str) -\u003e Result\u003c(), ValidationError\u003e {\n    if username.is_empty() || username.len() \u003e 50 {\n        return Err(ValidationError::new(\"username_invalid_length\"));\n    }\n\n    if !username.chars().all(|c| c.is_alphanumeric() || c == '_') {\n        return Err(ValidationError::new(\"username_invalid_characters\"));\n    }\n\n    Ok(())\n}\n\n/// Validates that planned hours are within acceptable range.\n///\n/// Requirements:\n/// - Between 0.5 and 24.0 hours\n#[allow(dead_code)]\npub fn validate_planned_hours(hours: f64) -\u003e Result\u003c(), ValidationError\u003e {\n    if !(0.5..=24.0).contains(\u0026hours) {\n        return Err(ValidationError::new(\"planned_hours_out_of_range\"));\n    }\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn password_strength_rejects_short_password() {\n        let result = validate_password_strength(\"Short1A\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn password_strength_rejects_no_uppercase() {\n        let result = validate_password_strength(\"lowercase123\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn password_strength_rejects_no_lowercase() {\n        let result = validate_password_strength(\"UPPERCASE123\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn password_strength_rejects_no_digit() {\n        let result = validate_password_strength(\"NoDigitsHere\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn password_strength_accepts_valid_password() {\n        let result = validate_password_strength(\"ValidPass123\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn username_rejects_empty() {\n        let result = validate_username(\"\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn username_rejects_special_chars() {\n        let result = validate_username(\"user@name\");\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn username_accepts_valid() {\n        let result = validate_username(\"valid_user123\");\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn planned_hours_rejects_too_low() {\n        let result = validate_planned_hours(0.25);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn planned_hours_rejects_too_high() {\n        let result = validate_planned_hours(25.0);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn planned_hours_accepts_valid() {\n        let result = validate_planned_hours(2.5);\n        assert!(result.is_ok());\n    }\n}\n","traces":[{"line":12,"address":[21899712],"length":1,"stats":{"Line":1},"fn_name":"validate_password_strength"},{"line":13,"address":[21899771],"length":1,"stats":{"Line":1},"fn_name":null},{"line":14,"address":[21899970],"length":1,"stats":{"Line":1},"fn_name":null},{"line":17,"address":[19288168,19288144],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":18,"address":[19288192,19288216],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":19,"address":[19288240,19288253],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":21,"address":[21899964],"length":1,"stats":{"Line":1},"fn_name":null},{"line":22,"address":[21900015],"length":1,"stats":{"Line":1},"fn_name":null},{"line":24,"address":[21900070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":25,"address":[21900089],"length":1,"stats":{"Line":1},"fn_name":null},{"line":27,"address":[21900144],"length":1,"stats":{"Line":1},"fn_name":null},{"line":28,"address":[21900150],"length":1,"stats":{"Line":1},"fn_name":null},{"line":31,"address":[21900206],"length":1,"stats":{"Line":1},"fn_name":null},{"line":39,"address":[21899328],"length":1,"stats":{"Line":1},"fn_name":"validate_username"},{"line":40,"address":[21899387],"length":1,"stats":{"Line":1},"fn_name":null},{"line":41,"address":[21899417],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[19288064,19288092],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":45,"address":[21899510],"length":1,"stats":{"Line":1},"fn_name":null},{"line":48,"address":[21899566],"length":1,"stats":{"Line":1},"fn_name":null},{"line":56,"address":[21899600],"length":1,"stats":{"Line":1},"fn_name":"validate_planned_hours"},{"line":57,"address":[21899619],"length":1,"stats":{"Line":1},"fn_name":null},{"line":58,"address":[21899640],"length":1,"stats":{"Line":1},"fn_name":null},{"line":60,"address":[21899688],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":23,"coverable":23},{"path":["/","home","marra","projects","timekeeper","backend","tests","active_session_repo.rs"],"content":"use chrono::{Duration as ChronoDuration, Utc};\nuse std::sync::OnceLock;\nuse timekeeper_backend::{models::user::UserRole, repositories::active_session};\nuse tokio::sync::Mutex;\nuse uuid::Uuid;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\nasync fn insert_refresh_token(\n    pool: \u0026sqlx::PgPool,\n    user_id: \u0026str,\n    expires_at: chrono::DateTime\u003cUtc\u003e,\n) -\u003e String {\n    let token_id = Uuid::new_v4().to_string();\n    let token_hash = format!(\"hash-{}\", token_id);\n    sqlx::query(\n        \"INSERT INTO refresh_tokens (id, user_id, token_hash, expires_at) VALUES ($1, $2, $3, $4)\",\n    )\n    .bind(\u0026token_id)\n    .bind(user_id)\n    .bind(\u0026token_hash)\n    .bind(expires_at)\n    .execute(pool)\n    .await\n    .expect(\"insert refresh token\");\n    token_id\n}\n\nfn assert_same_millis(left: chrono::DateTime\u003cUtc\u003e, right: chrono::DateTime\u003cUtc\u003e) {\n    assert_eq!(left.timestamp_millis(), right.timestamp_millis());\n}\n\n#[tokio::test]\nasync fn active_session_repo_roundtrip() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE active_sessions, refresh_tokens\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate session tables\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let expires_at = Utc::now() + ChronoDuration::hours(1);\n    let refresh_token_id = insert_refresh_token(\u0026pool, \u0026user.id.to_string(), expires_at).await;\n    let access_jti = Uuid::new_v4().to_string();\n\n    let created = active_session::create_active_session(\n        \u0026pool,\n        user.id,\n        \u0026refresh_token_id,\n        \u0026access_jti,\n        Some(\"macbook-pro\"),\n        expires_at,\n    )\n    .await\n    .expect(\"create active session\");\n\n    assert_eq!(created.user_id, user.id);\n    assert_eq!(created.refresh_token_id, refresh_token_id);\n    assert_eq!(created.access_jti.as_deref(), Some(access_jti.as_str()));\n    assert_eq!(created.device_label.as_deref(), Some(\"macbook-pro\"));\n    assert_same_millis(created.expires_at, expires_at);\n    assert!(created.last_seen_at.is_some());\n\n    let sessions = active_session::list_active_sessions_for_user(\u0026pool, user.id)\n        .await\n        .expect(\"list active sessions\");\n    assert_eq!(sessions.len(), 1);\n    assert_eq!(sessions[0].id, created.id);\n\n    let new_last_seen = Utc::now() + ChronoDuration::minutes(5);\n    active_session::touch_active_session_by_access_jti(\u0026pool, \u0026access_jti, new_last_seen)\n        .await\n        .expect(\"touch active session\");\n\n    let sessions = active_session::list_active_sessions_for_user(\u0026pool, user.id)\n        .await\n        .expect(\"list active sessions after touch\");\n    assert_same_millis(\n        sessions[0].last_seen_at.expect(\"last_seen_at\"),\n        new_last_seen,\n    );\n\n    sqlx::query(\"TRUNCATE active_sessions, refresh_tokens\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate session tables\");\n}\n\n#[tokio::test]\nasync fn active_session_repo_deletes_by_refresh_token() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE active_sessions, refresh_tokens\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate session tables\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let expires_at = Utc::now() + ChronoDuration::hours(2);\n    let refresh_token_id = insert_refresh_token(\u0026pool, \u0026user.id.to_string(), expires_at).await;\n    let access_jti = Uuid::new_v4().to_string();\n\n    let created = active_session::create_active_session(\n        \u0026pool,\n        user.id,\n        \u0026refresh_token_id,\n        \u0026access_jti,\n        None,\n        expires_at,\n    )\n    .await\n    .expect(\"create active session\");\n\n    active_session::delete_active_session_by_id(\u0026pool, \u0026created.id)\n        .await\n        .expect(\"delete by id\");\n\n    let sessions = active_session::list_active_sessions_for_user(\u0026pool, user.id)\n        .await\n        .expect(\"list active sessions\");\n    assert!(sessions.is_empty());\n\n    sqlx::query(\"TRUNCATE active_sessions, refresh_tokens\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate session tables\");\n}\n\n#[tokio::test]\nasync fn active_session_repo_cleans_expired_sessions() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE active_sessions, refresh_tokens\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate session tables\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let expired_at = Utc::now() - ChronoDuration::hours(1);\n    let valid_expires_at = Utc::now() + ChronoDuration::hours(1);\n    let expired_refresh = insert_refresh_token(\u0026pool, \u0026user.id.to_string(), valid_expires_at).await;\n    let valid_refresh = insert_refresh_token(\u0026pool, \u0026user.id.to_string(), valid_expires_at).await;\n    let expired_access_jti = Uuid::new_v4().to_string();\n    let valid_access_jti = Uuid::new_v4().to_string();\n\n    active_session::create_active_session(\n        \u0026pool,\n        user.id,\n        \u0026expired_refresh,\n        \u0026expired_access_jti,\n        Some(\"expired\"),\n        expired_at,\n    )\n    .await\n    .expect(\"create expired session\");\n    active_session::create_active_session(\n        \u0026pool,\n        user.id,\n        \u0026valid_refresh,\n        \u0026valid_access_jti,\n        Some(\"valid\"),\n        valid_expires_at,\n    )\n    .await\n    .expect(\"create valid session\");\n\n    let deleted = active_session::cleanup_expired_sessions(\u0026pool)\n        .await\n        .expect(\"cleanup expired sessions\");\n    assert_eq!(deleted, 1);\n\n    let sessions = active_session::list_active_sessions_for_user(\u0026pool, user.id)\n        .await\n        .expect(\"list remaining sessions\");\n    assert_eq!(sessions.len(), 1);\n    assert_eq!(sessions[0].device_label.as_deref(), Some(\"valid\"));\n\n    sqlx::query(\"TRUNCATE active_sessions, refresh_tokens\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate session tables\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_attendance_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::admin::attendance,\n    models::user::{User, UserRole},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/attendance\", axum::routing::get(attendance::get_all_attendance))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\nfn test_router_with_upsert(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/attendance\", axum::routing::put(attendance::upsert_attendance))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_list_all_attendance() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let _employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/attendance\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_regular_admin_cannot_list_all_attendance() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/attendance\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_list_all_attendance() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/attendance\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_upsert_attendance() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_upsert(pool.clone(), sysadmin.clone());\n    \n    let payload = json!({\n        \"user_id\": employee.id.to_string(),\n        \"date\": \"2024-07-15\",\n        \"clock_in_time\": \"2024-07-15T09:00:00\",\n        \"clock_out_time\": \"2024-07-15T18:00:00\",\n        \"breaks\": [\n            {\n                \"break_start_time\": \"2024-07-15T12:00:00\",\n                \"break_end_time\": \"2024-07-15T13:00:00\"\n            }\n        ]\n    });\n    \n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/admin/attendance\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_regular_admin_cannot_upsert_attendance() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_upsert(pool.clone(), admin.clone());\n    \n    let payload = json!({\n        \"user_id\": employee.id.to_string(),\n        \"date\": \"2024-07-15\",\n        \"clock_in_time\": \"2024-07-15T09:00:00\",\n        \"clock_out_time\": \"2024-07-15T18:00:00\"\n    });\n    \n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/admin/attendance\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_upsert_attendance_with_invalid_date_format_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_upsert(pool.clone(), sysadmin.clone());\n    \n    let payload = json!({\n        \"user_id\": employee.id.to_string(),\n        \"date\": \"invalid-date\",\n        \"clock_in_time\": \"2024-07-15T09:00:00\"\n    });\n    \n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/admin/attendance\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_audit_logs_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::admin::audit_logs,\n    models::user::{User, UserRole},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/audit-logs\", axum::routing::get(audit_logs::list_audit_logs))\n        .route(\"/api/admin/audit-logs/{id}\", axum::routing::get(audit_logs::get_audit_log_detail))\n        .route(\"/api/admin/audit-logs/export\", axum::routing::get(audit_logs::export_audit_logs))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\nasync fn seed_audit_log(pool: \u0026PgPool, actor_id: timekeeper_backend::types::UserId) -\u003e String {\n    let id = uuid::Uuid::new_v4().to_string();\n    sqlx::query(\n        r#\"\n        INSERT INTO audit_logs (id, occurred_at, actor_id, actor_type, event_type, target_type, target_id, result, created_at)\n        VALUES ($1, NOW(), $2, 'user', 'test_event', 'test_target', 'test-id', 'success', NOW())\n        \"#\n    )\n    .bind(\u0026id)\n    .bind(actor_id.to_string())\n    .execute(pool)\n    .await\n    .expect(\"insert audit log\");\n    id\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_list_audit_logs() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_audit_log(\u0026pool, employee.id).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json[\"items\"].as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_regular_admin_cannot_list_audit_logs_without_permission() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_list_audit_logs() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_export_audit_logs() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_audit_log(\u0026pool, employee.id).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs/export?from=2024-01-01\u0026to=2024-12-31\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_export_with_excessive_date_range_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs/export?from=2024-01-01\u0026to=2024-06-01\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_list_audit_logs_with_actor_filter() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_audit_log(\u0026pool, employee.id).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/admin/audit-logs?actor_id={}\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_list_audit_logs_with_event_type_filter() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_audit_log(\u0026pool, employee.id).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs?event_type=test_event\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_list_audit_logs_with_result_filter() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_audit_log(\u0026pool, employee.id).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs?result=success\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_invalid_result_filter_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs?result=invalid\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_get_audit_log_detail() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let log_id = seed_audit_log(\u0026pool, employee.id).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/admin/audit-logs/{}\", log_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_get_nonexistent_audit_log_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/admin/audit-logs/{}\", uuid::Uuid::new_v4()))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_export_api.rs"],"content":"use axum::{\n    body::{to_bytes, Body},\n    http::Request,\n    routing::get,\n    Extension, Router,\n};\nuse chrono::{NaiveDate, Utc};\nuse serde_json::Value;\nuse sqlx::PgPool;\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    handlers::admin::export_data,\n    models::{attendance::Attendance, user::UserRole},\n    repositories::{attendance::AttendanceRepository, AttendanceRepositoryTrait, repository::Repository},\n    state::AppState,\n};\nuse tokio::sync::Mutex;\nuse tower::ServiceExt;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\nasync fn reset_attendance_tables(pool: \u0026PgPool) {\n    sqlx::query(\"TRUNCATE break_records, attendance\")\n        .execute(pool)\n        .await\n        .expect(\"truncate attendance tables\");\n}\n\n#[tokio::test]\nasync fn admin_export_includes_date_strings() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_attendance_tables(\u0026pool).await;\n\n    let admin = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n\n    let date = NaiveDate::from_ymd_opt(2026, 1, 15).expect(\"valid date\");\n    let now = Utc::now();\n    let attendance = Attendance::new(employee.id, date, now);\n    let repo = AttendanceRepository::new();\n    repo.create(\u0026pool, \u0026attendance)\n        .await\n        .expect(\"create attendance\");\n\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n    let app = Router::new()\n        .route(\"/api/admin/export\", get(export_data))\n        .layer(Extension(admin))\n        .with_state(state);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(\"/api/admin/export\")\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert!(response.status().is_success());\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let payload: Value = serde_json::from_slice(\u0026body).expect(\"parse response\");\n    let csv_data = payload\n        .get(\"csv_data\")\n        .and_then(|value| value.as_str())\n        .unwrap_or(\"\");\n\n    assert!(csv_data.contains(\"\\\"2026-01-15\\\"\"));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_holiday_list.rs"],"content":"use axum::extract::{Extension, Query, State};\nuse chrono::{DateTime, NaiveDate, TimeZone, Utc};\nuse chrono_tz::UTC;\nuse sqlx::{postgres::PgPoolOptions, PgPool};\nuse std::str::FromStr;\n#[cfg(feature = \"test-utils\")]\nuse std::sync::{Mutex, OnceLock};\n#[cfg(feature = \"test-utils\")]\nuse std::time::Duration;\nuse timekeeper_backend::{\n    config::Config,\n    error::AppError,\n    handlers::admin::holidays::{list_holidays, AdminHolidayListQuery, AdminHolidayListResponse},\n    models::{\n        holiday::{AdminHolidayKind, AdminHolidayListItem},\n        user::{User, UserRole},\n    },\n    state::AppState,\n    utils::cookies::SameSite,\n};\n\n#[cfg(feature = \"test-utils\")]\nfn integration_guard() -\u003e std::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD\n        .get_or_init(|| Mutex::new(()))\n        .lock()\n        .expect(\"lock integration guard\")\n}\n\nfn build_item(\n    id: \u0026str,\n    kind: AdminHolidayKind,\n    date: NaiveDate,\n    created_at: DateTime\u003cUtc\u003e,\n) -\u003e AdminHolidayListItem {\n    AdminHolidayListItem {\n        id: id.to_string(),\n        kind,\n        applies_from: date,\n        applies_to: Some(date),\n        date: Some(date),\n        weekday: None,\n        starts_on: None,\n        ends_on: None,\n        name: Some(id.to_string()),\n        description: None,\n        user_id: None,\n        reason: None,\n        created_by: None,\n        created_at,\n        is_override: None,\n    }\n}\n\nfn mock_list_holidays(\n    items: Vec\u003cAdminHolidayListItem\u003e,\n    query: AdminHolidayListQuery,\n) -\u003e Result\u003cAdminHolidayListResponse, String\u003e {\n    let (page, per_page) = (\n        query.page.unwrap_or(1).clamp(1, 1_000),\n        query.per_page.unwrap_or(25).clamp(1, 100),\n    );\n\n    let kind = match query.r#type.as_deref() {\n        Some(value) if value.eq_ignore_ascii_case(\"all\") =\u003e None,\n        Some(value) =\u003e AdminHolidayKind::from_str(value)\n            .map(Some)\n            .map_err(|_| \"`type` must be one of public, weekly, exception, all\".to_string())?,\n        None =\u003e None,\n    };\n\n    let parse_date = |s: \u0026str| {\n        DateTime::parse_from_rfc3339(s)\n            .map(|dt| dt.date_naive())\n            .or_else(|_| NaiveDate::parse_from_str(s, \"%Y-%m-%d\"))\n            .ok()\n    };\n\n    let from = query\n        .from\n        .as_deref()\n        .map(|s| parse_date(s).ok_or(\"`from`/`to` must be a valid date (YYYY-MM-DD or RFC3339)\"))\n        .transpose()?;\n    let to = query\n        .to\n        .as_deref()\n        .map(|s| parse_date(s).ok_or(\"`from`/`to` must be a valid date (YYYY-MM-DD or RFC3339)\"))\n        .transpose()?;\n\n    if let (Some(from), Some(to)) = (from, to) {\n        if from \u003e to {\n            return Err(\"`from` must be before or equal to `to`\".into());\n        }\n    }\n\n    let mut filtered: Vec\u003cAdminHolidayListItem\u003e = items\n        .into_iter()\n        .filter(|item| kind.map(|k| item.kind == k).unwrap_or(true))\n        .filter(|item| from.map(|f| item.applies_from \u003e= f).unwrap_or(true))\n        .filter(|item| to.map(|t| item.applies_from \u003c= t).unwrap_or(true))\n        .collect();\n\n    filtered.sort_by(|a, b| {\n        b.applies_from\n            .cmp(\u0026a.applies_from)\n            .then_with(|| {\n                fn kind_sort_key(kind: \u0026AdminHolidayKind) -\u003e \u0026'static str {\n                    match kind {\n                        AdminHolidayKind::Exception =\u003e \"exception\",\n                        AdminHolidayKind::Public =\u003e \"public\",\n                        AdminHolidayKind::Weekly =\u003e \"weekly\",\n                    }\n                }\n                kind_sort_key(\u0026a.kind).cmp(kind_sort_key(\u0026b.kind))\n            })\n            .then_with(|| b.created_at.cmp(\u0026a.created_at))\n    });\n\n    let total = filtered.len() as i64;\n    let offset = ((page - 1) * per_page) as usize;\n    let items = filtered\n        .into_iter()\n        .skip(offset)\n        .take(per_page as usize)\n        .collect();\n\n    Ok(AdminHolidayListResponse {\n        page,\n        per_page,\n        total,\n        items,\n    })\n}\n\nfn test_admin() -\u003e User {\n    User::new(\n        \"admin\".into(),\n        \"hash\".into(),\n        \"Administrator\".into(),\n        \"admin@example.com\".into(),\n        UserRole::Admin,\n        true,\n    )\n}\n\nfn dummy_config() -\u003e Config {\n    Config {\n        database_url: \"postgres://invalid:invalid@localhost:5432/invalid\".into(),\n        read_database_url: None,\n        jwt_secret: \"this_is_a_long_enough_jwt_secret_string_123\".into(),\n        jwt_expiration_hours: 1,\n        refresh_token_expiration_days: 7,\n        max_concurrent_sessions: 3,\n        audit_log_retention_days: 1825,\n        audit_log_retention_forever: false,\n        consent_log_retention_days: 1825,\n        consent_log_retention_forever: false,\n        aws_region: \"ap-northeast-1\".into(),\n        aws_kms_key_id: \"alias/timekeeper-test\".into(),\n        aws_audit_log_bucket: \"timekeeper-audit-logs\".into(),\n        aws_cloudtrail_enabled: true,\n        cookie_secure: false,\n        cookie_same_site: SameSite::Lax,\n        cors_allow_origins: vec![\"http://localhost:8000\".into()],\n        time_zone: UTC,\n        mfa_issuer: \"Timekeeper\".into(),\n        rate_limit_ip_max_requests: 15,\n        rate_limit_ip_window_seconds: 900,\n        rate_limit_user_max_requests: 20,\n        rate_limit_user_window_seconds: 3600,\n        redis_url: None,\n        redis_pool_size: 10,\n        redis_connect_timeout: 5,\n        feature_redis_cache_enabled: true,\n        feature_read_replica_enabled: true,\n        password_min_length: 12,\n        password_require_uppercase: true,\n        password_require_lowercase: true,\n        password_require_numbers: true,\n        password_require_symbols: true,\n        password_expiration_days: 90,\n        password_history_count: 5,\n        production_mode: false,\n    }\n}\n\n#[test]\nfn admin_holiday_list_filters_by_type() {\n    let base_date = NaiveDate::from_ymd_opt(2025, 1, 10).unwrap();\n    let created_at = Utc.timestamp_millis_opt(0).single().unwrap();\n    let items = vec![\n        build_item(\"public\", AdminHolidayKind::Public, base_date, created_at),\n        build_item(\"weekly\", AdminHolidayKind::Weekly, base_date, created_at),\n        build_item(\n            \"exception\",\n            AdminHolidayKind::Exception,\n            base_date,\n            created_at,\n        ),\n    ];\n\n    let query = AdminHolidayListQuery {\n        page: Some(1),\n        per_page: Some(20),\n        r#type: Some(\"public\".into()),\n        from: None,\n        to: None,\n    };\n\n    let response = mock_list_holidays(items, query).expect(\"filtering should succeed\");\n\n    assert_eq!(response.total, 1);\n    assert_eq!(response.items.len(), 1);\n    assert_eq!(response.items[0].kind, AdminHolidayKind::Public);\n    assert_eq!(response.items[0].date, Some(base_date));\n}\n\n#[test]\nfn admin_holiday_list_supports_pagination_and_range() {\n    let dates = [\n        NaiveDate::from_ymd_opt(2025, 3, 1).unwrap(),\n        NaiveDate::from_ymd_opt(2025, 3, 5).unwrap(),\n        NaiveDate::from_ymd_opt(2025, 3, 10).unwrap(),\n    ];\n    let base_created = Utc.timestamp_millis_opt(10_000).single().unwrap();\n    let items: Vec\u003c_\u003e = dates\n        .iter()\n        .enumerate()\n        .map(|(idx, d)| {\n            let created_at = base_created + chrono::Duration::milliseconds(idx as i64);\n            build_item(\n                \u0026format!(\"Holiday {}\", idx),\n                AdminHolidayKind::Public,\n                *d,\n                created_at,\n            )\n        })\n        .collect();\n\n    let query = AdminHolidayListQuery {\n        page: Some(2),\n        per_page: Some(1),\n        r#type: Some(\"all\".into()),\n        from: Some(\"2025-03-01\".into()),\n        to: Some(\"2025-03-06\".into()),\n    };\n\n    let response = mock_list_holidays(items, query).expect(\"pagination should succeed\");\n\n    assert_eq!(response.total, 2);\n    assert_eq!(response.page, 2);\n    assert_eq!(response.per_page, 1);\n    assert_eq!(response.items.len(), 1);\n    assert!(response\n        .items\n        .iter()\n        .all(|item| item.kind == AdminHolidayKind::Public));\n    assert_eq!(\n        response.items[0].applies_from,\n        NaiveDate::from_ymd_opt(2025, 3, 1).unwrap()\n    );\n}\n\n#[tokio::test]\nasync fn admin_holiday_list_rejects_unknown_type() {\n    let pool = PgPoolOptions::new()\n        .connect_lazy(\"postgres://invalid:invalid@localhost:5432/invalid\")\n        .expect(\"create lazy pool\");\n\n    let query = AdminHolidayListQuery {\n        page: Some(1),\n        per_page: Some(10),\n        r#type: Some(\"unknown-kind\".into()),\n        from: None,\n        to: None,\n    };\n\n    let result = list_holidays(\n        State(AppState::new(pool, None, None, None, dummy_config())),\n        Extension(test_admin()),\n        Query(query),\n    )\n    .await;\n\n    match result {\n        Ok(_) =\u003e panic!(\"expected bad request for invalid type\"),\n        Err(AppError::BadRequest(msg)) =\u003e {\n            assert_eq!(msg, \"`type` must be one of public, weekly, exception, all\");\n        }\n        Err(e) =\u003e panic!(\"unexpected error: {:?}\", e),\n    }\n}\n\n#[tokio::test]\nasync fn admin_holiday_list_rejects_invalid_date_format() {\n    let pool = PgPoolOptions::new()\n        .connect_lazy(\"postgres://invalid:invalid@localhost:5432/invalid\")\n        .expect(\"create lazy pool\");\n\n    let query = AdminHolidayListQuery {\n        page: Some(1),\n        per_page: Some(10),\n        r#type: Some(\"public\".into()),\n        from: Some(\"not-a-date\".into()),\n        to: None,\n    };\n\n    let result = list_holidays(\n        State(AppState::new(pool, None, None, None, dummy_config())),\n        Extension(test_admin()),\n        Query(query),\n    )\n    .await;\n\n    match result {\n        Ok(_) =\u003e panic!(\"expected bad request for invalid date\"),\n        Err(AppError::BadRequest(msg)) =\u003e {\n            assert_eq!(\n                msg,\n                \"`from`/`to` must be a valid date (YYYY-MM-DD or RFC3339)\"\n            );\n        }\n        Err(e) =\u003e panic!(\"unexpected error: {:?}\", e),\n    }\n}\n\n#[tokio::test]\nasync fn admin_holiday_list_rejects_from_after_to() {\n    let pool = PgPoolOptions::new()\n        .connect_lazy(\"postgres://invalid:invalid@localhost:5432/invalid\")\n        .expect(\"create lazy pool\");\n\n    let query = AdminHolidayListQuery {\n        page: Some(1),\n        per_page: Some(10),\n        r#type: Some(\"public\".into()),\n        from: Some(\"2025-05-10\".into()),\n        to: Some(\"2025-05-01\".into()),\n    };\n\n    let result = list_holidays(\n        State(AppState::new(pool, None, None, None, dummy_config())),\n        Extension(test_admin()),\n        Query(query),\n    )\n    .await;\n\n    match result {\n        Ok(_) =\u003e panic!(\"expected bad request when from \u003e to\"),\n        Err(AppError::BadRequest(msg)) =\u003e {\n            assert_eq!(msg, \"`from` must be before or equal to `to`\");\n        }\n        Err(e) =\u003e panic!(\"unexpected error: {:?}\", e),\n    }\n}\n\n#[test]\nfn admin_holiday_list_orders_by_date_kind_and_created_at() {\n    let date_new = NaiveDate::from_ymd_opt(2025, 5, 10).unwrap();\n    let date_old = NaiveDate::from_ymd_opt(2025, 5, 1).unwrap();\n    let items = vec![\n        build_item(\n            \"weekly-old-created\",\n            AdminHolidayKind::Weekly,\n            date_new,\n            Utc.timestamp_millis_opt(100).single().unwrap(),\n        ),\n        build_item(\n            \"weekly-new-created\",\n            AdminHolidayKind::Weekly,\n            date_new,\n            Utc.timestamp_millis_opt(500).single().unwrap(),\n        ),\n        build_item(\n            \"public\",\n            AdminHolidayKind::Public,\n            date_new,\n            Utc.timestamp_millis_opt(200).single().unwrap(),\n        ),\n        build_item(\n            \"exception\",\n            AdminHolidayKind::Exception,\n            date_new,\n            Utc.timestamp_millis_opt(300).single().unwrap(),\n        ),\n        build_item(\n            \"older\",\n            AdminHolidayKind::Public,\n            date_old,\n            Utc.timestamp_millis_opt(400).single().unwrap(),\n        ),\n    ];\n\n    let response = mock_list_holidays(\n        items,\n        AdminHolidayListQuery {\n            page: Some(1),\n            per_page: Some(10),\n            r#type: Some(\"all\".into()),\n            from: None,\n            to: None,\n        },\n    )\n    .expect(\"ordering should succeed\");\n\n    let ids: Vec\u003c_\u003e = response.items.iter().map(|i| i.id.as_str()).collect();\n    assert_eq!(\n        ids,\n        \u0026[\n            \"exception\",          // same date, kind asc =\u003e exception first\n            \"public\",             // then public\n            \"weekly-new-created\", // then weekly (newer created_at first)\n            \"weekly-old-created\",\n            \"older\" // older date last\n        ]\n    );\n}\n\n#[test]\nfn admin_holiday_list_clamps_page_and_per_page() {\n    let date = NaiveDate::from_ymd_opt(2025, 1, 1).unwrap();\n    let created_at = Utc.timestamp_millis_opt(0).single().unwrap();\n    let items = (0..3)\n        .map(|i| {\n            build_item(\n                \u0026format!(\"id-{i}\"),\n                AdminHolidayKind::Public,\n                date,\n                created_at,\n            )\n        })\n        .collect();\n\n    let response = mock_list_holidays(\n        items,\n        AdminHolidayListQuery {\n            page: Some(0),\n            per_page: Some(200),\n            r#type: None,\n            from: None,\n            to: None,\n        },\n    )\n    .expect(\"clamping should succeed\");\n\n    assert_eq!(response.page, 1);\n    assert_eq!(response.per_page, 100);\n    assert_eq!(response.total, 3);\n}\n\n#[allow(dead_code)]\nasync fn prepare_holiday_tables(pool: \u0026PgPool) {\n    sqlx::query(\n        r#\"\n        CREATE TABLE IF NOT EXISTS holidays (\n            id TEXT PRIMARY KEY,\n            holiday_date DATE NOT NULL,\n            name TEXT NOT NULL,\n            description TEXT,\n            created_at TIMESTAMPTZ NOT NULL,\n            updated_at TIMESTAMPTZ NOT NULL\n        )\n        \"#,\n    )\n    .execute(pool)\n    .await\n    .expect(\"create holidays\");\n\n    sqlx::query(\n        r#\"\n        CREATE TABLE IF NOT EXISTS weekly_holidays (\n            id TEXT PRIMARY KEY,\n            weekday SMALLINT NOT NULL,\n            starts_on DATE NOT NULL,\n            ends_on DATE,\n            enforced_from DATE NOT NULL,\n            enforced_to DATE,\n            created_by TEXT NOT NULL,\n            created_at TIMESTAMPTZ NOT NULL,\n            updated_at TIMESTAMPTZ NOT NULL\n        )\n        \"#,\n    )\n    .execute(pool)\n    .await\n    .expect(\"create weekly_holidays\");\n\n    sqlx::query(\n        r#\"\n        CREATE TABLE IF NOT EXISTS holiday_exceptions (\n            id TEXT PRIMARY KEY,\n            user_id TEXT NOT NULL,\n            exception_date DATE NOT NULL,\n            override BOOLEAN NOT NULL,\n            reason TEXT NOT NULL,\n            created_by TEXT NOT NULL,\n            created_at TIMESTAMPTZ NOT NULL,\n            updated_at TIMESTAMPTZ NOT NULL\n        )\n        \"#,\n    )\n    .execute(pool)\n    .await\n    .expect(\"create holiday_exceptions\");\n\n    sqlx::query(\"TRUNCATE TABLE holiday_exceptions, weekly_holidays, holidays\")\n        .execute(pool)\n        .await\n        .expect(\"truncate tables\");\n}\n\n#[allow(dead_code)]\nasync fn seed_integration_holidays(pool: \u0026PgPool) {\n    let created_base = Utc\n        .timestamp_millis_opt(1_742_961_600_000)\n        .single()\n        .unwrap(); // 2025-03-10T00:00:00Z\n\n    sqlx::query(\n        \"INSERT INTO holidays (id, holiday_date, name, description, created_at, updated_at) \\\n         VALUES ($1, $2, $3, NULL, $4, $4)\",\n    )\n    .bind(\"public-310\")\n    .bind(NaiveDate::from_ymd_opt(2025, 3, 10).unwrap())\n    .bind(\"Public Holiday\")\n    .bind(created_base + chrono::Duration::seconds(10))\n    .execute(pool)\n    .await\n    .expect(\"insert public 310\");\n\n    sqlx::query(\n        \"INSERT INTO weekly_holidays (id, weekday, starts_on, ends_on, enforced_from, enforced_to, created_by, created_at, updated_at) \\\n         VALUES ($1, $2, $3, NULL, $4, NULL, 'tester', $5, $5)\",\n    )\n    .bind(\"weekly-310\")\n    .bind(1_i16)\n    .bind(NaiveDate::from_ymd_opt(2025, 3, 1).unwrap())\n    .bind(NaiveDate::from_ymd_opt(2025, 3, 10).unwrap())\n    .bind(created_base + chrono::Duration::seconds(20))\n    .execute(pool)\n    .await\n    .expect(\"insert weekly 310\");\n\n    sqlx::query(\n        \"INSERT INTO holiday_exceptions (id, user_id, exception_date, override, reason, created_by, created_at, updated_at) \\\n         VALUES ($1, 'user', $2, true, 'exceptional', 'tester', $3, $3)\",\n    )\n    .bind(\"exception-310\")\n    .bind(NaiveDate::from_ymd_opt(2025, 3, 10).unwrap())\n    .bind(created_base + chrono::Duration::seconds(30))\n    .execute(pool)\n    .await\n    .expect(\"insert exception 310\");\n\n    sqlx::query(\n        \"INSERT INTO holidays (id, holiday_date, name, description, created_at, updated_at) \\\n         VALUES ($1, $2, $3, NULL, $4, $4)\",\n    )\n    .bind(\"public-305\")\n    .bind(NaiveDate::from_ymd_opt(2025, 3, 5).unwrap())\n    .bind(\"Earlier Public\")\n    .bind(created_base - chrono::Duration::seconds(5 * 24 * 3600))\n    .execute(pool)\n    .await\n    .expect(\"insert public 305\");\n}\n\n#[cfg(feature = \"test-utils\")]\nasync fn connect_with_retry(database_url: \u0026str) -\u003e PgPool {\n    let mut last_err = None;\n    for _ in 0..5 {\n        match PgPoolOptions::new()\n            .max_connections(5)\n            .acquire_timeout(Duration::from_secs(120))\n            .connect(database_url)\n            .await\n        {\n            Ok(pool) =\u003e return pool,\n            Err(e) =\u003e {\n                last_err = Some(e);\n                tokio::time::sleep(Duration::from_secs(1)).await;\n            }\n        }\n    }\n    panic!(\"connect test database: {last_err:?}\");\n}\n\n#[tokio::test]\n#[cfg(feature = \"test-utils\")]\n#[ignore = \"requires Postgres setup; run with --features test-utils and enable when network/storage available\"]\nasync fn admin_holiday_list_integration_success() {\n    let _guard = integration_guard();\n    let config = support::test_config();\n    let pool = connect_with_retry(\u0026config.database_url).await;\n    prepare_holiday_tables(\u0026pool).await;\n    seed_integration_holidays(\u0026pool).await;\n\n    let query = AdminHolidayListQuery {\n        page: Some(1),\n        per_page: Some(2),\n        r#type: Some(\"all\".into()),\n        from: Some(\"2025-03-05\".into()),\n        to: Some(\"2025-03-10\".into()),\n    };\n\n    let Json(resp) = list_holidays(\n        State((pool.clone(), config.clone())),\n        Extension(test_admin()),\n        Query(query),\n    )\n    .await\n    .expect(\"list_holidays should succeed\");\n\n    assert_eq!(resp.total, 4);\n    assert_eq!(resp.items.len(), 2);\n    let ids: Vec\u003c_\u003e = resp.items.iter().map(|i| i.id.as_str()).collect();\n    assert_eq!(ids, vec![\"exception-310\", \"public-310\"]);\n\n    let query_page2 = AdminHolidayListQuery {\n        page: Some(2),\n        per_page: Some(2),\n        r#type: Some(\"all\".into()),\n        from: Some(\"2025-03-05\".into()),\n        to: Some(\"2025-03-10\".into()),\n    };\n\n    let Json(resp2) = list_holidays(\n        State((pool, config)),\n        Extension(test_admin()),\n        Query(query_page2),\n    )\n    .await\n    .expect(\"list_holidays page 2 should succeed\");\n\n    let ids2: Vec\u003c_\u003e = resp2.items.iter().map(|i| i.id.as_str()).collect();\n    assert_eq!(ids2, vec![\"weekly-310\", \"public-305\"]);\n}\n\n#[tokio::test]\n#[cfg(feature = \"test-utils\")]\n#[ignore = \"requires Postgres setup; run with --features test-utils and enable when network/storage available\"]\nasync fn admin_holiday_list_integration_type_filtering() {\n    let _guard = integration_guard();\n    let config = support::test_config();\n    let pool = connect_with_retry(\u0026config.database_url).await;\n    prepare_holiday_tables(\u0026pool).await;\n    seed_integration_holidays(\u0026pool).await;\n\n    // Public only\n    let Json(public_resp) = list_holidays(\n        State((pool.clone(), config.clone())),\n        Extension(test_admin()),\n        Query(AdminHolidayListQuery {\n            page: Some(1),\n            per_page: Some(10),\n            r#type: Some(\"public\".into()),\n            from: None,\n            to: None,\n        }),\n    )\n    .await\n    .expect(\"list_holidays public\");\n    let public_ids: Vec\u003c_\u003e = public_resp.items.iter().map(|i| i.id.as_str()).collect();\n    assert_eq!(public_resp.total, 2);\n    assert_eq!(public_ids, vec![\"public-310\", \"public-305\"]);\n\n    // Weekly only\n    let Json(weekly_resp) = list_holidays(\n        State((pool.clone(), config.clone())),\n        Extension(test_admin()),\n        Query(AdminHolidayListQuery {\n            page: Some(1),\n            per_page: Some(10),\n            r#type: Some(\"weekly\".into()),\n            from: None,\n            to: None,\n        }),\n    )\n    .await\n    .expect(\"list_holidays weekly\");\n    let weekly_ids: Vec\u003c_\u003e = weekly_resp.items.iter().map(|i| i.id.as_str()).collect();\n    assert_eq!(weekly_resp.total, 1);\n    assert_eq!(weekly_ids, vec![\"weekly-310\"]);\n\n    // Exception only\n    let Json(exception_resp) = list_holidays(\n        State((pool, config)),\n        Extension(test_admin()),\n        Query(AdminHolidayListQuery {\n            page: Some(1),\n            per_page: Some(10),\n            r#type: Some(\"exception\".into()),\n            from: None,\n            to: None,\n        }),\n    )\n    .await\n    .expect(\"list_holidays exception\");\n    let exception_ids: Vec\u003c_\u003e = exception_resp.items.iter().map(|i| i.id.as_str()).collect();\n    assert_eq!(exception_resp.total, 1);\n    assert_eq!(exception_ids, vec![\"exception-310\"]);\n}\n\n#[test]\nfn validate_admin_holiday_query_accepts_valid_input() {\n    let result = mock_list_holidays(\n        vec![],\n        AdminHolidayListQuery {\n            page: Some(2),\n            per_page: Some(50),\n            r#type: Some(\"weekly\".into()),\n            from: Some(\"2025-01-01\".into()),\n            to: Some(\"2025-12-31\".into()),\n        },\n    );\n    assert!(result.is_ok(), \"validation should succeed\");\n}\n\n#[test]\nfn validate_admin_holiday_query_rejects_invalid_type() {\n    let err = mock_list_holidays(\n        vec![],\n        AdminHolidayListQuery {\n            page: None,\n            per_page: None,\n            r#type: Some(\"unknown\".into()),\n            from: None,\n            to: None,\n        },\n    )\n    .expect_err(\"invalid type should fail\");\n    assert_eq!(err, \"`type` must be one of public, weekly, exception, all\");\n}\n\n#[test]\nfn validate_admin_holiday_query_rejects_invalid_date_formats() {\n    let err = mock_list_holidays(\n        vec![],\n        AdminHolidayListQuery {\n            page: Some(1),\n            per_page: Some(10),\n            r#type: Some(\"public\".into()),\n            from: Some(\"2025/01/01\".into()),\n            to: None,\n        },\n    )\n    .expect_err(\"invalid date format should fail\");\n    assert_eq!(\n        err,\n        \"`from`/`to` must be a valid date (YYYY-MM-DD or RFC3339)\"\n    );\n}\n\n#[test]\nfn validate_admin_holiday_query_rejects_from_after_to() {\n    let err = mock_list_holidays(\n        vec![],\n        AdminHolidayListQuery {\n            page: Some(1),\n            per_page: Some(10),\n            r#type: Some(\"public\".into()),\n            from: Some(\"2025-02-01\".into()),\n            to: Some(\"2025-01-01\".into()),\n        },\n    )\n    .expect_err(\"from \u003e to should fail\");\n    assert_eq!(err, \"`from` must be before or equal to `to`\");\n}\n\n#[test]\nfn validate_admin_holiday_query_clamps_page_and_per_page_boundaries() {\n    let response = mock_list_holidays(\n        vec![],\n        AdminHolidayListQuery {\n            page: Some(0),\n            per_page: Some(200),\n            r#type: None,\n            from: None,\n            to: None,\n        },\n    )\n    .expect(\"clamping should succeed\");\n\n    assert_eq!(response.page, 1);\n    assert_eq!(response.per_page, 100);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_holidays_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    routing::get,\n    Extension, Router,\n};\nuse chrono::NaiveDate;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::admin::holidays,\n    models::holiday::{CreateHolidayPayload, CreateWeeklyHolidayPayload},\n    models::user::{User, UserRole},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_public_holiday, seed_user, seed_weekly_holiday, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/holidays\", get(holidays::list_holidays).post(holidays::create_holiday))\n        .route(\"/api/admin/holidays/{id}\", axum::routing::delete(holidays::delete_holiday))\n        .route(\"/api/admin/holidays/weekly\", get(holidays::list_weekly_holidays).post(holidays::create_weekly_holiday))\n        .route(\"/api/admin/holidays/weekly/{id}\", axum::routing::delete(holidays::delete_weekly_holiday))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\nasync fn list_holidays(pool: \u0026PgPool, user: \u0026User) -\u003e StatusCode {\n    let token = create_test_token(user.id, user.role.clone());\n    let app = test_router_with_state(pool.clone(), user.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/holidays\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    response.status()\n}\n\n#[tokio::test]\nasync fn test_admin_can_list_holidays() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let _holiday = seed_public_holiday(\u0026pool, NaiveDate::from_ymd_opt(2024, 1, 1).unwrap(), \"New Year\").await;\n\n    let status = list_holidays(\u0026pool, \u0026admin).await;\n    assert_eq!(status, StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_non_admin_cannot_list_holidays() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n\n    let status = list_holidays(\u0026pool, \u0026employee).await;\n    assert_eq!(status, StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_admin_can_create_public_holiday() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let payload = CreateHolidayPayload {\n        holiday_date: NaiveDate::from_ymd_opt(2024, 12, 25).unwrap(),\n        name: \"Christmas\".to_string(),\n        description: Some(\"Public holiday\".to_string()),\n    };\n\n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/holidays\", axum::routing::post(holidays::create_holiday))\n        .layer(Extension(admin))\n        .with_state(state);\n\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/holidays\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n\n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_cannot_create_holiday_with_empty_name() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let payload = CreateHolidayPayload {\n        holiday_date: NaiveDate::from_ymd_opt(2024, 12, 25).unwrap(),\n        name: \"   \".to_string(),\n        description: None,\n    };\n\n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/holidays\", axum::routing::post(holidays::create_holiday))\n        .layer(Extension(admin))\n        .with_state(state);\n\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/holidays\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n\n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_cannot_create_duplicate_holiday_date() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let existing = seed_public_holiday(\u0026pool, NaiveDate::from_ymd_opt(2024, 7, 4).unwrap(), \"Independence Day\").await;\n    \n    let payload = CreateHolidayPayload {\n        holiday_date: existing.holiday_date,\n        name: \"Another Holiday\".to_string(),\n        description: None,\n    };\n\n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/holidays\", axum::routing::post(holidays::create_holiday))\n        .layer(Extension(admin))\n        .with_state(state);\n\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/holidays\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n\n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_admin_can_delete_holiday() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let holiday = seed_public_holiday(\u0026pool, NaiveDate::from_ymd_opt(2024, 1, 1).unwrap(), \"New Year\").await;\n\n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/holidays/{id}\", axum::routing::delete(holidays::delete_holiday))\n        .layer(Extension(admin))\n        .with_state(state);\n\n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/admin/holidays/{}\", holiday.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n\n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_cannot_create_weekly_holiday_with_invalid_weekday() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let payload = CreateWeeklyHolidayPayload {\n        weekday: 7,\n        starts_on: NaiveDate::from_ymd_opt(2024, 1, 1).unwrap(),\n        ends_on: None,\n    };\n\n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/holidays/weekly\", axum::routing::post(holidays::create_weekly_holiday))\n        .layer(Extension(admin))\n        .with_state(state);\n\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/holidays/weekly\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n\n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_cannot_create_weekly_holiday_with_invalid_date_range() {\n    let pool = test_pool().await;\n    let _guard = integration_guard().await;\n\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let payload = CreateWeeklyHolidayPayload {\n        weekday: 1,\n        starts_on: NaiveDate::from_ymd_opt(2024, 12, 31).unwrap(),\n        ends_on: Some(NaiveDate::from_ymd_opt(2024, 1, 1).unwrap()),\n    };\n\n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/holidays/weekly\", axum::routing::post(holidays::create_weekly_holiday))\n        .layer(Extension(admin))\n        .with_state(state);\n\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/holidays/weekly\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n\n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_requests_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::admin::requests as admin_requests,\n    handlers::requests as user_requests,\n    models::user::{User, UserRole},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_admin(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/requests\", axum::routing::get(admin_requests::list_requests))\n        .route(\"/api/admin/requests/{id}/approve\", axum::routing::post(admin_requests::approve_request))\n        .route(\"/api/admin/requests/{id}/reject\", axum::routing::post(admin_requests::reject_request))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\nfn test_router_user(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/requests/leave\", axum::routing::post(user_requests::create_leave_request))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_admin_can_list_all_requests() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let employee_token = create_test_token(employee.id, employee.role.clone());\n    let user_app = test_router_user(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"annual\",\n        \"start_date\": \"2024-07-15\",\n        \"end_date\": \"2024-07-17\",\n        \"reason\": \"Summer vacation\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", employee_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    user_app.oneshot(request_create).await.unwrap();\n    \n    let admin_token = create_test_token(admin.id, admin.role.clone());\n    let admin_app = test_router_admin(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/requests\")\n        .header(\"Authorization\", format!(\"Bearer {}\", admin_token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = admin_app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_list_all_requests() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_admin(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/requests\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_admin_can_approve_leave_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let employee_token = create_test_token(employee.id, employee.role.clone());\n    let user_app = test_router_user(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"annual\",\n        \"start_date\": \"2024-08-01\",\n        \"end_date\": \"2024-08-03\",\n        \"reason\": \"Personal time\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", employee_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response_create = user_app.oneshot(request_create).await.unwrap();\n    \n    let body = axum::body::to_bytes(response_create.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let request_id = json[\"id\"].as_str().unwrap();\n    \n    let admin_token = create_test_token(admin.id, admin.role.clone());\n    let admin_app = test_router_admin(pool.clone(), admin.clone());\n    \n    let approve_payload = json!({\n        \"comment\": \"Approved for summer break\"\n    });\n    let request_approve = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", admin_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(approve_payload.to_string()))\n        .unwrap();\n    \n    let response = admin_app.oneshot(request_approve).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_admin_can_reject_leave_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let employee_token = create_test_token(employee.id, employee.role.clone());\n    let user_app = test_router_user(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"sick\",\n        \"start_date\": \"2024-09-01\",\n        \"end_date\": \"2024-09-02\",\n        \"reason\": \"Not feeling well\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", employee_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response_create = user_app.oneshot(request_create).await.unwrap();\n    \n    let body = axum::body::to_bytes(response_create.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let request_id = json[\"id\"].as_str().unwrap();\n    \n    let admin_token = create_test_token(admin.id, admin.role.clone());\n    let admin_app = test_router_admin(pool.clone(), admin.clone());\n    \n    let reject_payload = json!({\n        \"comment\": \"Insufficient staffing during this period\"\n    });\n    let request_reject = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/requests/{}/reject\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", admin_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(reject_payload.to_string()))\n        .unwrap();\n    \n    let response = admin_app.oneshot(request_reject).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_approve_already_processed_request_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let employee_token = create_test_token(employee.id, employee.role.clone());\n    let user_app = test_router_user(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"personal\",\n        \"start_date\": \"2024-10-01\",\n        \"end_date\": \"2024-10-01\",\n        \"reason\": \"Personal matter\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", employee_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response_create = user_app.oneshot(request_create).await.unwrap();\n    \n    let body = axum::body::to_bytes(response_create.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let request_id = json[\"id\"].as_str().unwrap();\n    \n    let admin_token = create_test_token(admin.id, admin.role.clone());\n    let admin_app = test_router_admin(pool.clone(), admin.clone());\n    \n    let approve_payload = json!({\n        \"comment\": \"Approved\"\n    });\n    let request_approve = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", admin_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(approve_payload.to_string()))\n        .unwrap();\n    admin_app.clone().oneshot(request_approve).await.unwrap();\n    \n    let request_approve_again = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", admin_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(approve_payload.to_string()))\n        .unwrap();\n    let response = admin_app.oneshot(request_approve_again).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_approve_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee1 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let employee2 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let employee2_token = create_test_token(employee2.id, employee2.role.clone());\n    let user_app = test_router_user(pool.clone(), employee2.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"annual\",\n        \"start_date\": \"2024-11-01\",\n        \"end_date\": \"2024-11-03\",\n        \"reason\": \"Vacation\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", employee2_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response_create = user_app.oneshot(request_create).await.unwrap();\n    \n    let body = axum::body::to_bytes(response_create.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let request_id = json[\"id\"].as_str().unwrap();\n    \n    let employee1_token = create_test_token(employee1.id, employee1.role.clone());\n    let admin_app = test_router_admin(pool.clone(), employee1.clone());\n    \n    let approve_payload = json!({\n        \"comment\": \"Trying to approve\"\n    });\n    let request_approve = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", employee1_token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(approve_payload.to_string()))\n        .unwrap();\n    \n    let response = admin_app.oneshot(request_approve).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_subject_requests_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::admin::subject_requests,\n    models::{\n        subject_request::DataSubjectRequestType,\n        user::{User, UserRole},\n    },\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/subject-requests\", axum::routing::get(subject_requests::list_subject_requests))\n        .route(\"/api/admin/subject-requests/{id}/approve\", axum::routing::post(subject_requests::approve_subject_request))\n        .route(\"/api/admin/subject-requests/{id}/reject\", axum::routing::post(subject_requests::reject_subject_request))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\nasync fn seed_subject_request(pool: \u0026PgPool, user_id: timekeeper_backend::types::UserId, request_type: DataSubjectRequestType) -\u003e String {\n    let id = uuid::Uuid::new_v4().to_string();\n    sqlx::query(\n        r#\"\n        INSERT INTO subject_requests (id, user_id, request_type, status, description, created_at, updated_at)\n        VALUES ($1, $2, $3, 'pending', 'Test request', NOW(), NOW())\n        \"#\n    )\n    .bind(\u0026id)\n    .bind(user_id.to_string())\n    .bind(request_type.db_value())\n    .execute(pool)\n    .await\n    .expect(\"insert subject request\");\n    id\n}\n\n#[tokio::test]\nasync fn test_admin_can_list_subject_requests() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_subject_request(\u0026pool, employee.id, DataSubjectRequestType::Access).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/subject-requests\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json[\"items\"].as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_list_subject_requests() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/subject-requests\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_admin_can_approve_subject_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let request_id = seed_subject_request(\u0026pool, employee.id, DataSubjectRequestType::Access).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let payload = json!({\"comment\": \"Approved for data access\"});\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/subject-requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_admin_can_reject_subject_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let request_id = seed_subject_request(\u0026pool, employee.id, DataSubjectRequestType::Delete).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let payload = json!({\"comment\": \"Cannot delete due to legal retention\"});\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/subject-requests/{}/reject\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_approve_already_processed_request_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let request_id = seed_subject_request(\u0026pool, employee.id, DataSubjectRequestType::Access).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let payload = json!({\"comment\": \"Approved\"});\n    let request_approve = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/subject-requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    app.clone().oneshot(request_approve).await.unwrap();\n    \n    let request_approve_again = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/subject-requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response = app.oneshot(request_approve_again).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n\n#[tokio::test]\nasync fn test_list_subject_requests_with_status_filter() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_subject_request(\u0026pool, employee.id, DataSubjectRequestType::Access).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/subject-requests?status=pending\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json[\"items\"].as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_list_subject_requests_with_type_filter() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    seed_subject_request(\u0026pool, employee.id, DataSubjectRequestType::Access).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/subject-requests?type=access\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_list_subject_requests_with_invalid_status_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/subject-requests?status=invalid\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_approve_subject_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee1 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let employee2 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let request_id = seed_subject_request(\u0026pool, employee2.id, DataSubjectRequestType::Access).await;\n    \n    let token = create_test_token(employee1.id, employee1.role.clone());\n    let app = test_router_with_state(pool.clone(), employee1.clone());\n    \n    let payload = json!({\"comment\": \"Trying to approve\"});\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/subject-requests/{}/approve\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","admin_users_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    routing::get,\n    Extension, Router,\n};\nuse chrono::Utc;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::admin::users,\n    models::user::{CreateUser, UpdateUser, User, UserRole},\n    state::AppState,\n    types::UserId,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/users\", get(users::get_users).post(users::create_user))\n        .route(\"/api/admin/users/{id}\", get(users::update_user).delete(users::delete_user))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\nasync fn get_users_list(pool: \u0026PgPool, user: \u0026User) -\u003e StatusCode {\n    let token = create_test_token(user.id, user.role.clone());\n    let app = test_router_with_state(pool.clone(), user.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/users\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    response.status()\n}\n\n#[tokio::test]\nasync fn test_admin_can_list_all_users() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let _regular = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let status = get_users_list(\u0026pool, \u0026admin).await;\n    assert_eq!(status, StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_non_admin_cannot_list_users() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let status = get_users_list(\u0026pool, \u0026employee).await;\n    assert_eq!(status, StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_create_user() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let new_user = CreateUser {\n        username: \"newemployee\".to_string(),\n        password: \"SecureP@ssw0rd123\".to_string(),\n        full_name: \"New Employee\".to_string(),\n        email: \"new.employee@example.com\".to_string(),\n        role: UserRole::Employee,\n        is_system_admin: false,\n    };\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users\", axum::routing::post(users::create_user))\n        .layer(Extension(sysadmin))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/users\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(new_user).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_regular_admin_cannot_create_user() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let new_user = CreateUser {\n        username: \"newemployee\".to_string(),\n        password: \"SecureP@ssw0rd123\".to_string(),\n        full_name: \"New Employee\".to_string(),\n        email: \"new.employee@example.com\".to_string(),\n        role: UserRole::Employee,\n        is_system_admin: false,\n    };\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users\", axum::routing::post(users::create_user))\n        .layer(Extension(admin))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/users\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(new_user).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_cannot_create_user_with_duplicate_username() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let existing = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let new_user = CreateUser {\n        username: existing.username.clone(),\n        password: \"SecureP@ssw0rd123\".to_string(),\n        full_name: \"Another User\".to_string(),\n        email: \"another@example.com\".to_string(),\n        role: UserRole::Employee,\n        is_system_admin: false,\n    };\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users\", axum::routing::post(users::create_user))\n        .layer(Extension(sysadmin))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/admin/users\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(new_user).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_update_user() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let target = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let update = UpdateUser {\n        full_name: Some(\"Updated Name\".to_string()),\n        email: None,\n        role: None,\n        is_system_admin: None,\n    };\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users/{id}\", axum::routing::put(users::update_user))\n        .layer(Extension(sysadmin))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(format!(\"/api/admin/users/{}\", target.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(update).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_cannot_update_with_duplicate_email() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let user1 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let user2 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let update = UpdateUser {\n        full_name: None,\n        email: Some(user1.email.clone()),\n        role: None,\n        is_system_admin: None,\n    };\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users/{id}\", axum::routing::put(users::update_user))\n        .layer(Extension(sysadmin))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(format!(\"/api/admin/users/{}\", user2.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(update).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_cannot_delete_self() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users/{id}\", axum::routing::delete(users::delete_user))\n        .layer(Extension(sysadmin.clone()))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/admin/users/{}?hard=false\", sysadmin.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_regular_admin_cannot_reset_mfa() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let _target = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users/{id}/reset-mfa\", axum::routing::post(users::reset_user_mfa))\n        .layer(Extension(admin))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/admin/users/{}/reset-mfa\", UserId::new()))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!({\"user_id\": UserId::new().to_string()}).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","attendance_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse chrono::NaiveDate;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse std::sync::Arc;\nuse timekeeper_backend::{\n    handlers::attendance,\n    models::{\n        attendance::{ClockInRequest, ClockOutRequest, BreakStartRequest, BreakEndRequest},\n        user::{User, UserRole},\n    },\n    services::holiday::HolidayService,\n    state::AppState,\n    types::AttendanceId,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let holiday_service: Arc\u003cdyn timekeeper_backend::services::holiday::HolidayServiceTrait\u003e = \n        Arc::new(HolidayService::new(pool));\n    \n    Router::new()\n        .route(\"/api/attendance/clock-in\", axum::routing::post(attendance::clock_in))\n        .route(\"/api/attendance/clock-out\", axum::routing::post(attendance::clock_out))\n        .route(\"/api/attendance/break-start\", axum::routing::post(attendance::break_start))\n        .route(\"/api/attendance/break-end\", axum::routing::post(attendance::break_end))\n        .route(\"/api/attendance/status\", axum::routing::get(attendance::get_attendance_status))\n        .route(\"/api/attendance/me\", axum::routing::get(attendance::get_my_attendance))\n        .layer(Extension(user))\n        .layer(Extension(holiday_service))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_clock_in_creates_attendance_record() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = ClockInRequest { date: None };\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_clock_in_with_specific_date() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-07-15\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_clock_in_twice_returns_error() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = ClockInRequest { date: None };\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n    let response = app.clone().oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let request2 = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n    let response2 = app.oneshot(request2).await.unwrap();\n    assert_eq!(response2.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_clock_out_without_clock_in_returns_error() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = ClockOutRequest { date: None };\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-out\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload).to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n\n#[tokio::test]\nasync fn test_clock_out_after_clock_in_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload_in = ClockInRequest { date: None };\n    let request_in = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload_in).to_string()))\n        .unwrap();\n    let response_in = app.clone().oneshot(request_in).await.unwrap();\n    assert_eq!(response_in.status(), StatusCode::OK);\n    \n    let payload_out = ClockOutRequest { date: None };\n    let request_out = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-out\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload_out).to_string()))\n        .unwrap();\n    let response_out = app.oneshot(request_out).await.unwrap();\n    assert_eq!(response_out.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_start_break_without_clock_in_returns_error() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"attendance_id\": AttendanceId::new().to_string()\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/break-start\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n\n#[tokio::test]\nasync fn test_break_flow_works_correctly() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload_in = ClockInRequest { date: None };\n    let request_in = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload_in).to_string()))\n        .unwrap();\n    let response_in = app.clone().oneshot(request_in).await.unwrap();\n    assert_eq!(response_in.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response_in.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let attendance_id = json[\"id\"].as_str().unwrap();\n    \n    let payload_start = json!({\n        \"attendance_id\": attendance_id\n    });\n    let request_start = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/break-start\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload_start.to_string()))\n        .unwrap();\n    let response_start = app.clone().oneshot(request_start).await.unwrap();\n    assert_eq!(response_start.status(), StatusCode::OK);\n    \n    let body_start = axum::body::to_bytes(response_start.into_body(), usize::MAX).await.unwrap();\n    let json_start: serde_json::Value = serde_json::from_slice(\u0026body_start).unwrap();\n    let break_id = json_start[\"id\"].as_str().unwrap();\n    \n    let payload_end = json!({\n        \"break_record_id\": break_id\n    });\n    let request_end = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/break-end\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload_end.to_string()))\n        .unwrap();\n    let response_end = app.oneshot(request_end).await.unwrap();\n    assert_eq!(response_end.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_get_attendance_status_returns_correct_status() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/attendance/status\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response = app.clone().oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert_eq!(json[\"status\"], \"not_started\");\n    \n    let payload_in = ClockInRequest { date: None };\n    let request_in = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload_in).to_string()))\n        .unwrap();\n    app.clone().oneshot(request_in).await.unwrap();\n    \n    let request2 = Request::builder()\n        .uri(\"/api/attendance/status\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response2 = app.oneshot(request2).await.unwrap();\n    assert_eq!(response2.status(), StatusCode::OK);\n    \n    let body2 = axum::body::to_bytes(response2.into_body(), usize::MAX).await.unwrap();\n    let json2: serde_json::Value = serde_json::from_slice(\u0026body2).unwrap();\n    assert_eq!(json2[\"status\"], \"clocked_in\");\n}\n\n#[tokio::test]\nasync fn test_get_my_attendance_returns_list() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload_in = ClockInRequest { date: None };\n    let request_in = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload_in).to_string()))\n        .unwrap();\n    app.clone().oneshot(request_in).await.unwrap();\n    \n    let request = Request::builder()\n        .uri(\"/api/attendance/me\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json.as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_clock_out_during_break_returns_error() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload_in = ClockInRequest { date: None };\n    let request_in = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-in\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload_in).to_string()))\n        .unwrap();\n    let response_in = app.clone().oneshot(request_in).await.unwrap();\n    assert_eq!(response_in.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response_in.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let attendance_id = json[\"id\"].as_str().unwrap();\n    \n    let payload_start = json!({\n        \"attendance_id\": attendance_id\n    });\n    let request_start = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/break-start\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload_start.to_string()))\n        .unwrap();\n    app.clone().oneshot(request_start).await.unwrap();\n    \n    let payload_out = ClockOutRequest { date: None };\n    let request_out = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/attendance/clock-out\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(json!(payload_out).to_string()))\n        .unwrap();\n    let response_out = app.oneshot(request_out).await.unwrap();\n    assert_eq!(response_out.status(), StatusCode::BAD_REQUEST);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","attendance_breaks_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    routing::get,\n    Extension, Router,\n};\nuse chrono::Utc;\nuse serde_json;\nuse sqlx::PgPool;\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    handlers::attendance,\n    models::{attendance::Attendance, break_record::BreakRecord, user::UserRole},\n    repositories::{\n        attendance::{AttendanceRepository, AttendanceRepositoryTrait},\n        break_record::BreakRecordRepository,\n        repository::Repository,\n    },\n    state::AppState,\n};\nuse tokio::sync::Mutex;\nuse tower::ServiceExt;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\nasync fn reset_attendance_tables(pool: \u0026PgPool) {\n    sqlx::query(\"TRUNCATE break_records, attendance\")\n        .execute(pool)\n        .await\n        .expect(\"truncate attendance tables\");\n}\n\n#[tokio::test]\nasync fn get_breaks_by_attendance_blocks_other_user() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_attendance_tables(\u0026pool).await;\n\n    let owner = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let other = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n\n    let now = Utc::now();\n    let attendance = Attendance::new(owner.id, now.date_naive(), now);\n    let repo = AttendanceRepository::new();\n    let saved = repo\n        .create(\u0026pool, \u0026attendance)\n        .await\n        .expect(\"create attendance\");\n\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n    let app = Router::new()\n        .route(\n            \"/api/attendance/{id}/breaks\",\n            get(attendance::get_breaks_by_attendance),\n        )\n        .layer(Extension(other))\n        .with_state(state);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(format!(\"/api/attendance/{}/breaks\", saved.id))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn get_breaks_by_attendance_allows_owner() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_attendance_tables(\u0026pool).await;\n\n    let owner = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n\n    let now = Utc::now();\n    let attendance = Attendance::new(owner.id, now.date_naive(), now);\n    let attendance_repo = AttendanceRepository::new();\n    let saved = attendance_repo\n        .create(\u0026pool, \u0026attendance)\n        .await\n        .expect(\"create attendance\");\n\n    let break_repo = BreakRecordRepository::new();\n    let break_record = BreakRecord::new(saved.id, now.naive_utc(), now);\n    break_repo\n        .create(\u0026pool, \u0026break_record)\n        .await\n        .expect(\"create break\");\n\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n    let app = Router::new()\n        .route(\n            \"/api/attendance/{id}/breaks\",\n            get(attendance::get_breaks_by_attendance),\n        )\n        .layer(Extension(owner))\n        .with_state(state);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(format!(\"/api/attendance/{}/breaks\", saved.id))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = axum::body::to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let records: Vec\u003ctimekeeper_backend::models::break_record::BreakRecordResponse\u003e =\n        serde_json::from_slice(\u0026body).expect(\"parse response\");\n    assert_eq!(records.len(), 1);\n    assert_eq!(records[0].attendance_id, saved.id);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","attendance_holiday.rs"],"content":"use chrono::{Datelike, NaiveDate};\n\nfn is_holiday_or_weekend(\n    date: NaiveDate,\n    holidays: \u0026[NaiveDate],\n    overrides: \u0026[(NaiveDate, bool)],\n) -\u003e bool {\n    if let Some((_, override_workday)) = overrides.iter().find(|(d, _)| *d == date) {\n        return !override_workday;\n    }\n    date.weekday().number_from_monday() \u003e= 6 || holidays.contains(\u0026date)\n}\n\n#[test]\nfn detects_weekend_without_db() {\n    let saturday = NaiveDate::from_ymd_opt(2025, 3, 1).unwrap(); // Saturday\n    assert!(is_holiday_or_weekend(saturday, \u0026[], \u0026[]));\n}\n\n#[test]\nfn detects_configured_holiday_without_db() {\n    let holiday = NaiveDate::from_ymd_opt(2025, 3, 4).unwrap();\n    assert!(is_holiday_or_weekend(holiday, \u0026[holiday], \u0026[]));\n}\n\n#[test]\nfn override_can_cancel_holiday_without_db() {\n    let holiday = NaiveDate::from_ymd_opt(2025, 3, 4).unwrap();\n    assert!(\n        !is_holiday_or_weekend(holiday, \u0026[holiday], \u0026[(holiday, true)]),\n        \"override=true should mark as working day\"\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","attendance_repository.rs"],"content":"use chrono::{NaiveDate, Utc};\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    models::{\n        attendance::{Attendance, AttendanceStatus},\n        break_record::BreakRecord,\n        user::UserRole,\n    },\n    repositories::{\n        repository::Repository,\n        AttendanceRepository,\n        AttendanceRepositoryTrait,\n        BreakRecordRepository,\n    },\n};\nuse tokio::sync::Mutex;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\n#[tokio::test]\nasync fn attendance_repository_roundtrip() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE break_records, attendance\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate attendance tables\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let now = Utc::now();\n    let date = NaiveDate::from_ymd_opt(2024, 4, 1).unwrap();\n    let mut attendance = Attendance::new(user.id, date, now);\n\n    let repo = AttendanceRepository::new();\n    let saved = repo\n        .create(\u0026pool, \u0026attendance)\n        .await\n        .expect(\"create attendance\");\n    assert_eq!(saved.user_id, user.id);\n    assert!(matches!(saved.status, AttendanceStatus::Present));\n\n    attendance.clock_in_time = Some(date.and_hms_opt(9, 0, 0).unwrap());\n    attendance.status = AttendanceStatus::Late;\n    attendance.updated_at = now;\n    let updated = repo\n        .update(\u0026pool, \u0026attendance)\n        .await\n        .expect(\"update attendance\");\n    assert!(matches!(updated.status, AttendanceStatus::Late));\n    assert!(updated.clock_in_time.is_some());\n\n    let fetched = repo\n        .find_by_user_and_date(\u0026pool, user.id, date)\n        .await\n        .expect(\"find by user date\");\n    assert!(fetched.is_some());\n}\n\n#[tokio::test]\nasync fn break_record_repository_roundtrip() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE break_records, attendance\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate attendance tables\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let now = Utc::now();\n    let date = NaiveDate::from_ymd_opt(2024, 3, 15).unwrap();\n    let attendance = Attendance::new(user.id, date, now);\n    let attendance_repo = AttendanceRepository::new();\n    let saved_attendance = attendance_repo\n        .create(\u0026pool, \u0026attendance)\n        .await\n        .expect(\"create attendance\");\n\n    let start = date.and_hms_opt(12, 0, 0).unwrap();\n    let mut record = BreakRecord::new(saved_attendance.id, start, now);\n    let repo = BreakRecordRepository::new();\n    let saved = repo\n        .create(\u0026pool, \u0026record)\n        .await\n        .expect(\"create break record\");\n    assert_eq!(saved.attendance_id, saved_attendance.id);\n    assert!(saved.duration_minutes.is_none());\n\n    let end = start + chrono::Duration::minutes(15);\n    record.break_end_time = Some(end);\n    record.duration_minutes = Some(15);\n    record.updated_at = now;\n    let updated = repo\n        .update(\u0026pool, \u0026record)\n        .await\n        .expect(\"update break record\");\n    assert_eq!(updated.duration_minutes, Some(15));\n\n    let listed = repo\n        .find_by_attendance(\u0026pool, saved_attendance.id)\n        .await\n        .expect(\"list break records\");\n    assert_eq!(listed.len(), 1);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","attendance_repository_mock.rs"],"content":"#![allow(dead_code)]\n\n#[test]\nfn mock_tests_disabled() {\n    // Mock repository tests require the \"mock\" feature.\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","audit_log_middleware.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    middleware as axum_middleware,\n    response::IntoResponse,\n    routing::{post, put},\n    Extension, Router,\n};\nuse chrono::Utc;\nuse serde_json::Value;\nuse sqlx::PgPool;\nuse std::sync::Arc;\nuse timekeeper_backend::{\n    models::{audit_log::AuditLog, user::UserRole},\n    services::audit_log::{AuditLogService, AuditLogServiceTrait},\n    state::AppState,\n};\nuse tokio::time::{sleep, Duration};\nuse tower::ServiceExt;\nuse uuid::Uuid;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn ok_handler() -\u003e impl IntoResponse {\n    StatusCode::OK\n}\n\nasync fn unauthorized_handler() -\u003e impl IntoResponse {\n    StatusCode::UNAUTHORIZED\n}\n\nasync fn fetch_audit_log_by_request_id(pool: \u0026PgPool, request_id: \u0026str) -\u003e Option\u003cAuditLog\u003e {\n    sqlx::query_as::\u003c_, AuditLog\u003e(\n        \"SELECT id, occurred_at, actor_id, actor_type, event_type, target_type, target_id, result, \\\n         error_code, metadata, ip, user_agent, request_id \\\n         FROM audit_logs WHERE request_id = $1 ORDER BY occurred_at DESC LIMIT 1\",\n    )\n    .bind(request_id)\n    .fetch_optional(pool)\n    .await\n    .expect(\"fetch audit log\")\n}\n\nasync fn reset_audit_logs(pool: \u0026PgPool) {\n    sqlx::query(\"TRUNCATE audit_logs\")\n        .execute(pool)\n        .await\n        .expect(\"truncate audit_logs\");\n}\n\nfn metadata_value(log: \u0026AuditLog) -\u003e \u0026Value {\n    log.metadata\n        .as_ref()\n        .map(|value| \u0026value.0)\n        .expect(\"metadata\")\n}\n\nasync fn wait_for_audit_log_by_request_id(pool: \u0026PgPool, request_id: \u0026str) -\u003e Option\u003cAuditLog\u003e {\n    for _ in 0..100 {\n        if let Some(log) = fetch_audit_log_by_request_id(pool, request_id).await {\n            return Some(log);\n        }\n        sleep(Duration::from_millis(50)).await;\n    }\n    None\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_event() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let mut config = support::test_config();\n    config.audit_log_retention_days = 365;\n    config.audit_log_retention_forever = false;\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\"/api/attendance/clock-in\", post(ok_handler))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/attendance/clock-in\")\n                .header(\"x-client-source\", \"web\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    assert_eq!(logged.event_type, \"attendance_clock_in\");\n    assert_eq!(logged.result, \"success\");\n    assert_eq!(logged.actor_type, \"user\");\n    assert!(logged.actor_id.is_some());\n\n    let metadata = metadata_value(\u0026logged);\n    assert_eq!(\n        metadata.get(\"clock_type\").and_then(Value::as_str),\n        Some(\"clock_in\")\n    );\n    assert_eq!(metadata.get(\"source\").and_then(Value::as_str), Some(\"web\"));\n    assert_eq!(\n        metadata.get(\"timezone\").and_then(Value::as_str),\n        Some(\"Asia/Tokyo\")\n    );\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_skips_when_retention_is_zero() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let mut config = support::test_config();\n    config.audit_log_retention_days = 0;\n    config.audit_log_retention_forever = false;\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\"/api/attendance/clock-in\", post(ok_handler))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/attendance/clock-in\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let count: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM audit_logs WHERE request_id = $1\")\n        .bind(\u0026request_id)\n        .fetch_one(\u0026pool)\n        .await\n        .expect(\"count audit logs\");\n    assert_eq!(count.0, 0);\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_failure_with_error_code() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\n            \"/api/attendance/clock-in\",\n            post(|| async { (StatusCode::BAD_REQUEST, \"bad\") }),\n        )\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/attendance/clock-in\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    assert_eq!(logged.event_type, \"attendance_clock_in\");\n    assert_eq!(logged.result, \"failure\");\n    assert_eq!(logged.error_code.as_deref(), Some(\"http_400\"));\n    assert!(logged.occurred_at \u003c= Utc::now());\n\n    let metadata = metadata_value(\u0026logged);\n    assert_eq!(\n        metadata.get(\"clock_type\").and_then(Value::as_str),\n        Some(\"clock_in\")\n    );\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_auth_failure() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let mut config = support::test_config();\n    config.audit_log_retention_days = 365;\n    config.audit_log_retention_forever = false;\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\"/api/consents\", post(ok_handler))\n        .route(\"/api/attendance/clock-in\", post(unauthorized_handler))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/attendance/clock-in\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    assert_eq!(logged.event_type, \"attendance_clock_in\");\n    assert_eq!(logged.result, \"failure\");\n    assert_eq!(logged.error_code.as_deref(), Some(\"http_401\"));\n    assert_eq!(logged.actor_type, \"anonymous\");\n    assert!(logged.actor_id.is_none());\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_request_metadata() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\"/api/requests/leave\", post(ok_handler))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/requests/leave\")\n                .header(\"content-type\", \"application/json\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::from(\n                    r#\"{\"leave_type\":\"annual\",\"start_date\":\"2025-01-10\",\"end_date\":\"2025-01-12\",\"reason\":\"test\"}\"#,\n                ))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    let metadata = metadata_value(\u0026logged);\n    assert_eq!(\n        metadata.get(\"request_type\").and_then(Value::as_str),\n        Some(\"leave\")\n    );\n    let payload = metadata\n        .get(\"payload_summary\")\n        .and_then(Value::as_object)\n        .expect(\"payload_summary\");\n    assert_eq!(\n        payload.get(\"leave_type\").and_then(Value::as_str),\n        Some(\"annual\")\n    );\n    assert_eq!(\n        payload.get(\"start_date\").and_then(Value::as_str),\n        Some(\"2025-01-10\")\n    );\n    assert!(payload.get(\"reason\").is_none());\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_consent_metadata() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\"/api/consents\", post(ok_handler))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/consents\")\n                .header(\"content-type\", \"application/json\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::from(\n                    r#\"{\"purpose\":\"attendance\",\"policy_version\":\"2026-01\"}\"#,\n                ))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    assert_eq!(logged.event_type, \"consent_record\");\n    let metadata = metadata_value(\u0026logged);\n    assert_eq!(\n        metadata.get(\"purpose\").and_then(Value::as_str),\n        Some(\"attendance\")\n    );\n    assert_eq!(\n        metadata.get(\"policy_version\").and_then(Value::as_str),\n        Some(\"2026-01\")\n    );\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_request_metadata_on_failure_with_large_body() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\n            \"/api/requests/leave\",\n            post(|| async { (StatusCode::BAD_REQUEST, \"bad\") }),\n        )\n        .route(\"/api/auth/change-password\", put(ok_handler))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let body = vec![b'a'; 64 * 1024 + 1];\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/requests/leave\")\n                .header(\"content-type\", \"application/json\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::from(body))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    let metadata = metadata_value(\u0026logged);\n    assert_eq!(\n        metadata.get(\"request_type\").and_then(Value::as_str),\n        Some(\"leave\")\n    );\n    let payload = metadata\n        .get(\"payload_summary\")\n        .and_then(Value::as_object)\n        .expect(\"payload_summary\");\n    assert!(payload.is_empty());\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_approval_metadata() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\n            \"/api/admin/requests/{id}/approve\",\n            axum::routing::put(ok_handler),\n        )\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"PUT\")\n                .uri(\"/api/admin/requests/550e8400-e29b-41d4-a716-446655440000/approve\")\n                .header(\"content-type\", \"application/json\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::from(r#\"{\"comment\":\"ok\"}\"#))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    let metadata = metadata_value(\u0026logged);\n    assert_eq!(\n        metadata.get(\"approval_step\").and_then(Value::as_str),\n        Some(\"single\")\n    );\n    assert_eq!(\n        metadata.get(\"decision\").and_then(Value::as_str),\n        Some(\"approve\")\n    );\n}\n\n#[tokio::test]\nasync fn audit_log_middleware_records_password_change_metadata() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config.clone());\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let audit_service: Arc\u003cdyn AuditLogServiceTrait\u003e = Arc::new(AuditLogService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\n            \"/api/requests/leave\",\n            post(|| async { (StatusCode::BAD_REQUEST, \"bad\") }),\n        )\n        .route(\"/api/auth/change-password\", put(ok_handler))\n        .route_layer(axum_middleware::from_fn_with_state(\n            state.clone(),\n            timekeeper_backend::middleware::audit_log,\n        ))\n        .layer(Extension(user))\n        .layer(Extension(audit_service))\n        .with_state(state);\n\n    let request_id = Uuid::new_v4().to_string();\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"PUT\")\n                .uri(\"/api/auth/change-password\")\n                .header(\"content-type\", \"application/json\")\n                .header(\"x-request-id\", \u0026request_id)\n                .body(Body::from(\n                    r#\"{\"current_password\":\"old\",\"new_password\":\"newpass123\"}\"#,\n                ))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let logged = wait_for_audit_log_by_request_id(\u0026pool, \u0026request_id)\n        .await\n        .expect(\"audit log\");\n    let metadata = metadata_value(\u0026logged);\n    assert_eq!(\n        metadata.get(\"method\").and_then(Value::as_str),\n        Some(\"password\")\n    );\n    assert_eq!(\n        metadata.get(\"mfa_enabled\").and_then(Value::as_bool),\n        Some(false)\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","audit_log_read_export.rs"],"content":"use axum::{\n    body::{to_bytes, Body},\n    http::{\n        header::{CONTENT_DISPOSITION, CONTENT_TYPE},\n        Request, StatusCode,\n    },\n    routing::get,\n    Extension, Router,\n};\nuse chrono::{DateTime, Duration, Utc};\nuse serde_json::json;\nuse sqlx::{types::Json, PgPool};\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    handlers::admin::{\n        export_audit_logs, get_audit_log_detail, list_audit_logs, AuditLogListResponse,\n    },\n    models::{audit_log::AuditLog, user::UserRole},\n    repositories::{audit_log, permissions},\n    state::AppState,\n    types::{AuditLogId, UserId},\n};\nuse tokio::sync::Mutex;\nuse tower::ServiceExt;\nuse uuid::Uuid;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\nasync fn reset_audit_logs(pool: \u0026PgPool) {\n    sqlx::query(\"TRUNCATE audit_logs\")\n        .execute(pool)\n        .await\n        .expect(\"truncate audit_logs\");\n}\n\nfn build_log(\n    actor_id: Option\u003cUserId\u003e,\n    event_type: \u0026str,\n    target_type: Option\u003c\u0026str\u003e,\n    target_id: Option\u003c\u0026str\u003e,\n    result: \u0026str,\n    occurred_at: DateTime\u003cUtc\u003e,\n) -\u003e AuditLog {\n    AuditLog {\n        id: AuditLogId::new(),\n        occurred_at,\n        actor_id,\n        actor_type: actor_id\n            .map(|_| \"user\".to_string())\n            .unwrap_or_else(|| \"anonymous\".to_string()),\n        event_type: event_type.to_string(),\n        target_type: target_type.map(|v| v.to_string()),\n        target_id: target_id.map(|v| v.to_string()),\n        result: result.to_string(),\n        error_code: if result == \"failure\" {\n            Some(\"http_400\".to_string())\n        } else {\n            None\n        },\n        metadata: Some(Json(json!({ \"note\": event_type }))),\n        ip: Some(\"127.0.0.1\".to_string()),\n        user_agent: Some(\"test-agent\".to_string()),\n        request_id: Some(Uuid::new_v4().to_string()),\n    }\n}\n\n#[tokio::test]\nasync fn audit_log_list_requires_permission() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config);\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs\", get(list_audit_logs))\n        .layer(Extension(user))\n        .with_state(state);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(\"/api/admin/audit-logs\")\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn audit_log_list_filters_and_paginates() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config);\n\n    let permissioned_user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let permissioned_user_id = permissioned_user.id.to_string();\n    support::grant_permission(\u0026pool, \u0026permissioned_user_id, permissions::AUDIT_LOG_READ).await;\n    assert!(permissions::user_has_permission(\n        \u0026pool,\n        \u0026permissioned_user_id,\n        permissions::AUDIT_LOG_READ\n    )\n    .await\n    .expect(\"check permission\"));\n    let actor_one = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let actor_two = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n\n    let now = Utc::now();\n    let log_one = build_log(\n        Some(actor_one.id),\n        \"attendance_clock_in\",\n        Some(\"attendance\"),\n        Some(\"target-1\"),\n        \"success\",\n        now - Duration::minutes(10),\n    );\n    let log_two = build_log(\n        Some(actor_one.id),\n        \"request_update\",\n        Some(\"request\"),\n        Some(\"target-2\"),\n        \"success\",\n        now - Duration::minutes(5),\n    );\n    let log_three = build_log(\n        Some(actor_two.id),\n        \"attendance_clock_out\",\n        Some(\"attendance\"),\n        Some(\"target-3\"),\n        \"failure\",\n        now - Duration::minutes(1),\n    );\n\n    for log in [\u0026log_one, \u0026log_two, \u0026log_three] {\n        audit_log::insert_audit_log(\u0026pool, log)\n            .await\n            .expect(\"insert audit log\");\n    }\n\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs\", get(list_audit_logs))\n        .layer(Extension(permissioned_user.clone()))\n        .with_state(state.clone());\n\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(format!(\n                    \"/api/admin/audit-logs?actor_id={}\u0026result=success\u0026per_page=1\u0026page=2\",\n                    actor_one.id\n                ))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let payload: AuditLogListResponse = serde_json::from_slice(\u0026body).expect(\"parse response\");\n    assert_eq!(payload.total, 2);\n    assert_eq!(payload.items.len(), 1);\n    assert_eq!(payload.items[0].id, log_one.id.to_string());\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(\"/api/admin/audit-logs?target_id=target-2\")\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let payload: AuditLogListResponse = serde_json::from_slice(\u0026body).expect(\"parse response\");\n    assert_eq!(payload.total, 1);\n    assert_eq!(payload.items[0].id, log_two.id.to_string());\n}\n\n#[tokio::test]\nasync fn audit_log_detail_returns_log() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config);\n\n    let permissioned_user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let permissioned_user_id = permissioned_user.id.to_string();\n    support::grant_permission(\u0026pool, \u0026permissioned_user_id, permissions::AUDIT_LOG_READ).await;\n    assert!(permissions::user_has_permission(\n        \u0026pool,\n        \u0026permissioned_user_id,\n        permissions::AUDIT_LOG_READ\n    )\n    .await\n    .expect(\"check permission\"));\n    let log = build_log(\n        Some(permissioned_user.id),\n        \"attendance_clock_in\",\n        Some(\"attendance\"),\n        Some(\"target-1\"),\n        \"success\",\n        Utc::now(),\n    );\n    audit_log::insert_audit_log(\u0026pool, \u0026log)\n        .await\n        .expect(\"insert audit log\");\n\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs/{id}\", get(get_audit_log_detail))\n        .layer(Extension(permissioned_user))\n        .with_state(state);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(format!(\"/api/admin/audit-logs/{}\", log.id))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let payload: serde_json::Value = serde_json::from_slice(\u0026body).expect(\"parse response\");\n    assert_eq!(\n        payload.get(\"id\").and_then(|v| v.as_str()),\n        Some(log.id.to_string()).as_deref()\n    );\n}\n\n#[tokio::test]\nasync fn audit_log_export_returns_json_file() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config);\n\n    let permissioned_user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let permissioned_user_id = permissioned_user.id.to_string();\n    support::grant_permission(\u0026pool, \u0026permissioned_user_id, permissions::AUDIT_LOG_READ).await;\n    assert!(permissions::user_has_permission(\n        \u0026pool,\n        \u0026permissioned_user_id,\n        permissions::AUDIT_LOG_READ\n    )\n    .await\n    .expect(\"check permission\"));\n    let log = build_log(\n        Some(permissioned_user.id),\n        \"request_update\",\n        Some(\"request\"),\n        Some(\"target-2\"),\n        \"success\",\n        Utc::now(),\n    );\n    audit_log::insert_audit_log(\u0026pool, \u0026log)\n        .await\n        .expect(\"insert audit log\");\n\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs/export\", get(export_audit_logs))\n        .layer(Extension(permissioned_user))\n        .with_state(state);\n\n    let today = Utc::now().format(\"%Y-%m-%d\").to_string();\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(format!(\n                    \"/api/admin/audit-logs/export?from={}\u0026to={}\u0026event_type=request_update\",\n                    today, today\n                ))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    assert_eq!(\n        response\n            .headers()\n            .get(CONTENT_TYPE)\n            .and_then(|value| value.to_str().ok()),\n        Some(\"application/json\")\n    );\n    let content_disposition = response\n        .headers()\n        .get(CONTENT_DISPOSITION)\n        .and_then(|value| value.to_str().ok())\n        .unwrap_or_default();\n    assert!(content_disposition.starts_with(\"attachment; filename=\\\"audit_logs_\"));\n\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let payload: Vec\u003cserde_json::Value\u003e = serde_json::from_slice(\u0026body).expect(\"parse response\");\n    assert_eq!(payload.len(), 1);\n    assert_eq!(\n        payload[0].get(\"id\").and_then(|value| value.as_str()),\n        Some(log.id.to_string()).as_deref()\n    );\n}\n\n#[tokio::test]\nasync fn audit_log_export_requires_from_and_to() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config);\n\n    let permissioned_user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let permissioned_user_id = permissioned_user.id.to_string();\n    support::grant_permission(\u0026pool, \u0026permissioned_user_id, permissions::AUDIT_LOG_READ).await;\n\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs/export\", get(export_audit_logs))\n        .layer(Extension(permissioned_user))\n        .with_state(state);\n\n    // given: no from/to parameters\n    // when: export is called\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(\"/api/admin/audit-logs/export\")\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    // then: 400 Bad Request is returned\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn audit_log_export_rejects_period_exceeding_31_days() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config);\n\n    let permissioned_user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let permissioned_user_id = permissioned_user.id.to_string();\n    support::grant_permission(\u0026pool, \u0026permissioned_user_id, permissions::AUDIT_LOG_READ).await;\n\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs/export\", get(export_audit_logs))\n        .layer(Extension(permissioned_user))\n        .with_state(state);\n\n    // given: period of 32 days (exceeds 31-day limit)\n    let from_date = (Utc::now() - Duration::days(32))\n        .format(\"%Y-%m-%d\")\n        .to_string();\n    let to_date = Utc::now().format(\"%Y-%m-%d\").to_string();\n\n    // when: export is called\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(format!(\n                    \"/api/admin/audit-logs/export?from={}\u0026to={}\",\n                    from_date, to_date\n                ))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    // then: 400 Bad Request is returned with period limit message\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let error_response: serde_json::Value = serde_json::from_slice(\u0026body).expect(\"parse response\");\n    let error_message = error_response\n        .get(\"error\")\n        .and_then(|v| v.as_str())\n        .unwrap_or(\"\");\n    assert!(error_message.contains(\"31\"));\n}\n\n#[tokio::test]\nasync fn audit_log_export_allows_exactly_31_days() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_audit_logs(\u0026pool).await;\n    let config = support::test_config();\n    let state = AppState::new(pool.clone(), None, None, None, config);\n\n    let permissioned_user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let permissioned_user_id = permissioned_user.id.to_string();\n    support::grant_permission(\u0026pool, \u0026permissioned_user_id, permissions::AUDIT_LOG_READ).await;\n\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs/export\", get(export_audit_logs))\n        .layer(Extension(permissioned_user))\n        .with_state(state);\n\n    // given: period of 31 calendar days (from to to inclusive, within limit)\n    let from_date = (Utc::now() - Duration::days(30))\n        .format(\"%Y-%m-%d\")\n        .to_string();\n    let to_date = Utc::now().format(\"%Y-%m-%d\").to_string();\n\n    // when: export is called\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(format!(\n                    \"/api/admin/audit-logs/export?from={}\u0026to={}\",\n                    from_date, to_date\n                ))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    // then: 200 OK is returned\n    assert_eq!(response.status(), StatusCode::OK);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","audit_log_repo.rs"],"content":"use chrono::{Duration as ChronoDuration, Utc};\nuse serde_json::json;\nuse sqlx::types::Json;\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    models::{audit_log::AuditLog, user::UserRole},\n    repositories::audit_log,\n    types::AuditLogId,\n};\nuse tokio::sync::Mutex;\nuse uuid::Uuid;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\n#[tokio::test]\nasync fn audit_log_repo_inserts_and_fetches() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE audit_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate audit logs\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let metadata_value = json!({ \"source\": \"test\" });\n    let log = AuditLog {\n        id: AuditLogId::new(),\n        occurred_at: Utc::now(),\n        actor_id: Some(user.id),\n        actor_type: \"user\".into(),\n        event_type: \"attendance_clock_in\".into(),\n        target_type: Some(\"attendance\".into()),\n        target_id: Some(Uuid::new_v4().to_string()),\n        result: \"success\".into(),\n        error_code: None,\n        metadata: Some(Json(metadata_value.clone())),\n        ip: Some(\"127.0.0.1\".into()),\n        user_agent: Some(\"test-agent\".into()),\n        request_id: Some(\"req-123\".into()),\n    };\n\n    audit_log::insert_audit_log(\u0026pool, \u0026log)\n        .await\n        .expect(\"insert audit log\");\n\n    let fetched = audit_log::fetch_audit_log(\u0026pool, log.id)\n        .await\n        .expect(\"fetch audit log\")\n        .expect(\"audit log exists\");\n\n    assert_eq!(fetched.id, log.id);\n    assert_eq!(fetched.actor_id, log.actor_id);\n    assert_eq!(fetched.actor_type, log.actor_type);\n    assert_eq!(fetched.event_type, log.event_type);\n    assert_eq!(fetched.target_type, log.target_type);\n    assert_eq!(fetched.target_id, log.target_id);\n    assert_eq!(fetched.result, log.result);\n    assert_eq!(fetched.error_code, log.error_code);\n    assert_eq!(\n        fetched.metadata.as_ref().map(|value| value.0.clone()),\n        Some(metadata_value)\n    );\n    assert_eq!(fetched.ip, log.ip);\n    assert_eq!(fetched.user_agent, log.user_agent);\n    assert_eq!(fetched.request_id, log.request_id);\n    assert_eq!(\n        fetched.occurred_at.timestamp_micros(),\n        log.occurred_at.timestamp_micros()\n    );\n\n    sqlx::query(\"TRUNCATE audit_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate audit logs\");\n}\n\n#[tokio::test]\nasync fn audit_log_repo_deletes_logs_before_cutoff() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE audit_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate audit logs\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let now = Utc::now();\n    let old_log = AuditLog {\n        id: AuditLogId::new(),\n        occurred_at: now - ChronoDuration::days(40),\n        actor_id: Some(user.id),\n        actor_type: \"user\".into(),\n        event_type: \"admin_user_create\".into(),\n        target_type: Some(\"user\".into()),\n        target_id: Some(Uuid::new_v4().to_string()),\n        result: \"success\".into(),\n        error_code: None,\n        metadata: None,\n        ip: None,\n        user_agent: None,\n        request_id: Some(\"req-old\".into()),\n    };\n    let recent_log = AuditLog {\n        id: AuditLogId::new(),\n        occurred_at: now - ChronoDuration::days(10),\n        actor_id: Some(user.id),\n        actor_type: \"user\".into(),\n        event_type: \"admin_user_create\".into(),\n        target_type: Some(\"user\".into()),\n        target_id: Some(Uuid::new_v4().to_string()),\n        result: \"success\".into(),\n        error_code: None,\n        metadata: None,\n        ip: None,\n        user_agent: None,\n        request_id: Some(\"req-recent\".into()),\n    };\n\n    audit_log::insert_audit_log(\u0026pool, \u0026old_log)\n        .await\n        .expect(\"insert old log\");\n    audit_log::insert_audit_log(\u0026pool, \u0026recent_log)\n        .await\n        .expect(\"insert recent log\");\n\n    let cutoff = now - ChronoDuration::days(30);\n    let deleted = audit_log::delete_audit_logs_before(\u0026pool, cutoff)\n        .await\n        .expect(\"delete audit logs\");\n\n    assert_eq!(deleted, 1);\n\n    let remaining: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM audit_logs\")\n        .fetch_one(\u0026pool)\n        .await\n        .expect(\"count remaining logs\");\n    assert_eq!(remaining.0, 1);\n\n    let remaining_old: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM audit_logs WHERE id = $1\")\n        .bind(old_log.id.to_string())\n        .fetch_one(\u0026pool)\n        .await\n        .expect(\"count old logs\");\n    assert_eq!(remaining_old.0, 0);\n\n    sqlx::query(\"TRUNCATE audit_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate audit logs\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","auth_api.rs"],"content":"use std::{\n    future::Future,\n    sync::{Arc, Mutex},\n};\n\nuse chrono::Utc;\nuse chrono_tz::UTC;\nuse timekeeper_backend::{\n    config::Config,\n    error::AppError,\n    handlers::auth::process_login_for_user,\n    models::user::{LoginRequest, User, UserRole},\n    utils::{cookies::SameSite, mfa::generate_totp_secret, password::hash_password},\n};\n\nconst TEST_PASSWORD: \u0026str = \"correct-horse-battery-staple\";\n\nfn test_config() -\u003e Config {\n    Config {\n        database_url: \"\".into(),\n        read_database_url: None,\n        jwt_secret: \"a-secure-test-secret-that-is-long-enough\".repeat(2),\n        jwt_expiration_hours: 1,\n        refresh_token_expiration_days: 7,\n        max_concurrent_sessions: 3,\n        audit_log_retention_days: 1825,\n        audit_log_retention_forever: false,\n        consent_log_retention_days: 1825,\n        consent_log_retention_forever: false,\n        aws_region: \"ap-northeast-1\".into(),\n        aws_kms_key_id: \"alias/timekeeper-test\".into(),\n        aws_audit_log_bucket: \"timekeeper-audit-logs\".into(),\n        aws_cloudtrail_enabled: true,\n        cookie_secure: false,\n        cookie_same_site: SameSite::Lax,\n        cors_allow_origins: vec![\"http://localhost:8000\".into()],\n        time_zone: UTC,\n        mfa_issuer: \"Timekeeper Test\".into(),\n        rate_limit_ip_max_requests: 15,\n        rate_limit_ip_window_seconds: 900,\n        rate_limit_user_max_requests: 20,\n        rate_limit_user_window_seconds: 3600,\n        redis_url: None,\n        redis_pool_size: 10,\n        redis_connect_timeout: 5,\n        feature_redis_cache_enabled: true,\n        feature_read_replica_enabled: true,\n        password_min_length: 12,\n        password_require_uppercase: true,\n        password_require_lowercase: true,\n        password_require_numbers: true,\n        password_require_symbols: true,\n        password_expiration_days: 90,\n        password_history_count: 5,\n        production_mode: false,\n    }\n}\n\nfn block_on_future\u003cF, T\u003e(future: F) -\u003e T\nwhere\n    F: Future\u003cOutput = T\u003e,\n{\n    tokio::runtime::Runtime::new()\n        .expect(\"create runtime\")\n        .block_on(future)\n}\n\nfn user_with_mfa_secret(secret: String, enabled: bool) -\u003e User {\n    let mut user = User::new(\n        \"tester\".into(),\n        hash_password(TEST_PASSWORD).expect(\"hash test password\"),\n        \"Tester\".into(),\n        \"tester@example.com\".into(),\n        UserRole::Employee,\n        false,\n    );\n    user.mfa_secret = Some(secret);\n    user.mfa_enabled_at = enabled.then_some(Utc::now());\n    user\n}\n\n#[test]\nfn login_succeeds_when_password_matches_without_db() {\n    let password_hash = hash_password(\"correct-horse-battery-staple\").expect(\"hash password\");\n    let user = User {\n        password_hash: password_hash.clone(),\n        ..user_with_mfa_secret(String::new(), false)\n    };\n    let config = test_config();\n    let recorded = Arc::new(Mutex::new(Vec::new()));\n    let payload = LoginRequest {\n        username: user.username.clone(),\n        password: \"correct-horse-battery-staple\".into(),\n        device_label: Some(\"unit-test\".into()),\n        totp_code: None,\n    };\n\n    let response = block_on_future(process_login_for_user(\n        user,\n        payload,\n        \u0026config,\n        {\n            let recorded = Arc::clone(\u0026recorded);\n            move |token| {\n                let recorded = Arc::clone(\u0026recorded);\n                async move {\n                    recorded.lock().unwrap().push(token.encoded());\n                    Ok(())\n                }\n            }\n        },\n        {\n            let recorded = Arc::clone(\u0026recorded);\n            move |claims, _| {\n                let recorded = Arc::clone(\u0026recorded);\n                async move {\n                    recorded.lock().unwrap().push(claims.jti.clone());\n                    Ok(())\n                }\n            }\n        },\n        |_, _, _, _| async { Ok(()) },\n    ))\n    .expect(\"login should succeed\");\n\n    assert!(!response.access_token.is_empty());\n    assert!(!response.refresh_token.is_empty());\n    assert_eq!(response.user.username, \"tester\");\n    let recorded = recorded.lock().unwrap();\n    assert_eq!(\n        recorded.len(),\n        2,\n        \"refresh token and access token jti should be recorded\"\n    );\n    assert_ne!(recorded[0], recorded[1]);\n    assert_eq!(recorded[0], response.refresh_token);\n}\n\n#[test]\nfn login_rejects_invalid_password_without_db() {\n    let password_hash = hash_password(\"expected-secret\").expect(\"hash password\");\n    let user = User {\n        password_hash: password_hash.clone(),\n        ..user_with_mfa_secret(String::new(), false)\n    };\n    let config = test_config();\n    let payload = LoginRequest {\n        username: user.username.clone(),\n        password: \"wrong-secret\".into(),\n        device_label: None,\n        totp_code: None,\n    };\n\n    let err = block_on_future(process_login_for_user(\n        user,\n        payload,\n        \u0026config,\n        |_| async { Ok(()) },\n        |_, _| async { Ok(()) },\n        |_, _, _, _| async { Ok(()) },\n    ))\n    .expect_err(\"mismatched password should fail\");\n    match err {\n        AppError::Unauthorized(msg) =\u003e assert_eq!(msg, \"Invalid username or password\"),\n        e =\u003e panic!(\"unexpected error: {:?}\", e),\n    }\n}\n\n#[test]\nfn login_rejects_invalid_totp_code_when_mfa_is_enabled() {\n    let secret = generate_totp_secret();\n    let user = user_with_mfa_secret(secret, true);\n    let config = test_config();\n    let payload = LoginRequest {\n        username: user.username.clone(),\n        password: TEST_PASSWORD.into(),\n        device_label: None,\n        totp_code: Some(\"000000\".into()),\n    };\n\n    let err = block_on_future(process_login_for_user(\n        user,\n        payload,\n        \u0026config,\n        |_| async { Ok(()) },\n        |_, _| async { Ok(()) },\n        |_, _, _, _| async { Ok(()) },\n    ))\n    .expect_err(\"invalid code should be rejected\");\n    match err {\n        AppError::Unauthorized(msg) =\u003e assert_eq!(msg, \"Invalid MFA code\"),\n        e =\u003e panic!(\"unexpected error: {:?}\", e),\n    }\n}\n\n#[test]\nfn login_requires_totp_code_when_mfa_is_enabled() {\n    let secret = generate_totp_secret();\n    let user = user_with_mfa_secret(secret, true);\n    let config = test_config();\n    let payload = LoginRequest {\n        username: user.username.clone(),\n        password: TEST_PASSWORD.into(),\n        device_label: None,\n        totp_code: None,\n    };\n\n    let err = block_on_future(process_login_for_user(\n        user,\n        payload,\n        \u0026config,\n        |_| async { Ok(()) },\n        |_, _| async { Ok(()) },\n        |_, _, _, _| async { Ok(()) },\n    ))\n    .expect_err(\"missing code should be rejected\");\n    match err {\n        AppError::Unauthorized(msg) =\u003e assert_eq!(msg, \"MFA code required\"),\n        e =\u003e panic!(\"unexpected error: {:?}\", e),\n    }\n}\n\n#[test]\nfn login_accepts_valid_totp_code_when_mfa_is_enabled() {\n    let secret = generate_totp_secret();\n    let user = user_with_mfa_secret(secret.clone(), true);\n    let secret_bytes = base32::decode(base32::Alphabet::RFC4648 { padding: false }, \u0026secret)\n        .expect(\"decode secret\");\n    let totp = totp_rs::TOTP::new(\n        totp_rs::Algorithm::SHA1,\n        6,\n        1,\n        30,\n        secret_bytes,\n        None,\n        \"\".into(),\n    )\n    .expect(\"build totp\");\n    let code = totp.generate_current().expect(\"generate code\");\n\n    let config = test_config();\n    let payload = LoginRequest {\n        username: user.username.clone(),\n        password: TEST_PASSWORD.into(),\n        device_label: Some(\"device\".into()),\n        totp_code: Some(code),\n    };\n\n    block_on_future(process_login_for_user(\n        user,\n        payload,\n        \u0026config,\n        |_| async { Ok(()) },\n        |_, context| async move {\n            assert_eq!(context.as_deref(), Some(\"device\"));\n            Ok(())\n        },\n        |_, _, _, _| async { Ok(()) },\n    ))\n    .expect(\"valid code should pass\");\n}\n","traces":[{"line":63,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":2},{"path":["/","home","marra","projects","timekeeper","backend","tests","config_api.rs"],"content":"use timekeeper_backend::{config::Config, utils::cookies::SameSite};\n\n#[test]\nfn loads_time_zone_string_without_db() {\n    // Ensure Config struct stays default-constructible via explicit values.\n    let cfg = Config {\n        database_url: \"postgres://example\".into(),\n        read_database_url: None,\n        jwt_secret: \"secret\".into(),\n        jwt_expiration_hours: 1,\n        refresh_token_expiration_days: 1,\n        max_concurrent_sessions: 3,\n        audit_log_retention_days: 1825,\n        audit_log_retention_forever: false,\n        consent_log_retention_days: 1825,\n        consent_log_retention_forever: false,\n        aws_region: \"ap-northeast-1\".into(),\n        aws_kms_key_id: \"alias/timekeeper-test\".into(),\n        aws_audit_log_bucket: \"timekeeper-audit-logs\".into(),\n        aws_cloudtrail_enabled: true,\n        cookie_secure: false,\n        cookie_same_site: SameSite::Lax,\n        cors_allow_origins: vec![\"http://localhost:8000\".into()],\n        time_zone: chrono_tz::Asia::Tokyo,\n        mfa_issuer: \"Timekeeper\".into(),\n        rate_limit_ip_max_requests: 15,\n        rate_limit_ip_window_seconds: 900,\n        rate_limit_user_max_requests: 20,\n        rate_limit_user_window_seconds: 3600,\n        redis_url: None,\n        redis_pool_size: 10,\n        redis_connect_timeout: 5,\n        feature_redis_cache_enabled: true,\n        feature_read_replica_enabled: true,\n        password_min_length: 12,\n        password_require_uppercase: true,\n        password_require_lowercase: true,\n        password_require_numbers: true,\n        password_require_symbols: true,\n        password_expiration_days: 90,\n        password_history_count: 5,\n        production_mode: false,\n    };\n    assert_eq!(cfg.time_zone, chrono_tz::Asia::Tokyo);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","consent_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::consents,\n    models::user::{User, UserRole},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/consents\", axum::routing::post(consents::record_consent))\n        .route(\"/api/consents/me\", axum::routing::get(consents::list_my_consents))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_record_consent_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"purpose\": \"terms_of_service\",\n        \"policy_version\": \"v1.0\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/consents\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .header(\"User-Agent\", \"Test-Agent/1.0\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert_eq!(json[\"purpose\"], \"terms_of_service\");\n    assert_eq!(json[\"policy_version\"], \"v1.0\");\n    assert!(json[\"id\"].as_str().is_some());\n}\n\n#[tokio::test]\nasync fn test_record_consent_without_purpose_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"purpose\": \"\",\n        \"policy_version\": \"v1.0\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/consents\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_record_consent_without_policy_version_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"purpose\": \"marketing\",\n        \"policy_version\": \"\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/consents\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_record_consent_purpose_too_long_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let long_purpose = \"a\".repeat(201);\n    let payload = json!({\n        \"purpose\": long_purpose,\n        \"policy_version\": \"v1.0\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/consents\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_record_consent_policy_version_too_long_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let long_version = \"v\".repeat(101);\n    let payload = json!({\n        \"purpose\": \"privacy_policy\",\n        \"policy_version\": long_version\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/consents\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_list_my_consents_returns_consent_history() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"purpose\": \"data_processing\",\n        \"policy_version\": \"v2.0\"\n    });\n    let request_record = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/consents\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    app.clone().oneshot(request_record).await.unwrap();\n    \n    let request_list = Request::builder()\n        .uri(\"/api/consents/me\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response = app.oneshot(request_list).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json.as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_list_my_consents_returns_empty_when_no_consents() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/consents/me\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json.as_array().unwrap().is_empty());\n}\n\n#[tokio::test]\nasync fn test_record_consent_trims_whitespace() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"purpose\": \"  cookie_policy  \",\n        \"policy_version\": \"  v3.0  \"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/consents\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert_eq!(json[\"purpose\"], \"cookie_policy\");\n    assert_eq!(json[\"policy_version\"], \"v3.0\");\n}\n\n#[tokio::test]\nasync fn test_record_multiple_consents_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let consents = vec![\n        json!({\"purpose\": \"terms\", \"policy_version\": \"v1\"}),\n        json!({\"purpose\": \"privacy\", \"policy_version\": \"v2\"}),\n        json!({\"purpose\": \"marketing\", \"policy_version\": \"v1\"}),\n    ];\n    \n    for consent in \u0026consents {\n        let request = Request::builder()\n            .method(\"POST\")\n            .uri(\"/api/consents\")\n            .header(\"Authorization\", format!(\"Bearer {}\", token))\n            .header(\"Content-Type\", \"application/json\")\n            .body(Body::from(consent.to_string()))\n            .unwrap();\n        let response = app.clone().oneshot(request).await.unwrap();\n        assert_eq!(response.status(), StatusCode::OK);\n    }\n    \n    let request_list = Request::builder()\n        .uri(\"/api/consents/me\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response = app.oneshot(request_list).await.unwrap();\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert_eq!(json.as_array().unwrap().len(), 3);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","consent_log_repo.rs"],"content":"use chrono::{Duration as ChronoDuration, Utc};\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    models::{consent_log::ConsentLog, user::UserRole},\n    repositories::consent_log,\n};\nuse tokio::sync::Mutex;\nuse uuid::Uuid;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\n#[tokio::test]\nasync fn consent_log_repo_deletes_logs_before_cutoff() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE consent_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate consent logs\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let now = Utc::now();\n    let old_log = ConsentLog {\n        id: Uuid::new_v4().to_string(),\n        user_id: user.id.to_string(),\n        purpose: \"attendance\".into(),\n        policy_version: \"2026-01\".into(),\n        consented_at: now - ChronoDuration::days(40),\n        ip: None,\n        user_agent: None,\n        request_id: None,\n        created_at: now - ChronoDuration::days(40),\n    };\n    let recent_log = ConsentLog {\n        id: Uuid::new_v4().to_string(),\n        user_id: user.id.to_string(),\n        purpose: \"attendance\".into(),\n        policy_version: \"2026-02\".into(),\n        consented_at: now - ChronoDuration::days(5),\n        ip: None,\n        user_agent: None,\n        request_id: None,\n        created_at: now - ChronoDuration::days(5),\n    };\n\n    consent_log::insert_consent_log(\u0026pool, \u0026old_log)\n        .await\n        .expect(\"insert old consent\");\n    consent_log::insert_consent_log(\u0026pool, \u0026recent_log)\n        .await\n        .expect(\"insert recent consent\");\n\n    let cutoff = now - ChronoDuration::days(30);\n    let deleted = consent_log::delete_consent_logs_before(\u0026pool, cutoff)\n        .await\n        .expect(\"delete consent logs\");\n\n    assert_eq!(deleted, 1);\n\n    let remaining: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM consent_logs\")\n        .fetch_one(\u0026pool)\n        .await\n        .expect(\"count remaining logs\");\n    assert_eq!(remaining.0, 1);\n\n    sqlx::query(\"TRUNCATE consent_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate consent logs\");\n}\n\n#[tokio::test]\nasync fn consent_log_repo_orders_by_consented_at_desc() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE consent_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate consent logs\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let now = Utc::now();\n    let older = ConsentLog {\n        id: Uuid::new_v4().to_string(),\n        user_id: user.id.to_string(),\n        purpose: \"attendance\".into(),\n        policy_version: \"2026-01\".into(),\n        consented_at: now - ChronoDuration::days(1),\n        ip: None,\n        user_agent: None,\n        request_id: None,\n        created_at: now - ChronoDuration::days(1),\n    };\n    let newer = ConsentLog {\n        id: Uuid::new_v4().to_string(),\n        user_id: user.id.to_string(),\n        purpose: \"attendance\".into(),\n        policy_version: \"2026-02\".into(),\n        consented_at: now,\n        ip: None,\n        user_agent: None,\n        request_id: None,\n        created_at: now,\n    };\n\n    consent_log::insert_consent_log(\u0026pool, \u0026older)\n        .await\n        .expect(\"insert older consent\");\n    consent_log::insert_consent_log(\u0026pool, \u0026newer)\n        .await\n        .expect(\"insert newer consent\");\n\n    let user_id = user.id.to_string();\n    let logs = consent_log::list_consent_logs_for_user(\u0026pool, \u0026user_id)\n        .await\n        .expect(\"list consent logs\");\n\n    assert_eq!(logs.len(), 2);\n    assert_eq!(logs[0].policy_version, \"2026-02\");\n    assert_eq!(logs[1].policy_version, \"2026-01\");\n\n    sqlx::query(\"TRUNCATE consent_logs\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate consent logs\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","error_handling_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::auth,\n    models::user::{User, UserRole},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/auth/me\", axum::routing::get(auth::me))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_invalid_json_payload_returns_bad_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let state = AppState::new(pool, None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/requests/leave\", axum::routing::post(timekeeper_backend::handlers::requests::create_leave_request))\n        .layer(Extension(employee))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(\"not valid json\"))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_missing_required_field_returns_bad_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let state = AppState::new(pool, None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/requests/leave\", axum::routing::post(timekeeper_backend::handlers::requests::create_leave_request))\n        .layer(Extension(employee))\n        .with_state(state);\n    \n    let payload = json!({\n        \"leave_type\": \"annual\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_invalid_uuid_format_returns_bad_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let state = AppState::new(pool, None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/admin/users/{id}\", axum::routing::get(timekeeper_backend::handlers::admin::users::update_user))\n        .layer(Extension(employee))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .method(\"GET\")\n        .uri(\"/api/admin/users/not-a-uuid\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_out_of_range_pagination_params() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs\", axum::routing::get(timekeeper_backend::handlers::admin::audit_logs::list_audit_logs))\n        .layer(Extension(sysadmin))\n        .with_state(AppState::new(pool, None, None, None, test_config()));\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs?page=-1\u0026per_page=1000\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_invalid_date_format_returns_bad_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs\", axum::routing::get(timekeeper_backend::handlers::admin::audit_logs::list_audit_logs))\n        .layer(Extension(sysadmin))\n        .with_state(AppState::new(pool, None, None, None, test_config()));\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs?from=invalid-date\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_from_after_to_date_returns_bad_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs\", axum::routing::get(timekeeper_backend::handlers::admin::audit_logs::list_audit_logs))\n        .layer(Extension(sysadmin))\n        .with_state(AppState::new(pool, None, None, None, test_config()));\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs?from=2024-12-31\u0026to=2024-01-01\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_invalid_enum_value_returns_bad_request() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = Router::new()\n        .route(\"/api/admin/audit-logs\", axum::routing::get(timekeeper_backend::handlers::admin::audit_logs::list_audit_logs))\n        .layer(Extension(sysadmin))\n        .with_state(AppState::new(pool, None, None, None, test_config()));\n    \n    let request = Request::builder()\n        .uri(\"/api/admin/audit-logs?result=invalid_value\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_empty_authorization_header_returns_unauthorized() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let state = AppState::new(pool, None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/attendance/me\", axum::routing::get(timekeeper_backend::handlers::attendance::get_my_attendance))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .uri(\"/api/attendance/me\")\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n}\n\n#[tokio::test]\nasync fn test_malformed_jwt_token_returns_unauthorized() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let state = AppState::new(pool, None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/attendance/me\", axum::routing::get(timekeeper_backend::handlers::attendance::get_my_attendance))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .uri(\"/api/attendance/me\")\n        .header(\"Authorization\", \"Bearer invalid-token\")\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n}\n\n#[tokio::test]\nasync fn test_expired_jwt_token_returns_unauthorized() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let expired_token = \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyLTEyMyIsInVzZXJuYW1lIjoidGVzdCIsInJvbGUiOiJlbXBsb3llZSIsImV4cCI6MTcwNDA2MDgwMCwiaWF0IjoxNzA0MDYwODAwLCJqdGkiOiJ0ZXN0LWp0aSJ9.invalid\";\n    \n    let state = AppState::new(pool, None, None, None, test_config());\n    let app = Router::new()\n        .route(\"/api/attendance/me\", axum::routing::get(timekeeper_backend::handlers::attendance::get_my_attendance))\n        .with_state(state);\n    \n    let request = Request::builder()\n        .uri(\"/api/attendance/me\")\n        .header(\"Authorization\", format!(\"Bearer {}\", expired_token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","holiday_api.rs"],"content":"use chrono::{Datelike, NaiveDate};\nuse timekeeper_backend::models::holiday::Holiday;\n\nfn to_month(date: NaiveDate) -\u003e (i32, u32) {\n    (date.year(), date.month())\n}\n\n#[test]\nfn month_filtering_without_db() {\n    let dates = [\n        NaiveDate::from_ymd_opt(2025, 1, 1).unwrap(),\n        NaiveDate::from_ymd_opt(2025, 2, 15).unwrap(),\n        NaiveDate::from_ymd_opt(2025, 1, 10).unwrap(),\n    ];\n    let jan_holidays: Vec\u003c_\u003e = dates\n        .iter()\n        .map(|d| Holiday::new(*d, \"x\".into(), None))\n        .filter(|h| to_month(h.holiday_date) == (2025, 1))\n        .collect();\n    assert_eq!(jan_holidays.len(), 2);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","holiday_exception_flow.rs"],"content":"#![cfg(feature = \"test-utils\")]\n\nuse chrono::NaiveDate;\nuse timekeeper_backend::{\n    handlers::{holiday_exception_repo, holiday_exceptions},\n    models::{\n        holiday_exception::{\n            CreateHolidayExceptionPayload, HolidayException, HolidayExceptionResponse,\n        },\n        user::UserRole,\n    },\n    services::{\n        holiday::{HolidayReason, HolidayService},\n        holiday_exception::{HolidayExceptionService, HolidayExceptionServiceTrait},\n    },\n    state::AppState,\n};\n\nuse {\n    axum::{\n        body::Body,\n        extract::Extension,\n        http::{Request, StatusCode},\n        routing::{delete, get, post},\n        Router,\n    },\n    hyper::body::to_bytes,\n    serde_json::json,\n    std::sync::Arc,\n    tower::ServiceExt,\n};\n\n#[path = \"support/mod.rs\"]\nmod support;\n\n#[tokio::test]\nasync fn repository_prevents_duplicate_exceptions_for_same_user_and_date() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"../migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let date = NaiveDate::from_ymd_opt(2025, 5, 1).unwrap();\n\n    let first = HolidayException::new(\n        user.id.clone(),\n        date,\n        Some(\"出社対応\".into()),\n        user.id.clone(),\n    );\n    holiday_exception_repo::insert_holiday_exception(\u0026pool, \u0026first)\n        .await\n        .expect(\"insert first exception\");\n\n    let second = HolidayException::new(\n        user.id.clone(),\n        date,\n        Some(\"重複を許可しない\".into()),\n        user.id.clone(),\n    );\n\n    let result = holiday_exception_repo::insert_holiday_exception(\u0026pool, \u0026second).await;\n\n    assert!(\n        matches!(result, Err(sqlx::Error::Database(db_err)) if db_err.constraint() == Some(\"holiday_exceptions_user_date_key\")),\n        \"duplicate insert should surface unique constraint\"\n    );\n}\n\n#[tokio::test]\nasync fn service_marks_exception_as_workday_over_public_and_weekly() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"../migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let date = NaiveDate::from_ymd_opt(2025, 5, 3).unwrap();\n    support::seed_public_holiday(\u0026pool, date, \"みなし公休日\").await;\n    support::seed_weekly_holiday(\u0026pool, date).await;\n\n    let exception_service = HolidayExceptionService::new(pool.clone());\n    let holiday_service = HolidayService::new(pool.clone());\n\n    exception_service\n        .create_workday_override(\n            \u0026user.id,\n            CreateHolidayExceptionPayload {\n                exception_date: date,\n                reason: Some(\"現場稼働のため出社\".into()),\n            },\n            \u0026user.id,\n        )\n        .await\n        .expect(\"create override\");\n\n    let decision = holiday_service\n        .is_holiday(date, Some(\u0026user.id))\n        .await\n        .expect(\"holiday decision\");\n\n    assert!(\n        !decision.is_holiday,\n        \"exception should mark the day as working day\"\n    );\n    assert!(matches!(decision.reason, HolidayReason::ExceptionOverride));\n}\n\n#[tokio::test]\nasync fn handler_creates_and_lists_personal_workday_override() {\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"../migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    let config = support::test_config();\n    let admin = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let target = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n\n    let exception_service: Arc\u003cdyn HolidayExceptionServiceTrait\u003e =\n        Arc::new(HolidayExceptionService::new(pool.clone()));\n\n    let app = Router::new()\n        .route(\n            \"/api/admin/users/{user_id}/holiday-exceptions\",\n            post(holiday_exceptions::create_holiday_exception)\n                .get(holiday_exceptions::list_holiday_exceptions),\n        )\n        .route(\n            \"/api/admin/users/{user_id}/holiday-exceptions/{id}\",\n            delete(holiday_exceptions::delete_holiday_exception),\n        )\n        .with_state(AppState::new(\n            pool.clone(),\n            None,\n            None,\n            None,\n            config.clone(),\n        ))\n        .layer(Extension(admin.clone()))\n        .layer(Extension(exception_service.clone()));\n\n    let payload = json!({\n        \"exception_date\": date(2025, 6, 10),\n        \"reason\": \"祝日を出社扱いにする\"\n    });\n    let response = app\n        .clone()\n        .oneshot(\n            Request::post(format!(\"/api/admin/users/{}/holiday-exceptions\", target.id))\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(payload.to_string()))\n                .unwrap(),\n        )\n        .await\n        .expect(\"handler should respond\");\n    assert_eq!(response.status(), StatusCode::CREATED);\n\n    let body = to_bytes(response.into_body()).await.expect(\"read body\");\n    let created: HolidayExceptionResponse =\n        serde_json::from_slice(\u0026body).expect(\"parse response body\");\n    assert_eq!(created.exception_date, date(2025, 6, 10));\n    assert!(created.is_workday);\n    assert_eq!(created.reason.as_deref(), Some(\"祝日を出社扱いにする\"));\n\n    let duplicate = app\n        .clone()\n        .oneshot(\n            Request::post(format!(\"/api/admin/users/{}/holiday-exceptions\", target.id))\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(payload.to_string()))\n                .unwrap(),\n        )\n        .await\n        .expect(\"handler should respond\");\n    assert_eq!(duplicate.status(), StatusCode::CONFLICT);\n\n    let list_response = app\n        .oneshot(\n            Request::get(format!(\"/api/admin/users/{}/holiday-exceptions\", target.id))\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .expect(\"list handler should respond\");\n    assert_eq!(list_response.status(), StatusCode::OK);\n    let list_body = to_bytes(list_response.into_body())\n        .await\n        .expect(\"read list body\");\n    let listed: Vec\u003cHolidayExceptionResponse\u003e =\n        serde_json::from_slice(\u0026list_body).expect(\"parse list response\");\n    assert_eq!(listed.len(), 1);\n    assert_eq!(listed[0].exception_date, date(2025, 6, 10));\n}\n\nfn date(year: i32, month: u32, day: u32) -\u003e NaiveDate {\n    NaiveDate::from_ymd_opt(year, month, day).expect(\"valid date\")\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","holiday_exceptions_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse chrono::NaiveDate;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse std::sync::Arc;\nuse timekeeper_backend::{\n    handlers::holiday_exceptions,\n    models::{\n        holiday_exception::{CreateHolidayExceptionPayload, HolidayExceptionResponse},\n        user::{User, UserRole},\n    },\n    services::holiday_exception::{HolidayExceptionService, HolidayExceptionServiceTrait},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool.clone(), None, None, None, test_config());\n    let holiday_exception_service: Arc\u003cdyn HolidayExceptionServiceTrait\u003e = \n        Arc::new(HolidayExceptionService::new(pool));\n    \n    Router::new()\n        .route(\"/api/users/{user_id}/holiday-exceptions\", axum::routing::post(holiday_exceptions::create_holiday_exception))\n        .route(\"/api/users/{user_id}/holiday-exceptions\", axum::routing::get(holiday_exceptions::list_holiday_exceptions))\n        .route(\"/api/users/{user_id}/holiday-exceptions/{id}\", axum::routing::delete(holiday_exceptions::delete_holiday_exception))\n        .layer(Extension(user))\n        .layer(Extension(holiday_exception_service))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_admin_can_create_holiday_exception() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-12-25\",\n        \"is_workday\": true,\n        \"reason\": \"Working on holiday\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::CREATED);\n}\n\n#[tokio::test]\nasync fn test_system_admin_can_create_holiday_exception() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let sysadmin = seed_user(\u0026pool, UserRole::Admin, true).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(sysadmin.id, sysadmin.role.clone());\n    let app = test_router_with_state(pool.clone(), sysadmin.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-01-01\",\n        \"is_workday\": false,\n        \"reason\": \"Non-working day override\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::CREATED);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_create_holiday_exception() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee1 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let employee2 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee1.id, employee1.role.clone());\n    let app = test_router_with_state(pool.clone(), employee1.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-12-25\",\n        \"is_workday\": true,\n        \"reason\": \"Working\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", employee2.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_admin_can_list_holiday_exceptions() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_list_holiday_exceptions_with_date_range() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/users/{}/holiday-exceptions?from=2024-01-01\u0026to=2024-12-31\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_create_duplicate_holiday_exception_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-07-04\",\n        \"is_workday\": true,\n        \"reason\": \"Working on holiday\"\n    });\n    \n    let request1 = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    app.clone().oneshot(request1).await.unwrap();\n    \n    let request2 = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response = app.oneshot(request2).await.unwrap();\n    assert_eq!(response.status(), StatusCode::CONFLICT);\n}\n\n#[tokio::test]\nasync fn test_invalid_user_id_format_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-12-25\",\n        \"is_workday\": true,\n        \"reason\": \"Working\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/users/invalid-id/holiday-exceptions\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_nonexistent_user_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    \n    let token = create_test_token(admin.id, admin.role.clone());\n    let app = test_router_with_state(pool.clone(), admin.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-12-25\",\n        \"is_workday\": true,\n        \"reason\": \"Working\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", timekeeper_backend::types::UserId::new()))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_list_other_user_exceptions() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee1 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let employee2 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee1.id, employee1.role.clone());\n    let app = test_router_with_state(pool.clone(), employee1.clone());\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/users/{}/holiday-exceptions\", employee2.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","holiday_repository.rs"],"content":"use chrono::{NaiveDate, Utc};\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    models::{holiday::Holiday, user::UserRole},\n    repositories::{repository::Repository, HolidayRepository, HolidayRepositoryTrait},\n};\nuse tokio::sync::Mutex;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\n#[tokio::test]\nasync fn holiday_repository_roundtrip() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE holidays\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate holidays\");\n\n    let _user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let date = NaiveDate::from_ymd_opt(2024, 12, 25).unwrap();\n    let holiday = Holiday::new(date, \"Holiday\".into(), Some(\"seasonal\".into()));\n\n    let repo = HolidayRepository::new();\n    let saved = repo.create(\u0026pool, \u0026holiday).await.expect(\"create holiday\");\n    assert_eq!(saved.holiday_date, date);\n\n    let by_date = repo.find_by_date(\u0026pool, date).await.expect(\"find by date\");\n    assert!(by_date.is_some());\n\n    let mut updated = saved;\n    updated.name = \"Updated\".into();\n    updated.description = None;\n    updated.updated_at = Utc::now();\n    let saved_update = repo.update(\u0026pool, \u0026updated).await.expect(\"update holiday\");\n    assert_eq!(saved_update.name, \"Updated\");\n    assert!(saved_update.description.is_none());\n\n    repo.delete(\u0026pool, saved_update.id)\n        .await\n        .expect(\"delete holiday\");\n    let missing = repo\n        .find_by_date(\u0026pool, date)\n        .await\n        .expect(\"find after delete\");\n    assert!(missing.is_none());\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","holiday_repository_mock.rs"],"content":"#![allow(dead_code)]\n\n#[test]\nfn mock_tests_disabled() {\n    // Mock repository tests require the \"mock\" feature.\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","holiday_service.rs"],"content":"use chrono::NaiveDate;\nuse timekeeper_backend::services::holiday::{\n    HolidayReason, HolidayServiceStub, HolidayServiceTrait,\n};\n\n#[tokio::test]\nasync fn exception_override_beats_public_and_weekly_flags() {\n    let public = NaiveDate::from_ymd_opt(2025, 4, 1).unwrap();\n    let weekly = NaiveDate::from_ymd_opt(2025, 4, 2).unwrap();\n    let override_date = public;\n\n    let service = HolidayServiceStub::new([public], [weekly], [(override_date, false)]).service();\n\n    let decision = service\n        .is_holiday(override_date, None)\n        .await\n        .expect(\"holiday decision\");\n\n    assert!(!decision.is_holiday);\n    assert_eq!(decision.reason, HolidayReason::ExceptionOverride);\n}\n\n#[tokio::test]\nasync fn list_month_applies_service_logic_over_mixed_sources() {\n    let public = NaiveDate::from_ymd_opt(2025, 4, 1).unwrap();\n    let weekly_first = NaiveDate::from_ymd_opt(2025, 4, 4).unwrap();\n    let weekly_second = NaiveDate::from_ymd_opt(2025, 4, 11).unwrap();\n    let forced_holiday = NaiveDate::from_ymd_opt(2025, 4, 15).unwrap();\n\n    let service = HolidayServiceStub::new(\n        [public],\n        [weekly_first, weekly_second],\n        [(forced_holiday, true)],\n    )\n    .service();\n\n    let entries = service\n        .list_month(2025, 4, None)\n        .await\n        .expect(\"list monthly holidays\");\n    let dates: Vec\u003c_\u003e = entries.iter().map(|entry| entry.date).collect();\n\n    assert_eq!(\n        dates,\n        vec![public, weekly_first, weekly_second, forced_holiday]\n    );\n    assert!(entries.iter().all(|entry| matches!(\n        entry.reason,\n        HolidayReason::PublicHoliday\n            | HolidayReason::WeeklyHoliday\n            | HolidayReason::ExceptionOverride\n    )));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","leave_request_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse chrono::NaiveDate;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::requests,\n    models::{\n        leave_request::LeaveType,\n        user::{User, UserRole},\n    },\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/requests/leave\", axum::routing::post(requests::create_leave_request))\n        .route(\"/api/requests/me\", axum::routing::get(requests::get_my_requests))\n        .route(\"/api/requests/{id}\", axum::routing::delete(requests::cancel_request))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_create_leave_request_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"annual\",\n        \"start_date\": \"2024-07-15\",\n        \"end_date\": \"2024-07-17\",\n        \"reason\": \"Summer vacation\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_create_leave_request_with_invalid_date_range_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"annual\",\n        \"start_date\": \"2024-07-20\",\n        \"end_date\": \"2024-07-15\",\n        \"reason\": \"Invalid dates\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_create_leave_request_without_reason_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"sick\",\n        \"start_date\": \"2024-07-15\",\n        \"end_date\": \"2024-07-15\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_get_my_requests_returns_list() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"annual\",\n        \"start_date\": \"2024-07-15\",\n        \"end_date\": \"2024-07-17\",\n        \"reason\": \"Summer vacation\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    app.clone().oneshot(request_create).await.unwrap();\n    \n    let request_list = Request::builder()\n        .uri(\"/api/requests/me\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response = app.oneshot(request_list).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json[\"leave_requests\"].as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_cancel_leave_request_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"leave_type\": \"annual\",\n        \"start_date\": \"2024-08-01\",\n        \"end_date\": \"2024-08-03\",\n        \"reason\": \"Personal\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/leave\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response_create = app.clone().oneshot(request_create).await.unwrap();\n    assert_eq!(response_create.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response_create.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let request_id = json[\"id\"].as_str().unwrap();\n    \n    let request_cancel = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/requests/{}\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response_cancel = app.oneshot(request_cancel).await.unwrap();\n    assert_eq!(response_cancel.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_cancel_nonexistent_request_returns_not_found() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request_id = timekeeper_backend::types::LeaveRequestId::new();\n    let request_cancel = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/requests/{}\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response = app.oneshot(request_cancel).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","leave_request_repository_mock.rs"],"content":"#![allow(dead_code)]\n\n#[test]\nfn mock_tests_disabled() {\n    // Mock repository tests require the \"mock\" feature.\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","mfa_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::auth,\n    models::user::{User, UserRole},\n    state::AppState,\n    utils::mfa::{generate_totp_secret, verify_totp_code},\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/auth/mfa\", axum::routing::get(auth::mfa_status))\n        .route(\"/api/auth/mfa\", axum::routing::delete(auth::mfa_disable))\n        .route(\"/api/auth/mfa/setup\", axum::routing::post(auth::mfa_setup))\n        .route(\"/api/auth/mfa/activate\", axum::routing::post(auth::mfa_activate))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\nfn generate_test_totp_code(secret: \u0026str) -\u003e String {\n    use totp_rs::{Algorithm, TOTP};\n    use base32::Alphabet::RFC4648;\n    let cleaned = secret.trim().replace(' ', \"\").to_uppercase();\n    let secret_bytes = base32::decode(RFC4648 { padding: false }, \u0026cleaned).unwrap();\n    let totp = TOTP::new(\n        Algorithm::SHA1,\n        6,\n        1,\n        30,\n        secret_bytes,\n        Some(\"Test\".to_string()),\n        \"user\".to_string(),\n    ).unwrap();\n    totp.generate_current().unwrap()\n}\n\n#[tokio::test]\nasync fn test_mfa_setup_returns_secret_and_qr_url() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/auth/mfa/setup\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json[\"secret\"].as_str().is_some());\n    assert!(json[\"otpauth_url\"].as_str().is_some());\n}\n\n#[tokio::test]\nasync fn test_mfa_setup_already_enabled_returns_error() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let secret = generate_totp_secret();\n    employee.mfa_secret = Some(secret);\n    employee.mfa_enabled_at = Some(chrono::Utc::now());\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/auth/mfa/setup\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_mfa_activate_with_valid_code_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let secret = generate_totp_secret();\n    employee.mfa_secret = Some(secret.clone());\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let code = generate_test_totp_code(\u0026secret);\n    let payload = json!({\"code\": code});\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/auth/mfa/activate\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_mfa_activate_with_invalid_code_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let secret = generate_totp_secret();\n    employee.mfa_secret = Some(secret);\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\"code\": \"000000\"});\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/auth/mfa/activate\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n}\n\n#[tokio::test]\nasync fn test_mfa_activate_without_setup_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\"code\": \"123456\"});\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/auth/mfa/activate\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_mfa_disable_with_valid_code_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let secret = generate_totp_secret();\n    employee.mfa_secret = Some(secret.clone());\n    employee.mfa_enabled_at = Some(chrono::Utc::now());\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let code = generate_test_totp_code(\u0026secret);\n    let payload = json!({\"code\": code});\n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(\"/api/auth/mfa\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_mfa_disable_with_invalid_code_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let secret = generate_totp_secret();\n    employee.mfa_secret = Some(secret);\n    employee.mfa_enabled_at = Some(chrono::Utc::now());\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\"code\": \"000000\"});\n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(\"/api/auth/mfa\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n}\n\n#[tokio::test]\nasync fn test_mfa_disable_without_mfa_enabled_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\"code\": \"123456\"});\n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(\"/api/auth/mfa\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_mfa_status_returns_enabled_state() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let secret = generate_totp_secret();\n    employee.mfa_secret = Some(secret);\n    employee.mfa_enabled_at = Some(chrono::Utc::now());\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/auth/mfa\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert_eq!(json[\"enabled\"], true);\n}\n\n#[tokio::test]\nasync fn test_mfa_status_returns_disabled_state() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let request = Request::builder()\n        .uri(\"/api/auth/mfa\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert_eq!(json[\"enabled\"], false);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","overtime_request_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse chrono::NaiveDate;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::requests,\n    models::user::{User, UserRole},\n    state::AppState,\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/requests/overtime\", axum::routing::post(requests::create_overtime_request))\n        .route(\"/api/requests/me\", axum::routing::get(requests::get_my_requests))\n        .route(\"/api/requests/{id}\", axum::routing::delete(requests::cancel_request))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_create_overtime_request_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-07-15\",\n        \"planned_hours\": 3.5,\n        \"reason\": \"Project deadline\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/overtime\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_create_overtime_request_with_zero_hours_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-07-15\",\n        \"planned_hours\": 0.0,\n        \"reason\": \"Invalid\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/overtime\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_create_overtime_request_with_excessive_hours_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-07-15\",\n        \"planned_hours\": 25.0,\n        \"reason\": \"Too many hours\"\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/overtime\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_get_my_requests_includes_overtime() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-08-01\",\n        \"planned_hours\": 2.0,\n        \"reason\": \"Urgent task\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/overtime\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    app.clone().oneshot(request_create).await.unwrap();\n    \n    let request_list = Request::builder()\n        .uri(\"/api/requests/me\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response = app.oneshot(request_list).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json[\"overtime_requests\"].as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_cancel_overtime_request_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-08-15\",\n        \"planned_hours\": 4.0,\n        \"reason\": \"Extra work\"\n    });\n    let request_create = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/overtime\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    let response_create = app.clone().oneshot(request_create).await.unwrap();\n    assert_eq!(response_create.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response_create.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    let request_id = json[\"id\"].as_str().unwrap();\n    \n    let request_cancel = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/requests/{}\", request_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .body(Body::empty())\n        .unwrap();\n    let response_cancel = app.oneshot(request_cancel).await.unwrap();\n    assert_eq!(response_cancel.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_create_overtime_request_without_reason_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"date\": \"2024-09-01\",\n        \"planned_hours\": 1.5\n    });\n    let request = Request::builder()\n        .method(\"POST\")\n        .uri(\"/api/requests/overtime\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","overtime_request_repository_mock.rs"],"content":"#![allow(dead_code)]\n\n#[test]\nfn mock_tests_disabled() {\n    // Mock repository tests require the \"mock\" feature.\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","password_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::auth,\n    models::user::{User, UserRole},\n    state::AppState,\n    utils::password::{hash_password, verify_password},\n};\nuse tower::ServiceExt;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn test_router_with_state(pool: PgPool, user: User) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/auth/password\", axum::routing::put(auth::change_password))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_change_password_with_correct_current_password_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": password,\n        \"new_password\": \"NewPass456!@#\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_change_password_with_incorrect_current_password_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": \"WrongPass123!\",\n        \"new_password\": \"NewPass456!@#\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n}\n\n#[tokio::test]\nasync fn test_change_password_same_as_current_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": password,\n        \"new_password\": password\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_change_password_with_weak_password_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": password,\n        \"new_password\": \"weak\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_change_password_with_short_password_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": password,\n        \"new_password\": \"Short1!\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_change_password_without_uppercase_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": password,\n        \"new_password\": \"lowercase123!\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_change_password_without_number_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": password,\n        \"new_password\": \"NoNumbersHere!\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_change_password_without_special_char_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let password = \"CurrentPass123!\";\n    let mut employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let password_hash = hash_password(password).expect(\"hash password\");\n    employee.password_hash = password_hash;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": password,\n        \"new_password\": \"NoSpecialChar123\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_change_password_empty_current_password_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let token = create_test_token(employee.id, employee.role.clone());\n    let app = test_router_with_state(pool.clone(), employee.clone());\n    \n    let payload = json!({\n        \"current_password\": \"\",\n        \"new_password\": \"NewPass456!@#\"\n    });\n    let request = Request::builder()\n        .method(\"PUT\")\n        .uri(\"/api/auth/password\")\n        .header(\"Authorization\", format!(\"Bearer {}\", token))\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(payload.to_string()))\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","password_reset_api.rs"],"content":"use axum::{\n    body::{to_bytes, Body},\n    http::{Request, StatusCode},\n    routing::post,\n    Router,\n};\nuse chrono::Utc;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse std::{env, sync::OnceLock};\nuse timekeeper_backend::{\n    handlers,\n    models::user::{User, UserRole},\n    repositories::{auth as auth_repo, password_reset as password_reset_repo},\n    state::AppState,\n    utils::{\n        password::{hash_password, verify_password},\n        security::generate_token,\n    },\n};\nuse tokio::sync::Mutex;\nuse tower::ServiceExt;\nuse uuid::Uuid;\n\nmod support;\n\nasync fn migrate_db(pool: \u0026PgPool) {\n    sqlx::migrate!(\"./migrations\")\n        .run(pool)\n        .await\n        .expect(\"run migrations\");\n}\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\nfn configure_email_skip() {\n    static EMAIL_SKIP: OnceLock\u003c()\u003e = OnceLock::new();\n    EMAIL_SKIP.get_or_init(|| {\n        env::set_var(\"SMTP_SKIP_SEND\", \"true\");\n    });\n}\n\nasync fn reset_password_resets(pool: \u0026PgPool) {\n    sqlx::query(\"TRUNCATE password_resets\")\n        .execute(pool)\n        .await\n        .expect(\"truncate password_resets\");\n}\n\n#[tokio::test]\nasync fn test_password_reset_full_flow() {\n    let _guard = integration_guard().await;\n    configure_email_skip();\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n    reset_password_resets(\u0026pool).await;\n\n    let email = \"test@example.com\";\n    let initial_password = \"OldPassword123!\";\n    let new_password = \"NewPassword456!\";\n\n    let user = create_test_user(\u0026pool, email, initial_password).await;\n\n    let token = generate_token(32);\n    let reset_record = password_reset_repo::create_password_reset(\u0026pool, user.id, \u0026token)\n        .await\n        .expect(\"create password reset\");\n\n    assert_eq!(reset_record.user_id, user.id);\n    assert!(reset_record.used_at.is_none());\n    assert!(reset_record.expires_at \u003e Utc::now());\n\n    let found_reset = password_reset_repo::find_valid_reset_by_token(\u0026pool, \u0026token)\n        .await\n        .expect(\"find reset\")\n        .expect(\"reset should exist\");\n\n    assert_eq!(found_reset.id, reset_record.id);\n    assert_eq!(found_reset.user_id, user.id);\n\n    let new_hash = hash_password(new_password).expect(\"hash new password\");\n    let updated_user =\n        auth_repo::update_user_password(\u0026pool, user.id, \u0026new_hash, \u0026user.password_hash, 5)\n            .await\n            .expect(\"update password\");\n\n    assert_ne!(updated_user.password_hash, user.password_hash);\n\n    password_reset_repo::mark_token_as_used(\u0026pool, \u0026reset_record.id)\n        .await\n        .expect(\"mark token used\");\n\n    let used_reset =\n        sqlx::query_as::\u003c_, timekeeper_backend::models::password_reset::PasswordReset\u003e(\n            \"SELECT * FROM password_resets WHERE id = $1\",\n        )\n        .bind(\u0026reset_record.id)\n        .fetch_one(\u0026pool)\n        .await\n        .expect(\"fetch used reset\");\n\n    assert!(used_reset.used_at.is_some());\n\n    let invalid_search = password_reset_repo::find_valid_reset_by_token(\u0026pool, \u0026token)\n        .await\n        .expect(\"search should succeed\");\n\n    assert!(invalid_search.is_none());\n}\n\n#[tokio::test]\nasync fn test_expired_token_cleanup() {\n    let _guard = integration_guard().await;\n    configure_email_skip();\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n    reset_password_resets(\u0026pool).await;\n\n    let user = create_test_user(\u0026pool, \"cleanup@example.com\", \"Pass123!\").await;\n\n    sqlx::query(\n        \"INSERT INTO password_resets (id, user_id, token_hash, expires_at) VALUES ($1, $2, $3, $4)\",\n    )\n    .bind(Uuid::new_v4().to_string())\n    .bind(user.id)\n    .bind(\"expired_token_hash\")\n    .bind(Utc::now() - chrono::Duration::hours(2))\n    .execute(\u0026pool)\n    .await\n    .expect(\"insert expired token\");\n\n    let deleted = password_reset_repo::delete_expired_tokens(\u0026pool)\n        .await\n        .expect(\"cleanup\");\n\n    assert!(deleted \u003e= 1);\n\n    let count: i64 =\n        sqlx::query_scalar(\"SELECT COUNT(*) FROM password_resets WHERE token_hash = $1\")\n            .bind(\"expired_token_hash\")\n            .fetch_one(\u0026pool)\n            .await\n            .expect(\"count\");\n\n    assert_eq!(count, 0);\n}\n\n#[tokio::test]\nasync fn test_invalid_token_returns_none() {\n    let _guard = integration_guard().await;\n    configure_email_skip();\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n    reset_password_resets(\u0026pool).await;\n\n    let result = password_reset_repo::find_valid_reset_by_token(\u0026pool, \"invalid_token\")\n        .await\n        .expect(\"query should succeed\");\n\n    assert!(result.is_none());\n}\n\nasync fn create_test_user(pool: \u0026PgPool, email: \u0026str, password: \u0026str) -\u003e User {\n    let password_hash = hash_password(password).expect(\"hash password\");\n\n    let user_id = Uuid::new_v4();\n    let (local, domain) = email.split_once('@').unwrap_or((email, \"example.com\"));\n    let unique_email = format!(\"{}+{}@{}\", local, user_id, domain);\n    let username = format!(\"user_{}\", unique_email);\n    sqlx::query_as::\u003c_, User\u003e(\n        r#\"\n        INSERT INTO users (id, username, password_hash, full_name, email, role, is_system_admin)\n        VALUES ($1, $2, $3, $4, $5, $6, $7)\n        RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \n        mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\n        \"#,\n    )\n    .bind(user_id)\n    .bind(username)\n    .bind(password_hash)\n    .bind(\"Test User\")\n    .bind(unique_email)\n    .bind(UserRole::Employee.as_str())\n    .bind(false)\n    .fetch_one(pool)\n    .await\n    .expect(\"create test user\")\n}\n\n#[tokio::test]\nasync fn request_password_reset_creates_token_record() {\n    let _guard = integration_guard().await;\n    configure_email_skip();\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n    reset_password_resets(\u0026pool).await;\n\n    let user = create_test_user(\u0026pool, \"reset-request@example.com\", \"Pass123!\").await;\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n\n    let app = Router::new()\n        .route(\n            \"/api/auth/request-password-reset\",\n            post(handlers::auth::request_password_reset),\n        )\n        .with_state(state);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/auth/request-password-reset\")\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(json!({ \"email\": user.email }).to_string()))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let payload: serde_json::Value = serde_json::from_slice(\u0026body).expect(\"parse response\");\n    assert!(payload.get(\"message\").and_then(|v| v.as_str()).is_some());\n\n    let token_hash: String = sqlx::query_scalar(\n        \"SELECT token_hash FROM password_resets WHERE user_id = $1 ORDER BY created_at DESC LIMIT 1\",\n    )\n    .bind(user.id)\n    .fetch_one(\u0026pool)\n    .await\n    .expect(\"fetch token hash\");\n\n    assert_eq!(token_hash.len(), 64);\n}\n\n#[tokio::test]\nasync fn reset_password_endpoint_marks_token_used_and_rejects_reuse() {\n    let _guard = integration_guard().await;\n    configure_email_skip();\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n    reset_password_resets(\u0026pool).await;\n\n    let user = create_test_user(\u0026pool, \"reset-endpoint@example.com\", \"Pass123!\").await;\n    let token = generate_token(32);\n    let reset_record = password_reset_repo::create_password_reset(\u0026pool, user.id, \u0026token)\n        .await\n        .expect(\"create reset record\");\n\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n    let app = Router::new()\n        .route(\n            \"/api/auth/reset-password\",\n            post(handlers::auth::reset_password),\n        )\n        .with_state(state);\n\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/auth/reset-password\")\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(\n                    json!({ \"token\": token, \"new_password\": \"NewPassword123!\" }).to_string(),\n                ))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let used_at: Option\u003cchrono::DateTime\u003cUtc\u003e\u003e =\n        sqlx::query_scalar(\"SELECT used_at FROM password_resets WHERE id = $1\")\n            .bind(\u0026reset_record.id)\n            .fetch_one(\u0026pool)\n            .await\n            .expect(\"fetch used_at\");\n    assert!(used_at.is_some());\n\n    let updated_user = auth_repo::find_user_by_id(\u0026pool, user.id)\n        .await\n        .expect(\"fetch user\")\n        .expect(\"user exists\");\n    let matches =\n        verify_password(\"NewPassword123!\", \u0026updated_user.password_hash).expect(\"verify password\");\n    assert!(matches);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/auth/reset-password\")\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(\n                    json!({ \"token\": token, \"new_password\": \"OtherPassword123!\" }).to_string(),\n                ))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","rate_limit_integration_tests.rs"],"content":"use axum::{http::StatusCode, routing::post, Router};\nuse std::{net::SocketAddr, time::Duration};\nuse tokio::net::TcpListener;\n\nuse timekeeper_backend::{config::Config, middleware::rate_limit::create_auth_rate_limiter};\n\nfn test_config(rate_limit_ip_max_requests: u32, rate_limit_ip_window_seconds: u64) -\u003e Config {\n    Config {\n        database_url: \"test://\".to_string(),\n        read_database_url: None,\n        jwt_secret: \"test-jwt-secret-32-chars-minimum!\".to_string(),\n        jwt_expiration_hours: 1,\n        refresh_token_expiration_days: 7,\n        max_concurrent_sessions: 3,\n        audit_log_retention_days: 30,\n        audit_log_retention_forever: false,\n        consent_log_retention_days: 30,\n        consent_log_retention_forever: false,\n        aws_region: \"us-east-1\".to_string(),\n        aws_kms_key_id: \"test-key\".to_string(),\n        aws_audit_log_bucket: \"test-bucket\".to_string(),\n        aws_cloudtrail_enabled: false,\n        cookie_secure: false,\n        cookie_same_site: timekeeper_backend::utils::cookies::SameSite::Lax,\n        cors_allow_origins: vec![\"http://localhost:3000\".to_string()],\n        time_zone: chrono_tz::UTC,\n        mfa_issuer: \"Timekeeper\".to_string(),\n        rate_limit_ip_max_requests,\n        rate_limit_ip_window_seconds,\n        rate_limit_user_max_requests: 5,\n        rate_limit_user_window_seconds: 300,\n        redis_url: None,\n        redis_pool_size: 10,\n        redis_connect_timeout: 5,\n        feature_redis_cache_enabled: true,\n        feature_read_replica_enabled: true,\n        password_min_length: 12,\n        password_require_uppercase: true,\n        password_require_lowercase: true,\n        password_require_numbers: true,\n        password_require_symbols: true,\n        password_expiration_days: 90,\n        password_history_count: 5,\n        production_mode: false,\n    }\n}\n\nasync fn spawn_rate_limited_app(config: Config) -\u003e (SocketAddr, tokio::task::JoinHandle\u003c()\u003e) {\n    let listener = TcpListener::bind(\"127.0.0.1:0\").await.unwrap();\n    let addr = listener.local_addr().unwrap();\n    let limiter = create_auth_rate_limiter(\u0026config);\n\n    let app = Router::new()\n        .route(\"/login\", post(|| async { StatusCode::OK }))\n        .route_layer(limiter);\n\n    let server = axum::serve(\n        listener,\n        app.into_make_service_with_connect_info::\u003cSocketAddr\u003e(),\n    );\n    let handle = tokio::spawn(async move {\n        server.await.expect(\"server should run\");\n    });\n\n    tokio::time::sleep(Duration::from_millis(50)).await;\n    (addr, handle)\n}\n\n#[tokio::test]\nasync fn rate_limit_blocks_after_burst() {\n    let config = test_config(2, 2);\n    let (addr, handle) = spawn_rate_limited_app(config).await;\n\n    let client = reqwest::Client::new();\n    let url = format!(\"http://{}/login\", addr);\n\n    for _ in 0..2 {\n        let resp = client.post(\u0026url).send().await.unwrap();\n        assert_eq!(resp.status(), StatusCode::OK);\n    }\n\n    let resp = client.post(\u0026url).send().await.unwrap();\n    assert_eq!(resp.status(), StatusCode::TOO_MANY_REQUESTS);\n\n    handle.abort();\n}\n\n#[tokio::test]\nasync fn rate_limit_includes_headers() {\n    let config = test_config(1, 2);\n    let (addr, handle) = spawn_rate_limited_app(config).await;\n\n    let client = reqwest::Client::new();\n    let url = format!(\"http://{}/login\", addr);\n\n    let _ = client.post(\u0026url).send().await.unwrap();\n    let resp = client.post(\u0026url).send().await.unwrap();\n\n    assert_eq!(resp.status(), StatusCode::TOO_MANY_REQUESTS);\n    assert!(resp.headers().contains_key(\"x-ratelimit-limit\"));\n    assert!(resp.headers().contains_key(\"x-ratelimit-remaining\"));\n    assert!(resp.headers().contains_key(\"x-ratelimit-after\"));\n\n    handle.abort();\n}\n\n#[tokio::test]\nasync fn rate_limit_blocks_same_peer_ip() {\n    let config = test_config(1, 2);\n    let (addr, handle) = spawn_rate_limited_app(config).await;\n\n    let client = reqwest::Client::new();\n    let url = format!(\"http://{}/login\", addr);\n\n    let resp = client.post(\u0026url).send().await.unwrap();\n    assert_eq!(resp.status(), StatusCode::OK);\n\n    let resp = client.post(\u0026url).send().await.unwrap();\n    assert_eq!(resp.status(), StatusCode::TOO_MANY_REQUESTS);\n\n    handle.abort();\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","request_id_header.rs"],"content":"use axum::{body::Body, http::Request};\nuse tower::ServiceExt;\nuse uuid::Uuid;\n\n#[tokio::test]\nasync fn test_request_id_header_added_to_response() {\n    let app = axum::Router::new()\n        .route(\"/test\", axum::routing::get(|| async { \"ok\" }))\n        .layer(axum::middleware::from_fn(\n            timekeeper_backend::middleware::request_id::request_id,\n        ));\n\n    let response = app\n        .oneshot(Request::builder().uri(\"/test\").body(Body::empty()).unwrap())\n        .await\n        .unwrap();\n\n    assert!(response.headers().contains_key(\"x-request-id\"));\n    let id = response\n        .headers()\n        .get(\"x-request-id\")\n        .unwrap()\n        .to_str()\n        .unwrap();\n    assert!(Uuid::parse_str(id).is_ok());\n}\n\n#[tokio::test]\nasync fn test_request_id_header_persists_client_id() {\n    let app = axum::Router::new()\n        .route(\"/test\", axum::routing::get(|| async { \"ok\" }))\n        .layer(axum::middleware::from_fn(\n            timekeeper_backend::middleware::request_id::request_id,\n        ));\n\n    let client_id = \"client-req-123\";\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(\"/test\")\n                .header(\"x-request-id\", client_id)\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n\n    assert_eq!(response.headers().get(\"x-request-id\").unwrap(), client_id);\n}\n\n#[tokio::test]\nasync fn test_request_id_header_persists_correlation_id() {\n    let app = axum::Router::new()\n        .route(\"/test\", axum::routing::get(|| async { \"ok\" }))\n        .layer(axum::middleware::from_fn(\n            timekeeper_backend::middleware::request_id::request_id,\n        ));\n\n    let correlation_id = \"corr-req-456\";\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(\"/test\")\n                .header(\"x-correlation-id\", correlation_id)\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n\n    assert_eq!(\n        response.headers().get(\"x-request-id\").unwrap(),\n        correlation_id\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","request_repositories.rs"],"content":"use chrono::{NaiveDate, Utc};\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    models::{\n        leave_request::{LeaveRequest, LeaveType, RequestStatus},\n        overtime_request::OvertimeRequest,\n        user::UserRole,\n    },\n    repositories::{\n        repository::Repository,\n        LeaveRequestRepository,\n        LeaveRequestRepositoryTrait,\n        OvertimeRequestRepository,\n        OvertimeRequestRepositoryTrait,\n    },\n};\nuse tokio::sync::Mutex;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\n#[tokio::test]\nasync fn leave_request_repository_approve_roundtrip() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE leave_requests\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate leave_requests\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let admin = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let start = NaiveDate::from_ymd_opt(2024, 5, 1).unwrap();\n    let end = NaiveDate::from_ymd_opt(2024, 5, 2).unwrap();\n    let request = LeaveRequest::new(user.id, LeaveType::Annual, start, end, Some(\"trip\".into()));\n\n    let repo = LeaveRequestRepository::new();\n    let saved = repo\n        .create(\u0026pool, \u0026request)\n        .await\n        .expect(\"create leave request\");\n    assert_eq!(saved.user_id, user.id);\n    assert!(matches!(saved.status, RequestStatus::Pending));\n\n    let fetched = repo\n        .find_by_id_for_user(\u0026pool, saved.id, user.id)\n        .await\n        .expect(\"fetch leave request\");\n    assert!(fetched.is_some());\n\n    let now = Utc::now();\n    let updated = repo\n        .approve(\u0026pool, saved.id, admin.id, \"ok\", now)\n        .await\n        .expect(\"approve leave request\");\n    assert_eq!(updated, 1);\n\n    let approved = repo\n        .find_by_id(\u0026pool, saved.id)\n        .await\n        .expect(\"fetch approved request\");\n    assert!(matches!(approved.status, RequestStatus::Approved));\n    assert_eq!(approved.approved_by, Some(admin.id));\n}\n\n#[tokio::test]\nasync fn overtime_request_repository_reject_roundtrip() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    sqlx::query(\"TRUNCATE overtime_requests\")\n        .execute(\u0026pool)\n        .await\n        .expect(\"truncate overtime_requests\");\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let admin = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let date = NaiveDate::from_ymd_opt(2024, 6, 1).unwrap();\n    let request = OvertimeRequest::new(user.id, date, 2.5, Some(\"release\".into()));\n\n    let repo = OvertimeRequestRepository::new();\n    let saved = repo\n        .create(\u0026pool, \u0026request)\n        .await\n        .expect(\"create overtime request\");\n    assert_eq!(saved.user_id, user.id);\n    assert!(matches!(saved.status, RequestStatus::Pending));\n\n    let now = Utc::now();\n    let updated = repo\n        .reject(\u0026pool, saved.id, admin.id, \"busy\", now)\n        .await\n        .expect(\"reject overtime request\");\n    assert_eq!(updated, 1);\n\n    let rejected = repo\n        .find_by_id(\u0026pool, saved.id)\n        .await\n        .expect(\"fetch rejected request\");\n    assert!(matches!(rejected.status, RequestStatus::Rejected));\n    assert_eq!(rejected.rejected_by, Some(admin.id));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","requests_api.rs"],"content":"use timekeeper_backend::handlers::admin::RequestListQuery;\nuse timekeeper_backend::handlers::admin::{paginate_requests, AdminRequestListPageInfo};\n\n#[test]\nfn pagination_info_without_db() {\n    let page_info = AdminRequestListPageInfo {\n        page: 2,\n        per_page: 10,\n    };\n    assert_eq!(page_info.page, 2);\n    assert_eq!(page_info.per_page, 10);\n\n    let query = RequestListQuery {\n        status: None,\n        r#type: None,\n        user_id: None,\n        from: None,\n        to: None,\n        page: Some(3),\n        per_page: Some(15),\n    };\n    let (page, per_page, offset) = paginate_requests(\u0026query).expect(\"pagination ok\");\n    assert_eq!(page, 3);\n    assert_eq!(per_page, 15);\n    assert_eq!(offset, 30);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","session_api.rs"],"content":"use axum::{\n    body::Body,\n    http::{Request, StatusCode},\n    Extension, Router,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse timekeeper_backend::{\n    handlers::{sessions, admin::sessions as admin_sessions},\n    models::user::{User, UserRole},\n    state::AppState,\n    utils::jwt::{create_access_token, Claims},\n};\nuse tower::ServiceExt;\nuse std::sync::Arc;\nuse chrono::Utc;\n\nmod support;\n\nuse support::{\n    create_test_token, seed_user, seed_active_session, test_config, test_pool,\n};\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: std::sync::OnceLock\u003ctokio::sync::Mutex\u003c()\u003e\u003e = std::sync::OnceLock::new();\n    GUARD.get_or_init(|| tokio::sync::Mutex::new(())).lock().await\n}\n\nfn create_test_claims(user_id: timekeeper_backend::types::UserId, jti: \u0026str) -\u003e Claims {\n    Claims {\n        sub: user_id.to_string(),\n        username: \"testuser\".to_string(),\n        role: \"employee\".to_string(),\n        exp: Utc::now().timestamp() + 3600,\n        iat: Utc::now().timestamp(),\n        jti: jti.to_string(),\n    }\n}\n\nfn test_router_user_sessions(pool: PgPool, user: User, claims: Claims) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/sessions\", axum::routing::get(sessions::list_sessions))\n        .route(\"/api/sessions/{id}\", axum::routing::delete(sessions::revoke_session))\n        .layer(Extension(user))\n        .layer(Extension(claims))\n        .with_state(state)\n}\n\nfn test_router_admin_sessions(pool: PgPool, user: User, claims: Claims) -\u003e Router {\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/api/admin/users/{user_id}/sessions\", axum::routing::get(admin_sessions::list_user_sessions))\n        .route(\"/api/admin/sessions/{id}\", axum::routing::delete(admin_sessions::revoke_session))\n        .layer(Extension(user))\n        .layer(Extension(claims))\n        .with_state(state)\n}\n\n#[tokio::test]\nasync fn test_list_sessions_returns_user_sessions() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let refresh_token_id = uuid::Uuid::new_v4().to_string();\n    let access_jti = uuid::Uuid::new_v4().to_string();\n    seed_active_session(\u0026pool, employee.id, \u0026refresh_token_id, Some(\u0026access_jti)).await;\n    \n    let claims = create_test_claims(employee.id, \u0026access_jti);\n    let app = test_router_user_sessions(pool.clone(), employee.clone(), claims);\n    \n    let request = Request::builder()\n        .uri(\"/api/sessions\")\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee.id, employee.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json.as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_revoke_other_session_succeeds() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let refresh_token_id = uuid::Uuid::new_v4().to_string();\n    let access_jti = uuid::Uuid::new_v4().to_string();\n    seed_active_session(\u0026pool, employee.id, \u0026refresh_token_id, Some(\u0026access_jti)).await;\n    \n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(employee.id, \u0026current_jti);\n    let app = test_router_user_sessions(pool.clone(), employee.clone(), claims);\n    \n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/sessions/{}\", refresh_token_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee.id, employee.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_revoke_current_session_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let refresh_token_id = uuid::Uuid::new_v4().to_string();\n    let access_jti = uuid::Uuid::new_v4().to_string();\n    seed_active_session(\u0026pool, employee.id, \u0026refresh_token_id, Some(\u0026access_jti)).await;\n    \n    let claims = create_test_claims(employee.id, \u0026access_jti);\n    let app = test_router_user_sessions(pool.clone(), employee.clone(), claims);\n    \n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/sessions/{}\", refresh_token_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee.id, employee.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n\n#[tokio::test]\nasync fn test_revoke_other_user_session_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee1 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let employee2 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let refresh_token_id = uuid::Uuid::new_v4().to_string();\n    let access_jti = uuid::Uuid::new_v4().to_string();\n    seed_active_session(\u0026pool, employee2.id, \u0026refresh_token_id, Some(\u0026access_jti)).await;\n    \n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(employee1.id, \u0026current_jti);\n    let app = test_router_user_sessions(pool.clone(), employee1.clone(), claims);\n    \n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/sessions/{}\", refresh_token_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee1.id, employee1.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_revoke_nonexistent_session_returns_not_found() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(employee.id, \u0026current_jti);\n    let app = test_router_user_sessions(pool.clone(), employee.clone(), claims);\n    \n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/sessions/{}\", uuid::Uuid::new_v4()))\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee.id, employee.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::NOT_FOUND);\n}\n\n#[tokio::test]\nasync fn test_admin_can_list_user_sessions() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let refresh_token_id = uuid::Uuid::new_v4().to_string();\n    let access_jti = uuid::Uuid::new_v4().to_string();\n    seed_active_session(\u0026pool, employee.id, \u0026refresh_token_id, Some(\u0026access_jti)).await;\n    \n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(admin.id, \u0026current_jti);\n    let app = test_router_admin_sessions(pool.clone(), admin.clone(), claims);\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/admin/users/{}/sessions\", employee.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(admin.id, admin.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json.as_array().unwrap().len() \u003e 0);\n}\n\n#[tokio::test]\nasync fn test_admin_can_revoke_any_session() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let admin = seed_user(\u0026pool, UserRole::Admin, false).await;\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let refresh_token_id = uuid::Uuid::new_v4().to_string();\n    let access_jti = uuid::Uuid::new_v4().to_string();\n    seed_active_session(\u0026pool, employee.id, \u0026refresh_token_id, Some(\u0026access_jti)).await;\n    \n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(admin.id, \u0026current_jti);\n    let app = test_router_admin_sessions(pool.clone(), admin.clone(), claims);\n    \n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(format!(\"/api/admin/sessions/{}\", refresh_token_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(admin.id, admin.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_employee_cannot_list_other_user_sessions() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee1 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let employee2 = seed_user(\u0026pool, UserRole::Employee, false).await;\n    \n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(employee1.id, \u0026current_jti);\n    let app = test_router_admin_sessions(pool.clone(), employee1.clone(), claims);\n    \n    let request = Request::builder()\n        .uri(format!(\"/api/admin/users/{}/sessions\", employee2.id))\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee1.id, employee1.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_list_sessions_empty_when_no_sessions() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(employee.id, \u0026current_jti);\n    let app = test_router_user_sessions(pool.clone(), employee.clone(), claims);\n    \n    let request = Request::builder()\n        .uri(\"/api/sessions\")\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee.id, employee.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::OK);\n    \n    let body = axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap();\n    let json: serde_json::Value = serde_json::from_slice(\u0026body).unwrap();\n    assert!(json.as_array().unwrap().is_empty());\n}\n\n#[tokio::test]\nasync fn test_revoke_session_with_empty_id_fails() {\n    let _guard = integration_guard().await;\n    let pool = test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n\n    let employee = seed_user(\u0026pool, UserRole::Employee, false).await;\n    let current_jti = uuid::Uuid::new_v4().to_string();\n    let claims = create_test_claims(employee.id, \u0026current_jti);\n    let app = test_router_user_sessions(pool.clone(), employee.clone(), claims);\n    \n    let request = Request::builder()\n        .method(\"DELETE\")\n        .uri(\"/api/sessions/ \")\n        .header(\"Authorization\", format!(\"Bearer {}\", create_test_token(employee.id, employee.role.clone())))\n        .body(Body::empty())\n        .unwrap();\n    \n    let response = app.oneshot(request).await.unwrap();\n    assert_eq!(response.status(), StatusCode::BAD_REQUEST);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","subject_request_repo.rs"],"content":"use chrono::{Duration, Utc};\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    models::{\n        request::RequestStatus,\n        subject_request::{DataSubjectRequest, DataSubjectRequestType},\n        user::UserRole,\n    },\n    repositories::subject_request::{self, SubjectRequestFilters},\n};\nuse tokio::sync::Mutex;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\nasync fn reset_subject_requests(pool: \u0026sqlx::PgPool) {\n    sqlx::query(\"TRUNCATE subject_requests\")\n        .execute(pool)\n        .await\n        .expect(\"truncate subject_requests\");\n}\n\n#[tokio::test]\nasync fn subject_request_lists_for_user_in_descending_order() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_subject_requests(\u0026pool).await;\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let now = Utc::now();\n\n    let mut older = DataSubjectRequest::new(\n        user.id.to_string(),\n        DataSubjectRequestType::Access,\n        Some(\"old\".to_string()),\n        now - Duration::days(2),\n    );\n    older.created_at = now - Duration::days(2);\n    older.updated_at = older.created_at;\n\n    let mut newer = DataSubjectRequest::new(\n        user.id.to_string(),\n        DataSubjectRequestType::Delete,\n        Some(\"new\".to_string()),\n        now - Duration::days(1),\n    );\n    newer.created_at = now - Duration::days(1);\n    newer.updated_at = newer.created_at;\n\n    subject_request::insert_subject_request(\u0026pool, \u0026older)\n        .await\n        .expect(\"insert older request\");\n    subject_request::insert_subject_request(\u0026pool, \u0026newer)\n        .await\n        .expect(\"insert newer request\");\n\n    let user_id = user.id.to_string();\n    let items = subject_request::list_subject_requests_by_user(\u0026pool, \u0026user_id)\n        .await\n        .expect(\"list subject requests\");\n\n    assert_eq!(items.len(), 2);\n    assert_eq!(items[0].id, newer.id);\n    assert_eq!(items[1].id, older.id);\n}\n\n#[tokio::test]\nasync fn subject_request_filters_by_status_type_and_user() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_subject_requests(\u0026pool).await;\n\n    let user_one = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let user_two = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let now = Utc::now();\n\n    let mut req_one = DataSubjectRequest::new(\n        user_one.id.to_string(),\n        DataSubjectRequestType::Access,\n        None,\n        now - Duration::hours(2),\n    );\n    req_one.created_at = now - Duration::hours(2);\n    req_one.updated_at = req_one.created_at;\n\n    let mut req_two = DataSubjectRequest::new(\n        user_one.id.to_string(),\n        DataSubjectRequestType::Delete,\n        None,\n        now - Duration::hours(1),\n    );\n    req_two.status = RequestStatus::Approved;\n    req_two.created_at = now - Duration::hours(1);\n    req_two.updated_at = req_two.created_at;\n\n    let mut req_three = DataSubjectRequest::new(\n        user_two.id.to_string(),\n        DataSubjectRequestType::Delete,\n        None,\n        now,\n    );\n    req_three.status = RequestStatus::Approved;\n    req_three.created_at = now;\n    req_three.updated_at = req_three.created_at;\n\n    for req in [\u0026req_one, \u0026req_two, \u0026req_three] {\n        subject_request::insert_subject_request(\u0026pool, req)\n            .await\n            .expect(\"insert subject request\");\n    }\n\n    let filters = SubjectRequestFilters {\n        status: Some(RequestStatus::Approved),\n        request_type: Some(DataSubjectRequestType::Delete),\n        user_id: Some(user_one.id.to_string()),\n        from: None,\n        to: None,\n    };\n\n    let (items, total) = subject_request::list_subject_requests(\u0026pool, \u0026filters, 20, 0)\n        .await\n        .expect(\"list subject requests with filters\");\n\n    assert_eq!(total, 1);\n    assert_eq!(items.len(), 1);\n    assert_eq!(items[0].id, req_two.id);\n}\n\n#[tokio::test]\nasync fn subject_request_approve_and_reject_updates_status() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_subject_requests(\u0026pool).await;\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let admin = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let now = Utc::now();\n\n    let mut approve_request = DataSubjectRequest::new(\n        user.id.to_string(),\n        DataSubjectRequestType::Rectify,\n        Some(\"fix\".to_string()),\n        now,\n    );\n    approve_request.created_at = now - Duration::minutes(10);\n    approve_request.updated_at = approve_request.created_at;\n    subject_request::insert_subject_request(\u0026pool, \u0026approve_request)\n        .await\n        .expect(\"insert approval request\");\n\n    let admin_id = admin.id.to_string();\n    let rows =\n        subject_request::approve_subject_request(\u0026pool, \u0026approve_request.id, \u0026admin_id, \"ok\", now)\n            .await\n            .expect(\"approve request\");\n    assert_eq!(rows, 1);\n\n    let approved = subject_request::fetch_subject_request(\u0026pool, \u0026approve_request.id)\n        .await\n        .expect(\"fetch request\")\n        .expect(\"request exists\");\n    assert!(matches!(approved.status, RequestStatus::Approved));\n    assert_eq!(approved.approved_by.as_deref(), Some(admin_id.as_str()));\n    assert_eq!(approved.decision_comment.as_deref(), Some(\"ok\"));\n\n    let mut reject_request = DataSubjectRequest::new(\n        user.id.to_string(),\n        DataSubjectRequestType::Stop,\n        Some(\"stop\".to_string()),\n        now,\n    );\n    reject_request.created_at = now - Duration::minutes(5);\n    reject_request.updated_at = reject_request.created_at;\n    subject_request::insert_subject_request(\u0026pool, \u0026reject_request)\n        .await\n        .expect(\"insert reject request\");\n\n    let rows =\n        subject_request::reject_subject_request(\u0026pool, \u0026reject_request.id, \u0026admin_id, \"no\", now)\n            .await\n            .expect(\"reject request\");\n    assert_eq!(rows, 1);\n\n    let rejected = subject_request::fetch_subject_request(\u0026pool, \u0026reject_request.id)\n        .await\n        .expect(\"fetch request\")\n        .expect(\"request exists\");\n    assert!(matches!(rejected.status, RequestStatus::Rejected));\n    assert_eq!(rejected.rejected_by.as_deref(), Some(admin_id.as_str()));\n    assert_eq!(rejected.decision_comment.as_deref(), Some(\"no\"));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","subject_requests_api.rs"],"content":"use axum::{\n    body::{to_bytes, Body},\n    http::{Request, StatusCode},\n    routing::{delete, get, post, put},\n    Extension, Router,\n};\nuse chrono::Utc;\nuse serde::Deserialize;\nuse serde_json::json;\nuse sqlx::PgPool;\nuse std::sync::OnceLock;\nuse timekeeper_backend::{\n    handlers::{admin, subject_requests},\n    models::{\n        request::RequestStatus,\n        subject_request::{DataSubjectRequest, DataSubjectRequestResponse, DataSubjectRequestType},\n        user::UserRole,\n    },\n    repositories::subject_request,\n    state::AppState,\n};\nuse tokio::sync::Mutex;\nuse tower::ServiceExt;\n\n#[path = \"support/mod.rs\"]\nmod support;\n\nasync fn integration_guard() -\u003e tokio::sync::MutexGuard\u003c'static, ()\u003e {\n    static GUARD: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n    GUARD.get_or_init(|| Mutex::new(())).lock().await\n}\n\nasync fn reset_subject_requests(pool: \u0026PgPool) {\n    sqlx::query(\"TRUNCATE subject_requests\")\n        .execute(pool)\n        .await\n        .expect(\"truncate subject_requests\");\n}\n\n#[derive(Deserialize)]\nstruct AdminListResponse {\n    total: i64,\n    items: Vec\u003cDataSubjectRequestResponse\u003e,\n}\n\n#[tokio::test]\nasync fn create_and_list_subject_requests_for_user() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_subject_requests(\u0026pool).await;\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n\n    let app = Router::new()\n        .route(\n            \"/api/subject-requests\",\n            post(subject_requests::create_subject_request),\n        )\n        .route(\n            \"/api/subject-requests/me\",\n            get(subject_requests::list_my_subject_requests),\n        )\n        .layer(Extension(user.clone()))\n        .with_state(state);\n\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/api/subject-requests\")\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(\n                    json!({\n                        \"request_type\": \"access\",\n                        \"details\": \"please export\"\n                    })\n                    .to_string(),\n                ))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let created: DataSubjectRequestResponse =\n        serde_json::from_slice(\u0026body).expect(\"parse response\");\n    assert_eq!(created.user_id, user.id.to_string());\n    assert!(matches!(\n        created.request_type,\n        DataSubjectRequestType::Access\n    ));\n    assert!(matches!(created.status, RequestStatus::Pending));\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .uri(\"/api/subject-requests/me\")\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let list: Vec\u003cDataSubjectRequestResponse\u003e = serde_json::from_slice(\u0026body).expect(\"parse list\");\n    assert_eq!(list.len(), 1);\n    assert_eq!(list[0].id, created.id);\n}\n\n#[tokio::test]\nasync fn cancel_subject_request_marks_status() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_subject_requests(\u0026pool).await;\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n    let now = Utc::now();\n\n    let request = DataSubjectRequest::new(\n        user.id.to_string(),\n        DataSubjectRequestType::Delete,\n        Some(\"delete\".to_string()),\n        now,\n    );\n    subject_request::insert_subject_request(\u0026pool, \u0026request)\n        .await\n        .expect(\"insert request\");\n\n    let app = Router::new()\n        .route(\n            \"/api/subject-requests/{id}\",\n            delete(subject_requests::cancel_subject_request),\n        )\n        .layer(Extension(user))\n        .with_state(state);\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .method(\"DELETE\")\n                .uri(format!(\"/api/subject-requests/{}\", request.id))\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let updated = subject_request::fetch_subject_request(\u0026pool, \u0026request.id)\n        .await\n        .expect(\"fetch request\")\n        .expect(\"request exists\");\n    assert!(matches!(updated.status, RequestStatus::Cancelled));\n    assert!(updated.cancelled_at.is_some());\n}\n\n#[tokio::test]\nasync fn admin_can_list_and_decide_subject_requests() {\n    let _guard = integration_guard().await;\n    let pool = support::test_pool().await;\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026pool)\n        .await\n        .expect(\"run migrations\");\n    reset_subject_requests(\u0026pool).await;\n\n    let user = support::seed_user(\u0026pool, UserRole::Employee, false).await;\n    let admin_user = support::seed_user(\u0026pool, UserRole::Admin, false).await;\n    let state = AppState::new(pool.clone(), None, None, None, support::test_config());\n    let now = Utc::now();\n\n    let pending = DataSubjectRequest::new(\n        user.id.to_string(),\n        DataSubjectRequestType::Access,\n        None,\n        now,\n    );\n    subject_request::insert_subject_request(\u0026pool, \u0026pending)\n        .await\n        .expect(\"insert request\");\n\n    let admin_id = admin_user.id.to_string();\n\n    let app = Router::new()\n        .route(\n            \"/api/admin/subject-requests\",\n            get(admin::list_subject_requests),\n        )\n        .route(\n            \"/api/admin/subject-requests/{id}/approve\",\n            put(admin::approve_subject_request),\n        )\n        .route(\n            \"/api/admin/subject-requests/{id}/reject\",\n            put(admin::reject_subject_request),\n        )\n        .layer(Extension(admin_user.clone()))\n        .with_state(state);\n\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/api/admin/subject-requests?status=pending\")\n                .body(Body::empty())\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n    let body = to_bytes(response.into_body(), 1024 * 64)\n        .await\n        .expect(\"read body\");\n    let list: AdminListResponse = serde_json::from_slice(\u0026body).expect(\"parse list\");\n    assert_eq!(list.total, 1);\n    assert_eq!(list.items.len(), 1);\n    assert_eq!(list.items[0].id, pending.id);\n\n    let response = app\n        .clone()\n        .oneshot(\n            Request::builder()\n                .method(\"PUT\")\n                .uri(format!(\n                    \"/api/admin/subject-requests/{}/approve\",\n                    pending.id\n                ))\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(json!({\"comment\": \"ok\"}).to_string()))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let updated = subject_request::fetch_subject_request(\u0026pool, \u0026pending.id)\n        .await\n        .expect(\"fetch request\")\n        .expect(\"request exists\");\n    assert!(matches!(updated.status, RequestStatus::Approved));\n    assert_eq!(updated.approved_by.as_deref(), Some(admin_id.as_str()));\n\n    let rejected_request =\n        DataSubjectRequest::new(user.id.to_string(), DataSubjectRequestType::Stop, None, now);\n    subject_request::insert_subject_request(\u0026pool, \u0026rejected_request)\n        .await\n        .expect(\"insert request\");\n\n    let response = app\n        .oneshot(\n            Request::builder()\n                .method(\"PUT\")\n                .uri(format!(\n                    \"/api/admin/subject-requests/{}/reject\",\n                    rejected_request.id\n                ))\n                .header(\"content-type\", \"application/json\")\n                .body(Body::from(json!({\"comment\": \"no\"}).to_string()))\n                .expect(\"build request\"),\n        )\n        .await\n        .expect(\"call app\");\n\n    assert_eq!(response.status(), StatusCode::OK);\n\n    let updated = subject_request::fetch_subject_request(\u0026pool, \u0026rejected_request.id)\n        .await\n        .expect(\"fetch request\")\n        .expect(\"request exists\");\n    assert!(matches!(updated.status, RequestStatus::Rejected));\n    assert_eq!(updated.rejected_by.as_deref(), Some(admin_id.as_str()));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","support","mod.rs"],"content":"#![allow(dead_code)]\nuse chrono::{Datelike, Duration as ChronoDuration, NaiveDate, NaiveDateTime};\nuse chrono_tz::Asia::Tokyo;\nuse ctor::{ctor, dtor};\nuse sqlx::{postgres::PgPoolOptions, PgPool};\nuse std::{\n    env, fs,\n    net::TcpListener,\n    path::Path,\n    path::PathBuf,\n    process::Command,\n    sync::{Mutex, OnceLock},\n    time::Duration as StdDuration,\n};\nuse testcontainers::{clients::Cli, core::WaitFor, Container, GenericImage, RunnableImage};\nuse timekeeper_backend::{\n    config::Config,\n    models::user::{User, UserRole},\n    models::{\n        holiday::Holiday,\n        leave_request::{LeaveRequest, LeaveType},\n        overtime_request::OvertimeRequest,\n    },\n    state::AppState,\n    types::{HolidayExceptionId, UserId, WeeklyHolidayId},\n    utils::{cookies::SameSite, password::hash_password},\n};\nuse uuid::Uuid;\n\nstatic TESTCONTAINERS_DOCKER: OnceLock\u003c\u0026'static Cli\u003e = OnceLock::new();\nstatic TESTCONTAINERS_PG: OnceLock\u003cMutex\u003cOption\u003cContainer\u003c'static, GenericImage\u003e\u003e\u003e\u003e =\n    OnceLock::new();\nstatic TESTCONTAINERS_DB_URL: OnceLock\u003cString\u003e = OnceLock::new();\nstatic DOCKER_WRAPPER_DIR: OnceLock\u003cPathBuf\u003e = OnceLock::new();\nstatic ENV_MUTEX: OnceLock\u003cMutex\u003c()\u003e\u003e = OnceLock::new();\n\n#[ctor]\nfn init_test_database_url() {\n    if env::var(\"TEST_DATABASE_URL\").is_ok() {\n        return;\n    }\n\n    let url = start_testcontainer_postgres();\n    env::set_var(\"TEST_DATABASE_URL\", url);\n}\n\nfn env_guard() -\u003e std::sync::MutexGuard\u003c'static, ()\u003e {\n    ENV_MUTEX\n        .get_or_init(|| Mutex::new(()))\n        .lock()\n        .expect(\"lock env\")\n}\n\nfn start_testcontainer_postgres() -\u003e String {\n    let url = TESTCONTAINERS_DB_URL.get().cloned().unwrap_or_else(|| {\n        ensure_docker_cli();\n        let docker = TESTCONTAINERS_DOCKER.get_or_init(|| Box::leak(Box::new(Cli::default())));\n        let image_ref = env::var(\"TESTCONTAINERS_POSTGRES_IMAGE\")\n            .unwrap_or_else(|_| \"postgres:15-alpine\".to_string());\n        let (image_name, image_tag) = image_ref\n            .split_once(':')\n            .unwrap_or((image_ref.as_str(), \"latest\"));\n        let host_port = allocate_ephemeral_port();\n        let image = GenericImage::new(image_name, image_tag)\n            .with_env_var(\"POSTGRES_USER\", \"timekeeper_test\")\n            .with_env_var(\"POSTGRES_PASSWORD\", \"timekeeper_test\")\n            .with_env_var(\"POSTGRES_DB\", \"postgres\")\n            .with_wait_for(WaitFor::message_on_stdout(\n                \"database system is ready to accept connections\",\n            ));\n        let image = RunnableImage::from(image).with_mapped_port((host_port, 5432));\n        let container = docker.run(image);\n        let holder = TESTCONTAINERS_PG.get_or_init(|| Mutex::new(None));\n        let mut guard = holder.lock().expect(\"lock testcontainers postgres\");\n        *guard = Some(container);\n        let url = format!(\n            \"postgres://timekeeper_test:timekeeper_test@127.0.0.1:{}/postgres\",\n            host_port\n        );\n        eprintln!(\"--- Testcontainers Postgres started at {} ---\", url);\n        TESTCONTAINERS_DB_URL\n            .set(url.clone())\n            .expect(\"set test database url\");\n        url\n    });\n    env::set_var(\"DATABASE_URL\", url.clone());\n    env::set_var(\"TEST_DATABASE_URL\", url.clone());\n    url\n}\n\n#[dtor]\nfn shutdown_testcontainer_postgres() {\n    if let Some(holder) = TESTCONTAINERS_PG.get() {\n        if let Ok(mut guard) = holder.lock() {\n            let _ = guard.take();\n        }\n    }\n}\n\nfn allocate_ephemeral_port() -\u003e u16 {\n    TcpListener::bind(\"127.0.0.1:0\")\n        .expect(\"bind ephemeral port\")\n        .local_addr()\n        .expect(\"read socket addr\")\n        .port()\n}\n\nfn ensure_docker_cli() {\n    if env::var(\"DOCKER_HOST\").is_err() {\n        let podman_socket = Path::new(\"/run/podman/podman.sock\");\n        if podman_socket.exists() {\n            env::set_var(\"DOCKER_HOST\", \"unix:///run/podman/podman.sock\");\n        } else if let Ok(runtime_dir) = env::var(\"XDG_RUNTIME_DIR\") {\n            let path = Path::new(\u0026runtime_dir).join(\"podman/podman.sock\");\n            if path.exists() {\n                if let Some(path_str) = path.to_str() {\n                    env::set_var(\"DOCKER_HOST\", format!(\"unix://{}\", path_str));\n                }\n            }\n        }\n    }\n    if Command::new(\"docker\").arg(\"--version\").output().is_ok() {\n        return;\n    }\n    if Command::new(\"podman\").arg(\"--version\").output().is_err() {\n        return;\n    }\n    let dir = DOCKER_WRAPPER_DIR.get_or_init(|| {\n        let dir = env::temp_dir().join(\"timekeeper-testcontainers-docker\");\n        let _ = fs::create_dir_all(\u0026dir);\n        dir\n    });\n    let docker_path = dir.join(\"docker\");\n    if !docker_path.exists() {\n        let script = \"#!/usr/bin/env sh\\nexec podman \\\"$@\\\"\\n\";\n        let _ = fs::write(\u0026docker_path, script);\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            if let Ok(metadata) = fs::metadata(\u0026docker_path) {\n                let mut perms = metadata.permissions();\n                perms.set_mode(0o755);\n                let _ = fs::set_permissions(\u0026docker_path, perms);\n            }\n        }\n    }\n    let path = env::var(\"PATH\").unwrap_or_default();\n    let new_path = format!(\"{}:{}\", dir.display(), path);\n    env::set_var(\"PATH\", new_path);\n}\n\npub fn test_config() -\u003e Config {\n    let database_url = test_database_url();\n\n    Config {\n        database_url,\n        read_database_url: None,\n        jwt_secret: \"a_secure_token_that_is_long_enough_123\".into(),\n        jwt_expiration_hours: 1,\n        refresh_token_expiration_days: 7,\n        max_concurrent_sessions: 3,\n        audit_log_retention_days: 1825,\n        audit_log_retention_forever: false,\n        consent_log_retention_days: 1825,\n        consent_log_retention_forever: false,\n        aws_region: \"ap-northeast-1\".into(),\n        aws_kms_key_id: \"alias/timekeeper-test\".into(),\n        aws_audit_log_bucket: \"timekeeper-audit-logs\".into(),\n        aws_cloudtrail_enabled: true,\n        cookie_secure: false,\n        cookie_same_site: SameSite::Lax,\n        cors_allow_origins: vec![\"http://localhost:8000\".into()],\n        time_zone: Tokyo,\n        mfa_issuer: \"Timekeeper\".into(),\n        rate_limit_ip_max_requests: 15,\n        rate_limit_ip_window_seconds: 900,\n        rate_limit_user_max_requests: 20,\n        rate_limit_user_window_seconds: 3600,\n        redis_url: None,\n        redis_pool_size: 10,\n        redis_connect_timeout: 5,\n        feature_redis_cache_enabled: true,\n        feature_read_replica_enabled: true,\n        password_min_length: 12,\n        password_require_uppercase: true,\n        password_require_lowercase: true,\n        password_require_numbers: true,\n        password_require_symbols: true,\n        password_expiration_days: 90,\n        password_history_count: 5,\n        production_mode: false,\n    }\n}\n\npub async fn test_pool() -\u003e PgPool {\n    let database_url = test_database_url();\n    let mut retry_count = 0;\n    let max_retries = 3;\n\n    loop {\n        match PgPoolOptions::new()\n            .max_connections(5)\n            .acquire_timeout(StdDuration::from_secs(30))\n            .connect(\u0026database_url)\n            .await\n        {\n            Ok(pool) =\u003e return pool,\n            Err(e) if retry_count \u003c max_retries =\u003e {\n                retry_count += 1;\n                eprintln!(\n                    \"Retrying DB connection (attempt {}/{}): {}\",\n                    retry_count, max_retries, e\n                );\n                tokio::time::sleep(StdDuration::from_secs(2)).await;\n            }\n            Err(e) =\u003e panic!(\n                \"Failed to connect to test database after {} retries: {}\",\n                max_retries, e\n            ),\n        }\n    }\n}\n\nfn test_database_url() -\u003e String {\n    let _guard = ENV_MUTEX.get_or_init(|| Mutex::new(())).try_lock().ok();\n    env::var(\"TEST_DATABASE_URL\")\n        .or_else(|_| env::var(\"DATABASE_URL\"))\n        .unwrap_or_else(|_| start_testcontainer_postgres())\n}\n\nasync fn insert_user_with_password_hash(\n    pool: \u0026PgPool,\n    role: UserRole,\n    is_system_admin: bool,\n    password_hash: String,\n) -\u003e User {\n    let user = User::new(\n        format!(\"user_{}\", Uuid::new_v4()),\n        password_hash,\n        \"Test User\".into(),\n        format!(\"user_{}@example.com\", Uuid::new_v4()),\n        role,\n        is_system_admin,\n    );\n    sqlx::query(\n        \"INSERT INTO users (id, username, password_hash, full_name, email, role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)\",\n    )\n    .bind(user.id.to_string())\n    .bind(\u0026user.username)\n    .bind(\u0026user.password_hash)\n    .bind(\u0026user.full_name)\n    .bind(\u0026user.email)\n    .bind(user.role.as_str())\n    .bind(user.is_system_admin)\n    .bind(\u0026user.mfa_secret)\n    .bind(user.mfa_enabled_at)\n    .bind(user.password_changed_at)\n    .bind(user.created_at)\n    .bind(user.updated_at)\n    .execute(pool)\n    .await\n    .expect(\"insert user\");\n\n    user\n}\n\npub async fn seed_user(pool: \u0026PgPool, role: UserRole, is_system_admin: bool) -\u003e User {\n    insert_user_with_password_hash(pool, role, is_system_admin, \"hash\".into()).await\n}\n\npub async fn seed_user_with_password(\n    pool: \u0026PgPool,\n    role: UserRole,\n    is_system_admin: bool,\n    password: \u0026str,\n) -\u003e User {\n    let password_hash = hash_password(password).expect(\"hash password\");\n    insert_user_with_password_hash(pool, role, is_system_admin, password_hash).await\n}\n\npub async fn grant_permission(pool: \u0026PgPool, user_id: \u0026str, permission: \u0026str) {\n    sqlx::query(\n        \"INSERT INTO user_permissions (user_id, permission_name) VALUES ($1, $2) \\\n         ON CONFLICT (user_id, permission_name) DO NOTHING\",\n    )\n    .bind(user_id)\n    .bind(permission)\n    .execute(pool)\n    .await\n    .expect(\"grant permission\");\n}\n\npub async fn seed_weekly_holiday(pool: \u0026PgPool, date: NaiveDate) {\n    let weekday = date.weekday().num_days_from_monday() as i16;\n    sqlx::query(\n        \"INSERT INTO weekly_holidays \\\n            (id, weekday, starts_on, ends_on, enforced_from, enforced_to, created_by, created_at, updated_at) \\\n         VALUES ($1, $2, $3, NULL, $4, NULL, $5, NOW(), NOW())\",\n    )\n    .bind(WeeklyHolidayId::new().to_string())\n    .bind(weekday)\n    .bind(date - ChronoDuration::days(7))\n    .bind(date)\n    .bind(UserId::new().to_string())\n    .execute(pool)\n    .await\n    .expect(\"insert weekly holiday\");\n}\n\npub async fn seed_leave_request(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    leave_type: LeaveType,\n    start_date: NaiveDate,\n    end_date: NaiveDate,\n) -\u003e LeaveRequest {\n    let request = LeaveRequest::new(\n        user_id,\n        leave_type,\n        start_date,\n        end_date,\n        Some(\"test\".into()),\n    );\n    sqlx::query(\n        \"INSERT INTO leave_requests (id, user_id, leave_type, start_date, end_date, reason, status, approved_by, approved_at, decision_comment, rejected_by, rejected_at, cancelled_at, created_at, updated_at) \\\n         VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15)\",\n    )\n    .bind(request.id.to_string())\n    .bind(request.user_id.to_string())\n    .bind(match request.leave_type {\n        LeaveType::Annual =\u003e \"annual\",\n        LeaveType::Sick =\u003e \"sick\",\n        LeaveType::Personal =\u003e \"personal\",\n        LeaveType::Other =\u003e \"other\",\n    })\n    .bind(request.start_date)\n    .bind(request.end_date)\n    .bind(\u0026request.reason)\n    .bind(match request.status {\n        timekeeper_backend::models::leave_request::RequestStatus::Pending =\u003e \"pending\",\n        timekeeper_backend::models::leave_request::RequestStatus::Approved =\u003e \"approved\",\n        timekeeper_backend::models::leave_request::RequestStatus::Rejected =\u003e \"rejected\",\n        timekeeper_backend::models::leave_request::RequestStatus::Cancelled =\u003e \"cancelled\",\n    })\n    .bind(request.approved_by.map(|id| id.to_string()))\n    .bind(request.approved_at)\n    .bind(\u0026request.decision_comment)\n    .bind(request.rejected_by.map(|id| id.to_string()))\n    .bind(request.rejected_at)\n    .bind(request.cancelled_at)\n    .bind(request.created_at)\n    .bind(request.updated_at)\n    .execute(pool)\n    .await\n    .expect(\"insert leave request\");\n    request\n}\n\npub async fn seed_overtime_request(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    date: NaiveDate,\n    planned_hours: f64,\n) -\u003e OvertimeRequest {\n    let request = OvertimeRequest::new(user_id, date, planned_hours, Some(\"test OT\".into()));\n    sqlx::query(\n        \"INSERT INTO overtime_requests (id, user_id, date, planned_hours, reason, status, approved_by, approved_at, decision_comment, rejected_by, rejected_at, cancelled_at, created_at, updated_at) \\\n         VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14)\",\n    )\n    .bind(request.id.to_string())\n    .bind(request.user_id.to_string())\n    .bind(request.date)\n    .bind(request.planned_hours)\n    .bind(\u0026request.reason)\n    .bind(match request.status {\n        timekeeper_backend::models::overtime_request::RequestStatus::Pending =\u003e \"pending\",\n        timekeeper_backend::models::overtime_request::RequestStatus::Approved =\u003e \"approved\",\n        timekeeper_backend::models::overtime_request::RequestStatus::Rejected =\u003e \"rejected\",\n        timekeeper_backend::models::overtime_request::RequestStatus::Cancelled =\u003e \"cancelled\",\n    })\n    .bind(request.approved_by.map(|id| id.to_string()))\n    .bind(request.approved_at)\n    .bind(\u0026request.decision_comment)\n    .bind(request.rejected_by.map(|id| id.to_string()))\n    .bind(request.rejected_at)\n    .bind(request.cancelled_at)\n    .bind(request.created_at)\n    .bind(request.updated_at)\n    .execute(pool)\n    .await\n    .expect(\"insert overtime request\");\n    request\n}\n\npub async fn seed_public_holiday(pool: \u0026PgPool, date: NaiveDate, name: \u0026str) -\u003e Holiday {\n    let holiday = Holiday::new(date, name.to_string(), None);\n    sqlx::query(\n        \"INSERT INTO holidays (id, holiday_date, name, description, created_at, updated_at) \\\n         VALUES ($1, $2, $3, $4, $5, $6)\",\n    )\n    .bind(holiday.id.to_string())\n    .bind(holiday.holiday_date)\n    .bind(\u0026holiday.name)\n    .bind(\u0026holiday.description)\n    .bind(holiday.created_at)\n    .bind(holiday.updated_at)\n    .execute(pool)\n    .await\n    .expect(\"insert holiday\");\n    holiday\n}\n\npub async fn seed_holiday_exception(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    date: NaiveDate,\n    override_value: bool,\n    reason: \u0026str,\n) {\n    sqlx::query(\n        \"INSERT INTO holiday_exceptions \\\n            (id, user_id, exception_date, override, reason, created_by, created_at, updated_at) \\\n         VALUES ($1, $2, $3, $4, $5, $6, NOW(), NOW())\",\n    )\n    .bind(HolidayExceptionId::new().to_string())\n    .bind(user_id.to_string())\n    .bind(date)\n    .bind(override_value)\n    .bind(reason)\n    .bind(UserId::new().to_string())\n    .execute(pool)\n    .await\n    .expect(\"insert holiday exception\");\n}\n\npub async fn seed_attendance(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    date: NaiveDate,\n    clock_in: Option\u003cNaiveDateTime\u003e,\n    clock_out: Option\u003cNaiveDateTime\u003e,\n) -\u003e timekeeper_backend::models::attendance::Attendance {\n    use chrono::Utc;\n    use timekeeper_backend::models::attendance::{Attendance, AttendanceStatus};\n    use timekeeper_backend::repositories::attendance::AttendanceRepository;\n    use timekeeper_backend::repositories::attendance::AttendanceRepositoryTrait;\n\n    let now = Utc::now();\n    let attendance = Attendance {\n        id: timekeeper_backend::types::AttendanceId::new(),\n        user_id,\n        date,\n        clock_in_time: clock_in,\n        clock_out_time: clock_out,\n        status: AttendanceStatus::Present,\n        total_work_hours: None,\n        created_at: now,\n        updated_at: now,\n    };\n\n    let repo = AttendanceRepository::new();\n    repo.create(pool, \u0026attendance).await.expect(\"create attendance\")\n}\n\npub async fn seed_break_record(\n    pool: \u0026PgPool,\n    attendance_id: timekeeper_backend::types::AttendanceId,\n    start_time: NaiveDateTime,\n    end_time: Option\u003cNaiveDateTime\u003e,\n) -\u003e timekeeper_backend::models::break_record::BreakRecord {\n    use chrono::Utc;\n    use timekeeper_backend::models::break_record::BreakRecord;\n    use timekeeper_backend::repositories::break_record::BreakRecordRepository;\n    use timekeeper_backend::repositories::repository::Repository;\n\n    let now = Utc::now();\n    let duration_minutes = end_time.map(|end| (end - start_time).num_minutes() as i32);\n    let break_record = BreakRecord {\n        id: timekeeper_backend::types::BreakRecordId::new(),\n        attendance_id,\n        break_start_time: start_time,\n        break_end_time: end_time,\n        duration_minutes,\n        created_at: now,\n        updated_at: now,\n    };\n\n    let repo = BreakRecordRepository::new();\n    repo.create(pool, \u0026break_record).await.expect(\"create break record\")\n}\n\npub async fn seed_audit_log(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    action: \u0026str,\n    resource: \u0026str,\n) {\n    use sqlx::types::Json;\n\n    let id = timekeeper_backend::types::AuditLogId::new();\n    let now = chrono::Utc::now();\n    let metadata = Json(serde_json::json!({\"test\": true}));\n    sqlx::query(\n        \"INSERT INTO audit_logs \\\n            (id, occurred_at, actor_id, actor_type, event_type, target_type, target_id, result, error_code, metadata, ip, user_agent, request_id) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)\",\n    )\n    .bind(id.to_string())\n    .bind(now)\n    .bind(Some(user_id))\n    .bind(\"user\")\n    .bind(action)\n    .bind(Some(resource.to_string()))\n    .bind(Some(\"test-resource-id\".to_string()))\n    .bind(\"success\")\n    .bind(None::\u003cString\u003e)\n    .bind(metadata)\n    .bind(Some(\"127.0.0.1\".to_string()))\n    .bind(Some(\"test-agent\".to_string()))\n    .bind(Some(\"req-test\".to_string()))\n    .execute(pool)\n    .await\n    .expect(\"insert audit log\");\n}\n\npub async fn seed_consent_log(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    purpose: \u0026str,\n    policy_version: \u0026str,\n) {\n    use chrono::Utc;\n\n    let id = uuid::Uuid::new_v4().to_string();\n    let now = Utc::now();\n    sqlx::query(\n        \"INSERT INTO consent_logs \\\n            (id, user_id, purpose, policy_version, consented_at, ip, user_agent, request_id, created_at) \\\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\",\n    )\n    .bind(id)\n    .bind(user_id.to_string())\n    .bind(purpose)\n    .bind(policy_version)\n    .bind(now)\n    .bind(Some(\"127.0.0.1\".to_string()))\n    .bind(Some(\"test-agent\".to_string()))\n    .bind(None::\u003cString\u003e)\n    .bind(now)\n    .execute(pool)\n    .await\n    .expect(\"insert consent log\");\n}\n\npub async fn seed_active_session(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    refresh_token_id: \u0026str,\n    access_jti: Option\u003c\u0026str\u003e,\n) {\n    use chrono::{Duration, Utc};\n\n    let id = uuid::Uuid::new_v4().to_string();\n    let expires_at = Utc::now() + Duration::hours(1);\n    \n    sqlx::query(\n        \"INSERT INTO active_sessions \\\n            (id, user_id, refresh_token_id, access_jti, device_label, created_at, last_seen_at, expires_at) \\\n         VALUES ($1, $2, $3, $4, $5, NOW(), $6, $7)\",\n    )\n    .bind(id)\n    .bind(user_id.to_string())\n    .bind(refresh_token_id)\n    .bind(access_jti)\n    .bind(Some(\"test-device\".to_string()))\n    .bind(None::\u003cchrono::DateTime\u003cchrono::Utc\u003e\u003e)\n    .bind(expires_at)\n    .execute(pool)\n    .await\n    .expect(\"insert active session\");\n}\n\npub async fn seed_subject_request(\n    pool: \u0026PgPool,\n    user_id: UserId,\n    request_type: \u0026str,\n    status: \u0026str,\n) -\u003e timekeeper_backend::models::subject_request::DataSubjectRequest {\n    use chrono::Utc;\n    use timekeeper_backend::models::request::RequestStatus;\n    use timekeeper_backend::models::subject_request::{DataSubjectRequest, DataSubjectRequestType};\n    use timekeeper_backend::repositories::subject_request::insert_subject_request;\n\n    let now = Utc::now();\n    let request_type = match request_type {\n        \"access\" =\u003e DataSubjectRequestType::Access,\n        \"rectify\" =\u003e DataSubjectRequestType::Rectify,\n        \"delete\" =\u003e DataSubjectRequestType::Delete,\n        \"stop\" =\u003e DataSubjectRequestType::Stop,\n        other =\u003e panic!(\"invalid request type: {other}\"),\n    };\n    let status = match status {\n        \"pending\" =\u003e RequestStatus::Pending,\n        \"approved\" =\u003e RequestStatus::Approved,\n        \"rejected\" =\u003e RequestStatus::Rejected,\n        \"cancelled\" =\u003e RequestStatus::Cancelled,\n        other =\u003e panic!(\"invalid status: {other}\"),\n    };\n    let mut request = DataSubjectRequest::new(\n        user_id.to_string(),\n        request_type,\n        Some(\"Test subject request\".to_string()),\n        now,\n    );\n    request.status = status;\n\n    insert_subject_request(pool, \u0026request)\n        .await\n        .expect(\"create subject request\");\n    request\n}\n\nuse axum::{\n    body::Body,\n    extract::Request,\n    http::{header, StatusCode},\n    response::Response,\n    Extension, Router,\n};\nuse tower::ServiceExt;\n\npub fn test_router_with_user\u003cF\u003e(\n    handler: F,\n    user: timekeeper_backend::models::user::User,\n    pool: PgPool,\n) -\u003e Router\u003cAppState\u003e\nwhere\n    F: axum::handler::Handler\u003c(), AppState\u003e,\n{\n    let state = AppState::new(pool, None, None, None, test_config());\n    Router::new()\n        .route(\"/\", axum::routing::any(handler))\n        .layer(Extension(user))\n        .with_state(state)\n}\n\npub fn create_test_token(user_id: UserId, role: UserRole) -\u003e String {\n    use timekeeper_backend::utils::jwt::create_access_token;\n    \n    let username = \"testuser\".to_string();\n    let role_str = format!(\"{:?}\", role);\n    let secret = test_config().jwt_secret;\n    let (token, _claims) = create_access_token(\n        user_id.to_string(),\n        username,\n        role_str,\n        \u0026secret,\n        1,\n    )\n    .expect(\"create test token\");\n    \n    token\n}\n\npub fn build_auth_request(method: \u0026str, uri: \u0026str, token: \u0026str, body: Option\u003cBody\u003e) -\u003e Request\u003cBody\u003e {\n    let builder = Request::builder()\n        .method(method)\n        .uri(uri)\n        .header(header::AUTHORIZATION, format!(\"Bearer {}\", token));\n    \n    match body {\n        Some(b) =\u003e builder.body(b).expect(\"build request with body\"),\n        None =\u003e builder.body(Body::empty()).expect(\"build request\"),\n    }\n}\n\npub fn build_json_request(method: \u0026str, uri: \u0026str, token: \u0026str, json_body: serde_json::Value) -\u003e Request\u003cBody\u003e {\n    let body = Body::from(json_body.to_string());\n    Request::builder()\n        .method(method)\n        .uri(uri)\n        .header(header::AUTHORIZATION, format!(\"Bearer {}\", token))\n        .header(header::CONTENT_TYPE, \"application/json\")\n        .body(body)\n        .expect(\"build json request\")\n}\n\npub async fn response_json(response: Response) -\u003e serde_json::Value {\n    let body = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"read body bytes\");\n    serde_json::from_slice(\u0026body).expect(\"parse json\")\n}\n\npub fn assert_status(response: \u0026Response, expected: StatusCode) {\n    assert_eq!(\n        response.status(),\n        expected,\n        \"Expected status {:?}, got {:?}\",\n        expected,\n        response.status()\n    );\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    fn restore_env(original: (Option\u003cString\u003e, Option\u003cString\u003e)) {\n        match original.0 {\n            Some(value) =\u003e env::set_var(\"TEST_DATABASE_URL\", value),\n            None =\u003e env::remove_var(\"TEST_DATABASE_URL\"),\n        }\n        match original.1 {\n            Some(value) =\u003e env::set_var(\"DATABASE_URL\", value),\n            None =\u003e env::remove_var(\"DATABASE_URL\"),\n        }\n    }\n\n    #[test]\n    fn test_config_uses_database_url_from_env() {\n        if env::var(\"TEST_DATABASE_URL\").is_ok() {\n            return;\n        }\n        let _guard = env_guard();\n        let original = (\n            env::var(\"TEST_DATABASE_URL\").ok(),\n            env::var(\"DATABASE_URL\").ok(),\n        );\n        env::set_var(\"TEST_DATABASE_URL\", \"postgres://override/testdb\");\n\n        let config = test_config();\n\n        assert_eq!(config.database_url, \"postgres://override/testdb\");\n        restore_env(original);\n    }\n\n    #[test]\n    fn test_config_falls_back_to_default_when_env_missing() {\n        if env::var(\"TEST_DATABASE_URL\").is_ok() {\n            return;\n        }\n        let _guard = env_guard();\n        let original = (\n            env::var(\"TEST_DATABASE_URL\").ok(),\n            env::var(\"DATABASE_URL\").ok(),\n        );\n        env::remove_var(\"TEST_DATABASE_URL\");\n\n        let config = test_config();\n        let expected = env::var(\"DATABASE_URL\").expect(\"database url set\");\n\n        assert_eq!(config.database_url, expected);\n        restore_env(original);\n    }\n}\n","traces":[{"line":642,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":643,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":644,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":645,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":646,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":5},{"path":["/","home","marra","projects","timekeeper","backend","tests","user_update_api.rs"],"content":"use sqlx::PgPool;\nuse timekeeper_backend::models::user::{UpdateProfile, UpdateUser, User};\nuse uuid::Uuid;\n\nmod support;\n\nasync fn migrate_db(pool: \u0026PgPool) {\n    sqlx::migrate!(\"./migrations\")\n        .run(pool)\n        .await\n        .expect(\"run migrations\");\n}\n\nfn unique_email(base: \u0026str) -\u003e String {\n    let (local, domain) = base.split_once('@').unwrap_or((base, \"example.com\"));\n    format!(\"{}+{}@{}\", local, Uuid::new_v4(), domain)\n}\n\n#[tokio::test]\nasync fn test_admin_update_user_email() {\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n\n    let admin_email = unique_email(\"admin@test.com\");\n    let user_email = unique_email(\"user@test.com\");\n    let _admin = create_test_user(\u0026pool, \u0026admin_email, \"admin\", true).await;\n    let user = create_test_user(\u0026pool, \u0026user_email, \"user1\", false).await;\n\n    let new_email = unique_email(\"newemail@test.com\");\n\n    let update_payload = UpdateUser {\n        full_name: None,\n        email: Some(new_email.clone()),\n        role: None,\n        is_system_admin: None,\n    };\n\n    let updated = sqlx::query_as::\u003c_, User\u003e(\n         \"UPDATE users SET full_name = COALESCE($1, full_name), email = COALESCE($2, email), \\\n         role = COALESCE($3, role), is_system_admin = COALESCE($4, is_system_admin), updated_at = NOW() \\\n         WHERE id = $5 \\\n         RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\",\n    )\n    .bind(update_payload.full_name)\n    .bind(update_payload.email)\n    .bind(update_payload.role.map(|r| r.as_str()))\n    .bind(update_payload.is_system_admin)\n    .bind(user.id)\n    .fetch_one(\u0026pool)\n    .await\n    .expect(\"update user\");\n\n    assert_eq!(updated.email, new_email);\n    assert_eq!(updated.id, user.id);\n}\n\n#[tokio::test]\nasync fn test_user_update_own_profile() {\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n\n    let original_email = unique_email(\"original@test.com\");\n    let user = create_test_user(\u0026pool, \u0026original_email, \"testuser\", false).await;\n\n    let new_email = unique_email(\"updated@test.com\");\n    let new_full_name = \"Updated Name\";\n\n    let update_payload = UpdateProfile {\n        full_name: Some(new_full_name.to_string()),\n        email: Some(new_email.clone()),\n    };\n\n    let updated = sqlx::query_as::\u003c_, User\u003e(\n         \"UPDATE users SET full_name = COALESCE($1, full_name), email = COALESCE($2, email), updated_at = NOW() \\\n         WHERE id = $3 \\\n         RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \\\n         mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\",\n    )\n    .bind(update_payload.full_name)\n    .bind(update_payload.email)\n    .bind(user.id)\n    .fetch_one(\u0026pool)\n    .await\n    .expect(\"update profile\");\n\n    assert_eq!(updated.email, new_email);\n    assert_eq!(updated.full_name, new_full_name);\n}\n\n#[tokio::test]\nasync fn test_email_uniqueness_check() {\n    let pool = support::test_pool().await;\n    migrate_db(\u0026pool).await;\n\n    let user1_email = unique_email(\"user1@test.com\");\n    let user2_email = unique_email(\"user2@test.com\");\n    let _user1 = create_test_user(\u0026pool, \u0026user1_email, \"user1\", false).await;\n    let user2 = create_test_user(\u0026pool, \u0026user2_email, \"user2\", false).await;\n\n    let email_exists = sqlx::query_scalar::\u003c_, bool\u003e(\n        \"SELECT EXISTS(SELECT 1 FROM users WHERE email = $1 AND id != $2)\",\n    )\n    .bind(user1_email)\n    .bind(user2.id)\n    .fetch_one(\u0026pool)\n    .await\n    .expect(\"check email\");\n\n    assert!(email_exists);\n}\n\nasync fn create_test_user(pool: \u0026PgPool, email: \u0026str, username: \u0026str, is_admin: bool) -\u003e User {\n    let password_hash =\n        timekeeper_backend::utils::password::hash_password(\"TestPass123!\").expect(\"hash password\");\n\n    let user_id = Uuid::new_v4();\n    let unique_username = format!(\"{}_{}\", username, user_id);\n    sqlx::query_as::\u003c_, User\u003e(\n        r#\"\n        INSERT INTO users (id, username, password_hash, full_name, email, role, is_system_admin)\n        VALUES ($1, $2, $3, $4, $5, $6, $7)\n        RETURNING id, username, password_hash, full_name, email, LOWER(role) as role, is_system_admin, \n        mfa_secret, mfa_enabled_at, password_changed_at, created_at, updated_at\n        \"#,\n    )\n    .bind(user_id)\n    .bind(unique_username)\n    .bind(password_hash)\n    .bind(\"Test User\")\n    .bind(email)\n    .bind(if is_admin { \"admin\" } else { \"employee\" })\n    .bind(is_admin)\n    .fetch_one(pool)\n    .await\n    .expect(\"create test user\")\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","utils_csv.rs"],"content":"use timekeeper_backend::utils::csv::append_csv_row;\n\n#[test]\nfn csv_escapes_double_quotes() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"say \\\"hello\\\"\".to_string()]);\n    assert_eq!(buffer, \"\\\"say \\\"\\\"hello\\\"\\\"\\\"\\n\");\n}\n\n#[test]\nfn csv_handles_newlines_in_fields() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"line1\\nline2\".to_string()]);\n    assert_eq!(buffer, \"\\\"line1\\nline2\\\"\\n\");\n}\n\n#[test]\nfn csv_handles_comma_in_fields() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"a, b, c\".to_string()]);\n    assert_eq!(buffer, \"\\\"a, b, c\\\"\\n\");\n}\n\n#[test]\nfn csv_formula_guard_with_equals() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"=cmd|' /C calc'!A0\".to_string()]);\n    assert_eq!(buffer, \"\\\"'=cmd|' /C calc'!A0\\\"\\n\");\n}\n\n#[test]\nfn csv_formula_guard_with_plus() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"+1+2\".to_string()]);\n    assert_eq!(buffer, \"\\\"'+1+2\\\"\\n\");\n}\n\n#[test]\nfn csv_formula_guard_with_at() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"@SUM(A1)\".to_string()]);\n    assert_eq!(buffer, \"\\\"'@SUM(A1)\\\"\\n\");\n}\n\n#[test]\nfn csv_no_guard_for_normal_text() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"normal text\".to_string()]);\n    assert_eq!(buffer, \"\\\"normal text\\\"\\n\");\n}\n\n#[test]\nfn csv_empty_field() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"\".to_string()]);\n    assert_eq!(buffer, \"\\\"\\\"\\n\");\n}\n\n#[test]\nfn csv_multiple_fields() {\n    let mut buffer = String::new();\n    append_csv_row(\n        \u0026mut buffer,\n        \u0026[\n            \"field1\".to_string(),\n            \"field2\".to_string(),\n            \"field3\".to_string(),\n        ],\n    );\n    assert_eq!(buffer, \"\\\"field1\\\",\\\"field2\\\",\\\"field3\\\"\\n\");\n}\n\n#[test]\nfn csv_mixed_fields() {\n    let mut buffer = String::new();\n    append_csv_row(\n        \u0026mut buffer,\n        \u0026[\n            \"normal\".to_string(),\n            \"=formula\".to_string(),\n            \"quoted \\\"text\\\"\".to_string(),\n        ],\n    );\n    assert_eq!(buffer, \"\\\"normal\\\",\\\"'=formula\\\",\\\"quoted \\\"\\\"text\\\"\\\"\\\"\\n\");\n}\n\n#[test]\nfn csv_appends_multiple_rows() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"row1\".to_string()]);\n    append_csv_row(\u0026mut buffer, \u0026[\"row2\".to_string()]);\n    assert_eq!(buffer, \"\\\"row1\\\"\\n\\\"row2\\\"\\n\");\n}\n\n#[test]\nfn csv_handles_unicode() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"日本語テスト\".to_string()]);\n    assert_eq!(buffer, \"\\\"日本語テスト\\\"\\n\");\n}\n\n#[test]\nfn csv_handles_tabs() {\n    let mut buffer = String::new();\n    append_csv_row(\u0026mut buffer, \u0026[\"col1\\tcol2\".to_string()]);\n    assert_eq!(buffer, \"\\\"col1\\tcol2\\\"\\n\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","utils_jwt.rs"],"content":"use timekeeper_backend::utils::jwt::{\n    create_access_token, create_refresh_token, decode_refresh_token, verify_access_token,\n    verify_refresh_token, Claims,\n};\n\n#[test]\nfn jwt_create_and_verify_access_token() {\n    let (token, claims) = create_access_token(\n        \"user-123\".into(),\n        \"testuser\".into(),\n        \"employee\".into(),\n        \"testsecret\",\n        1,\n    )\n    .expect(\"create token\");\n\n    assert!(!token.is_empty());\n    assert_eq!(claims.sub, \"user-123\");\n    assert_eq!(claims.username, \"testuser\");\n    assert_eq!(claims.role, \"employee\");\n}\n\n#[test]\nfn jwt_verify_with_wrong_secret_fails() {\n    let (token, _) = create_access_token(\n        \"user-123\".into(),\n        \"testuser\".into(),\n        \"employee\".into(),\n        \"secret1\",\n        1,\n    )\n    .expect(\"create token\");\n\n    let result = verify_access_token(\u0026token, \"secret2\");\n    assert!(result.is_err());\n}\n\n#[test]\nfn jwt_expired_token_fails_verification() {\n    let expired_claims = Claims {\n        sub: \"user-123\".into(),\n        username: \"testuser\".into(),\n        role: \"employee\".into(),\n        exp: chrono::Utc::now().timestamp() - 3600,\n        iat: chrono::Utc::now().timestamp() - 7200,\n        jti: uuid::Uuid::new_v4().to_string(),\n    };\n\n    let token = jsonwebtoken::encode(\n        \u0026jsonwebtoken::Header::new(jsonwebtoken::Algorithm::HS256),\n        \u0026expired_claims,\n        \u0026jsonwebtoken::EncodingKey::from_secret(\"secret\".as_ref()),\n    )\n    .expect(\"encode token\");\n\n    let result = verify_access_token(\u0026token, \"secret\");\n    assert!(result.is_err());\n}\n\n#[test]\nfn jwt_malformed_token_fails() {\n    let result = verify_access_token(\"invalid.token.here\", \"secret\");\n    assert!(result.is_err());\n}\n\n#[test]\nfn jwt_create_and_verify_refresh_token() {\n    let refresh_token = create_refresh_token(\"user-456\".into(), 7).expect(\"create refresh token\");\n\n    assert!(!refresh_token.id.is_empty());\n    assert!(!refresh_token.secret.is_empty());\n    assert!(!refresh_token.token_hash.is_empty());\n    assert_eq!(refresh_token.user_id, \"user-456\");\n}\n\n#[test]\nfn jwt_verify_refresh_token_with_correct_hash() {\n    let refresh_token = create_refresh_token(\"user-789\".into(), 1).expect(\"create token\");\n    let is_valid = verify_refresh_token(\u0026refresh_token.secret, \u0026refresh_token.token_hash)\n        .expect(\"verify refresh token\");\n    assert!(is_valid);\n}\n\n#[test]\nfn jwt_verify_refresh_token_with_wrong_secret_fails() {\n    let refresh_token = create_refresh_token(\"user-789\".into(), 1).expect(\"create token\");\n    let is_valid = verify_refresh_token(\"wrong-secret\", \u0026refresh_token.token_hash)\n        .expect(\"verify refresh token\");\n    assert!(!is_valid);\n}\n\n#[test]\nfn jwt_decode_refresh_token_succeeds() {\n    let refresh_token = create_refresh_token(\"user-abc\".into(), 1).expect(\"create token\");\n    let encoded = refresh_token.encoded();\n\n    let (id, secret) = decode_refresh_token(\u0026encoded).expect(\"decode token\");\n    assert_eq!(id, refresh_token.id);\n    assert_eq!(secret, refresh_token.secret);\n}\n\n#[test]\nfn jwt_decode_malformed_refresh_token_fails() {\n    let result = decode_refresh_token(\"no-colon-here\");\n    assert!(result.is_err());\n}\n\n#[test]\nfn jwt_decode_empty_id_fails() {\n    let result = decode_refresh_token(\":secret\");\n    assert!(result.is_err());\n}\n\n#[test]\nfn jwt_decode_empty_secret_fails() {\n    let result = decode_refresh_token(\"id:\");\n    assert!(result.is_err());\n}\n\n#[test]\nfn jwt_claims_has_unique_jti() {\n    let (_, claims1) =\n        create_access_token(\"user\".into(), \"name\".into(), \"role\".into(), \"secret\", 1).unwrap();\n    let (_, claims2) =\n        create_access_token(\"user\".into(), \"name\".into(), \"role\".into(), \"secret\", 1).unwrap();\n\n    assert_ne!(claims1.jti, claims2.jti);\n}\n\n#[test]\nfn jwt_claims_expiration_set_correctly() {\n    let expiration_hours = 2u64;\n    let (_, claims) = create_access_token(\n        \"user\".into(),\n        \"name\".into(),\n        \"role\".into(),\n        \"secret\",\n        expiration_hours,\n    )\n    .unwrap();\n\n    let expected_exp = claims.iat + (expiration_hours as i64 * 3600);\n    assert!((claims.exp - expected_exp).abs() \u003c= 1);\n}\n\n#[test]\nfn jwt_refresh_token_has_future_expiration() {\n    let refresh_token = create_refresh_token(\"user\".into(), 7).expect(\"create token\");\n    assert!(refresh_token.expires_at \u003e chrono::Utc::now());\n}\n\n#[test]\nfn jwt_refresh_token_hash_is_different_from_secret() {\n    let refresh_token = create_refresh_token(\"user\".into(), 7).expect(\"create token\");\n    assert_ne!(refresh_token.token_hash, refresh_token.secret);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","utils_time.rs"],"content":"use chrono::{NaiveDate, Utc};\nuse chrono_tz::Tz;\nuse timekeeper_backend::utils::time::{now_in_timezone, now_utc, today_local};\n\n#[test]\nfn time_now_in_jst_returns_jst_datetime() {\n    let tz: Tz = \"Asia/Tokyo\".parse().unwrap();\n    let result = now_in_timezone(\u0026tz);\n    assert_eq!(result.timezone(), tz);\n}\n\n#[test]\nfn time_now_in_est_returns_est_datetime() {\n    let tz: Tz = \"America/New_York\".parse().unwrap();\n    let result = now_in_timezone(\u0026tz);\n    assert_eq!(result.timezone(), tz);\n}\n\n#[test]\nfn time_now_utc_returns_utc() {\n    let tz: Tz = chrono_tz::UTC;\n    let result = now_utc(\u0026tz);\n    assert_eq!(result.timezone(), Utc);\n}\n\n#[test]\nfn time_today_local_returns_date() {\n    let tz: Tz = chrono_tz::UTC;\n    let result = today_local(\u0026tz);\n    assert_eq!(result, Utc::now().date_naive());\n}\n\n#[test]\nfn time_now_in_timezone_returns_different_times() {\n    let jst: Tz = \"Asia/Tokyo\".parse().unwrap();\n    let utc: Tz = chrono_tz::UTC;\n\n    let jst_time = now_in_timezone(\u0026jst);\n    let utc_time = now_in_timezone(\u0026utc);\n\n    assert_eq!(jst_time.timezone(), jst);\n    assert_eq!(utc_time.timezone(), utc);\n}\n\n#[test]\nfn time_now_utc_is_consistent() {\n    let tz1: Tz = chrono_tz::UTC;\n    let tz2: Tz = \"Asia/Tokyo\".parse().unwrap();\n\n    let utc_from_utc = now_utc(\u0026tz1);\n    let utc_from_jst = now_utc(\u0026tz2);\n\n    let diff = (utc_from_utc - utc_from_jst).num_seconds().abs();\n    assert!(diff \u003c 2);\n}\n\n#[test]\nfn time_today_local_different_timezones() {\n    let jst: Tz = \"Asia/Tokyo\".parse().unwrap();\n    let pst: Tz = \"America/Los_Angeles\".parse().unwrap();\n\n    let jst_date = today_local(\u0026jst);\n    let pst_date = today_local(\u0026pst);\n\n    let diff_days = (jst_date - pst_date).num_days().abs();\n    assert!(diff_days \u003c= 1);\n}\n\n#[test]\nfn time_now_in_timezone_not_utc() {\n    let jst: Tz = \"Asia/Tokyo\".parse().unwrap();\n    let result = now_in_timezone(\u0026jst);\n    let jst_tz: Tz = result.timezone();\n    assert!(jst.to_string().contains(\"Tokyo\"));\n}\n\n#[test]\nfn time_jst_and_utc_produce_different_datetimes() {\n    let jst: Tz = \"Asia/Tokyo\".parse().unwrap();\n    let utc: Tz = chrono_tz::UTC;\n\n    let jst_time = now_in_timezone(\u0026jst);\n    let utc_time = now_in_timezone(\u0026utc);\n\n    assert_ne!(jst_time.to_rfc3339(), utc_time.to_rfc3339());\n}\n\n#[test]\nfn time_today_local_is_naive() {\n    let tz: Tz = chrono_tz::UTC;\n    let result = today_local(\u0026tz);\n    let _ = NaiveDate::from(result);\n}\n\n#[test]\nfn time_now_utc_timestamp_increases() {\n    let tz: Tz = chrono_tz::UTC;\n    let time1 = now_utc(\u0026tz);\n    std::thread::sleep(std::time::Duration::from_millis(10));\n    let time2 = now_utc(\u0026tz);\n\n    assert!(time2 \u003e= time1);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","backend","tests","weekly_holiday_convention.rs"],"content":"use chrono::NaiveDate;\nuse timekeeper_backend::services::holiday::{\n    HolidayReason, HolidayServiceStub, HolidayServiceTrait,\n};\n\n#[tokio::test]\nasync fn sunday_is_index_zero_convention() {\n    // 2025-12-28 is Sunday\n    let sunday = NaiveDate::from_ymd_opt(2025, 12, 28).unwrap();\n    // 2025-12-29 is Monday\n    let monday = NaiveDate::from_ymd_opt(2025, 12, 29).unwrap();\n\n    // If we define a weekly holiday with weekday=0 (Sunday in frontend/new convention)\n    let service = HolidayServiceStub::new([], [sunday], []).service();\n\n    // It should be a holiday on Sunday\n    let sunday_decision = service.is_holiday(sunday, None).await.expect(\"decision\");\n    assert!(sunday_decision.is_holiday);\n    assert_eq!(sunday_decision.reason, HolidayReason::WeeklyHoliday);\n\n    // It should NOT be a holiday on Monday\n    let monday_decision = service.is_holiday(monday, None).await.expect(\"decision\");\n    assert!(!monday_decision.is_holiday);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","attendance.rs"],"content":"use chrono::NaiveDate;\nuse serde_json::{json, Value};\n\nuse super::{\n    client::ApiClient,\n    types::{\n        AdminAttendanceUpsert, ApiError, AttendanceResponse, AttendanceStatusResponse,\n        AttendanceSummary, BreakRecordResponse,\n    },\n};\n\nfn attendance_range_params(\n    from: Option\u003cNaiveDate\u003e,\n    to: Option\u003cNaiveDate\u003e,\n) -\u003e Vec\u003c(\u0026'static str, String)\u003e {\n    let mut params = Vec::new();\n    if let Some(value) = from {\n        params.push((\"from\", value.format(\"%Y-%m-%d\").to_string()));\n    }\n    if let Some(value) = to {\n        params.push((\"to\", value.format(\"%Y-%m-%d\").to_string()));\n    }\n    params\n}\n\nfn attendance_status_params(date: Option\u003cNaiveDate\u003e) -\u003e Vec\u003c(\u0026'static str, String)\u003e {\n    date.map(|value| vec![(\"date\", value.format(\"%Y-%m-%d\").to_string())])\n        .unwrap_or_default()\n}\n\nfn attendance_summary_params(year: Option\u003ci32\u003e, month: Option\u003cu32\u003e) -\u003e Vec\u003c(\u0026'static str, String)\u003e {\n    let mut params = Vec::new();\n    if let Some(year) = year {\n        params.push((\"year\", year.to_string()));\n    }\n    if let Some(month) = month {\n        params.push((\"month\", month.to_string()));\n    }\n    params\n}\n\nimpl ApiClient {\n    pub async fn clock_in(\u0026self) -\u003e Result\u003cAttendanceResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/attendance/clock-in\", base_url))\n                    .json(\u0026json!({})))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn clock_out(\u0026self) -\u003e Result\u003cAttendanceResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/attendance/clock-out\", base_url))\n                    .json(\u0026json!({})))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn break_start(\u0026self, attendance_id: \u0026str) -\u003e Result\u003cBreakRecordResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/attendance/break-start\", base_url))\n                    .json(\u0026json!({ \"attendance_id\": attendance_id })))\n            })\n            .await?;\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn break_end(\u0026self, break_record_id: \u0026str) -\u003e Result\u003cBreakRecordResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/attendance/break-end\", base_url))\n                    .json(\u0026json!({ \"break_record_id\": break_record_id })))\n            })\n            .await?;\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn get_my_attendance_range(\n        \u0026self,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n    ) -\u003e Result\u003cVec\u003cAttendanceResponse\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let params = attendance_range_params(from, to);\n        let response = self\n            .send_with_refresh(|| {\n                let mut request = self\n                    .http_client()\n                    .get(format!(\"{}/attendance/me\", base_url));\n                if !params.is_empty() {\n                    request = request.query(\u0026params);\n                }\n                Ok(request)\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn get_attendance_status(\n        \u0026self,\n        date: Option\u003cNaiveDate\u003e,\n    ) -\u003e Result\u003cAttendanceStatusResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let params = attendance_status_params(date);\n        let response = self\n            .send_with_refresh(|| {\n                let mut request = self\n                    .http_client()\n                    .get(format!(\"{}/attendance/status\", base_url));\n                if !params.is_empty() {\n                    request = request.query(\u0026params);\n                }\n                Ok(request)\n            })\n            .await?;\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn get_breaks_by_attendance(\n        \u0026self,\n        attendance_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cBreakRecordResponse\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let url = format!(\"{}/attendance/{}/breaks\", base_url, attendance_id);\n        let response = self\n            .send_with_refresh(|| Ok(self.http_client().get(\u0026url)))\n            .await?;\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_upsert_attendance(\n        \u0026self,\n        payload: AdminAttendanceUpsert,\n    ) -\u003e Result\u003cAttendanceResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .put(format!(\"{}/admin/attendance\", base_url))\n                    .json(\u0026payload))\n            })\n            .await?;\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_force_end_break(\n        \u0026self,\n        break_id: \u0026str,\n    ) -\u003e Result\u003cBreakRecordResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .put(format!(\"{}/admin/breaks/{}/force-end\", base_url, break_id)))\n            })\n            .await?;\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn get_my_summary(\n        \u0026self,\n        year: Option\u003ci32\u003e,\n        month: Option\u003cu32\u003e,\n    ) -\u003e Result\u003cAttendanceSummary, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let params = attendance_summary_params(year, month);\n        let response = self\n            .send_with_refresh(|| {\n                let mut request = self\n                    .http_client()\n                    .get(format!(\"{}/attendance/me/summary\", base_url));\n                if !params.is_empty() {\n                    request = request.query(\u0026params);\n                }\n                Ok(request)\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn export_my_attendance_filtered(\n        \u0026self,\n        from: Option\u003c\u0026str\u003e,\n        to: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cValue, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let mut params: Vec\u003c(\u0026str, String)\u003e = Vec::new();\n        if let Some(f) = from {\n            if !f.is_empty() {\n                params.push((\"from\", f.to_string()));\n            }\n        }\n        if let Some(t) = to {\n            if !t.is_empty() {\n                params.push((\"to\", t.to_string()));\n            }\n        }\n\n        let response = self\n            .send_with_refresh(|| {\n                let mut request = self\n                    .http_client()\n                    .get(format!(\"{}/attendance/export\", base_url));\n                if !params.is_empty() {\n                    request = request.query(\u0026params);\n                }\n                Ok(request)\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::NaiveDate;\n\n    #[test]\n    fn builds_attendance_range_params() {\n        let from = NaiveDate::from_ymd_opt(2025, 1, 2).unwrap();\n        let to = NaiveDate::from_ymd_opt(2025, 1, 31).unwrap();\n        let params = attendance_range_params(Some(from), Some(to));\n        assert_eq!(params.len(), 2);\n        assert!(params.contains(\u0026(\"from\", \"2025-01-02\".to_string())));\n        assert!(params.contains(\u0026(\"to\", \"2025-01-31\".to_string())));\n    }\n\n    #[test]\n    fn builds_attendance_status_params() {\n        let date = NaiveDate::from_ymd_opt(2025, 2, 1).unwrap();\n        let params = attendance_status_params(Some(date));\n        assert_eq!(params, vec![(\"date\", \"2025-02-01\".to_string())]);\n        assert!(attendance_status_params(None).is_empty());\n    }\n\n    #[test]\n    fn builds_attendance_summary_params() {\n        let params = attendance_summary_params(Some(2024), Some(3));\n        assert!(params.contains(\u0026(\"year\", \"2024\".to_string())));\n        assert!(params.contains(\u0026(\"month\", \"3\".to_string())));\n        assert_eq!(attendance_summary_params(None, None).len(), 0);\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","audit_log.rs"],"content":"use crate::api::client::ApiClient;\nuse crate::api::types::{ApiError, AuditLog, AuditLogListResponse};\n\nfn audit_log_params(\n    page: Option\u003ci64\u003e,\n    per_page: Option\u003ci64\u003e,\n    from: Option\u003cString\u003e,\n    to: Option\u003cString\u003e,\n    actor_id: Option\u003cString\u003e,\n    event_type: Option\u003cString\u003e,\n    result: Option\u003cString\u003e,\n) -\u003e Vec\u003c(String, String)\u003e {\n    let mut params = Vec::new();\n    if let Some(page) = page {\n        params.push((\"page\".to_string(), page.to_string()));\n    }\n    if let Some(per_page) = per_page {\n        params.push((\"per_page\".to_string(), per_page.to_string()));\n    }\n    if let Some(value) = from {\n        if !value.is_empty() {\n            params.push((\"from\".into(), value));\n        }\n    }\n    if let Some(value) = to {\n        if !value.is_empty() {\n            params.push((\"to\".into(), value));\n        }\n    }\n    if let Some(value) = actor_id {\n        if !value.is_empty() {\n            params.push((\"actor_id\".into(), value));\n        }\n    }\n    if let Some(value) = event_type {\n        if !value.is_empty() {\n            params.push((\"event_type\".into(), value));\n        }\n    }\n    if let Some(value) = result {\n        if !value.is_empty() {\n            params.push((\"result\".into(), value));\n        }\n    }\n    params\n}\n\nimpl ApiClient {\n    pub async fn list_audit_logs(\n        \u0026self,\n        page: i64,\n        per_page: i64,\n        from: Option\u003cString\u003e,\n        to: Option\u003cString\u003e,\n        actor_id: Option\u003cString\u003e,\n        event_type: Option\u003cString\u003e,\n        result: Option\u003cString\u003e,\n    ) -\u003e Result\u003cAuditLogListResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let params = audit_log_params(\n            Some(page),\n            Some(per_page),\n            from,\n            to,\n            actor_id,\n            event_type,\n            result,\n        );\n\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .get(format!(\"{}/admin/audit-logs\", base_url))\n                    .query(\u0026params))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn export_audit_logs(\n        \u0026self,\n        from: Option\u003cString\u003e,\n        to: Option\u003cString\u003e,\n        actor_id: Option\u003cString\u003e,\n        event_type: Option\u003cString\u003e,\n        result: Option\u003cString\u003e,\n    ) -\u003e Result\u003cVec\u003cAuditLog\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let params = audit_log_params(None, None, from, to, actor_id, event_type, result);\n\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .get(format!(\"{}/admin/audit-logs/export\", base_url))\n                    .query(\u0026params))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn audit_log_params_include_page_defaults() {\n        let params = audit_log_params(Some(1), Some(20), None, None, None, None, None);\n        assert!(params.contains(\u0026(\"page\".to_string(), \"1\".to_string())));\n        assert!(params.contains(\u0026(\"per_page\".to_string(), \"20\".to_string())));\n    }\n\n    #[test]\n    fn audit_log_params_skip_empty_strings() {\n        let params = audit_log_params(\n            None,\n            None,\n            Some(\"\".into()),\n            Some(\"2025-01-01\".into()),\n            Some(\"\".into()),\n            None,\n            Some(\"success\".into()),\n        );\n        assert!(!params.iter().any(|(k, _)| k == \"from\"));\n        assert!(params.iter().any(|(k, v)| k == \"to\" \u0026\u0026 v == \"2025-01-01\"));\n        assert!(!params.iter().any(|(k, _)| k == \"actor_id\"));\n        assert!(params.iter().any(|(k, v)| k == \"result\" \u0026\u0026 v == \"success\"));\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","auth.rs"],"content":"use serde_json::json;\n\nuse super::{\n    client::{ensure_device_label, ApiClient},\n    types::{ApiError, LoginRequest, LoginResponse, MfaSetupResponse, MfaStatusResponse},\n};\nuse crate::utils::storage as storage_utils;\n\nimpl ApiClient {\n    pub async fn login(\u0026self, mut request: LoginRequest) -\u003e Result\u003cLoginResponse, ApiError\u003e {\n        let storage = storage_utils::local_storage().map_err(ApiError::unknown)?;\n        if request.device_label.is_none() {\n            request.device_label = Some(ensure_device_label(\u0026storage)?);\n        }\n        let base_url = self.resolved_base_url().await;\n        let response = ApiClient::with_credentials(\n            self.http_client()\n                .post(format!(\"{}/auth/login\", base_url))\n                .json(\u0026request),\n        )\n        .send()\n        .await\n        .map_err(|e| ApiError::request_failed(format!(\"Request failed: {}\", e)))?;\n\n        if response.status().is_success() {\n            let login_response: LoginResponse = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))?;\n            Ok(login_response)\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn refresh_token(\u0026self) -\u003e Result\u003cLoginResponse, ApiError\u003e {\n        let storage = storage_utils::local_storage().map_err(ApiError::unknown)?;\n        let device_label = ensure_device_label(\u0026storage)?;\n\n        let base_url = self.resolved_base_url().await;\n        let payload = json!({\n            \"device_label\": device_label\n        });\n\n        let response = ApiClient::with_credentials(\n            self.http_client()\n                .post(format!(\"{}/auth/refresh\", base_url))\n                .json(\u0026payload),\n        )\n        .send()\n        .await\n        .map_err(|e| ApiError::request_failed(format!(\"Request failed: {}\", e)))?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            let login_response: LoginResponse = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))?;\n            Ok(login_response)\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn logout(\u0026self, all: bool) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n\n        let body = if all {\n            serde_json::json!({ \"all\": true })\n        } else {\n            serde_json::json!({})\n        };\n\n        let resp = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/auth/logout\", base_url))\n                    .json(\u0026body))\n            })\n            .await?;\n        let status = resp.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let err: Result\u003cApiError, _\u003e = resp.json().await;\n            Err(err.unwrap_or_else(|_| ApiError::unknown(\"Logout failed\")))\n        }\n    }\n\n    pub async fn get_mfa_status(\u0026self) -\u003e Result\u003cMfaStatusResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| Ok(self.http_client().get(format!(\"{}/auth/mfa\", base_url))))\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn register_mfa(\u0026self) -\u003e Result\u003cMfaSetupResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/auth/mfa/register\", base_url))\n                    .json(\u0026json!({})))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn activate_mfa(\u0026self, code: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/auth/mfa/activate\", base_url))\n                    .json(\u0026json!({ \"code\": code })))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn change_password(\u0026self, current: String, new: String) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let payload = crate::api::types::ChangePasswordRequest {\n            current_password: current,\n            new_password: new,\n        };\n\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .put(format!(\"{}/auth/change-password\", base_url))\n                    .json(\u0026payload))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","client.rs"],"content":"use crate::api::types::*;\nuse crate::config;\nuse chrono::NaiveDate;\nuse reqwest::{Client, StatusCode};\nuse serde_json::json;\nuse uuid::Uuid;\nuse web_sys::Storage;\n\n#[cfg(test)]\nuse crate::utils::storage as storage_utils;\n\n#[derive(Clone)]\npub struct ApiClient {\n    client: Client,\n    base_url: Option\u003cString\u003e,\n}\n\nimpl ApiClient {\n    pub fn new() -\u003e Self {\n        Self {\n            client: Client::new(),\n            base_url: None,\n        }\n    }\n\n    pub(super) async fn resolved_base_url(\u0026self) -\u003e String {\n        if let Some(base) = \u0026self.base_url {\n            base.clone()\n        } else {\n            config::await_api_base_url().await\n        }\n    }\n\n    pub(super) fn http_client(\u0026self) -\u003e \u0026Client {\n        \u0026self.client\n    }\n\n    #[cfg(target_arch = \"wasm32\")]\n    pub(crate) fn with_credentials(builder: reqwest::RequestBuilder) -\u003e reqwest::RequestBuilder {\n        builder.fetch_credentials_include()\n    }\n\n    #[cfg(not(target_arch = \"wasm32\"))]\n    pub(crate) fn with_credentials(builder: reqwest::RequestBuilder) -\u003e reqwest::RequestBuilder {\n        builder\n    }\n\n    pub(super) fn handle_unauthorized_status(status: StatusCode) {\n        if status == StatusCode::UNAUTHORIZED {\n            Self::redirect_to_login_if_needed();\n        }\n    }\n\n    pub(super) async fn send_with_refresh\u003cF\u003e(\n        \u0026self,\n        build_request: F,\n    ) -\u003e Result\u003creqwest::Response, ApiError\u003e\n    where\n        F: Fn() -\u003e Result\u003creqwest::RequestBuilder, ApiError\u003e,\n    {\n        let response = Self::with_credentials(build_request()?)\n            .send()\n            .await\n            .map_err(|e| ApiError::request_failed(format!(\"Request failed: {}\", e)))?;\n\n        if response.status() != StatusCode::UNAUTHORIZED {\n            return Ok(response);\n        }\n\n        if self.refresh_token().await.is_ok() {\n            let retry_response = Self::with_credentials(build_request()?)\n                .send()\n                .await\n                .map_err(|e| ApiError::request_failed(format!(\"Request failed: {}\", e)))?;\n            return Ok(retry_response);\n        }\n\n        Ok(response)\n    }\n\n    fn redirect_to_login_if_needed() {\n        if let Some(window) = web_sys::window() {\n            let location = window.location();\n            if let Ok(pathname) = location.pathname() {\n                // Public paths where 401 is expected (not logged in) and should not trigger redirect\n                let public_paths = [\n                    \"/\",\n                    \"/login\",\n                    \"/forgot-password\",\n                    \"/reset-password\",\n                    \"/mfa/register\",\n                ];\n                if public_paths.contains(\u0026pathname.as_str()) {\n                    return;\n                }\n            }\n            let _ = location.set_href(\"/login\");\n        }\n    }\n\n    pub async fn get_me(\u0026self) -\u003e Result\u003cUserResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| Ok(self.client.get(format!(\"{}/auth/me\", base_url))))\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn get_users(\u0026self) -\u003e Result\u003cVec\u003cUserResponse\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| Ok(self.client.get(format!(\"{}/admin/users\", base_url))))\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn create_user(\u0026self, request: CreateUser) -\u003e Result\u003cUserResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .post(format!(\"{}/admin/users\", base_url))\n                    .json(\u0026request))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_reset_mfa(\u0026self, user_id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let resp = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .post(format!(\"{}/admin/mfa/reset\", base_url))\n                    .json(\u0026json!({ \"user_id\": user_id })))\n            })\n            .await?;\n        let status = resp.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = resp\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    /// Delete a user (soft delete by default, hard delete if `hard` is true).\n    pub async fn admin_delete_user(\u0026self, user_id: \u0026str, hard: bool) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let resp = self\n            .send_with_refresh(|| {\n                let mut request = self\n                    .client\n                    .delete(format!(\"{}/admin/users/{}\", base_url, user_id));\n                if hard {\n                    request = request.query(\u0026[(\"hard\", \"true\")]);\n                }\n                Ok(request)\n            })\n            .await?;\n        let status = resp.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = resp\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    /// Get all archived users.\n    pub async fn admin_get_archived_users(\u0026self) -\u003e Result\u003cVec\u003cArchivedUserResponse\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let resp = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .get(format!(\"{}/admin/archived-users\", base_url)))\n            })\n            .await?;\n        let status = resp.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            resp.json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = resp\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    /// Restore an archived user.\n    pub async fn admin_restore_archived_user(\u0026self, user_id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let resp = self\n            .send_with_refresh(|| {\n                Ok(self.client.post(format!(\n                    \"{}/admin/archived-users/{}/restore\",\n                    base_url, user_id\n                )))\n            })\n            .await?;\n        let status = resp.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = resp\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    /// Permanently delete an archived user.\n    pub async fn admin_delete_archived_user(\u0026self, user_id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let resp = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .delete(format!(\"{}/admin/archived-users/{}\", base_url, user_id)))\n            })\n            .await?;\n        let status = resp.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = resp\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_list_holidays(\n        \u0026self,\n        page: i64,\n        per_page: i64,\n        from: Option\u003cNaiveDate\u003e,\n        to: Option\u003cNaiveDate\u003e,\n    ) -\u003e Result\u003cAdminHolidayListResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let mut params = vec![\n            (\"type\".to_string(), \"public\".to_string()),\n            (\"page\".to_string(), page.to_string()),\n            (\"per_page\".to_string(), per_page.to_string()),\n        ];\n        if let Some(from) = from {\n            params.push((\"from\".into(), from.format(\"%Y-%m-%d\").to_string()));\n        }\n        if let Some(to) = to {\n            params.push((\"to\".into(), to.format(\"%Y-%m-%d\").to_string()));\n        }\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .get(format!(\"{}/admin/holidays\", base_url))\n                    .query(\u0026params))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_create_holiday(\n        \u0026self,\n        payload: \u0026CreateHolidayRequest,\n    ) -\u003e Result\u003cHolidayResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .post(format!(\"{}/admin/holidays\", base_url))\n                    .json(payload))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_delete_holiday(\u0026self, id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .delete(format!(\"{}/admin/holidays/{}\", base_url, id)))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn check_holiday(\n        \u0026self,\n        date: chrono::NaiveDate,\n    ) -\u003e Result\u003cHolidayCheckResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .get(format!(\"{}/holidays/check\", base_url))\n                    .query(\u0026[(\"date\", date.format(\"%Y-%m-%d\").to_string())]))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn get_monthly_holidays(\n        \u0026self,\n        year: i32,\n        month: u32,\n    ) -\u003e Result\u003cVec\u003cHolidayCalendarEntry\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .get(format!(\"{}/holidays/month\", base_url))\n                    .query(\u0026[(\"year\", year.to_string()), (\"month\", month.to_string())]))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_list_weekly_holidays(\u0026self) -\u003e Result\u003cVec\u003cWeeklyHolidayResponse\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .get(format!(\"{}/admin/holidays/weekly\", base_url)))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_create_weekly_holiday(\n        \u0026self,\n        payload: \u0026CreateWeeklyHolidayRequest,\n    ) -\u003e Result\u003cWeeklyHolidayResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .post(format!(\"{}/admin/holidays/weekly\", base_url))\n                    .json(payload))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_delete_weekly_holiday(\u0026self, id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .client\n                    .delete(format!(\"{}/admin/holidays/weekly/{}\", base_url, id)))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            Ok(())\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn admin_fetch_google_holidays(\n        \u0026self,\n        year: Option\u003ci32\u003e,\n    ) -\u003e Result\u003cVec\u003cCreateHolidayRequest\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                let mut request = self\n                    .client\n                    .get(format!(\"{}/admin/holidays/google\", base_url));\n                if let Some(year) = year {\n                    let params = [(\"year\", year.to_string())];\n                    request = request.query(\u0026params);\n                }\n                Ok(request)\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn export_data_filtered(\n        \u0026self,\n        username: Option\u003c\u0026str\u003e,\n        from: Option\u003c\u0026str\u003e,\n        to: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cserde_json::Value, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let mut params: Vec\u003c(\u0026str, String)\u003e = Vec::new();\n        if let Some(u) = username {\n            if !u.is_empty() {\n                params.push((\"username\", u.to_string()));\n            }\n        }\n        if let Some(f) = from {\n            if !f.is_empty() {\n                params.push((\"from\", f.to_string()));\n            }\n        }\n        if let Some(t) = to {\n            if !t.is_empty() {\n                params.push((\"to\", t.to_string()));\n            }\n        }\n\n        let response = self\n            .send_with_refresh(|| {\n                let mut request = self.client.get(format!(\"{}/admin/export\", base_url));\n                if !params.is_empty() {\n                    request = request.query(\u0026params);\n                }\n                Ok(request)\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn request_password_reset(\u0026self, email: String) -\u003e Result\u003cMessageResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let request = RequestPasswordResetRequest { email };\n        let response = self\n            .client\n            .post(format!(\"{}/auth/request-password-reset\", base_url))\n            .json(\u0026request)\n            .send()\n            .await\n            .map_err(|e| ApiError::request_failed(format!(\"Request failed: {}\", e)))?;\n\n        let status = response.status();\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn reset_password(\n        \u0026self,\n        token: String,\n        new_password: String,\n    ) -\u003e Result\u003cMessageResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let request = ResetPasswordRequest {\n            token,\n            new_password,\n        };\n        let response = self\n            .client\n            .post(format!(\"{}/auth/reset-password\", base_url))\n            .json(\u0026request)\n            .send()\n            .await\n            .map_err(|e| ApiError::request_failed(format!(\"Request failed: {}\", e)))?;\n\n        let status = response.status();\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n}\n\npub(super) fn ensure_device_label(storage: \u0026Storage) -\u003e Result\u003cString, ApiError\u003e {\n    if let Ok(Some(label)) = storage.get_item(\"device_label\") {\n        if !label.trim().is_empty() {\n            return Ok(label);\n        }\n    }\n    let label = format!(\"device-{}\", Uuid::new_v4());\n    storage\n        .set_item(\"device_label\", \u0026label)\n        .map_err(|_| ApiError::unknown(\"Failed to persist device label\"))?;\n    Ok(label)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    fn storage() -\u003e Storage {\n        storage_utils::local_storage().expect(\"local_storage available\")\n    }\n\n    fn cleanup(keys: \u0026[\u0026str]) {\n        let store = storage();\n        for key in keys {\n            let _ = store.remove_item(key);\n        }\n    }\n\n    #[wasm_bindgen_test]\n    fn ensure_device_label_persists_value() {\n        cleanup(\u0026[\"device_label\"]);\n        let store = storage();\n        let first = ensure_device_label(\u0026store).expect(\"label generated\");\n        assert!(first.starts_with(\"device-\"));\n        assert_eq!(store.get_item(\"device_label\").unwrap().unwrap(), first);\n        let second = ensure_device_label(\u0026store).expect(\"label reused\");\n        assert_eq!(first, second);\n        cleanup(\u0026[\"device_label\"]);\n    }\n}\n","traces":[{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":70,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":71,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":75,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":11},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","mod.rs"],"content":"mod attendance;\nmod audit_log;\nmod auth;\npub mod client;\nmod requests;\nmod subject_requests;\npub mod types;\n\npub use client::*;\npub use types::*;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","requests.rs"],"content":"use serde_json::{json, Value};\n\nuse super::{\n    client::ApiClient,\n    types::{\n        ApiError, CreateLeaveRequest, CreateOvertimeRequest, LeaveRequestResponse,\n        OvertimeRequestResponse,\n    },\n};\n\nfn admin_request_params(\n    status: Option\u003c\u0026str\u003e,\n    user_id: Option\u003c\u0026str\u003e,\n    page: Option\u003cu32\u003e,\n    per_page: Option\u003cu32\u003e,\n) -\u003e Vec\u003c(\u0026'static str, String)\u003e {\n    let mut params = Vec::new();\n    if let Some(status) = status {\n        params.push((\"status\", status.to_string()));\n    }\n    if let Some(user_id) = user_id {\n        params.push((\"user_id\", user_id.to_string()));\n    }\n    if let Some(page) = page {\n        params.push((\"page\", page.to_string()));\n    }\n    if let Some(per_page) = per_page {\n        params.push((\"per_page\", per_page.to_string()));\n    }\n    params\n}\n\nimpl ApiClient {\n    pub async fn admin_list_requests(\n        \u0026self,\n        status: Option\u003c\u0026str\u003e,\n        user_id: Option\u003c\u0026str\u003e,\n        page: Option\u003cu32\u003e,\n        per_page: Option\u003cu32\u003e,\n    ) -\u003e Result\u003cValue, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let params = admin_request_params(status, user_id, page, per_page);\n        let response = self\n            .send_with_refresh(|| {\n                let mut request = self\n                    .http_client()\n                    .get(format!(\"{}/admin/requests\", base_url));\n                if !params.is_empty() {\n                    request = request.query(\u0026params);\n                }\n                Ok(request)\n            })\n            .await?;\n        self.map_json_response(response).await\n    }\n\n    pub async fn admin_approve_request(\u0026self, id: \u0026str, comment: \u0026str) -\u003e Result\u003cValue, ApiError\u003e {\n        self.admin_mutate_request(id, \"approve\", comment).await\n    }\n\n    pub async fn admin_reject_request(\u0026self, id: \u0026str, comment: \u0026str) -\u003e Result\u003cValue, ApiError\u003e {\n        self.admin_mutate_request(id, \"reject\", comment).await\n    }\n\n    async fn admin_mutate_request(\n        \u0026self,\n        id: \u0026str,\n        action: \u0026str,\n        comment: \u0026str,\n    ) -\u003e Result\u003cValue, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .put(format!(\"{}/admin/requests/{}/{}\", base_url, id, action))\n                    .json(\u0026json!({ \"comment\": comment })))\n            })\n            .await?;\n        self.map_json_response(response).await\n    }\n\n    pub async fn update_request(\u0026self, id: \u0026str, payload: Value) -\u003e Result\u003cValue, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .put(format!(\"{}/requests/{}\", base_url, id))\n                    .json(\u0026payload))\n            })\n            .await?;\n        self.map_json_response(response).await\n    }\n\n    pub async fn cancel_request(\u0026self, id: \u0026str) -\u003e Result\u003cValue, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .delete(format!(\"{}/requests/{}\", base_url, id)))\n            })\n            .await?;\n        self.map_json_response(response).await\n    }\n\n    pub async fn create_leave_request(\n        \u0026self,\n        request: CreateLeaveRequest,\n    ) -\u003e Result\u003cLeaveRequestResponse, ApiError\u003e {\n        self.create_request(\"leave\", request).await\n    }\n\n    pub async fn create_overtime_request(\n        \u0026self,\n        request: CreateOvertimeRequest,\n    ) -\u003e Result\u003cOvertimeRequestResponse, ApiError\u003e {\n        self.create_request(\"overtime\", request).await\n    }\n\n    async fn create_request\u003cT, R\u003e(\u0026self, kind: \u0026str, payload: T) -\u003e Result\u003cR, ApiError\u003e\n    where\n        T: serde::Serialize,\n        R: serde::de::DeserializeOwned,\n    {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/requests/{}\", base_url, kind))\n                    .json(\u0026payload))\n            })\n            .await?;\n\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n\n    pub async fn get_my_requests(\u0026self) -\u003e Result\u003cValue, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| Ok(self.http_client().get(format!(\"{}/requests/me\", base_url))))\n            .await?;\n        self.map_json_response(response).await\n    }\n\n    async fn map_json_response(\u0026self, response: reqwest::Response) -\u003e Result\u003cValue, ApiError\u003e {\n        let status = response.status();\n        Self::handle_unauthorized_status(status);\n        if status.is_success() {\n            response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n        } else {\n            let error: ApiError = response\n                .json()\n                .await\n                .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n            Err(error)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn admin_request_params_skip_missing_values() {\n        let params = admin_request_params(None, None, None, None);\n        assert!(params.is_empty());\n    }\n\n    #[test]\n    fn admin_request_params_includes_filters() {\n        let params = admin_request_params(Some(\"approved\"), Some(\"user-1\"), Some(2), Some(50));\n        assert!(params.contains(\u0026(\"status\", \"approved\".to_string())));\n        assert!(params.contains(\u0026(\"user_id\", \"user-1\".to_string())));\n        assert!(params.contains(\u0026(\"page\", \"2\".to_string())));\n        assert!(params.contains(\u0026(\"per_page\", \"50\".to_string())));\n    }\n}\n","traces":[{"line":127,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":129,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":133,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":143,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":18},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","subject_requests.rs"],"content":"use serde_json::json;\n\nuse super::{\n    client::ApiClient,\n    types::{\n        ApiError, CreateDataSubjectRequest, DataSubjectRequestResponse, SubjectRequestListResponse,\n    },\n};\n\nimpl ApiClient {\n    pub async fn create_subject_request(\n        \u0026self,\n        payload: CreateDataSubjectRequest,\n    ) -\u003e Result\u003cDataSubjectRequestResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .post(format!(\"{}/subject-requests\", base_url))\n                    .json(\u0026payload))\n            })\n            .await?;\n        map_typed_response(response).await\n    }\n\n    pub async fn list_my_subject_requests(\n        \u0026self,\n    ) -\u003e Result\u003cVec\u003cDataSubjectRequestResponse\u003e, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .get(format!(\"{}/subject-requests/me\", base_url)))\n            })\n            .await?;\n        map_typed_response(response).await\n    }\n\n    pub async fn cancel_subject_request(\u0026self, id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .delete(format!(\"{}/subject-requests/{}\", base_url, id)))\n            })\n            .await?;\n        map_empty_response(response).await\n    }\n\n    pub async fn admin_list_subject_requests(\n        \u0026self,\n        status: Option\u003cString\u003e,\n        request_type: Option\u003cString\u003e,\n        user_id: Option\u003cString\u003e,\n        from: Option\u003cString\u003e,\n        to: Option\u003cString\u003e,\n        page: i64,\n        per_page: i64,\n    ) -\u003e Result\u003cSubjectRequestListResponse, ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let mut params = vec![\n            (\"page\".to_string(), page.to_string()),\n            (\"per_page\".to_string(), per_page.to_string()),\n        ];\n        if let Some(value) = status {\n            if !value.is_empty() {\n                params.push((\"status\".to_string(), value));\n            }\n        }\n        if let Some(value) = request_type {\n            if !value.is_empty() {\n                params.push((\"type\".to_string(), value));\n            }\n        }\n        if let Some(value) = user_id {\n            if !value.is_empty() {\n                params.push((\"user_id\".to_string(), value));\n            }\n        }\n        if let Some(value) = from {\n            if !value.is_empty() {\n                params.push((\"from\".to_string(), value));\n            }\n        }\n        if let Some(value) = to {\n            if !value.is_empty() {\n                params.push((\"to\".to_string(), value));\n            }\n        }\n\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .get(format!(\"{}/admin/subject-requests\", base_url))\n                    .query(\u0026params))\n            })\n            .await?;\n        map_typed_response(response).await\n    }\n\n    pub async fn admin_approve_subject_request(\n        \u0026self,\n        id: \u0026str,\n        comment: \u0026str,\n    ) -\u003e Result\u003c(), ApiError\u003e {\n        self.admin_mutate_subject_request(id, \"approve\", comment)\n            .await\n    }\n\n    pub async fn admin_reject_subject_request(\n        \u0026self,\n        id: \u0026str,\n        comment: \u0026str,\n    ) -\u003e Result\u003c(), ApiError\u003e {\n        self.admin_mutate_subject_request(id, \"reject\", comment)\n            .await\n    }\n\n    async fn admin_mutate_subject_request(\n        \u0026self,\n        id: \u0026str,\n        action: \u0026str,\n        comment: \u0026str,\n    ) -\u003e Result\u003c(), ApiError\u003e {\n        let base_url = self.resolved_base_url().await;\n        let response = self\n            .send_with_refresh(|| {\n                Ok(self\n                    .http_client()\n                    .put(format!(\n                        \"{}/admin/subject-requests/{}/{}\",\n                        base_url, id, action\n                    ))\n                    .json(\u0026json!({ \"comment\": comment })))\n            })\n            .await?;\n        map_empty_response(response).await\n    }\n}\n\nasync fn map_typed_response\u003cT\u003e(response: reqwest::Response) -\u003e Result\u003cT, ApiError\u003e\nwhere\n    T: serde::de::DeserializeOwned,\n{\n    let status = response.status();\n    ApiClient::handle_unauthorized_status(status);\n    if status.is_success() {\n        response\n            .json()\n            .await\n            .map_err(|e| ApiError::unknown(format!(\"Failed to parse response: {}\", e)))\n    } else {\n        let error: ApiError = response\n            .json()\n            .await\n            .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n        Err(error)\n    }\n}\n\nasync fn map_empty_response(response: reqwest::Response) -\u003e Result\u003c(), ApiError\u003e {\n    let status = response.status();\n    ApiClient::handle_unauthorized_status(status);\n    if status.is_success() {\n        Ok(())\n    } else {\n        let error: ApiError = response\n            .json()\n            .await\n            .map_err(|e| ApiError::unknown(format!(\"Failed to parse error: {}\", e)))?;\n        Err(error)\n    }\n}\n","traces":[{"line":149,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":10},{"path":["/","home","marra","projects","timekeeper","frontend","src","api","types.rs"],"content":"use chrono::{DateTime, NaiveDate, NaiveDateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct LoginRequest {\n    pub username: String,\n    pub password: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub totp_code: Option\u003cString\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub device_label: Option\u003cString\u003e,\n}\n\n#[derive(Clone, Serialize, Deserialize)]\npub struct ChangePasswordRequest {\n    pub current_password: String,\n    pub new_password: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct LoginResponse {\n    pub user: UserResponse,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UserResponse {\n    pub id: String,\n    pub username: String,\n    pub full_name: String,\n    pub role: String,\n    #[serde(default)]\n    pub is_system_admin: bool,\n    #[serde(default)]\n    pub mfa_enabled: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MfaSetupResponse {\n    pub secret: String,\n    pub otpauth_url: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MfaStatusResponse {\n    pub enabled: bool,\n    pub pending: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AttendanceResponse {\n    pub id: String,\n    pub user_id: String,\n    pub date: NaiveDate,\n    pub clock_in_time: Option\u003cNaiveDateTime\u003e,\n    pub clock_out_time: Option\u003cNaiveDateTime\u003e,\n    pub status: String,\n    pub total_work_hours: Option\u003cf64\u003e,\n    pub break_records: Vec\u003cBreakRecordResponse\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AttendanceStatusResponse {\n    pub status: String,\n    pub attendance_id: Option\u003cString\u003e,\n    pub active_break_id: Option\u003cString\u003e,\n    pub clock_in_time: Option\u003cNaiveDateTime\u003e,\n    pub clock_out_time: Option\u003cNaiveDateTime\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HolidayResponse {\n    pub id: String,\n    pub holiday_date: NaiveDate,\n    pub name: String,\n    pub description: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AdminHolidayListResponse {\n    pub page: i64,\n    pub per_page: i64,\n    pub total: i64,\n    pub items: Vec\u003cAdminHolidayListItem\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\n#[serde(rename_all = \"snake_case\")]\npub enum AdminHolidayKind {\n    Public,\n    Weekly,\n    Exception,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AdminHolidayListItem {\n    pub id: String,\n    pub kind: AdminHolidayKind,\n    pub applies_from: NaiveDate,\n    pub applies_to: Option\u003cNaiveDate\u003e,\n    pub date: Option\u003cNaiveDate\u003e,\n    pub weekday: Option\u003ci16\u003e,\n    pub starts_on: Option\u003cNaiveDate\u003e,\n    pub ends_on: Option\u003cNaiveDate\u003e,\n    pub name: Option\u003cString\u003e,\n    pub description: Option\u003cString\u003e,\n    pub user_id: Option\u003cString\u003e,\n    pub reason: Option\u003cString\u003e,\n    pub created_by: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub is_override: Option\u003cbool\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CreateHolidayRequest {\n    pub holiday_date: NaiveDate,\n    pub name: String,\n    #[serde(default)]\n    pub description: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WeeklyHolidayResponse {\n    pub id: String,\n    pub weekday: i16,\n    pub starts_on: NaiveDate,\n    pub ends_on: Option\u003cNaiveDate\u003e,\n    pub enforced_from: NaiveDate,\n    pub enforced_to: Option\u003cNaiveDate\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CreateWeeklyHolidayRequest {\n    pub weekday: u8,\n    pub starts_on: NaiveDate,\n    #[serde(default)]\n    pub ends_on: Option\u003cNaiveDate\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HolidayCheckResponse {\n    pub is_holiday: bool,\n    #[serde(default)]\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HolidayCalendarEntry {\n    pub date: NaiveDate,\n    pub reason: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct BreakRecordResponse {\n    pub id: String,\n    pub attendance_id: String,\n    pub break_start_time: NaiveDateTime,\n    pub break_end_time: Option\u003cNaiveDateTime\u003e,\n    pub duration_minutes: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AttendanceSummary {\n    pub month: u32,\n    pub year: i32,\n    pub total_work_hours: f64,\n    pub total_work_days: i32,\n    pub average_daily_hours: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CreateLeaveRequest {\n    pub leave_type: String,\n    pub start_date: NaiveDate,\n    pub end_date: NaiveDate,\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct LeaveRequestResponse {\n    pub id: String,\n    pub user_id: String,\n    pub leave_type: String,\n    pub start_date: NaiveDate,\n    pub end_date: NaiveDate,\n    pub reason: Option\u003cString\u003e,\n    pub status: String,\n    pub approved_by: Option\u003cString\u003e,\n    pub approved_at: Option\u003cString\u003e,\n    pub rejected_by: Option\u003cString\u003e,\n    pub rejected_at: Option\u003cString\u003e,\n    pub cancelled_at: Option\u003cString\u003e,\n    pub decision_comment: Option\u003cString\u003e,\n    pub created_at: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CreateOvertimeRequest {\n    pub date: NaiveDate,\n    pub planned_hours: f64,\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct OvertimeRequestResponse {\n    pub id: String,\n    pub user_id: String,\n    pub date: NaiveDate,\n    pub planned_hours: f64,\n    pub reason: Option\u003cString\u003e,\n    pub status: String,\n    pub approved_by: Option\u003cString\u003e,\n    pub approved_at: Option\u003cString\u003e,\n    pub rejected_by: Option\u003cString\u003e,\n    pub rejected_at: Option\u003cString\u003e,\n    pub cancelled_at: Option\u003cString\u003e,\n    pub decision_comment: Option\u003cString\u003e,\n    pub created_at: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\n#[serde(rename_all = \"snake_case\")]\npub enum DataSubjectRequestType {\n    Access,\n    Rectify,\n    Delete,\n    Stop,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CreateDataSubjectRequest {\n    pub request_type: DataSubjectRequestType,\n    #[serde(default)]\n    pub details: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DataSubjectRequestResponse {\n    pub id: String,\n    pub user_id: String,\n    pub request_type: DataSubjectRequestType,\n    pub status: String,\n    pub details: Option\u003cString\u003e,\n    pub approved_by: Option\u003cString\u003e,\n    pub approved_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub rejected_by: Option\u003cString\u003e,\n    pub rejected_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub cancelled_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub decision_comment: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SubjectRequestListResponse {\n    pub page: i64,\n    pub per_page: i64,\n    pub total: i64,\n    pub items: Vec\u003cDataSubjectRequestResponse\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AdminAttendanceUpsert {\n    pub user_id: String,\n    pub date: NaiveDate,\n    pub clock_in_time: NaiveDateTime,\n    pub clock_out_time: Option\u003cNaiveDateTime\u003e,\n    pub breaks: Option\u003cVec\u003cAdminBreakItem\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AdminBreakItem {\n    pub break_start_time: NaiveDateTime,\n    pub break_end_time: Option\u003cNaiveDateTime\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CreateUser {\n    pub username: String,\n    pub password: String,\n    pub full_name: String,\n    pub email: String,\n    pub role: String,\n    #[serde(default)]\n    pub is_system_admin: bool,\n}\n\nuse leptos::*;\n\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\npub struct ApiError {\n    pub error: String,\n    pub code: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub details: Option\u003cValue\u003e,\n}\n\nimpl std::fmt::Display for ApiError {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(f, \"{}\", self.error)\n    }\n}\n\nimpl From\u003cApiError\u003e for String {\n    fn from(error: ApiError) -\u003e Self {\n        error.error\n    }\n}\n\nimpl IntoView for ApiError {\n    fn into_view(self) -\u003e View {\n        self.error.into_view()\n    }\n}\n\nimpl ApiError {\n    pub fn validation(msg: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            error: msg.into(),\n            code: \"VALIDATION_ERROR\".to_string(),\n            details: None,\n        }\n    }\n\n    pub fn unknown(msg: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            error: msg.into(),\n            code: \"UNKNOWN\".to_string(),\n            details: None,\n        }\n    }\n\n    pub fn request_failed(msg: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            error: msg.into(),\n            code: \"REQUEST_FAILED\".to_string(),\n            details: None,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AuditLog {\n    pub id: String,\n    pub occurred_at: DateTime\u003cUtc\u003e,\n    pub actor_id: Option\u003cString\u003e,\n    pub actor_type: String,\n    pub event_type: String,\n    pub target_type: Option\u003cString\u003e,\n    pub target_id: Option\u003cString\u003e,\n    pub result: String,\n    pub error_code: Option\u003cString\u003e,\n    pub metadata: Option\u003cValue\u003e,\n    pub ip: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub request_id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AuditLogListResponse {\n    pub page: i64,\n    pub per_page: i64,\n    pub total: i64,\n    pub items: Vec\u003cAuditLog\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ArchivedUserResponse {\n    pub id: String,\n    pub username: String,\n    pub full_name: String,\n    pub role: String,\n    #[serde(default)]\n    pub is_system_admin: bool,\n    pub archived_at: String,\n    pub archived_by: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RequestPasswordResetRequest {\n    pub email: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ResetPasswordRequest {\n    pub token: String,\n    pub new_password: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MessageResponse {\n    pub message: String,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    #[wasm_bindgen_test]\n    fn serialize_create_leave_request_snake_case_fields() {\n        let req = CreateLeaveRequest {\n            leave_type: \"annual\".into(),\n            start_date: chrono::NaiveDate::from_ymd_opt(2025, 1, 2).unwrap(),\n            end_date: chrono::NaiveDate::from_ymd_opt(2025, 1, 3).unwrap(),\n            reason: None,\n        };\n        let v = serde_json::to_value(\u0026req).unwrap();\n        assert_eq!(v[\"leave_type\"], serde_json::json!(\"annual\"));\n        assert_eq!(v[\"start_date\"], serde_json::json!(\"2025-01-02\"));\n        assert_eq!(v[\"end_date\"], serde_json::json!(\"2025-01-03\"));\n        assert!(v.get(\"reason\").is_some());\n        assert!(v[\"reason\"].is_null());\n    }\n\n    #[wasm_bindgen_test]\n    fn deserialize_login_response_role_snake_case() {\n        let raw = r#\"{\n            \"user\": { \"id\": \"u1\", \"username\": \"bob\", \"full_name\": \"Bob\", \"role\": \"admin\" }\n        }\"#;\n        let lr: LoginResponse = serde_json::from_str(raw).unwrap();\n        assert_eq!(lr.user.role, \"admin\");\n        assert_eq!(lr.user.username, \"bob\");\n    }\n\n    #[wasm_bindgen_test]\n    fn serialize_create_weekly_holiday_request_includes_optional_fields() {\n        let request = CreateWeeklyHolidayRequest {\n            weekday: 2,\n            starts_on: NaiveDate::from_ymd_opt(2025, 1, 8).unwrap(),\n            ends_on: None,\n        };\n        let json = serde_json::to_value(\u0026request).unwrap();\n        assert_eq!(json[\"weekday\"], serde_json::json!(2));\n        assert_eq!(json[\"starts_on\"], serde_json::json!(\"2025-01-08\"));\n        assert!(json.get(\"ends_on\").is_some());\n        assert!(json[\"ends_on\"].is_null());\n    }\n\n    #[wasm_bindgen_test]\n    fn deserialize_holiday_calendar_entry() {\n        let raw = r#\"{\"date\":\"2025-01-01\",\"reason\":\"public holiday\"}\"#;\n        let entry: HolidayCalendarEntry = serde_json::from_str(raw).unwrap();\n        assert_eq!(entry.date, NaiveDate::from_ymd_opt(2025, 1, 1).unwrap());\n        assert_eq!(entry.reason, \"public holiday\");\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","cards.rs"],"content":"use chrono::{Datelike, Timelike};\nuse leptos::*;\n\nuse crate::state::attendance::AttendanceState;\nuse crate::utils::time::today_in_app_tz;\n\n#[component]\npub fn AttendanceCard(attendance_state: ReadSignal\u003cAttendanceState\u003e) -\u003e impl IntoView {\n    let today = today_in_app_tz();\n\n    let clock_in = move || {\n        attendance_state\n            .get()\n            .today_status\n            .as_ref()\n            .and_then(|s| s.clock_in_time)\n            .map(|t| format!(\"{:02}:{:02}\", t.hour(), t.minute()))\n            .unwrap_or_else(|| \"-\".into())\n    };\n    let clock_out = move || {\n        attendance_state\n            .get()\n            .today_status\n            .as_ref()\n            .and_then(|s| s.clock_out_time)\n            .map(|t| format!(\"{:02}:{:02}\", t.hour(), t.minute()))\n            .unwrap_or_else(|| \"-\".into())\n    };\n    let total_hours = move || {\n        attendance_state\n            .get()\n            .attendance_history\n            .iter()\n            .find(|a| a.date == today)\n            .and_then(|a| a.total_work_hours)\n            .map(|h| format!(\"{:.2}時間\", h))\n            .unwrap_or_else(|| \"-\".into())\n    };\n    let break_minutes = move || {\n        let mins: i32 = attendance_state\n            .get()\n            .attendance_history\n            .iter()\n            .find(|a| a.date == today)\n            .map(|a| {\n                a.break_records\n                    .iter()\n                    .map(|b| b.duration_minutes.unwrap_or(0))\n                    .sum()\n            })\n            .unwrap_or(0);\n        if mins \u003e 0 {\n            format!(\"{} 分\", mins)\n        } else {\n            \"-\".into()\n        }\n    };\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated overflow-hidden shadow rounded-lg\"\u003e\n            \u003cdiv class=\"px-4 py-5 sm:p-6\"\u003e\n                \u003ch3 class=\"text-lg leading-6 font-medium text-fg\"\u003e\n                    {format!(\"今日の勤怠 ({:04}-{:02}-{:02})\", today.year(), today.month(), today.day())}\n                \u003c/h3\u003e\n                \u003cdiv class=\"mt-5\"\u003e\n                    \u003cdiv class=\"grid grid-cols-2 gap-4\"\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"出勤時間\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-sm text-fg\"\u003e{clock_in}\u003c/dd\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"退勤時間\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-sm text-fg\"\u003e{clock_out}\u003c/dd\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"稼働時間\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-sm text-fg\"\u003e{total_hours}\u003c/dd\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"休憩合計\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-sm text-fg\"\u003e{break_minutes}\u003c/dd\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn SummaryCard(\n    summary: Resource\u003c(), Result\u003ccrate::pages::dashboard::repository::DashboardSummary, String\u003e\u003e,\n) -\u003e impl IntoView {\n    let summary_val = move || summary.get().and_then(|res| res.ok());\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated overflow-hidden shadow rounded-lg\"\u003e\n            \u003cdiv class=\"px-4 py-5 sm:p-6\"\u003e\n                \u003ch3 class=\"text-lg leading-6 font-medium text-fg\"\u003e{\"今月のサマリー\"}\u003c/h3\u003e\n                \u003cdiv class=\"mt-5\"\u003e\n                    \u003cdiv class=\"grid grid-cols-3 gap-4\"\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"総稼働時間\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-2xl font-semibold text-fg\"\u003e\n                                {move || summary_val().and_then(|s| s.total_work_hours).map(|h| format!(\"{:.2}時間\", h)).unwrap_or_else(|| \"-\".into())}\n                            \u003c/dd\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"稼働日数\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-2xl font-semibold text-fg\"\u003e\n                                {move || summary_val().and_then(|s| s.total_work_days).map(|d| format!(\"{} 日\", d)).unwrap_or_else(|| \"-\".into())}\n                            \u003c/dd\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"平均稼働時間\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-2xl font-semibold text-fg\"\u003e\n                                {move || summary_val().and_then(|s| s.average_daily_hours).map(|h| format!(\"{:.2}時間\", h)).unwrap_or_else(|| \"-\".into())}\n                            \u003c/dd\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn RequestCard(\n    requests: Resource\u003c\n        crate::pages::dashboard::utils::ActivityStatusFilter,\n        Result\u003cVec\u003ccrate::pages::dashboard::repository::DashboardActivity\u003e, String\u003e,\n    \u003e,\n) -\u003e impl IntoView {\n    let activities = move || requests.get().and_then(|res| res.ok()).unwrap_or_default();\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated overflow-hidden shadow rounded-lg\"\u003e\n            \u003cdiv class=\"px-4 py-5 sm:p-6\"\u003e\n                \u003ch3 class=\"text-lg leading-6 font-medium text-fg\"\u003e{\"申請状況\"}\u003c/h3\u003e\n                \u003cdiv class=\"mt-5 space-y-2\"\u003e\n                    \u003cFor\n                        each=activities\n                        key=|a| a.title.clone()\n                        children=|a| {\n                            view! {\n                                \u003cdiv class=\"text-sm text-fg\"\u003e\n                                    {a.title} {\": \"} {a.detail.unwrap_or_else(|| \"-\".into())}\n                                \u003c/div\u003e\n                            }\n                        }\n                    /\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn UserCard() -\u003e impl IntoView {\n    use crate::state::auth::use_auth;\n    let (auth, _) = use_auth();\n    view! {\n        \u003cdiv class=\"bg-surface-elevated overflow-hidden shadow rounded-lg\"\u003e\n            \u003cdiv class=\"px-4 py-5 sm:p-6\"\u003e\n                \u003ch3 class=\"text-lg leading-6 font-medium text-fg\"\u003e{\"ユーザー情報\"}\u003c/h3\u003e\n                \u003cdiv class=\"mt-5\"\u003e\n                    \u003cdiv class=\"space-y-2\"\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"ユーザー名\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-sm text-fg\"\u003e{move || auth.get().user.as_ref().map(|u| u.username.clone()).unwrap_or_else(|| \"-\".into())}\u003c/dd\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"氏名\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-sm text-fg\"\u003e{move || auth.get().user.as_ref().map(|u| u.full_name.clone()).unwrap_or_else(|| \"-\".into())}\u003c/dd\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdt class=\"text-sm font-medium text-fg-muted\"\u003e{\"役割\"}\u003c/dt\u003e\n                            \u003cdd class=\"mt-1 text-sm text-fg\"\u003e{move || auth.get().user.as_ref().map(|u| u.role.clone()).unwrap_or_else(|| \"-\".into())}\u003c/dd\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","common.rs"],"content":"use leptos::*;\n\n#[derive(Clone, Copy, Debug, PartialEq, Eq, Default)]\npub enum ButtonVariant {\n    #[default]\n    Primary,\n}\n\nimpl ButtonVariant {\n    pub fn classes(\u0026self) -\u003e \u0026'static str {\n        match self {\n            ButtonVariant::Primary =\u003e \"bg-action-primary-bg hover:bg-action-primary-bg-hover text-action-primary-text shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-action-primary-focus\",\n        }\n    }\n}\n\n#[component]\npub fn Button(\n    #[prop(optional)] variant: ButtonVariant,\n    #[prop(optional, into)] class: String,\n    #[prop(optional, into)] disabled: MaybeSignal\u003cbool\u003e,\n    #[prop(optional, into)] loading: MaybeSignal\u003cbool\u003e,\n    #[prop(attrs)] attributes: Vec\u003c(\u0026'static str, Attribute)\u003e,\n    children: Children,\n) -\u003e impl IntoView {\n    view! {\n        \u003cbutton\n            class=move || {\n                format!(\n                    \"inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-semibold transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed {} {}\",\n                    variant.classes(),\n                    class\n                )\n            }\n            disabled=move || disabled.get() || loading.get()\n            {..attributes}\n        \u003e\n            \u003cShow when=move || loading.get()\u003e\n                \u003cspan class=\"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent\"\u003e\u003c/span\u003e\n            \u003c/Show\u003e\n            {children()}\n        \u003c/button\u003e\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn primary_variant_includes_primary_class() {\n        let classes = ButtonVariant::Primary.classes();\n        assert!(classes.contains(\"bg-action-primary-bg\"));\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","empty_state.rs"],"content":"use leptos::*;\n\n#[component]\npub fn EmptyState(\n    #[prop(into)] title: String,\n    #[prop(optional, into)] description: Option\u003cString\u003e,\n    #[prop(optional)] icon: Option\u003cView\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"text-center py-12 px-4 rounded-lg border-2 border-dashed border-border-strong bg-surface-muted\"\u003e\n            \u003cdiv class=\"mx-auto h-12 w-12 text-fg-muted\"\u003e\n                {icon.unwrap_or_else(|| view! {\n                    \u003csvg class=\"mx-auto h-12 w-12 text-fg-muted\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" aria-hidden=\"true\"\u003e\n                        \u003cpath vector-effect=\"non-scaling-stroke\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z\" /\u003e\n                    \u003c/svg\u003e\n                }.into_view())}\n            \u003c/div\u003e\n            \u003ch3 class=\"mt-2 text-sm font-semibold text-fg\"\u003e{title}\u003c/h3\u003e\n            {move || description.clone().map(|desc| view! {\n                \u003cp class=\"mt-1 text-sm text-fg-muted\"\u003e{desc}\u003c/p\u003e\n            })}\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","error.rs"],"content":"use crate::api::ApiError;\nuse leptos::*;\n\n#[component]\npub fn InlineErrorMessage(error: Signal\u003cOption\u003cApiError\u003e\u003e) -\u003e impl IntoView {\n    view! {\n        \u003cShow when=move || error.get().is_some() fallback=|| ()\u003e\n            \u003cdiv class=\"bg-status-error-bg border border-status-error-border text-status-error-text px-4 py-3 rounded space-y-1 my-2\"\u003e\n                \u003cdiv class=\"font-bold\"\u003e{move || error.get().map(|e| e.error).unwrap_or_default()}\u003c/div\u003e\n                {move || error.get().map(|e| {\n                    let code = \u0026e.code;\n                    let details = e.details.as_ref();\n                    if code == \"VALIDATION_ERROR\" {\n                        if let Some(details) = details {\n                            if let Some(errors) = details.get(\"errors\").and_then(|v| v.as_array()) {\n                                return view! {\n                                    \u003cul class=\"list-disc list-inside text-sm\"\u003e\n                                        {errors.iter().map(|err| {\n                                            view! { \u003cli\u003e{err.as_str().unwrap_or_default().to_string()}\u003c/li\u003e }\n                                        }).collect_view()}\n                                    \u003c/ul\u003e\n                                }.into_view();\n                            }\n                        }\n                    }\n                    if code != \"UNKNOWN\" \u0026\u0026 !code.is_empty() {\n                         view! { \u003cdiv class=\"text-xs opacity-75\"\u003e{\"Code: \"}{code.clone()}\u003c/div\u003e }.into_view()\n                    } else {\n                        ().into_view()\n                    }\n                }).unwrap_or_else(|| ().into_view())}\n            \u003c/div\u003e\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","forms.rs"],"content":"use crate::state::attendance::{describe_holiday_reason, AttendanceState, ClockMessage};\nuse chrono::{Datelike, NaiveDate};\nuse leptos::{ev::MouseEvent, *};\nuse wasm_bindgen::JsCast;\n\n#[derive(Clone, Copy, Debug, Default, PartialEq, Eq)]\nstruct AttendanceButtonFlags {\n    clock_in: bool,\n    break_start: bool,\n    break_end: bool,\n    clock_out: bool,\n}\n\nfn button_flags_for(status: Option\u003c\u0026str\u003e, loading: bool) -\u003e AttendanceButtonFlags {\n    if loading {\n        return AttendanceButtonFlags::default();\n    }\n\n    match status.unwrap_or(\"not_started\") {\n        \"not_started\" =\u003e AttendanceButtonFlags {\n            clock_in: true,\n            ..Default::default()\n        },\n        \"clocked_in\" =\u003e AttendanceButtonFlags {\n            break_start: true,\n            clock_out: true,\n            ..Default::default()\n        },\n        \"on_break\" =\u003e AttendanceButtonFlags {\n            break_end: true,\n            clock_out: true,\n            ..Default::default()\n        },\n        \"clocked_out\" =\u003e AttendanceButtonFlags::default(),\n        _ =\u003e AttendanceButtonFlags::default(),\n    }\n}\n\n#[component]\npub fn AttendanceActionButtons(\n    attendance_state: ReadSignal\u003cAttendanceState\u003e,\n    action_pending: ReadSignal\u003cbool\u003e,\n    message: ReadSignal\u003cOption\u003cClockMessage\u003e\u003e,\n    on_clock_in: Callback\u003cMouseEvent\u003e,\n    on_clock_out: Callback\u003cMouseEvent\u003e,\n    on_break_start: Callback\u003cMouseEvent\u003e,\n    on_break_end: Callback\u003cMouseEvent\u003e,\n) -\u003e impl IntoView {\n    let status_snapshot = move || attendance_state.get().today_status.clone();\n    let holiday_reason = create_memo(move |_| attendance_state.get().today_holiday_reason.clone());\n\n    let button_state = move || {\n        let flags = button_flags_for(\n            status_snapshot().as_ref().map(|s| s.status.as_str()),\n            action_pending.get(),\n        );\n        if holiday_reason.get().is_some() {\n            AttendanceButtonFlags::default()\n        } else {\n            flags\n        }\n    };\n\n    view! {\n        \u003cdiv class=\"space-y-6 animate-fade-in\"\u003e\n            \u003cdiv class=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4 p-4 rounded-2xl bg-surface-muted border border-border\"\u003e\n                \u003cdiv class=\"flex items-center gap-3\"\u003e\n                    \u003cdiv class=\"w-10 h-10 flex items-center justify-center rounded-xl bg-surface-elevated shadow-sm text-action-primary-bg\"\u003e\n                        \u003ci class=\"fas fa-user-clock text-lg\"\u003e\u003c/i\u003e\n                    \u003c/div\u003e\n                    \u003cdiv\u003e\n                        \u003cp class=\"text-xs font-display font-bold text-action-primary-bg uppercase tracking-wider\"\u003e{\"現在のステータス\"}\u003c/p\u003e\n                        {move || {\n                            let status = status_snapshot();\n                            let (label, color, dot_color) = match status.as_ref().map(|s| s.status.as_str()) {\n                                Some(\"clocked_in\") =\u003e (\"勤務中\", \"text-status-attendance-text-active\", \"bg-status-attendance-clock_in animate-pulse\"),\n                                Some(\"on_break\") =\u003e (\"休憩中\", \"text-status-attendance-text-active\", \"bg-status-attendance-break animate-pulse\"),\n                                Some(\"clocked_out\") =\u003e (\"退勤済み\", \"text-status-attendance-text-inactive\", \"bg-status-attendance-clock_out\"),\n                                _ =\u003e (\"未出勤\", \"text-status-attendance-text-inactive\", \"bg-status-attendance-not_started\"),\n                            };\n                            view! {\n                                \u003cdiv class=\"flex items-center gap-2 mt-0.5\"\u003e\n                                    \u003cspan class=format!(\"w-2 h-2 rounded-full {}\", dot_color)\u003e\u003c/span\u003e\n                                    \u003cspan class=format!(\"text-lg font-bold {}\", color)\u003e{label}\u003c/span\u003e\n                                \u003c/div\u003e\n                            }.into_view()\n                        }}\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n\n            \u003cdiv class=\"grid grid-cols-2 gap-3\"\u003e\n                \u003cbutton\n                    class=\"group relative flex flex-col items-center justify-center p-4 rounded-2xl border-2 transition-all duration-200 transform active:scale-95 disabled:opacity-40 disabled:active:scale-100\n                           border-status-attendance-clock_in bg-status-attendance-clock_in text-text-inverse shadow-lg hover:bg-action-primary-bg-hover hover:border-action-primary-border-hover disabled:border-state-disabled-border disabled:bg-state-disabled-bg disabled:text-state-disabled-text disabled:shadow-none\"\n                    disabled={move || !button_state().clock_in}\n                    on:click=move |ev| on_clock_in.call(ev)\n                \u003e\n                    \u003ci class=\"fas fa-sign-in-alt text-xl mb-2 group-disabled:text-state-disabled-text\"\u003e\u003c/i\u003e\n                    \u003cspan class=\"font-bold\"\u003e{\"出勤\"}\u003c/span\u003e\n                \u003c/button\u003e\n\n                \u003cbutton\n                    class=\"group relative flex flex-col items-center justify-center p-4 rounded-2xl border-2 transition-all duration-200 transform active:scale-95 disabled:opacity-40 disabled:active:scale-100\n                           border-status-attendance-break bg-surface-elevated text-status-attendance-break hover:bg-status-warning-bg disabled:border-state-disabled-border disabled:bg-state-disabled-bg disabled:text-state-disabled-text\"\n                    disabled={move || !button_state().break_start}\n                    on:click=move |ev| on_break_start.call(ev)\n                \u003e\n                    \u003ci class=\"fas fa-coffee text-xl mb-2 group-disabled:text-state-disabled-text\"\u003e\u003c/i\u003e\n                    \u003cspan class=\"font-bold\"\u003e{\"休憩開始\"}\u003c/span\u003e\n                \u003c/button\u003e\n\n                \u003cbutton\n                    class=\"group relative flex flex-col items-center justify-center p-4 rounded-2xl border-2 transition-all duration-200 transform active:scale-95 disabled:opacity-40 disabled:active:scale-100\n                           border-status-attendance-break bg-status-attendance-break text-text-inverse shadow-lg hover:bg-status-warning-text disabled:border-state-disabled-border disabled:bg-state-disabled-bg disabled:text-state-disabled-text disabled:shadow-none\"\n                    disabled={move || !button_state().break_end}\n                    on:click=move |ev| on_break_end.call(ev)\n                \u003e\n                    \u003ci class=\"fas fa-mug-hot text-xl mb-2 group-disabled:text-state-disabled-text\"\u003e\u003c/i\u003e\n                    \u003cspan class=\"font-bold\"\u003e{\"休憩終了\"}\u003c/span\u003e\n                \u003c/button\u003e\n\n                \u003cbutton\n                    class=\"group relative flex flex-col items-center justify-center p-4 rounded-2xl border-2 transition-all duration-200 transform active:scale-95 disabled:opacity-40 disabled:active:scale-100\n                           border-action-danger-border bg-surface-elevated text-action-danger-bg hover:bg-status-error-bg disabled:border-state-disabled-border disabled:bg-state-disabled-bg disabled:text-state-disabled-text\"\n                    disabled={move || !button_state().clock_out}\n                    on:click=move |ev| on_clock_out.call(ev)\n                \u003e\n                    \u003ci class=\"fas fa-sign-out-alt text-xl mb-2 group-disabled:text-state-disabled-text\"\u003e\u003c/i\u003e\n                    \u003cspan class=\"font-bold\"\u003e{\"退勤\"}\u003c/span\u003e\n                \u003c/button\u003e\n            \u003c/div\u003e\n\n            {move || {\n                holiday_reason\n                    .get()\n                    .map(|reason| {\n                        let label = describe_holiday_reason(reason.trim());\n                        view! {\n                            \u003cdiv class=\"flex items-center gap-3 p-4 rounded-2xl bg-status-warning-bg border border-status-warning-border text-status-warning-text animate-pop-in\"\u003e\n                                \u003ci class=\"fas fa-calendar-day text-status-warning-text text-xl\"\u003e\u003c/i\u003e\n                                \u003cspan class=\"text-sm font-medium\"\u003e{format!(\"本日は{}のため打刻できません。\", label)}\u003c/span\u003e\n                            \u003c/div\u003e\n                        }\n                        .into_view()\n                    })\n                    .unwrap_or_else(|| view! {}.into_view())\n            }}\n\n            \u003cShow when=move || action_pending.get()\u003e\n                \u003cdiv class=\"flex items-center justify-center gap-2 py-2 text-action-primary-bg\"\u003e\n                    \u003cdiv class=\"animate-spin rounded-full h-4 w-4 border-b-2 border-current\"\u003e\u003c/div\u003e\n                    \u003cp class=\"text-sm font-medium\"\u003e{\"処理中...\"}\u003c/p\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n\n            {move || {\n                message\n                    .get()\n                    .map(|message| {\n                        let (text, is_error) = match message {\n                            ClockMessage::Success(text) =\u003e (text, false),\n                            ClockMessage::Error(err) =\u003e (err.error, true),\n                        };\n                        let (bg, border, color, icon) = if is_error {\n                            (\n                                \"bg-status-error-bg\",\n                                \"border-status-error-border\",\n                                \"text-status-error-text\",\n                                \"fa-exclamation-circle\",\n                            )\n                        } else {\n                            (\n                                \"bg-status-success-bg\",\n                                \"border-status-success-border\",\n                                \"text-status-success-text\",\n                                \"fa-check-circle\",\n                            )\n                        };\n                        view! {\n                            \u003cdiv class=format!(\"flex items-center gap-2 p-3 rounded-xl border {} {} {} animate-pop-in\", bg, border, color)\u003e\n                                \u003ci class=format!(\"fas {}\", icon)\u003e\u003c/i\u003e\n                                \u003cp class=\"text-sm font-medium\"\u003e{text}\u003c/p\u003e\n                            \u003c/div\u003e\n                        }\n                        .into_view()\n                    })\n                    .unwrap_or_else(|| view! {}.into_view())\n            }}\n        \u003c/div\u003e\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn button_flags_follow_status() {\n        let flags = button_flags_for(Some(\"not_started\"), false);\n        assert!(flags.clock_in);\n        assert!(!flags.clock_out);\n\n        let flags = button_flags_for(Some(\"clocked_in\"), false);\n        assert!(flags.break_start);\n        assert!(flags.clock_out);\n\n        let flags = button_flags_for(Some(\"on_break\"), false);\n        assert!(flags.break_end);\n        assert!(flags.clock_out);\n\n        let flags = button_flags_for(Some(\"clocked_out\"), false);\n        assert!(!flags.clock_in);\n        assert!(!flags.clock_out);\n    }\n\n    #[test]\n    fn loading_disables_buttons() {\n        let flags = button_flags_for(Some(\"clocked_in\"), true);\n        assert!(!flags.clock_in);\n        assert!(!flags.break_start);\n        assert!(!flags.break_end);\n        assert!(!flags.clock_out);\n    }\n}\n\n#[component]\npub fn DatePicker(\n    #[prop(into)] value: RwSignal\u003cString\u003e,\n    label: Option\u003c\u0026'static str\u003e,\n    #[prop(optional)] disabled: MaybeSignal\u003cbool\u003e,\n) -\u003e impl IntoView {\n    let input_ref = create_node_ref::\u003chtml::Input\u003e();\n\n    let display_value = move || {\n        let val = value.get();\n        if val.is_empty() {\n            return \"日付を選択\".to_string();\n        }\n        if let Ok(date) = NaiveDate::parse_from_str(\u0026val, \"%Y-%m-%d\") {\n            let day_of_week = match date.weekday() {\n                chrono::Weekday::Mon =\u003e \"月\",\n                chrono::Weekday::Tue =\u003e \"火\",\n                chrono::Weekday::Wed =\u003e \"水\",\n                chrono::Weekday::Thu =\u003e \"木\",\n                chrono::Weekday::Fri =\u003e \"金\",\n                chrono::Weekday::Sat =\u003e \"土\",\n                chrono::Weekday::Sun =\u003e \"日\",\n            };\n            format!(\"{} ({})\", date.format(\"%Y/%m/%d\"), day_of_week)\n        } else {\n            val\n        }\n    };\n\n    let on_click = move |_| {\n        if disabled.get() {\n            return;\n        }\n        if let Some(input) = input_ref.get() {\n            // Try showPicker()\n            let _ = js_sys::Reflect::get(\u0026input, \u0026\"showPicker\".into()).map(|f| {\n                if f.is_function() {\n                    let _ = js_sys::Reflect::apply(\n                        \u0026f.unchecked_into::\u003cjs_sys::Function\u003e(),\n                        \u0026input,\n                        \u0026js_sys::Array::new(),\n                    );\n                }\n            });\n            // Always focus as fallback/additional trigger\n            let _ = input.focus();\n        }\n    };\n\n    view! {\n        \u003cdiv class=\"flex flex-col gap-1.5 w-full\"\u003e\n            {label.map(|l| view! { \u003clabel class=\"text-sm font-bold text-fg-muted ml-1\"\u003e{l}\u003c/label\u003e })}\n            \u003cdiv\n                class=move || format!(\n                    \"relative group cursor-pointer rounded-xl border-2 transition-all duration-200 bg-form-control-bg py-2.5 px-4 flex items-center justify-between shadow-sm border-form-control-border hover:border-action-primary-border-hover hover:shadow-md active:scale-[0.98] {}\",\n                    if disabled.get() { \"opacity-50 cursor-not-allowed bg-state-disabled-bg border-state-disabled-border text-state-disabled-text shadow-none touch-none\" } else { \"hover:ring-4 hover:ring-action-primary-focus\" }\n                )\n                on:click=on_click\n            \u003e\n                \u003cdiv class=\"flex items-center gap-3\"\u003e\n                    \u003cdiv class=move || format!(\n                        \"w-8 h-8 rounded-lg flex items-center justify-center transition-colors {}\",\n                        if value.get().is_empty() { \"bg-surface-muted text-text-muted\" } else { \"bg-primary-subtle text-action-primary-bg\" }\n                    )\u003e\n                        \u003ci class=\"far fa-calendar-alt text-base\"\u003e\u003c/i\u003e\n                    \u003c/div\u003e\n                    \u003cspan class=move || format!(\n                        \"text-sm font-semibold tracking-wide {}\",\n                        if value.get().is_empty() { \"text-text-muted\" } else { \"text-fg\" }\n                    )\u003e\n                        {display_value}\n                    \u003c/span\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"text-fg-muted group-hover:text-action-primary-bg transition-colors\"\u003e\n                    \u003ci class=\"fas fa-chevron-down text-xs\"\u003e\u003c/i\u003e\n                \u003c/div\u003e\n\n                // Hidden native input\n                \u003cinput\n                    type=\"date\"\n                    node_ref=input_ref\n                    class=\"absolute inset-0 w-full h-full opacity-0 pointer-events-none\"\n                    disabled=disabled\n                    prop:value={move || value.get()}\n                    on:input=move |ev| value.set(event_target_value(\u0026ev))\n                /\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","guard.rs"],"content":"use crate::{components::layout::LoadingSpinner, state::auth::use_auth};\nuse leptos::*;\n\n#[component]\npub fn RequireAuth(children: ChildrenFn) -\u003e impl IntoView {\n    let (auth, _) = use_auth();\n    let is_authenticated = create_memo(move |_| auth.get().is_authenticated);\n    let is_loading = create_memo(move |_| auth.get().loading);\n    create_effect(move |_| {\n        let state = auth.get();\n        if state.loading || state.is_authenticated {\n            return;\n        }\n        if let Some(win) = web_sys::window() {\n            let _ = win.location().set_href(\"/login\");\n        }\n    });\n    view! {\n        \u003cShow\n            when=move || should_render_children(is_authenticated.get(), is_loading.get())\n            fallback=move || {\n                if is_loading.get() {\n                    view! { \u003cLoadingSpinner /\u003e }.into_view()\n                } else {\n                    ().into_view()\n                }\n            }\n        \u003e\n            {children()}\n        \u003c/Show\u003e\n    }\n}\n\nfn should_render_children(is_authenticated: bool, is_loading: bool) -\u003e bool {\n    is_authenticated \u0026\u0026 !is_loading\n}\n\n#[cfg(test)]\nmod tests {\n    use super::should_render_children;\n\n    #[test]\n    fn guard_blocks_until_authenticated() {\n        assert!(!should_render_children(false, true));\n        assert!(!should_render_children(false, false));\n        assert!(!should_render_children(true, true));\n        assert!(should_render_children(true, false));\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","layout.rs"],"content":"use crate::state::auth::{self, use_auth};\nuse leptos::*;\n\n#[component]\npub fn Header() -\u003e impl IntoView {\n    let (auth, _set_auth) = use_auth();\n    let (menu_open, set_menu_open) = create_signal(false);\n    let can_access_admin = move || {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin || user.role.eq_ignore_ascii_case(\"admin\"))\n            .unwrap_or(false)\n    };\n    let can_manage_users = move || {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin)\n            .unwrap_or(false)\n    };\n    let logout_action = auth::use_logout_action();\n    let logout_pending = logout_action.pending();\n    {\n        create_effect(move |_| {\n            if logout_action.value().get().is_some() {\n                if let Some(win) = web_sys::window() {\n                    let _ = win.location().set_href(\"/login\");\n                }\n            }\n        });\n    }\n    let on_logout = {\n        move |_| {\n            if logout_pending.get_untracked() {\n                return;\n            }\n            set_menu_open.set(false);\n            logout_action.dispatch(false);\n        }\n    };\n    let toggle_menu = { move |_| set_menu_open.update(|open| *open = !*open) };\n    view! {\n        \u003cheader class=\"bg-surface-elevated shadow-sm border-b border-border\"\u003e\n            \u003cdiv class=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\"\u003e\n                \u003cdiv class=\"flex justify-between items-center h-16\"\u003e\n                    \u003cdiv class=\"flex items-center\"\u003e\n                        \u003ch1 class=\"text-xl font-semibold text-fg\"\u003e\n                            \"Timekeeper\"\n                        \u003c/h1\u003e\n                    \u003c/div\u003e\n                    \u003cdiv class=\"flex items-center\"\u003e\n                        \u003cnav class=\"hidden lg:flex space-x-4\"\u003e\n                            \u003ca href=\"/dashboard\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                \"ダッシュボード\"\n                            \u003c/a\u003e\n                            \u003ca href=\"/attendance\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                \"勤怠\"\n                            \u003c/a\u003e\n                            \u003ca href=\"/requests\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                \"申請\"\n                            \u003c/a\u003e\n                            \u003ca href=\"/settings\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                \"設定\"\n                            \u003c/a\u003e\n                            \u003cShow when=move || can_access_admin()\u003e\n                                \u003ca href=\"/admin\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                    \"管理\"\n                                \u003c/a\u003e\n                                \u003ca href=\"/admin/export\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                    \"データエクスポート\"\n                                \u003c/a\u003e\n                                \u003ca href=\"/admin/audit-logs\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                    \"監査ログ\"\n                                \u003c/a\u003e\n                            \u003c/Show\u003e\n                            \u003cShow when=move || can_manage_users()\u003e\n                                \u003ca href=\"/admin/users\" class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\u003e\n                                    \"ユーザー追加\"\n                                \u003c/a\u003e\n                            \u003c/Show\u003e\n                            \u003cbutton\n                                on:click=on_logout\n                                class=\"text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium disabled:opacity-50 hover:bg-action-ghost-bg-hover\"\n                                disabled={move || logout_pending.get()}\n                            \u003e\n                                \"ログアウト\"\n                            \u003c/button\u003e\n                        \u003c/nav\u003e\n                        \u003cbutton\n                            type=\"button\"\n                            class=\"lg:hidden inline-flex items-center justify-center p-2 rounded-md text-fg-muted hover:text-fg hover:bg-action-ghost-bg-hover\"\n                            on:click=toggle_menu\n                            aria-expanded=move || menu_open.get()\n                            aria-controls=\"mobile-nav\"\n                        \u003e\n                            \u003cspan class=\"sr-only\"\u003e\n                                {move || if menu_open.get() { \"メニューを閉じる\" } else { \"メニューを開く\" }}\n                            \u003c/span\u003e\n                            \u003csvg\n                                class=\"h-6 w-6\"\n                                xmlns=\"http://www.w3.org/2000/svg\"\n                                fill=\"none\"\n                                viewBox=\"0 0 24 24\"\n                                stroke=\"currentColor\"\n                            \u003e\n                                \u003cShow\n                                    when=move || menu_open.get()\n                                    fallback=move || {\n                                        view! {\n                                            \u003cpath\n                                                stroke-linecap=\"round\"\n                                                stroke-linejoin=\"round\"\n                                                stroke-width=\"2\"\n                                                d=\"M4 6h16M4 12h16M4 18h16\"\n                                            /\u003e\n                                        }\n                                    }\n                                \u003e\n                                    \u003cpath\n                                        stroke-linecap=\"round\"\n                                        stroke-linejoin=\"round\"\n                                        stroke-width=\"2\"\n                                        d=\"M6 18L18 6M6 6l12 12\"\n                                    /\u003e\n                                \u003c/Show\u003e\n                            \u003c/svg\u003e\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n                \u003cShow when=move || menu_open.get()\u003e\n                    \u003cdiv id=\"mobile-nav\" class=\"lg:hidden border-t border-border\"\u003e\n                        \u003cnav class=\"px-4 py-3 space-y-2\"\u003e\n                            \u003ca\n                                href=\"/dashboard\"\n                                class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                on:click=move |_| set_menu_open.set(false)\n                            \u003e\n                                \"ダッシュボード\"\n                            \u003c/a\u003e\n                            \u003ca\n                                href=\"/attendance\"\n                                class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                on:click=move |_| set_menu_open.set(false)\n                            \u003e\n                                \"勤怠\"\n                            \u003c/a\u003e\n                            \u003ca\n                                href=\"/requests\"\n                                class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                on:click=move |_| set_menu_open.set(false)\n                            \u003e\n                                \"申請\"\n                            \u003c/a\u003e\n                            \u003ca\n                                href=\"/settings\"\n                                class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                on:click=move |_| set_menu_open.set(false)\n                            \u003e\n                                \"設定\"\n                            \u003c/a\u003e\n                            \u003cShow when=move || can_access_admin()\u003e\n                                \u003ca\n                                    href=\"/admin\"\n                                    class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                    on:click=move |_| set_menu_open.set(false)\n                                \u003e\n                                    \"管理\"\n                                \u003c/a\u003e\n                                \u003ca\n                                    href=\"/admin/export\"\n                                    class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                    on:click=move |_| set_menu_open.set(false)\n                                \u003e\n                                    \"データエクスポート\"\n                                \u003c/a\u003e\n                                \u003ca\n                                    href=\"/admin/audit-logs\"\n                                    class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                    on:click=move |_| set_menu_open.set(false)\n                                \u003e\n                                    \"監査ログ\"\n                                \u003c/a\u003e\n                            \u003c/Show\u003e\n                            \u003cShow when=move || can_manage_users()\u003e\n                                \u003ca\n                                    href=\"/admin/users\"\n                                    class=\"block text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium hover:bg-action-ghost-bg-hover\"\n                                    on:click=move |_| set_menu_open.set(false)\n                                \u003e\n                                    \"ユーザー追加\"\n                                \u003c/a\u003e\n                            \u003c/Show\u003e\n                            \u003cbutton\n                                on:click=on_logout\n                                class=\"w-full text-left text-fg-muted hover:text-fg px-3 py-2 rounded-md text-sm font-medium disabled:opacity-50 hover:bg-action-ghost-bg-hover\"\n                                disabled={move || logout_pending.get()}\n                            \u003e\n                                \"ログアウト\"\n                            \u003c/button\u003e\n                        \u003c/nav\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n        \u003c/header\u003e\n    }\n}\n\n#[component]\npub fn Layout(children: Children) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"min-h-screen bg-surface\"\u003e\n            \u003cHeader/\u003e\n            \u003cmain class=\"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8\"\u003e\n                \u003cTimeZoneWarningBanner/\u003e\n                {children()}\n            \u003c/main\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn TimeZoneWarningBanner() -\u003e impl IntoView {\n    let (config_read, config_write) = crate::state::config::use_config();\n    let status = Signal::derive(move || config_read.get().time_zone_status);\n\n    create_effect(move |_| {\n        spawn_local(async move {\n            let _ = crate::config::await_time_zone().await;\n            let current = crate::config::time_zone_status();\n            config_write.update(|s| s.time_zone_status = current);\n        });\n    });\n\n    let on_retry = move |_| {\n        if status.get_untracked().loading {\n            return;\n        }\n        spawn_local(async move {\n            crate::state::config::refresh_time_zone(config_write).await;\n        });\n    };\n\n    let should_show = move || {\n        let state = status.get();\n        state.is_fallback || state.last_error.is_some()\n    };\n\n    let warning_message = move || {\n        let state = status.get();\n        if state.loading {\n            \"バックエンドのタイムゾーン情報を再取得しています...\".to_string()\n        } else if let Some(err) = state.last_error.clone() {\n            format!(\n                \"サーバーのタイムゾーン情報を取得できませんでした ({})。現在 {} として動作しています。\",\n                err,\n                state.time_zone.clone().unwrap_or_else(|| \"UTC\".into())\n            )\n        } else {\n            format!(\n                \"サーバーのタイムゾーン情報を取得できず、現在 {} として動作しています。\",\n                state.time_zone.clone().unwrap_or_else(|| \"UTC\".into())\n            )\n        }\n    };\n\n    let refreshing = Signal::derive(move || status.get().loading);\n\n    view! {\n        \u003cShow when=should_show\u003e\n            \u003cdiv class=\"mb-4\"\u003e\n                \u003cdiv class=\"bg-status-warning-bg border border-status-warning-border text-status-warning-text px-4 py-3 rounded\"\u003e\n                    \u003cdiv class=\"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\"\u003e\n                        \u003cdiv\u003e\n                            \u003cp class=\"font-semibold\"\u003e{\"タイムゾーン情報に関する警告\"}\u003c/p\u003e\n                            \u003cp class=\"text-sm mt-1\"\u003e{warning_message}\u003c/p\u003e\n                        \u003c/div\u003e\n                        \u003cbutton\n                            class=\"inline-flex items-center justify-center px-4 py-2 border border-status-warning-border text-sm font-medium rounded text-status-warning-text hover:bg-status-warning-bg disabled:opacity-60\"\n                            on:click=on_retry\n                            disabled=move || refreshing.get()\n                        \u003e\n                            {move || if refreshing.get() { \"再取得中...\" } else { \"再取得\" }}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/Show\u003e\n    }\n}\n\n#[component]\npub fn LoadingSpinner() -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"flex justify-center items-center p-8\"\u003e\n            \u003cdiv class=\"animate-spin rounded-full h-8 w-8 border-b-2 border-action-primary-bg\"\u003e\u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn ErrorMessage(message: String) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-status-error-bg border border-status-error-border text-status-error-text px-4 py-3 rounded mb-4\"\u003e\n            \u003cdiv class=\"flex\"\u003e\n                \u003cdiv class=\"flex-shrink-0\"\u003e\n                    \u003ci class=\"fas fa-exclamation-circle\"\u003e\u003c/i\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"ml-3\"\u003e\n                    \u003cp class=\"text-sm\"\u003e{message}\u003c/p\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn SuccessMessage(message: String) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-status-success-bg border border-status-success-border text-status-success-text px-4 py-3 rounded mb-4\"\u003e\n            \u003cdiv class=\"flex\"\u003e\n                \u003cdiv class=\"flex-shrink-0\"\u003e\n                    \u003ci class=\"fas fa-check-circle\"\u003e\u003c/i\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"ml-3\"\u003e\n                    \u003cp class=\"text-sm\"\u003e{message}\u003c/p\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","mod.rs"],"content":"pub mod cards;\npub mod common;\npub mod empty_state;\npub mod error;\npub mod forms;\npub mod guard;\npub mod layout;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","components","theme.rs"],"content":"use crate::state::theme::{use_theme, Theme};\nuse leptos::*;\n\n#[component]\npub fn ThemeToggle() -\u003e impl IntoView {\n    let theme_state = use_theme();\n    let current_theme = theme_state.current();\n\n    let on_click = move |_| {\n        theme_state.toggle();\n    };\n\n    view! {\n        \u003cbutton\n            type=\"button\"\n            class=\"relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2\"\n            on:click=on_click\n            aria-label=\"Toggle theme\"\n        \u003e\n            \u003cspan class=\"sr-only\"\u003e\"Toggle theme\"\u003c/span\u003e\n\n            \u003cspan\n                class=move || {\n                    if current_theme.get() == Theme::Dark {\n                        \"translate-x-6 bg-primary-600\"\n                    } else {\n                        \"translate-x-1 bg-white\"\n                    }\n                }\n                class=\"inline-block h-4 w-4 transform rounded-full bg-white transition-transform shadow-theme-switch\"\n            /\u003e\n\n            \u003cspan\n                class=move || {\n                    if current_theme.get() == Theme::Dark {\n                        \"opacity-100\"\n                    } else {\n                        \"opacity-0\"\n                    }\n                }\n                class=\"absolute left-1 top-1/2 -translate-y-1/2 text-xs text-gray-400 transition-opacity\"\n            \u003e\n                \u003ci class=\"fas fa-moon\"\u003e\u003c/i\u003e\n            \u003c/span\u003e\n\n            \u003cspan\n                class=move || {\n                    if current_theme.get() == Theme::Light || current_theme.get() == Theme::HighContrast {\n                        \"opacity-100\"\n                    } else {\n                        \"opacity-0\"\n                    }\n                }\n                class=\"absolute right-1 top-1/2 -translate-y-1/2 text-xs text-yellow-500 transition-opacity\"\n            \u003e\n                \u003ci class=\"fas fa-sun\"\u003e\u003c/i\u003e\n            \u003c/span\u003e\n        \u003c/button\u003e\n    }\n}\n\n#[component]\npub fn ThemeProvider(children: Children) -\u003e impl IntoView {\n    let theme_state = crate::state::theme::provide_theme();\n\n    view! {\n        \u003cdiv class=move || theme_state.current().get().as_class()\u003e\n            {children()}\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","config.rs"],"content":"use crate::api::client::ApiClient;\nuse chrono_tz::Tz;\nuse serde::{Deserialize, Serialize};\n#[cfg(test)]\nuse std::sync::Mutex;\nuse std::sync::{OnceLock, RwLock};\n\n#[derive(Debug, Clone, Default, Serialize, Deserialize)]\npub struct RuntimeConfig {\n    pub api_base_url: Option\u003cString\u003e,\n}\n\nstatic API_BASE_URL: OnceLock\u003cString\u003e = OnceLock::new();\nstatic TIME_ZONE: OnceLock\u003cRwLock\u003cTimeZoneCache\u003e\u003e = OnceLock::new();\n#[cfg(test)]\nstatic TIME_ZONE_FETCH_OVERRIDE: OnceLock\u003cMutex\u003cVec\u003cResult\u003cString, String\u003e\u003e\u003e\u003e = OnceLock::new();\n\n#[derive(Debug, Clone, Default)]\nstruct TimeZoneCache {\n    value: Option\u003cString\u003e,\n    is_fallback: bool,\n    last_error: Option\u003cString\u003e,\n    loading: bool,\n}\n\nfn time_zone_cache() -\u003e \u0026'static RwLock\u003cTimeZoneCache\u003e {\n    TIME_ZONE.get_or_init(|| RwLock::new(TimeZoneCache::default()))\n}\n\n#[derive(Debug, Clone, Default, PartialEq, Eq)]\npub struct TimeZoneStatus {\n    pub time_zone: Option\u003cString\u003e,\n    pub is_fallback: bool,\n    pub last_error: Option\u003cString\u003e,\n    pub loading: bool,\n}\n\npub fn time_zone_status() -\u003e TimeZoneStatus {\n    let guard = time_zone_cache().read().unwrap();\n    TimeZoneStatus {\n        time_zone: guard.value.clone(),\n        is_fallback: guard.is_fallback,\n        last_error: guard.last_error.clone(),\n        loading: guard.loading,\n    }\n}\n\npub async fn refresh_time_zone() -\u003e TimeZoneStatus {\n    let _ = ensure_time_zone(true).await;\n    time_zone_status()\n}\n\n#[cfg(test)]\npub(crate) fn overwrite_time_zone_status_for_test(_status: TimeZoneStatus) {\n    let mut guard = time_zone_cache().write().unwrap();\n    guard.value = _status.time_zone.clone();\n    guard.is_fallback = _status.is_fallback;\n    guard.last_error = _status.last_error.clone();\n    guard.loading = _status.loading;\n}\n\n#[cfg(target_arch = \"wasm32\")]\nfn window() -\u003e Option\u003cweb_sys::Window\u003e {\n    web_sys::window()\n}\n\n#[cfg(not(target_arch = \"wasm32\"))]\nfn window() -\u003e Option\u003cweb_sys::Window\u003e {\n    None\n}\n\nfn get_window_object(name: \u0026str) -\u003e Option\u003cjs_sys::Object\u003e {\n    let win = window()?;\n    let any = js_sys::Reflect::get(\u0026win, \u0026name.into()).ok()?;\n    if any.is_undefined() || any.is_null() {\n        return None;\n    }\n    Some(js_sys::Object::from(any))\n}\n\nfn read_property(obj: \u0026js_sys::Object, key: \u0026str) -\u003e Option\u003cString\u003e {\n    js_sys::Reflect::get(obj, \u0026wasm_bindgen::JsValue::from_str(key))\n        .ok()\n        .filter(|v| !v.is_undefined() \u0026\u0026 !v.is_null())\n        .and_then(|v| v.as_string())\n}\n\nfn read_property_aliases(obj: \u0026js_sys::Object, keys: \u0026[\u0026str]) -\u003e Option\u003cString\u003e {\n    for key in keys {\n        if let Some(value) = read_property(obj, key) {\n            return Some(value);\n        }\n    }\n    None\n}\n\nfn get_env_value(keys: \u0026[\u0026str]) -\u003e Option\u003cString\u003e {\n    get_window_object(\"__TIMEKEEPER_ENV\").and_then(|obj| read_property_aliases(\u0026obj, keys))\n}\n\nfn get_window_config_value(keys: \u0026[\u0026str]) -\u003e Option\u003cString\u003e {\n    get_window_object(\"__TIMEKEEPER_CONFIG\").and_then(|obj| read_property_aliases(\u0026obj, keys))\n}\n\nfn snapshot_base_url_from_globals() -\u003e Option\u003cString\u003e {\n    if let Some(env_url) = get_env_value(\u0026[\"API_BASE_URL\", \"api_base_url\"]) {\n        return Some(env_url);\n    }\n    get_window_config_value(\u0026[\"api_base_url\", \"API_BASE_URL\"])\n}\n\nfn snapshot_time_zone_from_globals() -\u003e Option\u003cString\u003e {\n    get_env_value(\u0026[\"TIME_ZONE\", \"time_zone\"])\n}\n\nfn cache_base_url(value: \u0026str) -\u003e String {\n    let value = value.to_string();\n    let _ = API_BASE_URL.set(value.clone());\n    value\n}\n\nfn cache_time_zone(value: \u0026str, is_fallback: bool) -\u003e String {\n    let mut guard = time_zone_cache().write().unwrap();\n    guard.value = Some(value.to_string());\n    guard.is_fallback = is_fallback;\n    if !is_fallback {\n        guard.last_error = None;\n    }\n    guard.loading = false;\n    value.to_string()\n}\n\nfn mark_time_zone_loading() {\n    let mut guard = time_zone_cache().write().unwrap();\n    guard.loading = true;\n}\n\nfn mark_time_zone_error(message: String) -\u003e String {\n    let mut guard = time_zone_cache().write().unwrap();\n    guard.value = Some(\"UTC\".to_string());\n    guard.is_fallback = true;\n    guard.last_error = Some(message);\n    guard.loading = false;\n    \"UTC\".to_string()\n}\n\n#[cfg(test)]\npub(crate) fn queue_mock_time_zone_fetch(result: Result\u003cString, String\u003e) {\n    let mutex = TIME_ZONE_FETCH_OVERRIDE.get_or_init(|| Mutex::new(Vec::new()));\n    mutex.lock().unwrap().push(result);\n}\n\n#[cfg(test)]\nfn next_mock_time_zone_fetch() -\u003e Option\u003cResult\u003cString, String\u003e\u003e {\n    TIME_ZONE_FETCH_OVERRIDE\n        .get()\n        .and_then(|mutex| mutex.lock().ok().and_then(|mut stack| stack.pop()))\n}\n\nfn write_window_config(cfg: \u0026RuntimeConfig) {\n    let Some(w) = window() else {\n        return;\n    };\n    let obj = js_sys::Object::new();\n    if let Some(url) = \u0026cfg.api_base_url {\n        let _ = js_sys::Reflect::set(\n            \u0026obj,\n            \u0026\"api_base_url\".into(),\n            \u0026wasm_bindgen::JsValue::from_str(url),\n        );\n    }\n    let _ = js_sys::Reflect::set(\u0026w, \u0026\"__TIMEKEEPER_CONFIG\".into(), \u0026obj);\n}\n\nasync fn fetch_runtime_config() -\u003e Option\u003cRuntimeConfig\u003e {\n    let resp = reqwest::get(\"./config.json\").await.ok()?;\n    if !resp.status().is_success() {\n        return None;\n    }\n    resp.json::\u003cRuntimeConfig\u003e().await.ok()\n}\n\npub async fn await_api_base_url() -\u003e String {\n    if let Some(cached) = API_BASE_URL.get() {\n        return cached.clone();\n    }\n    if let Some(existing) = snapshot_base_url_from_globals() {\n        return cache_base_url(\u0026existing);\n    }\n    if let Some(cfg) = fetch_runtime_config().await {\n        write_window_config(\u0026cfg);\n        if let Some(url) = cfg.api_base_url {\n            return cache_base_url(\u0026url);\n        }\n    }\n    cache_base_url(\"http://localhost:3000/api\")\n}\n\nfn parse_time_zone(value: \u0026str) -\u003e Tz {\n    value.parse::\u003cTz\u003e().unwrap_or(chrono_tz::UTC)\n}\n\n#[derive(Deserialize)]\nstruct TimeZoneResponse {\n    time_zone: String,\n}\n\nasync fn fetch_time_zone_from_api(base_url: \u0026str) -\u003e Result\u003cString, String\u003e {\n    #[cfg(test)]\n    if let Some(result) = next_mock_time_zone_fetch() {\n        return result;\n    }\n\n    let client = reqwest::Client::new();\n    let trimmed = base_url.trim_end_matches('/');\n    let url = format!(\"{}/config/timezone\", trimmed);\n    let resp = ApiClient::with_credentials(client.get(\u0026url))\n        .send()\n        .await\n        .map_err(|e| format!(\"Failed to request {}: {}\", url, e))?;\n    if !resp.status().is_success() {\n        return Err(format!(\n            \"Timezone endpoint {} returned status {}\",\n            url,\n            resp.status()\n        ));\n    }\n    let payload: TimeZoneResponse = resp\n        .json()\n        .await\n        .map_err(|e| format!(\"Failed to parse timezone response: {}\", e))?;\n    Ok(payload.time_zone)\n}\n\npub fn current_time_zone() -\u003e Tz {\n    let cached = {\n        let guard = time_zone_cache().read().unwrap();\n        guard.value.clone()\n    };\n    cached\n        .map(|value| parse_time_zone(\u0026value))\n        .unwrap_or(chrono_tz::UTC)\n}\n\npub async fn await_time_zone() -\u003e Tz {\n    ensure_time_zone(false).await\n}\n\nasync fn ensure_time_zone(force_refresh: bool) -\u003e Tz {\n    if !force_refresh {\n        if let Some(cached) = {\n            let guard = time_zone_cache().read().unwrap();\n            guard.value.clone()\n        } {\n            return parse_time_zone(\u0026cached);\n        }\n    }\n\n    if let Some(existing) = snapshot_time_zone_from_globals() {\n        let cached = cache_time_zone(\u0026existing, false);\n        return parse_time_zone(\u0026cached);\n    }\n\n    mark_time_zone_loading();\n    let base_url = await_api_base_url().await;\n    match fetch_time_zone_from_api(\u0026base_url).await {\n        Ok(tz_name) =\u003e parse_time_zone(\u0026cache_time_zone(\u0026tz_name, false)),\n        Err(err) =\u003e parse_time_zone(\u0026mark_time_zone_error(err)),\n    }\n}\n\npub async fn init() {\n    let _ = await_api_base_url().await;\n    let _ = await_time_zone().await;\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn reports_fallback_status_when_marked() {\n        overwrite_time_zone_status_for_test(TimeZoneStatus {\n            time_zone: Some(\"UTC\".into()),\n            is_fallback: true,\n            last_error: Some(\"network error\".into()),\n            loading: false,\n        });\n        let status = time_zone_status();\n        assert_eq!(status.time_zone.as_deref(), Some(\"UTC\"));\n        assert!(status.is_fallback);\n        assert_eq!(status.last_error.as_deref(), Some(\"network error\"));\n    }\n\n    #[test]\n    fn clears_error_after_refresh() {\n        overwrite_time_zone_status_for_test(TimeZoneStatus {\n            time_zone: Some(\"UTC\".into()),\n            is_fallback: true,\n            last_error: Some(\"network error\".into()),\n            loading: false,\n        });\n        queue_mock_time_zone_fetch(Ok(\"Asia/Tokyo\".into()));\n        let refreshed = futures::executor::block_on(async { refresh_time_zone().await });\n        assert!(!refreshed.is_fallback);\n        assert!(refreshed.last_error.is_none());\n        assert_eq!(refreshed.time_zone.as_deref(), Some(\"Asia/Tokyo\"));\n    }\n}\n\n#[cfg(all(test, target_arch = \"wasm32\"))]\nmod wasm_tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test(async)]\n    async fn reads_api_base_url_from_window_env() {\n        let window = web_sys::window().expect(\"window available\");\n        let env = js_sys::Object::new();\n        let _ = js_sys::Reflect::set(\n            \u0026env,\n            \u0026\"API_BASE_URL\".into(),\n            \u0026wasm_bindgen::JsValue::from_str(\"https://example.test/api\"),\n        );\n        let _ = js_sys::Reflect::set(\u0026window, \u0026\"__TIMEKEEPER_ENV\".into(), \u0026env);\n\n        let resolved = await_api_base_url().await;\n        assert_eq!(resolved, \"https://example.test/api\");\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","lib.rs"],"content":"use js_sys::Date;\nuse leptos::*;\nuse wasm_bindgen_futures::spawn_local;\nuse web_sys::console;\n\nmod api;\nmod components;\npub mod config;\nmod pages;\npub mod router;\nmod state;\npub mod theme;\npub mod utils;\n\n#[wasm_bindgen::prelude::wasm_bindgen(start)]\npub fn start() {\n    console_error_panic_hook::set_once();\n    theme::init_system_theme();\n    let t0 = Date::now();\n    console::log_1(\u0026\"Starting Timekeeper Frontend (wasm): initializing runtime config\".into());\n\n    spawn_local(async move {\n        config::init().await;\n        let elapsed = Date::now() - t0;\n        let msg = format!(\"Runtime config initialized ({} ms)\", elapsed);\n        web_sys::console::log_1(\u0026msg.into());\n        router::mount_app();\n    });\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","main.rs"],"content":"use js_sys::Date;\nuse wasm_bindgen_futures::spawn_local;\nuse web_sys::console;\n\nuse timekeeper_frontend::{config, router, theme};\n\nfn main() {\n    console_error_panic_hook::set_once();\n    theme::init_system_theme();\n    let t0 = Date::now();\n    console::log_1(\u0026\"Starting Timekeeper Frontend: initializing runtime config\".into());\n\n    spawn_local(async move {\n        config::init().await;\n        let elapsed = Date::now() - t0;\n        console::log_1(\u0026format!(\"Runtime config initialized ({} ms)\", elapsed).into());\n        router::mount_app();\n    });\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","attendance.rs"],"content":"use crate::{\n    api::{AdminAttendanceUpsert, AdminBreakItem, ApiError},\n    components::{error::InlineErrorMessage, forms::DatePicker, layout::SuccessMessage},\n    pages::admin::{\n        components::user_select::{AdminUserSelect, UsersResource},\n        repository::AdminRepository,\n    },\n};\nuse chrono::{NaiveDate, NaiveDateTime};\nuse leptos::{ev, *};\n\nfn parse_dt_local(input: \u0026str) -\u003e Option\u003cNaiveDateTime\u003e {\n    if input.len() == 16 {\n        NaiveDateTime::parse_from_str(\u0026format!(\"{}:00\", input), \"%Y-%m-%dT%H:%M:%S\").ok()\n    } else {\n        NaiveDateTime::parse_from_str(input, \"%Y-%m-%dT%H:%M:%S\").ok()\n    }\n}\n\n#[component]\npub fn AdminAttendanceToolsSection(\n    repository: AdminRepository,\n    system_admin_allowed: Memo\u003cbool\u003e,\n    users: UsersResource,\n) -\u003e impl IntoView {\n    let att_user = create_rw_signal(String::new());\n    let att_date = create_rw_signal(String::new());\n    let att_in = create_rw_signal(String::new());\n    let att_out = create_rw_signal(String::new());\n    let breaks = create_rw_signal(Vec::\u003c(String, String)\u003e::new());\n    let break_force_id = create_rw_signal(String::new());\n    let message = create_rw_signal(None::\u003cString\u003e);\n    let error = create_rw_signal(None::\u003cApiError\u003e);\n\n    let add_break = {\n        move |_| {\n            breaks.update(|list| list.push((String::new(), String::new())));\n        }\n    };\n\n    let repo_for_attendance = repository.clone();\n    let attendance_action = create_action(move |payload: \u0026AdminAttendanceUpsert| {\n        let repo = repo_for_attendance.clone();\n        let payload = payload.clone();\n        async move { repo.upsert_attendance(payload).await }\n    });\n    let attendance_pending = attendance_action.pending();\n\n    let repo_for_break = repository.clone();\n    let force_break_action = create_action(move |break_id: \u0026String| {\n        let repo = repo_for_break.clone();\n        let break_id = break_id.clone();\n        async move { repo.force_end_break(\u0026break_id).await }\n    });\n    let force_pending = force_break_action.pending();\n\n    {\n        create_effect(move |_| {\n            if let Some(result) = attendance_action.value().get() {\n                match result {\n                    Ok(_) =\u003e {\n                        message.set(Some(\"勤怠データを登録しました。\".into()));\n                        error.set(None);\n                    }\n                    Err(err) =\u003e {\n                        message.set(None);\n                        error.set(Some(err));\n                    }\n                }\n            }\n        });\n    }\n    {\n        create_effect(move |_| {\n            if let Some(result) = force_break_action.value().get() {\n                match result {\n                    Ok(_) =\u003e {\n                        message.set(Some(\"休憩を強制終了しました。\".into()));\n                        error.set(None);\n                    }\n                    Err(err) =\u003e {\n                        message.set(None);\n                        error.set(Some(err));\n                    }\n                }\n            }\n        });\n    }\n\n    let on_submit_attendance = {\n        move |ev: ev::SubmitEvent| {\n            ev.prevent_default();\n            if !system_admin_allowed.get_untracked() {\n                return;\n            }\n            let user_id = att_user.get();\n            let date_raw = att_date.get();\n            let clock_in = parse_dt_local(\u0026att_in.get());\n            if user_id.trim().is_empty() || date_raw.trim().is_empty() || clock_in.is_none() {\n                error.set(Some(ApiError::validation(\n                    \"ユーザーID・日付・出勤時刻を入力してください。\",\n                )));\n                message.set(None);\n                return;\n            }\n            let clock_out = if att_out.get().trim().is_empty() {\n                None\n            } else {\n                parse_dt_local(\u0026att_out.get())\n            };\n            let date = NaiveDate::parse_from_str(\u0026date_raw, \"%Y-%m-%d\").ok();\n            if date.is_none() {\n                error.set(Some(ApiError::validation(\n                    \"日付は YYYY-MM-DD 形式で入力してください。\",\n                )));\n                message.set(None);\n                return;\n            }\n            let mut break_items: Vec\u003cAdminBreakItem\u003e = vec![];\n            for (start, end) in breaks.get() {\n                if start.trim().is_empty() {\n                    continue;\n                }\n                let start_dt = parse_dt_local(\u0026start);\n                let end_dt = if end.trim().is_empty() {\n                    None\n                } else {\n                    parse_dt_local(\u0026end)\n                };\n                if let Some(start_dt) = start_dt {\n                    break_items.push(AdminBreakItem {\n                        break_start_time: start_dt,\n                        break_end_time: end_dt,\n                    });\n                }\n            }\n            let payload = AdminAttendanceUpsert {\n                user_id,\n                date: date.unwrap(),\n                clock_in_time: clock_in.unwrap(),\n                clock_out_time: clock_out,\n                breaks: if break_items.is_empty() {\n                    None\n                } else {\n                    Some(break_items)\n                },\n            };\n            message.set(None);\n            error.set(None);\n            attendance_action.dispatch(payload);\n        }\n    };\n\n    let on_force_end = {\n        move |_| {\n            if !system_admin_allowed.get_untracked() {\n                return;\n            }\n            let id = break_force_id.get();\n            if id.trim().is_empty() {\n                error.set(Some(ApiError::validation(\"Break ID を入力してください。\")));\n                message.set(None);\n                return;\n            }\n            error.set(None);\n            message.set(None);\n            force_break_action.dispatch(id);\n        }\n    };\n\n    view! {\n        \u003cShow when=move || system_admin_allowed.get()\u003e\n            \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n                \u003ch3 class=\"text-lg font-medium text-fg\"\u003e{\"勤怠ツール\"}\u003c/h3\u003e\n                \u003cform class=\"space-y-3\" on:submit=on_submit_attendance\u003e\n                    \u003cAdminUserSelect\n                        users=users\n                        selected=att_user\n                        label=Some(\"対象ユーザー\".into())\n                        placeholder=\"ユーザーを選択してください\".into()\n                    /\u003e\n                    \u003cDatePicker\n                        label=Some(\"対象日\")\n                        value=att_date\n                    /\u003e\n                    \u003cinput type=\"datetime-local\" class=\"w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\" on:input=move |ev| att_in.set(event_target_value(\u0026ev)) /\u003e\n                    \u003cinput type=\"datetime-local\" class=\"w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\" on:input=move |ev| att_out.set(event_target_value(\u0026ev)) /\u003e\n                    \u003cdiv\u003e\n                        \u003cdiv class=\"flex items-center justify-between mb-1\"\u003e\n                            \u003cspan class=\"text-sm text-fg-muted\"\u003e{\"休憩（任意）\"}\u003c/span\u003e\n                            \u003cbutton type=\"button\" class=\"text-link hover:text-link-hover text-sm\" on:click=add_break\u003e{\"行を追加\"}\u003c/button\u003e\n                        \u003c/div\u003e\n                        \u003cFor\n                            each=move || breaks.get().into_iter().enumerate()\n                            key=|(idx, _)| *idx\n                            children=move |(idx, _)| {\n                                let start_value = {\n                                    let breaks = breaks;\n                                    move || {\n                                        breaks\n                                            .with(|list| {\n                                                list.get(idx).map(|item| item.0.clone())\n                                            })\n                                            .unwrap_or_default()\n                                    }\n                                };\n                                let end_value = {\n                                    let breaks = breaks;\n                                    move || {\n                                        breaks\n                                            .with(|list| {\n                                                list.get(idx).map(|item| item.1.clone())\n                                            })\n                                            .unwrap_or_default()\n                                    }\n                                };\n                                let on_start = {\n                                    let breaks = breaks;\n                                    move |ev| {\n                                        let value = event_target_value(\u0026ev);\n                                        breaks.update(|list| {\n                                            if let Some(item) = list.get_mut(idx) {\n                                                item.0 = value;\n                                            }\n                                        });\n                                    }\n                                };\n                                let on_end = {\n                                    let breaks = breaks;\n                                    move |ev| {\n                                        let value = event_target_value(\u0026ev);\n                                        breaks.update(|list| {\n                                            if let Some(item) = list.get_mut(idx) {\n                                                item.1 = value;\n                                            }\n                                        });\n                                    }\n                                };\n                                view! {\n                                    \u003cdiv class=\"flex space-x-2 mb-2\"\u003e\n                                        \u003cinput type=\"datetime-local\" class=\"border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1 w-full\" prop:value=start_value on:input=on_start /\u003e\n                                        \u003cinput type=\"datetime-local\" class=\"border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1 w-full\" prop:value=end_value on:input=on_end /\u003e\n                                    \u003c/div\u003e\n                                }\n                            }\n                        /\u003e\n                    \u003c/div\u003e\n                    \u003cbutton\n                        type=\"submit\"\n                        class=\"w-full bg-action-primary-bg text-action-primary-text rounded py-2 disabled:opacity-50\"\n                        disabled={move || attendance_pending.get()}\n                    \u003e\n                        {move || if attendance_pending.get() { \"登録中...\" } else { \"勤怠を登録\" }}\n                    \u003c/button\u003e\n                \u003c/form\u003e\n                \u003cdiv class=\"mt-4\"\u003e\n                    \u003ch4 class=\"text-sm font-medium text-fg mb-2\"\u003e{\"休憩の強制終了\"}\u003c/h4\u003e\n                    \u003cdiv class=\"flex space-x-2\"\u003e\n                        \u003cinput\n                            placeholder=\"Break ID\"\n                            class=\"border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1 w-full\"\n                            on:input=move |ev| break_force_id.set(event_target_value(\u0026ev))\n                        /\u003e\n                        \u003cbutton\n                            class=\"px-3 py-1 bg-action-danger-bg text-action-danger-text rounded disabled:opacity-50\"\n                            disabled={move || force_pending.get()}\n                            on:click=on_force_end\n                        \u003e\n                            {move || if force_pending.get() { \"終了中...\" } else { \"強制終了\" }}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n                \u003cShow when=move || error.get().is_some()\u003e\n                    \u003cInlineErrorMessage error={error.into()} /\u003e\n                \u003c/Show\u003e\n                \u003cShow when=move || message.get().is_some()\u003e\n                    \u003cSuccessMessage message={message.get().unwrap_or_default()} /\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","holidays.rs"],"content":"use crate::{\n    api::{ApiError, CreateHolidayRequest},\n    components::{\n        error::InlineErrorMessage,\n        forms::DatePicker,\n        layout::{LoadingSpinner, SuccessMessage},\n    },\n    pages::admin::repository::{AdminRepository, HolidayListQuery, HolidayListResult},\n    utils::time::now_in_app_tz,\n};\nuse chrono::{Datelike, Duration, NaiveDate};\nuse leptos::{ev, *};\nuse std::collections::HashSet;\n\n#[component]\npub fn HolidayManagementSection(\n    repository: AdminRepository,\n    admin_allowed: Memo\u003cbool\u003e,\n) -\u003e impl IntoView {\n    let holidays_reload = create_rw_signal(0u32);\n    let holiday_date_input = create_rw_signal(String::new());\n    let holiday_name_input = create_rw_signal(String::new());\n    let holiday_desc_input = create_rw_signal(String::new());\n    let holiday_message = create_rw_signal(None::\u003cString\u003e);\n    let holiday_error = create_rw_signal(None::\u003cApiError\u003e);\n    let deleting_id = create_rw_signal(None::\u003cString\u003e);\n    let holiday_query = create_rw_signal(HolidayListQuery::default());\n    let filter_from_input = create_rw_signal(String::new());\n    let filter_to_input = create_rw_signal(String::new());\n    let calendar_month_input = create_rw_signal(format!(\n        \"{:04}-{:02}\",\n        now_in_app_tz().year(),\n        now_in_app_tz().month()\n    ));\n\n    let repo_for_holidays = repository.clone();\n    let holidays_resource = create_resource(\n        move || {\n            (\n                admin_allowed.get(),\n                holiday_query.get(),\n                holidays_reload.get(),\n            )\n        },\n        move |(allowed, query, _)| {\n            let repo = repo_for_holidays.clone();\n            async move {\n                if !allowed {\n                    Ok(HolidayListResult::empty(query.page, query.per_page))\n                } else {\n                    repo.list_holidays(query).await\n                }\n            }\n        },\n    );\n    let holidays_loading = holidays_resource.loading();\n    let holidays_fetch_error =\n        Signal::derive(move || holidays_resource.get().and_then(|result| result.err()));\n    let holidays_page =\n        Signal::derive(move || holidays_resource.get().and_then(|result| result.ok()));\n    let holidays_data = Signal::derive(move || {\n        holidays_page\n            .get()\n            .map(|page| {\n                let mut list = page.items.clone();\n                list.sort_by_key(|h| h.holiday_date);\n                list\n            })\n            .unwrap_or_default()\n    });\n    let page_total = Signal::derive(move || {\n        holidays_page\n            .get()\n            .map(|page| (page.page, page.per_page, page.total))\n    });\n    let total_pages = Signal::derive(move || {\n        page_total\n            .get()\n            .map(|(_, per_page, total)| {\n                if total == 0 {\n                    1\n                } else {\n                    ((total + per_page - 1) / per_page).max(1)\n                }\n            })\n            .unwrap_or(1)\n    });\n    let can_go_prev = Signal::derive(move || {\n        page_total\n            .get()\n            .map(|(page, _, _)| page \u003e 1)\n            .unwrap_or(false)\n    });\n    let can_go_next = Signal::derive(move || {\n        page_total\n            .get()\n            .map(|(page, per_page, total)| {\n                let max_page = if total == 0 {\n                    1\n                } else {\n                    ((total + per_page - 1) / per_page).max(1)\n                };\n                page \u003c max_page\n            })\n            .unwrap_or(false)\n    });\n    let page_bounds = Signal::derive(move || {\n        page_total.get().map(|(page, per_page, total)| {\n            if total == 0 {\n                (0, 0, 0)\n            } else {\n                let start = ((page - 1).max(0) * per_page) + 1;\n                let end = (page * per_page).min(total);\n                (start, end, total)\n            }\n        })\n    });\n    let on_prev_page = {\n        move |_| {\n            holiday_query.update(|query| {\n                if query.page \u003e 1 {\n                    query.page -= 1;\n                }\n            });\n        }\n    };\n    let on_next_page = {\n        move |_| {\n            if can_go_next.get_untracked() {\n                holiday_query.update(|query| query.page += 1);\n            }\n        }\n    };\n    let on_per_page_change = {\n        move |ev: ev::Event| {\n            if let Ok(value) = event_target_value(\u0026ev).parse::\u003ci64\u003e() {\n                holiday_query.update(|query| {\n                    query.per_page = value.max(1);\n                    query.page = 1;\n                });\n            }\n        }\n    };\n    let on_apply_filters = {\n        move |_| {\n            let from_raw = filter_from_input.get();\n            let to_raw = filter_to_input.get();\n            let parse_input = |value: \u0026str, label: \u0026str| -\u003e Result\u003cOption\u003cNaiveDate\u003e, String\u003e {\n                let trimmed = value.trim();\n                if trimmed.is_empty() {\n                    return Ok(None);\n                }\n                NaiveDate::parse_from_str(trimmed, \"%Y-%m-%d\")\n                    .map(Some)\n                    .map_err(|_| format!(\"{}は YYYY-MM-DD 形式で入力してください。\", label))\n            };\n            let parsed_from = match parse_input(\u0026from_raw, \"開始日\") {\n                Ok(date) =\u003e date,\n                Err(err) =\u003e {\n                    holiday_error.set(Some(ApiError::validation(\u0026err)));\n                    return;\n                }\n            };\n            let parsed_to = match parse_input(\u0026to_raw, \"終了日\") {\n                Ok(date) =\u003e date,\n                Err(err) =\u003e {\n                    holiday_error.set(Some(ApiError::validation(\u0026err)));\n                    return;\n                }\n            };\n            if let (Some(from), Some(to)) = (parsed_from, parsed_to) {\n                if from \u003e to {\n                    holiday_error.set(Some(ApiError::validation(\n                        \"開始日は終了日以前である必要があります。\",\n                    )));\n                    return;\n                }\n            }\n            holiday_error.set(None);\n            holiday_message.set(None);\n            holiday_query.update(|query| {\n                query.page = 1;\n                query.from = parsed_from;\n                query.to = parsed_to;\n            });\n        }\n    };\n    let on_clear_filters = {\n        move |_| {\n            filter_from_input.set(String::new());\n            filter_to_input.set(String::new());\n            holiday_error.set(None);\n            holiday_message.set(None);\n            holiday_query.update(|query| {\n                query.page = 1;\n                query.from = None;\n                query.to = None;\n            });\n        }\n    };\n    let on_apply_calendar_range = {\n        move |_| {\n            let month_raw = calendar_month_input.get();\n            let trimmed = month_raw.trim();\n            if trimmed.is_empty() {\n                holiday_error.set(Some(ApiError::validation(\"月を選択してください。\")));\n                return;\n            }\n            let first_day = match NaiveDate::parse_from_str(\u0026format!(\"{}-01\", trimmed), \"%Y-%m-%d\")\n            {\n                Ok(date) =\u003e date,\n                Err(_) =\u003e {\n                    holiday_error.set(Some(ApiError::validation(\n                        \"月は YYYY-MM 形式で入力してください。\",\n                    )));\n                    return;\n                }\n            };\n            let next_month = if first_day.month() == 12 {\n                NaiveDate::from_ymd_opt(first_day.year() + 1, 1, 1)\n            } else {\n                NaiveDate::from_ymd_opt(first_day.year(), first_day.month() + 1, 1)\n            }\n            .expect(\"next month boundary must exist\");\n            let last_day = next_month - Duration::days(1);\n            filter_from_input.set(first_day.format(\"%Y-%m-%d\").to_string());\n            filter_to_input.set(last_day.format(\"%Y-%m-%d\").to_string());\n            holiday_error.set(None);\n            holiday_message.set(None);\n            holiday_query.update(|query| {\n                query.page = 1;\n                query.from = Some(first_day);\n                query.to = Some(last_day);\n            });\n        }\n    };\n\n    let repo_for_create = repository.clone();\n    let create_holiday_action = create_action(move |payload: \u0026CreateHolidayRequest| {\n        let repo = repo_for_create.clone();\n        let payload = payload.clone();\n        async move { repo.create_holiday(payload).await }\n    });\n    let create_pending = create_holiday_action.pending();\n    {\n        create_effect(move |_| {\n            if let Some(result) = create_holiday_action.value().get() {\n                match result {\n                    Ok(created) =\u003e {\n                        holiday_message.set(Some(format!(\n                            \"{} ({}) を登録しました。\",\n                            created.name,\n                            created.holiday_date.format(\"%Y-%m-%d\")\n                        )));\n                        holiday_error.set(None);\n                        holiday_date_input.set(String::new());\n                        holiday_name_input.set(String::new());\n                        holiday_desc_input.set(String::new());\n                        holidays_reload.update(|value| *value = value.wrapping_add(1));\n                    }\n                    Err(err) =\u003e {\n                        holiday_message.set(None);\n                        holiday_error.set(Some(err));\n                    }\n                }\n            }\n        });\n    }\n\n    let repo_for_delete = repository.clone();\n    let delete_holiday_action = create_action(move |id: \u0026String| {\n        let repo = repo_for_delete.clone();\n        let id = id.clone();\n        async move { repo.delete_holiday(\u0026id).await }\n    });\n    {\n        create_effect(move |_| {\n            if let Some(result) = delete_holiday_action.value().get() {\n                match result {\n                    Ok(_) =\u003e {\n                        holiday_message.set(Some(\"祝日を削除しました。\".into()));\n                        holiday_error.set(None);\n                        deleting_id.set(None);\n                        holidays_reload.update(|value| *value = value.wrapping_add(1));\n                    }\n                    Err(err) =\u003e {\n                        holiday_message.set(None);\n                        holiday_error.set(Some(err));\n                        deleting_id.set(None);\n                    }\n                }\n            }\n        });\n    }\n\n    let google_year_input = create_rw_signal(now_in_app_tz().year().to_string());\n    let google_holidays = create_rw_signal(Vec::\u003cCreateHolidayRequest\u003e::new());\n    let google_error = create_rw_signal(None::\u003cApiError\u003e);\n    let repo_for_google = repository.clone();\n    let fetch_google_action = create_action(move |year: \u0026Option\u003ci32\u003e| {\n        let repo = repo_for_google.clone();\n        let year = *year;\n        async move { repo.fetch_google_holidays(year).await }\n    });\n    let google_loading = fetch_google_action.pending();\n    {\n        create_effect(move |_| {\n            if let Some(result) = fetch_google_action.value().get() {\n                match result {\n                    Ok(list) =\u003e {\n                        google_error.set(None);\n                        google_holidays.set(list);\n                    }\n                    Err(err) =\u003e {\n                        google_error.set(Some(err));\n                        google_holidays.set(Vec::new());\n                    }\n                }\n            }\n        });\n    }\n\n    let repo_for_import = repository.clone();\n    let import_action = create_action(move |payload: \u0026Vec\u003cCreateHolidayRequest\u003e| {\n        let repo = repo_for_import.clone();\n        let payload = payload.clone();\n        async move {\n            let mut imported = 0usize;\n            for item in payload {\n                repo.create_holiday(item.clone()).await?;\n                imported += 1;\n            }\n            Ok(imported)\n        }\n    });\n    {\n        create_effect(move |_| {\n            if let Some(result) = import_action.value().get() {\n                match result {\n                    Ok(count) =\u003e {\n                        if count == 0 {\n                            holiday_message.set(Some(\"追加対象の祝日はありません。\".into()));\n                        } else {\n                            holiday_message\n                                .set(Some(format!(\"{} 件の祝日を追加しました。\", count)));\n                        }\n                        holiday_error.set(None);\n                        holidays_reload.update(|value| *value = value.wrapping_add(1));\n                    }\n                    Err(err) =\u003e {\n                        holiday_message.set(None);\n                        holiday_error.set(Some(err));\n                    }\n                }\n            }\n        });\n    }\n\n    let on_fetch_google = {\n        move |_| {\n            let parsed_year = google_year_input.get().trim().parse::\u003ci32\u003e().ok();\n            fetch_google_action.dispatch(parsed_year);\n        }\n    };\n\n    let on_create_holiday = {\n        move |ev: ev::SubmitEvent| {\n            ev.prevent_default();\n            let date_raw = holiday_date_input.get();\n            let name_raw = holiday_name_input.get();\n            let desc_raw = holiday_desc_input.get();\n            if date_raw.trim().is_empty() || name_raw.trim().is_empty() {\n                holiday_error.set(Some(ApiError::validation(\"日付と名称を入力してください。\")));\n                holiday_message.set(None);\n                return;\n            }\n            let parsed_date = match NaiveDate::parse_from_str(date_raw.trim(), \"%Y-%m-%d\") {\n                Ok(date) =\u003e date,\n                Err(_) =\u003e {\n                    holiday_error.set(Some(ApiError::validation(\n                        \"日付は YYYY-MM-DD 形式で入力してください。\",\n                    )));\n                    holiday_message.set(None);\n                    return;\n                }\n            };\n            let payload = CreateHolidayRequest {\n                holiday_date: parsed_date,\n                name: name_raw.trim().to_string(),\n                description: if desc_raw.trim().is_empty() {\n                    None\n                } else {\n                    Some(desc_raw.trim().to_string())\n                },\n            };\n            holiday_error.set(None);\n            holiday_message.set(None);\n            create_holiday_action.dispatch(payload);\n        }\n    };\n\n    let on_delete_holiday = {\n        move |id: String| {\n            deleting_id.set(Some(id.clone()));\n            delete_holiday_action.dispatch(id);\n        }\n    };\n\n    let on_import_google = {\n        move |_| {\n            let existing: HashSet\u003cNaiveDate\u003e = holidays_data\n                .get()\n                .into_iter()\n                .map(|h| h.holiday_date)\n                .collect();\n            let candidates: Vec\u003cCreateHolidayRequest\u003e = google_holidays\n                .get()\n                .into_iter()\n                .filter(|candidate| !existing.contains(\u0026candidate.holiday_date))\n                .collect();\n            if candidates.is_empty() {\n                holiday_message.set(Some(\"追加対象の祝日はありません。\".into()));\n                holiday_error.set(None);\n                return;\n            }\n            holiday_error.set(None);\n            holiday_message.set(None);\n            import_action.dispatch(candidates);\n        }\n    };\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003ch3 class=\"text-lg font-medium text-fg\"\u003e{\"祝日管理\"}\u003c/h3\u003e\n            \u003cform class=\"grid gap-3 lg:grid-cols-3\" on:submit=on_create_holiday\u003e\n                \u003cDatePicker\n                    label=Some(\"日付\")\n                    value=holiday_date_input\n                /\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-bold text-fg-muted ml-1 mb-1.5\"\u003e{\"名称\"}\u003c/label\u003e\n                    \u003cinput class=\"w-full rounded-xl border-2 border-form-control-border bg-form-control-bg text-fg py-2.5 px-4 shadow-sm focus:outline-none focus:border-action-primary-border-hover focus:ring-4 focus:ring-action-primary-focus transition-all duration-200\" on:input=move |ev| holiday_name_input.set(event_target_value(\u0026ev)) /\u003e\n                \u003c/div\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-bold text-fg-muted ml-1 mb-1.5\"\u003e{\"備考（任意）\"}\u003c/label\u003e\n                    \u003cinput class=\"w-full rounded-xl border-2 border-form-control-border bg-form-control-bg text-fg py-2.5 px-4 shadow-sm focus:outline-none focus:border-action-primary-border-hover focus:ring-4 focus:ring-action-primary-focus transition-all duration-200\" on:input=move |ev| holiday_desc_input.set(event_target_value(\u0026ev)) /\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"lg:col-span-3\"\u003e\n                    \u003cbutton\n                        type=\"submit\"\n                        class=\"px-4 py-2 rounded bg-action-primary-bg text-action-primary-text disabled:opacity-50\"\n                        disabled={move || create_pending.get()}\n                    \u003e\n                        {move || if create_pending.get() { \"登録中...\" } else { \"祝日を登録\" }}\n                    \u003c/button\u003e\n                \u003c/div\u003e\n            \u003c/form\u003e\n            \u003cdiv class=\"flex flex-col gap-2 lg:flex-row lg:items-center lg:gap-4\"\u003e\n                \u003cdiv class=\"flex items-center gap-2\"\u003e\n                    \u003cinput\n                        type=\"number\"\n                        class=\"w-32 rounded-xl border-2 border-form-control-border bg-form-control-bg text-fg py-2.5 px-4 shadow-sm focus:outline-none focus:border-action-primary-border-hover focus:ring-4 focus:ring-action-primary-focus transition-all duration-200\"\n                        prop:value={move || google_year_input.get()}\n                        on:input=move |ev| google_year_input.set(event_target_value(\u0026ev))\n                    /\u003e\n                    \u003cbutton\n                        class=\"px-3 py-2.5 rounded-xl border-2 border-border text-fg hover:bg-action-ghost-bg-hover disabled:opacity-50 font-medium transition-colors\"\n                        disabled={move || google_loading.get()}\n                        on:click=on_fetch_google\n                    \u003e\n                        {move || if google_loading.get() { \"取得中...\" } else { \"Google 祝日取得\" }}\n                    \u003c/button\u003e\n                \u003c/div\u003e\n                \u003cbutton\n                    class=\"px-3 py-2.5 rounded-xl border-2 border-status-success-border text-status-success-text bg-status-success-bg disabled:opacity-50 font-bold transition-colors\"\n                    disabled={move || google_holidays.get().is_empty()}\n                    on:click=on_import_google\n                \u003e\n                    {\"一覧から登録\"}\n                \u003c/button\u003e\n            \u003c/div\u003e\n            \u003cdiv class=\"space-y-3 rounded-lg border border-dashed border-border p-4\"\u003e\n                \u003cdiv class=\"flex flex-col gap-1\"\u003e\n                    \u003ch4 class=\"text-sm font-medium text-fg\"\u003e{\"祝日一覧フィルター\"}\u003c/h4\u003e\n                    \u003cp class=\"text-xs text-fg-muted\"\u003e{\"期間を指定すると一致する祝日だけを表示します。\"}\u003c/p\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"grid gap-3 lg:grid-cols-4 align-bottom\"\u003e\n                    \u003cDatePicker\n                        label=Some(\"開始日\")\n                        value=filter_from_input\n                    /\u003e\n                    \u003cDatePicker\n                        label=Some(\"終了日\")\n                        value=filter_to_input\n                    /\u003e\n                    \u003cdiv class=\"lg:col-span-2 flex items-end gap-2 mb-0.5\"\u003e\n                        \u003cbutton class=\"h-[50px] px-4 rounded-xl border-2 border-border text-fg hover:bg-action-ghost-bg-hover font-medium transition-colors\" on:click=on_apply_filters\u003e\n                            {\"日付で絞り込み\"}\n                        \u003c/button\u003e\n                        \u003cbutton class=\"h-[50px] px-4 rounded-xl text-fg-muted hover:text-fg font-medium transition-colors\" on:click=on_clear_filters\u003e\n                            {\"条件クリア\"}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"grid gap-3 lg:grid-cols-3\"\u003e\n                    \u003cdiv\u003e\n                        \u003clabel class=\"block text-sm font-bold text-fg-muted ml-1 mb-1.5\"\u003e{\"カレンダー範囲 (YYYY-MM)\"}\u003c/label\u003e\n                        \u003cinput\n                            type=\"month\"\n                            class=\"w-full rounded-xl border-2 border-form-control-border bg-form-control-bg text-fg py-2.5 px-4 shadow-sm focus:outline-none focus:border-action-primary-border-hover focus:ring-4 focus:ring-action-primary-focus transition-all duration-200\"\n                            prop:value={move || calendar_month_input.get()}\n                            on:input=move |ev| calendar_month_input.set(event_target_value(\u0026ev))\n                        /\u003e\n                    \u003c/div\u003e\n                    \u003cdiv class=\"lg:col-span-2 flex items-end mb-0.5\"\u003e\n                        \u003cbutton class=\"h-[50px] px-4 rounded-xl border-2 border-border text-fg hover:bg-action-ghost-bg-hover font-medium transition-colors\" on:click=on_apply_calendar_range\u003e\n                            {\"選択月の範囲を適用\"}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || holiday_error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={holiday_error.into()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || holiday_message.get().is_some()\u003e\n                \u003cSuccessMessage message={holiday_message.get().unwrap_or_default()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || holidays_fetch_error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={holidays_fetch_error} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || google_error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={google_error.into()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || holidays_loading.get()\u003e\n                \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                    \u003cLoadingSpinner /\u003e\n                    \u003cspan\u003e{\"祝日一覧を読み込み中...\"}\u003c/span\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n            \u003cdiv class=\"flex flex-col gap-2 rounded-lg border border-border p-3 text-sm text-fg lg:flex-row lg:items-center lg:justify-between\"\u003e\n                \u003cdiv\u003e\n                    {move || {\n                        page_bounds\n                            .get()\n                            .map(|bounds| match bounds {\n                                (0, 0, 0) =\u003e \"該当する祝日はありません。\".to_string(),\n                                (start, end, total) =\u003e {\n                                    format!(\"{} 件中 {} - {} 件を表示中\", total, start, end)\n                                }\n                            })\n                            .unwrap_or_else(|| \"祝日一覧を取得しています...\".into())\n                    }}\n                \u003c/div\u003e\n                \u003cdiv class=\"flex flex-wrap items-center gap-3\"\u003e\n                    \u003clabel class=\"flex items-center gap-1\"\u003e\n                        \u003cspan class=\"text-xs uppercase tracking-wide text-fg-muted\"\u003e\n                            {\"件数/ページ\"}\n                        \u003c/span\u003e\n                        \u003cselect\n                            class=\"border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                            prop:value={move || holiday_query.get().per_page.to_string()}\n                            on:change=on_per_page_change\n                        \u003e\n                            \u003coption value=\"10\"\u003e{\"10\"}\u003c/option\u003e\n                            \u003coption value=\"25\"\u003e{\"25\"}\u003c/option\u003e\n                            \u003coption value=\"50\"\u003e{\"50\"}\u003c/option\u003e\n                        \u003c/select\u003e\n                    \u003c/label\u003e\n                    \u003cdiv class=\"inline-flex items-center gap-2\"\u003e\n                        \u003cbutton\n                            class=\"px-3 py-1 rounded border border-border text-fg disabled:opacity-50\"\n                            disabled={move || holidays_loading.get() || !can_go_prev.get()}\n                            on:click=on_prev_page\n                        \u003e\n                            {\"前へ\"}\n                        \u003c/button\u003e\n                        \u003cspan class=\"text-xs text-fg-muted\"\u003e\n                            {move || {\n                                let current = page_total.get().map(|(page, _, _)| page).unwrap_or(1);\n                                format!(\"ページ {}/{}\", current, total_pages.get())\n                            }}\n                        \u003c/span\u003e\n                        \u003cbutton\n                            class=\"px-3 py-1 rounded border border-border text-fg disabled:opacity-50\"\n                            disabled={move || holidays_loading.get() || !can_go_next.get()}\n                            on:click=on_next_page\n                        \u003e\n                            {\"次へ\"}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n            \u003cdiv class=\"overflow-x-auto\"\u003e\n                \u003ctable class=\"min-w-full divide-y divide-border text-sm\"\u003e\n                    \u003cthead class=\"bg-surface-muted\"\u003e\n                        \u003ctr\u003e\n                            \u003cth class=\"px-4 py-2 text-left text-fg-muted\"\u003e{\"日付\"}\u003c/th\u003e\n                            \u003cth class=\"px-4 py-2 text-left text-fg-muted\"\u003e{\"名称\"}\u003c/th\u003e\n                            \u003cth class=\"px-4 py-2 text-left text-fg-muted\"\u003e{\"備考\"}\u003c/th\u003e\n                            \u003cth class=\"px-4 py-2 text-right text-fg-muted\"\u003e{\"操作\"}\u003c/th\u003e\n                        \u003c/tr\u003e\n                    \u003c/thead\u003e\n                    \u003ctbody class=\"divide-y divide-border\"\u003e\n                        \u003cFor\n                            each=move || holidays_data.get()\n                            key=|item| item.id.clone()\n                            children=move |item| {\n                                let remove = {\n                                    let item_id = item.id.clone();\n                                    move |_| on_delete_holiday(item_id.clone())\n                                };\n                                view! {\n                                    \u003ctr\u003e\n                                        \u003ctd class=\"px-4 py-2 text-fg\"\u003e{item.holiday_date.format(\"%Y-%m-%d\").to_string()}\u003c/td\u003e\n                                        \u003ctd class=\"px-4 py-2 text-fg\"\u003e{item.name.clone()}\u003c/td\u003e\n                                        \u003ctd class=\"px-4 py-2 text-fg-muted\"\u003e{item.description.clone().unwrap_or_default()}\u003c/td\u003e\n                                        \u003ctd class=\"px-4 py-2 text-right\"\u003e\n                                            \u003cbutton\n                                                class=\"px-3 py-1 rounded border border-border text-sm text-fg disabled:opacity-50\"\n                                                disabled={move || deleting_id.get().as_deref() == Some(\u0026item.id)}\n                                                on:click=remove\n                                            \u003e\n                                                {\"削除\"}\n                                            \u003c/button\u003e\n                                        \u003c/td\u003e\n                                    \u003c/tr\u003e\n                                }\n                            }\n                        /\u003e\n                    \u003c/tbody\u003e\n                \u003c/table\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || !google_holidays.get().is_empty()\u003e\n                \u003cdiv class=\"border border-border rounded-lg p-4 space-y-2\"\u003e\n                    \u003ch4 class=\"text-sm font-medium text-fg\"\u003e{\"Google 祝日候補\"}\u003c/h4\u003e\n                    \u003cul class=\"space-y-1 text-sm text-fg\"\u003e\n                        \u003cFor\n                            each=move || google_holidays.get()\n                            key=|item| (item.name.clone(), item.holiday_date)\n                            children=move |item| {\n                                view! {\n                                    \u003cli class=\"flex justify-between\"\u003e\n                                        \u003cspan\u003e{item.holiday_date.format(\"%Y-%m-%d\").to_string()}\u003c/span\u003e\n                                        \u003cspan\u003e{item.name.clone()}\u003c/span\u003e\n                                    \u003c/li\u003e\n                                }\n                            }\n                        /\u003e\n                    \u003c/ul\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","mod.rs"],"content":"pub mod attendance;\npub mod holidays;\npub mod requests;\npub mod subject_requests;\npub mod system_tools;\npub mod user_select;\npub mod weekly_holidays;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","requests.rs"],"content":"use crate::{\n    api::ApiError,\n    components::{empty_state::EmptyState, error::InlineErrorMessage, layout::LoadingSpinner},\n    pages::admin::{\n        components::user_select::{AdminUserSelect, UsersResource},\n        utils::RequestFilterState,\n        view_model::RequestActionPayload,\n    },\n};\nuse leptos::*;\nuse serde_json::{json, Value};\n\n#[component]\npub fn AdminRequestsSection(\n    users: UsersResource,\n    filter: RequestFilterState,\n    resource: Resource\u003c\n        (bool, crate::pages::admin::utils::RequestFilterSnapshot, u32),\n        Result\u003cserde_json::Value, ApiError\u003e,\n    \u003e,\n    action: Action\u003cRequestActionPayload, Result\u003c(), ApiError\u003e\u003e,\n    action_error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    reload: RwSignal\u003cu32\u003e,\n) -\u003e impl IntoView {\n    let modal_open = create_rw_signal(false);\n    let modal_data = create_rw_signal(Value::Null);\n    let modal_comment = create_rw_signal(String::new());\n\n    let requests_loading = resource.loading();\n    let requests_data = Signal::derive(move || {\n        resource\n            .get()\n            .and_then(|result| result.ok())\n            .unwrap_or(Value::Null)\n    });\n    let requests_error = Signal::derive(move || resource.get().and_then(|result| result.err()));\n\n    let action_pending = action.pending();\n\n    // Effects\n    create_effect(move |_| {\n        if let Some(result) = action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    modal_open.set(false);\n                    action_error.set(None);\n                    reload.update(|value| *value = value.wrapping_add(1));\n                }\n                Err(err) =\u003e action_error.set(Some(err)),\n            }\n        }\n    });\n\n    let trigger_reload = move || reload.update(|value| *value = value.wrapping_add(1));\n\n    let on_status_change = move |value: String| {\n        filter.status_signal().set(value);\n        filter.reset_page();\n        trigger_reload();\n    };\n\n    let on_search = move |_| {\n        filter.reset_page();\n        trigger_reload();\n    };\n\n    let open_modal = move |data: Value| {\n        modal_data.set(data);\n        modal_comment.set(String::new());\n        modal_open.set(true);\n    };\n\n    let on_action = move |approve: bool| {\n        let id = modal_data\n            .get()\n            .get(\"id\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"\")\n            .to_string();\n        let comment = modal_comment.get();\n        action.dispatch(RequestActionPayload {\n            id,\n            comment,\n            approve,\n        });\n    };\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003ch3 class=\"text-lg font-medium text-fg\"\u003e{\"申請一覧\"}\u003c/h3\u003e\n            \u003cdiv class=\"flex flex-col gap-3 lg:flex-row lg:flex-wrap lg:items-end\"\u003e\n                \u003cselect\n                    class=\"w-full lg:w-auto border border-form-control-border bg-form-control-bg text-form-control-text rounded-md px-2 py-1\"\n                    on:change=move |ev| on_status_change(event_target_value(\u0026ev))\n                \u003e\n                    \u003coption value=\"\"\u003e{ \"すべて\" }\u003c/option\u003e\n                    \u003coption value=\"pending\"\u003e{ \"承認待ち\" }\u003c/option\u003e\n                    \u003coption value=\"approved\"\u003e{ \"承認済み\" }\u003c/option\u003e\n                    \u003coption value=\"rejected\"\u003e{ \"却下\" }\u003c/option\u003e\n                    \u003coption value=\"cancelled\"\u003e{ \"取消\" }\u003c/option\u003e\n                \u003c/select\u003e\n                \u003cdiv class=\"w-full lg:min-w-[220px] lg:flex-1\"\u003e\n                    \u003cAdminUserSelect\n                        users=users\n                        selected=filter.user_id_signal()\n                        label=Some(\"ユーザー\".into())\n                        placeholder=\"全ユーザー\".into()\n                    /\u003e\n                \u003c/div\u003e\n                \u003cbutton\n                    class=\"w-full lg:w-auto px-3 py-1 bg-action-primary-bg text-action-primary-text rounded\"\n                    disabled={move || requests_loading.get()}\n                    on:click=on_search\n                \u003e\n                    \u003cspan class=\"inline-flex items-center gap-2\"\u003e\n                        \u003cShow when=move || requests_loading.get()\u003e\n                            \u003cspan class=\"h-4 w-4 animate-spin rounded-full border-2 border-action-primary-text/70 border-t-transparent\"\u003e\u003c/span\u003e\n                        \u003c/Show\u003e\n                        {move || if requests_loading.get() { \"検索中...\" } else { \"検索\" }}\n                    \u003c/span\u003e\n                \u003c/button\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || requests_error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={requests_error} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || requests_loading.get()\u003e\n                \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                    \u003cLoadingSpinner /\u003e\n                    \u003cspan\u003e{\"申請情報を読み込み中...\"}\u003c/span\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n            \u003cdiv class=\"overflow-x-auto\"\u003e\n                \u003ctable class=\"min-w-full divide-y divide-border\"\u003e\n                    \u003cthead class=\"bg-surface-muted\"\u003e\n                        \u003ctr\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"種別\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"対象\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"ユーザー\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"ステータス\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"操作\"}\u003c/th\u003e\n                        \u003c/tr\u003e\n                    \u003c/thead\u003e\n                    \u003ctbody class=\"bg-surface-elevated divide-y divide-border\"\u003e\n                        \u003cShow when=move || requests_data.get().is_object()\u003e\n                            {let data = requests_data.get();\n                                let leaves = data.get(\"leave_requests\").cloned().unwrap_or(json!([]));\n                                let ots = data.get(\"overtime_requests\").cloned().unwrap_or(json!([]));\n                                let mut rows: Vec\u003cValue\u003e = vec![];\n                                if let Some(arr) = leaves.as_array() {\n                                    for r in arr {\n                                        rows.push(json!({\"kind\":\"leave\",\"data\": r}));\n                                    }\n                                }\n                                if let Some(arr) = ots.as_array() {\n                                    for r in arr {\n                                        rows.push(json!({\"kind\":\"overtime\",\"data\": r}));\n                                    }\n                                }\n                                if rows.is_empty() {\n                                    view! {\n                                        \u003ctr\u003e\n                                            \u003ctd colspan=\"5\" class=\"p-4 bg-surface-muted\"\u003e\n                                                \u003cEmptyState\n                                                    title=\"申請がありません\"\n                                                    description=\"表示できる申請データが見つかりませんでした。\"\n                                                /\u003e\n                                            \u003c/td\u003e\n                                        \u003c/tr\u003e\n                                    }.into_view()\n                                } else {\n                                    view! { \u003c\u003e\n                                        {rows.into_iter().map(|row| {\n                                        let kind = row.get(\"kind\").and_then(|v| v.as_str()).unwrap_or(\"\").to_string();\n                                        let data = row.get(\"data\").cloned().unwrap_or(json!({}));\n                                        let statusv = data.get(\"status\").and_then(|v| v.as_str()).unwrap_or(\"\").to_string();\n                                        let user = data.get(\"user_id\").and_then(|v| v.as_str()).unwrap_or(\"\").to_string();\n                                        let target = if kind == \"leave\" {\n                                            format!(\n                                                \"{} - {}\",\n                                                data.get(\"start_date\").and_then(|v| v.as_str()).unwrap_or(\"\"),\n                                                data.get(\"end_date\").and_then(|v| v.as_str()).unwrap_or(\"\")\n                                            )\n                                        } else {\n                                            data.get(\"date\").and_then(|v| v.as_str()).unwrap_or(\"\").to_string()\n                                        };\n                                        let open = {\n                                            let data = data.clone();\n                                            move |_| open_modal(data.clone())\n                                        };\n                                        let kind_label = if kind == \"leave\" { \"休暇\" } else { \"残業\" };\n                                        view! {\n                                            \u003ctr\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e{kind_label}\u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e{target.clone()}\u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e{user.clone()}\u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap\"\u003e\n                                                    \u003cspan class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-status-neutral-bg text-status-neutral-text\"\u003e\n                                                        {statusv.clone()}\n                                                    \u003c/span\u003e\n                                                \u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-right text-sm\"\u003e\n                                                    \u003cbutton class=\"text-link hover:text-link-hover\" on:click=open\u003e{\"詳細\"}\u003c/button\u003e\n                                                \u003c/td\u003e\n                                            \u003c/tr\u003e\n                                        }\n                                        }).collect::\u003cVec\u003c_\u003e\u003e()}\n                                    \u003c/\u003e }.into_view()\n                                }\n                            }\n                        \u003c/Show\u003e\n                    \u003c/tbody\u003e\n                \u003c/table\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || modal_open.get()\u003e\n                \u003cdiv class=\"fixed inset-0 bg-overlay-backdrop flex items-center justify-center z-50\"\u003e\n                    \u003cdiv class=\"bg-surface-elevated rounded-lg shadow-lg w-full max-w-lg p-6\"\u003e\n                        \u003ch3 class=\"text-lg font-medium text-fg mb-2\"\u003e{\"申請詳細\"}\u003c/h3\u003e\n                        \u003cpre class=\"text-xs bg-surface-muted text-fg p-2 rounded overflow-auto max-h-64\"\u003e{format!(\"{}\", modal_data.get())}\u003c/pre\u003e\n                        \u003cdiv class=\"mt-3\"\u003e\n                            \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"コメント（任意）\"}\u003c/label\u003e\n                            \u003ctextarea\n                                class=\"w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                                on:input=move |ev| modal_comment.set(event_target_value(\u0026ev))\n                            \u003e\u003c/textarea\u003e\n                        \u003c/div\u003e\n                        \u003cShow when=move || action_error.get().is_some()\u003e\n                            \u003cInlineErrorMessage error={action_error.into()} /\u003e\n                        \u003c/Show\u003e\n                        \u003cdiv class=\"mt-4 flex justify-end space-x-2\"\u003e\n                            \u003cbutton class=\"px-3 py-1 rounded border border-border text-fg hover:bg-action-ghost-bg-hover\" on:click=move |_| modal_open.set(false)\u003e{\"閉じる\"}\u003c/button\u003e\n                            \u003cbutton\n                                class=\"px-3 py-1 rounded bg-action-danger-bg text-action-danger-text disabled:opacity-50\"\n                                disabled={move || action_pending.get()}\n                                on:click=move |_| on_action(false)\n                            \u003e\n                                {\"却下\"}\n                            \u003c/button\u003e\n                            \u003cbutton\n                                class=\"px-3 py-1 rounded bg-action-primary-bg text-action-primary-text disabled:opacity-50\"\n                                disabled={move || action_pending.get()}\n                                on:click=move |_| on_action(true)\n                            \u003e\n                                {\"承認\"}\n                            \u003c/button\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","subject_requests.rs"],"content":"use crate::{\n    components::layout::{ErrorMessage, LoadingSpinner},\n    pages::admin::{\n        components::user_select::{AdminUserSelect, UsersResource},\n        utils::SubjectRequestFilterState,\n        view_model::SubjectRequestActionPayload,\n    },\n};\nuse chrono::DateTime;\nuse leptos::*;\nuse serde_json::to_string_pretty;\n\nuse crate::api::{\n    ApiError, DataSubjectRequestResponse, DataSubjectRequestType, SubjectRequestListResponse,\n};\n\n#[component]\npub fn AdminSubjectRequestsSection(\n    users: UsersResource,\n    filter: SubjectRequestFilterState,\n    resource: Resource\u003c\n        (\n            bool,\n            crate::pages::admin::utils::SubjectRequestFilterSnapshot,\n            u32,\n        ),\n        Result\u003cSubjectRequestListResponse, ApiError\u003e,\n    \u003e,\n    action: Action\u003cSubjectRequestActionPayload, Result\u003c(), ApiError\u003e\u003e,\n    action_error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    reload: RwSignal\u003cu32\u003e,\n) -\u003e impl IntoView {\n    let modal_open = create_rw_signal(false);\n    let modal_request = create_rw_signal(None::\u003cDataSubjectRequestResponse\u003e);\n    let modal_comment = create_rw_signal(String::new());\n\n    let modal_detail = Signal::derive(move || {\n        modal_request\n            .get()\n            .and_then(|request| to_string_pretty(\u0026request).ok())\n            .unwrap_or_default()\n    });\n    let modal_pending = Signal::derive(move || {\n        modal_request\n            .get()\n            .map(|request| request.status == \"pending\")\n            .unwrap_or(false)\n    });\n\n    let loading = resource.loading();\n    let data = Signal::derive(move || resource.get().and_then(|result| result.ok()));\n    let error = Signal::derive(move || resource.get().and_then(|result| result.err()));\n\n    let action_pending = action.pending();\n\n    create_effect(move |_| {\n        if let Some(result) = action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    modal_open.set(false);\n                    modal_request.set(None);\n                    modal_comment.set(String::new());\n                    action_error.set(None);\n                    reload.update(|value| *value = value.wrapping_add(1));\n                }\n                Err(err) =\u003e action_error.set(Some(err)),\n            }\n        }\n    });\n\n    let trigger_reload = move || reload.update(|value| *value = value.wrapping_add(1));\n\n    let on_status_change = move |value: String| {\n        filter.status_signal().set(value);\n        filter.reset_page();\n        trigger_reload();\n    };\n\n    let on_type_change = move |value: String| {\n        filter.request_type_signal().set(value);\n        filter.reset_page();\n        trigger_reload();\n    };\n\n    let on_search = move |_| {\n        filter.reset_page();\n        trigger_reload();\n    };\n\n    let open_modal = Callback::new(move |request: DataSubjectRequestResponse| {\n        modal_request.set(Some(request));\n        modal_comment.set(String::new());\n        modal_open.set(true);\n        action_error.set(None);\n    });\n\n    let on_action = move |approve: bool| {\n        let comment = modal_comment.get();\n        if comment.trim().is_empty() {\n            action_error.set(Some(ApiError::validation(\"コメントを入力してください。\")));\n            return;\n        }\n        let Some(request) = modal_request.get() else {\n            action_error.set(Some(ApiError::validation(\n                \"申請情報を取得できませんでした。\",\n            )));\n            return;\n        };\n        action.dispatch(SubjectRequestActionPayload {\n            id: request.id,\n            comment,\n            approve,\n        });\n    };\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003ch3 class=\"text-lg font-medium text-fg\"\u003e{\"本人対応申請\"}\u003c/h3\u003e\n            \u003cdiv class=\"flex flex-col gap-3 lg:flex-row lg:flex-wrap lg:items-end\"\u003e\n                \u003cselect\n                    class=\"w-full lg:w-auto border border-form-control-border bg-form-control-bg text-form-control-text rounded-md px-2 py-1\"\n                    on:change=move |ev| on_status_change(event_target_value(\u0026ev))\n                \u003e\n                    \u003coption value=\"\"\u003e{ \"すべて\" }\u003c/option\u003e\n                    \u003coption value=\"pending\"\u003e{ \"承認待ち\" }\u003c/option\u003e\n                    \u003coption value=\"approved\"\u003e{ \"承認済み\" }\u003c/option\u003e\n                    \u003coption value=\"rejected\"\u003e{ \"却下\" }\u003c/option\u003e\n                    \u003coption value=\"cancelled\"\u003e{ \"取消\" }\u003c/option\u003e\n                \u003c/select\u003e\n                \u003cselect\n                    class=\"w-full lg:w-auto border border-form-control-border bg-form-control-bg text-form-control-text rounded-md px-2 py-1\"\n                    on:change=move |ev| on_type_change(event_target_value(\u0026ev))\n                \u003e\n                    \u003coption value=\"\"\u003e{ \"請求種別\" }\u003c/option\u003e\n                    \u003coption value=\"access\"\u003e{ \"開示\" }\u003c/option\u003e\n                    \u003coption value=\"rectify\"\u003e{ \"訂正\" }\u003c/option\u003e\n                    \u003coption value=\"delete\"\u003e{ \"削除\" }\u003c/option\u003e\n                    \u003coption value=\"stop\"\u003e{ \"停止\" }\u003c/option\u003e\n                \u003c/select\u003e\n                \u003cdiv class=\"w-full lg:min-w-[220px] lg:flex-1\"\u003e\n                    \u003cAdminUserSelect\n                        users=users\n                        selected=filter.user_id_signal()\n                        label=Some(\"請求種別\".into())\n                        placeholder=\"全ユーザー\".into()\n                    /\u003e\n                \u003c/div\u003e\n                \u003cbutton\n                    class=\"w-full lg:w-auto px-3 py-1 bg-action-primary-bg text-action-primary-text rounded\"\n                    disabled={move || loading.get()}\n                    on:click=on_search\n                \u003e\n                    \u003cspan class=\"inline-flex items-center gap-2\"\u003e\n                        \u003cShow when=move || loading.get()\u003e\n                            \u003cspan class=\"h-4 w-4 animate-spin rounded-full border-2 border-action-primary-text/70 border-t-transparent\"\u003e\u003c/span\u003e\n                        \u003c/Show\u003e\n                        {move || if loading.get() { \"検索中...\" } else { \"検索\" }}\n                    \u003c/span\u003e\n                \u003c/button\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || error.get().is_some()\u003e\n                \u003cErrorMessage message={error.get().map(|err| err.to_string()).unwrap_or_default()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || loading.get()\u003e\n                \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                    \u003cLoadingSpinner /\u003e\n                    \u003cspan\u003e{\"本人対応申請を読み込み中...\"}\u003c/span\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n            \u003cdiv class=\"overflow-x-auto\"\u003e\n                \u003ctable class=\"min-w-full divide-y divide-border\"\u003e\n                    \u003cthead class=\"bg-surface-muted\"\u003e\n                        \u003ctr\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"種別\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"ユーザー\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"ステータス\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"申請日\"}\u003c/th\u003e\n                            \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"操作\"}\u003c/th\u003e\n                        \u003c/tr\u003e\n                    \u003c/thead\u003e\n                    \u003ctbody class=\"bg-surface-elevated divide-y divide-border\"\u003e\n                        \u003cShow when=move || data.get().is_some()\u003e\n                            {move || {\n                                data.get()\n                                    .map(|payload| {\n                                        payload\n                                            .items\n                                            .into_iter()\n                                            .map(|item| {\n                                                let status_label = item.status.clone();\n                                                let created_label = format_datetime(item.created_at);\n                                                let type_label = type_label(\u0026item.request_type);\n                                                let id = item.id.clone();\n                                                let open = {\n                                                    let item = item.clone();\n                                                    let open_modal = open_modal.clone();\n                                                    move |_| open_modal.call(item.clone())\n                                                };\n                                                view! {\n                                                    \u003ctr\u003e\n                                                        \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e{type_label}\u003c/td\u003e\n                                                        \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e{item.user_id}\u003c/td\u003e\n                                                        \u003ctd class=\"px-6 py-4 whitespace-nowrap\"\u003e\n                                                            \u003cspan class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-status-neutral-bg text-status-neutral-text\"\u003e\n                                                                {status_label}\n                                                            \u003c/span\u003e\n                                                        \u003c/td\u003e\n                                                        \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e{created_label}\u003c/td\u003e\n                                                        \u003ctd class=\"px-6 py-4 whitespace-nowrap text-right text-sm\"\u003e\n                                                            \u003cbutton class=\"text-link hover:text-link-hover\" on:click=open\u003e{\"詳細\"}\u003c/button\u003e\n                                                            \u003cspan class=\"sr-only\"\u003e{id}\u003c/span\u003e\n                                                        \u003c/td\u003e\n                                                    \u003c/tr\u003e\n                                                }\n                                            })\n                                            .collect::\u003cVec\u003c_\u003e\u003e()\n                                    })\n                                    .unwrap_or_default()\n                            }}\n                        \u003c/Show\u003e\n                    \u003c/tbody\u003e\n                \u003c/table\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || modal_open.get()\u003e\n                \u003cdiv class=\"fixed inset-0 bg-overlay-backdrop flex items-center justify-center z-50\"\u003e\n                    \u003cdiv class=\"bg-surface-elevated rounded-lg shadow-lg w-full max-w-lg p-6\"\u003e\n                        \u003ch3 class=\"text-lg font-medium text-fg mb-2\"\u003e{\"本人対応申請の詳細\"}\u003c/h3\u003e\n                        \u003cpre class=\"text-xs bg-surface-muted text-fg p-2 rounded overflow-auto max-h-64 whitespace-pre-wrap\"\u003e{move || modal_detail.get()}\u003c/pre\u003e\n                        \u003cdiv class=\"mt-3\"\u003e\n                            \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"コメント\"}\u003c/label\u003e\n                            \u003ctextarea\n                                class=\"w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                                on:input=move |ev| modal_comment.set(event_target_value(\u0026ev))\n                            \u003e\u003c/textarea\u003e\n                        \u003c/div\u003e\n                        \u003cShow when=move || action_error.get().is_some()\u003e\n                            \u003cErrorMessage\n                                message={action_error\n                                    .get()\n                                    .map(|err| err.to_string())\n                                    .unwrap_or_default()}\n                            /\u003e\n                        \u003c/Show\u003e\n                        \u003cdiv class=\"mt-4 flex justify-end space-x-2\"\u003e\n                            \u003cbutton class=\"px-3 py-1 rounded border border-border text-fg hover:bg-action-ghost-bg-hover\" on:click=move |_| modal_open.set(false)\u003e{\"閉じる\"}\u003c/button\u003e\n                            \u003cbutton\n                                class=\"px-3 py-1 rounded bg-action-danger-bg text-action-danger-text disabled:opacity-50\"\n                                disabled={move || action_pending.get() || !modal_pending.get()}\n                                on:click=move |_| on_action(false)\n                            \u003e\n                                {\"却下\"}\n                            \u003c/button\u003e\n                            \u003cbutton\n                                class=\"px-3 py-1 rounded bg-action-primary-bg text-action-primary-text disabled:opacity-50\"\n                                disabled={move || action_pending.get() || !modal_pending.get()}\n                                on:click=move |_| on_action(true)\n                            \u003e\n                                {\"承認\"}\n                            \u003c/button\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n\nfn type_label(request_type: \u0026DataSubjectRequestType) -\u003e \u0026'static str {\n    match request_type {\n        DataSubjectRequestType::Access =\u003e \"開示\",\n        DataSubjectRequestType::Rectify =\u003e \"訂正\",\n        DataSubjectRequestType::Delete =\u003e \"削除\",\n        DataSubjectRequestType::Stop =\u003e \"停止\",\n    }\n}\n\nfn format_datetime(value: DateTime\u003cchrono::Utc\u003e) -\u003e String {\n    value.format(\"%Y-%m-%d %H:%M\").to_string()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","system_tools.rs"],"content":"use crate::{\n    api::ApiError,\n    components::{error::InlineErrorMessage, layout::SuccessMessage},\n    pages::admin::{\n        components::user_select::{AdminUserSelect, UsersResource},\n        repository::AdminRepository,\n    },\n};\nuse leptos::*;\n\n#[component]\npub fn AdminMfaResetSection(\n    repository: AdminRepository,\n    system_admin_allowed: Memo\u003cbool\u003e,\n    users: UsersResource,\n) -\u003e impl IntoView {\n    let user_id = create_rw_signal(String::new());\n    let error = create_rw_signal(None::\u003cApiError\u003e);\n    let success = create_rw_signal(None::\u003cString\u003e);\n    let repo_for_reset = repository.clone();\n    let reset_action = create_action(move |target: \u0026String| {\n        let repo = repo_for_reset.clone();\n        let user_id = target.clone();\n        async move {\n            if user_id.trim().is_empty() {\n                Err(ApiError::validation(\"ユーザーIDを入力してください。\"))\n            } else {\n                repo.reset_mfa(\u0026user_id).await\n            }\n        }\n    });\n    let pending = reset_action.pending();\n    {\n        create_effect(move |_| {\n            if let Some(result) = reset_action.value().get() {\n                match result {\n                    Ok(_) =\u003e {\n                        error.set(None);\n                        success.set(Some(\"MFA をリセットしました。\".into()));\n                    }\n                    Err(err) =\u003e {\n                        success.set(None);\n                        error.set(Some(err));\n                    }\n                }\n            }\n        });\n    }\n\n    let on_reset = {\n        move |_| {\n            if !system_admin_allowed.get_untracked() {\n                return;\n            }\n            let value = user_id.get();\n            if value.trim().is_empty() {\n                error.set(Some(ApiError::validation(\"ユーザーIDを入力してください。\")));\n                success.set(None);\n                return;\n            }\n            error.set(None);\n            success.set(None);\n            reset_action.dispatch(value);\n        }\n    };\n\n    view! {\n        \u003cShow when=move || system_admin_allowed.get()\u003e\n            \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6\"\u003e\n                \u003ch3 class=\"text-lg font-medium text-fg mb-4\"\u003e{\"MFA リセット\"}\u003c/h3\u003e\n                \u003cdiv class=\"flex flex-col gap-2\"\u003e\n                    \u003cAdminUserSelect\n                        users=users\n                        selected=user_id\n                        label=Some(\"対象ユーザー\".into())\n                        placeholder=\"ユーザーを選択してください\".into()\n                    /\u003e\n                    \u003cbutton\n                        class=\"px-3 py-1 rounded bg-action-primary-bg text-action-primary-text disabled:opacity-50\"\n                        disabled={move || pending.get()}\n                        on:click=on_reset\n                    \u003e\n                        \u003cspan class=\"inline-flex items-center gap-2\"\u003e\n                            \u003cShow when=move || pending.get()\u003e\n                                \u003cspan class=\"h-4 w-4 animate-spin rounded-full border-2 border-action-primary-text/70 border-t-transparent\"\u003e\u003c/span\u003e\n                            \u003c/Show\u003e\n                            {move || if pending.get() { \"リセット中...\" } else { \"MFA をリセット\" }}\n                        \u003c/span\u003e\n                    \u003c/button\u003e\n                    \u003cShow when=move || error.get().is_some()\u003e\n                        \u003cInlineErrorMessage error={error.into()} /\u003e\n                    \u003c/Show\u003e\n                    \u003cShow when=move || success.get().is_some()\u003e\n                        \u003cSuccessMessage message={success.get().unwrap_or_default()} /\u003e\n                    \u003c/Show\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","user_select.rs"],"content":"use crate::{\n    api::{ApiError, UserResponse},\n    components::{error::InlineErrorMessage, layout::LoadingSpinner},\n};\nuse leptos::{ev, *};\n\npub type UsersResource = Resource\u003cbool, Result\u003cVec\u003cUserResponse\u003e, ApiError\u003e\u003e;\n\n#[derive(Copy, Clone, Debug, Default, PartialEq, Eq)]\npub enum UserSelectValue {\n    #[default]\n    Id,\n    Username,\n}\n\n#[component]\npub fn AdminUserSelect(\n    users: UsersResource,\n    selected: RwSignal\u003cString\u003e,\n    #[prop(optional_no_strip)] label: Option\u003cString\u003e,\n    #[prop(default = \"ユーザーを選択\".to_string())] placeholder: String,\n    #[prop(default = UserSelectValue::Id)] value_kind: UserSelectValue,\n    #[prop(into, default = MaybeSignal::Static(false))] disabled: MaybeSignal\u003cbool\u003e,\n) -\u003e impl IntoView {\n    let fetch_error = create_rw_signal(None::\u003cApiError\u003e);\n    let loading = users.loading();\n\n    {\n        create_effect(move |_| {\n            if let Some(result) = users.get() {\n                match result {\n                    Ok(_) =\u003e fetch_error.set(None),\n                    Err(err) =\u003e fetch_error.set(Some(err)),\n                }\n            }\n        });\n    }\n\n    let on_change = {\n        move |ev: ev::Event| {\n            selected.set(event_target_value(\u0026ev));\n        }\n    };\n\n    let has_label = label.as_ref().map(|l| !l.is_empty()).unwrap_or(false);\n    let label_value = label.unwrap_or_default();\n\n    let on_retry = {\n        move |_| {\n            fetch_error.set(None);\n            users.refetch();\n        }\n    };\n\n    let options_view = move || {\n        if loading.get() {\n            return view! { \u003coption value=\"\" disabled\u003e{\"ユーザーを読み込み中...\"}\u003c/option\u003e }\n                .into_view();\n        }\n        match users.get() {\n            None =\u003e {\n                view! { \u003coption value=\"\" disabled\u003e{\"ユーザーを読み込み中...\"}\u003c/option\u003e }.into_view()\n            }\n            Some(Err(_)) =\u003e {\n                view! { \u003coption value=\"\" disabled\u003e{\"ユーザーの取得に失敗しました\"}\u003c/option\u003e }\n                    .into_view()\n            }\n            Some(Ok(list)) if list.is_empty() =\u003e {\n                view! { \u003coption value=\"\" disabled\u003e{\"ユーザーが0件です\"}\u003c/option\u003e }.into_view()\n            }\n            Some(Ok(list)) =\u003e {\n                let mut sorted = list.clone();\n                sorted.sort_by(|left, right| {\n                    let name_cmp = left.full_name.cmp(\u0026right.full_name);\n                    if name_cmp == std::cmp::Ordering::Equal {\n                        left.username.cmp(\u0026right.username)\n                    } else {\n                        name_cmp\n                    }\n                });\n                view! {\n                    \u003cFor\n                        each=move || sorted.clone()\n                        key=|user| user.id.clone()\n                        children=move |user| {\n                            let label = format!(\"{} ({})\", user.full_name, user.username);\n                            let value = match value_kind {\n                                UserSelectValue::Id =\u003e user.id.clone(),\n                                UserSelectValue::Username =\u003e user.username.clone(),\n                        };\n                        view! { \u003coption value=value\u003e{label}\u003c/option\u003e }\n                    }\n                    /\u003e\n                }\n                .into_view()\n            }\n        }\n    };\n\n    view! {\n        \u003cdiv class=\"space-y-1\"\u003e\n            \u003cShow when=move || has_label\u003e\n                \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\n                    {label_value.clone()}\n                \u003c/label\u003e\n            \u003c/Show\u003e\n            \u003cselect\n                class=\"w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1 disabled:opacity-50\"\n                on:change=on_change\n                prop:value=selected\n                disabled=disabled\n            \u003e\n                \u003coption value=\"\"\u003e{placeholder.clone()}\u003c/option\u003e\n                {move || options_view()}\n            \u003c/select\u003e\n            \u003cShow when=move || fetch_error.get().is_some()\u003e\n                \u003cdiv class=\"flex items-center gap-2\"\u003e\n                    \u003cInlineErrorMessage error={fetch_error.into()} /\u003e\n                    \u003cbutton\n                        class=\"text-sm text-link hover:text-link-hover hover:underline disabled:opacity-50\"\n                        on:click=on_retry\n                        disabled=move || loading.get()\n                    \u003e\n                        {\"再試行\"}\n                    \u003c/button\u003e\n                    \u003cShow when=move || loading.get()\u003e\n                        \u003cLoadingSpinner /\u003e\n                    \u003c/Show\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","components","weekly_holidays.rs"],"content":"use crate::{\n    api::{ApiError, CreateWeeklyHolidayRequest, WeeklyHolidayResponse},\n    components::{\n        error::InlineErrorMessage,\n        forms::DatePicker,\n        layout::{LoadingSpinner, SuccessMessage},\n    },\n    pages::admin::utils::WeeklyHolidayFormState,\n    utils::time::today_in_app_tz,\n};\nuse leptos::{ev, *};\n\n#[component]\npub fn WeeklyHolidaySection(\n    state: WeeklyHolidayFormState,\n    resource: Resource\u003c(bool, u32), Result\u003cVec\u003cWeeklyHolidayResponse\u003e, ApiError\u003e\u003e,\n    action: Action\u003cCreateWeeklyHolidayRequest, Result\u003cWeeklyHolidayResponse, ApiError\u003e\u003e,\n    delete_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n    reload: RwSignal\u003cu32\u003e,\n    message: RwSignal\u003cOption\u003cString\u003e\u003e,\n    error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    admin_allowed: Memo\u003cbool\u003e,\n    system_admin_allowed: Memo\u003cbool\u003e,\n) -\u003e impl IntoView {\n    let weekday_signal = state.weekday_signal();\n    let starts_on_signal = state.starts_on_signal();\n    let ends_on_signal = state.ends_on_signal();\n\n    let holidays_loading = resource.loading();\n    let holidays_data = Signal::derive(move || {\n        resource\n            .get()\n            .and_then(|result| result.ok())\n            .unwrap_or_default()\n    });\n    let holidays_error = Signal::derive(move || resource.get().and_then(|result| result.err()));\n\n    let create_pending = action.pending();\n\n    // Effects and submission logic\n    create_effect(move |_| {\n        if let Some(result) = action.value().get() {\n            match result {\n                Ok(created) =\u003e {\n                    message.set(Some(format!(\n                        \"{} ({}) を登録しました。\",\n                        crate::pages::admin::utils::weekday_label(created.weekday),\n                        created.starts_on.format(\"%Y-%m-%d\")\n                    )));\n                    error.set(None);\n                    state.reset_starts_on(created.starts_on);\n                    state.reset_ends_on();\n                    reload.update(|value| *value = value.wrapping_add(1));\n                }\n                Err(err) =\u003e error.set(Some(err)),\n            }\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = delete_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    message.set(Some(\"週次休日を削除しました。\".into()));\n                    error.set(None);\n                    reload.update(|value| *value = value.wrapping_add(1));\n                }\n                Err(err) =\u003e error.set(Some(err)),\n            }\n        }\n    });\n\n    let on_submit = move |ev: ev::SubmitEvent| {\n        ev.prevent_default();\n        if !admin_allowed.get_untracked() {\n            return;\n        }\n        let min_start = crate::pages::admin::utils::next_allowed_weekly_start(\n            today_in_app_tz(),\n            system_admin_allowed.get_untracked(),\n        );\n        message.set(None);\n        match state.to_payload(min_start) {\n            Ok(payload) =\u003e {\n                error.set(None);\n                action.dispatch(payload);\n            }\n            Err(err) =\u003e error.set(Some(err)),\n        }\n    };\n\n    let on_refresh = move |_| reload.update(|value| *value = value.wrapping_add(1));\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv class=\"flex flex-col gap-1 lg:flex-row lg:items-center lg:justify-between\"\u003e\n                \u003cdiv\u003e\n                    \u003ch2 class=\"text-lg font-semibold text-fg\"\u003e{\"週次休日\"}\u003c/h2\u003e\n                    \u003cp class=\"text-sm text-fg-muted\"\u003e\n                        {\"週単位の休日を登録します。システム管理者は即日開始も設定できます。\"}\n                    \u003c/p\u003e\n                \u003c/div\u003e\n                \u003cbutton\n                    class=\"px-3 py-1 rounded border border-border text-sm text-fg hover:bg-action-ghost-bg-hover disabled:opacity-50\"\n                    disabled={move || holidays_loading.get()}\n                    on:click=on_refresh\n                \u003e\n                    {\"再取得\"}\n                \u003c/button\u003e\n            \u003c/div\u003e\n            \u003cform class=\"grid gap-3 lg:grid-cols-3\" on:submit=on_submit\u003e\n                \u003cdiv class=\"lg:col-span-1\"\u003e\n                    \u003clabel class=\"block text-sm font-bold text-fg-muted ml-1 mb-1.5\"\u003e{\"曜日\"}\u003c/label\u003e\n                    \u003cdiv class=\"relative\"\u003e\n                        \u003cselect\n                            class=\"appearance-none w-full rounded-xl border-2 border-form-control-border bg-form-control-bg text-fg py-2.5 px-4 shadow-sm focus:outline-none focus:border-action-primary-border-hover focus:ring-4 focus:ring-action-primary-focus transition-all duration-200\"\n                            prop:value={move || weekday_signal.get()}\n                            on:change=move |ev| weekday_signal.set(event_target_value(\u0026ev))\n                        \u003e\n                            \u003coption value=\"0\"\u003e{\"日 (0)\"}\u003c/option\u003e\n                            \u003coption value=\"1\"\u003e{\"月 (1)\"}\u003c/option\u003e\n                            \u003coption value=\"2\"\u003e{\"火 (2)\"}\u003c/option\u003e\n                            \u003coption value=\"3\"\u003e{\"水 (3)\"}\u003c/option\u003e\n                            \u003coption value=\"4\"\u003e{\"木 (4)\"}\u003c/option\u003e\n                            \u003coption value=\"5\"\u003e{\"金 (5)\"}\u003c/option\u003e\n                            \u003coption value=\"6\"\u003e{\"土 (6)\"}\u003c/option\u003e\n                        \u003c/select\u003e\n                        \u003cdiv class=\"pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-fg-muted\"\u003e\n                            \u003ci class=\"fas fa-chevron-down text-xs\"\u003e\u003c/i\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"lg:col-span-1\"\u003e\n                    \u003cDatePicker\n                        label=Some(\"稼働開始日\")\n                        value=starts_on_signal\n                    /\u003e\n                    \u003cp class=\"text-xs text-fg-muted mt-1\"\u003e\n                        {move || {\n                            if system_admin_allowed.get() {\n                                \"システム管理者は本日から設定できます。\"\n                            } else {\n                                \"通常管理者は翌日以降が設定可能です。\"\n                            }\n                        }}\n                    \u003c/p\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"lg:col-span-1\"\u003e\n                    \u003cDatePicker\n                        label=Some(\"稼働終了日（任意）\")\n                        value=ends_on_signal\n                    /\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"lg:col-span-3\"\u003e\n                    \u003cbutton\n                        type=\"submit\"\n                        class=\"w-full lg:w-auto px-4 py-2 rounded bg-action-primary-bg text-action-primary-text hover:bg-action-primary-bg-hover disabled:opacity-50\"\n                        disabled={move || create_pending.get()}\n                    \u003e\n                        {move || if create_pending.get() { \"登録中...\" } else { \"週次休日を登録\" }}\n                    \u003c/button\u003e\n                \u003c/div\u003e\n            \u003c/form\u003e\n            \u003cShow when=move || error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={error.into()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || message.get().is_some()\u003e\n                \u003cSuccessMessage message={message.get().unwrap_or_default()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || holidays_error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={holidays_error} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || holidays_loading.get()\u003e\n                \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                    \u003cLoadingSpinner /\u003e\n                    \u003cspan\u003e{\"週次休日を読み込み中です...\"}\u003c/span\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || !holidays_loading.get() \u0026\u0026 holidays_data.get().is_empty()\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"登録済みの週次休日はありません。\"} \u003c/p\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || !holidays_loading.get() \u0026\u0026 !holidays_data.get().is_empty()\u003e\n                \u003cdiv class=\"overflow-x-auto\"\u003e\n                    \u003ctable class=\"min-w-full divide-y divide-border text-sm\"\u003e\n                        \u003cthead class=\"bg-surface-muted\"\u003e\n                            \u003ctr\u003e\n                                \u003cth class=\"px-4 py-2 text-left text-fg-muted\"\u003e{\"曜日\"}\u003c/th\u003e\n                                \u003cth class=\"px-4 py-2 text-left text-fg-muted\"\u003e{\"指定期間\"}\u003c/th\u003e\n                                \u003cth class=\"px-4 py-2 text-left text-fg-muted\"\u003e{\"適用期間\"}\u003c/th\u003e\n                                \u003cth class=\"px-4 py-2 text-right text-fg-muted\"\u003e{\"操作\"}\u003c/th\u003e\n                            \u003c/tr\u003e\n                        \u003c/thead\u003e\n                        \u003ctbody class=\"divide-y divide-border\"\u003e\n                            \u003cFor\n                                each=move || holidays_data.get()\n                                key=|item| item.id.clone()\n                                children=move |item| {\n                                    view! {\n                                        \u003ctr\u003e\n                                            \u003ctd class=\"px-4 py-2 text-fg\"\u003e{crate::pages::admin::utils::weekday_label(item.weekday)}\u003c/td\u003e\n                                            \u003ctd class=\"px-4 py-2 text-fg-muted\"\u003e\n                                                {format!(\n                                                    \"{} 〜 {}\",\n                                                    item.starts_on.format(\"%Y-%m-%d\"),\n                                                    item\n                                                        .ends_on\n                                                        .map(|d| d.format(\"%Y-%m-%d\").to_string())\n                                                        .unwrap_or_else(|| \"未設定\".into())\n                                                )}\n                                            \u003c/td\u003e\n                                            \u003ctd class=\"px-4 py-2 text-fg-muted\"\u003e\n                                                {format!(\n                                                    \"{} 〜 {}\",\n                                                    item.enforced_from.format(\"%Y-%m-%d\"),\n                                                    item\n                                                        .enforced_to\n                                                        .map(|d| d.format(\"%Y-%m-%d\").to_string())\n                                                        .unwrap_or_else(|| \"適用中\".into())\n                                                )}\n                                            \u003c/td\u003e\n                                            \u003ctd class=\"px-4 py-2 text-right\"\u003e\n                                                \u003cbutton\n                                                    class=\"text-action-danger-bg hover:text-action-danger-bg-hover disabled:opacity-50\"\n                                                    disabled={move || delete_action.pending().get()}\n                                                    on:click={\n                                                        let id = item.id.clone();\n                                                        move |_| {\n                                                            if let Some(window) = web_sys::window() {\n                                                                if let Ok(true) = window.confirm_with_message(\"この週次休日を削除してもよろしいですか？\") {\n                                                                    delete_action.dispatch(id.clone());\n                                                                }\n                                                            }\n                                                        }\n                                                    }\n                                                \u003e\n                                                    {\"削除\"}\n                                                \u003c/button\u003e\n                                            \u003c/td\u003e\n                                        \u003c/tr\u003e\n                                    }\n                                }\n                            /\u003e\n                        \u003c/tbody\u003e\n                    \u003c/table\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","layout.rs"],"content":"use crate::components::layout::Layout;\nuse leptos::*;\n\n#[component]\npub fn UnauthorizedMessage() -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"space-y-6\"\u003e\n            \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6\"\u003e\n                \u003cp class=\"text-sm text-fg\"\u003e\n                    {\"このページは管理者以上の権限が必要です。\"}\n                \u003c/p\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn AdminDashboardFrame(children: Children) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"space-y-6\"\u003e\n            \u003cdiv\u003e\n                \u003ch1 class=\"text-2xl font-bold text-fg\"\u003e{\"管理者ツール\"}\u003c/h1\u003e\n                \u003cp class=\"mt-1 text-sm text-fg-muted\"\u003e\n                    {\"週次休日や申請、勤怠、MFA、祝日管理をまとめて実行できます。\"}\n                \u003c/p\u003e\n            \u003c/div\u003e\n            {children()}\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn AdminDashboardScaffold(admin_allowed: Memo\u003cbool\u003e, children: Children) -\u003e impl IntoView {\n    let content = store_value(children());\n    view! {\n        \u003cLayout\u003e\n            \u003cShow\n                when=move || admin_allowed.get()\n                fallback=move || view! { \u003cUnauthorizedMessage /\u003e }.into_view()\n            \u003e\n                \u003cAdminDashboardFrame\u003e\n                    {content.get_value().clone()}\n                \u003c/AdminDashboardFrame\u003e\n            \u003c/Show\u003e\n        \u003c/Layout\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","mod.rs"],"content":"use crate::components::guard::RequireAuth;\nuse leptos::*;\n\npub mod components;\npub mod layout;\npub mod panel;\npub mod repository;\npub mod utils;\npub mod view_model;\n\npub use panel::AdminPanel;\n\n#[component]\npub fn AdminPage() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cAdminPanel /\u003e\u003c/RequireAuth\u003e }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","panel.rs"],"content":"use crate::pages::admin::{\n    components::{\n        attendance::AdminAttendanceToolsSection, holidays::HolidayManagementSection,\n        requests::AdminRequestsSection, subject_requests::AdminSubjectRequestsSection,\n        system_tools::AdminMfaResetSection, weekly_holidays::WeeklyHolidaySection,\n    },\n    layout,\n    view_model::use_admin_view_model,\n};\nuse crate::state::auth::use_auth;\nuse leptos::*;\n\n#[component]\npub fn AdminPanel() -\u003e impl IntoView {\n    let (auth, _) = use_auth();\n    let admin_allowed = create_memo(move |_| {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin || user.role.eq_ignore_ascii_case(\"admin\"))\n            .unwrap_or(false)\n    });\n    let system_admin_allowed = create_memo(move |_| {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin)\n            .unwrap_or(false)\n    });\n\n    let vm = use_admin_view_model();\n\n    view! {\n        \u003clayout::AdminDashboardScaffold admin_allowed=admin_allowed\u003e\n            \u003cWeeklyHolidaySection\n                state=vm.weekly_holiday_state\n                resource=vm.weekly_holidays_resource\n                action=vm.create_weekly_action\n                delete_action=vm.delete_weekly_action\n                reload=vm.reload_weekly\n                message=vm.weekly_action_message\n                error=vm.weekly_action_error\n                admin_allowed=admin_allowed\n                system_admin_allowed=system_admin_allowed\n            /\u003e\n            \u003cdiv class=\"grid grid-cols-1 gap-6 lg:grid-cols-3\"\u003e\n                \u003cAdminRequestsSection\n                    users=vm.users_resource\n                    filter=vm.requests_filter\n                    resource=vm.requests_resource\n                    action=vm.request_action\n                    action_error=vm.requests_action_error\n                    reload=vm.reload_requests\n                /\u003e\n                \u003cAdminAttendanceToolsSection\n                    repository=vm.repository.clone()\n                    system_admin_allowed=system_admin_allowed\n                    users=vm.users_resource\n                /\u003e\n                \u003cAdminMfaResetSection\n                    repository=vm.repository.clone()\n                    system_admin_allowed=system_admin_allowed\n                    users=vm.users_resource\n                /\u003e\n            \u003c/div\u003e\n            \u003cAdminSubjectRequestsSection\n                users=vm.users_resource\n                filter=vm.subject_request_filter\n                resource=vm.subject_requests_resource\n                action=vm.subject_request_action\n                action_error=vm.subject_request_action_error\n                reload=vm.reload_subject_requests\n            /\u003e\n            \u003cHolidayManagementSection\n                repository=vm.repository.clone()\n                admin_allowed=admin_allowed\n            /\u003e\n        \u003c/layout::AdminDashboardScaffold\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","repository.rs"],"content":"use crate::api::{\n    AdminAttendanceUpsert, AdminHolidayKind, AdminHolidayListItem, ApiClient, ApiError,\n    CreateHolidayRequest, CreateWeeklyHolidayRequest, HolidayResponse, SubjectRequestListResponse,\n    UserResponse, WeeklyHolidayResponse,\n};\nuse chrono::NaiveDate;\nuse serde::{Deserialize, Serialize};\nuse serde_json::Value;\nuse std::rc::Rc;\n\n#[derive(Debug, Clone, PartialEq, Eq)]\npub struct HolidayListQuery {\n    pub page: i64,\n    pub per_page: i64,\n    pub from: Option\u003cNaiveDate\u003e,\n    pub to: Option\u003cNaiveDate\u003e,\n}\n\nimpl Default for HolidayListQuery {\n    fn default() -\u003e Self {\n        Self {\n            page: 1,\n            per_page: 10,\n            from: None,\n            to: None,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HolidayListResult {\n    pub page: i64,\n    pub per_page: i64,\n    pub total: i64,\n    pub items: Vec\u003cHolidayResponse\u003e,\n}\n\nimpl HolidayListResult {\n    pub fn empty(page: i64, per_page: i64) -\u003e Self {\n        Self {\n            page,\n            per_page,\n            total: 0,\n            items: Vec::new(),\n        }\n    }\n}\n\n#[derive(Clone)]\npub struct AdminRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl Default for AdminRepository {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl AdminRepository {\n    pub fn new() -\u003e Self {\n        Self {\n            client: Rc::new(ApiClient::new()),\n        }\n    }\n\n    pub fn new_with_client(client: Rc\u003cApiClient\u003e) -\u003e Self {\n        Self { client }\n    }\n\n    pub async fn list_weekly_holidays(\u0026self) -\u003e Result\u003cVec\u003cWeeklyHolidayResponse\u003e, ApiError\u003e {\n        self.client.admin_list_weekly_holidays().await\n    }\n\n    pub async fn create_weekly_holiday(\n        \u0026self,\n        payload: CreateWeeklyHolidayRequest,\n    ) -\u003e Result\u003cWeeklyHolidayResponse, ApiError\u003e {\n        self.client.admin_create_weekly_holiday(\u0026payload).await\n    }\n\n    pub async fn delete_weekly_holiday(\u0026self, id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_delete_weekly_holiday(id).await\n    }\n\n    pub async fn list_requests(\n        \u0026self,\n        status: Option\u003cString\u003e,\n        user_id: Option\u003cString\u003e,\n        page: u32,\n        per_page: u32,\n    ) -\u003e Result\u003cValue, ApiError\u003e {\n        self.client\n            .admin_list_requests(\n                status.as_deref(),\n                user_id.as_deref(),\n                Some(page),\n                Some(per_page),\n            )\n            .await\n    }\n\n    pub async fn approve_request(\u0026self, id: \u0026str, comment: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client\n            .admin_approve_request(id, comment)\n            .await\n            .map(|_| ())\n    }\n\n    pub async fn reject_request(\u0026self, id: \u0026str, comment: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client\n            .admin_reject_request(id, comment)\n            .await\n            .map(|_| ())\n    }\n\n    pub async fn list_subject_requests(\n        \u0026self,\n        status: Option\u003cString\u003e,\n        request_type: Option\u003cString\u003e,\n        user_id: Option\u003cString\u003e,\n        page: i64,\n        per_page: i64,\n    ) -\u003e Result\u003cSubjectRequestListResponse, ApiError\u003e {\n        self.client\n            .admin_list_subject_requests(status, request_type, user_id, None, None, page, per_page)\n            .await\n    }\n\n    pub async fn approve_subject_request(\u0026self, id: \u0026str, comment: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_approve_subject_request(id, comment).await\n    }\n\n    pub async fn reject_subject_request(\u0026self, id: \u0026str, comment: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_reject_subject_request(id, comment).await\n    }\n\n    pub async fn reset_mfa(\u0026self, user_id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_reset_mfa(user_id).await.map(|_| ())\n    }\n\n    pub async fn upsert_attendance(\u0026self, payload: AdminAttendanceUpsert) -\u003e Result\u003c(), ApiError\u003e {\n        self.client\n            .admin_upsert_attendance(payload)\n            .await\n            .map(|_| ())\n    }\n\n    pub async fn force_end_break(\u0026self, break_id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client\n            .admin_force_end_break(break_id)\n            .await\n            .map(|_| ())\n    }\n\n    pub async fn list_holidays(\n        \u0026self,\n        query: HolidayListQuery,\n    ) -\u003e Result\u003cHolidayListResult, ApiError\u003e {\n        let response = self\n            .client\n            .admin_list_holidays(query.page, query.per_page, query.from, query.to)\n            .await?;\n\n        let items = response\n            .items\n            .into_iter()\n            .filter_map(convert_admin_holiday_item)\n            .collect::\u003cVec\u003c_\u003e\u003e();\n\n        Ok(HolidayListResult {\n            page: response.page,\n            per_page: response.per_page,\n            total: response.total,\n            items,\n        })\n    }\n\n    pub async fn fetch_google_holidays(\n        \u0026self,\n        year: Option\u003ci32\u003e,\n    ) -\u003e Result\u003cVec\u003cCreateHolidayRequest\u003e, ApiError\u003e {\n        self.client.admin_fetch_google_holidays(year).await\n    }\n\n    pub async fn create_holiday(\n        \u0026self,\n        payload: CreateHolidayRequest,\n    ) -\u003e Result\u003cHolidayResponse, ApiError\u003e {\n        self.client.admin_create_holiday(\u0026payload).await\n    }\n\n    pub async fn delete_holiday(\u0026self, id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_delete_holiday(id).await.map(|_| ())\n    }\n\n    pub async fn fetch_users(\u0026self) -\u003e Result\u003cVec\u003cUserResponse\u003e, ApiError\u003e {\n        self.client.get_users().await\n    }\n}\n\nfn convert_admin_holiday_item(item: AdminHolidayListItem) -\u003e Option\u003cHolidayResponse\u003e {\n    if item.kind != AdminHolidayKind::Public {\n        return None;\n    }\n\n    let AdminHolidayListItem {\n        id,\n        applies_from,\n        date,\n        name,\n        description,\n        reason,\n        ..\n    } = item;\n\n    let fallback_reason = reason.clone();\n    let holiday_name = name\n        .or_else(|| fallback_reason.clone())\n        .unwrap_or_else(|| \"Holiday\".to_string());\n    let holiday_description = description.or(reason);\n\n    Some(HolidayResponse {\n        id,\n        holiday_date: date.unwrap_or(applies_from),\n        name: holiday_name,\n        description: holiday_description,\n    })\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","utils.rs"],"content":"use crate::api::{ApiError, CreateWeeklyHolidayRequest};\nuse chrono::NaiveDate;\nuse leptos::*;\n\n#[derive(Clone, Copy)]\npub struct WeeklyHolidayFormState {\n    weekday: RwSignal\u003cString\u003e,\n    starts_on: RwSignal\u003cString\u003e,\n    ends_on: RwSignal\u003cString\u003e,\n}\n\nimpl WeeklyHolidayFormState {\n    pub fn new(initial_weekday: \u0026str, initial_starts_on: String) -\u003e Self {\n        Self {\n            weekday: create_rw_signal(initial_weekday.to_string()),\n            starts_on: create_rw_signal(initial_starts_on),\n            ends_on: create_rw_signal(String::new()),\n        }\n    }\n\n    pub fn weekday_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.weekday\n    }\n\n    pub fn starts_on_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.starts_on\n    }\n\n    pub fn ends_on_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.ends_on\n    }\n\n    pub fn reset_starts_on(\u0026self, next_start: NaiveDate) {\n        self.starts_on\n            .set(next_start.format(\"%Y-%m-%d\").to_string());\n    }\n\n    pub fn reset_ends_on(\u0026self) {\n        self.ends_on.set(String::new());\n    }\n\n    pub fn to_payload(\u0026self, min_start: NaiveDate) -\u003e Result\u003cCreateWeeklyHolidayRequest, ApiError\u003e {\n        let weekday_value: u8 =\n            self.weekday.get().trim().parse::\u003cu8\u003e().map_err(|_| {\n                ApiError::validation(\"曜日は 0 (日) 〜 6 (土) で入力してください。\")\n            })?;\n        if weekday_value \u003e= 7 {\n            return Err(ApiError::validation(\n                \"曜日は 0 (日) 〜 6 (土) で入力してください。\",\n            ));\n        }\n        let start_raw = self.starts_on.get();\n        if start_raw.trim().is_empty() {\n            return Err(ApiError::validation(\"稼働開始日を入力してください。\"));\n        }\n        let start_date = NaiveDate::parse_from_str(start_raw.trim(), \"%Y-%m-%d\").map_err(|_| {\n            ApiError::validation(\"稼働開始日は YYYY-MM-DD 形式で入力してください。\")\n        })?;\n        if start_date \u003c min_start {\n            return Err(ApiError::validation(\u0026format!(\n                \"稼働開始日は {} 以降の日付を選択してください。\",\n                min_start.format(\"%Y-%m-%d\")\n            )));\n        }\n\n        let ends_on = {\n            let raw = self.ends_on.get();\n            if raw.trim().is_empty() {\n                None\n            } else {\n                let parsed = NaiveDate::parse_from_str(raw.trim(), \"%Y-%m-%d\").map_err(|_| {\n                    ApiError::validation(\"稼働終了日は YYYY-MM-DD 形式で入力してください。\")\n                })?;\n                if parsed \u003c start_date {\n                    return Err(ApiError::validation(\n                        \"稼働終了日は開始日以降を指定してください。\",\n                    ));\n                }\n                Some(parsed)\n            }\n        };\n\n        Ok(CreateWeeklyHolidayRequest {\n            weekday: weekday_value,\n            starts_on: start_date,\n            ends_on,\n        })\n    }\n}\n\n#[derive(Clone, Debug, PartialEq, Eq)]\npub struct RequestFilterSnapshot {\n    pub status: Option\u003cString\u003e,\n    pub user_id: Option\u003cString\u003e,\n    pub page: u32,\n    pub per_page: u32,\n}\n\n#[derive(Clone, Copy)]\npub struct RequestFilterState {\n    status: RwSignal\u003cString\u003e,\n    user_id: RwSignal\u003cString\u003e,\n    page: RwSignal\u003cu32\u003e,\n    per_page: u32,\n}\n\nimpl RequestFilterState {\n    pub fn new() -\u003e Self {\n        Self {\n            status: create_rw_signal(String::new()),\n            user_id: create_rw_signal(String::new()),\n            page: create_rw_signal(1),\n            per_page: 20,\n        }\n    }\n\n    pub fn status_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.status\n    }\n\n    pub fn user_id_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.user_id\n    }\n\n    pub fn snapshot(\u0026self) -\u003e RequestFilterSnapshot {\n        let status_value = self.status.get();\n        let user_id_value = self.user_id.get();\n        RequestFilterSnapshot {\n            status: if status_value.is_empty() {\n                None\n            } else {\n                Some(status_value)\n            },\n            user_id: if user_id_value.is_empty() {\n                None\n            } else {\n                Some(user_id_value)\n            },\n            page: self.page.get(),\n            per_page: self.per_page,\n        }\n    }\n\n    pub fn reset_page(\u0026self) {\n        self.page.set(1);\n    }\n}\n\n#[derive(Clone, Debug, PartialEq, Eq)]\npub struct SubjectRequestFilterSnapshot {\n    pub status: Option\u003cString\u003e,\n    pub request_type: Option\u003cString\u003e,\n    pub user_id: Option\u003cString\u003e,\n    pub page: u32,\n    pub per_page: u32,\n}\n\n#[derive(Clone, Copy)]\npub struct SubjectRequestFilterState {\n    status: RwSignal\u003cString\u003e,\n    request_type: RwSignal\u003cString\u003e,\n    user_id: RwSignal\u003cString\u003e,\n    page: RwSignal\u003cu32\u003e,\n    per_page: u32,\n}\n\nimpl SubjectRequestFilterState {\n    pub fn new() -\u003e Self {\n        Self {\n            status: create_rw_signal(String::new()),\n            request_type: create_rw_signal(String::new()),\n            user_id: create_rw_signal(String::new()),\n            page: create_rw_signal(1),\n            per_page: 20,\n        }\n    }\n\n    pub fn status_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.status\n    }\n\n    pub fn request_type_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.request_type\n    }\n\n    pub fn user_id_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.user_id\n    }\n\n    pub fn snapshot(\u0026self) -\u003e SubjectRequestFilterSnapshot {\n        let status_value = self.status.get();\n        let request_type_value = self.request_type.get();\n        let user_id_value = self.user_id.get();\n        SubjectRequestFilterSnapshot {\n            status: if status_value.is_empty() {\n                None\n            } else {\n                Some(status_value)\n            },\n            request_type: if request_type_value.is_empty() {\n                None\n            } else {\n                Some(request_type_value)\n            },\n            user_id: if user_id_value.is_empty() {\n                None\n            } else {\n                Some(user_id_value)\n            },\n            page: self.page.get(),\n            per_page: self.per_page,\n        }\n    }\n\n    pub fn reset_page(\u0026self) {\n        self.page.set(1);\n    }\n}\n\npub fn next_allowed_weekly_start(today: NaiveDate, is_system_admin: bool) -\u003e NaiveDate {\n    if is_system_admin {\n        today\n    } else {\n        today.succ_opt().unwrap_or(today)\n    }\n}\n\npub fn weekday_label(idx: i16) -\u003e \u0026'static str {\n    match idx {\n        0 =\u003e \"日\",\n        1 =\u003e \"月\",\n        2 =\u003e \"火\",\n        3 =\u003e \"水\",\n        4 =\u003e \"木\",\n        5 =\u003e \"金\",\n        6 =\u003e \"土\",\n        _ =\u003e \"-\",\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::NaiveDate;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn non_system_admin_starts_tomorrow() {\n        let today = NaiveDate::from_ymd_opt(2025, 1, 10).unwrap();\n        let expected = NaiveDate::from_ymd_opt(2025, 1, 11).unwrap();\n        assert_eq!(next_allowed_weekly_start(today, false), expected);\n    }\n\n    #[wasm_bindgen_test]\n    fn weekly_form_validates_range() {\n        let state = WeeklyHolidayFormState::new(\"0\", \"2025-01-15\".into());\n        state.ends_on_signal().set(\"2025-01-10\".into());\n        let min = NaiveDate::from_ymd_opt(2025, 1, 15).unwrap();\n        assert!(state.to_payload(min).is_err());\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin","view_model.rs"],"content":"use super::{\n    repository::AdminRepository,\n    utils::{\n        next_allowed_weekly_start, RequestFilterState, SubjectRequestFilterState,\n        WeeklyHolidayFormState,\n    },\n};\nuse crate::api::{\n    ApiClient, ApiError, CreateWeeklyHolidayRequest, SubjectRequestListResponse, UserResponse,\n    WeeklyHolidayResponse,\n};\nuse crate::state::auth::use_auth;\nuse crate::utils::time::today_in_app_tz;\nuse leptos::*;\n\n#[derive(Clone)]\npub struct AdminViewModel {\n    pub users_resource: Resource\u003cbool, Result\u003cVec\u003cUserResponse\u003e, ApiError\u003e\u003e,\n    pub weekly_holiday_state: WeeklyHolidayFormState,\n    pub reload_weekly: RwSignal\u003cu32\u003e,\n    pub weekly_holidays_resource:\n        Resource\u003c(bool, u32), Result\u003cVec\u003cWeeklyHolidayResponse\u003e, ApiError\u003e\u003e,\n    pub weekly_action_message: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub weekly_action_error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    pub create_weekly_action:\n        Action\u003cCreateWeeklyHolidayRequest, Result\u003cWeeklyHolidayResponse, ApiError\u003e\u003e,\n    pub delete_weekly_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n    pub requests_filter: RequestFilterState,\n    pub requests_resource: Resource\u003c\n        (bool, super::utils::RequestFilterSnapshot, u32),\n        Result\u003cserde_json::Value, ApiError\u003e,\n    \u003e,\n    pub request_action: Action\u003cRequestActionPayload, Result\u003c(), ApiError\u003e\u003e,\n    pub requests_action_error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    pub reload_requests: RwSignal\u003cu32\u003e,\n    pub subject_request_filter: SubjectRequestFilterState,\n    pub subject_requests_resource: Resource\u003c\n        (bool, super::utils::SubjectRequestFilterSnapshot, u32),\n        Result\u003cSubjectRequestListResponse, ApiError\u003e,\n    \u003e,\n    pub subject_request_action: Action\u003cSubjectRequestActionPayload, Result\u003c(), ApiError\u003e\u003e,\n    pub subject_request_action_error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    pub reload_subject_requests: RwSignal\u003cu32\u003e,\n    pub repository: AdminRepository,\n    // Add other section states here as needed\n}\n\npub fn use_admin_view_model() -\u003e AdminViewModel {\n    let (auth, _) = use_auth();\n    // ApiClient is typically provided by AuthProvider/router context.\n    // We use a fallback to provide robustness if AuthProvider is not mounted.\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repo = AdminRepository::new_with_client(std::rc::Rc::new(api));\n\n    // Admin Access Check\n    let admin_allowed = create_memo(move |_| {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin || user.role.eq_ignore_ascii_case(\"admin\"))\n            .unwrap_or(false)\n    });\n\n    let system_admin_allowed = create_memo(move |_| {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin)\n            .unwrap_or(false)\n    });\n\n    // Resources\n    let repo_users = repo.clone();\n    let users_resource = create_resource(\n        move || admin_allowed.get(),\n        move |allowed| {\n            let repo = repo_users.clone();\n            async move {\n                if allowed {\n                    repo.fetch_users().await\n                } else {\n                    Ok(Vec::new())\n                }\n            }\n        },\n    );\n\n    // Weekly Holidays Section State\n    let default_start =\n        next_allowed_weekly_start(today_in_app_tz(), system_admin_allowed.get_untracked())\n            .format(\"%Y-%m-%d\")\n            .to_string();\n    let weekly_holiday_state = WeeklyHolidayFormState::new(\"0\", default_start);\n\n    let reload_weekly = create_rw_signal(0u32);\n    let repo_weekly = repo.clone();\n    let weekly_holidays_resource = create_resource(\n        move || (admin_allowed.get(), reload_weekly.get()),\n        move |(allowed, _)| {\n            let repo = repo_weekly.clone();\n            async move {\n                if !allowed {\n                    Ok(Vec::new())\n                } else {\n                    repo.list_weekly_holidays().await\n                }\n            }\n        },\n    );\n\n    let weekly_action_message = create_rw_signal(None);\n    let weekly_action_error = create_rw_signal(None);\n\n    let repo_create = repo.clone();\n    let create_weekly_action = create_action(move |payload: \u0026CreateWeeklyHolidayRequest| {\n        let repo = repo_create.clone();\n        let payload = payload.clone();\n        async move { repo.create_weekly_holiday(payload).await }\n    });\n\n    let repo_delete = repo.clone();\n    let delete_weekly_action = create_action(move |id: \u0026String| {\n        let repo = repo_delete.clone();\n        let id = id.clone();\n        async move { repo.delete_weekly_holiday(\u0026id).await }\n    });\n\n    // Requests Section State\n    let requests_filter = RequestFilterState::new();\n    let filter_state_for_snapshot = requests_filter.clone();\n    let snapshot = Signal::derive(move || filter_state_for_snapshot.snapshot());\n\n    let repo_for_requests = repo.clone();\n    let reload_requests = create_rw_signal(0u32);\n    let requests_resource = create_resource(\n        move || (admin_allowed.get(), snapshot.get(), reload_requests.get()),\n        move |(allowed, snapshot, _)| {\n            let repo = repo_for_requests.clone();\n            async move {\n                if !allowed {\n                    Ok(serde_json::Value::Null)\n                } else {\n                    repo.list_requests(\n                        snapshot.status.clone(),\n                        snapshot.user_id.clone(),\n                        snapshot.page,\n                        snapshot.per_page,\n                    )\n                    .await\n                }\n            }\n        },\n    );\n\n    let repo_action = repo.clone();\n    let requests_action_error = create_rw_signal(None::\u003cApiError\u003e);\n    let request_action = create_action(move |payload: \u0026RequestActionPayload| {\n        let repo = repo_action.clone();\n        let payload = payload.clone();\n        async move {\n            if payload.id.trim().is_empty() {\n                Err(ApiError::validation(\"リクエストIDを取得できませんでした。\"))\n            } else if payload.approve {\n                repo.approve_request(\u0026payload.id, \u0026payload.comment).await\n            } else {\n                repo.reject_request(\u0026payload.id, \u0026payload.comment).await\n            }\n        }\n    });\n\n    // Subject Requests Section State\n    let subject_request_filter = SubjectRequestFilterState::new();\n    let subject_filter_state = subject_request_filter.clone();\n    let subject_snapshot = Signal::derive(move || subject_filter_state.snapshot());\n\n    let repo_for_subject_requests = repo.clone();\n    let reload_subject_requests = create_rw_signal(0u32);\n    let subject_requests_resource = create_resource(\n        move || {\n            (\n                admin_allowed.get(),\n                subject_snapshot.get(),\n                reload_subject_requests.get(),\n            )\n        },\n        move |(allowed, snapshot, _reload)| {\n            let repo = repo_for_subject_requests.clone();\n            async move {\n                if !allowed {\n                    Ok(SubjectRequestListResponse {\n                        page: snapshot.page as i64,\n                        per_page: snapshot.per_page as i64,\n                        total: 0,\n                        items: Vec::new(),\n                    })\n                } else {\n                    repo.list_subject_requests(\n                        snapshot.status.clone(),\n                        snapshot.request_type.clone(),\n                        snapshot.user_id.clone(),\n                        snapshot.page as i64,\n                        snapshot.per_page as i64,\n                    )\n                    .await\n                }\n            }\n        },\n    );\n\n    let repo_subject_action = repo.clone();\n    let subject_request_action_error = create_rw_signal(None::\u003cApiError\u003e);\n    let subject_request_action = create_action(move |payload: \u0026SubjectRequestActionPayload| {\n        let repo = repo_subject_action.clone();\n        let payload = payload.clone();\n        async move {\n            if payload.id.trim().is_empty() {\n                Err(ApiError::validation(\"リクエストIDを取得できませんでした。\"))\n            } else if payload.approve {\n                repo.approve_subject_request(\u0026payload.id, \u0026payload.comment)\n                    .await\n            } else {\n                repo.reject_subject_request(\u0026payload.id, \u0026payload.comment)\n                    .await\n            }\n        }\n    });\n\n    AdminViewModel {\n        users_resource,\n        weekly_holiday_state,\n        reload_weekly,\n        weekly_holidays_resource,\n        weekly_action_message,\n        weekly_action_error,\n        create_weekly_action,\n        delete_weekly_action,\n        requests_filter,\n        requests_resource,\n        request_action,\n        requests_action_error,\n        reload_requests,\n        subject_request_filter,\n        subject_requests_resource,\n        subject_request_action,\n        subject_request_action_error,\n        reload_subject_requests,\n        repository: repo,\n    }\n}\n\n#[derive(Clone)]\npub struct RequestActionPayload {\n    pub id: String,\n    pub comment: String,\n    pub approve: bool,\n}\n\n#[derive(Clone)]\npub struct SubjectRequestActionPayload {\n    pub id: String,\n    pub comment: String,\n    pub approve: bool,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_audit_logs","mod.rs"],"content":"pub mod panel;\npub mod view_model;\n\npub use panel::AdminAuditLogsPage;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_audit_logs","panel.rs"],"content":"use super::view_model::{use_audit_log_view_model, AuditLogFilters, AUDIT_EVENT_TYPES};\nuse crate::components::common::{Button, ButtonVariant};\nuse crate::components::empty_state::EmptyState;\nuse crate::components::layout::Layout;\nuse crate::state::auth::use_auth;\nuse leptos::*;\n\n#[component]\npub fn AdminAuditLogsPage() -\u003e impl IntoView {\n    let vm = use_audit_log_view_model();\n    let (auth, _) = use_auth();\n    let selected_metadata = create_rw_signal::\u003cOption\u003cserde_json::Value\u003e\u003e(None);\n    let is_system_admin = create_memo(move |_| {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|u| u.is_system_admin)\n            .unwrap_or(false)\n    });\n\n    let is_filters_default = create_memo(move |_| vm.filters.get() == AuditLogFilters::default());\n\n    let on_filter_change = move |ev: web_sys::Event, field: \u0026str| {\n        let val = event_target_value(\u0026ev);\n        vm.filters.update(|f| match field {\n            \"from\" =\u003e f.from = val,\n            \"to\" =\u003e f.to = val,\n            \"actor_id\" =\u003e f.actor_id = val,\n            \"event_type\" =\u003e f.event_type = val,\n            \"result\" =\u003e f.result = val,\n            _ =\u003e {}\n        });\n        vm.page.set(1);\n    };\n\n    view! {\n        \u003cLayout\u003e\n            \u003cShow\n                when=move || is_system_admin.get()\n                fallback=move || view! { \u003cdiv class=\"p-6 bg-surface-elevated text-fg shadow rounded\"\u003e\"権限がありません\"\u003c/div\u003e }\n            \u003e\n                \u003cdiv class=\"space-y-6\"\u003e\n                    \u003cdiv\u003e\n                        \u003ch1 class=\"text-2xl font-bold text-fg\"\u003e\"監査ログ\"\u003c/h1\u003e\n                        \u003cp class=\"mt-1 text-sm text-fg-muted\"\u003e\"システム操作の履歴を確認・エクスポートします。\"\u003c/p\u003e\n                    \u003c/div\u003e\n\n                    \u003cdiv class=\"bg-surface-elevated p-4 rounded-lg shadow space-y-4\"\u003e\n                        \u003cdiv class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\"\u003e\n                            \u003cdiv\u003e\n                                \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"日時 (From)\"\u003c/label\u003e\n                                \u003cinput type=\"datetime-local\" class=\"mt-1 block w-full rounded-md border-form-control-border bg-form-control-bg text-form-control-text shadow-sm sm:text-sm border px-2 py-1\"\n                                    prop:value=move || vm.filters.get().from\n                                    on:input=move |ev| on_filter_change(ev, \"from\")\n                                /\u003e\n                            \u003c/div\u003e\n                            \u003cdiv\u003e\n                                \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"日時 (To)\"\u003c/label\u003e\n                                \u003cinput type=\"datetime-local\" class=\"mt-1 block w-full rounded-md border-form-control-border bg-form-control-bg text-form-control-text shadow-sm sm:text-sm border px-2 py-1\"\n                                    prop:value=move || vm.filters.get().to\n                                    on:input=move |ev| on_filter_change(ev, \"to\")\n                                /\u003e\n                            \u003c/div\u003e\n                            \u003cdiv\u003e\n                                \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"ユーザーID\"\u003c/label\u003e\n                                \u003cinput type=\"text\" class=\"mt-1 block w-full rounded-md border-form-control-border bg-form-control-bg text-form-control-text shadow-sm sm:text-sm border px-2 py-1\"\n                                    prop:value=move || vm.filters.get().actor_id\n                                    on:input=move |ev| on_filter_change(ev, \"actor_id\")\n                                /\u003e\n                            \u003c/div\u003e\n                            \u003cdiv\u003e\n                                \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"イベントタイプ\"\u003c/label\u003e\n                                \u003cselect class=\"mt-1 block w-full rounded-md border-form-control-border bg-form-control-bg text-form-control-text shadow-sm sm:text-sm border px-2 py-1\"\n                                    prop:value=move || vm.filters.get().event_type\n                                    on:change=move |ev| on_filter_change(ev, \"event_type\")\n                                \u003e\n                                    \u003coption value=\"\"\u003e\"すべて\"\u003c/option\u003e\n                                    {AUDIT_EVENT_TYPES.iter().map(|(val, label)| view! {\n                                        \u003coption value=*val\u003e{*label}\u003c/option\u003e\n                                    }).collect_view()}\n                                \u003c/select\u003e\n                            \u003c/div\u003e\n                            \u003cdiv\u003e\n                                \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"結果\"\u003c/label\u003e\n                                \u003cselect class=\"mt-1 block w-full rounded-md border-form-control-border bg-form-control-bg text-form-control-text shadow-sm sm:text-sm border px-2 py-1\"\n                                    prop:value=move || vm.filters.get().result\n                                    on:change=move |ev| on_filter_change(ev, \"result\")\n                                \u003e\n                                    \u003coption value=\"\"\u003e\"すべて\"\u003c/option\u003e\n                                    \u003coption value=\"success\"\u003e\"成功\"\u003c/option\u003e\n                                    \u003coption value=\"failure\"\u003e\"失敗\"\u003c/option\u003e\n                                \u003c/select\u003e\n                            \u003c/div\u003e\n                        \u003c/div\u003e\n                        \u003cdiv class=\"flex justify-end items-center gap-4\"\u003e\n                            \u003cbutton\n                                class=\"text-sm text-fg-muted hover:text-fg disabled:opacity-50 disabled:cursor-not-allowed\"\n                                disabled=move || is_filters_default.get()\n                                on:click=move |_| {\n                                    vm.filters.set(AuditLogFilters::default());\n                                    vm.page.set(1);\n                                }\n                            \u003e\n                                \"フィルタをクリア\"\n                            \u003c/button\u003e\n                            \u003cButton\n                                variant=ButtonVariant::Primary\n                                on:click=move |_| vm.export_action.dispatch(())\n                                disabled=Signal::derive(move || vm.export_action.pending().get())\n                                loading=Signal::derive(move || vm.export_action.pending().get())\n                            \u003e\n                                {move || if vm.export_action.pending().get() { \"エクスポート中...\" } else { \"JSONエクスポート\" }}\n                            \u003c/Button\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n\n                    \u003cdiv class=\"bg-surface-elevated shadow overflow-hidden sm:rounded-lg overflow-x-auto\"\u003e\n                        \u003ctable class=\"min-w-full divide-y divide-border\"\u003e\n                            \u003cthead class=\"bg-surface-muted\"\u003e\n                                \u003ctr\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\"日時\"\u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\"ユーザー\"\u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\"イベント\"\u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\"対象\"\u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\"結果\"\u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\"詳細\"\u003c/th\u003e\n                                \u003c/tr\u003e\n                            \u003c/thead\u003e\n                            \u003ctbody class=\"bg-surface-elevated divide-y divide-border\"\u003e\n                                \u003cSuspense fallback=move || view! { \u003ctr\u003e\u003ctd colspan=\"6\" class=\"p-4 text-center\"\u003e\"読み込み中...\"\u003c/td\u003e\u003c/tr\u003e }\u003e\n                                    {move || vm.logs_resource.get().map(|res| match res {\n                                        Ok(response) =\u003e {\n                                            if response.items.is_empty() {\n                                                view! {\n                                                    \u003ctr\u003e\n                                                        \u003ctd colspan=\"6\" class=\"p-4\"\u003e\n                                                            \u003cEmptyState\n                                                                title=\"ログがありません\"\n                                                                description=\"検索条件に一致する監査ログは見つかりませんでした。\"\n                                                            /\u003e\n                                                        \u003c/td\u003e\n                                                    \u003c/tr\u003e\n                                                }.into_view()\n                                            } else {\n                                                response.items.into_iter().map(|log| {\n                                                    view! {\n                                                        \u003ctr\u003e\n                                                            \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg-muted\"\u003e\n                                                                {log.occurred_at.format(\"%Y-%m-%d %H:%M:%S\").to_string()}\n                                                            \u003c/td\u003e\n                                                            \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e\n                                                                {log.actor_id.unwrap_or_else(|| \"-\".to_string())}\n                                                                \u003cspan class=\"text-xs text-fg-muted block\"\u003e{log.actor_type}\u003c/span\u003e\n                                                            \u003c/td\u003e\n                                                            \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e\n                                                                {log.event_type}\n                                                            \u003c/td\u003e\n                                                            \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg-muted\"\u003e\n                                                                {format!(\"{} {}\", log.target_type.unwrap_or_default(), log.target_id.unwrap_or_default())}\n                                                            \u003c/td\u003e\n                                                             \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm\"\u003e\n                                                                \u003cspan class={if log.result == \"success\" { \"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-status-success-bg text-status-success-text\" } else { \"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-status-error-bg text-status-error-text\" }}\u003e\n                                                                    {log.result.clone()}\n                                                                \u003c/span\u003e\n                                                                {log.error_code.clone().map(|c| view! { \u003cspan class=\"block text-xs text-status-error-text\"\u003e{c}\u003c/span\u003e })}\n                                                            \u003c/td\u003e\n                                                             \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg-muted\"\u003e\n                                                                 {\n                                                                    let m = log.metadata.clone();\n                                                                    m.map(|val| {\n                                                                        let s = val.to_string();\n                                                                        let display = if s.len() \u003e 50 {\n                                                                            format!(\"{}...\", \u0026s[0..50])\n                                                                        } else {\n                                                                            s\n                                                                        };\n                                                                        let val_clone = val.clone();\n                                                                        view! {\n                                                                            \u003cbutton\n                                                                                class=\"text-link hover:text-link-hover hover:underline text-left font-mono text-xs\"\n                                                                                on:click=move |_| selected_metadata.set(Some(val_clone.clone()))\n                                                                            \u003e\n                                                                                {display}\n                                                                            \u003c/button\u003e\n                                                                        }\n                                                                    })\n                                                                }\n                                                            \u003c/td\u003e\n                                                        \u003c/tr\u003e\n                                                    }\n                                                }).collect_view()\n                                            }\n                                        }\n                                        Err(e) =\u003e view! { \u003ctr\u003e\u003ctd colspan=\"6\" class=\"p-4 text-center text-status-error-text\"\u003e{e}\u003c/td\u003e\u003c/tr\u003e }.into_view()\n                                    })}\n                                \u003c/Suspense\u003e\n                            \u003c/tbody\u003e\n                        \u003c/table\u003e\n                    \u003c/div\u003e\n\n                    \u003cdiv class=\"mt-4 flex justify-between items-center\"\u003e\n                        \u003cbutton\n                            class=\"px-4 py-2 border border-border rounded disabled:opacity-50 text-sm text-fg\"\n                            disabled=move || vm.page.get() \u003c= 1\n                            on:click=move |_| vm.page.update(|p| *p = (*p - 1).max(1))\n                        \u003e\n                            \"前へ\"\n                        \u003c/button\u003e\n                        \u003cdiv class=\"text-sm text-fg\"\u003e\n                            \"ページ \" {move || vm.page.get()}\n                             {move || vm.logs_resource.get().map(|res| if let Ok(r) = res { format!(\" / {}\", (r.total as f64 / r.per_page as f64).ceil() as i64) } else { \"\".to_string() })}\n                        \u003c/div\u003e\n                        \u003cbutton\n                            class=\"px-4 py-2 border border-border rounded disabled:opacity-50 text-sm text-fg\"\n                            disabled=move || {\n                                vm.logs_resource.get().map(|res| if let Ok(r) = res {\n                                    vm.page.get() \u003e= (r.total as f64 / r.per_page as f64).ceil() as i64\n                                } else {\n                                    true\n                                }).unwrap_or(true)\n                            }\n                            on:click=move |_| vm.page.update(|p| *p += 1)\n                        \u003e\n                            \"次へ\"\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n\n                    \u003cShow when=move || selected_metadata.get().is_some()\u003e\n                        \u003cdiv class=\"fixed inset-0 bg-overlay-backdrop flex items-center justify-center z-50 p-4\"\u003e\n                            \u003cdiv class=\"bg-surface-elevated rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]\"\u003e\n                                \u003cdiv class=\"p-4 border-b border-border flex justify-between items-center\"\u003e\n                                    \u003ch3 class=\"text-lg font-bold text-fg\"\u003e\"メタデータ詳細\"\u003c/h3\u003e\n                                    \u003cbutton class=\"text-fg-muted hover:text-fg\" on:click=move |_| selected_metadata.set(None)\u003e\n                                        \u003ci class=\"fas fa-times\"\u003e\u003c/i\u003e\n                                    \u003c/button\u003e\n                                \u003c/div\u003e\n                                \u003cdiv class=\"p-4 overflow-auto flex-1 bg-surface-muted font-mono text-xs sm:text-sm text-fg\"\u003e\n                                    \u003cpre\u003e{move || selected_metadata.get().map(|m| serde_json::to_string_pretty(\u0026m).unwrap_or_default()).unwrap_or_default()}\u003c/pre\u003e\n                                \u003c/div\u003e\n                                \u003cdiv class=\"p-4 border-t border-border flex justify-end\"\u003e\n                                    \u003cbutton\n                                        class=\"px-4 py-2 bg-surface-muted hover:bg-surface-elevated rounded text-sm font-medium text-fg\"\n                                        on:click=move |_| selected_metadata.set(None)\n                                    \u003e\n                                        \"閉じる\"\n                                    \u003c/button\u003e\n                                \u003c/div\u003e\n                            \u003c/div\u003e\n                        \u003c/div\u003e\n                    \u003c/Show\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n        \u003c/Layout\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_audit_logs","view_model.rs"],"content":"use crate::api::{ApiClient, ApiError, AuditLogListResponse};\nuse leptos::*;\nuse wasm_bindgen::JsCast;\n\npub const AUDIT_EVENT_TYPES: \u0026[(\u0026str, \u0026str)] = \u0026[\n    // 認証・アカウント\n    (\"auth_login\", \"ログイン\"),\n    (\"auth_logout\", \"ログアウト\"),\n    (\"auth_refresh\", \"トークン更新\"),\n    (\"mfa_activate\", \"MFA有効化\"),\n    (\"mfa_disable\", \"MFA無効化\"),\n    (\"mfa_register\", \"MFA登録\"),\n    (\"mfa_setup\", \"MFAセットアップ\"),\n    (\"password_change\", \"パスワード変更\"),\n    // 勤怠\n    (\"attendance_break_end\", \"休憩終了\"),\n    (\"attendance_break_start\", \"休憩開始\"),\n    (\"attendance_clock_in\", \"出勤打刻\"),\n    (\"attendance_clock_out\", \"退勤打刻\"),\n    (\"attendance_export\", \"勤怠データ出力\"),\n    // 申請\n    (\"request_cancel\", \"申請取消\"),\n    (\"request_leave_create\", \"休暇申請作成\"),\n    (\"request_overtime_create\", \"残業申請作成\"),\n    (\"request_update\", \"申請更新\"),\n    // 本人確認・データ要求\n    (\"subject_request_cancel\", \"本人確認申請取消\"),\n    (\"subject_request_create\", \"本人確認申請作成\"),\n    // 同意\n    (\"consent_record\", \"同意記録\"),\n    // 管理者操作\n    (\"admin_attendance_list\", \"勤怠一覧参照(管理者)\"),\n    (\"admin_attendance_upsert\", \"勤怠修正(管理者)\"),\n    (\"admin_audit_log_detail\", \"監査ログ詳細参照(管理者)\"),\n    (\"admin_audit_log_export\", \"監査ログ出力(管理者)\"),\n    (\"admin_audit_log_list\", \"監査ログ一覧参照(管理者)\"),\n    (\"admin_break_force_end\", \"休憩強制終了(管理者)\"),\n    (\"admin_export\", \"データ一括出力(管理者)\"),\n    (\"admin_holiday_create\", \"祝日作成(管理者)\"),\n    (\"admin_holiday_delete\", \"祝日削除(管理者)\"),\n    (\"admin_holiday_google_fetch\", \"Googleカレンダー連携(管理者)\"),\n    (\"admin_holiday_list\", \"祝日一覧参照(管理者)\"),\n    (\"admin_mfa_reset\", \"MFAリセット(管理者)\"),\n    (\"admin_request_approve\", \"申請承認(管理者)\"),\n    (\"admin_request_detail\", \"申請詳細参照(管理者)\"),\n    (\"admin_request_list\", \"申請一覧参照(管理者)\"),\n    (\"admin_request_reject\", \"申請却下(管理者)\"),\n    (\"admin_subject_request_approve\", \"本人確認承認(管理者)\"),\n    (\"admin_subject_request_list\", \"本人確認一覧参照(管理者)\"),\n    (\"admin_subject_request_reject\", \"本人確認却下(管理者)\"),\n    (\"admin_user_create\", \"ユーザー作成(管理者)\"),\n    (\"admin_user_list\", \"ユーザー一覧参照(管理者)\"),\n    (\"admin_weekly_holiday_create\", \"週間祝日作成(管理者)\"),\n    (\"admin_weekly_holiday_list\", \"週間祝日一覧参照(管理者)\"),\n];\n\n#[derive(Clone, Debug, PartialEq)]\npub struct AuditLogFilters {\n    pub from: String,\n    pub to: String,\n    pub actor_id: String,\n    pub event_type: String,\n    pub result: String,\n}\n\nimpl Default for AuditLogFilters {\n    fn default() -\u003e Self {\n        Self {\n            from: \"\".to_string(),\n            to: \"\".to_string(),\n            actor_id: \"\".to_string(),\n            event_type: \"\".to_string(),\n            result: \"\".to_string(),\n        }\n    }\n}\n\n#[derive(Clone)]\npub struct AuditLogViewModel {\n    pub logs_resource: Resource\u003c(i64, AuditLogFilters), Result\u003cAuditLogListResponse, ApiError\u003e\u003e,\n    pub page: RwSignal\u003ci64\u003e,\n    pub filters: RwSignal\u003cAuditLogFilters\u003e,\n    pub export_action: Action\u003c(), Result\u003c(), ApiError\u003e\u003e,\n}\n\npub fn use_audit_log_view_model() -\u003e AuditLogViewModel {\n    let api_client = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let page = create_rw_signal(1);\n    let filters = create_rw_signal(AuditLogFilters::default());\n\n    let api = api_client.clone();\n    let logs_resource = create_resource(\n        move || (page.get(), filters.get()),\n        move |(p, f)| {\n            let api = api.clone();\n            async move {\n                api.list_audit_logs(\n                    p,\n                    20,\n                    if f.from.is_empty() {\n                        None\n                    } else {\n                        Some(f.from)\n                    },\n                    if f.to.is_empty() { None } else { Some(f.to) },\n                    if f.actor_id.is_empty() {\n                        None\n                    } else {\n                        Some(f.actor_id)\n                    },\n                    if f.event_type.is_empty() {\n                        None\n                    } else {\n                        Some(f.event_type)\n                    },\n                    if f.result.is_empty() {\n                        None\n                    } else {\n                        Some(f.result)\n                    },\n                )\n                .await\n            }\n        },\n    );\n\n    let api_export = api_client.clone();\n    let export_action = create_action(move |_| {\n        let api = api_export.clone();\n        let f = filters.get_untracked();\n        async move {\n            let result_data = api\n                .export_audit_logs(\n                    if f.from.is_empty() {\n                        None\n                    } else {\n                        Some(f.from)\n                    },\n                    if f.to.is_empty() { None } else { Some(f.to) },\n                    if f.actor_id.is_empty() {\n                        None\n                    } else {\n                        Some(f.actor_id)\n                    },\n                    if f.event_type.is_empty() {\n                        None\n                    } else {\n                        Some(f.event_type)\n                    },\n                    if f.result.is_empty() {\n                        None\n                    } else {\n                        Some(f.result)\n                    },\n                )\n                .await;\n\n            match result_data {\n                Ok(data) =\u003e {\n                    // In Rust WASM, to trigger download:\n                    // 1. Serialize data to JSON string\n                    // 2. Create Blob\n                    // 3. Create object URL\n                    // 4. Create anchor, click, revoke\n                    // We will use a helper or do it here.\n                    // Since we cannot access web_sys easily without boilerplate, and result is Vec\u003cAuditLog\u003e.\n                    // We will convert to JsValue and use web primitives if possible, or just print success?\n                    // The requirement is \"download\".\n                    // We'll wrap this logic in a function `trigger_download` if possible.\n                    // For now, let's just return Ok and handle UI side?\n                    // No, create_action should probably do the side effect if possible or we return data.\n\n                    // Helper using web-sys\n                    if let Ok(json_str) = serde_json::to_string(\u0026data) {\n                        trigger_download(\"audit_logs.json\", \u0026json_str);\n                        Ok(())\n                    } else {\n                        Err(ApiError::unknown(\"Failed to serialize export data\"))\n                    }\n                }\n                Err(e) =\u003e Err(e),\n            }\n        }\n    });\n\n    AuditLogViewModel {\n        logs_resource,\n        page,\n        filters,\n        export_action,\n    }\n}\n\nfn trigger_download(filename: \u0026str, content: \u0026str) {\n    use web_sys::{Blob, BlobPropertyBag, HtmlAnchorElement, Url};\n    if let Some(window) = web_sys::window() {\n        if let Some(document) = window.document() {\n            let props = BlobPropertyBag::new();\n            props.set_type(\"application/json\");\n\n            let blob_parts = js_sys::Array::of1(\u0026content.into());\n            if let Ok(blob) = Blob::new_with_str_sequence_and_options(\u0026blob_parts, \u0026props) {\n                if let Ok(url) = Url::create_object_url_with_blob(\u0026blob) {\n                    if let Ok(element) = document.create_element(\"a\") {\n                        if let Ok(anchor) = element.dyn_into::\u003cHtmlAnchorElement\u003e() {\n                            anchor.set_href(\u0026url);\n                            anchor.set_download(filename);\n                            anchor.click();\n                            let _ = Url::revoke_object_url(\u0026url);\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_export","mod.rs"],"content":"pub mod panel;\npub mod repository;\npub mod view_model;\n\npub use panel::AdminExportPage;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_export","panel.rs"],"content":"use super::view_model::{\n    needs_specific_user_selection, use_admin_export_view_model, ExportFilters,\n};\nuse crate::api::ApiError;\nuse crate::components::error::InlineErrorMessage;\nuse crate::components::forms::DatePicker;\nuse crate::components::layout::*;\nuse crate::pages::admin::components::user_select::{AdminUserSelect, UserSelectValue};\nuse crate::state::auth::use_auth;\nuse leptos::*;\n\n#[component]\npub fn AdminExportPage() -\u003e impl IntoView {\n    let (auth, _set_auth) = use_auth();\n    let is_admin = create_memo(move |_| {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin || user.role.eq_ignore_ascii_case(\"admin\"))\n            .unwrap_or(false)\n    });\n\n    view! {\n        \u003cLayout\u003e\n            \u003cShow\n                when=move || is_admin.get()\n                fallback=move || {\n                    view! {\n                        \u003cdiv class=\"space-y-6\"\u003e\n                            \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6\"\u003e\n                                \u003cp class=\"text-sm text-fg\"\u003e\n                                    {\"このページは管理者以上の権限が必要です。\"}\n                                \u003c/p\u003e\n                            \u003c/div\u003e\n                        \u003c/div\u003e\n                    }\n                }\n            \u003e\n                \u003cAdminExportPanel /\u003e\n            \u003c/Show\u003e\n        \u003c/Layout\u003e\n    }\n}\n\n#[component]\nfn AdminExportPanel() -\u003e impl IntoView {\n    let vm = use_admin_export_view_model();\n\n    let users_error = Signal::derive(move || vm.users_resource.get().and_then(|res| res.err()));\n    let specific_user_disabled = Signal::derive(move || !vm.use_specific_user.get());\n    let specific_user_required = Signal::derive(move || {\n        needs_specific_user_selection(vm.use_specific_user.get(), \u0026vm.username.get())\n    });\n\n    let on_export = {\n        move |_| {\n            let filters = ExportFilters {\n                username: if vm.use_specific_user.get_untracked() {\n                    vm.username.get_untracked()\n                } else {\n                    String::new()\n                },\n                from_date: vm.from_date.get_untracked(),\n                to_date: vm.to_date.get_untracked(),\n            };\n            if needs_specific_user_selection(\n                vm.use_specific_user.get_untracked(),\n                \u0026filters.username,\n            ) {\n                vm.error.set(Some(ApiError::validation(\n                    \"指定ユーザーを選択してください。\",\n                )));\n                vm.preview.set(None);\n                return;\n            }\n            if let Err(msg) = filters.validate() {\n                vm.error.set(Some(msg));\n                vm.preview.set(None);\n                return;\n            }\n            vm.error.set(None);\n            vm.preview.set(None);\n            vm.export_action.dispatch(filters);\n        }\n    };\n\n    let downloading = vm.export_action.pending();\n\n    view! {\n        \u003cdiv class=\"space-y-6\"\u003e\n            \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6\"\u003e\n                \u003ch2 class=\"text-lg font-medium text-fg mb-4\"\u003e{\"データエクスポート (CSV)\"}\u003c/h2\u003e\n                \u003cdiv class=\"grid grid-cols-1 lg:grid-cols-3 gap-3 mb-4\"\u003e\n                    \u003cdiv\u003e\n                        \u003clabel class=\"block text-sm text-fg-muted\"\u003e{\"ユーザー\"}\u003c/label\u003e\n                        \u003cdiv class=\"mt-1 space-y-2\"\u003e\n                            \u003cdiv class=\"flex items-center gap-4 text-sm text-fg\"\u003e\n                                \u003clabel class=\"flex items-center gap-1\"\u003e\n                                    \u003cinput\n                                        type=\"radio\"\n                                        name=\"export_user_filter\"\n                                        value=\"all\"\n                                        checked=move || !vm.use_specific_user.get()\n                                        on:change=move |_| {\n                                            vm.use_specific_user.set(false);\n                                            vm.username.set(String::new());\n                                            vm.error.set(None);\n                                            vm.preview.set(None);\n                                        }\n                                    /\u003e\n                                    {\"全ユーザー\"}\n                                \u003c/label\u003e\n                                \u003clabel class=\"flex items-center gap-1\"\u003e\n                                    \u003cinput\n                                        type=\"radio\"\n                                        name=\"export_user_filter\"\n                                        value=\"specific\"\n                                        checked=move || vm.use_specific_user.get()\n                                        on:change=move |_| {\n                                            vm.use_specific_user.set(true);\n                                            vm.error.set(None);\n                                            vm.preview.set(None);\n                                        }\n                                    /\u003e\n                                    {\"指定ユーザー\"}\n                                \u003c/label\u003e\n                            \u003c/div\u003e\n                            \u003cShow when=move || users_error.get().is_some()\u003e\n                                \u003cdiv class=\"space-y-1\"\u003e\n                                    \u003cinput\n                                        class=\"w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1 disabled:opacity-50\"\n                                        placeholder=\"username を直接入力\"\n                                        prop:value={move || vm.username.get()}\n                                        on:input=move |ev| vm.username.set(event_target_value(\u0026ev))\n                                        disabled=specific_user_disabled\n                                    /\u003e\n                                    \u003cInlineErrorMessage error={users_error} /\u003e\n                                \u003c/div\u003e\n                            \u003c/Show\u003e\n                            \u003cShow when=move || users_error.get().is_none()\u003e\n                                \u003cAdminUserSelect\n                                    users=vm.users_resource\n                                    selected=vm.username\n                                    label=None\n                                    placeholder=\"ユーザーを選択してください\".into()\n                                    value_kind=UserSelectValue::Username\n                                    disabled=specific_user_disabled\n                                /\u003e\n                            \u003c/Show\u003e\n                            \u003cShow when=move || specific_user_required.get()\u003e\n                                \u003cp class=\"text-xs text-status-warning-text\"\u003e\n                                    {\"指定ユーザーを選択してください。\"}\n                                \u003c/p\u003e\n                            \u003c/Show\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                    \u003cDatePicker\n                        label=Some(\"From\")\n                        value=vm.from_date\n                    /\u003e\n                    \u003cDatePicker\n                        label=Some(\"To\")\n                        value=vm.to_date\n                    /\u003e\n                \u003c/div\u003e\n                \u003cShow when=move || vm.error.get().is_some()\u003e\n                    \u003cInlineErrorMessage error={vm.error.into()} /\u003e\n                \u003c/Show\u003e\n                \u003cbutton\n                    class=\"px-4 py-2 bg-action-primary-bg text-action-primary-text rounded disabled:opacity-50\"\n                    on:click=on_export\n                    disabled=move || downloading.get() || specific_user_required.get()\n                \u003e\n                    \u003cspan class=\"inline-flex items-center gap-2\"\u003e\n                        \u003cShow when=move || downloading.get()\u003e\n                            \u003cspan class=\"h-4 w-4 animate-spin rounded-full border-2 border-action-primary-text/70 border-t-transparent\"\u003e\u003c/span\u003e\n                        \u003c/Show\u003e\n                        {move || if downloading.get() { \"エクスポート中...\" } else { \"CSVをエクスポート\" }}\n                    \u003c/span\u003e\n                \u003c/button\u003e\n                \u003cShow when=move || vm.preview.get().is_some()\u003e\n                    \u003cdiv class=\"mt-4\"\u003e\n                        \u003ch3 class=\"text-sm text-fg\"\u003e\n                            {\"プレビュー (先頭2KB) - ファイル名: \"}\n                            {move || vm.filename.get()}\n                        \u003c/h3\u003e\n                        \u003cpre class=\"mt-2 text-xs bg-surface-muted p-3 rounded overflow-auto max-h-64 whitespace-pre-wrap\"\u003e\n                            {move || vm.preview.get().unwrap_or_default()}\n                        \u003c/pre\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_export","repository.rs"],"content":"use crate::api::{ApiClient, ApiError};\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct AdminExportRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl Default for AdminExportRepository {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl AdminExportRepository {\n    pub fn new() -\u003e Self {\n        Self {\n            client: Rc::new(ApiClient::new()),\n        }\n    }\n\n    pub fn new_with_client(client: Rc\u003cApiClient\u003e) -\u003e Self {\n        Self { client }\n    }\n\n    pub async fn export_data_filtered(\n        \u0026self,\n        username: Option\u003c\u0026str\u003e,\n        from: Option\u003c\u0026str\u003e,\n        to: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cserde_json::Value, ApiError\u003e {\n        self.client.export_data_filtered(username, from, to).await\n    }\n\n    pub async fn fetch_users(\u0026self) -\u003e Result\u003cVec\u003ccrate::api::UserResponse\u003e, ApiError\u003e {\n        self.client.get_users().await\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_export","view_model.rs"],"content":"use super::repository::AdminExportRepository;\nuse crate::api::{ApiClient, ApiError};\nuse crate::utils::trigger_csv_download;\nuse chrono::NaiveDate;\nuse leptos::*;\nuse std::rc::Rc;\n\n#[derive(Clone, Default)]\npub struct ExportFilters {\n    pub username: String,\n    pub from_date: String,\n    pub to_date: String,\n}\n\nimpl ExportFilters {\n    fn normalized_str(value: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        let trimmed = value.trim();\n        if trimmed.is_empty() {\n            None\n        } else {\n            Some(trimmed)\n        }\n    }\n\n    pub fn username_param(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        Self::normalized_str(\u0026self.username)\n    }\n\n    pub fn start_date_param(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        Self::normalized_str(\u0026self.from_date)\n    }\n\n    pub fn end_date_param(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        Self::normalized_str(\u0026self.to_date)\n    }\n\n    pub fn validate(\u0026self) -\u003e Result\u003c(), ApiError\u003e {\n        let from_str = self.from_date.trim();\n        let to_str = self.to_date.trim();\n\n        let parse_date = |value: \u0026str| {\n            NaiveDate::parse_from_str(value, \"%Y-%m-%d\")\n                .map_err(|_| ApiError::validation(\"日付は YYYY-MM-DD 形式で入力してください。\"))\n        };\n\n        let from = if from_str.is_empty() {\n            None\n        } else {\n            Some(parse_date(from_str)?)\n        };\n        let to = if to_str.is_empty() {\n            None\n        } else {\n            Some(parse_date(to_str)?)\n        };\n\n        if let (Some(f), Some(t)) = (from, to) {\n            if f \u003e t {\n                return Err(ApiError::validation(\n                    \"From は To 以前の日付を指定してください。\",\n                ));\n            }\n        }\n\n        Ok(())\n    }\n}\n\n#[derive(Clone, Copy)]\npub struct AdminExportViewModel {\n    pub error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    pub preview: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub filename: RwSignal\u003cString\u003e,\n    pub username: RwSignal\u003cString\u003e,\n    pub from_date: RwSignal\u003cString\u003e,\n    pub to_date: RwSignal\u003cString\u003e,\n    pub use_specific_user: RwSignal\u003cbool\u003e,\n    pub users_resource: Resource\u003cbool, Result\u003cVec\u003ccrate::api::UserResponse\u003e, ApiError\u003e\u003e,\n    pub export_action: Action\u003cExportFilters, Result\u003cserde_json::Value, ApiError\u003e\u003e,\n}\n\npub fn use_admin_export_view_model() -\u003e AdminExportViewModel {\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repo = AdminExportRepository::new_with_client(Rc::new(api));\n\n    let error = create_rw_signal(None::\u003cApiError\u003e);\n    let preview = create_rw_signal(None::\u003cString\u003e);\n    let filename = create_rw_signal(String::new());\n    let username = create_rw_signal(String::new());\n    let from_date = create_rw_signal(String::new());\n    let to_date = create_rw_signal(String::new());\n    let use_specific_user = create_rw_signal(false);\n\n    let repo_users = repo.clone();\n    let users_resource = create_resource(\n        || true,\n        move |_| {\n            let repo = repo_users.clone();\n            async move { repo.fetch_users().await }\n        },\n    );\n\n    let repo_export = repo.clone();\n    let export_action = create_action(move |filters: \u0026ExportFilters| {\n        let repo = repo_export.clone();\n        let filters = filters.clone();\n        async move {\n            repo.export_data_filtered(\n                filters.username_param(),\n                filters.start_date_param(),\n                filters.end_date_param(),\n            )\n            .await\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = export_action.value().get() {\n            match result {\n                Ok(payload) =\u003e {\n                    let fname = payload\n                        .get(\"filename\")\n                        .and_then(|s| s.as_str())\n                        .unwrap_or(\"export.csv\");\n                    let csv = payload\n                        .get(\"csv_data\")\n                        .and_then(|c| c.as_str())\n                        .unwrap_or(\"\");\n                    filename.set(fname.to_string());\n                    preview.set(Some(csv.chars().take(2000).collect()));\n                    let _ = trigger_csv_download(fname, csv);\n                    error.set(None);\n                }\n                Err(message) =\u003e {\n                    error.set(Some(message));\n                    preview.set(None);\n                }\n            }\n        }\n    });\n\n    AdminExportViewModel {\n        error,\n        preview,\n        filename,\n        username,\n        from_date,\n        to_date,\n        use_specific_user,\n        users_resource,\n        export_action,\n    }\n}\n\npub fn needs_specific_user_selection(use_specific_user: bool, username: \u0026str) -\u003e bool {\n    use_specific_user \u0026\u0026 username.trim().is_empty()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::needs_specific_user_selection;\n\n    #[test]\n    fn specific_user_requires_selection() {\n        assert!(needs_specific_user_selection(true, \"\"));\n        assert!(needs_specific_user_selection(true, \"   \"));\n        assert!(!needs_specific_user_selection(true, \"admin\"));\n        assert!(!needs_specific_user_selection(false, \"\"));\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","components","archived_detail.rs"],"content":"use crate::{\n    api::{ApiError, ArchivedUserResponse},\n    components::{error::InlineErrorMessage, layout::SuccessMessage},\n    pages::admin_users::utils::MessageState,\n};\nuse leptos::*;\n\n#[component]\npub fn ArchivedUserDetailDrawer(\n    selected_archived_user: RwSignal\u003cOption\u003cArchivedUserResponse\u003e\u003e,\n    messages: MessageState,\n    restore_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n    delete_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n) -\u003e impl IntoView {\n    let restore_pending = restore_action.pending();\n    let delete_pending = delete_action.pending();\n\n    // State for delete confirmation\n    let show_delete_confirm = create_rw_signal(false);\n\n    view! {\n        \u003cShow\n            when=move || selected_archived_user.get().is_some()\n            fallback=|| view! {}.into_view()\n        \u003e\n            {move || {\n                selected_archived_user\n                    .get()\n                    .map(|user| {\n                        let overlay_close = {\n                            move |_| {\n                                messages.clear();\n                                show_delete_confirm.set(false);\n                                selected_archived_user.set(None);\n                            }\n                        };\n                        let button_close = {\n                            move |_| {\n                                messages.clear();\n                                show_delete_confirm.set(false);\n                                selected_archived_user.set(None);\n                            }\n                        };\n\n                        let restore_click = {\n                            move |_| {\n                                if let Some(current) = selected_archived_user.get_untracked() {\n                                    messages.clear();\n                                    restore_action.dispatch(current.id.clone());\n                                }\n                            }\n                        };\n\n                        let delete_click = move |_| {\n                            show_delete_confirm.set(true);\n                        };\n\n                        let confirm_delete = move |_| {\n                            if let Some(current) = selected_archived_user.get_untracked() {\n                                messages.clear();\n                                delete_action.dispatch(current.id.clone());\n                                show_delete_confirm.set(false);\n                            }\n                        };\n\n                        let cancel_delete = move |_| {\n                            show_delete_confirm.set(false);\n                        };\n\n                        view! {\n                            \u003cdiv class=\"fixed inset-0 z-50 flex justify-end\"\u003e\n                                \u003cdiv class=\"absolute inset-0 bg-overlay-backdrop\" on:click=overlay_close\u003e\u003c/div\u003e\n                                \u003cdiv class=\"relative w-full max-w-md bg-surface-elevated shadow-xl h-full overflow-y-auto\"\u003e\n                                    \u003cdiv class=\"flex items-center justify-between border-b border-border px-6 py-4\"\u003e\n                                        \u003cdiv\u003e\n                                            \u003ch3 class=\"text-lg font-semibold text-fg\"\u003e{user.full_name.clone()}\u003c/h3\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{format!(\"@{}\", user.username)}\u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cbutton class=\"text-fg-muted hover:text-fg\" on:click=button_close\u003e\n                                            {\"✕\"}\n                                        \u003c/button\u003e\n                                    \u003c/div\u003e\n                                    \u003cdiv class=\"p-6 space-y-4\"\u003e\n                                        \u003cdiv\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{\"権限\"}\u003c/p\u003e\n                                            \u003cp class=\"text-base text-fg font-medium\"\u003e{user.role.clone()}\u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{\"システム管理者\"}\u003c/p\u003e\n                                            \u003cp class=\"text-base text-fg font-medium\"\u003e\n                                                {if user.is_system_admin { \"有効\" } else { \"無効\" }}\n                                            \u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{\"退職日\"}\u003c/p\u003e\n                                            \u003cp class=\"text-base text-fg font-medium\"\u003e\n                                                {user.archived_at.split('T').next().unwrap_or(\u0026user.archived_at).to_string()}\n                                            \u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cShow when=move || messages.error.get().is_some()\u003e\n                                            \u003cInlineErrorMessage error={messages.error.into()} /\u003e\n                                        \u003c/Show\u003e\n                                        \u003cShow when=move || messages.success.get().is_some()\u003e\n                                            \u003cSuccessMessage message={messages.success.get().unwrap_or_default()} /\u003e\n                                        \u003c/Show\u003e\n\n                                        // Action buttons\n                                        \u003cdiv class=\"border-t pt-4 mt-4 space-y-2\"\u003e\n                                            \u003cbutton\n                                                class=\"w-full px-4 py-2 rounded bg-action-primary-bg text-action-primary-text hover:bg-action-primary-bg-hover disabled:opacity-50\"\n                                                disabled=move || restore_pending.get() || delete_pending.get()\n                                                on:click=restore_click\n                                            \u003e\n                                                {move || if restore_pending.get() { \"復職処理中...\" } else { \"復職させる\" }}\n                                            \u003c/button\u003e\n\n                                            \u003cShow\n                                                when=move || !show_delete_confirm.get()\n                                                fallback=move || {\n                                                    view! {\n                                                        \u003cdiv class=\"border border-status-error-border rounded p-4 bg-status-error-bg text-status-error-text\"\u003e\n                                                            \u003cp class=\"text-sm text-status-error-text mb-3\"\u003e\n                                                                {\"この退職ユーザーのデータを完全に削除しますか？この操作は取り消せません。\"}\n                                                            \u003c/p\u003e\n                                                            \u003cdiv class=\"flex gap-2\"\u003e\n                                                                \u003cbutton\n                                                                    class=\"flex-1 px-4 py-2 rounded bg-action-danger-bg text-action-danger-text disabled:opacity-50\"\n                                                                    disabled=move || delete_pending.get()\n                                                                    on:click=confirm_delete\n                                                                \u003e\n                                                                    {move || if delete_pending.get() { \"削除中...\" } else { \"完全削除する\" }}\n                                                                \u003c/button\u003e\n                                                                \u003cbutton\n                                                                    class=\"flex-1 px-4 py-2 rounded bg-surface-muted text-fg\"\n                                                                    on:click=cancel_delete\n                                                                \u003e\n                                                                    {\"キャンセル\"}\n                                                                \u003c/button\u003e\n                                                            \u003c/div\u003e\n                                                        \u003c/div\u003e\n                                                    }\n                                                }\n                                            \u003e\n                                                \u003cbutton\n                                                    class=\"w-full px-4 py-2 rounded bg-action-danger-bg text-action-danger-text hover:bg-action-danger-bg-hover disabled:opacity-50\"\n                                                    disabled=move || restore_pending.get() || delete_pending.get()\n                                                    on:click=delete_click\n                                                \u003e\n                                                    {\"完全削除\"}\n                                                \u003c/button\u003e\n                                            \u003c/Show\u003e\n                                        \u003c/div\u003e\n                                    \u003c/div\u003e\n                                \u003c/div\u003e\n                            \u003c/div\u003e\n                        }\n                    })\n                    .unwrap_or_else(|| view! { \u003cdiv\u003e\u003c/div\u003e })\n            }}\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","components","archived_list.rs"],"content":"use crate::{\n    api::{ApiError, ArchivedUserResponse},\n    components::error::InlineErrorMessage,\n};\nuse leptos::*;\n\n#[component]\npub fn ArchivedUserList(\n    archived_users_resource: Resource\u003c(bool, u32), Result\u003cVec\u003cArchivedUserResponse\u003e, ApiError\u003e\u003e,\n    loading: Signal\u003cbool\u003e,\n    on_select: Callback\u003cArchivedUserResponse\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"space-y-2\"\u003e\n            \u003cShow\n                when=move || loading.get()\n                fallback=move || {\n                    view! {\n                        \u003cSuspense fallback=move || view! { \u003cp class=\"text-fg-muted\"\u003e{\"読み込み中...\"}\u003c/p\u003e }\u003e\n                            {move || {\n                                archived_users_resource\n                                    .get()\n                                    .map(|result| match result {\n                                        Ok(users) if users.is_empty() =\u003e {\n                                            view! {\n                                                \u003cp class=\"text-fg-muted text-center py-8\"\u003e\n                                                    {\"退職ユーザーはいません。\"}\n                                                \u003c/p\u003e\n                                            }\n                                                .into_view()\n                                        }\n                                        Ok(users) =\u003e {\n                                            view! {\n                                                \u003cul class=\"divide-y divide-border border border-border rounded-lg\"\u003e\n                                                    \u003cFor\n                                                        each=move || users.clone()\n                                                        key=|user| user.id.clone()\n                                                        children=move |user| {\n                                                            let on_click = {\n                                                                let user = user.clone();\n                                                                move |_| on_select.call(user.clone())\n                                                            };\n                                                        view! {\n                                                            \u003cli\n                                                                class=\"px-4 py-3 hover:bg-surface-muted cursor-pointer flex items-center justify-between\"\n                                                                on:click=on_click\n                                                            \u003e\n                                                                \u003cdiv\u003e\n                                                                    \u003cp class=\"font-medium text-fg\"\u003e\n                                                                        {user.full_name.clone()}\n                                                                    \u003c/p\u003e\n                                                                    \u003cp class=\"text-sm text-fg-muted\"\u003e\n                                                                        {format!(\"@{}\", user.username)}\n                                                                    \u003c/p\u003e\n                                                                \u003c/div\u003e\n                                                                \u003cdiv class=\"text-right\"\u003e\n                                                                    \u003cp class=\"text-xs text-fg-muted\"\u003e{\"退職日\"}\u003c/p\u003e\n                                                                    \u003cp class=\"text-sm text-fg-muted\"\u003e\n                                                                        {user.archived_at.split('T').next().unwrap_or(\u0026user.archived_at).to_string()}\n                                                                    \u003c/p\u003e\n                                                                \u003c/div\u003e\n                                                                \u003c/li\u003e\n                                                            }\n                                                        }\n                                                    /\u003e\n                                                \u003c/ul\u003e\n                                            }\n                                                .into_view()\n                                        }\n                                        Err(err) =\u003e {\n                                            let error_signal = create_rw_signal(Some(err));\n                                            view! {\n                                                \u003cInlineErrorMessage error={error_signal.into()} /\u003e\n                                            }\n                                                .into_view()\n                                        }\n                                    })\n                            }}\n                        \u003c/Suspense\u003e\n                    }\n                }\n            \u003e\n                \u003cp class=\"text-fg-muted\"\u003e{\"読み込み中...\"}\u003c/p\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","components","detail.rs"],"content":"use crate::{\n    api::{ApiError, UserResponse},\n    components::{error::InlineErrorMessage, layout::SuccessMessage},\n    pages::admin_users::utils::MessageState,\n};\nuse leptos::*;\n\n#[component]\npub fn UserDetailDrawer(\n    selected_user: RwSignal\u003cOption\u003cUserResponse\u003e\u003e,\n    messages: MessageState,\n    reset_mfa_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n    delete_user_action: Action\u003c(String, bool), Result\u003c(), ApiError\u003e\u003e,\n    /// Current user's ID to prevent self-deletion\n    current_user_id: Signal\u003cOption\u003cString\u003e\u003e,\n) -\u003e impl IntoView {\n    let pending = reset_mfa_action.pending();\n    let delete_pending = delete_user_action.pending();\n\n    // State for delete confirmation\n    let show_delete_confirm = create_rw_signal(false);\n    let hard_delete_mode = create_rw_signal(false);\n\n    view! {\n        \u003cShow\n            when=move || selected_user.get().is_some()\n            fallback=|| view! {}.into_view()\n        \u003e\n            {move || {\n                selected_user\n                    .get()\n                    .map(|user| {\n                        let user_id = user.id.clone();\n                        let is_self = current_user_id.get().map(|id| id == user_id).unwrap_or(false);\n\n                        let overlay_close = {\n                            move |_| {\n                                messages.clear();\n                                show_delete_confirm.set(false);\n                                selected_user.set(None);\n                            }\n                        };\n                        let button_close = {\n                            move |_| {\n                                messages.clear();\n                                show_delete_confirm.set(false);\n                                selected_user.set(None);\n                            }\n                        };\n                        let reset_click = {\n                            move |_| {\n                                if let Some(current) = selected_user.get_untracked() {\n                                    messages.clear();\n                                    reset_mfa_action.dispatch(current.id.clone());\n                                }\n                            }\n                        };\n\n\n                        let soft_delete_click = move |_| {\n                            hard_delete_mode.set(false);\n                            show_delete_confirm.set(true);\n                        };\n\n                        let hard_delete_click = move |_| {\n                            hard_delete_mode.set(true);\n                            show_delete_confirm.set(true);\n                        };\n\n                        // Use selected_user signal to get user_id at runtime to avoid FnOnce issue\n                        let confirm_delete = move |_| {\n                            if let Some(current) = selected_user.get_untracked() {\n                                messages.clear();\n                                delete_user_action.dispatch((current.id.clone(), hard_delete_mode.get()));\n                                show_delete_confirm.set(false);\n                            }\n                        };\n\n                        let cancel_delete = move |_| {\n                            show_delete_confirm.set(false);\n                        };\n\n                        view! {\n                            \u003cdiv class=\"fixed inset-0 z-50 flex justify-end\"\u003e\n                                \u003cdiv class=\"absolute inset-0 bg-overlay-backdrop\" on:click=overlay_close\u003e\u003c/div\u003e\n                                \u003cdiv class=\"relative w-full max-w-md bg-surface-elevated shadow-xl h-full overflow-y-auto\"\u003e\n                                    \u003cdiv class=\"flex items-center justify-between border-b border-border px-6 py-4\"\u003e\n                                        \u003cdiv\u003e\n                                            \u003ch3 class=\"text-lg font-semibold text-fg\"\u003e{user.full_name}\u003c/h3\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{format!(\"@{}\", user.username)}\u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cbutton class=\"text-fg-muted hover:text-fg\" on:click=button_close\u003e\n                                            {\"✕\"}\n                                        \u003c/button\u003e\n                                    \u003c/div\u003e\n                                    \u003cdiv class=\"p-6 space-y-4\"\u003e\n                                        \u003cdiv\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{\"権限\"}\u003c/p\u003e\n                                            \u003cp class=\"text-base text-fg font-medium\"\u003e{user.role}\u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{\"システム管理者\"}\u003c/p\u003e\n                                            \u003cp class=\"text-base text-fg font-medium\"\u003e\n                                                {if user.is_system_admin { \"有効\" } else { \"無効\" }}\n                                            \u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{\"MFA\"}\u003c/p\u003e\n                                            \u003cp class=\"text-base text-fg font-medium\"\u003e\n                                                {if user.mfa_enabled { \"登録済み\" } else { \"未登録\" }}\n                                            \u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cShow when=move || messages.error.get().is_some()\u003e\n                                            \u003cInlineErrorMessage error={messages.error.into()} /\u003e\n                                        \u003c/Show\u003e\n                                        \u003cShow when=move || messages.success.get().is_some()\u003e\n                                            \u003cSuccessMessage message={messages.success.get().unwrap_or_default()} /\u003e\n                                        \u003c/Show\u003e\n                                        \u003cbutton\n                                            class=\"w-full px-4 py-2 rounded bg-action-primary-bg text-action-primary-text disabled:opacity-50\"\n                                            disabled=move || pending.get()\n                                            on:click=reset_click\n                                        \u003e\n                                            {move || if pending.get() { \"MFA をリセット中...\" } else { \"MFA をリセット\" }}\n                                        \u003c/button\u003e\n\n                                        // Delete buttons (hidden for self)\n                                        \u003cShow when=move || !is_self\u003e\n                                            \u003cShow\n                                                when=move || !show_delete_confirm.get()\n                                                fallback=move || {\n                                                    view! {\n                                                        \u003cdiv class=\"border border-status-error-border rounded p-4 bg-status-error-bg text-status-error-text\"\u003e\n                                                            \u003cp class=\"text-sm text-status-error-text mb-3\"\u003e\n                                                                {move || if hard_delete_mode.get() {\n                                                                    \"このユーザーと全ての関連データを完全に削除しますか？この操作は取り消せません。\"\n                                                                } else {\n                                                                    \"このユーザーを退職処理（アーカイブ）しますか？\"\n                                                                }}\n                                                            \u003c/p\u003e\n                                                            \u003cdiv class=\"flex gap-2\"\u003e\n                                                                \u003cbutton\n                                                                    class=\"flex-1 px-4 py-2 rounded bg-action-danger-bg text-action-danger-text disabled:opacity-50\"\n                                                                    disabled=move || delete_pending.get()\n                                                                    on:click=confirm_delete\n                                                                \u003e\n                                                                    {move || if delete_pending.get() { \"処理中...\" } else { \"削除する\" }}\n                                                                \u003c/button\u003e\n                                                                \u003cbutton\n                                                                    class=\"flex-1 px-4 py-2 rounded bg-surface-muted text-fg\"\n                                                                    on:click=cancel_delete\n                                                                \u003e\n                                                                    {\"キャンセル\"}\n                                                                \u003c/button\u003e\n                                                            \u003c/div\u003e\n                                                        \u003c/div\u003e\n                                                    }\n                                                }\n                                            \u003e\n                                                \u003cdiv class=\"border-t pt-4 mt-4 space-y-2\"\u003e\n                                                    \u003cp class=\"text-sm text-fg-muted\"\u003e{\"ユーザー削除\"}\u003c/p\u003e\n                                                    \u003cbutton\n                                                        class=\"w-full px-4 py-2 rounded bg-status-warning-text text-text-inverse disabled:opacity-50\"\n                                                        disabled=move || delete_pending.get()\n                                                        on:click=soft_delete_click.clone()\n                                                    \u003e\n                                                        {\"退職処理（アーカイブ）\"}\n                                                    \u003c/button\u003e\n                                                    \u003cbutton\n                                                        class=\"w-full px-4 py-2 rounded bg-action-danger-bg text-action-danger-text hover:bg-action-danger-bg-hover disabled:opacity-50\"\n                                                        disabled=move || delete_pending.get()\n                                                        on:click=hard_delete_click.clone()\n                                                    \u003e\n                                                        {\"完全削除\"}\n                                                    \u003c/button\u003e\n                                                \u003c/div\u003e\n                                            \u003c/Show\u003e\n                                        \u003c/Show\u003e\n                                        \u003cShow when=move || is_self\u003e\n                                            \u003cp class=\"text-sm text-fg-muted italic\"\u003e{\"自分自身は削除できません。\"}\u003c/p\u003e\n                                        \u003c/Show\u003e\n                                    \u003c/div\u003e\n                                \u003c/div\u003e\n                            \u003c/div\u003e\n                        }\n                    })\n                    .unwrap_or_else(|| view! { \u003cdiv\u003e\u003c/div\u003e })\n            }}\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","components","invite_form.rs"],"content":"use crate::{\n    api::{ApiError, CreateUser, UserResponse},\n    components::{error::InlineErrorMessage, layout::SuccessMessage},\n    pages::admin_users::utils::{InviteFormState, MessageState},\n};\nuse leptos::{ev, *};\nuse wasm_bindgen::JsCast;\n\n#[component]\npub fn InviteForm(\n    form_state: InviteFormState,\n    messages: MessageState,\n    invite_action: Action\u003cCreateUser, Result\u003cUserResponse, ApiError\u003e\u003e,\n    is_system_admin: Memo\u003cbool\u003e,\n) -\u003e impl IntoView {\n    let pending = invite_action.pending();\n    let on_submit = {\n        move |ev: ev::SubmitEvent| {\n            ev.prevent_default();\n            messages.clear();\n            if !is_system_admin.get_untracked() {\n                messages.set_error(ApiError::unknown(\"システム管理者のみ操作できます。\"));\n                return;\n            }\n            if !form_state.is_valid() {\n                messages.set_error(ApiError::validation(\"すべての必須項目を入力してください。\"));\n                return;\n            }\n            invite_action.dispatch(form_state.to_request());\n        }\n    };\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv\u003e\n                \u003ch2 class=\"text-lg font-medium text-fg\"\u003e{\"ユーザー招待 (管理者専用)\"}\u003c/h2\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"ユーザー名・氏名・権限を入力し、必要に応じてシステム管理者権限を付与します。\"}\u003c/p\u003e\n            \u003c/div\u003e\n\n            \u003cShow when=move || messages.error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={messages.error.into()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || messages.success.get().is_some()\u003e\n                \u003cSuccessMessage message={messages.success.get().unwrap_or_default()} /\u003e\n            \u003c/Show\u003e\n\n            \u003cform class=\"grid grid-cols-1 lg:grid-cols-2 gap-4\" on:submit=on_submit\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"ユーザー名\"}\u003c/label\u003e\n                    \u003cinput\n                        class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        placeholder=\"username\"\n                        prop:value=form_state.username\n                        on:input=move |ev| form_state.username.set(event_target_value(\u0026ev))\n                    /\u003e\n                \u003c/div\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"氏名\"}\u003c/label\u003e\n                    \u003cinput\n                        class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        placeholder=\"山田太郎\"\n                        prop:value=form_state.full_name\n                        on:input=move |ev| form_state.full_name.set(event_target_value(\u0026ev))\n                    /\u003e\n                \u003c/div\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"メールアドレス\"}\u003c/label\u003e\n                    \u003cinput\n                        type=\"email\"\n                        class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        placeholder=\"user@example.com\"\n                        prop:value=form_state.email\n                        on:input=move |ev| form_state.email.set(event_target_value(\u0026ev))\n                    /\u003e\n                \u003c/div\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"パスワード\"}\u003c/label\u003e\n                    \u003cinput\n                        type=\"password\"\n                        class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        prop:value=form_state.password\n                        on:input=move |ev| form_state.password.set(event_target_value(\u0026ev))\n                    /\u003e\n                \u003c/div\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"権限\"}\u003c/label\u003e\n                    \u003cselect\n                        class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        prop:value=form_state.role\n                        on:change=move |ev| form_state.role.set(event_target_value(\u0026ev))\n                    \u003e\n                        \u003coption value=\"employee\"\u003e{\"employee\"}\u003c/option\u003e\n                        \u003coption value=\"admin\"\u003e{\"admin\"}\u003c/option\u003e\n                    \u003c/select\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"flex items-center space-x-2 h-full pt-6\"\u003e\n                    \u003cinput\n                        type=\"checkbox\"\n                        class=\"h-4 w-4 text-action-primary-bg border-form-control-border rounded\"\n                        prop:checked=form_state.is_system_admin\n                        on:change=move |ev| {\n                            if let Some(target) =\n                                ev.target().and_then(|t| t.dyn_into::\u003cweb_sys::HtmlInputElement\u003e().ok())\n                            {\n                                form_state.is_system_admin.set(target.checked());\n                            }\n                        }\n                    /\u003e\n                    \u003cspan class=\"text-sm text-fg\"\u003e{\"システム管理者権限を付与\"}\u003c/span\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"lg:col-span-2\"\u003e\n                    \u003cbutton\n                        type=\"submit\"\n                        disabled=move || pending.get()\n                        class=\"px-4 py-2 bg-action-primary-bg text-action-primary-text rounded disabled:opacity-50\"\n                    \u003e\n                        {move || if pending.get() { \"作成中...\" } else { \"ユーザーを作成\" }}\n                    \u003c/button\u003e\n                \u003c/div\u003e\n            \u003c/form\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","components","list.rs"],"content":"use crate::{\n    api::{ApiError, UserResponse},\n    components::{error::InlineErrorMessage, layout::LoadingSpinner},\n};\nuse leptos::*;\n\n#[component]\npub fn UserList(\n    users_resource: Resource\u003c(bool, u32), Result\u003cVec\u003cUserResponse\u003e, ApiError\u003e\u003e,\n    loading: Signal\u003cbool\u003e,\n    on_select: Callback\u003cUserResponse\u003e,\n) -\u003e impl IntoView {\n    let users = Signal::derive(move || {\n        users_resource\n            .get()\n            .and_then(|result| result.ok())\n            .unwrap_or_default()\n    });\n    let fetch_error = Signal::derive(move || users_resource.get().and_then(|result| result.err()));\n\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv class=\"flex flex-col gap-1 lg:flex-row lg:items-center lg:justify-between\"\u003e\n                \u003cdiv\u003e\n                    \u003ch3 class=\"text-lg font-medium text-fg\"\u003e{\"ユーザー一覧\"}\u003c/h3\u003e\n                    \u003cp class=\"text-sm text-fg-muted\"\u003e{\"行をクリックすると詳細ドロワーが開きます。\"}\u003c/p\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n\n            \u003cShow when=move || fetch_error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={fetch_error.into()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || loading.get()\u003e\n                \u003cLoadingSpinner /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || !loading.get() \u0026\u0026 users.get().is_empty() \u0026\u0026 fetch_error.get().is_none()\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e\n                    {\"登録済みのユーザーが見つかりません。新しいユーザーを招待してください。\"}\n                \u003c/p\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || !users.get().is_empty()\u003e\n                \u003c\u003e\n                    \u003cdiv class=\"space-y-3 lg:hidden\"\u003e\n                        \u003cFor\n                            each=move || users.get()\n                            key=|user| user.id.clone()\n                            children=move |user: UserResponse| {\n                                let row_user = user.clone();\n                                let click_handler = {\n                                    let selected = row_user.clone();\n                                    move |_| on_select.call(selected.clone())\n                                };\n                                view! {\n                                    \u003cbutton\n                                        class=\"w-full text-left border border-border rounded-lg p-4 shadow-sm hover:bg-surface-muted\"\n                                        on:click=click_handler\n                                        type=\"button\"\n                                    \u003e\n                                        \u003cdiv class=\"flex items-start justify-between gap-3\"\u003e\n                                            \u003cdiv\u003e\n                                                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"ユーザー名\"}\u003c/p\u003e\n                                                \u003cp class=\"text-base font-semibold text-fg\"\u003e\n                                                    {row_user.username}\n                                                \u003c/p\u003e\n                                            \u003c/div\u003e\n                                            \u003cdiv class=\"text-right\"\u003e\n                                                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"権限\"}\u003c/p\u003e\n                                                \u003cp class=\"text-sm font-medium text-fg\"\u003e\n                                                    {row_user.role}\n                                                \u003c/p\u003e\n                                            \u003c/div\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv class=\"mt-3 grid grid-cols-2 gap-3 text-sm\"\u003e\n                                            \u003cdiv\u003e\n                                                \u003cp class=\"text-fg-muted\"\u003e{\"氏名\"}\u003c/p\u003e\n                                                \u003cp class=\"text-fg\"\u003e{row_user.full_name}\u003c/p\u003e\n                                            \u003c/div\u003e\n                                            \u003cdiv\u003e\n                                                \u003cp class=\"text-fg-muted\"\u003e{\"システム管理者\"}\u003c/p\u003e\n                                                \u003cp class=\"text-fg\"\u003e\n                                                    {if row_user.is_system_admin { \"Yes\" } else { \"No\" }}\n                                                \u003c/p\u003e\n                                            \u003c/div\u003e\n                                            \u003cdiv\u003e\n                                                \u003cp class=\"text-fg-muted\"\u003e{\"MFA\"}\u003c/p\u003e\n                                                \u003cp class=\"text-fg\"\u003e\n                                                    {if row_user.mfa_enabled { \"Enabled\" } else { \"Disabled\" }}\n                                                \u003c/p\u003e\n                                            \u003c/div\u003e\n                                        \u003c/div\u003e\n                                    \u003c/button\u003e\n                                }\n                            }\n                        /\u003e\n                    \u003c/div\u003e\n                    \u003cdiv class=\"hidden lg:block overflow-x-auto\"\u003e\n                        \u003ctable class=\"min-w-full divide-y divide-border\"\u003e\n                            \u003cthead class=\"bg-surface-muted\"\u003e\n                                \u003ctr\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\n                                        {\"ユーザー名\"}\n                                    \u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\n                                        {\"氏名\"}\n                                    \u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\n                                        {\"権限\"}\n                                    \u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\n                                        {\"システム管理者\"}\n                                    \u003c/th\u003e\n                                    \u003cth class=\"px-6 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e\n                                        {\"MFA\"}\n                                    \u003c/th\u003e\n                                \u003c/tr\u003e\n                            \u003c/thead\u003e\n                            \u003ctbody class=\"bg-surface-elevated divide-y divide-border\"\u003e\n                                \u003cFor\n                                    each=move || users.get()\n                                    key=|user| user.id.clone()\n                                    children=move |user: UserResponse| {\n                                        let row_user = user.clone();\n                                        let click_handler = {\n                                            let selected = row_user.clone();\n                                            move |_| on_select.call(selected.clone())\n                                        };\n                                        view! {\n                                            \u003ctr\n                                                class=\"hover:bg-surface-muted cursor-pointer\"\n                                                on:click=click_handler\n                                            \u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e\n                                                    {row_user.username}\n                                                \u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e\n                                                    {row_user.full_name}\n                                                \u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e\n                                                    {row_user.role}\n                                                \u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e\n                                                    {if row_user.is_system_admin { \"Yes\" } else { \"No\" }}\n                                                \u003c/td\u003e\n                                                \u003ctd class=\"px-6 py-4 whitespace-nowrap text-sm text-fg\"\u003e\n                                                    {if row_user.mfa_enabled { \"Enabled\" } else { \"Disabled\" }}\n                                                \u003c/td\u003e\n                                            \u003c/tr\u003e\n                                        }\n                                    }\n                                /\u003e\n                            \u003c/tbody\u003e\n                        \u003c/table\u003e\n                    \u003c/div\u003e\n                \u003c/\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","components","mod.rs"],"content":"pub mod archived_detail;\npub mod archived_list;\npub mod detail;\npub mod invite_form;\npub mod list;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","layout.rs"],"content":"use leptos::*;\n\n#[component]\npub fn UnauthorizedAdminUsersMessage() -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"space-y-6\"\u003e\n            \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6\"\u003e\n                \u003cp class=\"text-sm text-fg\"\u003e\n                    {\"このページはシステム管理者のみ利用できます。\"}\n                \u003c/p\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\npub fn AdminUsersFrame(children: Children) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"space-y-6\"\u003e\n            \u003cdiv\u003e\n                \u003ch1 class=\"text-2xl font-bold text-fg\"\u003e{\"ユーザー管理\"}\u003c/h1\u003e\n                \u003cp class=\"mt-1 text-sm text-fg-muted\"\u003e\n                    {\"ユーザー招待とアクセス権管理、MFA リセットをまとめて操作できます。\"}\n                \u003c/p\u003e\n            \u003c/div\u003e\n            {children()}\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","mod.rs"],"content":"pub mod components;\npub mod layout;\npub mod panel;\npub mod repository;\npub mod utils;\npub mod view_model;\n\n#[allow(unused_imports)]\npub use panel::AdminUsersPage;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","panel.rs"],"content":"use crate::{\n    api::{ArchivedUserResponse, UserResponse},\n    components::layout::Layout,\n    state::auth::use_auth,\n};\nuse leptos::*;\n\nuse super::{\n    components::{\n        archived_detail::ArchivedUserDetailDrawer, archived_list::ArchivedUserList,\n        detail::UserDetailDrawer, invite_form::InviteForm, list::UserList,\n    },\n    layout::{AdminUsersFrame, UnauthorizedAdminUsersMessage},\n    view_model::UserTab,\n};\n\n#[component]\npub fn AdminUsersPage() -\u003e impl IntoView {\n    let vm = super::view_model::use_admin_users_view_model();\n    let (auth, _) = use_auth();\n\n    let current_user_id = Signal::derive(move || auth.get().user.as_ref().map(|u| u.id.clone()));\n\n    let select_user = Callback::new({\n        let selected = vm.selected_user;\n        let messages = vm.drawer_messages;\n        move |user: UserResponse| {\n            messages.clear();\n            selected.set(Some(user));\n        }\n    });\n\n    let select_archived_user = Callback::new({\n        let selected = vm.selected_archived_user;\n        let messages = vm.drawer_messages;\n        move |user: ArchivedUserResponse| {\n            messages.clear();\n            selected.set(Some(user));\n        }\n    });\n\n    let set_tab_active = {\n        let tab = vm.active_tab;\n        move |_| tab.set(UserTab::Active)\n    };\n\n    let set_tab_archived = {\n        let tab = vm.active_tab;\n        move |_| tab.set(UserTab::Archived)\n    };\n\n    view! {\n        \u003cLayout\u003e\n            \u003cShow\n                when=move || vm.is_system_admin.get()\n                fallback=move || view! { \u003cUnauthorizedAdminUsersMessage /\u003e }.into_view()\n            \u003e\n                \u003cAdminUsersFrame\u003e\n                    // Tab header\n                    \u003cdiv class=\"flex border-b border-border mb-4\"\u003e\n                        \u003cbutton\n                            class=move || {\n                                if vm.active_tab.get() == UserTab::Active {\n                                    \"px-4 py-2 font-medium text-link border-b-2 border-action-primary-border\"\n                                } else {\n                                    \"px-4 py-2 font-medium text-fg-muted hover:text-fg\"\n                                }\n                            }\n                            on:click=set_tab_active\n                        \u003e\n                            {\"アクティブユーザー\"}\n                        \u003c/button\u003e\n                        \u003cbutton\n                            class=move || {\n                                if vm.active_tab.get() == UserTab::Archived {\n                                    \"px-4 py-2 font-medium text-link border-b-2 border-action-primary-border\"\n                                } else {\n                                    \"px-4 py-2 font-medium text-fg-muted hover:text-fg\"\n                                }\n                            }\n                            on:click=set_tab_archived\n                        \u003e\n                            {\"退職ユーザー\"}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n\n                    // Tab content\n                    \u003cShow\n                        when=move || vm.active_tab.get() == UserTab::Active\n                        fallback=move || {\n                            view! {\n                                \u003cArchivedUserList\n                                    archived_users_resource=vm.archived_users_resource\n                                    loading=vm.archived_users_resource.loading()\n                                    on_select=select_archived_user\n                                /\u003e\n                            }\n                        }\n                    \u003e\n                        \u003cInviteForm\n                            form_state=vm.invite_form\n                            messages=vm.invite_messages\n                            invite_action=vm.invite_action\n                            is_system_admin=vm.is_system_admin\n                        /\u003e\n                        \u003cUserList\n                            users_resource=vm.users_resource\n                            loading=vm.users_resource.loading()\n                            on_select=select_user\n                        /\u003e\n                    \u003c/Show\u003e\n                \u003c/AdminUsersFrame\u003e\n\n                // Active user detail drawer\n                \u003cUserDetailDrawer\n                    selected_user=vm.selected_user\n                    messages=vm.drawer_messages\n                    reset_mfa_action=vm.reset_mfa_action\n                    delete_user_action=vm.delete_user_action\n                    current_user_id=current_user_id\n                /\u003e\n\n                // Archived user detail drawer\n                \u003cArchivedUserDetailDrawer\n                    selected_archived_user=vm.selected_archived_user\n                    messages=vm.drawer_messages\n                    restore_action=vm.restore_archived_action\n                    delete_action=vm.delete_archived_action\n                /\u003e\n            \u003c/Show\u003e\n        \u003c/Layout\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","repository.rs"],"content":"use crate::api::{ApiClient, ApiError, ArchivedUserResponse, CreateUser, UserResponse};\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct AdminUsersRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl Default for AdminUsersRepository {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl AdminUsersRepository {\n    pub fn new() -\u003e Self {\n        Self {\n            client: std::rc::Rc::new(ApiClient::new()),\n        }\n    }\n\n    pub fn new_with_client(client: Rc\u003cApiClient\u003e) -\u003e Self {\n        Self { client }\n    }\n\n    pub async fn fetch_users(\u0026self) -\u003e Result\u003cVec\u003cUserResponse\u003e, ApiError\u003e {\n        self.client.get_users().await\n    }\n\n    pub async fn invite_user(\u0026self, payload: CreateUser) -\u003e Result\u003cUserResponse, ApiError\u003e {\n        self.client.create_user(payload).await\n    }\n\n    pub async fn reset_user_mfa(\u0026self, user_id: String) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_reset_mfa(\u0026user_id).await\n    }\n\n    /// Delete a user (soft delete by default, hard delete if `hard` is true).\n    pub async fn delete_user(\u0026self, user_id: String, hard: bool) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_delete_user(\u0026user_id, hard).await\n    }\n\n    // ========================================================================\n    // Archived user functions\n    // ========================================================================\n\n    pub async fn fetch_archived_users(\u0026self) -\u003e Result\u003cVec\u003cArchivedUserResponse\u003e, ApiError\u003e {\n        self.client.admin_get_archived_users().await\n    }\n\n    pub async fn restore_archived_user(\u0026self, user_id: String) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_restore_archived_user(\u0026user_id).await\n    }\n\n    pub async fn delete_archived_user(\u0026self, user_id: String) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.admin_delete_archived_user(\u0026user_id).await\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","utils.rs"],"content":"use crate::api::{ApiError, CreateUser};\nuse leptos::*;\n\n#[derive(Clone, Copy)]\npub struct InviteFormState {\n    pub username: RwSignal\u003cString\u003e,\n    pub full_name: RwSignal\u003cString\u003e,\n    pub email: RwSignal\u003cString\u003e,\n    pub password: RwSignal\u003cString\u003e,\n    pub role: RwSignal\u003cString\u003e,\n    pub is_system_admin: RwSignal\u003cbool\u003e,\n}\n\nimpl Default for InviteFormState {\n    fn default() -\u003e Self {\n        Self {\n            username: create_rw_signal(String::new()),\n            full_name: create_rw_signal(String::new()),\n            email: create_rw_signal(String::new()),\n            password: create_rw_signal(String::new()),\n            role: create_rw_signal(\"employee\".to_string()),\n            is_system_admin: create_rw_signal(false),\n        }\n    }\n}\n\nimpl InviteFormState {\n    pub fn is_valid(\u0026self) -\u003e bool {\n        !(self.username.get().trim().is_empty()\n            || self.full_name.get().trim().is_empty()\n            || self.email.get().trim().is_empty()\n            || self.password.get().trim().is_empty())\n    }\n\n    pub fn reset(\u0026self) {\n        self.username.set(String::new());\n        self.full_name.set(String::new());\n        self.email.set(String::new());\n        self.password.set(String::new());\n        self.role.set(\"employee\".to_string());\n        self.is_system_admin.set(false);\n    }\n\n    pub fn to_request(self) -\u003e CreateUser {\n        CreateUser {\n            username: self.username.get(),\n            password: self.password.get(),\n            full_name: self.full_name.get(),\n            email: self.email.get(),\n            role: self.role.get(),\n            is_system_admin: self.is_system_admin.get(),\n        }\n    }\n}\n\n#[derive(Clone, Copy)]\npub struct MessageState {\n    pub success: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n}\n\nimpl Default for MessageState {\n    fn default() -\u003e Self {\n        Self {\n            success: create_rw_signal(None),\n            error: create_rw_signal(None),\n        }\n    }\n}\n\nimpl MessageState {\n    pub fn clear(\u0026self) {\n        self.success.set(None);\n        self.error.set(None);\n    }\n\n    pub fn set_success(\u0026self, message: impl Into\u003cString\u003e) {\n        self.success.set(Some(message.into()));\n        self.error.set(None);\n    }\n\n    pub fn set_error(\u0026self, message: ApiError) {\n        self.error.set(Some(message));\n        self.success.set(None);\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use leptos::create_runtime;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    fn with_runtime\u003cT\u003e(test: impl FnOnce() -\u003e T) -\u003e T {\n        let runtime = create_runtime();\n        let result = test();\n        runtime.dispose();\n        result\n    }\n\n    #[wasm_bindgen_test]\n    fn invite_form_state_validation() {\n        with_runtime(|| {\n            let state = InviteFormState::default();\n            assert!(!state.is_valid());\n\n            state.username.set(\"admin\".into());\n            state.full_name.set(\"System 管理者\".into());\n            state.email.set(\"admin@example.com\".into());\n            state.password.set(\"Password123!\".into());\n\n            assert!(state.is_valid());\n\n            let request = state.to_request();\n            assert_eq!(request.username, \"admin\");\n            assert_eq!(request.full_name, \"System 管理者\");\n            assert_eq!(request.email, \"admin@example.com\");\n            assert_eq!(request.role, \"employee\");\n            assert!(!request.is_system_admin);\n        });\n    }\n\n    #[wasm_bindgen_test]\n    fn message_state_resets_flags() {\n        with_runtime(|| {\n            let state = MessageState::default();\n            state.set_error(crate::api::ApiError::validation(\"NG\"));\n            assert!(state.error.get().is_some());\n            assert!(state.success.get().is_none());\n\n            state.set_success(\"OK\");\n            assert!(state.success.get().is_some());\n            assert!(state.error.get().is_none());\n\n            state.clear();\n            assert!(state.success.get().is_none());\n            assert!(state.error.get().is_none());\n        });\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","admin_users","view_model.rs"],"content":"use super::{\n    repository::AdminUsersRepository,\n    utils::{InviteFormState, MessageState},\n};\nuse crate::api::{ApiClient, ApiError, ArchivedUserResponse, CreateUser, UserResponse};\nuse crate::state::auth::use_auth;\nuse leptos::*;\nuse std::rc::Rc;\n\n/// Tab selection for user management page\n#[derive(Clone, Copy, PartialEq, Eq, Default)]\npub enum UserTab {\n    #[default]\n    Active,\n    Archived,\n}\n\n#[derive(Clone, Copy)]\npub struct AdminUsersViewModel {\n    pub invite_form: InviteFormState,\n    pub invite_messages: MessageState,\n    pub drawer_messages: MessageState,\n    pub selected_user: RwSignal\u003cOption\u003cUserResponse\u003e\u003e,\n    pub selected_archived_user: RwSignal\u003cOption\u003cArchivedUserResponse\u003e\u003e,\n    pub active_tab: RwSignal\u003cUserTab\u003e,\n    pub users_resource: Resource\u003c(bool, u32), Result\u003cVec\u003cUserResponse\u003e, ApiError\u003e\u003e,\n    pub archived_users_resource: Resource\u003c(bool, u32), Result\u003cVec\u003cArchivedUserResponse\u003e, ApiError\u003e\u003e,\n    pub invite_action: Action\u003cCreateUser, Result\u003cUserResponse, ApiError\u003e\u003e,\n    pub reset_mfa_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n    /// Delete a user: (user_id, hard_delete)\n    pub delete_user_action: Action\u003c(String, bool), Result\u003c(), ApiError\u003e\u003e,\n    /// Restore an archived user\n    pub restore_archived_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n    /// Delete an archived user permanently\n    pub delete_archived_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n    pub is_system_admin: Memo\u003cbool\u003e,\n}\n\npub fn use_admin_users_view_model() -\u003e AdminUsersViewModel {\n    let (auth, _) = use_auth();\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repo = AdminUsersRepository::new_with_client(Rc::new(api));\n\n    let is_system_admin = create_memo(move |_| {\n        auth.get()\n            .user\n            .as_ref()\n            .map(|user| user.is_system_admin)\n            .unwrap_or(false)\n    });\n\n    let invite_form = InviteFormState::default();\n    let invite_messages = MessageState::default();\n    let drawer_messages = MessageState::default();\n    let selected_user = create_rw_signal(None::\u003cUserResponse\u003e);\n    let selected_archived_user = create_rw_signal(None::\u003cArchivedUserResponse\u003e);\n    let active_tab = create_rw_signal(UserTab::Active);\n\n    // Active users resource\n    let repo_resource = repo.clone();\n    let users_resource = create_resource(\n        move || (is_system_admin.get(), 0u32),\n        move |(allowed, _reload)| {\n            let repo = repo_resource.clone();\n            async move {\n                if !allowed {\n                    Err(ApiError::validation(\"システム管理者のみ利用できます。\"))\n                } else {\n                    repo.fetch_users().await\n                }\n            }\n        },\n    );\n\n    // Archived users resource\n    let repo_archived = repo.clone();\n    let archived_users_resource = create_resource(\n        move || (is_system_admin.get(), 0u32),\n        move |(allowed, _reload)| {\n            let repo = repo_archived.clone();\n            async move {\n                if !allowed {\n                    Err(ApiError::validation(\"システム管理者のみ利用できます。\"))\n                } else {\n                    repo.fetch_archived_users().await\n                }\n            }\n        },\n    );\n\n    let repo_invite = repo.clone();\n    let invite_action = create_action(move |payload: \u0026CreateUser| {\n        let repo = repo_invite.clone();\n        let payload = payload.clone();\n        async move { repo.invite_user(payload).await }\n    });\n\n    let repo_reset = repo.clone();\n    let reset_mfa_action = create_action(move |user_id: \u0026String| {\n        let repo = repo_reset.clone();\n        let user_id = user_id.clone();\n        async move { repo.reset_user_mfa(user_id).await }\n    });\n\n    let repo_delete = repo.clone();\n    let delete_user_action = create_action(move |args: \u0026(String, bool)| {\n        let repo = repo_delete.clone();\n        let (user_id, hard) = args.clone();\n        async move { repo.delete_user(user_id, hard).await }\n    });\n\n    let repo_restore = repo.clone();\n    let restore_archived_action = create_action(move |user_id: \u0026String| {\n        let repo = repo_restore.clone();\n        let user_id = user_id.clone();\n        async move { repo.restore_archived_user(user_id).await }\n    });\n\n    let repo_delete_archived = repo.clone();\n    let delete_archived_action = create_action(move |user_id: \u0026String| {\n        let repo = repo_delete_archived.clone();\n        let user_id = user_id.clone();\n        async move { repo.delete_archived_user(user_id).await }\n    });\n\n    // Effects for action success\n    create_effect(move |_| {\n        if let Some(result) = invite_action.value().get() {\n            match result {\n                Ok(user) =\u003e {\n                    invite_messages\n                        .set_success(format!(\"ユーザー '{}' を作成しました。\", user.username));\n                    invite_form.reset();\n                    users_resource.refetch();\n                }\n                Err(err) =\u003e {\n                    invite_messages.set_error(err);\n                }\n            }\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = reset_mfa_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    drawer_messages.set_success(\"MFA をリセットしました。\");\n                }\n                Err(err) =\u003e {\n                    drawer_messages.set_error(err);\n                }\n            }\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = delete_user_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    drawer_messages.set_success(\"ユーザーを削除しました。\");\n                    selected_user.set(None);\n                    users_resource.refetch();\n                    archived_users_resource.refetch();\n                }\n                Err(err) =\u003e {\n                    drawer_messages.set_error(err);\n                }\n            }\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = restore_archived_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    drawer_messages.set_success(\"ユーザーを復職させました。\");\n                    selected_archived_user.set(None);\n                    users_resource.refetch();\n                    archived_users_resource.refetch();\n                }\n                Err(err) =\u003e {\n                    drawer_messages.set_error(err);\n                }\n            }\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = delete_archived_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    drawer_messages.set_success(\"退職ユーザーを完全削除しました。\");\n                    selected_archived_user.set(None);\n                    archived_users_resource.refetch();\n                }\n                Err(err) =\u003e {\n                    drawer_messages.set_error(err);\n                }\n            }\n        }\n    });\n\n    AdminUsersViewModel {\n        invite_form,\n        invite_messages,\n        drawer_messages,\n        selected_user,\n        selected_archived_user,\n        active_tab,\n        users_resource,\n        archived_users_resource,\n        invite_action,\n        reset_mfa_action,\n        delete_user_action,\n        restore_archived_action,\n        delete_archived_action,\n        is_system_admin,\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","components","alerts.rs"],"content":"use crate::{\n    api::HolidayCalendarEntry,\n    components::{error::InlineErrorMessage, layout::LoadingSpinner},\n    state::attendance::describe_holiday_reason,\n};\nuse leptos::*;\n\n#[component]\npub fn HolidayAlerts(\n    holiday_entries: Signal\u003cVec\u003cHolidayCalendarEntry\u003e\u003e,\n    loading: Signal\u003cbool\u003e,\n    error: Signal\u003cOption\u003ccrate::api::ApiError\u003e\u003e,\n    active_period: Signal\u003c(i32, u32)\u003e,\n    on_refresh: Callback\u003c()\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-4 space-y-3\"\u003e\n            \u003cdiv class=\"flex flex-col gap-1 lg:flex-row lg:items-center lg:justify-between\"\u003e\n                \u003cdiv\u003e\n                    \u003ch3 class=\"text-base font-semibold text-fg\"\u003e{\"今月の休日\"}\u003c/h3\u003e\n                    \u003cp class=\"text-sm text-fg-muted\"\u003e\n                        {move || {\n                            let (year, month) = active_period.get();\n                            format!(\"{year}年{month}月に登録済みの休日一覧です。\")\n                        }}\n                    \u003c/p\u003e\n                \u003c/div\u003e\n                \u003cbutton\n                    class=\"px-3 py-1 text-sm rounded border border-border text-fg hover:bg-action-ghost-bg-hover disabled:opacity-50\"\n                    disabled={move || loading.get()}\n                    on:click=move |_| on_refresh.call(())\n                \u003e\n                    {\"再取得\"}\n                \u003c/button\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || error.get().is_some()\u003e\n                \u003cInlineErrorMessage error={error} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || loading.get()\u003e\n                \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                    \u003cLoadingSpinner /\u003e\n                    \u003cspan\u003e{\"休日カレンダーを読み込み中...\"}\u003c/span\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || !loading.get() \u0026\u0026 holiday_entries.get().is_empty()\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"登録された休日はありません。必要に応じて管理者へ連絡してください。\"} \u003c/p\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || !loading.get() \u0026\u0026 !holiday_entries.get().is_empty()\u003e\n                \u003cul class=\"space-y-2\"\u003e\n                    \u003cFor\n                        each=move || holiday_entries.get()\n                        key=|entry| (entry.date, entry.reason.clone())\n                        children=move |entry: HolidayCalendarEntry| {\n                            let label = describe_holiday_reason(entry.reason.as_str());\n                            view! {\n                                \u003cli class=\"flex items-center justify-between text-sm text-fg\"\u003e\n                                    \u003cspan\u003e{entry.date.format(\"%Y-%m-%d\").to_string()}\u003c/span\u003e\n                                    \u003cspan class=\"px-2 py-0.5 rounded-full text-xs bg-status-info-bg text-status-info-text\"\u003e\n                                        {label}\n                                    \u003c/span\u003e\n                                \u003c/li\u003e\n                            }\n                        }\n                    /\u003e\n                \u003c/ul\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","components","form.rs"],"content":"use crate::components::forms::DatePicker;\nuse crate::components::{error::InlineErrorMessage, layout::SuccessMessage};\nuse leptos::{ev::MouseEvent, Callback, *};\n\n#[component]\npub fn RangeFormSection(\n    from_input: RwSignal\u003cString\u003e,\n    to_input: RwSignal\u003cString\u003e,\n    exporting: Signal\u003cbool\u003e,\n    export_error: ReadSignal\u003cOption\u003ccrate::api::ApiError\u003e\u003e,\n    export_success: ReadSignal\u003cOption\u003cString\u003e\u003e,\n    history_loading: Signal\u003cbool\u003e,\n    history_error: Signal\u003cOption\u003ccrate::api::ApiError\u003e\u003e,\n    range_error: ReadSignal\u003cOption\u003cString\u003e\u003e,\n    last_refresh_error: Signal\u003cOption\u003ccrate::api::ApiError\u003e\u003e,\n    on_select_current_month: Callback\u003cMouseEvent\u003e,\n    on_load_range: Callback\u003cMouseEvent\u003e,\n    on_export_csv: Callback\u003cMouseEvent\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-4 flex flex-col gap-3 lg:flex-row lg:items-end\"\u003e\n            \u003cdiv class=\"w-full lg:w-48\"\u003e\n                \u003cDatePicker\n                    label=Some(\"開始日\")\n                    value=from_input\n                /\u003e\n            \u003c/div\u003e\n            \u003cdiv class=\"w-full lg:w-48\"\u003e\n                \u003cDatePicker\n                    label=Some(\"終了日\")\n                    value=to_input\n                /\u003e\n            \u003c/div\u003e\n            \u003cbutton\n                class=\"w-full lg:w-auto px-4 py-2 bg-surface-muted text-fg rounded hover:bg-action-ghost-bg-hover\"\n                on:click=move |ev| on_select_current_month.call(ev)\n            \u003e\n                {\"今月\"}\n            \u003c/button\u003e\n            \u003cbutton\n                class=\"w-full lg:w-auto px-4 py-2 bg-action-primary-bg text-action-primary-text rounded disabled:opacity-50\"\n                disabled={move || history_loading.get()}\n                on:click=move |ev| on_load_range.call(ev)\n            \u003e\n                {move || if history_loading.get() { \"読み込み中...\" } else { \"読み込み\" }}\n            \u003c/button\u003e\n            \u003cbutton\n                class=\"w-full lg:w-auto px-4 py-2 bg-action-secondary-bg text-action-secondary-text rounded disabled:opacity-50\"\n                disabled={move || exporting.get()}\n                on:click=move |ev| on_export_csv.call(ev)\n            \u003e\n                {move || if exporting.get() { \"CSV生成中...\" } else { \"CSVダウンロード\" }}\n            \u003c/button\u003e\n        \u003c/div\u003e\n        \u003cShow when=move || export_error.get().is_some()\u003e\n            \u003cInlineErrorMessage error={export_error.into()} /\u003e\n        \u003c/Show\u003e\n        \u003cShow when=move || export_success.get().is_some()\u003e\n            \u003cSuccessMessage message={export_success.get().unwrap_or_default()} /\u003e\n        \u003c/Show\u003e\n        \u003cShow when=move || range_error.get().is_some()\u003e\n            \u003cdiv class=\"bg-status-error-bg border border-status-error-border text-status-error-text px-4 py-3 rounded\"\u003e\n                {range_error.get().unwrap_or_default()}\n            \u003c/div\u003e\n        \u003c/Show\u003e\n        \u003cShow when=move || history_error.get().is_some()\u003e\n            \u003cInlineErrorMessage error={history_error} /\u003e\n        \u003c/Show\u003e\n        \u003cShow when=move || last_refresh_error.get().is_some()\u003e\n            \u003cInlineErrorMessage error={last_refresh_error} /\u003e\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","components","history.rs"],"content":"use crate::{\n    api::{AttendanceResponse, BreakRecordResponse, HolidayCalendarEntry},\n    components::{error::InlineErrorMessage, layout::LoadingSpinner},\n    pages::attendance::repository,\n    state::attendance::describe_holiday_reason,\n};\nuse leptos::*;\nuse log::error;\n\n#[component]\npub fn HistorySection(\n    history: Signal\u003cVec\u003cAttendanceResponse\u003e\u003e,\n    holiday_entries: Signal\u003cVec\u003cHolidayCalendarEntry\u003e\u003e,\n    loading: Signal\u003cbool\u003e,\n    error: Signal\u003cOption\u003ccrate::api::ApiError\u003e\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow-premium rounded-3xl overflow-hidden border border-border\"\u003e\n            \u003cdiv class=\"px-6 py-4 border-b border-border flex items-center justify-between\"\u003e\n                \u003ch3 class=\"text-lg font-display font-bold text-fg\"\u003e{\"勤怠履歴\"}\u003c/h3\u003e\n                \u003cShow when=move || loading.get()\u003e\n                    \u003cdiv class=\"flex items-center gap-2 text-xs font-bold text-action-primary-bg uppercase tracking-widest animate-pulse\"\u003e\n                        \u003cLoadingSpinner /\u003e\n                        \u003cspan\u003e{\"更新中...\"}\u003c/span\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n            \u003cdiv class=\"p-2\"\u003e\n                \u003cShow when=move || error.get().is_some()\u003e\n                    \u003cdiv class=\"p-4\"\u003e\n                        \u003cInlineErrorMessage error={error} /\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n                \u003cShow when=move || !loading.get() \u0026\u0026 history.get().is_empty()\u003e\n                    \u003cdiv class=\"p-12 text-center\"\u003e\n                        \u003cdiv class=\"w-16 h-16 bg-surface-muted rounded-full flex items-center justify-center mx-auto mb-4 text-fg-muted\"\u003e\n                            \u003ci class=\"fas fa-calendar-times text-2xl\"\u003e\u003c/i\u003e\n                        \u003c/div\u003e\n                        \u003cp class=\"text-fg-muted font-medium font-sans\"\u003e{\"指定された期間の記録はありません\"} \u003c/p\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n                \u003cShow when=move || !history.get().is_empty()\u003e\n                    \u003cul class=\"divide-y divide-border\"\u003e\n                        \u003cFor\n                            each=move || history.get()\n                            key=|item| item.id.clone()\n                            children=move |item| view! { \u003cHistoryRow item=item holiday_entries=holiday_entries /\u003e }\n                        /\u003e\n                    \u003c/ul\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\nfn HistoryRow(\n    item: AttendanceResponse,\n    holiday_entries: Signal\u003cVec\u003cHolidayCalendarEntry\u003e\u003e,\n) -\u003e impl IntoView {\n    let expanded = create_rw_signal(false);\n    let breaks = create_rw_signal(Vec::\u003cBreakRecordResponse\u003e::new());\n    let (loading_breaks, set_loading_breaks) = create_signal(false);\n\n    let day_holiday_reason = create_memo(move |_| {\n        holiday_entries\n            .get()\n            .iter()\n            .find(|entry| entry.date == item.date)\n            .map(|entry| entry.reason.clone())\n    });\n\n    let toggle = {\n        let attendance_id = item.id.clone();\n        move |_| {\n            let now_expanded = !expanded.get();\n            expanded.set(now_expanded);\n            if now_expanded \u0026\u0026 breaks.get().is_empty() {\n                let api = use_context::\u003ccrate::api::ApiClient\u003e()\n                    .unwrap_or_else(crate::api::ApiClient::new);\n                let attendance_id = attendance_id.clone();\n                set_loading_breaks.set(true);\n                spawn_local(async move {\n                    match repository::fetch_breaks_by_attendance(\u0026api, \u0026attendance_id).await {\n                        Ok(list) =\u003e {\n                            breaks.set(list);\n                            set_loading_breaks.set(false);\n                        }\n                        Err(err) =\u003e {\n                            error!(\"Failed to load breaks: {}\", err);\n                            set_loading_breaks.set(false);\n                        }\n                    }\n                });\n            }\n        }\n    };\n\n    view! {\n        \u003cli class=\"group transition-all duration-200 hover:bg-surface-muted rounded-2xl mx-1 my-1\"\u003e\n            \u003cdiv class=\"px-4 py-4 sm:px-6 cursor-pointer\" on:click=toggle\u003e\n                \u003cdiv class=\"flex items-center justify-between\"\u003e\n                    \u003cdiv class=\"flex items-center gap-4\"\u003e\n                        \u003cdiv class=\"w-12 h-12 rounded-xl bg-surface-elevated border border-border shadow-sm flex flex-col items-center justify-center group-hover:border-action-primary-border group-hover:bg-primary-subtle transition-colors\"\u003e\n                            \u003cspan class=\"text-[10px] font-bold text-fg-muted leading-none mb-1\"\u003e\n                                {item.date.format(\"%m\").to_string()}\n                            \u003c/span\u003e\n                            \u003cspan class=\"text-lg font-display font-black text-fg leading-none\"\u003e\n                                {item.date.format(\"%d\").to_string()}\n                            \u003c/span\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003cdiv class=\"flex items-center gap-2\"\u003e\n                                \u003cShow when=move || day_holiday_reason.get().is_some()\u003e\n                                    \u003cspan class=\"inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold bg-status-warning-bg text-status-warning-text uppercase\"\u003e\n                                        {move || {\n                                            day_holiday_reason\n                                                .get()\n                                                .as_ref()\n                                                .map(|code| describe_holiday_reason(code.trim()).to_string())\n                                                .unwrap_or_default()\n                                        }}\n                                    \u003c/span\u003e\n                                \u003c/Show\u003e\n                                \u003cspan class=\"text-sm font-bold text-fg\"\u003e\n                                    {match (item.clock_in_time, item.clock_out_time) {\n                                        (Some(start), Some(end)) =\u003e format!(\"{} - {}\", start.format(\"%H:%M\"), end.format(\"%H:%M\")),\n                                        (Some(start), None) =\u003e format!(\"{} - (未退勤)\", start.format(\"%H:%M\")),\n                                        _ =\u003e \"記録なし\".to_string(),\n                                    }}\n                                \u003c/span\u003e\n                            \u003c/div\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                    \u003cdiv class=\"flex items-center gap-6\"\u003e\n                        \u003cdiv class=\"text-right\"\u003e\n                            \u003cp class=\"text-xs font-bold text-fg-muted uppercase tracking-wider mb-0.5\"\u003e{\"勤務時間\"}\u003c/p\u003e\n                            \u003cp class=\"text-lg font-display font-black text-action-primary-bg\"\u003e\n                                {item.total_work_hours.map(|h| format!(\"{:.1}h\", h)).unwrap_or_else(|| \"-\".into())}\n                            \u003c/p\u003e\n                        \u003c/div\u003e\n                        \u003cdiv class=move || format!(\"transition-transform duration-300 {}\", if expanded.get() { \"rotate-180 text-action-primary-bg\" } else { \"text-fg-muted\" })\u003e\n                            \u003ci class=\"fas fa-chevron-down\"\u003e\u003c/i\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n\n                \u003cShow when=move || expanded.get()\u003e\n                    \u003cdiv class=\"mt-4 bg-surface-elevated rounded-2xl border border-border p-4 shadow-sm animate-pop-in overflow-hidden\"\u003e\n                        \u003cdiv class=\"flex items-center justify-between mb-3\"\u003e\n                            \u003ch4 class=\"text-xs font-bold text-fg-muted uppercase tracking-widest flex items-center gap-2\"\u003e\n                                \u003ci class=\"fas fa-mug-hot text-status-warning-text\"\u003e\u003c/i\u003e\n                                {\"休憩詳細\"}\n                            \u003c/h4\u003e\n                            \u003cShow when=move || loading_breaks.get()\u003e\n                                \u003cdiv class=\"animate-spin rounded-full h-3 w-3 border-b-2 border-action-primary-bg\"\u003e\u003c/div\u003e\n                            \u003c/Show\u003e\n                        \u003c/div\u003e\n\n                        \u003cShow when=move || !loading_breaks.get() \u0026\u0026 breaks.get().is_empty()\u003e\n                            \u003cp class=\"text-xs text-fg-muted font-medium py-2\"\u003e{\"休憩の記録はありません\"}\u003c/p\u003e\n                        \u003c/Show\u003e\n\n                        \u003cShow when=move || !breaks.get().is_empty()\u003e\n                            \u003cul class=\"space-y-2\"\u003e\n                                \u003cFor\n                                    each=move || breaks.get()\n                                    key=|record| record.id.clone()\n                                    children=move |record| {\n                                        let duration = record\n                                            .duration_minutes\n                                            .map(|mins| format!(\"{mins}分\"))\n                                            .unwrap_or_else(|| \"-\".into());\n                                        view! {\n                                            \u003cli class=\"flex items-center justify-between p-2 rounded-xl bg-surface-muted text-xs font-medium\"\u003e\n                                                \u003cspan class=\"text-fg-muted\"\u003e{format!(\n                                                    \"{} - {}\",\n                                                    record.break_start_time.format(\"%H:%M\"),\n                                                    record\n                                                        .break_end_time\n                                                        .map(|t| t.format(\"%H:%M\").to_string())\n                                                        .unwrap_or_else(|| \"進行中\".into())\n                                                )}\u003c/span\u003e\n                                                \u003cspan class=\"text-fg font-bold\"\u003e{duration}\u003c/span\u003e\n                                            \u003c/li\u003e\n                                        }\n                                    }\n                                /\u003e\n                            \u003c/ul\u003e\n                        \u003c/Show\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n        \u003c/li\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","components","mod.rs"],"content":"pub mod alerts;\npub mod form;\npub mod history;\npub mod summary;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","components","summary.rs"],"content":"use crate::{\n    components::forms::AttendanceActionButtons,\n    state::attendance::{describe_holiday_reason, AttendanceState, ClockMessage},\n};\nuse leptos::{ev::MouseEvent, *};\n\n#[component]\npub fn SummarySection(\n    state: ReadSignal\u003cAttendanceState\u003e,\n    action_pending: ReadSignal\u003cbool\u003e,\n    message: ReadSignal\u003cOption\u003cClockMessage\u003e\u003e,\n    on_clock_in: Callback\u003cMouseEvent\u003e,\n    on_clock_out: Callback\u003cMouseEvent\u003e,\n    on_break_start: Callback\u003cMouseEvent\u003e,\n    on_break_end: Callback\u003cMouseEvent\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv\u003e\n            \u003ch1 class=\"text-2xl font-bold text-fg\"\u003e{\"勤怠管理\"}\u003c/h1\u003e\n            \u003cp class=\"mt-1 text-sm text-fg-muted\"\u003e{\"当日のステータスを確認できます。\"}\u003c/p\u003e\n            \u003cShow when=move || state.get().today_holiday_reason.is_some()\u003e\n                \u003cp class=\"mt-1 text-sm text-status-warning-text\"\u003e\n                    {move || state\n                        .get()\n                        .today_holiday_reason\n                        .as_ref()\n                        .map(|reason| describe_holiday_reason(reason).to_string())\n                        .unwrap_or_default()}\n                \u003c/p\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n        \u003cShow when=move || state.get().today_status.is_some()\u003e\n            \u003cdiv class=\"rounded-md p-4 border border-border bg-surface-elevated shadow-sm\"\u003e\n                \u003cAttendanceActionButtons\n                    attendance_state=state\n                    action_pending=action_pending\n                    message=message\n                    on_clock_in=on_clock_in\n                    on_clock_out=on_clock_out\n                    on_break_start=on_break_start\n                    on_break_end=on_break_end\n                /\u003e\n            \u003c/div\u003e\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","layout.rs"],"content":"use crate::components::layout::Layout;\nuse leptos::*;\n\n#[component]\npub fn AttendanceFrame(children: Children) -\u003e impl IntoView {\n    view! { \u003cLayout\u003e{children()}\u003c/Layout\u003e }\n}\n\n#[component]\npub fn UnauthorizedMessage() -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 text-center\"\u003e\n            \u003cp class=\"text-sm text-fg\"\u003e{\"このページを表示するには適切な権限が必要です。\"}\u003c/p\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","mod.rs"],"content":"pub mod components;\npub mod layout;\nmod panel;\npub mod repository;\npub mod utils;\npub mod view_model;\n\npub use panel::AttendancePage;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","panel.rs"],"content":"use super::{\n    components::{\n        alerts::HolidayAlerts, form::RangeFormSection, history::HistorySection,\n        summary::SummarySection,\n    },\n    layout::AttendanceFrame,\n    view_model::use_attendance_view_model,\n};\nuse leptos::*;\n\n#[component]\npub fn AttendancePage() -\u003e impl IntoView {\n    view! { \u003cAttendancePanel /\u003e }\n}\n\n#[component]\npub fn AttendancePanel() -\u003e impl IntoView {\n    let vm = use_attendance_view_model();\n    let (state, _) = vm.state;\n    let form_state = vm.form_state.clone();\n    let from_input = form_state.start_date_signal();\n    let to_input = form_state.end_date_signal();\n\n    let history_loading = vm.history_resource.loading();\n    let history_error =\n        Signal::derive(move || vm.history_resource.get().and_then(|result| result.err()));\n\n    let holiday_loading = vm.holiday_resource.loading();\n    let holiday_entries = Signal::derive(move || {\n        vm.holiday_resource\n            .get()\n            .and_then(|result| result.ok())\n            .unwrap_or_default()\n    });\n    let holiday_error =\n        Signal::derive(move || vm.holiday_resource.get().and_then(|result| result.err()));\n    let active_holiday_period =\n        Signal::derive(move || vm.holiday_query.with(|query| (query.year, query.month)));\n\n    let exporting = vm.export_action.pending();\n    let _context_loading = vm.context_resource.loading();\n    let last_refresh_error = Signal::derive(move || state.with(|s| s.last_refresh_error.clone()));\n    let history_signal = Signal::derive(move || state.with(|s| s.attendance_history.clone()));\n\n    view! {\n        \u003cAttendanceFrame\u003e\n            \u003cdiv class=\"space-y-6\"\u003e\n                \u003cSummarySection\n                    state=state\n                    action_pending={vm.clock_action.pending()}\n                    message={vm.clock_message.read_only()}\n                    on_clock_in={Callback::new(vm.handle_clock_in())}\n                    on_clock_out={Callback::new(vm.handle_clock_out())}\n                    on_break_start={Callback::new(vm.handle_break_start())}\n                    on_break_end={Callback::new(vm.handle_break_end())}\n                /\u003e\n                \u003cRangeFormSection\n                    from_input=from_input\n                    to_input=to_input\n                    exporting={exporting.into()}\n                    export_error={vm.export_error.read_only()}\n                    export_success={vm.export_success.read_only()}\n                    history_loading=history_loading\n                    history_error={history_error}\n                    range_error={vm.range_error.read_only()}\n                    last_refresh_error=last_refresh_error\n                    on_select_current_month=Callback::new(vm.on_select_current_month())\n                    on_load_range=Callback::new(vm.on_load_range())\n                    on_export_csv=Callback::new(vm.on_export_csv())\n                /\u003e\n                \u003cHolidayAlerts\n                    holiday_entries={holiday_entries}\n                    loading={holiday_loading}\n                    error={holiday_error}\n                    active_period={active_holiday_period}\n                    on_refresh=Callback::new(vm.on_refresh_holidays())\n                /\u003e\n                \u003cHistorySection\n                    history=history_signal\n                    holiday_entries={holiday_entries}\n                    loading=history_loading\n                    error={history_error}\n                /\u003e\n            \u003c/div\u003e\n        \u003c/AttendanceFrame\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","repository.rs"],"content":"use crate::api::{ApiClient, ApiError, BreakRecordResponse, HolidayCalendarEntry};\n\npub async fn fetch_monthly_holidays(\n    api: \u0026ApiClient,\n    year: i32,\n    month: u32,\n) -\u003e Result\u003cVec\u003cHolidayCalendarEntry\u003e, ApiError\u003e {\n    api.get_monthly_holidays(year, month).await\n}\n\npub async fn fetch_breaks_by_attendance(\n    api: \u0026ApiClient,\n    attendance_id: \u0026str,\n) -\u003e Result\u003cVec\u003cBreakRecordResponse\u003e, ApiError\u003e {\n    api.get_breaks_by_attendance(attendance_id).await\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","utils.rs"],"content":"use crate::api::ApiError;\nuse chrono::{Datelike, Duration, Months, NaiveDate};\nuse leptos::*;\n\n#[derive(Clone)]\npub struct AttendanceFormState {\n    from: RwSignal\u003cString\u003e,\n    to: RwSignal\u003cString\u003e,\n}\n\nimpl AttendanceFormState {\n    pub fn new() -\u003e Self {\n        Self {\n            from: create_rw_signal(String::new()),\n            to: create_rw_signal(String::new()),\n        }\n    }\n\n    pub fn start_date_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.from\n    }\n\n    pub fn end_date_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.to\n    }\n\n    pub fn set_range(\u0026self, from: NaiveDate, to: NaiveDate) {\n        self.from.set(from.format(\"%Y-%m-%d\").to_string());\n        self.to.set(to.format(\"%Y-%m-%d\").to_string());\n    }\n\n    pub fn to_payload(\u0026self) -\u003e Result\u003c(Option\u003cNaiveDate\u003e, Option\u003cNaiveDate\u003e), ApiError\u003e {\n        let from_val = self.from.get();\n        let to_val = self.to.get();\n        let from = parse_date_input(\u0026from_val, \"開始日は YYYY-MM-DD 形式で入力してください。\")?;\n        let to = parse_date_input(\u0026to_val, \"終了日は YYYY-MM-DD 形式で入力してください。\")?;\n        if let (Some(f), Some(t)) = (from, to) {\n            if f \u003e t {\n                return Err(ApiError::validation(\n                    \"開始日は終了日以前の日付を指定してください。\",\n                ));\n            }\n        }\n        Ok((from, to))\n    }\n}\n\nfn parse_date_input(value: \u0026str, error_message: \u0026str) -\u003e Result\u003cOption\u003cNaiveDate\u003e, ApiError\u003e {\n    if value.trim().is_empty() {\n        return Ok(None);\n    }\n    NaiveDate::parse_from_str(value.trim(), \"%Y-%m-%d\")\n        .map(Some)\n        .map_err(|_| ApiError::validation(error_message))\n}\n\npub fn month_bounds(today: NaiveDate) -\u003e Option\u003c(NaiveDate, NaiveDate)\u003e {\n    let first = NaiveDate::from_ymd_opt(today.year(), today.month(), 1)?;\n    let next_month = first.checked_add_months(Months::new(1))?;\n    let last = next_month.checked_sub_signed(Duration::days(1))?;\n    Some((first, last))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::Datelike;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn form_state_to_payload_accepts_blank() {\n        let state = AttendanceFormState::new();\n        let result = state.to_payload().unwrap();\n        assert!(result.0.is_none());\n        assert!(result.1.is_none());\n    }\n\n    #[wasm_bindgen_test]\n    fn form_state_validates_order() {\n        let state = AttendanceFormState::new();\n        state.start_date_signal().set(\"2025-02-10\".into());\n        state.end_date_signal().set(\"2025-02-01\".into());\n        assert!(state.to_payload().is_err());\n    }\n\n    #[wasm_bindgen_test]\n    fn month_bounds_returns_expected_range() {\n        let date = NaiveDate::from_ymd_opt(2025, 2, 18).unwrap();\n        let (start, end) = month_bounds(date).unwrap();\n        assert_eq!(start.day(), 1);\n        assert_eq!(end.day(), 28);\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","attendance","view_model.rs"],"content":"use super::repository;\nuse super::utils::{month_bounds, AttendanceFormState};\nuse crate::api::{ApiClient, ApiError};\nuse crate::state::attendance::{\n    self as attendance_state, load_attendance_range, refresh_today_context, use_attendance,\n    AttendanceState, ClockEventKind, ClockEventPayload, ClockMessage,\n};\nuse crate::utils::time::today_in_app_tz;\nuse chrono::{Datelike, NaiveDate};\nuse leptos::{ev::MouseEvent, *};\nuse serde_json::Value;\n\n#[derive(Clone, Copy, PartialEq, Eq)]\npub struct HistoryQuery {\n    pub from: Option\u003cNaiveDate\u003e,\n    pub to: Option\u003cNaiveDate\u003e,\n    pub token: u32,\n}\n\nimpl HistoryQuery {\n    pub fn new(from: Option\u003cNaiveDate\u003e, to: Option\u003cNaiveDate\u003e) -\u003e Self {\n        Self { from, to, token: 0 }\n    }\n\n    pub fn with_range(self, from: Option\u003cNaiveDate\u003e, to: Option\u003cNaiveDate\u003e) -\u003e Self {\n        Self {\n            from,\n            to,\n            token: self.token.wrapping_add(1),\n        }\n    }\n}\n\n#[derive(Clone, Copy, PartialEq, Eq)]\npub struct HolidayQuery {\n    pub year: i32,\n    pub month: u32,\n    pub token: u32,\n}\n\nimpl HolidayQuery {\n    pub fn new(year: i32, month: u32) -\u003e Self {\n        Self {\n            year,\n            month,\n            token: 0,\n        }\n    }\n\n    pub fn with_period(self, year: i32, month: u32) -\u003e Self {\n        Self {\n            year,\n            month,\n            token: self.token.wrapping_add(1),\n        }\n    }\n\n    pub fn refresh(self) -\u003e Self {\n        Self {\n            year: self.year,\n            month: self.month,\n            token: self.token.wrapping_add(1),\n        }\n    }\n}\n\n#[derive(Clone, Default)]\npub struct ExportPayload {\n    pub from: Option\u003cString\u003e,\n    pub to: Option\u003cString\u003e,\n}\n\nimpl ExportPayload {\n    pub fn from_dates(from: Option\u003cNaiveDate\u003e, to: Option\u003cNaiveDate\u003e) -\u003e Self {\n        Self {\n            from: from.map(|date| date.format(\"%Y-%m-%d\").to_string()),\n            to: to.map(|date| date.format(\"%Y-%m-%d\").to_string()),\n        }\n    }\n}\n\n#[derive(Clone)]\npub struct AttendanceViewModel {\n    pub state: (ReadSignal\u003cAttendanceState\u003e, WriteSignal\u003cAttendanceState\u003e),\n    pub form_state: AttendanceFormState,\n    pub history_query: RwSignal\u003cHistoryQuery\u003e,\n    pub history_resource: Resource\u003cHistoryQuery, Result\u003c(), ApiError\u003e\u003e,\n    pub holiday_query: RwSignal\u003cHolidayQuery\u003e,\n    pub holiday_resource:\n        Resource\u003cHolidayQuery, Result\u003cVec\u003ccrate::api::HolidayCalendarEntry\u003e, ApiError\u003e\u003e,\n    pub context_resource: Resource\u003c(), Result\u003c(), ApiError\u003e\u003e,\n    pub export_action: Action\u003cExportPayload, Result\u003cValue, ApiError\u003e\u003e,\n    pub clock_action: Action\u003cClockEventPayload, Result\u003c(), ApiError\u003e\u003e,\n    pub clock_message: RwSignal\u003cOption\u003cClockMessage\u003e\u003e,\n    pub last_clock_event: RwSignal\u003cOption\u003cClockEventKind\u003e\u003e,\n    pub range_error: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub export_error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    pub export_success: RwSignal\u003cOption\u003cString\u003e\u003e,\n}\n\nimpl AttendanceViewModel {\n    pub fn new() -\u003e Self {\n        let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n        let (state, set_state) = use_attendance();\n        let initial_today = today_in_app_tz();\n\n        let form_state = AttendanceFormState::new();\n        form_state.set_range(initial_today, initial_today);\n\n        let api_clone = api.clone();\n        let export_action = create_action(move |payload: \u0026ExportPayload| {\n            let api = api_clone.clone();\n            let payload = payload.clone();\n            async move {\n                api.export_my_attendance_filtered(payload.from.as_deref(), payload.to.as_deref())\n                    .await\n            }\n        });\n\n        let history_query =\n            create_rw_signal(HistoryQuery::new(Some(initial_today), Some(initial_today)));\n        let api_for_history = api.clone();\n        let history_resource = create_resource(\n            move || history_query.get(),\n            move |query| {\n                let api = api_for_history.clone();\n                async move { load_attendance_range(\u0026api, set_state, query.from, query.to).await }\n            },\n        );\n\n        let holiday_query = create_rw_signal(HolidayQuery::new(\n            initial_today.year(),\n            initial_today.month(),\n        ));\n        let api_for_holiday = api.clone();\n        let holiday_resource = create_resource(\n            move || holiday_query.get(),\n            move |query| {\n                let api = api_for_holiday.clone();\n                async move { repository::fetch_monthly_holidays(\u0026api, query.year, query.month).await }\n            },\n        );\n\n        let api_for_context = api.clone();\n        let context_resource = create_resource(\n            || (),\n            move |_| {\n                let api = api_for_context.clone();\n                async move { refresh_today_context(\u0026api, set_state).await }\n            },\n        );\n\n        let api_for_clock = api.clone();\n        let clock_action = create_action(move |payload: \u0026ClockEventPayload| {\n            let api = api_for_clock.clone();\n            let set_attendance_state = set_state;\n            let payload = payload.clone();\n            async move {\n                match payload.kind {\n                    ClockEventKind::ClockIn =\u003e {\n                        attendance_state::clock_in(\u0026api, set_attendance_state).await?\n                    }\n                    ClockEventKind::ClockOut =\u003e {\n                        attendance_state::clock_out(\u0026api, set_attendance_state).await?\n                    }\n                    ClockEventKind::BreakStart =\u003e {\n                        let attendance_id = payload.attendance_id.as_deref().ok_or_else(|| {\n                            ApiError::validation(\"出勤レコードが見つかりません。\")\n                        })?;\n                        attendance_state::start_break(\u0026api, attendance_id).await?\n                    }\n                    ClockEventKind::BreakEnd =\u003e {\n                        let break_id = payload.break_id.as_deref().ok_or_else(|| {\n                            ApiError::validation(\"休憩レコードが見つかりません。\")\n                        })?;\n                        attendance_state::end_break(\u0026api, break_id).await?\n                    }\n                };\n                refresh_today_context(\u0026api, set_attendance_state).await\n            }\n        });\n\n        let clock_message = create_rw_signal(None);\n        let last_clock_event = create_rw_signal(None);\n        let range_error = create_rw_signal(None);\n        let export_error = create_rw_signal(None);\n        let export_success = create_rw_signal(None);\n\n        {\n            create_effect(move |_| {\n                if let Some(result) = clock_action.value().get() {\n                    match result {\n                        Ok(_) =\u003e {\n                            let success = match last_clock_event.get_untracked() {\n                                Some(ClockEventKind::ClockIn) =\u003e \"出勤しました。\",\n                                Some(ClockEventKind::BreakStart) =\u003e \"休憩を開始しました。\",\n                                Some(ClockEventKind::BreakEnd) =\u003e \"休憩を終了しました。\",\n                                Some(ClockEventKind::ClockOut) =\u003e \"退勤しました。\",\n                                None =\u003e \"操作が完了しました。\",\n                            };\n                            clock_message.set(Some(ClockMessage::Success(success.to_string())));\n                        }\n                        Err(err) =\u003e clock_message.set(Some(ClockMessage::Error(err))),\n                    }\n                }\n            });\n        }\n\n        {\n            create_effect(move |_| {\n                if let Some(result) = export_action.value().get() {\n                    match result {\n                        Ok(payload) =\u003e {\n                            let filename = payload\n                                .get(\"filename\")\n                                .and_then(|v| v.as_str())\n                                .unwrap_or(\"my_attendance.csv\");\n                            let csv = payload\n                                .get(\"csv_data\")\n                                .and_then(|v| v.as_str())\n                                .unwrap_or(\"\");\n                            match crate::utils::trigger_csv_download(filename, csv) {\n                                Ok(_) =\u003e {\n                                    export_success\n                                        .set(Some(format!(\"{filename} をダウンロードしました。\")));\n                                }\n                                Err(err) =\u003e {\n                                    export_error.set(Some(ApiError::unknown(format!(\n                                        \"CSVのダウンロードに失敗しました: {err}\"\n                                    ))));\n                                }\n                            }\n                        }\n                        Err(err) =\u003e export_error.set(Some(err)),\n                    }\n                }\n            });\n        }\n\n        Self {\n            state: (state, set_state),\n            form_state,\n            history_query,\n            history_resource,\n            holiday_query,\n            holiday_resource,\n            context_resource,\n            export_action,\n            clock_action,\n            clock_message,\n            last_clock_event,\n            range_error,\n            export_error,\n            export_success,\n        }\n    }\n\n    pub fn on_select_current_month(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let form_state = self.form_state.clone();\n        let history_query = self.history_query;\n        let holiday_query = self.holiday_query;\n        let range_error = self.range_error;\n        let export_error = self.export_error;\n        let export_success = self.export_success;\n\n        move |_ev| {\n            range_error.set(None);\n            export_error.set(None);\n            export_success.set(None);\n            let today = today_in_app_tz();\n            let Some((first_day, last_day)) = month_bounds(today) else {\n                return;\n            };\n            form_state.set_range(first_day, last_day);\n            history_query\n                .update(|query| *query = query.with_range(Some(first_day), Some(last_day)));\n            holiday_query.update(|query| {\n                *query = query.with_period(first_day.year(), first_day.month());\n            });\n        }\n    }\n\n    pub fn on_load_range(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let form_state = self.form_state.clone();\n        let history_query = self.history_query;\n        let holiday_query = self.holiday_query;\n        let range_error = self.range_error;\n        let export_error = self.export_error;\n        let export_success = self.export_success;\n\n        move |_ev| {\n            export_error.set(None);\n            export_success.set(None);\n            match form_state.to_payload() {\n                Ok((from, to)) =\u003e {\n                    range_error.set(None);\n                    history_query.update(|query| *query = query.with_range(from, to));\n                    if let Some(date) = from {\n                        holiday_query.update(|query| {\n                            *query = query.with_period(date.year(), date.month());\n                        });\n                    }\n                }\n                Err(err) =\u003e range_error.set(Some(err.error)),\n            }\n        }\n    }\n\n    pub fn on_export_csv(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let form_state = self.form_state.clone();\n        let export_action = self.export_action;\n        let export_error = self.export_error;\n        let export_success = self.export_success;\n\n        move |_ev| {\n            export_error.set(None);\n            export_success.set(None);\n            match form_state.to_payload() {\n                Ok((from, to)) =\u003e {\n                    let payload = ExportPayload::from_dates(from, to);\n                    export_action.dispatch(payload);\n                }\n                Err(err) =\u003e export_error.set(Some(err)),\n            }\n        }\n    }\n\n    pub fn on_refresh_holidays(\u0026self) -\u003e impl Fn(()) {\n        let holiday_query = self.holiday_query;\n        move |_| {\n            holiday_query.update(|query| {\n                *query = query.refresh();\n            })\n        }\n    }\n\n    pub fn handle_clock_in(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::ClockIn));\n            clock_action.dispatch(ClockEventPayload::clock_in());\n        }\n    }\n\n    pub fn handle_clock_out(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::ClockOut));\n            clock_action.dispatch(ClockEventPayload::clock_out());\n        }\n    }\n\n    pub fn handle_break_start(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        let (state, _) = self.state;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            let Some(status) = state.with(|s| s.today_status.clone()) else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"ステータスを取得できません。\",\n                ))));\n                return;\n            };\n            if status.status != \"clocked_in\" {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"出勤中のみ休憩を開始できます。\",\n                ))));\n                return;\n            }\n            let Some(att_id) = status.attendance_id.clone() else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"出勤レコードが見つかりません。\",\n                ))));\n                return;\n            };\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::BreakStart));\n            clock_action.dispatch(ClockEventPayload::break_start(att_id));\n        }\n    }\n\n    pub fn handle_break_end(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        let (state, _) = self.state;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            let Some(status) = state.with(|s| s.today_status.clone()) else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"ステータスを取得できません。\",\n                ))));\n                return;\n            };\n            if status.status != \"on_break\" {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"休憩中のみ休憩を終了できます。\",\n                ))));\n                return;\n            }\n            let Some(break_id) = status.active_break_id.clone() else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"休憩レコードが見つかりません。\",\n                ))));\n                return;\n            };\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::BreakEnd));\n            clock_action.dispatch(ClockEventPayload::break_end(break_id));\n        }\n    }\n}\n\npub fn use_attendance_view_model() -\u003e AttendanceViewModel {\n    match use_context::\u003cAttendanceViewModel\u003e() {\n        Some(vm) =\u003e vm,\n        None =\u003e {\n            let vm = AttendanceViewModel::new();\n            provide_context(vm.clone());\n            vm\n        }\n    }\n}\n\n#[cfg(all(test, target_arch = \"wasm32\"))]\nmod tests {\n    use super::*;\n    use leptos::create_runtime;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    fn with_runtime\u003cT\u003e(test: impl FnOnce() -\u003e T) -\u003e T {\n        let runtime = create_runtime();\n        let result = test();\n        runtime.dispose();\n        result\n    }\n\n    #[wasm_bindgen_test]\n    fn attendance_view_model_sets_up_context_refresh() {\n        with_runtime(|| {\n            let vm = AttendanceViewModel::new();\n            let _ = vm.context_resource.loading().get();\n        });\n    }\n}\n","traces":[{"line":451,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":452,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":453,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":454,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":455,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":5},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","components","activities.rs"],"content":"use crate::{\n    components::error::InlineErrorMessage,\n    components::layout::LoadingSpinner,\n    pages::dashboard::{repository::DashboardActivity, utils::ActivityStatusFilter},\n};\nuse leptos::*;\n\n#[component]\npub fn ActivitiesSection(\n    activities: Resource\u003c\n        ActivityStatusFilter,\n        Result\u003cVec\u003cDashboardActivity\u003e, crate::api::ApiError\u003e,\n    \u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv\u003e\n                \u003ch3 class=\"text-base font-semibold text-fg\"\u003e{\"申請・活動のサマリー\"}\u003c/h3\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"承認待ちの申請数や最新の状態を確認できます\"}\u003c/p\u003e\n            \u003c/div\u003e\n            {move || match activities.get() {\n                None =\u003e view! {\n                    \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                        \u003cLoadingSpinner /\u003e\n                        \u003cspan\u003e{\"最新の申請情報を読み込み中...\"}\u003c/span\u003e\n                    \u003c/div\u003e\n                }.into_view(),\n                Some(Err(err)) =\u003e {\n                    let error_signal = create_rw_signal(Some(err));\n                    view! { \u003cInlineErrorMessage error={error_signal.into()} /\u003e }.into_view()\n                }\n                Some(Ok(list)) =\u003e view! {\n                    \u003cul class=\"divide-y divide-border\"\u003e\n                        \u003cFor\n                            each=move || list.clone()\n                            key=|item| item.title.clone()\n                            children=move |item: DashboardActivity| {\n                                view! {\n                                    \u003cli class=\"py-2 flex items-center justify-between text-sm text-fg\"\u003e\n                                        \u003cspan\u003e{item.title}\u003c/span\u003e\n                                        \u003cspan class=\"text-fg-muted\"\u003e{item.detail.unwrap_or_else(|| \"-\".into())}\u003c/span\u003e\n                                    \u003c/li\u003e\n                                }\n                            }\n                        /\u003e\n                    \u003c/ul\u003e\n                }.into_view(),\n            }}\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","components","alerts.rs"],"content":"use crate::{\n    components::error::InlineErrorMessage,\n    components::layout::LoadingSpinner,\n    pages::dashboard::repository::{DashboardAlert, DashboardAlertLevel, DashboardSummary},\n};\nuse leptos::*;\n\ntype AlertsResource = Resource\u003c\n    Option\u003cResult\u003cDashboardSummary, crate::api::ApiError\u003e\u003e,\n    Result\u003cVec\u003cDashboardAlert\u003e, crate::api::ApiError\u003e,\n\u003e;\n\n#[component]\npub fn AlertsSection(alerts: AlertsResource) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv class=\"flex flex-col gap-2\"\u003e\n                \u003ch3 class=\"text-base font-semibold text-fg\"\u003e{\"アラート\"}\u003c/h3\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"勤務や申請に関する注意事項\"}\u003c/p\u003e\n            \u003c/div\u003e\n            {move || match alerts.get() {\n                None =\u003e view! {\n                    \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                        \u003cLoadingSpinner /\u003e\n                        \u003cspan\u003e{\"アラート情報を読み込み中...\"}\u003c/span\u003e\n                    \u003c/div\u003e\n                }.into_view(),\n                Some(Err(err)) =\u003e {\n                    let error_signal = create_rw_signal(Some(err));\n                    view! { \u003cInlineErrorMessage error={error_signal.into()} /\u003e }.into_view()\n                }\n                Some(Ok(list)) =\u003e view! {\n                    \u003cul class=\"space-y-2\"\u003e\n                        \u003cFor\n                            each=move || list.clone()\n                            key=|alert| alert.message.clone()\n                            children=move |alert: DashboardAlert| {\n                                let badge = render_badge(\u0026alert.level);\n                                view! {\n                                    \u003cli class=\"flex items-start gap-2 text-sm text-fg\"\u003e\n                                        {badge}\n                                        \u003cspan\u003e{alert.message}\u003c/span\u003e\n                                    \u003c/li\u003e\n                                }\n                            }\n                        /\u003e\n                    \u003c/ul\u003e\n                }.into_view(),\n            }}\n        \u003c/div\u003e\n    }\n}\n\nfn render_badge(level: \u0026DashboardAlertLevel) -\u003e View {\n    let (color, text) = match level {\n        DashboardAlertLevel::Info =\u003e (\"bg-status-info-bg text-status-info-text\", \"INFO\"),\n        DashboardAlertLevel::Warning =\u003e (\"bg-status-warning-bg text-status-warning-text\", \"WARN\"),\n        DashboardAlertLevel::Error =\u003e (\"bg-status-error-bg text-status-error-text\", \"ERROR\"),\n    };\n    view! {\n        \u003cspan class=format!(\"px-2 py-0.5 rounded-full text-xs font-semibold {}\", color)\u003e\n            {text}\n        \u003c/span\u003e\n    }\n    .into_view()\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","components","clock.rs"],"content":"use gloo_timers::callback::Interval;\nuse leptos::*;\n\nuse crate::utils::time::now_in_app_tz;\n\n#[component]\npub fn Clock() -\u003e impl IntoView {\n    let (time, set_time) = create_signal(now_in_app_tz());\n\n    // Update time every second\n    // We use store_value to keep the Interval alive. It will be dropped (and cancelled) when the component is unmounted.\n    let _interval = store_value(Interval::new(1000, move || {\n        set_time.set(now_in_app_tz());\n    }));\n\n    // Format date: \"2024年12月30日(月)\"\n    let date_str = move || {\n        let t = time.get();\n        // Custom formatting for Japanese locale-like output if needed, or use chrono's formatting\n        // %Y年%m月%d日(%a) w/ locale if possible, but chrono's localized formatting might need feature flags\n        // For simplicity and robustness, specific format:\n        format!(\"{}\", t.format(\"%Y年%m月%d日\"))\n    };\n\n    // Day of week in Japanese\n    let weekday_str = move || {\n        let t = time.get();\n        match t.format(\"%A\").to_string().as_str() {\n            \"Monday\" =\u003e \"(月)\",\n            \"Tuesday\" =\u003e \"(火)\",\n            \"Wednesday\" =\u003e \"(水)\",\n            \"Thursday\" =\u003e \"(木)\",\n            \"Friday\" =\u003e \"(金)\",\n            \"Saturday\" =\u003e \"(土)\",\n            \"Sunday\" =\u003e \"(日)\",\n            _ =\u003e \"\",\n        }\n    };\n\n    // Format time: \"12:34:56\"\n    let time_str = move || time.get().format(\"%H:%M:%S\").to_string();\n\n    view! {\n        \u003cdiv class=\"bg-gradient-to-br from-action-primary-bg to-action-primary-bg-hover text-text-inverse border-none shadow-lg rounded-lg overflow-hidden\"\u003e\n            \u003cdiv class=\"flex flex-col items-center justify-center py-4 space-y-2\"\u003e\n                \u003cdiv class=\"text-lg font-medium opacity-90\"\u003e\n                    {date_str} \u003cspan class=\"ml-1\"\u003e{weekday_str}\u003c/span\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"text-4xl font-bold tracking-wider font-mono\"\u003e\n                    {time_str}\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","components","global_filters.rs"],"content":"use crate::pages::dashboard::utils::ActivityStatusFilter;\nuse leptos::*;\nuse wasm_bindgen::JsCast;\n\n#[component]\npub fn GlobalFilters(filter: RwSignal\u003cActivityStatusFilter\u003e) -\u003e impl IntoView {\n    let on_change = move |ev: web_sys::Event| {\n        if let Some(target) = ev\n            .target()\n            .and_then(|t| t.dyn_into::\u003cweb_sys::HtmlSelectElement\u003e().ok())\n        {\n            let next = ActivityStatusFilter::from_str(\u0026target.value());\n            filter.set(next);\n        }\n    };\n\n    view! {\n        \u003cdiv class=\"flex items-center gap-3 text-sm text-fg bg-surface-elevated border border-border rounded-lg px-4 py-2 shadow-sm\"\u003e\n            \u003cspan class=\"font-medium text-fg\"\u003e{\"フィルター\"}\u003c/span\u003e\n            \u003clabel class=\"flex items-center gap-2\"\u003e\n                \u003cspan class=\"text-fg-muted\"\u003e{\"申請ステータス\"}\u003c/span\u003e\n                \u003cselect\n                    class=\"border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1 text-sm\"\n                    on:change=on_change\n                    prop:value={move || filter.get().as_value().to_string()}\n                \u003e\n                    \u003coption value=\"all\"\u003e{\"すべて\"}\u003c/option\u003e\n                    \u003coption value=\"pending\"\u003e{\"承認待ちのみ\"}\u003c/option\u003e\n                    \u003coption value=\"approved\"\u003e{\"承認済みのみ\"}\u003c/option\u003e\n                \u003c/select\u003e\n            \u003c/label\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","components","mod.rs"],"content":"pub mod activities;\npub mod alerts;\npub mod global_filters;\npub mod summary;\n\nmod clock;\n\npub use activities::ActivitiesSection;\npub use alerts::AlertsSection;\npub use clock::Clock;\npub use global_filters::GlobalFilters;\npub use summary::SummarySection;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","components","summary.rs"],"content":"use crate::{\n    components::error::InlineErrorMessage,\n    components::layout::LoadingSpinner,\n    pages::dashboard::{\n        repository::DashboardSummary,\n        utils::{format_days, format_hours},\n    },\n};\nuse leptos::*;\n\n#[component]\npub fn SummarySection(\n    summary: Resource\u003c(), Result\u003cDashboardSummary, crate::api::ApiError\u003e\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv\u003e\n                \u003ch3 class=\"text-base font-semibold text-fg\"\u003e{\"勤務サマリー\"}\u003c/h3\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"今月の勤務時間と日数のスナップショット\"}\u003c/p\u003e\n            \u003c/div\u003e\n            \u003cdiv\u003e\n                {move || match summary.get() {\n                    None =\u003e view! {\n                        \u003cdiv class=\"flex items-center gap-2 text-sm text-fg-muted\"\u003e\n                            \u003cLoadingSpinner /\u003e\n                            \u003cspan\u003e{\"勤怠サマリーを読み込み中...\"}\u003c/span\u003e\n                        \u003c/div\u003e\n                    }.into_view(),\n                    Some(Err(err)) =\u003e {\n                        let error_signal = create_rw_signal(Some(err));\n                        view! { \u003cInlineErrorMessage error={error_signal.into()} /\u003e }.into_view()\n                    }\n                    Some(Ok(data)) =\u003e view! {\n                        \u003cdiv class=\"grid grid-cols-1 gap-4 lg:grid-cols-3\"\u003e\n                            \u003cMetric label=\"総労働時間\".to_string() value={format_hours(data.total_work_hours)} /\u003e\n                            \u003cMetric label=\"勤務日数\".to_string() value={format_days(data.total_work_days)} /\u003e\n                            \u003cMetric label=\"平均日次労働時間\".to_string() value={format_hours(data.average_daily_hours)} /\u003e\n                        \u003c/div\u003e\n                    }.into_view(),\n                }}\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n\n#[component]\nfn Metric(label: String, value: String) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"relative overflow-hidden p-6 rounded-2xl bg-surface-elevated border border-border shadow-premium hover:shadow-premium-hover transition-all duration-300 group\"\u003e\n            \u003cdiv class=\"absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-primary-subtle rounded-full opacity-50 group-hover:scale-110 transition-transform\"\u003e\u003c/div\u003e\n            \u003cp class=\"relative z-10 text-xs font-display font-bold text-action-primary-bg uppercase tracking-widest\"\u003e{label}\u003c/p\u003e\n            \u003cp class=\"relative z-10 mt-3 text-3xl font-display font-extrabold text-fg\"\u003e{value}\u003c/p\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","layout.rs"],"content":"use crate::components::layout::Layout;\nuse leptos::*;\n\n#[component]\npub fn DashboardFrame(children: Children) -\u003e impl IntoView {\n    view! { \u003cLayout\u003e{children()}\u003c/Layout\u003e }\n}\n\n#[component]\npub fn UnauthorizedMessage() -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 text-center\"\u003e\n            \u003cp class=\"text-sm text-fg\"\u003e{\"このページにアクセスするには権限が必要です。管理者にお問い合わせください。\"}\u003c/p\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","mod.rs"],"content":"pub mod components;\npub mod layout;\npub mod panel;\npub mod repository;\npub mod utils;\npub mod view_model;\n\npub use panel::DashboardPage;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","panel.rs"],"content":"use crate::components::forms::AttendanceActionButtons;\nuse crate::pages::dashboard::{\n    components::{ActivitiesSection, AlertsSection, Clock, GlobalFilters, SummarySection},\n    layout::DashboardFrame,\n    view_model::use_dashboard_view_model,\n};\nuse leptos::*;\n\n#[component]\npub fn DashboardPage() -\u003e impl IntoView {\n    let vm = use_dashboard_view_model();\n    let (attendance_state, _) = vm.attendance_state;\n\n    view! {\n        \u003cDashboardFrame\u003e\n            \u003cdiv class=\"grid grid-cols-1 lg:grid-cols-3 gap-6\"\u003e\n                \u003cdiv class=\"lg:col-span-2 space-y-6\"\u003e\n                    \u003cSummarySection summary={vm.summary_resource} /\u003e\n                    \u003cAlertsSection alerts={vm.alerts_resource} /\u003e\n                    \u003cdiv class=\"space-y-4\"\u003e\n                        \u003cGlobalFilters filter={vm.activity_filter} /\u003e\n                        \u003cActivitiesSection activities={vm.activities_resource} /\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"space-y-6\"\u003e\n                    \u003cClock /\u003e\n                    \u003cAttendanceActionButtons\n                        attendance_state=attendance_state\n                        action_pending={vm.clock_action.pending()}\n                        message={vm.clock_message.read_only()}\n                        on_clock_in={Callback::new(vm.handle_clock_in())}\n                        on_clock_out={Callback::new(vm.handle_clock_out())}\n                        on_break_start={Callback::new(vm.handle_break_start())}\n                        on_break_end={Callback::new(vm.handle_break_end())}\n                    /\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/DashboardFrame\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","repository.rs"],"content":"use crate::api::{ApiClient, ApiError, AttendanceSummary};\nuse crate::pages::dashboard::utils::{current_year_month, ActivityStatusFilter};\nuse crate::pages::requests::repository::RequestsRepository;\nuse crate::pages::requests::types::{flatten_requests, RequestKind, RequestSummary};\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]\npub struct DashboardSummary {\n    pub total_work_hours: Option\u003cf64\u003e,\n    pub total_work_days: Option\u003ci32\u003e,\n    pub average_daily_hours: Option\u003cf64\u003e,\n}\n\n#[derive(Clone, Debug, PartialEq, Eq, Serialize, Deserialize)]\npub enum DashboardAlertLevel {\n    Info,\n    Warning,\n    Error,\n}\n\n#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]\npub struct DashboardAlert {\n    pub level: DashboardAlertLevel,\n    pub message: String,\n}\n\n#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]\npub struct DashboardActivity {\n    pub title: String,\n    pub detail: Option\u003cString\u003e,\n}\n\npub async fn fetch_summary(api: \u0026ApiClient) -\u003e Result\u003cDashboardSummary, ApiError\u003e {\n    let (y, m) = current_year_month();\n    let summary: AttendanceSummary = api.get_my_summary(Some(y), Some(m)).await?;\n    Ok(DashboardSummary {\n        total_work_hours: Some(summary.total_work_hours),\n        total_work_days: Some(summary.total_work_days),\n        average_daily_hours: Some(summary.average_daily_hours),\n    })\n}\n\npub fn build_alerts(summary: \u0026DashboardSummary) -\u003e Vec\u003cDashboardAlert\u003e {\n    let mut alerts = Vec::new();\n\n    if summary.total_work_days.unwrap_or_default() == 0 {\n        alerts.push(DashboardAlert {\n            level: DashboardAlertLevel::Warning,\n            message: \"今月の勤怠が未登録です。出勤打刻を確認してください。\".into(),\n        });\n    }\n\n    if alerts.is_empty() {\n        alerts.push(DashboardAlert {\n            level: DashboardAlertLevel::Info,\n            message: \"新しいアラートはありません。\".into(),\n        });\n    }\n\n    alerts\n}\n\npub async fn fetch_recent_activities(\n    api: \u0026ApiClient,\n    filter: ActivityStatusFilter,\n) -\u003e Result\u003cVec\u003cDashboardActivity\u003e, ApiError\u003e {\n    let repo = RequestsRepository::new(api.clone());\n    let response = repo.list_my_requests().await?;\n    let summaries = flatten_requests(\u0026response);\n\n    let leave_pending = count_by(\u0026summaries, RequestKind::Leave, \"pending\");\n    let overtime_pending = count_by(\u0026summaries, RequestKind::Overtime, \"pending\");\n    let leave_approved = count_by(\u0026summaries, RequestKind::Leave, \"approved\");\n    let overtime_approved = count_by(\u0026summaries, RequestKind::Overtime, \"approved\");\n\n    let activities = vec![\n        DashboardActivity {\n            title: \"休暇申請（承認待ち）\".into(),\n            detail: Some(format!(\"{leave_pending} 件\")),\n        },\n        DashboardActivity {\n            title: \"残業申請（承認待ち）\".into(),\n            detail: Some(format!(\"{overtime_pending} 件\")),\n        },\n        DashboardActivity {\n            title: \"休暇申請（承認済み）\".into(),\n            detail: Some(format!(\"{leave_approved} 件\")),\n        },\n        DashboardActivity {\n            title: \"残業申請（承認済み）\".into(),\n            detail: Some(format!(\"{overtime_approved} 件\")),\n        },\n    ];\n\n    let filtered = match filter {\n        ActivityStatusFilter::All =\u003e activities,\n        ActivityStatusFilter::PendingOnly =\u003e activities.into_iter().take(2).collect(),\n        ActivityStatusFilter::ApprovedOnly =\u003e activities.into_iter().skip(2).collect(),\n    };\n\n    Ok(filtered)\n}\n\nfn count_by(summaries: \u0026[RequestSummary], kind: RequestKind, status: \u0026str) -\u003e i32 {\n    summaries\n        .iter()\n        .filter(|s| s.kind == kind \u0026\u0026 s.status == status)\n        .count() as i32\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn alerts_warn_when_no_workdays() {\n        let summary = DashboardSummary {\n            total_work_hours: Some(0.0),\n            total_work_days: Some(0),\n            average_daily_hours: None,\n        };\n        let alerts = build_alerts(\u0026summary);\n        assert!(alerts\n            .iter()\n            .any(|a| matches!(a.level, DashboardAlertLevel::Warning)));\n    }\n\n    #[test]\n    fn count_handles_missing_kind() {\n        let empty: crate::pages::requests::types::MyRequestsResponse = Default::default();\n        let summaries = flatten_requests(\u0026empty);\n        assert_eq!(count_by(\u0026summaries, RequestKind::Leave, \"pending\"), 0);\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","utils.rs"],"content":"use crate::utils::time::now_in_app_tz;\nuse chrono::Datelike;\n\npub fn current_year_month() -\u003e (i32, u32) {\n    let now = now_in_app_tz();\n    (now.year(), now.month())\n}\n\npub fn format_hours(hours: Option\u003cf64\u003e) -\u003e String {\n    hours\n        .map(|h| format!(\"{:.2}時間\", h))\n        .unwrap_or_else(|| \"-\".into())\n}\n\npub fn format_days(days: Option\u003ci32\u003e) -\u003e String {\n    days.map(|d| format!(\"{d} 日\"))\n        .unwrap_or_else(|| \"-\".into())\n}\n\n#[derive(Clone, Copy, Debug, PartialEq, Eq)]\npub enum ActivityStatusFilter {\n    All,\n    PendingOnly,\n    ApprovedOnly,\n}\n\nimpl ActivityStatusFilter {\n    pub fn from_str(value: \u0026str) -\u003e Self {\n        match value {\n            \"pending\" =\u003e ActivityStatusFilter::PendingOnly,\n            \"approved\" =\u003e ActivityStatusFilter::ApprovedOnly,\n            _ =\u003e ActivityStatusFilter::All,\n        }\n    }\n\n    pub fn as_value(self) -\u003e \u0026'static str {\n        match self {\n            ActivityStatusFilter::All =\u003e \"all\",\n            ActivityStatusFilter::PendingOnly =\u003e \"pending\",\n            ActivityStatusFilter::ApprovedOnly =\u003e \"approved\",\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn formats_hours_with_two_decimals() {\n        assert_eq!(format_hours(Some(12.3456)), \"12.35時間\");\n        assert_eq!(format_hours(Some(0.0)), \"0.00時間\");\n        assert_eq!(format_hours(None), \"-\");\n    }\n\n    #[test]\n    fn formats_days_with_suffix() {\n        assert_eq!(format_days(Some(5)), \"5 日\");\n        assert_eq!(format_days(None), \"-\");\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","dashboard","view_model.rs"],"content":"use crate::api::{ApiClient, ApiError};\nuse crate::pages::dashboard::{repository, utils::ActivityStatusFilter};\nuse crate::state::attendance::{\n    self as attendance_state, refresh_today_context, use_attendance, AttendanceState,\n    ClockEventKind, ClockEventPayload, ClockMessage,\n};\nuse leptos::{ev::MouseEvent, *};\n\n#[derive(Clone, Copy)]\npub struct DashboardViewModel {\n    pub summary_resource: Resource\u003c(), Result\u003crepository::DashboardSummary, ApiError\u003e\u003e,\n    pub alerts_resource: Resource\u003c\n        Option\u003cResult\u003crepository::DashboardSummary, ApiError\u003e\u003e,\n        Result\u003cVec\u003crepository::DashboardAlert\u003e, ApiError\u003e,\n    \u003e,\n    pub activities_resource:\n        Resource\u003cActivityStatusFilter, Result\u003cVec\u003crepository::DashboardActivity\u003e, ApiError\u003e\u003e,\n    pub activity_filter: RwSignal\u003cActivityStatusFilter\u003e,\n    pub attendance_state: (ReadSignal\u003cAttendanceState\u003e, WriteSignal\u003cAttendanceState\u003e),\n    pub clock_action: Action\u003cClockEventPayload, Result\u003c(), ApiError\u003e\u003e,\n    pub clock_message: RwSignal\u003cOption\u003cClockMessage\u003e\u003e,\n    pub last_clock_event: RwSignal\u003cOption\u003cClockEventKind\u003e\u003e,\n}\n\nimpl DashboardViewModel {\n    pub fn new() -\u003e Self {\n        let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n        let (attendance_read, attendance_write) = use_attendance();\n\n        let api_clone = api.clone();\n        let summary_resource = create_resource(\n            || (),\n            move |_| {\n                let api = api_clone.clone();\n                async move { repository::fetch_summary(\u0026api).await }\n            },\n        );\n\n        let alerts_resource = create_resource(\n            move || summary_resource.get(),\n            move |summary_opt| async move {\n                if let Some(Ok(summary)) = summary_opt {\n                    Ok(repository::build_alerts(\u0026summary))\n                } else {\n                    Ok(Vec::new())\n                }\n            },\n        );\n\n        let activity_filter = create_rw_signal(ActivityStatusFilter::All);\n        let api_clone = api.clone();\n        let activities_resource = create_resource(\n            move || activity_filter.get(),\n            move |filter| {\n                let api = api_clone.clone();\n                async move { repository::fetch_recent_activities(\u0026api, filter).await }\n            },\n        );\n\n        let api_clone = api.clone();\n        let clock_action = create_action(move |payload: \u0026ClockEventPayload| {\n            let api = api_clone.clone();\n            let set_attendance_state = attendance_write;\n            let payload = payload.clone();\n            async move {\n                match payload.kind {\n                    ClockEventKind::ClockIn =\u003e {\n                        attendance_state::clock_in(\u0026api, set_attendance_state).await?\n                    }\n                    ClockEventKind::ClockOut =\u003e {\n                        attendance_state::clock_out(\u0026api, set_attendance_state).await?\n                    }\n                    ClockEventKind::BreakStart =\u003e {\n                        let attendance_id = payload\n                            .attendance_id\n                            .as_deref()\n                            .ok_or_else(|| ApiError::unknown(\"出勤レコードが見つかりません。\"))?;\n                        attendance_state::start_break(\u0026api, attendance_id).await?\n                    }\n                    ClockEventKind::BreakEnd =\u003e {\n                        let break_id = payload\n                            .break_id\n                            .as_deref()\n                            .ok_or_else(|| ApiError::unknown(\"休憩レコードが見つかりません。\"))?;\n                        attendance_state::end_break(\u0026api, break_id).await?\n                    }\n                };\n                attendance_state::refresh_today_context(\u0026api, set_attendance_state).await\n            }\n        });\n\n        let clock_message = create_rw_signal(None);\n        let last_clock_event = create_rw_signal(None);\n\n        {\n            create_effect(move |_| {\n                if let Some(result) = clock_action.value().get() {\n                    match result {\n                        Ok(_) =\u003e {\n                            let success = match last_clock_event.get_untracked() {\n                                Some(ClockEventKind::ClockIn) =\u003e \"出勤しました。\",\n                                Some(ClockEventKind::BreakStart) =\u003e \"休憩を開始しました。\",\n                                Some(ClockEventKind::BreakEnd) =\u003e \"休憩を終了しました。\",\n                                Some(ClockEventKind::ClockOut) =\u003e \"退勤しました。\",\n                                None =\u003e \"操作が完了しました。\",\n                            };\n                            clock_message.set(Some(ClockMessage::Success(success.to_string())));\n                        }\n                        Err(err) =\u003e clock_message.set(Some(ClockMessage::Error(err))),\n                    }\n                }\n            });\n        }\n\n        {\n            let api = api.clone();\n            create_effect(move |_| {\n                let api = api.clone();\n                spawn_local(async move {\n                    let _ = refresh_today_context(\u0026api, attendance_write).await;\n                });\n            });\n        }\n\n        Self {\n            summary_resource,\n            alerts_resource,\n            activities_resource,\n            activity_filter,\n            attendance_state: (attendance_read, attendance_write),\n            clock_action,\n            clock_message,\n            last_clock_event,\n        }\n    }\n\n    pub fn handle_clock_in(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::ClockIn));\n            clock_action.dispatch(ClockEventPayload::clock_in());\n        }\n    }\n\n    pub fn handle_clock_out(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::ClockOut));\n            clock_action.dispatch(ClockEventPayload::clock_out());\n        }\n    }\n\n    pub fn handle_break_start(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        let (state, _) = self.attendance_state;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            let Some(status) = state.get().today_status.clone() else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"ステータスを取得できません。\",\n                ))));\n                return;\n            };\n            if status.status != \"clocked_in\" {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"出勤中のみ休憩を開始できます。\",\n                ))));\n                return;\n            }\n            let Some(att_id) = status.attendance_id.clone() else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"出勤レコードが見つかりません。\",\n                ))));\n                return;\n            };\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::BreakStart));\n            clock_action.dispatch(ClockEventPayload::break_start(att_id));\n        }\n    }\n\n    pub fn handle_break_end(\u0026self) -\u003e impl Fn(MouseEvent) {\n        let clock_action = self.clock_action;\n        let clock_message = self.clock_message;\n        let last_event = self.last_clock_event;\n        let (state, _) = self.attendance_state;\n        move |_| {\n            if clock_action.pending().get_untracked() {\n                return;\n            }\n            let Some(status) = state.get().today_status.clone() else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"ステータスを取得できません。\",\n                ))));\n                return;\n            };\n            if status.status != \"on_break\" {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"休憩中のみ休憩を終了できます。\",\n                ))));\n                return;\n            }\n            let Some(break_id) = status.active_break_id.clone() else {\n                clock_message.set(Some(ClockMessage::Error(ApiError::validation(\n                    \"休憩レコードが見つかりません。\",\n                ))));\n                return;\n            };\n            clock_message.set(None);\n            last_event.set(Some(ClockEventKind::BreakEnd));\n            clock_action.dispatch(ClockEventPayload::break_end(break_id));\n        }\n    }\n}\n\npub fn use_dashboard_view_model() -\u003e DashboardViewModel {\n    match use_context::\u003cDashboardViewModel\u003e() {\n        Some(vm) =\u003e vm,\n        None =\u003e {\n            let vm = DashboardViewModel::new();\n            provide_context(vm.clone());\n            vm\n        }\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","forgot_password","mod.rs"],"content":"use leptos::*;\n\nmod panel;\nmod repository;\nmod view_model;\n\npub use panel::ForgotPasswordPanel;\n\n#[component]\npub fn ForgotPasswordPage() -\u003e impl IntoView {\n    view! { \u003cForgotPasswordPanel /\u003e }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","forgot_password","panel.rs"],"content":"use super::view_model::use_forgot_password_view_model;\nuse leptos::*;\nuse leptos_router::*;\n\n#[component]\npub fn ForgotPasswordPanel() -\u003e impl IntoView {\n    let vm = use_forgot_password_view_model();\n    let email = vm.email;\n    let error = vm.error;\n    let success = vm.success;\n    let submit_action = vm.submit_action;\n\n    let pending = submit_action.pending();\n\n    view! {\n        \u003cdiv class=\"min-h-screen flex items-center justify-center bg-surface py-12 px-4 sm:px-6 lg:px-8\"\u003e\n            \u003cdiv class=\"max-w-md w-full space-y-8\"\u003e\n                \u003cdiv\u003e\n                    \u003ch2 class=\"mt-6 text-center text-3xl font-extrabold text-fg\"\u003e\n                        \"Reset your password\"\n                    \u003c/h2\u003e\n                    \u003cp class=\"mt-2 text-center text-sm text-fg-muted\"\u003e\n                        \"Enter your email address and we'll send you a link to reset your password.\"\n                    \u003c/p\u003e\n                \u003c/div\u003e\n\n                {move || {\n                    if let Some(msg) = success.get() {\n                        view! {\n                            \u003cdiv class=\"rounded-md bg-status-success-bg p-4 text-status-success-text\"\u003e\n                                \u003cdiv class=\"flex\"\u003e\n                                    \u003cdiv class=\"flex-shrink-0\"\u003e\n                                        \u003csvg\n                                            class=\"h-5 w-5 text-status-success-text\"\n                                            viewBox=\"0 0 20 20\"\n                                            fill=\"currentColor\"\n                                        \u003e\n                                            \u003cpath\n                                                fill-rule=\"evenodd\"\n                                                d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\"\n                                                clip-rule=\"evenodd\"\n                                            \u003e\u003c/path\u003e\n                                        \u003c/svg\u003e\n                                    \u003c/div\u003e\n                                    \u003cdiv class=\"ml-3\"\u003e\n                                        \u003ch3 class=\"text-sm font-medium text-status-success-text\"\u003e{msg}\u003c/h3\u003e\n                                        \u003cdiv class=\"mt-2 text-sm text-status-success-text\"\u003e\n                                            \u003cp\u003e\"Check your email for the reset link.\"\u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv class=\"mt-4\"\u003e\n                                            \u003cdiv class=\"-mx-2 -my-1.5 flex\"\u003e\n                                                \u003cA\n                                                    href=\"/login\"\n                                                    class=\"px-2 py-1.5 rounded-md text-sm font-medium text-status-success-text hover:bg-status-success-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-status-success-bg focus:ring-status-success-border\"\n                                                \u003e\n                                                    \"Back to login\"\n                                                \u003c/A\u003e\n                                            \u003c/div\u003e\n                                        \u003c/div\u003e\n                                    \u003c/div\u003e\n                                \u003c/div\u003e\n                            \u003c/div\u003e\n                        }\n                            .into_view()\n                    } else {\n                        view! {\n                            \u003cform\n                                class=\"mt-8 space-y-6\"\n                                on:submit=move |ev| {\n                                    ev.prevent_default();\n                                    submit_action.dispatch(email.get());\n                                }\n                            \u003e\n                                \u003cdiv class=\"rounded-md shadow-sm -space-y-px\"\u003e\n                                    \u003cdiv\u003e\n                                        \u003clabel for=\"email-address\" class=\"sr-only\"\u003e\n                                            \"Email address\"\n                                        \u003c/label\u003e\n                                        \u003cinput\n                                            id=\"email-address\"\n                                            name=\"email\"\n                                            type=\"email\"\n                                            autocomplete=\"email\"\n                                            required\n                                            class=\"appearance-none rounded-md relative block w-full px-3 py-2 border border-form-control-border bg-form-control-bg placeholder-form-control-placeholder text-form-control-text focus:outline-none focus:ring-2 focus:ring-action-primary-focus focus:border-action-primary-border focus:z-10 sm:text-sm\"\n                                            placeholder=\"Email address\"\n                                            prop:value=email\n                                            on:input=move |ev| {\n                                                email.set(event_target_value(\u0026ev));\n                                            }\n                                        /\u003e\n                                    \u003c/div\u003e\n                                \u003c/div\u003e\n\n                                {move || {\n                                    if let Some(err) = error.get() {\n                                        view! {\n                                            \u003cdiv class=\"rounded-md bg-status-error-bg p-4 text-status-error-text\"\u003e\n                                                \u003cdiv class=\"flex\"\u003e\n                                                    \u003cdiv class=\"ml-3\"\u003e\n                                                        \u003ch3 class=\"text-sm font-medium text-status-error-text\"\u003e\n                                                            \"Error\"\n                                                        \u003c/h3\u003e\n                                                        \u003cdiv class=\"mt-2 text-sm text-status-error-text\"\u003e\n                                                            \u003cp\u003e{err}\u003c/p\u003e\n                                                        \u003c/div\u003e\n                                                    \u003c/div\u003e\n                                                \u003c/div\u003e\n                                            \u003c/div\u003e\n                                        }\n                                            .into_view()\n                                    } else {\n                                        view! {}.into_view()\n                                    }\n                                }}\n\n                                \u003cdiv\u003e\n                                    \u003cbutton\n                                        type=\"submit\"\n                                        disabled=move || pending.get()\n                                        class=\"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-action-primary-text bg-action-primary-bg hover:bg-action-primary-bg-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-action-primary-focus disabled:opacity-50\"\n                                    \u003e\n                                        \u003cspan class=\"absolute left-0 inset-y-0 flex items-center pl-3\"\u003e\n                                            \u003csvg\n                                                class=\"h-5 w-5 text-action-primary-text/70 group-hover:text-action-primary-text\"\n                                                xmlns=\"http://www.w3.org/2000/svg\"\n                                                viewBox=\"0 0 20 20\"\n                                                fill=\"currentColor\"\n                                                aria-hidden=\"true\"\n                                            \u003e\n                                                \u003cpath\n                                                    fill-rule=\"evenodd\"\n                                                    d=\"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z\"\n                                                    clip-rule=\"evenodd\"\n                                                \u003e\u003c/path\u003e\n                                            \u003c/svg\u003e\n                                        \u003c/span\u003e\n                                        {move || {\n                                            if pending.get() { \"Sending...\" } else { \"Send Reset Link\" }\n                                        }}\n\n                                    \u003c/button\u003e\n                                \u003c/div\u003e\n\n                                \u003cdiv class=\"text-sm text-center\"\u003e\n                                    \u003cA\n                                        href=\"/login\"\n                                        class=\"font-medium text-link hover:text-link-hover\"\n                                    \u003e\n                                        \"Back to login\"\n                                    \u003c/A\u003e\n                                \u003c/div\u003e\n                            \u003c/form\u003e\n                        }\n                            .into_view()\n                    }\n                }}\n\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","forgot_password","repository.rs"],"content":"use crate::api::{ApiClient, ApiError, MessageResponse};\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct ForgotPasswordRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl ForgotPasswordRepository {\n    pub fn new_with_client(client: Rc\u003cApiClient\u003e) -\u003e Self {\n        Self { client }\n    }\n\n    pub async fn request_reset(\u0026self, email: String) -\u003e Result\u003cMessageResponse, ApiError\u003e {\n        self.client.request_password_reset(email).await\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","forgot_password","view_model.rs"],"content":"use super::repository::ForgotPasswordRepository;\nuse crate::api::{ApiClient, ApiError, MessageResponse};\nuse leptos::*;\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct ForgotPasswordViewModel {\n    pub email: RwSignal\u003cString\u003e,\n    pub error: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub success: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub submit_action: Action\u003cString, Result\u003cMessageResponse, ApiError\u003e\u003e,\n}\n\npub fn use_forgot_password_view_model() -\u003e ForgotPasswordViewModel {\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repository = ForgotPasswordRepository::new_with_client(Rc::new(api));\n\n    let email = create_rw_signal(String::new());\n    let error = create_rw_signal(None);\n    let success = create_rw_signal(None);\n\n    let repo_for_submit = repository.clone();\n    let submit_action = create_action(move |value: \u0026String| {\n        let repo = repo_for_submit.clone();\n        let value = value.clone();\n        async move {\n            let email = normalize_email(\u0026value)?;\n            repo.request_reset(email).await\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = submit_action.value().get() {\n            match result {\n                Ok(resp) =\u003e {\n                    success.set(Some(resp.message));\n                    error.set(None);\n                }\n                Err(err) =\u003e {\n                    error.set(Some(err.to_string()));\n                    success.set(None);\n                }\n            }\n        }\n    });\n\n    ForgotPasswordViewModel {\n        email,\n        error,\n        success,\n        submit_action,\n    }\n}\n\nfn normalize_email(value: \u0026str) -\u003e Result\u003cString, ApiError\u003e {\n    let email = value.trim();\n    if email.is_empty() {\n        return Err(ApiError::validation(\"Email is required\"));\n    }\n    Ok(email.to_string())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    #[wasm_bindgen_test]\n    fn normalize_email_rejects_empty() {\n        let err = normalize_email(\"\").expect_err(\"should fail\");\n        assert_eq!(err.code, \"VALIDATION_ERROR\");\n    }\n\n    #[wasm_bindgen_test]\n    fn normalize_email_trims_whitespace() {\n        let email = normalize_email(\"  test@example.com  \").expect(\"valid\");\n        assert_eq!(email, \"test@example.com\");\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","home.rs"],"content":"use leptos::*;\n\n#[component]\npub fn HomePage() -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"min-h-screen bg-surface\"\u003e\n            \u003cdiv class=\"max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8\"\u003e\n                \u003cdiv class=\"text-center\"\u003e\n                    \u003ch1 class=\"text-4xl font-extrabold text-fg sm:text-5xl lg:text-6xl\"\u003e\n                        \"Timekeeper\"\n                    \u003c/h1\u003e\n                    \u003cp class=\"mt-3 max-w-md mx-auto text-base text-fg-muted sm:text-lg lg:mt-5 lg:text-xl lg:max-w-3xl\"\u003e\n                        \"少人数向けの勤怠管理システム\"\n                    \u003c/p\u003e\n                    \u003cdiv class=\"mt-5 max-w-md mx-auto sm:flex sm:justify-center lg:mt-8\"\u003e\n                        \u003cdiv class=\"rounded-md shadow\"\u003e\n                            \u003ca href=\"/login\" class=\"w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-action-primary-text bg-action-primary-bg hover:bg-action-primary-bg-hover lg:py-4 lg:text-lg lg:px-10\"\u003e\n                                \"ログイン\"\n                            \u003c/a\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","components","form.rs"],"content":"use crate::{\n    api::{ApiError, LoginRequest},\n    components::error::InlineErrorMessage,\n    pages::login::utils::LoginFormState,\n};\nuse leptos::{ev::SubmitEvent, *};\nuse leptos_router::A;\nuse web_sys::HtmlInputElement;\n\n#[component]\npub fn LoginForm(\n    form: LoginFormState,\n    error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    login_action: Action\u003cLoginRequest, Result\u003c(), ApiError\u003e\u003e,\n) -\u003e impl IntoView {\n    let pending = login_action.pending();\n\n    let on_submit = move |ev: SubmitEvent| {\n        ev.prevent_default();\n        if pending.get_untracked() {\n            return;\n        }\n\n        if let Err(msg) = form.validate() {\n            error.set(Some(msg));\n            return;\n        }\n\n        let request = LoginRequest {\n            username: form.username.get_untracked(),\n            password: form.password.get_untracked(),\n            totp_code: form.normalize_totp(),\n            device_label: None,\n        };\n        error.set(None);\n        login_action.dispatch(request);\n    };\n\n    view! {\n        \u003cdiv class=\"min-h-screen flex items-center justify-center bg-surface py-12 px-4 sm:px-6 lg:px-8\"\u003e\n            \u003cdiv class=\"max-w-md w-full space-y-8\"\u003e\n                \u003cdiv\u003e\n                    \u003ch2 class=\"mt-6 text-center text-3xl font-extrabold text-fg\"\u003e\n                        {\"Timekeeper にログイン\"}\n                    \u003c/h2\u003e\n                    \u003cp class=\"mt-2 text-center text-sm text-fg-muted\"\u003e\n                        {\"勤怠管理システム\"}\n                    \u003c/p\u003e\n                \u003c/div\u003e\n                \u003cform class=\"mt-8 space-y-6\" on:submit=on_submit\u003e\n                    \u003cdiv class=\"rounded-md shadow-sm -space-y-px\"\u003e\n                        \u003cdiv\u003e\n                            \u003clabel for=\"username\" class=\"sr-only\"\u003e{\"ユーザー名\"}\u003c/label\u003e\n                            \u003cinput\n                                id=\"username\"\n                                name=\"username\"\n                                type=\"text\"\n                                required\n                                class=\"appearance-none rounded-none relative block w-full px-3 py-2 border border-form-control-border bg-form-control-bg placeholder-form-control-placeholder text-form-control-text rounded-t-md focus:outline-none focus:ring-2 focus:ring-action-primary-focus focus:border-action-primary-border focus:z-10 sm:text-sm\"\n                                placeholder=\"ユーザー名\"\n                                prop:value=form.username\n                                on:input=move |ev| {\n                                    let target = event_target::\u003cHtmlInputElement\u003e(\u0026ev);\n                                    form.username.set(target.value());\n                                }\n                            /\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003clabel for=\"password\" class=\"sr-only\"\u003e{\"パスワード\"}\u003c/label\u003e\n                            \u003cinput\n                                id=\"password\"\n                                name=\"password\"\n                                type=\"password\"\n                                required\n                                class=\"appearance-none rounded-none relative block w-full px-3 py-2 border border-form-control-border bg-form-control-bg placeholder-form-control-placeholder text-form-control-text rounded-b-md focus:outline-none focus:ring-2 focus:ring-action-primary-focus focus:border-action-primary-border focus:z-10 sm:text-sm\"\n                                placeholder=\"パスワード\"\n                                prop:value=form.password\n                                on:input=move |ev| {\n                                    let target = event_target::\u003cHtmlInputElement\u003e(\u0026ev);\n                                    form.password.set(target.value());\n                                }\n                            /\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003clabel for=\"totp_code\" class=\"sr-only\"\u003e{\"MFAコード\"}\u003c/label\u003e\n                            \u003cinput\n                                id=\"totp_code\"\n                                name=\"totp_code\"\n                                type=\"text\"\n                                inputmode=\"numeric\"\n                                autocomplete=\"one-time-code\"\n                                class=\"appearance-none rounded relative block w-full px-3 py-2 border border-form-control-border bg-form-control-bg placeholder-form-control-placeholder text-form-control-text focus:outline-none focus:ring-2 focus:ring-action-primary-focus focus:border-action-primary-border focus:z-10 sm:text-sm\"\n                                placeholder=\"MFAコード (必要な場合)\"\n                                prop:value=form.totp_code\n                                on:input=move |ev| {\n                                    let target = event_target::\u003cHtmlInputElement\u003e(\u0026ev);\n                                    form.totp_code.set(target.value());\n                                }\n                            /\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n\n                    \u003cdiv class=\"flex items-center justify-between\"\u003e\n                        \u003cdiv class=\"text-sm\"\u003e\n                            \u003cA href=\"/forgot-password\" class=\"font-medium text-link hover:text-link-hover\"\u003e\n                                \"Forgot your password?\"\n                            \u003c/A\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n\n                    \u003cInlineErrorMessage error=error.read_only().into() /\u003e\n\n                    \u003cdiv\u003e\n                        \u003cbutton\n                            type=\"submit\"\n                            disabled={move || pending.get()}\n                            class=\"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-action-primary-text bg-action-primary-bg hover:bg-action-primary-bg-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-action-primary-focus disabled:opacity-50\"\n                        \u003e\n                            \u003cspan class=\"absolute left-0 inset-y-0 flex items-center pl-3\"\u003e\n                                \u003csvg\n                                    class=\"h-5 w-5 text-action-primary-text/70 group-hover:text-action-primary-text\"\n                                    xmlns=\"http://www.w3.org/2000/svg\"\n                                    viewBox=\"0 0 20 20\"\n                                    fill=\"currentColor\"\n                                    aria-hidden=\"true\"\n                                \u003e\n                                    \u003cpath\n                                        fill-rule=\"evenodd\"\n                                        d=\"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z\"\n                                        clip-rule=\"evenodd\"\n                                    /\u003e\n                                \u003c/svg\u003e\n                            \u003c/span\u003e\n                            {move || if pending.get() { \"ログイン中...\" } else { \"ログイン\" }}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                \u003c/form\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","components","messages.rs"],"content":"use leptos::*;\n\n#[component]\npub fn InlineErrorMessage(error: ReadSignal\u003cOption\u003cString\u003e\u003e) -\u003e impl IntoView {\n    view! {\n        \u003cShow when=move || error.get().is_some() fallback=|| ()\u003e\n            \u003cdiv class=\"bg-status-error-bg border border-status-error-border text-status-error-text px-4 py-3 rounded\"\u003e\n                {error.get().unwrap_or_default()}\n            \u003c/div\u003e\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","components","mod.rs"],"content":"pub mod form;\npub mod messages;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","mod.rs"],"content":"use leptos::*;\n\npub mod components;\npub mod repository;\npub mod utils;\npub mod view_model;\n\nmod panel;\n\npub use panel::LoginPanel;\n\n#[component]\npub fn LoginPage() -\u003e impl IntoView {\n    view! { \u003cLoginPanel /\u003e }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","panel.rs"],"content":"use crate::pages::login::components::form::LoginForm;\nuse leptos::*;\n#[component]\npub fn LoginPanel() -\u003e impl IntoView {\n    let vm = crate::pages::login::view_model::use_login_view_model();\n\n    view! {\n        \u003cLoginForm\n            form=vm.form\n            error=vm.error\n            login_action=vm.login_action\n        /\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","repository.rs"],"content":"use crate::api::{ApiClient, ApiError, LoginRequest, LoginResponse};\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct LoginRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl LoginRepository {\n    pub fn new_with_client(client: Rc\u003cApiClient\u003e) -\u003e Self {\n        Self { client }\n    }\n\n    pub async fn login(\u0026self, request: LoginRequest) -\u003e Result\u003cLoginResponse, ApiError\u003e {\n        self.client.login(request).await\n    }\n\n    pub async fn logout(\u0026self, all: bool) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.logout(all).await\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","utils.rs"],"content":"use crate::api::ApiError;\nuse leptos::*;\n\n#[derive(Clone, Copy)]\npub struct LoginFormState {\n    pub username: RwSignal\u003cString\u003e,\n    pub password: RwSignal\u003cString\u003e,\n    pub totp_code: RwSignal\u003cString\u003e,\n}\n\nimpl Default for LoginFormState {\n    fn default() -\u003e Self {\n        Self {\n            username: create_rw_signal(String::new()),\n            password: create_rw_signal(String::new()),\n            totp_code: create_rw_signal(String::new()),\n        }\n    }\n}\n\nimpl LoginFormState {\n    pub fn validate(\u0026self) -\u003e Result\u003c(), ApiError\u003e {\n        let username = self.username.get();\n        let password = self.password.get();\n\n        if username.trim().is_empty() {\n            return Err(ApiError::validation(\"ユーザー名を入力してください\"));\n        }\n        if password.is_empty() {\n            return Err(ApiError::validation(\"パスワードを入力してください\"));\n        }\n        Ok(())\n    }\n\n    pub fn normalize_totp(\u0026self) -\u003e Option\u003cString\u003e {\n        let raw = self.totp_code.get();\n        let trimmed = raw.trim();\n        if trimmed.is_empty() {\n            None\n        } else {\n            Some(trimmed.to_string())\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use leptos::create_runtime;\n\n    fn with_runtime\u003cT\u003e(test: impl FnOnce() -\u003e T) -\u003e T {\n        let runtime = create_runtime();\n        let result = test();\n        runtime.dispose();\n        result\n    }\n\n    #[test]\n    fn login_form_validation_requires_values() {\n        with_runtime(|| {\n            let state = LoginFormState::default();\n            assert!(state.validate().is_err());\n            state.username.set(\"user\".into());\n            assert!(state.validate().is_err());\n            state.password.set(\"pass\".into());\n            assert!(state.validate().is_ok());\n        });\n    }\n\n    #[test]\n    fn normalize_totp_trims_value() {\n        with_runtime(|| {\n            let state = LoginFormState::default();\n            state.totp_code.set(\" 123456 \".into());\n            assert_eq!(state.normalize_totp().as_deref(), Some(\"123456\"));\n            state.totp_code.set(\"   \".into());\n            assert!(state.normalize_totp().is_none());\n        });\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","login","view_model.rs"],"content":"use super::utils::LoginFormState;\nuse crate::api::{ApiError, LoginRequest};\nuse crate::state::auth;\nuse leptos::*;\n\n#[derive(Clone)]\npub struct LoginViewModel {\n    pub form: LoginFormState,\n    pub error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    pub login_action: Action\u003cLoginRequest, Result\u003c(), ApiError\u003e\u003e,\n}\n\npub fn use_login_view_model() -\u003e LoginViewModel {\n    let form = LoginFormState::default();\n    let error = create_rw_signal(None::\u003cApiError\u003e);\n    let login_action = auth::use_login_action();\n\n    let form_copy = form;\n    create_effect(move |_| {\n        if let Some(result) = login_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    error.set(None);\n                    form_copy.totp_code.set(String::new());\n                    if let Some(window) = web_sys::window() {\n                        let _ = window.location().set_href(\"/dashboard\");\n                    }\n                }\n                Err(err) =\u003e error.set(Some(err)),\n            }\n        }\n    });\n\n    LoginViewModel {\n        form,\n        error,\n        login_action,\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","components","mod.rs"],"content":"pub mod setup;\npub mod verify;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","components","setup.rs"],"content":"use crate::{api::MfaStatusResponse, components::layout::LoadingSpinner};\nuse leptos::*;\n\n#[component]\npub fn SetupSection\u003cF, R\u003e(\n    status: ReadSignal\u003cOption\u003cMfaStatusResponse\u003e\u003e,\n    status_loading: ReadSignal\u003cbool\u003e,\n    register_loading: Signal\u003cbool\u003e,\n    on_register: F,\n    on_refresh: R,\n) -\u003e impl IntoView\nwhere\n    F: Fn() + 'static,\n    R: Fn() + 'static,\n{\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-3\"\u003e\n            \u003ch1 class=\"text-xl font-semibold text-fg\"\u003e{\"MFA 設定\"}\u003c/h1\u003e\n\n            \u003cShow when=move || status_loading.get() fallback=|| ()\u003e\n                \u003cdiv class=\"py-4\"\u003e\n                    \u003cLoadingSpinner /\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n\n            \u003cShow when=move || status.get().is_some() fallback=|| ()\u003e\n                {move || {\n                    status\n                        .get()\n                        .map(|info| {\n                            let message = if info.enabled {\n                                \"MFA は有効です。必要に応じて再登録してください。\"\n                            } else if info.pending {\n                                \"認証アプリにシークレットを登録済みです。確認コードを入力して有効化してください。\"\n                            } else {\n                                \"まだ MFA は無効です。このボタンから登録できます。\"\n                            };\n                            view! {\n                                \u003cdiv class=\"bg-surface-muted border border-border text-fg px-4 py-3 rounded\"\u003e\n                                    {message}\n                                \u003c/div\u003e\n                            }\n                            .into_view()\n                        })\n                        .unwrap_or_else(|| view! {}.into_view())\n                }}\n            \u003c/Show\u003e\n\n            \u003cdiv class=\"flex flex-col gap-2 sm:flex-row sm:items-center\"\u003e\n                \u003cbutton\n                    class=\"px-4 py-2 bg-action-primary-bg text-action-primary-text rounded disabled:opacity-50\"\n                    on:click=move |_| on_register()\n                    disabled={move || register_loading.get()}\n                \u003e\n                    {move || if register_loading.get() {\n                        \"登録中...\"\n                    } else {\n                        \"シークレットを発行\"\n                    }}\n                \u003c/button\u003e\n                \u003cbutton\n                    class=\"px-4 py-2 border border-border text-fg rounded hover:bg-action-ghost-bg-hover\"\n                    on:click=move |_| on_refresh()\n                \u003e\n                    {\"ステータスを再取得\"}\n                \u003c/button\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":17,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":20,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":21,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":23,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":24,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":26,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":27,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":34,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":38,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":40,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":41,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":43,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":47,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":49,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":62,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[],"length":0,"stats":{"Line":0},"fn_name":null},{"line":68,"address":[],"length":0,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":41},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","components","verify.rs"],"content":"use crate::api::MfaSetupResponse;\nuse crate::pages::mfa::utils::svg_to_data_url;\nuse leptos::{ev::SubmitEvent, Callback, *};\nuse qrcode::{render::svg, QrCode};\nuse web_sys::HtmlInputElement;\n\n#[component]\npub fn VerificationSection(\n    setup_info: ReadSignal\u003cOption\u003cMfaSetupResponse\u003e\u003e,\n    activate_loading: Signal\u003cbool\u003e,\n    on_submit: Callback\u003cSubmitEvent\u003e,\n    on_input: WriteSignal\u003cString\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cShow when=move || setup_info.get().is_some() fallback=|| ()\u003e\n            {move || {\n                setup_info\n                    .get()\n                    .map(|info| {\n                        let qr_svg = QrCode::new(info.otpauth_url.as_bytes())\n                            .map(|code| code.render::\u003csvg::Color\u003e().build())\n                            .unwrap_or_default();\n                        let qr_svg_data_url = svg_to_data_url(\u0026qr_svg);\n\n                        view! {\n                            \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n                                \u003ch2 class=\"text-lg font-semibold text-fg\"\u003e\n                                    {\"認証アプリで QR をスキャン\"}\n                                \u003c/h2\u003e\n                                \u003cdiv class=\"border border-border rounded p-4 bg-surface-muted\"\u003e\n                                    \u003cimg src=qr_svg_data_url alt=\"認証アプリのQRコード\" /\u003e\n                                \u003c/div\u003e\n                                \u003cp class=\"text-sm text-fg-muted break-all\"\u003e\n                                    {info.otpauth_url.clone()}\n                                \u003c/p\u003e\n                                \u003cform class=\"space-y-3\" on:submit=move |ev| on_submit.call(ev)\u003e\n                                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\n                                        {\"確認コード\"}\n                                    \u003c/label\u003e\n                                    \u003cinput\n                                        type=\"text\"\n                                        class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-3 py-2\"\n                                        placeholder=\"6桁コード\"\n                                        maxlength=6\n                                        on:input=move |ev| {\n                                            let target = event_target::\u003cHtmlInputElement\u003e(\u0026ev);\n                                            on_input.set(target.value());\n                                        }\n                                    /\u003e\n                                    \u003cbutton\n                                        class=\"px-4 py-2 bg-action-primary-bg text-action-primary-text rounded disabled:opacity-50\"\n                                        disabled={move || activate_loading.get()}\n                                    \u003e\n                                        {move || if activate_loading.get() {\n                                            \"有効化中...\"\n                                        } else {\n                                            \"有効化する\"\n                                        }}\n                                    \u003c/button\u003e\n                                \u003c/form\u003e\n                            \u003c/div\u003e\n                        }\n                        .into_view()\n                    })\n                    .unwrap_or_else(|| view! {}.into_view())\n            }}\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","mod.rs"],"content":"use leptos::*;\n\npub mod components;\npub mod panel;\npub mod repository;\npub mod utils;\npub mod view_model;\n\npub use panel::MfaRegisterPanel;\n\n#[component]\npub fn MfaRegisterPage() -\u003e impl IntoView {\n    view! { \u003cMfaRegisterPanel /\u003e }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","panel.rs"],"content":"use crate::{\n    components::{\n        error::InlineErrorMessage,\n        layout::{Layout, SuccessMessage},\n    },\n    pages::mfa::{\n        components::{setup::SetupSection, verify::VerificationSection},\n        utils,\n    },\n};\nuse leptos::{ev::SubmitEvent, Callback, *};\n\n#[component]\npub fn MfaRegisterPanel() -\u003e impl IntoView {\n    let vm = crate::pages::mfa::view_model::use_mfa_view_model();\n\n    let register_loading = vm.register_action.pending();\n    let activate_loading = vm.activate_action.pending();\n\n    let start_registration = {\n        move || {\n            if register_loading.get() {\n                return;\n            }\n            vm.messages.clear();\n            vm.setup_info.set(None);\n            vm.register_action.dispatch(());\n        }\n    };\n\n    let handle_activate = {\n        move |ev: SubmitEvent| {\n            ev.prevent_default();\n            if activate_loading.get() {\n                return;\n            }\n            let code_value = vm.totp_code.get();\n            let trimmed = match utils::validate_totp_code(\u0026code_value) {\n                Ok(code) =\u003e code,\n                Err(msg) =\u003e {\n                    vm.messages.set_error(msg);\n                    return;\n                }\n            };\n\n            vm.messages.clear();\n            vm.activate_action.dispatch(trimmed);\n        }\n    };\n    let handle_activate = Callback::new(handle_activate);\n\n    view! {\n        \u003cLayout\u003e\n            \u003cdiv class=\"mx-auto max-w-3xl space-y-6\"\u003e\n                \u003cSetupSection\n                    status=vm.status.read_only()\n                    status_loading=vm.status_loading.read_only()\n                    register_loading=register_loading.into()\n                    on_register=start_registration\n                    on_refresh=move || vm.fetch_status_action.dispatch(())\n                /\u003e\n                \u003cShow when=move || vm.messages.success.get().is_some() fallback=|| ()\u003e\n                    \u003cSuccessMessage message={vm.messages.success.get().unwrap_or_default()} /\u003e\n                \u003c/Show\u003e\n                \u003cShow when=move || vm.messages.error.get().is_some() fallback=|| ()\u003e\n                    \u003cInlineErrorMessage error={vm.messages.error.into()} /\u003e\n                \u003c/Show\u003e\n                \u003cVerificationSection\n                    setup_info=vm.setup_info.read_only()\n                    activate_loading=activate_loading.into()\n                    on_submit=handle_activate\n                    on_input=vm.totp_code.write_only()\n                /\u003e\n            \u003c/div\u003e\n        \u003c/Layout\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","repository.rs"],"content":"use crate::api::{ApiClient, ApiError, MfaSetupResponse, MfaStatusResponse};\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct MfaRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl MfaRepository {\n    pub fn new_with_client(client: Rc\u003cApiClient\u003e) -\u003e Self {\n        Self { client }\n    }\n\n    pub async fn fetch_status(\u0026self) -\u003e Result\u003cMfaStatusResponse, ApiError\u003e {\n        self.client.get_mfa_status().await\n    }\n\n    pub async fn register(\u0026self) -\u003e Result\u003cMfaSetupResponse, ApiError\u003e {\n        self.client.register_mfa().await\n    }\n\n    pub async fn activate(\u0026self, code: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.activate_mfa(code).await\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","utils.rs"],"content":"use crate::api::ApiError;\nuse base64::{engine::general_purpose, Engine as _};\nuse leptos::*;\n\n#[derive(Clone, Copy, Default)]\npub struct MessageState {\n    pub error: RwSignal\u003cOption\u003cApiError\u003e\u003e,\n    pub success: RwSignal\u003cOption\u003cString\u003e\u003e,\n}\n\nimpl MessageState {\n    pub fn set_error(\u0026self, msg: ApiError) {\n        self.error.set(Some(msg));\n        self.success.set(None);\n    }\n\n    pub fn set_success(\u0026self, msg: String) {\n        self.success.set(Some(msg));\n        self.error.set(None);\n    }\n\n    pub fn clear(\u0026self) {\n        self.error.set(None);\n        self.success.set(None);\n    }\n}\n\npub fn validate_totp_code(code: \u0026str) -\u003e Result\u003cString, ApiError\u003e {\n    let trimmed = code.trim();\n    if trimmed.len() \u003c 6 {\n        Err(ApiError::validation(\"6桁の確認コードを入力してください\"))\n    } else {\n        Ok(trimmed.to_string())\n    }\n}\n\npub fn svg_to_data_url(svg: \u0026str) -\u003e String {\n    let encoded = general_purpose::STANDARD.encode(svg.as_bytes());\n    format!(\"data:image/svg+xml;base64,{}\", encoded)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    #[wasm_bindgen_test]\n    fn validate_totp_code_rejects_short_values() {\n        let result = validate_totp_code(\"123\");\n        assert!(result.is_err());\n    }\n\n    #[wasm_bindgen_test]\n    fn validate_totp_code_trims_and_accepts() {\n        let result = validate_totp_code(\" 987654 \");\n        assert_eq!(result.unwrap(), \"987654\");\n    }\n\n    #[wasm_bindgen_test]\n    fn svg_to_data_url_encodes_svg() {\n        let result = svg_to_data_url(\"\u003csvg\u003e\u003c/svg\u003e\");\n        assert_eq!(result, \"data:image/svg+xml;base64,PHN2Zz48L3N2Zz4=\");\n    }\n\n    #[wasm_bindgen_test]\n    fn svg_to_data_url_handles_empty_input() {\n        let result = svg_to_data_url(\"\");\n        assert_eq!(result, \"data:image/svg+xml;base64,\");\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mfa","view_model.rs"],"content":"use super::{repository::MfaRepository, utils::MessageState};\nuse crate::{\n    api::{ApiClient, ApiError, MfaSetupResponse, MfaStatusResponse},\n    state::auth::use_auth,\n};\nuse leptos::*;\n\n#[derive(Clone)]\npub struct MfaViewModel {\n    pub status: RwSignal\u003cOption\u003cMfaStatusResponse\u003e\u003e,\n    pub status_loading: RwSignal\u003cbool\u003e,\n    pub setup_info: RwSignal\u003cOption\u003cMfaSetupResponse\u003e\u003e,\n    pub totp_code: RwSignal\u003cString\u003e,\n    pub messages: MessageState,\n    pub fetch_status_action: Action\u003c(), ()\u003e,\n    pub register_action: Action\u003c(), Result\u003cMfaSetupResponse, ApiError\u003e\u003e,\n    pub activate_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n}\n\npub fn use_mfa_view_model() -\u003e MfaViewModel {\n    let (_auth, set_auth) = use_auth();\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repository = MfaRepository::new_with_client(std::rc::Rc::new(api));\n\n    let status = create_rw_signal(None);\n    let status_loading = create_rw_signal(true);\n    let setup_info = create_rw_signal(None);\n    let totp_code = create_rw_signal(String::new());\n    let messages = MessageState::default();\n\n    let repo_for_fetch = repository.clone();\n    let fetch_status_action = create_action(move |_| {\n        let repo = repo_for_fetch.clone();\n        async move {\n            messages.clear();\n            status_loading.set(true);\n            match repo.fetch_status().await {\n                Ok(resp) =\u003e status.set(Some(resp)),\n                Err(err) =\u003e messages.set_error(err),\n            }\n            status_loading.set(false);\n        }\n    });\n\n    let repo_for_register = repository.clone();\n    let register_action = create_action(move |_| {\n        let repo = repo_for_register.clone();\n        async move { repo.register().await }\n    });\n\n    let repo_for_activate = repository.clone();\n    let activate_action = create_action(move |code: \u0026String| {\n        let repo = repo_for_activate.clone();\n        let code = code.clone();\n        async move { repo.activate(\u0026code).await }\n    });\n\n    // Effects\n    create_effect(move |_| {\n        if let Some(result) = register_action.value().get() {\n            match result {\n                Ok(info) =\u003e {\n                    setup_info.set(Some(info));\n                    messages.set_success(\n                        \"認証アプリにシークレットを登録し、確認コードを入力してください。\"\n                            .to_string(),\n                    );\n                }\n                Err(err) =\u003e messages.set_error(err),\n            }\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = activate_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    setup_info.set(None);\n                    totp_code.set(String::new());\n                    messages.set_success(\n                        \"MFA を有効化しました。次回以降のログインで認証コードが求められます。\"\n                            .to_string(),\n                    );\n\n                    // Update global auth state\n                    set_auth.update(|state| {\n                        if let Some(user) = state.user.as_mut() {\n                            user.mfa_enabled = true;\n                        }\n                    });\n\n                    fetch_status_action.dispatch(());\n                }\n                Err(err) =\u003e messages.set_error(err),\n            }\n        }\n    });\n\n    // Initial fetch\n    fetch_status_action.dispatch(());\n\n    MfaViewModel {\n        status,\n        status_loading,\n        setup_info,\n        totp_code,\n        messages,\n        fetch_status_action,\n        register_action,\n        activate_action,\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","mod.rs"],"content":"pub mod admin;\npub mod admin_audit_logs;\npub mod admin_export;\npub mod admin_users;\npub mod attendance;\npub mod dashboard;\npub mod forgot_password;\npub mod home;\npub mod login;\npub mod mfa;\npub mod requests;\npub mod reset_password;\npub mod settings;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","components","detail_modal.rs"],"content":"use crate::pages::requests::types::{RequestKind, RequestSummary};\nuse leptos::*;\n\n#[component]\npub fn RequestDetailModal(selected: RwSignal\u003cOption\u003cRequestSummary\u003e\u003e) -\u003e impl IntoView {\n    let on_close = { move |_| selected.set(None) };\n    view! {\n        \u003cShow when=move || selected.get().is_some()\u003e\n            {move || {\n                selected\n                    .get()\n                    .map(|summary| {\n                        view! {\n                            \u003cdiv class=\"fixed inset-0 z-50 flex items-end sm:items-center justify-center\"\u003e\n                                \u003cdiv class=\"fixed inset-0 bg-overlay-backdrop\" on:click=on_close\u003e\u003c/div\u003e\n                                \u003cdiv class=\"relative bg-surface-elevated rounded-lg shadow-xl w-full max-w-md mx-4 p-6 space-y-4\"\u003e\n                                    \u003cdiv class=\"flex items-center justify-between\"\u003e\n                                        \u003cdiv\u003e\n                                            \u003cp class=\"text-sm text-fg-muted\"\u003e{\"申請の詳細\"}\u003c/p\u003e\n                                            \u003cp class=\"text-lg font-semibold text-fg\"\u003e\n                                                {match summary.kind {\n                                                    RequestKind::Leave =\u003e \"休暇申請\",\n                                                    RequestKind::Overtime =\u003e \"残業申請\",\n                                                }}\n                                            \u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cbutton class=\"text-fg-muted hover:text-fg\" on:click=on_close\u003e\n                                            {\"✕\"}\n                                        \u003c/button\u003e\n                                    \u003c/div\u003e\n                                    \u003cdiv class=\"space-y-2 text-sm text-fg\"\u003e\n                                        \u003cdiv\u003e\n                                            \u003cspan class=\"font-medium text-fg-muted\"\u003e{\"ステータス: \"}\u003c/span\u003e\n                                            \u003cspan class=\"capitalize\"\u003e{summary.status.clone()}\u003c/span\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cspan class=\"font-medium text-fg-muted\"\u003e{\"期間/日付: \"}\u003c/span\u003e\n                                            \u003cspan\u003e{summary.primary_label.clone().unwrap_or_else(|| \"-\".into())}\u003c/span\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cspan class=\"font-medium text-fg-muted\"\u003e{\"補足: \"}\u003c/span\u003e\n                                            \u003cspan\u003e{summary.secondary_label.clone().unwrap_or_else(|| \"-\".into())}\u003c/span\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cspan class=\"font-medium text-fg-muted\"\u003e{\"理由: \"}\u003c/span\u003e\n                                            \u003cspan\u003e{summary.reason.clone().unwrap_or_else(|| \"未入力\".into())}\u003c/span\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv\u003e\n                                            \u003cspan class=\"font-medium text-fg-muted\"\u003e{\"提出日: \"}\u003c/span\u003e\n                                            \u003cspan\u003e{summary.submitted_at.clone().unwrap_or_else(|| \"-\".into())}\u003c/span\u003e\n                                        \u003c/div\u003e\n                                    \u003c/div\u003e\n                                    \u003cdiv class=\"flex justify-end\"\u003e\n                                        \u003cbutton class=\"px-4 py-2 rounded bg-surface-muted text-fg hover:bg-surface-elevated\" on:click=on_close\u003e\n                                            {\"閉じる\"}\n                                        \u003c/button\u003e\n                                    \u003c/div\u003e\n                                \u003c/div\u003e\n                            \u003c/div\u003e\n                        }\n                    })\n            }}\n        \u003c/Show\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","components","filter.rs"],"content":"use crate::pages::requests::utils::RequestFilterState;\nuse leptos::*;\n\n#[component]\npub fn RequestsFilter(filter_state: RequestFilterState) -\u003e impl IntoView {\n    let status_signal = filter_state.status_signal();\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-4 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between\"\u003e\n            \u003cdiv\u003e\n                \u003ch3 class=\"text-sm font-semibold text-fg\"\u003e{\"申請の絞り込み\"}\u003c/h3\u003e\n                \u003cp class=\"text-xs text-fg-muted\"\u003e{\"ステータスで一覧の表示を切り替えます。\"} \u003c/p\u003e\n            \u003c/div\u003e\n            \u003cdiv class=\"flex items-center gap-2\"\u003e\n                \u003cselect\n                    class=\"border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1 text-sm\"\n                    prop:value=move || status_signal.get()\n                    on:change=move |ev| status_signal.set(event_target_value(\u0026ev))\n                \u003e\n                    \u003coption value=\"\"\u003e{\"すべて\"}\u003c/option\u003e\n                    \u003coption value=\"pending\"\u003e{\"保留\"}\u003c/option\u003e\n                    \u003coption value=\"approved\"\u003e{\"承認済み\"}\u003c/option\u003e\n                    \u003coption value=\"rejected\"\u003e{\"却下\"}\u003c/option\u003e\n                    \u003coption value=\"cancelled\"\u003e{\"取消\"}\u003c/option\u003e\n                \u003c/select\u003e\n                \u003cbutton\n                    class=\"text-sm text-link hover:text-link-hover underline\"\n                    on:click=move |_| status_signal.set(String::new())\n                \u003e\n                    {\"クリア\"}\n                \u003c/button\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","components","leave_form.rs"],"content":"use crate::api::{ApiError, CreateLeaveRequest};\nuse crate::components::error::InlineErrorMessage;\nuse crate::components::forms::DatePicker;\nuse crate::components::layout::SuccessMessage;\nuse crate::pages::requests::types::RequestKind;\nuse crate::pages::requests::{\n    utils::{EditTarget, LeaveFormState, MessageState},\n    view_model::EditPayload,\n};\nuse leptos::*;\nuse serde_json::to_value;\n\n#[component]\npub fn LeaveRequestForm(\n    state: LeaveFormState,\n    message: RwSignal\u003cMessageState\u003e,\n    action: Action\u003cCreateLeaveRequest, Result\u003c(), ApiError\u003e\u003e,\n    update_action: Action\u003cEditPayload, Result\u003c(), ApiError\u003e\u003e,\n    editing: RwSignal\u003cOption\u003cEditTarget\u003e\u003e,\n    on_cancel_edit: Callback\u003c()\u003e,\n) -\u003e impl IntoView {\n    let pending = action.pending();\n    let updating = update_action.pending();\n\n    let on_submit = {\n        let state = state.clone();\n        move |ev: ev::SubmitEvent| {\n            ev.prevent_default();\n            match state.to_payload() {\n                Ok(payload) =\u003e {\n                    message.update(|msg| msg.clear());\n                    if let Some(target) = editing.get() {\n                        update_action\n                            .dispatch((target.id, to_value(payload).unwrap_or_default()).into());\n                    } else {\n                        action.dispatch(payload);\n                    }\n                }\n                Err(err) =\u003e {\n                    message.update(|msg| msg.set_error(err));\n                }\n            }\n        }\n    };\n\n    let leave_type = state.leave_type_signal();\n    let start_signal = state.start_signal();\n    let end_signal = state.end_signal();\n    let reason_signal = state.reason_signal();\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv\u003e\n                \u003ch3 class=\"text-lg font-medium text-fg\"\u003e{\"休暇申請\"}\u003c/h3\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"休暇の種類と期間を入力して申請を送信します。\"} \u003c/p\u003e\n                \u003cShow\n                    when=move || {\n                        editing\n                            .get()\n                            .map(|target| target.kind == RequestKind::Leave)\n                            .unwrap_or(false)\n                    }\n                \u003e\n                    \u003cp class=\"mt-1 text-xs text-status-info-text bg-status-info-bg border border-status-info-border rounded px-2 py-1 inline-flex items-center gap-2\"\u003e\n                        {\"編集中: 既存の休暇申請を更新します。\"}\n                        \u003cbutton class=\"text-status-info-text underline\" on:click=move |_| on_cancel_edit.call(())\u003e\n                            {\"キャンセル\"}\n                        \u003c/button\u003e\n                    \u003c/p\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || message.get().error.is_some()\u003e\n                \u003cInlineErrorMessage error={Signal::derive(move || message.get().error).into()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || message.get().success.is_some()\u003e\n                \u003cSuccessMessage message={message.get().success.clone().unwrap_or_default()} /\u003e\n            \u003c/Show\u003e\n            \u003cform class=\"space-y-4\" on:submit=on_submit\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"種類\"}\u003c/label\u003e\n                    \u003cselect\n                        class=\"mt-1 block w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        prop:value=move || leave_type.get()\n                        on:change=move |ev| leave_type.set(event_target_value(\u0026ev))\n                    \u003e\n                        \u003coption value=\"annual\"\u003e{\"年次有給\"}\u003c/option\u003e\n                        \u003coption value=\"sick\"\u003e{\"病気\"}\u003c/option\u003e\n                        \u003coption value=\"personal\"\u003e{\"私用\"}\u003c/option\u003e\n                        \u003coption value=\"other\"\u003e{\"その他\"}\u003c/option\u003e\n                    \u003c/select\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"grid grid-cols-1 gap-4 lg:grid-cols-2\"\u003e\n                    \u003cDatePicker\n                        label=Some(\"開始日\")\n                        value=start_signal\n                    /\u003e\n                    \u003cDatePicker\n                        label=Some(\"終了日\")\n                        value=end_signal\n                    /\u003e\n                \u003c/div\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"理由（任意）\"}\u003c/label\u003e\n                    \u003ctextarea\n                        rows=3\n                        class=\"mt-1 block w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        prop:value=move || reason_signal.get()\n                        on:input=move |ev| reason_signal.set(event_target_value(\u0026ev))\n                    \u003e\u003c/textarea\u003e\n                \u003c/div\u003e\n                \u003cbutton\n                    type=\"submit\"\n                    class=\"px-4 py-2 rounded bg-action-primary-bg text-action-primary-text disabled:opacity-50\"\n                    disabled=move || pending.get() || updating.get()\n                \u003e\n                    {move || {\n                        if pending.get() || updating.get() {\n                            \"送信中...\"\n                        } else if editing\n                            .get()\n                            .map(|target| target.kind == RequestKind::Leave)\n                            .unwrap_or(false)\n                        {\n                            \"休暇申請を更新\"\n                        } else {\n                            \"休暇申請を送信\"\n                        }\n                    }}\n                \u003c/button\u003e\n            \u003c/form\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","components","list.rs"],"content":"use crate::api::ApiError;\nuse crate::components::{\n    empty_state::EmptyState, error::InlineErrorMessage, layout::LoadingSpinner,\n};\nuse crate::pages::requests::types::{RequestKind, RequestSummary};\nuse leptos::*;\n\n#[component]\npub fn RequestsList(\n    summaries: Signal\u003cVec\u003cRequestSummary\u003e\u003e,\n    loading: Signal\u003cbool\u003e,\n    error: Signal\u003cOption\u003cApiError\u003e\u003e,\n    on_select: Callback\u003cRequestSummary\u003e,\n    on_edit: Callback\u003cRequestSummary\u003e,\n    on_cancel: Callback\u003cRequestSummary\u003e,\n    message: RwSignal\u003ccrate::pages::requests::utils::MessageState\u003e,\n) -\u003e impl IntoView {\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow-premium rounded-3xl overflow-hidden border border-border\"\u003e\n            \u003cdiv class=\"px-8 py-6 border-b border-border\"\u003e\n                \u003ch3 class=\"text-xl font-display font-bold text-fg\"\u003e{\"申請一覧\"}\u003c/h3\u003e\n                \u003cShow when=move || message.get().error.is_some()\u003e\n                    \u003cdiv class=\"mt-4\"\u003e\n                        \u003cInlineErrorMessage error={Signal::derive(move || message.get().error).into()} /\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n                \u003cShow when=move || message.get().success.is_some()\u003e\n                    \u003cdiv class=\"mt-4 flex items-center gap-2 p-3 rounded-xl bg-status-success-bg border border-status-success-border text-status-success-text animate-pop-in\"\u003e\n                        \u003ci class=\"fas fa-check-circle\"\u003e\u003c/i\u003e\n                        \u003cspan class=\"text-sm font-medium\"\u003e{message.get().success.clone().unwrap_or_default()}\u003c/span\u003e\n                    \u003c/div\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n\n            \u003cShow when=move || error.get().is_some()\u003e\n                \u003cdiv class=\"p-8\"\u003e\n                    \u003cInlineErrorMessage error={error.into()} /\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n\n            \u003cShow when=move || loading.get()\u003e\n                \u003cdiv class=\"p-12 flex flex-col items-center justify-center gap-4 text-fg-muted\"\u003e\n                    \u003cLoadingSpinner /\u003e\n                    \u003cspan class=\"text-sm font-medium tracking-widest uppercase\"\u003e{\"データを取得中...\"}\u003c/span\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n\n            \u003cShow when=move || !loading.get() \u0026\u0026 summaries.get().is_empty() \u0026\u0026 error.get().is_none()\u003e\n                \u003cEmptyState\n                    title=\"表示できる申請がありません\"\n                    description=\"左または上のフォームから新しい申請を送信できます\"\n                    icon=view! { \u003ci class=\"fas fa-inbox text-4xl text-fg-muted\"\u003e\u003c/i\u003e }.into_view()\n                /\u003e\n            \u003c/Show\u003e\n\n            \u003cShow when=move || !summaries.get().is_empty()\u003e\n                \u003cdiv class=\"overflow-x-auto\"\u003e\n                    \u003ctable class=\"min-w-full divide-y divide-border\"\u003e\n                        \u003cthead\u003e\n                            \u003ctr class=\"bg-surface-muted\"\u003e\n                                \u003cth class=\"px-8 py-4 text-left text-xs font-bold text-fg-muted uppercase tracking-widest\"\u003e{\"種類\"}\u003c/th\u003e\n                                \u003cth class=\"px-8 py-4 text-left text-xs font-bold text-fg-muted uppercase tracking-widest\"\u003e{\"期間 / 日付\"}\u003c/th\u003e\n                                \u003cth class=\"px-8 py-4 text-left text-xs font-bold text-fg-muted uppercase tracking-widest\"\u003e{\"補足\"}\u003c/th\u003e\n                                \u003cth class=\"px-8 py-4 text-left text-xs font-bold text-fg-muted uppercase tracking-widest\"\u003e{\"ステータス\"}\u003c/th\u003e\n                                \u003cth class=\"px-8 py-4 text-left text-xs font-bold text-fg-muted uppercase tracking-widest\"\u003e{\"提出日\"}\u003c/th\u003e\n                                \u003cth class=\"px-8 py-4 text-left text-xs font-bold text-fg-muted uppercase tracking-widest\"\u003e{\"操作\"}\u003c/th\u003e\n                            \u003c/tr\u003e\n                        \u003c/thead\u003e\n                        \u003ctbody class=\"divide-y divide-border bg-surface-elevated\"\u003e\n                            \u003cFor\n                                each=move || summaries.get()\n                                key=|summary| summary.id.clone()\n                                children=move |summary: RequestSummary| {\n                                    let summary = store_value(summary);\n                                    let summary_value = summary.get_value();\n                                    let status = summary_value.status.clone();\n                                    let status_for_pending = status.clone();\n                                    let status_for_not_pending = status.clone();\n                                    let primary_label =\n                                        summary_value.primary_label.clone().unwrap_or_else(|| \"-\".into());\n                                    let secondary_label =\n                                        summary_value.secondary_label.clone().unwrap_or_else(|| \"-\".into());\n                                    let submitted_at =\n                                        summary_value.submitted_at.clone().unwrap_or_else(|| \"-\".into());\n\n                                    let status_style = match status.as_str() {\n                                        \"approved\" =\u003e \"bg-status-success-bg text-status-success-text\",\n                                        \"rejected\" =\u003e \"bg-status-error-bg text-status-error-text\",\n                                        \"pending\" =\u003e \"bg-status-warning-bg text-status-warning-text\",\n                                        _ =\u003e \"bg-status-neutral-bg text-status-neutral-text\",\n                                    };\n\n                                    view! {\n                                        \u003ctr class=\"hover:bg-surface-muted transition-colors group cursor-pointer\" on:click=move |_| on_select.call(summary.get_value())\u003e\n                                            \u003ctd class=\"px-8 py-5 whitespace-nowrap\"\u003e\n                                                \u003cspan class=\"inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold bg-status-neutral-bg text-status-neutral-text uppercase\"\u003e\n                                                    {match summary_value.kind {\n                                                        RequestKind::Leave =\u003e \"休暇\",\n                                                        RequestKind::Overtime =\u003e \"残業\",\n                                                    }}\n                                                \u003c/span\u003e\n                                            \u003c/td\u003e\n                                            \u003ctd class=\"px-8 py-5 whitespace-nowrap text-sm font-bold text-fg\"\u003e\n                                                {primary_label.clone()}\n                                            \u003c/td\u003e\n                                            \u003ctd class=\"px-8 py-5 whitespace-nowrap text-sm text-fg-muted\"\u003e\n                                                {secondary_label.clone()}\n                                            \u003c/td\u003e\n                                            \u003ctd class=\"px-8 py-5 whitespace-nowrap\"\u003e\n                                                \u003cspan class=format!(\"inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider {}\", status_style)\u003e\n                                                    {status.clone()}\n                                                \u003c/span\u003e\n                                            \u003c/td\u003e\n                                            \u003ctd class=\"px-8 py-5 whitespace-nowrap text-sm font-medium text-fg-muted\"\u003e\n                                                {submitted_at.clone()}\n                                            \u003c/td\u003e\n                                            \u003ctd class=\"px-8 py-5 whitespace-nowrap text-sm text-fg\"\u003e\n                                                \u003cShow when=move || status_for_pending == \"pending\"\u003e\n                                                    \u003cdiv class=\"flex gap-4\"\u003e\n                                                        \u003cbutton\n                                                            class=\"text-link hover:text-link-hover font-bold flex items-center gap-1 transition-colors\"\n                                                            on:click=move |ev| {\n                                                                ev.stop_propagation();\n                                                                on_edit.call(summary.get_value());\n                                                            }\n                                                        \u003e\n                                                            \u003ci class=\"fas fa-edit text-xs\"\u003e\u003c/i\u003e\n                                                            {\"編集\"}\n                                                        \u003c/button\u003e\n                                                        \u003cbutton\n                                                            class=\"text-action-danger-bg hover:text-action-danger-bg-hover font-bold flex items-center gap-1 transition-colors\"\n                                                            on:click=move |ev| {\n                                                                ev.stop_propagation();\n                                                                on_cancel.call(summary.get_value());\n                                                            }\n                                                        \u003e\n                                                            \u003ci class=\"fas fa-times-circle text-xs\"\u003e\u003c/i\u003e\n                                                            {\"取消\"}\n                                                        \u003c/button\u003e\n                                                    \u003c/div\u003e\n                                                \u003c/Show\u003e\n                                                \u003cShow when=move || status_for_not_pending != \"pending\"\u003e\n                                                    \u003cspan class=\"text-fg-muted\"\u003e\n                                                        \u003ci class=\"fas fa-lock text-xs\"\u003e\u003c/i\u003e\n                                                    \u003c/span\u003e\n                                                \u003c/Show\u003e\n                                            \u003c/td\u003e\n                                        \u003c/tr\u003e\n                                    }\n                                }\n                            /\u003e\n                        \u003c/tbody\u003e\n                    \u003c/table\u003e\n                \u003c/div\u003e\n            \u003c/Show\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","components","mod.rs"],"content":"pub mod detail_modal;\npub mod filter;\npub mod leave_form;\npub mod list;\npub mod overtime_form;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","components","overtime_form.rs"],"content":"use crate::api::{ApiError, CreateOvertimeRequest};\nuse crate::components::error::InlineErrorMessage;\nuse crate::components::forms::DatePicker;\nuse crate::components::layout::SuccessMessage;\nuse crate::pages::requests::types::RequestKind;\nuse crate::pages::requests::{\n    utils::{EditTarget, MessageState, OvertimeFormState},\n    view_model::EditPayload,\n};\nuse leptos::*;\nuse serde_json::to_value;\n\n#[component]\npub fn OvertimeRequestForm(\n    state: OvertimeFormState,\n    message: RwSignal\u003cMessageState\u003e,\n    action: Action\u003cCreateOvertimeRequest, Result\u003c(), ApiError\u003e\u003e,\n    update_action: Action\u003cEditPayload, Result\u003c(), ApiError\u003e\u003e,\n    editing: RwSignal\u003cOption\u003cEditTarget\u003e\u003e,\n    on_cancel_edit: Callback\u003c()\u003e,\n) -\u003e impl IntoView {\n    let pending = action.pending();\n    let updating = update_action.pending();\n\n    let on_submit = {\n        let state = state.clone();\n        move |ev: ev::SubmitEvent| {\n            ev.prevent_default();\n            match state.to_payload() {\n                Ok(payload) =\u003e {\n                    message.update(|msg| msg.clear());\n                    if let Some(target) = editing.get() {\n                        update_action\n                            .dispatch((target.id, to_value(payload).unwrap_or_default()).into());\n                    } else {\n                        action.dispatch(payload);\n                    }\n                }\n                Err(err) =\u003e message.update(|msg| msg.set_error(err)),\n            }\n        }\n    };\n\n    let date_signal = state.date_signal();\n    let hours_signal = state.hours_signal();\n    let reason_signal = state.reason_signal();\n    view! {\n        \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n            \u003cdiv\u003e\n                \u003ch3 class=\"text-lg font-medium text-fg\"\u003e{\"残業申請\"}\u003c/h3\u003e\n                \u003cp class=\"text-sm text-fg-muted\"\u003e{\"残業予定日と時間を入力して申請を送信します。\"} \u003c/p\u003e\n                \u003cShow when=move || editing\n                    .get()\n                    .map(|target| target.kind == RequestKind::Overtime)\n                    .unwrap_or(false)\u003e\n                    \u003cp class=\"mt-1 text-xs text-status-info-text bg-status-info-bg border border-status-info-border rounded px-2 py-1 inline-flex items-center gap-2\"\u003e\n                        {\"編集中: 既存の残業申請を更新します。\"}\n                        \u003cbutton class=\"text-status-info-text underline\" on:click=move |_| on_cancel_edit.call(())\u003e\n                            {\"キャンセル\"}\n                        \u003c/button\u003e\n                    \u003c/p\u003e\n                \u003c/Show\u003e\n            \u003c/div\u003e\n            \u003cShow when=move || message.get().error.is_some()\u003e\n                \u003cInlineErrorMessage error={Signal::derive(move || message.get().error).into()} /\u003e\n            \u003c/Show\u003e\n            \u003cShow when=move || message.get().success.is_some()\u003e\n                \u003cSuccessMessage message={message.get().success.clone().unwrap_or_default()} /\u003e\n            \u003c/Show\u003e\n            \u003cform class=\"space-y-4\" on:submit=on_submit\u003e\n                \u003cDatePicker\n                    label=Some(\"残業日\")\n                    value=date_signal\n                /\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"予定時間（時間）\"}\u003c/label\u003e\n                    \u003cinput\n                        type=\"number\"\n                        step=\"0.25\"\n                        min=\"0.25\"\n                        class=\"mt-1 block w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        prop:value=move || hours_signal.get()\n                        on:input=move |ev| hours_signal.set(event_target_value(\u0026ev))\n                    /\u003e\n                \u003c/div\u003e\n                \u003cdiv\u003e\n                    \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e{\"理由（任意）\"}\u003c/label\u003e\n                    \u003ctextarea\n                        rows=3\n                        class=\"mt-1 block w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-2 py-1\"\n                        prop:value=move || reason_signal.get()\n                        on:input=move |ev| reason_signal.set(event_target_value(\u0026ev))\n                    \u003e\u003c/textarea\u003e\n                \u003c/div\u003e\n                \u003cbutton\n                    type=\"submit\"\n                    class=\"px-4 py-2 rounded bg-action-primary-bg text-action-primary-text disabled:opacity-50\"\n                    disabled=move || pending.get() || updating.get()\n                \u003e\n                    {move || {\n                        if pending.get() || updating.get() {\n                            \"送信中...\"\n                        } else if editing\n                            .get()\n                            .map(|target| target.kind == RequestKind::Overtime)\n                            .unwrap_or(false)\n                        {\n                            \"残業申請を更新\"\n                        } else {\n                            \"残業申請を送信\"\n                        }\n                    }}\n                \u003c/button\u003e\n            \u003c/form\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","layout.rs"],"content":"use crate::components::layout::Layout;\nuse leptos::*;\n\n#[component]\npub fn RequestsLayout(children: Children) -\u003e impl IntoView {\n    view! {\n        \u003cLayout\u003e\n            \u003cdiv class=\"space-y-6\"\u003e\n                \u003cdiv\u003e\n                    \u003ch1 class=\"text-2xl font-bold text-fg\"\u003e{\"申請管理\"}\u003c/h1\u003e\n                    \u003cp class=\"mt-1 text-sm text-fg-muted\"\u003e\n                        {\"休暇と残業申請を作成し、申請状況をまとめて確認できます。\"}\n                    \u003c/p\u003e\n                \u003c/div\u003e\n                {children()}\n            \u003c/div\u003e\n        \u003c/Layout\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","mod.rs"],"content":"pub mod components;\npub mod layout;\npub mod panel;\npub mod repository;\npub mod types;\npub mod utils;\npub mod view_model;\n\npub use panel::RequestsPage;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","panel.rs"],"content":"use crate::pages::requests::{\n    components::{\n        detail_modal::RequestDetailModal, filter::RequestsFilter, leave_form::LeaveRequestForm,\n        list::RequestsList, overtime_form::OvertimeRequestForm,\n    },\n    layout::RequestsLayout,\n    view_model::{use_requests_view_model, RequestFormKind},\n};\nuse leptos::*;\n\n#[component]\npub fn RequestsPage() -\u003e impl IntoView {\n    let vm = use_requests_view_model();\n    let leave_state = vm.leave_state;\n    let overtime_state = vm.overtime_state;\n    let active_form = vm.active_form;\n    let set_active_form = vm.set_active_form;\n    let leave_message = vm.leave_message;\n    let overtime_message = vm.overtime_message;\n    let list_message = vm.list_message;\n    let leave_action = vm.leave_action;\n    let overtime_action = vm.overtime_action;\n    let update_action = vm.update_action;\n    let editing_request = vm.editing_request;\n    let filter_state = vm.filter_state;\n    let filtered_summaries = vm.filtered_summaries();\n    let requests_resource = vm.requests_resource;\n    let selected_request = vm.selected_request;\n    let on_edit = vm.on_edit();\n    let on_cancel_request = vm.on_cancel_request();\n\n    let on_cancel_leave = Callback::new({\n        move |_| {\n            editing_request.set(None);\n            list_message.update(|msg| msg.clear());\n            leave_state.reset();\n        }\n    });\n\n    let on_cancel_overtime = Callback::new({\n        move |_| {\n            editing_request.set(None);\n            list_message.update(|msg| msg.clear());\n            overtime_state.reset();\n        }\n    });\n\n    view! {\n        \u003c\u003e\n            \u003cRequestsLayout\u003e\n                \u003cdiv class=\"lg:hidden space-y-6\"\u003e\n                    \u003cdiv class=\"flex p-1.5 gap-1.5 rounded-2xl bg-surface-muted border border-border shadow-inner\"\u003e\n                        \u003cbutton\n                            class=move || {\n                                let base = \"flex-1 px-4 py-2.5 rounded-xl text-sm font-display font-bold transition-all duration-200\";\n                                if matches!(active_form.get(), RequestFormKind::Leave) {\n                                    format!(\"{base} bg-surface-elevated text-fg shadow-sm transition-all duration-300\")\n                                } else {\n                                    format!(\"{base} text-fg-muted hover:text-fg\")\n                                }\n                            }\n                            on:click=move |_| set_active_form.set(RequestFormKind::Leave)\n                        \u003e\n                            {\"休暇申請\"}\n                        \u003c/button\u003e\n                        \u003cbutton\n                            class=move || {\n                                let base = \"flex-1 px-4 py-2.5 rounded-xl text-sm font-display font-bold transition-all duration-200\";\n                                if matches!(active_form.get(), RequestFormKind::Overtime) {\n                                    format!(\"{base} bg-surface-elevated text-fg shadow-sm transition-all duration-300\")\n                                } else {\n                                    format!(\"{base} text-fg-muted hover:text-fg\")\n                                }\n                            }\n                            on:click=move |_| set_active_form.set(RequestFormKind::Overtime)\n                        \u003e\n                            {\"残業申請\"}\n                        \u003c/button\u003e\n                    \u003c/div\u003e\n                    \u003cShow when=move || matches!(active_form.get(), RequestFormKind::Leave)\u003e\n                        \u003cLeaveRequestForm\n                            state=leave_state\n                            message=leave_message\n                            action=leave_action\n                            update_action=update_action\n                            editing=editing_request\n                            on_cancel_edit=on_cancel_leave\n                        /\u003e\n                    \u003c/Show\u003e\n                    \u003cShow when=move || matches!(active_form.get(), RequestFormKind::Overtime)\u003e\n                        \u003cOvertimeRequestForm\n                            state=overtime_state\n                            message=overtime_message\n                            action=overtime_action\n                            update_action=update_action\n                            editing=editing_request\n                            on_cancel_edit=on_cancel_overtime\n                        /\u003e\n                    \u003c/Show\u003e\n                \u003c/div\u003e\n                \u003cdiv class=\"hidden lg:grid grid-cols-1 gap-6 lg:grid-cols-2\"\u003e\n                    \u003cLeaveRequestForm\n                        state=leave_state\n                        message=leave_message\n                        action=leave_action\n                        update_action=update_action\n                        editing=editing_request\n                        on_cancel_edit=on_cancel_leave\n                    /\u003e\n                    \u003cOvertimeRequestForm\n                        state=overtime_state\n                        message=overtime_message\n                        action=overtime_action\n                        update_action=update_action\n                        editing=editing_request\n                        on_cancel_edit=on_cancel_overtime\n                    /\u003e\n                \u003c/div\u003e\n                \u003cRequestsFilter filter_state=filter_state /\u003e\n                \u003cRequestsList\n                    summaries=filtered_summaries\n                    loading=requests_resource.loading()\n                    error=Signal::derive(move || requests_resource.get().and_then(|result| result.err()))\n                    on_select=Callback::new(move |s| selected_request.set(Some(s)))\n                    on_edit=on_edit\n                    on_cancel=on_cancel_request\n                    message=list_message\n                /\u003e\n            \u003c/RequestsLayout\u003e\n            \u003cRequestDetailModal selected=selected_request /\u003e\n        \u003c/\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","repository.rs"],"content":"use crate::api::{\n    ApiClient, ApiError, CreateLeaveRequest, CreateOvertimeRequest, LeaveRequestResponse,\n    OvertimeRequestResponse,\n};\nuse serde_json::Value;\nuse std::rc::Rc;\n\nuse super::types::MyRequestsResponse;\n\n#[derive(Clone)]\npub struct RequestsRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl RequestsRepository {\n    pub fn new(api: ApiClient) -\u003e Self {\n        Self {\n            client: Rc::new(api),\n        }\n    }\n\n    pub async fn submit_leave(\n        \u0026self,\n        payload: CreateLeaveRequest,\n    ) -\u003e Result\u003cLeaveRequestResponse, ApiError\u003e {\n        self.client.create_leave_request(payload).await\n    }\n\n    pub async fn submit_overtime(\n        \u0026self,\n        payload: CreateOvertimeRequest,\n    ) -\u003e Result\u003cOvertimeRequestResponse, ApiError\u003e {\n        self.client.create_overtime_request(payload).await\n    }\n\n    pub async fn update_request(\u0026self, id: \u0026str, payload: Value) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.update_request(id, payload).await.map(|_| ())\n    }\n\n    pub async fn cancel_request(\u0026self, id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n        self.client.cancel_request(id).await.map(|_| ())\n    }\n\n    pub async fn list_my_requests(\u0026self) -\u003e Result\u003cMyRequestsResponse, ApiError\u003e {\n        let value: Value = self.client.get_my_requests().await?;\n        serde_json::from_value(value)\n            .map_err(|err| ApiError::unknown(format!(\"Failed to parse requests response: {}\", err)))\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","types.rs"],"content":"use serde::{Deserialize, Serialize};\nuse serde_json::Value;\n\n#[derive(Debug, Clone, Deserialize, Serialize, Default)]\npub struct MyRequestsResponse {\n    #[serde(default)]\n    pub leave_requests: Vec\u003cValue\u003e,\n    #[serde(default)]\n    pub overtime_requests: Vec\u003cValue\u003e,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum RequestKind {\n    Leave,\n    Overtime,\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub struct RequestSummary {\n    pub id: String,\n    pub kind: RequestKind,\n    pub status: String,\n    pub submitted_at: Option\u003cString\u003e,\n    pub primary_label: Option\u003cString\u003e,\n    pub secondary_label: Option\u003cString\u003e,\n    pub reason: Option\u003cString\u003e,\n    pub details: Value,\n}\n\nimpl RequestSummary {\n    pub fn from_leave(value: \u0026Value) -\u003e Self {\n        let start = value\n            .get(\"start_date\")\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string());\n        let end = value\n            .get(\"end_date\")\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string());\n        let primary_label = match (start, end) {\n            (Some(s), Some(e)) if s != e =\u003e Some(format!(\"{} 〜 {}\", s, e)),\n            (Some(s), _) =\u003e Some(s),\n            _ =\u003e None,\n        };\n        Self {\n            id: extract_string(value, \"id\"),\n            kind: RequestKind::Leave,\n            status: extract_string(value, \"status\"),\n            submitted_at: value\n                .get(\"created_at\")\n                .and_then(|v| v.as_str())\n                .map(|s| s.to_string()),\n            primary_label,\n            secondary_label: value\n                .get(\"leave_type\")\n                .and_then(|v| v.as_str())\n                .map(|s| s.to_string()),\n            reason: value\n                .get(\"reason\")\n                .and_then(|v| v.as_str())\n                .map(|s| s.to_string()),\n            details: value.clone(),\n        }\n    }\n\n    pub fn from_overtime(value: \u0026Value) -\u003e Self {\n        let hours = value\n            .get(\"planned_hours\")\n            .and_then(|v| v.as_f64())\n            .map(|h| format!(\"{} 時間\", h));\n        Self {\n            id: extract_string(value, \"id\"),\n            kind: RequestKind::Overtime,\n            status: extract_string(value, \"status\"),\n            submitted_at: value\n                .get(\"created_at\")\n                .and_then(|v| v.as_str())\n                .map(|s| s.to_string()),\n            primary_label: value\n                .get(\"date\")\n                .and_then(|v| v.as_str())\n                .map(|s| s.to_string()),\n            secondary_label: hours,\n            reason: value\n                .get(\"reason\")\n                .and_then(|v| v.as_str())\n                .map(|s| s.to_string()),\n            details: value.clone(),\n        }\n    }\n}\n\nfn extract_string(value: \u0026Value, key: \u0026str) -\u003e String {\n    value\n        .get(key)\n        .and_then(|v| v.as_str())\n        .map(|s| s.to_string())\n        .filter(|s| !s.is_empty())\n        .unwrap_or_else(|| \"unknown\".into())\n}\n\npub fn flatten_requests(response: \u0026MyRequestsResponse) -\u003e Vec\u003cRequestSummary\u003e {\n    let mut list: Vec\u003cRequestSummary\u003e = response\n        .leave_requests\n        .iter()\n        .map(RequestSummary::from_leave)\n        .chain(\n            response\n                .overtime_requests\n                .iter()\n                .map(RequestSummary::from_overtime),\n        )\n        .collect();\n    list.sort_by(|a, b| b.submitted_at.cmp(\u0026a.submitted_at));\n    list\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n\n    #[test]\n    fn summarizes_leave_request() {\n        let value = json!({\n            \"id\": \"req-1\",\n            \"status\": \"pending\",\n            \"start_date\": \"2025-01-10\",\n            \"end_date\": \"2025-01-12\",\n            \"leave_type\": \"annual\",\n            \"reason\": \"family\",\n            \"created_at\": \"2025-01-05T10:00:00Z\"\n        });\n        let summary = RequestSummary::from_leave(\u0026value);\n        assert_eq!(summary.id, \"req-1\");\n        assert_eq!(summary.status, \"pending\");\n        assert_eq!(\n            summary.primary_label.as_deref(),\n            Some(\"2025-01-10 〜 2025-01-12\")\n        );\n        assert_eq!(summary.secondary_label.as_deref(), Some(\"annual\"));\n    }\n\n    #[test]\n    fn summarizes_overtime_request() {\n        let value = json!({\n            \"id\": \"ot-1\",\n            \"status\": \"approved\",\n            \"date\": \"2025-01-15\",\n            \"planned_hours\": 3.5,\n            \"reason\": \"deploy\",\n            \"created_at\": \"2025-01-14T09:00:00Z\"\n        });\n        let summary = RequestSummary::from_overtime(\u0026value);\n        assert_eq!(summary.kind, RequestKind::Overtime);\n        assert_eq!(summary.primary_label.as_deref(), Some(\"2025-01-15\"));\n        assert_eq!(summary.secondary_label.as_deref(), Some(\"3.5 時間\"));\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","utils.rs"],"content":"use crate::api::{ApiError, CreateLeaveRequest, CreateOvertimeRequest};\nuse chrono::NaiveDate;\nuse leptos::*;\nuse serde_json::Value;\n\nuse super::types::RequestKind;\n\n#[derive(Clone, PartialEq, Eq)]\npub struct EditTarget {\n    pub id: String,\n    pub kind: RequestKind,\n}\n\n#[derive(Clone, Copy)]\npub struct LeaveFormState {\n    leave_type: RwSignal\u003cString\u003e,\n    start_date: RwSignal\u003cString\u003e,\n    end_date: RwSignal\u003cString\u003e,\n    reason: RwSignal\u003cString\u003e,\n}\n\nimpl Default for LeaveFormState {\n    fn default() -\u003e Self {\n        Self {\n            leave_type: create_rw_signal(\"annual\".to_string()),\n            start_date: create_rw_signal(String::new()),\n            end_date: create_rw_signal(String::new()),\n            reason: create_rw_signal(String::new()),\n        }\n    }\n}\n\n#[derive(Clone, Copy)]\npub struct OvertimeFormState {\n    date: RwSignal\u003cString\u003e,\n    hours: RwSignal\u003cString\u003e,\n    reason: RwSignal\u003cString\u003e,\n}\n\n#[derive(Clone, Copy)]\npub struct RequestFilterState {\n    status: RwSignal\u003cString\u003e,\n}\n\nimpl LeaveFormState {\n    pub fn leave_type_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.leave_type\n    }\n\n    pub fn start_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.start_date\n    }\n\n    pub fn end_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.end_date\n    }\n\n    pub fn reason_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.reason\n    }\n\n    pub fn reset(\u0026self) {\n        self.leave_type.set(\"annual\".into());\n        self.start_date.set(String::new());\n        self.end_date.set(String::new());\n        self.reason.set(String::new());\n    }\n\n    pub fn load_from_value(\u0026self, value: \u0026Value) {\n        if let Some(leave_type) = value.get(\"leave_type\").and_then(|v| v.as_str()) {\n            self.leave_type.set(leave_type.to_string());\n        }\n        if let Some(start) = value.get(\"start_date\").and_then(|v| v.as_str()) {\n            self.start_date.set(start.to_string());\n        }\n        if let Some(end) = value.get(\"end_date\").and_then(|v| v.as_str()) {\n            self.end_date.set(end.to_string());\n        }\n        if let Some(reason) = value.get(\"reason\").and_then(|v| v.as_str()) {\n            self.reason.set(reason.to_string());\n        }\n    }\n\n    pub fn to_payload(self) -\u003e Result\u003cCreateLeaveRequest, ApiError\u003e {\n        let start = parse_date(\n            \u0026self.start_date.get(),\n            \"開始日を YYYY-MM-DD 形式で入力してください。\",\n        )?;\n        let end = parse_date(\n            \u0026self.end_date.get(),\n            \"終了日を YYYY-MM-DD 形式で入力してください。\",\n        )?;\n        if end \u003c start {\n            return Err(ApiError::validation(\n                \"終了日は開始日以降の日付を指定してください。\",\n            ));\n        }\n        Ok(CreateLeaveRequest {\n            leave_type: self.leave_type.get(),\n            start_date: start,\n            end_date: end,\n            reason: optional_string(self.reason.get()),\n        })\n    }\n}\n\nimpl Default for OvertimeFormState {\n    fn default() -\u003e Self {\n        Self {\n            date: create_rw_signal(String::new()),\n            hours: create_rw_signal(String::new()),\n            reason: create_rw_signal(String::new()),\n        }\n    }\n}\n\nimpl OvertimeFormState {\n    pub fn date_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.date\n    }\n\n    pub fn hours_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.hours\n    }\n\n    pub fn reason_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.reason\n    }\n\n    pub fn reset(\u0026self) {\n        self.date.set(String::new());\n        self.hours.set(String::new());\n        self.reason.set(String::new());\n    }\n\n    pub fn load_from_value(\u0026self, value: \u0026Value) {\n        if let Some(date) = value.get(\"date\").and_then(|v| v.as_str()) {\n            self.date.set(date.to_string());\n        }\n        if let Some(hours) = value.get(\"planned_hours\").and_then(|v| v.as_f64()) {\n            self.hours.set(format!(\"{:.2}\", hours));\n        }\n        if let Some(reason) = value.get(\"reason\").and_then(|v| v.as_str()) {\n            self.reason.set(reason.to_string());\n        }\n    }\n\n    pub fn to_payload(self) -\u003e Result\u003cCreateOvertimeRequest, ApiError\u003e {\n        let date = parse_date(\n            \u0026self.date.get(),\n            \"残業日を YYYY-MM-DD 形式で入力してください。\",\n        )?;\n        let hours_raw = self.hours.get();\n        let hours = hours_raw\n            .trim()\n            .parse::\u003cf64\u003e()\n            .map_err(|_| ApiError::validation(\"残業時間は数値で入力してください。\"))?;\n        if !(0.25..=24.0).contains(\u0026hours) {\n            return Err(ApiError::validation(\n                \"残業時間は0.25〜24.0の範囲で指定してください。\",\n            ));\n        }\n        Ok(CreateOvertimeRequest {\n            date,\n            planned_hours: hours,\n            reason: optional_string(self.reason.get()),\n        })\n    }\n}\n\n#[derive(Clone, Default)]\npub struct MessageState {\n    pub success: Option\u003cString\u003e,\n    pub error: Option\u003cApiError\u003e,\n}\n\nimpl MessageState {\n    pub fn set_success(\u0026mut self, msg: impl Into\u003cString\u003e) {\n        self.success = Some(msg.into());\n        self.error = None;\n    }\n\n    pub fn set_error(\u0026mut self, msg: ApiError) {\n        self.error = Some(msg);\n        self.success = None;\n    }\n\n    pub fn clear(\u0026mut self) {\n        self.success = None;\n        self.error = None;\n    }\n}\n\nimpl Default for RequestFilterState {\n    fn default() -\u003e Self {\n        Self {\n            status: create_rw_signal(String::new()),\n        }\n    }\n}\n\nimpl RequestFilterState {\n    pub fn status_signal(\u0026self) -\u003e RwSignal\u003cString\u003e {\n        self.status\n    }\n\n    pub fn status_filter(\u0026self) -\u003e String {\n        self.status.get()\n    }\n}\n\nfn parse_date(input: \u0026str, err: \u0026str) -\u003e Result\u003cNaiveDate, ApiError\u003e {\n    NaiveDate::parse_from_str(input.trim(), \"%Y-%m-%d\")\n        .map_err(|_| ApiError::validation(err.to_string()))\n}\n\nfn optional_string(value: String) -\u003e Option\u003cString\u003e {\n    let trimmed = value.trim().to_string();\n    if trimmed.is_empty() {\n        None\n    } else {\n        Some(trimmed)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn leave_form_rejects_invalid_dates() {\n        let state = LeaveFormState::default();\n        state.start_signal().set(\"2025-01-10\".into());\n        state.end_signal().set(\"2025-01-05\".into());\n        assert!(state.to_payload().is_err());\n    }\n\n    #[test]\n    fn overtime_form_validates_hours() {\n        let state = OvertimeFormState::default();\n        state.date_signal().set(\"2025-01-15\".into());\n        state.hours_signal().set(\"0.1\".into());\n        assert!(state.to_payload().is_err());\n        state.hours_signal().set(\"2.5\".into());\n        assert!(state.to_payload().is_ok());\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","requests","view_model.rs"],"content":"use crate::api::{ApiClient, ApiError, CreateLeaveRequest, CreateOvertimeRequest};\nuse crate::pages::requests::types::MyRequestsResponse;\nuse crate::pages::requests::{\n    repository::RequestsRepository,\n    types::{flatten_requests, RequestSummary},\n    utils::{EditTarget, LeaveFormState, MessageState, OvertimeFormState, RequestFilterState},\n};\nuse leptos::*;\n\n#[derive(Clone, Copy)]\npub struct RequestsViewModel {\n    pub leave_state: LeaveFormState,\n    pub overtime_state: OvertimeFormState,\n    pub filter_state: RequestFilterState,\n    pub leave_message: RwSignal\u003cMessageState\u003e,\n    pub overtime_message: RwSignal\u003cMessageState\u003e,\n    pub list_message: RwSignal\u003cMessageState\u003e,\n    pub selected_request: RwSignal\u003cOption\u003cRequestSummary\u003e\u003e,\n    pub editing_request: RwSignal\u003cOption\u003cEditTarget\u003e\u003e,\n    pub active_form: ReadSignal\u003cRequestFormKind\u003e,\n    pub set_active_form: WriteSignal\u003cRequestFormKind\u003e,\n    pub requests_resource: Resource\u003cu32, Result\u003cMyRequestsResponse, ApiError\u003e\u003e,\n    pub leave_action: Action\u003cCreateLeaveRequest, Result\u003c(), ApiError\u003e\u003e,\n    pub overtime_action: Action\u003cCreateOvertimeRequest, Result\u003c(), ApiError\u003e\u003e,\n    pub update_action: Action\u003cEditPayload, Result\u003c(), ApiError\u003e\u003e,\n    pub cancel_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n}\n\n#[derive(Clone, Copy, Debug, PartialEq, Eq)]\npub enum RequestFormKind {\n    Leave,\n    Overtime,\n}\n\n#[derive(Clone)]\npub struct EditPayload {\n    pub id: String,\n    pub body: serde_json::Value,\n}\n\nimpl From\u003c(String, serde_json::Value)\u003e for EditPayload {\n    fn from(value: (String, serde_json::Value)) -\u003e Self {\n        Self {\n            id: value.0,\n            body: value.1,\n        }\n    }\n}\n\nimpl RequestsViewModel {\n    pub fn new() -\u003e Self {\n        let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n        let repository = store_value(RequestsRepository::new(api));\n\n        let leave_state = LeaveFormState::default();\n        let overtime_state = OvertimeFormState::default();\n        let filter_state = RequestFilterState::default();\n        let leave_message = create_rw_signal(MessageState::default());\n        let overtime_message = create_rw_signal(MessageState::default());\n        let list_message = create_rw_signal(MessageState::default());\n        let selected_request = create_rw_signal(None::\u003cRequestSummary\u003e);\n        let editing_request = create_rw_signal(None::\u003cEditTarget\u003e);\n        let reload = create_rw_signal(0u32);\n        let (active_form, set_active_form) = create_signal(RequestFormKind::Leave);\n\n        let requests_resource = create_resource(\n            move || reload.get(),\n            move |_| {\n                let repo = repository.get_value();\n                async move { repo.list_my_requests().await }\n            },\n        );\n\n        let leave_action = create_action(move |payload: \u0026CreateLeaveRequest| {\n            let repo = repository.get_value();\n            let payload = payload.clone();\n            async move {\n                match repo.submit_leave(payload).await {\n                    Ok(_) =\u003e Ok(()),\n                    Err(e) =\u003e Err(e),\n                }\n            }\n        });\n\n        let overtime_action = create_action(move |payload: \u0026CreateOvertimeRequest| {\n            let repo = repository.get_value();\n            let payload = payload.clone();\n            async move {\n                match repo.submit_overtime(payload).await {\n                    Ok(_) =\u003e Ok(()),\n                    Err(e) =\u003e Err(e),\n                }\n            }\n        });\n\n        let update_action = create_action(move |payload: \u0026EditPayload| {\n            let repo = repository.get_value();\n            let payload = payload.clone();\n            async move { repo.update_request(\u0026payload.id, payload.body.clone()).await }\n        });\n\n        let cancel_action = create_action(move |id: \u0026String| {\n            let repo = repository.get_value();\n            let id = id.clone();\n            async move { repo.cancel_request(\u0026id).await }\n        });\n\n        // Setup effects for actions\n        {\n            create_effect(move |_| {\n                if let Some(result) = update_action.value().get() {\n                    match result {\n                        Ok(_) =\u003e {\n                            list_message.update(|msg| msg.set_success(\"申請内容を更新しました。\"));\n                            editing_request.set(None);\n                            leave_state.reset();\n                            // Note: reset() for overtime_state is handled by the caller or needed here?\n                            // In original code it was both.\n                            reload.update(|value| *value = value.wrapping_add(1));\n                        }\n                        Err(err) =\u003e list_message.update(|msg| msg.set_error(err)),\n                    }\n                }\n            });\n        }\n\n        {\n            create_effect(move |_| {\n                if let Some(result) = cancel_action.value().get() {\n                    match result {\n                        Ok(_) =\u003e {\n                            list_message.update(|msg| msg.set_success(\"申請を取消しました。\"));\n                            reload.update(|value| *value = value.wrapping_add(1));\n                        }\n                        Err(err) =\u003e list_message.update(|msg| msg.set_error(err)),\n                    }\n                }\n            });\n        }\n\n        {\n            create_effect(move |_| {\n                if let Some(result) = leave_action.value().get() {\n                    match result {\n                        Ok(_) =\u003e {\n                            leave_message.update(|msg| msg.set_success(\"休暇申請を送信しました。\"));\n                            reload.update(|value| *value = value.wrapping_add(1));\n                        }\n                        Err(err) =\u003e leave_message.update(|msg| msg.set_error(err)),\n                    }\n                }\n            });\n        }\n\n        {\n            create_effect(move |_| {\n                if let Some(result) = overtime_action.value().get() {\n                    match result {\n                        Ok(_) =\u003e {\n                            overtime_message\n                                .update(|msg| msg.set_success(\"残業申請を送信しました。\"));\n                            reload.update(|value| *value = value.wrapping_add(1));\n                        }\n                        Err(err) =\u003e overtime_message.update(|msg| msg.set_error(err)),\n                    }\n                }\n            });\n        }\n\n        Self {\n            leave_state,\n            overtime_state,\n            filter_state,\n            leave_message,\n            overtime_message,\n            list_message,\n            selected_request,\n            editing_request,\n            active_form,\n            set_active_form,\n            requests_resource,\n            leave_action,\n            overtime_action,\n            update_action,\n            cancel_action,\n        }\n    }\n\n    pub fn filtered_summaries(\u0026self) -\u003e Signal\u003cVec\u003cRequestSummary\u003e\u003e {\n        let requests_resource = self.requests_resource;\n        let all_summaries = create_memo(move |_| {\n            requests_resource\n                .get()\n                .and_then(|result| result.ok())\n                .map(|data| flatten_requests(\u0026data))\n                .unwrap_or_default()\n        });\n        let filter_state = self.filter_state;\n        Signal::derive(move || {\n            let status = filter_state.status_filter();\n            if status.is_empty() {\n                return all_summaries.get();\n            }\n            all_summaries.with(|summaries| {\n                summaries\n                    .iter()\n                    .filter(|summary| summary.status == status)\n                    .cloned()\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n            })\n        })\n    }\n\n    pub fn on_edit(\u0026self) -\u003e Callback\u003cRequestSummary\u003e {\n        let leave_state = self.leave_state;\n        let overtime_state = self.overtime_state;\n        let list_message = self.list_message;\n        let editing_request = self.editing_request;\n        let set_active_form = self.set_active_form;\n\n        Callback::new(move |summary: RequestSummary| {\n            list_message.update(|msg| msg.clear());\n            let target = EditTarget {\n                id: summary.id.clone(),\n                kind: summary.kind,\n            };\n            editing_request.set(Some(target));\n            match summary.kind {\n                crate::pages::requests::types::RequestKind::Leave =\u003e {\n                    leave_state.load_from_value(\u0026summary.details);\n                    set_active_form.set(RequestFormKind::Leave);\n                }\n                crate::pages::requests::types::RequestKind::Overtime =\u003e {\n                    overtime_state.load_from_value(\u0026summary.details);\n                    set_active_form.set(RequestFormKind::Overtime);\n                }\n            }\n        })\n    }\n\n    pub fn on_cancel_request(\u0026self) -\u003e Callback\u003cRequestSummary\u003e {\n        let leave_state = self.leave_state;\n        let overtime_state = self.overtime_state;\n        let editing_request = self.editing_request;\n        let cancel_action = self.cancel_action;\n\n        Callback::new(move |summary: RequestSummary| {\n            editing_request.set(None);\n            leave_state.reset();\n            overtime_state.reset();\n            cancel_action.dispatch(summary.id.clone());\n        })\n    }\n}\n\npub fn use_requests_view_model() -\u003e RequestsViewModel {\n    match use_context::\u003cRequestsViewModel\u003e() {\n        Some(vm) =\u003e vm,\n        None =\u003e {\n            let vm = RequestsViewModel::new();\n            provide_context(vm.clone());\n            vm\n        }\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","reset_password","mod.rs"],"content":"use leptos::*;\n\nmod panel;\nmod repository;\nmod view_model;\n\npub use panel::ResetPasswordPanel;\n\n#[component]\npub fn ResetPasswordPage() -\u003e impl IntoView {\n    view! { \u003cResetPasswordPanel /\u003e }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","reset_password","panel.rs"],"content":"use super::view_model::use_reset_password_view_model;\nuse leptos::*;\nuse leptos_router::*;\n\n#[component]\npub fn ResetPasswordPanel() -\u003e impl IntoView {\n    let vm = use_reset_password_view_model();\n    let password = vm.password;\n    let error = vm.error;\n    let success = vm.success;\n    let submit_action = vm.submit_action;\n\n    let pending = submit_action.pending();\n\n    view! {\n        \u003cdiv class=\"min-h-screen flex items-center justify-center bg-surface py-12 px-4 sm:px-6 lg:px-8\"\u003e\n            \u003cdiv class=\"max-w-md w-full space-y-8\"\u003e\n                \u003cdiv\u003e\n                    \u003ch2 class=\"mt-6 text-center text-3xl font-extrabold text-fg\"\u003e\n                        \"Set new password\"\n                    \u003c/h2\u003e\n                \u003c/div\u003e\n\n                {move || {\n                    if let Some(msg) = success.get() {\n                        view! {\n                            \u003cdiv class=\"rounded-md bg-status-success-bg p-4 text-status-success-text\"\u003e\n                                \u003cdiv class=\"flex\"\u003e\n                                    \u003cdiv class=\"flex-shrink-0\"\u003e\n                                        \u003csvg\n                                            class=\"h-5 w-5 text-status-success-text\"\n                                            viewBox=\"0 0 20 20\"\n                                            fill=\"currentColor\"\n                                        \u003e\n                                            \u003cpath\n                                                fill-rule=\"evenodd\"\n                                                d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\"\n                                                clip-rule=\"evenodd\"\n                                            \u003e\u003c/path\u003e\n                                        \u003c/svg\u003e\n                                    \u003c/div\u003e\n                                    \u003cdiv class=\"ml-3\"\u003e\n                                        \u003ch3 class=\"text-sm font-medium text-status-success-text\"\u003e\n                                            \"Success!\"\n                                        \u003c/h3\u003e\n                                        \u003cdiv class=\"mt-2 text-sm text-status-success-text\"\u003e\n                                            \u003cp\u003e{msg}\u003c/p\u003e\n                                        \u003c/div\u003e\n                                        \u003cdiv class=\"mt-4\"\u003e\n                                            \u003cdiv class=\"-mx-2 -my-1.5 flex\"\u003e\n                                                \u003cA\n                                                    href=\"/login\"\n                                                    class=\"px-2 py-1.5 rounded-md text-sm font-medium text-status-success-text hover:bg-status-success-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-status-success-bg focus:ring-status-success-border\"\n                                                \u003e\n                                                    \"Go to login\"\n                                                \u003c/A\u003e\n                                            \u003c/div\u003e\n                                        \u003c/div\u003e\n                                    \u003c/div\u003e\n                                \u003c/div\u003e\n                            \u003c/div\u003e\n                        }\n                            .into_view()\n                    } else {\n                        view! {\n                            \u003cform\n                                class=\"mt-8 space-y-6\"\n                                on:submit=move |ev| {\n                                    ev.prevent_default();\n                                    submit_action.dispatch(password.get());\n                                }\n                            \u003e\n                                \u003cdiv class=\"rounded-md shadow-sm -space-y-px\"\u003e\n                                    \u003cdiv\u003e\n                                        \u003clabel for=\"password\" class=\"sr-only\"\u003e\n                                            \"New Password\"\n                                        \u003c/label\u003e\n                                        \u003cinput\n                                            id=\"password\"\n                                            name=\"password\"\n                                            type=\"password\"\n                                            required\n                                            class=\"appearance-none rounded-md relative block w-full px-3 py-2 border border-form-control-border bg-form-control-bg placeholder-form-control-placeholder text-form-control-text focus:outline-none focus:ring-2 focus:ring-action-primary-focus focus:border-action-primary-border focus:z-10 sm:text-sm\"\n                                            placeholder=\"New Password\"\n                                            prop:value=password\n                                            on:input=move |ev| {\n                                                password.set(event_target_value(\u0026ev));\n                                            }\n                                        /\u003e\n                                    \u003c/div\u003e\n                                \u003c/div\u003e\n\n                                {move || {\n                                    if let Some(err) = error.get() {\n                                        view! {\n                                            \u003cdiv class=\"rounded-md bg-status-error-bg p-4 text-status-error-text\"\u003e\n                                                \u003cdiv class=\"flex\"\u003e\n                                                    \u003cdiv class=\"ml-3\"\u003e\n                                                        \u003ch3 class=\"text-sm font-medium text-status-error-text\"\u003e\n                                                            \"Error\"\n                                                        \u003c/h3\u003e\n                                                        \u003cdiv class=\"mt-2 text-sm text-status-error-text\"\u003e\n                                                            \u003cp\u003e{err}\u003c/p\u003e\n                                                        \u003c/div\u003e\n                                                    \u003c/div\u003e\n                                                \u003c/div\u003e\n                                            \u003c/div\u003e\n                                        }\n                                            .into_view()\n                                    } else {\n                                        view! {}.into_view()\n                                    }\n                                }}\n\n                                \u003cdiv\u003e\n                                    \u003cbutton\n                                        type=\"submit\"\n                                        disabled=move || pending.get()\n                                        class=\"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-action-primary-text bg-action-primary-bg hover:bg-action-primary-bg-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-action-primary-focus disabled:opacity-50\"\n                                    \u003e\n                                        \u003cspan class=\"absolute left-0 inset-y-0 flex items-center pl-3\"\u003e\n                                            \u003csvg\n                                                class=\"h-5 w-5 text-action-primary-text/70 group-hover:text-action-primary-text\"\n                                                xmlns=\"http://www.w3.org/2000/svg\"\n                                                viewBox=\"0 0 20 20\"\n                                                fill=\"currentColor\"\n                                                aria-hidden=\"true\"\n                                            \u003e\n                                                \u003cpath\n                                                    fill-rule=\"evenodd\"\n                                                    d=\"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z\"\n                                                    clip-rule=\"evenodd\"\n                                                \u003e\u003c/path\u003e\n                                            \u003c/svg\u003e\n                                        \u003c/span\u003e\n                                        {move || {\n                                            if pending.get() { \"Resetting...\" } else { \"Reset Password\" }\n                                        }}\n\n                                    \u003c/button\u003e\n                                \u003c/div\u003e\n                            \u003c/form\u003e\n                        }\n                            .into_view()\n                    }\n                }}\n\n            \u003c/div\u003e\n        \u003c/div\u003e\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","reset_password","repository.rs"],"content":"use crate::api::{ApiClient, ApiError, MessageResponse};\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct ResetPasswordRepository {\n    client: Rc\u003cApiClient\u003e,\n}\n\nimpl ResetPasswordRepository {\n    pub fn new_with_client(client: Rc\u003cApiClient\u003e) -\u003e Self {\n        Self { client }\n    }\n\n    pub async fn reset_password(\n        \u0026self,\n        token: String,\n        new_password: String,\n    ) -\u003e Result\u003cMessageResponse, ApiError\u003e {\n        self.client.reset_password(token, new_password).await\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","reset_password","view_model.rs"],"content":"use super::repository::ResetPasswordRepository;\nuse crate::api::{ApiClient, ApiError, MessageResponse};\nuse leptos::*;\nuse leptos_router::use_query_map;\nuse std::rc::Rc;\n\n#[derive(Clone)]\npub struct ResetPasswordViewModel {\n    pub password: RwSignal\u003cString\u003e,\n    pub error: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub success: RwSignal\u003cOption\u003cString\u003e\u003e,\n    pub submit_action: Action\u003cString, Result\u003cMessageResponse, ApiError\u003e\u003e,\n}\n\npub fn use_reset_password_view_model() -\u003e ResetPasswordViewModel {\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repository = ResetPasswordRepository::new_with_client(Rc::new(api));\n    let query = use_query_map();\n    let token = Signal::derive(move || query.get().get(\"token\").cloned().unwrap_or_default());\n\n    let password = create_rw_signal(String::new());\n    let error = create_rw_signal(None);\n    let success = create_rw_signal(None);\n\n    let repo_for_submit = repository.clone();\n    let token_for_submit = token.clone();\n    let submit_action = create_action(move |value: \u0026String| {\n        let repo = repo_for_submit.clone();\n        let token = token_for_submit.get();\n        let value = value.clone();\n        async move {\n            let (token, new_password) = validate_reset_input(\u0026token, \u0026value)?;\n            repo.reset_password(token, new_password).await\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = submit_action.value().get() {\n            match result {\n                Ok(resp) =\u003e {\n                    success.set(Some(resp.message));\n                    error.set(None);\n                }\n                Err(err) =\u003e {\n                    error.set(Some(err.to_string()));\n                    success.set(None);\n                }\n            }\n        }\n    });\n\n    ResetPasswordViewModel {\n        password,\n        error,\n        success,\n        submit_action,\n    }\n}\n\nfn validate_reset_input(token: \u0026str, new_password: \u0026str) -\u003e Result\u003c(String, String), ApiError\u003e {\n    let token = token.trim();\n    if token.is_empty() {\n        return Err(ApiError::validation(\"Invalid token\"));\n    }\n    let new_password = new_password.trim();\n    if new_password.is_empty() {\n        return Err(ApiError::validation(\"Password is required\"));\n    }\n    Ok((token.to_string(), new_password.to_string()))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    #[wasm_bindgen_test]\n    fn validate_reset_input_rejects_empty_token() {\n        let err = validate_reset_input(\"\", \"password\").expect_err(\"should fail\");\n        assert_eq!(err.code, \"VALIDATION_ERROR\");\n    }\n\n    #[wasm_bindgen_test]\n    fn validate_reset_input_rejects_empty_password() {\n        let err = validate_reset_input(\"token\", \" \").expect_err(\"should fail\");\n        assert_eq!(err.code, \"VALIDATION_ERROR\");\n    }\n\n    #[wasm_bindgen_test]\n    fn validate_reset_input_trims_values() {\n        let (token, password) =\n            validate_reset_input(\"  token  \", \"  NewPass123!  \").expect(\"valid\");\n        assert_eq!(token, \"token\");\n        assert_eq!(password, \"NewPass123!\");\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","settings","mod.rs"],"content":"pub mod panel;\npub mod repository;\npub mod view_model;\n\npub use panel::SettingsPage;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","settings","panel.rs"],"content":"use crate::{\n    api::{ApiError, CreateDataSubjectRequest, DataSubjectRequestType},\n    components::{\n        error::InlineErrorMessage,\n        layout::{ErrorMessage, Layout, SuccessMessage},\n    },\n    pages::{\n        mfa::{\n            components::{setup::SetupSection, verify::VerificationSection},\n            utils,\n        },\n        settings::view_model::use_settings_view_model,\n    },\n};\nuse chrono::{DateTime, Utc};\nuse leptos::{ev::SubmitEvent, Callback, *};\n\nfn map_change_password_error(error: \u0026ApiError) -\u003e ApiError {\n    match error.error.as_str() {\n        \"Current password is incorrect\" =\u003e {\n            ApiError::validation(\"現在のパスワードが正しくありません。\")\n        }\n        \"New password must be at least 8 characters\" =\u003e {\n            ApiError::validation(\"新しいパスワードは8文字以上である必要があります。\")\n        }\n        \"New password must differ from current password\" =\u003e {\n            ApiError::validation(\"新しいパスワードは現在のパスワードと異なる必要があります。\")\n        }\n        _ =\u003e ApiError::unknown(\"パスワード変更に失敗しました。時間をおいて再度お試しください。\"),\n    }\n}\n\n#[component]\npub fn SettingsPage() -\u003e impl IntoView {\n    let vm = use_settings_view_model();\n\n    // --- Password Change State ---\n    let (current_password, set_current_password) = create_signal(String::new());\n    let (new_password, set_new_password) = create_signal(String::new());\n    let (confirm_password, set_confirm_password) = create_signal(String::new());\n\n    let password_loading = vm.change_password_action.pending();\n    let (password_success_msg, set_password_success_msg) = create_signal(Option::\u003cString\u003e::None);\n    let (password_error_msg, set_password_error_msg) = create_signal(Option::\u003cApiError\u003e::None);\n\n    create_effect(move |_| {\n        if let Some(result) = vm.change_password_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    set_password_success_msg.set(Some(\"パスワードを変更しました。\".to_string()));\n                    set_password_error_msg.set(None);\n                    // Clear inputs\n                    set_current_password.set(String::new());\n                    set_new_password.set(String::new());\n                    set_confirm_password.set(String::new());\n                }\n                Err(e) =\u003e {\n                    set_password_error_msg.set(Some(map_change_password_error(\u0026e)));\n                    set_password_success_msg.set(None);\n                }\n            }\n        }\n    });\n\n    let on_submit_password = move |ev: SubmitEvent| {\n        ev.prevent_default();\n        if password_loading.get() {\n            return;\n        }\n        let current = current_password.get();\n        let new = new_password.get();\n        let confirm = confirm_password.get();\n\n        if new.len() \u003c 8 {\n            set_password_error_msg.set(Some(ApiError::validation(\n                \"新しいパスワードは8文字以上である必要があります。\",\n            )));\n            return;\n        }\n        if new != confirm {\n            set_password_error_msg.set(Some(ApiError::validation(\n                \"新しいパスワードが一致しません。\",\n            )));\n            return;\n        }\n\n        set_password_error_msg.set(None);\n        set_password_success_msg.set(None);\n        vm.change_password_action.dispatch((current, new));\n    };\n\n    // --- MFA State (Reusing MfaViewModel) ---\n    let mfa_vm = vm.mfa_view_model;\n    let register_loading = mfa_vm.register_action.pending();\n    let activate_loading = mfa_vm.activate_action.pending();\n\n    // Logic adapted from MfaRegisterPanel for reuse\n    let start_registration = {\n        move || {\n            if register_loading.get() {\n                return;\n            }\n            mfa_vm.messages.clear();\n            mfa_vm.setup_info.set(None);\n            mfa_vm.register_action.dispatch(());\n        }\n    };\n\n    let handle_activate = {\n        move |ev: SubmitEvent| {\n            ev.prevent_default();\n            if activate_loading.get() {\n                return;\n            }\n            let code_value = mfa_vm.totp_code.get();\n            let trimmed = match utils::validate_totp_code(\u0026code_value) {\n                Ok(code) =\u003e code,\n                Err(msg) =\u003e {\n                    mfa_vm.messages.set_error(msg);\n                    return;\n                }\n            };\n            mfa_vm.messages.clear();\n            mfa_vm.activate_action.dispatch(trimmed);\n        }\n    };\n    let handle_activate_cb = Callback::new(handle_activate);\n\n    // --- Subject Request State ---\n    let subject_vm = vm.subject_request_view_model;\n    let subject_request_type = create_rw_signal(\"access\".to_string());\n    let subject_details = create_rw_signal(String::new());\n    let subject_loading = subject_vm.create_action.pending();\n    let cancel_loading = subject_vm.cancel_action.pending();\n    let cancel_action = subject_vm.cancel_action;\n    let subject_requests_resource = subject_vm.requests_resource;\n    let subject_requests_error = Signal::derive(move || {\n        subject_requests_resource\n            .get()\n            .and_then(|res| res.err())\n            .map(|err| err.to_string())\n    });\n    let subject_requests = Signal::derive(move || {\n        subject_requests_resource\n            .get()\n            .and_then(|res| res.ok())\n            .unwrap_or_default()\n    });\n    let (subject_success_msg, set_subject_success_msg) = create_signal(Option::\u003cString\u003e::None);\n    let (subject_error_msg, set_subject_error_msg) = create_signal(Option::\u003cString\u003e::None);\n\n    create_effect(move |_| {\n        if let Some(result) = subject_vm.create_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    set_subject_success_msg.set(Some(\"本人対応申請を送信しました。\".into()));\n                    set_subject_error_msg.set(None);\n                    subject_details.set(String::new());\n                    subject_vm\n                        .reload\n                        .update(|value| *value = value.wrapping_add(1));\n                }\n                Err(err) =\u003e {\n                    set_subject_error_msg.set(Some(err.to_string()));\n                    set_subject_success_msg.set(None);\n                }\n            }\n        }\n    });\n\n    create_effect(move |_| {\n        if let Some(result) = subject_vm.cancel_action.value().get() {\n            match result {\n                Ok(_) =\u003e {\n                    set_subject_success_msg.set(Some(\"本人対応申請を取消しました。\".into()));\n                    set_subject_error_msg.set(None);\n                    subject_vm\n                        .reload\n                        .update(|value| *value = value.wrapping_add(1));\n                }\n                Err(err) =\u003e {\n                    set_subject_error_msg.set(Some(err.to_string()));\n                    set_subject_success_msg.set(None);\n                }\n            }\n        }\n    });\n\n    let on_submit_subject = move |ev: SubmitEvent| {\n        ev.prevent_default();\n        if subject_loading.get() {\n            return;\n        }\n        let request_type = match subject_request_type.get().as_str() {\n            \"access\" =\u003e DataSubjectRequestType::Access,\n            \"rectify\" =\u003e DataSubjectRequestType::Rectify,\n            \"delete\" =\u003e DataSubjectRequestType::Delete,\n            \"stop\" =\u003e DataSubjectRequestType::Stop,\n            _ =\u003e {\n                set_subject_error_msg.set(Some(\"申請種別を選択してください。\".into()));\n                return;\n            }\n        };\n        let details_raw = subject_details.get();\n        let details = if details_raw.trim().is_empty() {\n            None\n        } else {\n            Some(details_raw.trim().to_string())\n        };\n        set_subject_error_msg.set(None);\n        set_subject_success_msg.set(None);\n        subject_vm.create_action.dispatch(CreateDataSubjectRequest {\n            request_type,\n            details,\n        });\n    };\n\n    view! {\n        \u003cLayout\u003e\n            \u003cdiv class=\"mx-auto max-w-3xl space-y-8\"\u003e\n\n                // --- Password Change Section ---\n                \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n                    \u003ch2 class=\"text-xl font-semibold text-fg border-b border-border pb-2\"\u003e\"パスワード変更\"\u003c/h2\u003e\n\n                    \u003cShow when=move || password_success_msg.get().is_some() fallback=|| ()\u003e\n                        \u003cSuccessMessage message={password_success_msg.get().unwrap_or_default()} /\u003e\n                    \u003c/Show\u003e\n                    \u003cShow when=move || password_error_msg.get().is_some() fallback=|| ()\u003e\n                        \u003cInlineErrorMessage error={password_error_msg.into()} /\u003e\n                    \u003c/Show\u003e\n\n                    \u003cform class=\"space-y-4\" on:submit=on_submit_password\u003e\n                        \u003cdiv\u003e\n                            \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"現在のパスワード\"\u003c/label\u003e\n                            \u003cinput type=\"password\" required\n                                class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-3 py-2\"\n                                on:input=move |ev| set_current_password.set(event_target_value(\u0026ev))\n                                prop:value=current_password\n                            /\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"新しいパスワード\"\u003c/label\u003e\n                            \u003cinput type=\"password\" required\n                                class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-3 py-2\"\n                                on:input=move |ev| set_new_password.set(event_target_value(\u0026ev))\n                                prop:value=new_password\n                            /\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"新しいパスワード（確認）\"\u003c/label\u003e\n                            \u003cinput type=\"password\" required\n                                class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-3 py-2\"\n                                on:input=move |ev| set_confirm_password.set(event_target_value(\u0026ev))\n                                prop:value=confirm_password\n                            /\u003e\n                        \u003c/div\u003e\n                        \u003cdiv class=\"flex justify-end\"\u003e\n                            \u003cbutton type=\"submit\"\n                                class=\"px-4 py-2 bg-action-primary-bg text-action-primary-text rounded hover:bg-action-primary-bg-hover disabled:opacity-50\"\n                                disabled=move || password_loading.get()\n                            \u003e\n                                {move || if password_loading.get() { \"変更中...\" } else { \"パスワードを変更\" }}\n                            \u003c/button\u003e\n                        \u003c/div\u003e\n                    \u003c/form\u003e\n                \u003c/div\u003e\n\n                // --- MFA Section ---\n                // Reusing components from mfa page, but wrapped in our layout\n                \u003cdiv class=\"space-y-6\"\u003e\n                    \u003cSetupSection\n                        status=mfa_vm.status.read_only()\n                        status_loading=mfa_vm.status_loading.read_only()\n                        register_loading=register_loading.into()\n                        on_register=start_registration\n                        on_refresh=move || mfa_vm.fetch_status_action.dispatch(())\n                    /\u003e\n                    \u003cShow when=move || mfa_vm.messages.success.get().is_some() fallback=|| ()\u003e\n                        \u003cSuccessMessage message={mfa_vm.messages.success.get().unwrap_or_default()} /\u003e\n                    \u003c/Show\u003e\n                    \u003cShow when=move || mfa_vm.messages.error.get().is_some() fallback=|| ()\u003e\n                        \u003cInlineErrorMessage error={mfa_vm.messages.error.into()} /\u003e\n                    \u003c/Show\u003e\n                    \u003cVerificationSection\n                        setup_info=mfa_vm.setup_info.read_only()\n                        activate_loading=activate_loading.into()\n                        on_submit=handle_activate_cb\n                        on_input=mfa_vm.totp_code.write_only()\n                    /\u003e\n                \u003c/div\u003e\n\n                // --- Subject Request Section ---\n                \u003cdiv class=\"bg-surface-elevated shadow rounded-lg p-6 space-y-4\"\u003e\n                    \u003ch2 class=\"text-xl font-semibold text-fg border-b border-border pb-2\"\u003e\"本人対応申請\"\u003c/h2\u003e\n                    \u003cShow when=move || subject_success_msg.get().is_some() fallback=|| ()\u003e\n                        \u003cSuccessMessage message={subject_success_msg.get().unwrap_or_default()} /\u003e\n                    \u003c/Show\u003e\n                    \u003cShow when=move || subject_error_msg.get().is_some() fallback=|| ()\u003e\n                        \u003cErrorMessage message={subject_error_msg.get().unwrap_or_default()} /\u003e\n                    \u003c/Show\u003e\n                    \u003cform class=\"space-y-3\" on:submit=on_submit_subject\u003e\n                        \u003cdiv\u003e\n                            \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"申請種別\"\u003c/label\u003e\n                            \u003cselect\n                                class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-3 py-2\"\n                                prop:value={move || subject_request_type.get()}\n                                on:change=move |ev| subject_request_type.set(event_target_value(\u0026ev))\n                            \u003e\n                                \u003coption value=\"access\"\u003e{\"開示\"}\u003c/option\u003e\n                                \u003coption value=\"rectify\"\u003e{\"訂正\"}\u003c/option\u003e\n                                \u003coption value=\"delete\"\u003e{\"削除\"}\u003c/option\u003e\n                                \u003coption value=\"stop\"\u003e{\"停止\"}\u003c/option\u003e\n                            \u003c/select\u003e\n                        \u003c/div\u003e\n                        \u003cdiv\u003e\n                            \u003clabel class=\"block text-sm font-medium text-fg-muted\"\u003e\"詳細\"\u003c/label\u003e\n                            \u003ctextarea\n                                class=\"mt-1 w-full border border-form-control-border bg-form-control-bg text-form-control-text rounded px-3 py-2\"\n                                rows=\"3\"\n                                prop:value={move || subject_details.get()}\n                                on:input=move |ev| subject_details.set(event_target_value(\u0026ev))\n                            \u003e\u003c/textarea\u003e\n                        \u003c/div\u003e\n                        \u003cdiv class=\"flex justify-end\"\u003e\n                            \u003cbutton\n                                type=\"submit\"\n                                class=\"px-4 py-2 bg-action-primary-bg text-action-primary-text rounded disabled:opacity-50\"\n                                disabled=move || subject_loading.get()\n                            \u003e\n                                {move || if subject_loading.get() { \"送信中...\" } else { \"申請する\" }}\n                            \u003c/button\u003e\n                        \u003c/div\u003e\n                    \u003c/form\u003e\n                    \u003cdiv\u003e\n                        \u003ch3 class=\"text-sm font-medium text-fg-muted mb-2\"\u003e{\"申請履歴\"}\u003c/h3\u003e\n                        \u003cShow when=move || subject_requests_error.get().is_some()\u003e\n                            \u003cErrorMessage message={subject_requests_error.get().unwrap_or_default()} /\u003e\n                        \u003c/Show\u003e\n                        \u003cdiv class=\"overflow-x-auto\"\u003e\n                            \u003ctable class=\"min-w-full divide-y divide-border\"\u003e\n                                \u003cthead class=\"bg-surface-muted\"\u003e\n                                    \u003ctr\u003e\n                                        \u003cth class=\"px-4 py-2 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"種別\"}\u003c/th\u003e\n                                        \u003cth class=\"px-4 py-2 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"ステータス\"}\u003c/th\u003e\n                                        \u003cth class=\"px-4 py-2 text-left text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"申請日\"}\u003c/th\u003e\n                                        \u003cth class=\"px-4 py-2 text-right text-xs font-medium text-fg-muted uppercase tracking-wider\"\u003e{\"操作\"}\u003c/th\u003e\n                                    \u003c/tr\u003e\n                                \u003c/thead\u003e\n                                \u003ctbody class=\"bg-surface-elevated divide-y divide-border\"\u003e\n                                    {move || {\n                                        subject_requests\n                                            .get()\n                                            .into_iter()\n                                            .map(|request| {\n                                                let can_cancel = request.status == \"pending\";\n                                                let type_label = subject_request_type_label(\u0026request.request_type);\n                                                let status_label = subject_request_status_label(\u0026request.status);\n                                                let created_label = format_subject_datetime(request.created_at);\n                                                let request_id = request.id.clone();\n                                                let on_cancel = {\n                                                    let request_id = request.id.clone();\n                                                    move |_| cancel_action.dispatch(request_id.clone())\n                                                };\n                                                view! {\n                                                    \u003ctr\u003e\n                                                        \u003ctd class=\"px-4 py-2 whitespace-nowrap text-sm text-fg\"\u003e{type_label}\u003c/td\u003e\n                                                        \u003ctd class=\"px-4 py-2 whitespace-nowrap text-sm text-fg-muted\"\u003e{status_label}\u003c/td\u003e\n                                                        \u003ctd class=\"px-4 py-2 whitespace-nowrap text-sm text-fg-muted\"\u003e{created_label}\u003c/td\u003e\n                                                        \u003ctd class=\"px-4 py-2 whitespace-nowrap text-right text-sm\"\u003e\n                                                            \u003cbutton\n                                                                class=\"text-action-danger-bg hover:text-action-danger-bg-hover disabled:opacity-50\"\n                                                                disabled={move || cancel_loading.get() || !can_cancel}\n                                                                on:click=on_cancel\n                                                            \u003e\n                                                                {\"取消\"}\n                                                            \u003c/button\u003e\n                                                            \u003cspan class=\"sr-only\"\u003e{request_id}\u003c/span\u003e\n                                                        \u003c/td\u003e\n                                                    \u003c/tr\u003e\n                                                }\n                                            })\n                                            .collect::\u003cVec\u003c_\u003e\u003e()\n                                    }}\n                                \u003c/tbody\u003e\n                            \u003c/table\u003e\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            \u003c/div\u003e\n        \u003c/Layout\u003e\n    }\n}\n\nfn subject_request_type_label(value: \u0026DataSubjectRequestType) -\u003e \u0026'static str {\n    match value {\n        DataSubjectRequestType::Access =\u003e \"開示\",\n        DataSubjectRequestType::Rectify =\u003e \"訂正\",\n        DataSubjectRequestType::Delete =\u003e \"削除\",\n        DataSubjectRequestType::Stop =\u003e \"停止\",\n    }\n}\n\nfn subject_request_status_label(value: \u0026str) -\u003e String {\n    match value {\n        \"pending\" =\u003e \"承認待ち\".to_string(),\n        \"approved\" =\u003e \"承認済み\".to_string(),\n        \"rejected\" =\u003e \"却下\".to_string(),\n        \"cancelled\" =\u003e \"取消\".to_string(),\n        _ =\u003e value.to_string(),\n    }\n}\n\nfn format_subject_datetime(value: DateTime\u003cUtc\u003e) -\u003e String {\n    value.format(\"%Y-%m-%d %H:%M\").to_string()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::map_change_password_error;\n    use crate::api::ApiError;\n    use wasm_bindgen_test::*;\n\n    #[wasm_bindgen_test]\n    fn map_change_password_error_handles_known_messages() {\n        assert_eq!(\n            map_change_password_error(\u0026ApiError::unknown(\"Current password is incorrect\")).error,\n            \"現在のパスワードが正しくありません。\"\n        );\n        assert_eq!(\n            map_change_password_error(\u0026ApiError::unknown(\n                \"New password must be at least 8 characters\"\n            ))\n            .error,\n            \"新しいパスワードは8文字以上である必要があります。\"\n        );\n        assert_eq!(\n            map_change_password_error(\u0026ApiError::unknown(\n                \"New password must differ from current password\"\n            ))\n            .error,\n            \"新しいパスワードは現在のパスワードと異なる必要があります。\"\n        );\n    }\n\n    #[wasm_bindgen_test]\n    fn map_change_password_error_masks_unknown_messages() {\n        assert_eq!(\n            map_change_password_error(\u0026ApiError::unknown(\"Failed to update password\")).error,\n            \"パスワード変更に失敗しました。時間をおいて再度お試しください。\"\n        );\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","settings","repository.rs"],"content":"use crate::api::{ApiClient, ApiError};\n\npub async fn change_password(\n    client: ApiClient,\n    current: String,\n    new: String,\n) -\u003e Result\u003c(), ApiError\u003e {\n    client.change_password(current, new).await\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","pages","settings","view_model.rs"],"content":"use super::repository;\nuse crate::api::{ApiClient, ApiError, CreateDataSubjectRequest, DataSubjectRequestResponse};\nuse crate::pages::mfa::view_model::MfaViewModel;\nuse leptos::*;\n\n#[derive(Clone)]\npub struct SettingsViewModel {\n    pub change_password_action: Action\u003c(String, String), Result\u003c(), ApiError\u003e\u003e,\n    pub mfa_view_model: MfaViewModel, // Reuse existing MFA logic\n    pub subject_request_view_model: SubjectRequestViewModel,\n}\n\n#[derive(Clone)]\npub struct SubjectRequestViewModel {\n    pub requests_resource: Resource\u003cu32, Result\u003cVec\u003cDataSubjectRequestResponse\u003e, ApiError\u003e\u003e,\n    pub reload: RwSignal\u003cu32\u003e,\n    pub create_action:\n        Action\u003cCreateDataSubjectRequest, Result\u003cDataSubjectRequestResponse, ApiError\u003e\u003e,\n    pub cancel_action: Action\u003cString, Result\u003c(), ApiError\u003e\u003e,\n}\n\npub fn use_settings_view_model() -\u003e SettingsViewModel {\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let api_for_password = api.clone();\n    let change_password_action = create_action(move |(current, new): \u0026(String, String)| {\n        let api = api_for_password.clone();\n        let current = current.clone();\n        let new = new.clone();\n        async move { repository::change_password(api, current, new).await }\n    });\n\n    let subject_reload = create_rw_signal(0u32);\n    let list_api = api.clone();\n    let requests_resource = create_resource(\n        move || subject_reload.get(),\n        move |_| {\n            let api = list_api.clone();\n            async move { api.list_my_subject_requests().await }\n        },\n    );\n\n    let create_api = api.clone();\n    let create_subject_action = create_action(move |payload: \u0026CreateDataSubjectRequest| {\n        let api = create_api.clone();\n        let payload = payload.clone();\n        async move { api.create_subject_request(payload).await }\n    });\n\n    let cancel_api = api.clone();\n    let cancel_subject_action = create_action(move |id: \u0026String| {\n        let api = cancel_api.clone();\n        let id = id.clone();\n        async move { api.cancel_subject_request(\u0026id).await }\n    });\n\n    let subject_request_view_model = SubjectRequestViewModel {\n        requests_resource,\n        reload: subject_reload,\n        create_action: create_subject_action,\n        cancel_action: cancel_subject_action,\n    };\n\n    let mfa_view_model = crate::pages::mfa::view_model::use_mfa_view_model();\n\n    SettingsViewModel {\n        change_password_action,\n        mfa_view_model,\n        subject_request_view_model,\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","router.rs"],"content":"use leptos::*;\nuse leptos_router::*;\n\nuse crate::{\n    components::guard::RequireAuth,\n    pages::{\n        admin::AdminPage, admin_audit_logs::AdminAuditLogsPage, admin_export::AdminExportPage,\n        admin_users::AdminUsersPage, attendance::AttendancePage, dashboard::DashboardPage,\n        forgot_password::ForgotPasswordPage, home::HomePage, login::LoginPage,\n        mfa::MfaRegisterPage, requests::RequestsPage, reset_password::ResetPasswordPage,\n        settings::SettingsPage,\n    },\n    state::auth::AuthProvider,\n};\n\npub const ROUTE_PATHS: \u0026[\u0026str] = \u0026[\n    \"/\",\n    \"/login\",\n    \"/forgot-password\",\n    \"/reset-password\",\n    \"/dashboard\",\n    \"/attendance\",\n    \"/requests\",\n    \"/mfa/register\",\n    \"/settings\",\n    \"/admin\",\n    \"/admin/users\",\n    \"/admin/export\",\n    \"/admin/audit-logs\",\n];\n\npub const PROTECTED_ROUTE_PATHS: \u0026[\u0026str] = \u0026[\n    \"/dashboard\",\n    \"/attendance\",\n    \"/requests\",\n    \"/settings\",\n    \"/admin\",\n    \"/admin/users\",\n    \"/admin/export\",\n    \"/admin/audit-logs\",\n];\n\npub const PUBLIC_ROUTE_PATHS: \u0026[\u0026str] = \u0026[\n    \"/\",\n    \"/login\",\n    \"/mfa/register\",\n    \"/forgot-password\",\n    \"/reset-password\",\n];\n\npub fn mount_app() {\n    mount_to_body(app_root);\n}\n\npub fn app_root() -\u003e impl IntoView {\n    provide_context(crate::api::ApiClient::new());\n    view! {\n        \u003cAuthProvider\u003e\n            \u003cRouter\u003e\n                \u003cRoutes\u003e\n                    \u003cRoute path=\"/\" view=HomePage/\u003e\n                    \u003cRoute path=\"/login\" view=LoginPage/\u003e\n                    \u003cRoute path=\"/forgot-password\" view=ForgotPasswordPage/\u003e\n                    \u003cRoute path=\"/reset-password\" view=ResetPasswordPage/\u003e\n                    \u003cRoute path=\"/dashboard\" view=ProtectedDashboard/\u003e\n                    \u003cRoute path=\"/attendance\" view=ProtectedAttendance/\u003e\n                    \u003cRoute path=\"/requests\" view=ProtectedRequests/\u003e\n                    \u003cRoute path=\"/mfa/register\" view=MfaRegisterPage/\u003e // Keeping for direct access if needed, or redirect?\n                    \u003cRoute path=\"/settings\" view=ProtectedSettings/\u003e\n                    \u003cRoute path=\"/admin\" view=ProtectedAdmin/\u003e\n                    \u003cRoute path=\"/admin/users\" view=ProtectedAdminUsers/\u003e\n                    \u003cRoute path=\"/admin/export\" view=ProtectedAdminExport/\u003e\n                    \u003cRoute path=\"/admin/audit-logs\" view=ProtectedAdminAuditLogs/\u003e\n                \u003c/Routes\u003e\n            \u003c/Router\u003e\n        \u003c/AuthProvider\u003e\n    }\n}\n\n#[component]\nfn ProtectedDashboard() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cDashboardPage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[component]\nfn ProtectedAttendance() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cAttendancePage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[component]\nfn ProtectedRequests() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cRequestsPage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[component]\nfn ProtectedSettings() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cSettingsPage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[component]\nfn ProtectedAdmin() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cAdminPage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[component]\nfn ProtectedAdminUsers() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cAdminUsersPage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[component]\nfn ProtectedAdminExport() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cAdminExportPage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[component]\nfn ProtectedAdminAuditLogs() -\u003e impl IntoView {\n    view! { \u003cRequireAuth\u003e\u003cAdminAuditLogsPage/\u003e\u003c/RequireAuth\u003e }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::collections::HashSet;\n\n    #[test]\n    fn route_paths_include_admin_routes() {\n        assert!(ROUTE_PATHS.contains(\u0026\"/admin/users\"));\n        assert!(ROUTE_PATHS.contains(\u0026\"/admin/export\"));\n    }\n\n    #[test]\n    fn protected_routes_are_subset_of_all() {\n        let all: HashSet\u003c\u0026str\u003e = ROUTE_PATHS.iter().copied().collect();\n        for path in PROTECTED_ROUTE_PATHS {\n            assert!(\n                all.contains(path),\n                \"protected path missing from ROUTE_PATHS: {}\",\n                path\n            );\n        }\n    }\n\n    #[test]\n    fn no_duplicate_routes() {\n        let unique: HashSet\u003c\u0026str\u003e = ROUTE_PATHS.iter().copied().collect();\n        assert_eq!(unique.len(), ROUTE_PATHS.len());\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","state","attendance.rs"],"content":"use crate::api::{ApiClient, ApiError, AttendanceResponse, AttendanceStatusResponse};\nuse crate::utils::time::today_in_app_tz;\nuse chrono::NaiveDate;\nuse leptos::*;\n\n#[derive(Clone, Copy, Debug, PartialEq, Eq)]\npub enum ClockEventKind {\n    ClockIn,\n    BreakStart,\n    BreakEnd,\n    ClockOut,\n}\n\n#[derive(Clone, Debug, PartialEq, Eq)]\npub struct ClockEventPayload {\n    pub kind: ClockEventKind,\n    pub attendance_id: Option\u003cString\u003e,\n    pub break_id: Option\u003cString\u003e,\n}\n\n#[derive(Clone, Debug, PartialEq, Eq)]\npub enum ClockMessage {\n    Success(String),\n    Error(ApiError),\n}\n\nimpl ClockEventPayload {\n    pub fn clock_in() -\u003e Self {\n        Self {\n            kind: ClockEventKind::ClockIn,\n            attendance_id: None,\n            break_id: None,\n        }\n    }\n\n    pub fn clock_out() -\u003e Self {\n        Self {\n            kind: ClockEventKind::ClockOut,\n            attendance_id: None,\n            break_id: None,\n        }\n    }\n\n    pub fn break_start(attendance_id: String) -\u003e Self {\n        Self {\n            kind: ClockEventKind::BreakStart,\n            attendance_id: Some(attendance_id),\n            break_id: None,\n        }\n    }\n\n    pub fn break_end(break_id: String) -\u003e Self {\n        Self {\n            kind: ClockEventKind::BreakEnd,\n            attendance_id: None,\n            break_id: Some(break_id),\n        }\n    }\n}\n\n#[derive(Debug, Clone, Default)]\npub struct AttendanceState {\n    pub current_attendance: Option\u003cAttendanceResponse\u003e,\n    pub attendance_history: Vec\u003cAttendanceResponse\u003e,\n    pub today_status: Option\u003cAttendanceStatusResponse\u003e,\n    pub today_holiday_reason: Option\u003cString\u003e,\n    pub last_refresh_error: Option\u003cApiError\u003e,\n    pub range_from: Option\u003cNaiveDate\u003e,\n    pub range_to: Option\u003cNaiveDate\u003e,\n    pub loading: bool,\n}\n\npub fn use_attendance() -\u003e (ReadSignal\u003cAttendanceState\u003e, WriteSignal\u003cAttendanceState\u003e) {\n    let (attendance_state, set_attendance_state) = create_signal(AttendanceState::default());\n    (attendance_state, set_attendance_state)\n}\n\npub async fn clock_in(\n    api: \u0026ApiClient,\n    set_attendance_state: WriteSignal\u003cAttendanceState\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    set_attendance_state.update(|state| state.loading = true);\n    match api.clock_in().await {\n        Ok(attendance) =\u003e {\n            set_attendance_state.update(|state| {\n                state.current_attendance = Some(attendance);\n                state.loading = false;\n            });\n            Ok(())\n        }\n        Err(error) =\u003e {\n            set_attendance_state.update(|state| state.loading = false);\n            Err(error)\n        }\n    }\n}\n\npub async fn clock_out(\n    api: \u0026ApiClient,\n    set_attendance_state: WriteSignal\u003cAttendanceState\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    set_attendance_state.update(|state| state.loading = true);\n    match api.clock_out().await {\n        Ok(attendance) =\u003e {\n            set_attendance_state.update(|state| {\n                state.current_attendance = Some(attendance);\n                state.loading = false;\n            });\n            Ok(())\n        }\n        Err(error) =\u003e {\n            set_attendance_state.update(|state| state.loading = false);\n            Err(error)\n        }\n    }\n}\n\npub async fn start_break(api: \u0026ApiClient, attendance_id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n    api.break_start(attendance_id).await.map(|_| ())\n}\n\npub async fn end_break(api: \u0026ApiClient, break_id: \u0026str) -\u003e Result\u003c(), ApiError\u003e {\n    api.break_end(break_id).await.map(|_| ())\n}\n\npub async fn load_attendance_range(\n    api: \u0026ApiClient,\n    set_attendance_state: WriteSignal\u003cAttendanceState\u003e,\n    from: Option\u003cNaiveDate\u003e,\n    to: Option\u003cNaiveDate\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    set_attendance_state.update(|state| state.loading = true);\n    match api.get_my_attendance_range(from, to).await {\n        Ok(history) =\u003e {\n            set_attendance_state.update(|state| {\n                state.attendance_history = history;\n                state.range_from = from;\n                state.range_to = to;\n                state.loading = false;\n            });\n            Ok(())\n        }\n        Err(error) =\u003e {\n            set_attendance_state.update(|state| state.loading = false);\n            Err(error)\n        }\n    }\n}\n\npub async fn load_today_status(\n    api: \u0026ApiClient,\n    set_attendance_state: WriteSignal\u003cAttendanceState\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    set_attendance_state.update(|state| state.loading = true);\n    match api.get_attendance_status(None).await {\n        Ok(status) =\u003e {\n            set_attendance_state.update(|state| {\n                state.today_status = Some(status);\n                state.loading = false;\n            });\n            Ok(())\n        }\n        Err(e) =\u003e {\n            set_attendance_state.update(|state| state.loading = false);\n            Err(e)\n        }\n    }\n}\n\npub async fn load_today_holiday_reason(\n    api: \u0026ApiClient,\n    set_attendance_state: WriteSignal\u003cAttendanceState\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    let today = today_in_app_tz();\n    match api.check_holiday(today).await {\n        Ok(response) =\u003e {\n            set_attendance_state.update(|state| {\n                if response.is_holiday {\n                    state.today_holiday_reason = response.reason;\n                } else {\n                    state.today_holiday_reason = None;\n                }\n            });\n            Ok(())\n        }\n        Err(e) =\u003e {\n            set_attendance_state.update(|state| state.today_holiday_reason = None);\n            Err(e)\n        }\n    }\n}\n\npub async fn refresh_today_context(\n    api: \u0026ApiClient,\n    set_attendance_state: WriteSignal\u003cAttendanceState\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    if let Err(err) = load_today_status(api, set_attendance_state).await {\n        set_attendance_state.update(|state| state.last_refresh_error = Some(err.clone()));\n        return Err(err);\n    }\n\n    let today = today_in_app_tz();\n    if let Err(err) =\n        load_attendance_range(api, set_attendance_state, Some(today), Some(today)).await\n    {\n        set_attendance_state.update(|state| state.last_refresh_error = Some(err.clone()));\n        return Err(err);\n    }\n\n    if let Err(err) = load_today_holiday_reason(api, set_attendance_state).await {\n        set_attendance_state.update(|state| state.last_refresh_error = Some(err.clone()));\n        return Err(err);\n    }\n\n    set_attendance_state.update(|state| state.last_refresh_error = None);\n    Ok(())\n}\n\npub fn describe_holiday_reason(code: \u0026str) -\u003e \u0026'static str {\n    match code {\n        \"public holiday\" =\u003e \"祝日\",\n        \"weekly holiday\" =\u003e \"定休日\",\n        \"forced holiday\" =\u003e \"特別休日\",\n        _ =\u003e \"休日\",\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn default_state_has_no_holiday_reason() {\n        let state = AttendanceState::default();\n        assert!(state.today_holiday_reason.is_none());\n    }\n\n    #[wasm_bindgen_test]\n    fn describe_reason_maps_known_values() {\n        assert_eq!(describe_holiday_reason(\"public holiday\"), \"祝日\");\n        assert_eq!(describe_holiday_reason(\"weekly holiday\"), \"定休日\");\n        assert_eq!(describe_holiday_reason(\"forced holiday\"), \"特別休日\");\n    }\n\n    #[wasm_bindgen_test]\n    fn describe_reason_falls_back_for_unknown() {\n        assert_eq!(describe_holiday_reason(\"custom\"), \"休日\");\n    }\n\n    #[wasm_bindgen_test]\n    fn attendance_state_default_has_no_refresh_error() {\n        let state = AttendanceState::default();\n        assert!(state.last_refresh_error.is_none());\n    }\n\n    #[wasm_bindgen_test]\n    fn can_store_refresh_error_message() {\n        let state = AttendanceState {\n            last_refresh_error: Some(crate::api::ApiError::validation(\"network error\")),\n            ..Default::default()\n        };\n        assert_eq!(\n            state.last_refresh_error.as_ref().map(|e| e.error.as_str()),\n            Some(\"network error\")\n        );\n    }\n}\n\n// load_attendance_summary was unused; consider adding a call site before reintroducing.\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","state","auth.rs"],"content":"use crate::{\n    api::{ApiClient, ApiError, LoginRequest, UserResponse},\n    pages::login::repository as login_repository,\n};\nuse leptos::*;\n\ntype AuthContext = (ReadSignal\u003cAuthState\u003e, WriteSignal\u003cAuthState\u003e);\n\n#[derive(Debug, Clone, Default)]\npub struct AuthState {\n    pub user: Option\u003cUserResponse\u003e,\n    pub is_authenticated: bool,\n    pub loading: bool,\n}\n\nfn create_auth_context() -\u003e AuthContext {\n    let (auth_state, set_auth_state) = create_signal(AuthState::default());\n    set_auth_state.update(|state| state.loading = true);\n\n    let api_client = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let set_auth_for_check = set_auth_state;\n    spawn_local(async move {\n        match check_auth_status(\u0026api_client).await {\n            Ok(user) =\u003e set_auth_for_check.update(|state| {\n                state.user = Some(user);\n                state.is_authenticated = true;\n                state.loading = false;\n            }),\n            Err(_) =\u003e set_auth_for_check.update(|state| {\n                state.user = None;\n                state.is_authenticated = false;\n                state.loading = false;\n            }),\n        }\n    });\n\n    (auth_state, set_auth_state)\n}\n\n#[component]\npub fn AuthProvider(children: Children) -\u003e impl IntoView {\n    let ctx = create_auth_context();\n    provide_context::\u003cAuthContext\u003e(ctx);\n    view! { \u003c\u003e{children()}\u003c/\u003e }\n}\n\npub fn use_auth() -\u003e AuthContext {\n    use_context::\u003cAuthContext\u003e().unwrap_or_else(|| create_signal(AuthState::default()))\n}\n\nasync fn check_auth_status(api_client: \u0026ApiClient) -\u003e Result\u003cUserResponse, ApiError\u003e {\n    api_client.get_me().await\n}\n\npub async fn login_request(\n    request: LoginRequest,\n    repo: \u0026login_repository::LoginRepository,\n    set_auth_state: WriteSignal\u003cAuthState\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    set_auth_state.update(|state| state.loading = true);\n\n    match repo.login(request).await {\n        Ok(response) =\u003e {\n            set_auth_state.update(|state| {\n                state.user = Some(response.user);\n                state.is_authenticated = true;\n                state.loading = false;\n            });\n            Ok(())\n        }\n        Err(error) =\u003e {\n            set_auth_state.update(|state| state.loading = false);\n            Err(error)\n        }\n    }\n}\n\npub async fn logout(\n    all_sessions: bool,\n    repo: \u0026login_repository::LoginRepository,\n    set_auth_state: WriteSignal\u003cAuthState\u003e,\n) -\u003e Result\u003c(), ApiError\u003e {\n    let result = repo.logout(all_sessions).await;\n\n    set_auth_state.update(|state| {\n        state.user = None;\n        state.is_authenticated = false;\n        state.loading = false;\n    });\n\n    result\n}\n\npub fn use_login_action() -\u003e Action\u003cLoginRequest, Result\u003c(), ApiError\u003e\u003e {\n    let (_auth, set_auth) = use_auth();\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repo = login_repository::LoginRepository::new_with_client(std::rc::Rc::new(api));\n\n    create_action(move |request: \u0026LoginRequest| {\n        let payload = request.clone();\n        let repo = repo.clone();\n        async move { login_request(payload, \u0026repo, set_auth).await }\n    })\n}\n\npub fn use_logout_action() -\u003e Action\u003cbool, Result\u003c(), ApiError\u003e\u003e {\n    let (_auth, set_auth) = use_auth();\n    let api = use_context::\u003cApiClient\u003e().unwrap_or_else(ApiClient::new);\n    let repo = login_repository::LoginRepository::new_with_client(std::rc::Rc::new(api));\n\n    create_action(move |all: \u0026bool| {\n        let flag = *all;\n        let repo = repo.clone();\n        async move { logout(flag, \u0026repo, set_auth).await }\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use leptos::create_runtime;\n\n    fn with_runtime\u003cT\u003e(test: impl FnOnce() -\u003e T) -\u003e T {\n        let runtime = create_runtime();\n        let result = test();\n        runtime.dispose();\n        result\n    }\n\n    #[test]\n    fn use_auth_returns_default_without_context() {\n        with_runtime(|| {\n            let (state, _set_state) = use_auth();\n            let snapshot = state.get();\n            assert!(!snapshot.is_authenticated);\n            assert!(snapshot.user.is_none());\n        });\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","state","config.rs"],"content":"use crate::config::{self, TimeZoneStatus};\nuse leptos::*;\n\n#[derive(Clone, Debug, Default, PartialEq)]\npub struct ConfigState {\n    pub time_zone_status: TimeZoneStatus,\n}\n\npub fn use_config() -\u003e (ReadSignal\u003cConfigState\u003e, WriteSignal\u003cConfigState\u003e) {\n    match use_context::\u003c(ReadSignal\u003cConfigState\u003e, WriteSignal\u003cConfigState\u003e)\u003e() {\n        Some(ctx) =\u003e ctx,\n        None =\u003e {\n            let (read, write) = create_signal(ConfigState {\n                time_zone_status: config::time_zone_status(),\n            });\n            provide_context((read, write));\n            (read, write)\n        }\n    }\n}\n\npub async fn refresh_time_zone(set_state: WriteSignal\u003cConfigState\u003e) {\n    set_state.update(|s| s.time_zone_status.loading = true);\n    let status = config::refresh_time_zone().await;\n    set_state.update(|s| s.time_zone_status = status);\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use leptos::create_runtime;\n\n    fn with_runtime\u003cT\u003e(test: impl FnOnce() -\u003e T) -\u003e T {\n        let runtime = create_runtime();\n        let result = test();\n        runtime.dispose();\n        result\n    }\n\n    #[test]\n    fn use_config_seeds_time_zone_status() {\n        with_runtime(|| {\n            let (read, _write) = use_config();\n            let seeded = read.get().time_zone_status;\n            assert_eq!(seeded, config::time_zone_status());\n        });\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","state","mod.rs"],"content":"pub mod attendance;\npub mod auth;\npub mod config;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","state","theme.rs"],"content":"use leptos::*;\n\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum Theme {\n    Light,\n    Dark,\n    HighContrast,\n}\n\nimpl Default for Theme {\n    fn default() -\u003e Self {\n        if web_sys::window()\n            .and_then(|w| w.match_media(\"(prefers-color-scheme: dark)\").ok())\n            .map(|m| m.matches())\n            .unwrap_or(false)\n        {\n            Theme::Dark\n        } else {\n            Theme::Light\n        }\n    }\n}\n\nimpl Theme {\n    pub fn as_class(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Theme::Light =\u003e \"\",\n            Theme::Dark =\u003e \"dark\",\n            Theme::HighContrast =\u003e \"contrast-high\",\n        }\n    }\n}\n\n#[derive(Clone)]\npub struct ThemeState {\n    pub theme: RwSignal\u003cTheme\u003e,\n}\n\nimpl ThemeState {\n    pub fn new() -\u003e Self {\n        let theme = create_rw_signal(Theme::default());\n        Self { theme }\n    }\n\n    pub fn set_theme(\u0026self, theme: Theme) {\n        self.theme.set(theme);\n        self.apply_to_dom();\n    }\n\n    pub fn toggle(\u0026self) {\n        let new_theme = match self.theme.get() {\n            Theme::Light =\u003e Theme::Dark,\n            Theme::Dark =\u003e Theme::Light,\n            Theme::HighContrast =\u003e Theme::Light,\n        };\n        self.set_theme(new_theme);\n    }\n\n    fn apply_to_dom(\u0026self) {\n        if let Some(document) = web_sys::window().and_then(|w| w.document()) {\n            let class_list = document.document_element().unwrap().class_list();\n            class_list.remove_1(\"dark\");\n            class_list.remove_1(\"contrast-high\");\n            class_list.add_1(self.theme.get().as_class());\n        }\n    }\n\n    pub fn current(\u0026self) -\u003e ReadSignal\u003cTheme\u003e {\n        self.theme.read_only()\n    }\n}\n\npub fn use_theme() -\u003e ThemeState {\n    expect_context::\u003cThemeState\u003e().expect(\"ThemeState must be provided in app root\")\n}\n\npub fn provide_theme() -\u003e ThemeState {\n    let state = ThemeState::new();\n    provide_context(state.clone());\n    state.apply_to_dom();\n\n    if let Some(window) = web_sys::window() {\n        if let Ok(media) = window.match_media(\"(prefers-color-scheme: dark)\") {\n            let state_clone = state.clone();\n            let closure = Closure::wrap(Box::new(move |_: web_sys::MediaQueryListEvent| {\n                let system_dark = window\n                    .match_media(\"(prefers-color-scheme: dark)\")\n                    .map(|m| m.matches())\n                    .unwrap_or(false);\n\n                let current = state_clone.theme.get();\n            }));\n\n            media\n                .add_event_listener_with_callback(\"change\", \u0026closure)\n                .unwrap();\n            closure.forget();\n        }\n    }\n\n    state\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","theme.rs"],"content":"#[cfg(target_arch = \"wasm32\")]\nmod wasm {\n    use std::cell::RefCell;\n    use wasm_bindgen::closure::Closure;\n    use wasm_bindgen::JsCast;\n    use web_sys;\n\n    const DARK_CLASS: \u0026str = \"dark\";\n\n    struct ThemeWatcher {\n        _media_query: web_sys::MediaQueryList,\n        _listener: Closure\u003cdyn FnMut(web_sys::MediaQueryListEvent)\u003e,\n    }\n\n    thread_local! {\n        static THEME_WATCHER: RefCell\u003cOption\u003cThemeWatcher\u003e\u003e = RefCell::new(None);\n    }\n\n    fn update_html_class(html: \u0026web_sys::Element, is_dark: bool) {\n        let list = html.class_list();\n        if is_dark {\n            let _ = list.add_1(DARK_CLASS);\n        } else {\n            let _ = list.remove_1(DARK_CLASS);\n        }\n    }\n\n    pub fn init() {\n        let window = match web_sys::window() {\n            Some(win) =\u003e win,\n            None =\u003e return,\n        };\n\n        let document = match window.document() {\n            Some(doc) =\u003e doc,\n            None =\u003e return,\n        };\n\n        let html = match document.document_element() {\n            Some(node) =\u003e node,\n            None =\u003e return,\n        };\n\n        let media_query = window\n            .match_media(\"(prefers-color-scheme: dark)\")\n            .ok()\n            .flatten();\n\n        let set_from_query = |matches: bool| {\n            update_html_class(\u0026html, matches);\n        };\n\n        if let Some(list) = media_query {\n            set_from_query(list.matches());\n            let html_clone = html.clone();\n            let closure = Closure::wrap(Box::new(move |event: web_sys::MediaQueryListEvent| {\n                update_html_class(\u0026html_clone, event.matches());\n            }) as Box\u003cdyn FnMut(_)\u003e);\n            if list\n                .add_event_listener_with_callback(\"change\", closure.as_ref().unchecked_ref())\n                .is_err()\n            {\n                // ignore\n            }\n            THEME_WATCHER.with(|slot| {\n                *slot.borrow_mut() = Some(ThemeWatcher {\n                    _media_query: list,\n                    _listener: closure,\n                });\n            });\n        } else {\n            set_from_query(false);\n        }\n    }\n\n    #[cfg(test)]\n    mod tests {\n        use super::*;\n        use wasm_bindgen_test::*;\n\n        wasm_bindgen_test_configure!(run_in_browser);\n\n        #[wasm_bindgen_test]\n        fn update_html_class_toggles_dark_mode() {\n            let document = web_sys::window().unwrap().document().unwrap();\n            let element = document.create_element(\"div\").unwrap();\n\n            update_html_class(\u0026element, true);\n            assert!(element.class_list().contains(DARK_CLASS));\n\n            update_html_class(\u0026element, false);\n            assert!(!element.class_list().contains(DARK_CLASS));\n        }\n    }\n}\n\n#[cfg(target_arch = \"wasm32\")]\npub use wasm::init as init_system_theme;\n\n#[cfg(not(target_arch = \"wasm32\"))]\npub fn init_system_theme() {}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","utils","download.rs"],"content":"use wasm_bindgen::JsCast;\n\npub fn trigger_csv_download(filename: \u0026str, csv_data: \u0026str) -\u003e Result\u003c(), String\u003e {\n    let array = js_sys::Array::new();\n    array.push(\u0026wasm_bindgen::JsValue::from_str(csv_data));\n    let blob = web_sys::Blob::new_with_str_sequence(\u0026array)\n        .map_err(|_| \"Failed to create blob\".to_string())?;\n\n    let url = web_sys::Url::create_object_url_with_blob(\u0026blob)\n        .map_err(|_| \"Failed to create object URL\".to_string())?;\n\n    let document = web_sys::window()\n        .and_then(|w| w.document())\n        .ok_or(\"No document\")?;\n    let element = document\n        .create_element(\"a\")\n        .map_err(|_| \"Failed to create link\".to_string())?;\n    let a = element\n        .dyn_into::\u003cweb_sys::HtmlAnchorElement\u003e()\n        .map_err(|_| \"Failed to cast anchor\".to_string())?;\n    a.set_href(\u0026url);\n    a.set_download(filename);\n    a.style().set_property(\"display\", \"none\").ok();\n    document\n        .body()\n        .ok_or(\"No body\")?\n        .append_child(\u0026a)\n        .map_err(|_| \"Append failed\".to_string())?;\n    a.click();\n    a.remove();\n    let _ = web_sys::Url::revoke_object_url(\u0026url);\n    Ok(())\n}\n\n#[cfg(all(test, target_arch = \"wasm32\"))]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn trigger_csv_download_succeeds() {\n        let result = trigger_csv_download(\"test.csv\", \"a,b\\n1,2\\n\");\n        assert!(result.is_ok());\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","utils","mod.rs"],"content":"pub mod download;\npub mod storage;\npub mod time;\n\npub use download::*;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","utils","storage.rs"],"content":"use web_sys::{Storage, Window};\n\nfn window() -\u003e Result\u003cWindow, String\u003e {\n    web_sys::window().ok_or_else(|| \"No window object\".to_string())\n}\n\npub fn local_storage() -\u003e Result\u003cStorage, String\u003e {\n    window()?\n        .local_storage()\n        .map_err(|_| \"No localStorage\".to_string())?\n        .ok_or_else(|| \"No localStorage\".to_string())\n}\n\n#[cfg(all(test, target_arch = \"wasm32\"))]\nmod tests {\n    use super::*;\n    use wasm_bindgen_test::*;\n\n    wasm_bindgen_test_configure!(run_in_browser);\n\n    #[wasm_bindgen_test]\n    fn local_storage_is_available() {\n        assert!(local_storage().is_ok());\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","marra","projects","timekeeper","frontend","src","utils","time.rs"],"content":"use chrono::{DateTime, NaiveDate, Utc};\nuse chrono_tz::Tz;\n\nuse crate::config;\n\nfn app_time_zone() -\u003e Tz {\n    config::current_time_zone()\n}\n\npub fn now_in_app_tz() -\u003e DateTime\u003cTz\u003e {\n    Utc::now().with_timezone(\u0026app_time_zone())\n}\n\npub fn today_in_app_tz() -\u003e NaiveDate {\n    now_in_app_tz().date_naive()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn today_matches_now_date() {\n        let today = today_in_app_tz();\n        let now = now_in_app_tz();\n        assert_eq!(today, now.date_naive());\n    }\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('div', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('pre', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>